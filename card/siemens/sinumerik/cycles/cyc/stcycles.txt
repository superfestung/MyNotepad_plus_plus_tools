;----------------------------------------------------------
;
;@(#)$program_version_id:V06.24.00.00 15/07/24 15:00:00, ShopTurn Cycles,
;
;----------------------------------------------------------
;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_BARLO_SPF
PROC F_BARLO(INT _MODE, REAL _ZPD) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.04.27.00 ;DATE: 2012-05-15
;ShopTurn: Bar loader
WRTPR("NPVSET("<<_ZPD<<",5)",1)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_CI_CO_SPF
PROC F_CI_CO(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,STRING[70] _NAME,INT _BA,REAL _R1,REAL _Z0,REAL _Z1,INT _Z1A,REAL _DXY,REAL _DZ,REAL _UXY,REAL _UZ,REAL _X,REAL _Y,REAL _FZ,INT _FZA,REAL _FZR,REAL _RP,REAL _SC,INT _DIR,STRING[21] _CHECK1,STRING[21] _CHECK2,INT _ST,INT _METRIC,REAL _SCAL_XY,REAL _SCAL_Z,STRING[70] _NAME_DR,INT _DXYA,REAL _MAX_R,REAL _C0,REAL _FS,REAL _ZFS,INT _ZFSA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.94.00.00.005 ;DATE: 2020-04-23
;ShopTurn contour pintle
_ST=_ST+100
IF((_TMOD _DEC1)==2)OR((_TMOD _DEC1)==0)
_TMOD=_TMOD+100000*(1-(_TMOD _DEC6))
ENDIF
N10 F_CP_CO(_T,_TF,_DD,_F,_FAA,_S,_SA,_TMOD,_NAME,_BA,,_Z0,_Z1,_Z1A,_DXY,_DZ,_UXY,_UZ,_X,_Y,_FZ,_FZA,_FZR,,,,,,_ST,,,,,_DXYA,,_C0,_FS,_ZFS,_ZFSA)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_CI_RE_SPF
PROC F_CI_RE(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,STRING[70] _NAME,REAL _R1,REAL _R2,REAL _Z0,REAL _Z1,INT _Z1A,REAL _DXY,REAL _DZ,REAL _UXY,REAL _UZ,REAL _RP,REAL _SC,INT _DIR,STRING[21] _CHECK1,STRING[21] _CHECK2,INT _ST,STRING[32] _TR,INT _DR,INT _METRIC,REAL _SCAL_XY,REAL _SCAL_Z,INT _DXYA,REAL _C0,REAL _X,REAL _Y,INT _BA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.94.00.00.005 ;DATE: 2020-04-23
;ShopTurn contour pintle residual material
_ST=_ST+100
IF((_TMOD _DEC1)==2)OR((_TMOD _DEC1)==0)
_TMOD=_TMOD+100000*(1-(_TMOD _DEC6))
ENDIF
N10 F_CP_RE(_T,_TF,_DD,_F,_FAA,_S,_SA,_TMOD,_NAME,,,_Z0,_Z1,_Z1A,_DXY,_DZ,_UXY,_UZ,,,,,,_ST,_TR,_DR,,,,_DXYA,_C0,_X,_Y,_BA)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_CON_SPF
PROC F_CON(STRING[140] _KNAME,INT _TYPE,STRING[32] _LAB1,STRING[32] _LAB2) DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.95.00.00.003 ;DATE: 2020-12-07
;ShopTurn Contour definitions for Roughing and Pockets
IF(_E_S_LINE)
IF(_E_S_LINE==$P_LINENO[0])
_E_S_LINE=0
ELSE
IF(_SC_CHAN=="")
GOTOF _RETS
ENDIF
ENDIF
ENDIF
N10 CYCLE62(_KNAME,1)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_CONFIG_SPF
PROC F_CONFIG(INT _ST,REAL _X0,REAL _Z0,REAL _X1,REAL _Z1,REAL _XR0,REAL _ZR0,REAL _XR1,REAL _ZR1,REAL _XT,REAL _ZT,REAL _SC,REAL _S1,REAL _S3,INT _DIR,INT _ST2,INT _BL,REAL _ZB,REAL _XR) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.07.10.00 ;DATE: 2014-06-27
;ShopTurn: Settings
_ST=_ST B_OR 'H18000000'
_ST=_ST B_AND (B_NOT 'H000F')
_ST=_ST B_AND (B_NOT 'H2000')
_ST2=_ST2 B_AND (B_NOT 'H0002')
_ST2=_ST2 B_AND (B_NOT 'H0008')
_ST2=_ST2 B_AND (B_NOT 'H0200')
F_HEAD(_ST,,,,,_XR0,_ZR0,_XR1,_ZR1,_XT,_ZT,_SC,_S1,_S3,,_DIR,_ST2,,,_XR)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_CP_CE_SPF
PROC F_CP_CE(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,STRING[70] _NAME,REAL _Z0,REAL _Z1,INT _Z1A,INT _ST,INT _METRIC,REAL _SCAL_XY,REAL _SCAL_Z,REAL _MAX_R,STRING[32] _TR,INT _DR,REAL _DXY,REAL _UXY,INT _DXYA,STRING[21] _CHECK1,STRING[21] _CHECK2,REAL _C0,REAL _X,REAL _Y,INT _BA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.06.04.00 ;DATE: 2012-10-25
;ShopTurn contour pocket pre centering
_ST=_ST+100
N10 F_CP_DR(_T,_TF,_DD,_F,_FAA,_S,_SA,_TMOD,_NAME,_Z0,_Z1,_Z1A,,_ST,,,,,_TR,_DR,_DXY,_UXY,_DXYA,,,_C0,_X,_Y,_BA)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_CP_CO_SPF
PROC F_CP_CO(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,STRING[70] _NAME,INT _BA,REAL _R1,REAL _Z0,REAL _Z1,INT _Z1A,REAL _DXY,REAL _DZ,REAL _UXY,REAL _UZ,REAL __X,REAL __Y,REAL _FZ,INT _FZA,REAL _FZR,REAL _RP,REAL _SC,INT _DIR,STRING[21] _CHECK1,STRING[21] _CHECK2,INT _ST,INT _METRIC,REAL _SCAL_XY,REAL _SCAL_Z,STRING[70] _NAME_DR,INT _DXYA,REAL _MAX_R,REAL _C0,REAL _FS,REAL _ZFS,INT _ZFSA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn contour pocket
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _P29,_PMZ,_TM1,_TM3,_TM6,_TM7,_TM8,_TM9,_MERKER_C=0,_MD_CLAMP,_VARI,_UMODE,_GMODE,_DMODE,_AMODE,S_MD_BREAK,_BA1,_BA10
DEF REAL _FAK1,_FAK2,_RPX,_RPZ,_RPZB,_X,_Y,_SPZ,_Z_TR,S_ANP
DEF FRAME _CYC_FR
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
IF(_E_S_LINE)
IF(_E_S_LINE==$P_LINENO[0])
_E_S_LINE=0
ELSE
IF(_SC_CHAN=="")
GOTOF _RETS
ENDIF
ENDIF
ENDIF
OFFN=0
_P29=$P_GG[29]
DIAMCYCOF
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_CP_CO_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
ENDIF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM7=TRUNC(_TMOD/1000000) MOD 10
_TM8=TRUNC(_TMOD/10000000) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
IF(_TM1==0)AND(_TM7)
_Z0=_Z0/2
IF(_Z1A==90)
_Z1=_Z1/2
ENDIF
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N10 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
F_SP_RPT(2,_TMOD)
IF S_CALL_FROM_MA_JOG_STEP
_E_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RPZB=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RPZB=_F_RP_ACT*_FAK2
ENDIF
IF(_TM1==6)
IF(_RPZB<=_Z0+_SC) GOTOF _FEHL1
ENDIF
IF(_TM3==1)
_PMZ=1
ELSE
_PMZ=-1
ENDIF
_BA1=_BA B_AND 'B111'
_VARI=_BA B_AND 'B111'
IF(_VARI==2)
_VARI=3
ENDIF
IF(_FZA>=1)
_BA10=_FZA-1
_VARI=_VARI+10*(_FZA-1)
ENDIF
_VARI=_VARI+1000*(_ST MOD 10)
IF(_BA B_AND 'B10000000')
_VARI=_VARI+10000
ENDIF
_GMODE=0
IF($P_F_TYPE==11)OR($P_F_TYPE==33)
IF(_FZA==0)
_DMODE=10
ELSE
_DMODE=20
ENDIF
ELSE
IF(_FZA==0)
_DMODE=20
ELSE
_DMODE=10
ENDIF
ENDIF
_DMODE=_DMODE+100
IF((_ST DIV 100) MOD 10)
_DMODE=_DMODE+100
ENDIF
IF(_TM8==1)
_DMODE=_DMODE+10000
ENDIF
_AMODE=0
IF(_Z1A==91)
_AMODE=_AMODE+1
ENDIF
IF(_DXYA==1)
_AMODE=_AMODE+10
ENDIF
IF(_ZFSA==91)
_AMODE=_AMODE+100
ENDIF
IF(((_BA B_AND 'H100')=='H100')AND(((_BA B_AND 'H7')=='H1')OR((_BA B_AND 'H7')=='H2')))OR(_FZA==2)
_AMODE=_AMODE+1000
ENDIF
_NAME="/_N_WKS_DIR/_N_TEMP_WPD/_N_"<<_NAME<<"_MPF"
_X=__X
_Y=__Y
IF((_BA B_AND 'B10100000')=='B00000000')
_CYC_FR=$P_CYCFRAME
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_Z0)
ELSE
F_SP_TRA(2102,_Z0)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,_Z0,_C0)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_TM1==3)
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
N11 CYCLE63(_NAME,_VARI,_RPZB,_Z0,_SC,_Z1,_F,_FZ,_DXY,_DZ,_UXY,_UZ,_E_DIR,_X,_Y,_FZR,_FZ,_FZ,_FS,_ZFS,,,_UMODE,_GMODE+200,_DMODE,_AMODE)
$P_CYCFRAME=_CYC_FR
F_SP_TRA(0)
_X=_SC_POS[0]*_FAK1
_Y=_SC_POS[1]*_FAK1
S_ANP=_SC_POS[3]*_FAK1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Startpunkt berechnet:")
WRITE(_LOG,_LOG_FILE,"_SC_POS[0]="<<_SC_POS[0]<<" _SC_POS[1]="<<_SC_POS[1]<<" _SC_POS[2]="<<_SC_POS[2]<<" _SC_POS[3]="<<_SC_POS[3])
ENDIF
ELSE
S_ANP=SQRT(POT(_X)+POT(_Y))
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Startpunkt: X="<<_X<<" Y="<<_Y<<" S_ANP"<<S_ANP)
ENDIF
IF(_TM1<2)
_SPZ=_Y
IF(_F_RELEAS==0)
IF(_TM3==0)
_RPX=_F_RPT[0]*_FAK2
ELSE
_RPX=_F_RPT[2]*_FAK2
ENDIF
ENDIF
IF(_TM1==0)
F_SP_RP(0,_RPX,_SPZ,0)
IF(_TM9==1)
F_SP_TRA(103102,_Z0)
ELSE
F_SP_TRA(3102,_Z0)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,_Z0,_C0)
F_SP_RP(0,_RPX,_SPZ,0,_X)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N15 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
IF(_F_RELEAS==0)
_XX=$P_AXN3 _ZZ=$P_AXN2 _YY=$P_AXN1
SBLON
N20 G90 G0 G40 AX[_XX]=_RPX AX[_ZZ]=_SPZ AX[_YY]=_X
SBLOF
ENDIF
ELSE
IF(_F_RELEAS==0)
REPEAT _AXNAME_A _AXNAME_E
_Z_TR=$P_PFRAME[_ZZ,TR]*_FAK1
IF($MN_MM_FRAME_FINE_TRANS)
_Z_TR=_Z_TR+$P_PFRAME[_ZZ,FI]*_FAK1
ENDIF
IF(_TM1==6)
_RPZ=_F_RPT[5]*_FAK2
ELSE
IF(_TM3==0)
_RPZ=_F_RPT[1]*_FAK2-_Z_TR
ELSE
_RPZ=_F_RPT[3]*_FAK2-_Z_TR
ENDIF
ENDIF
ENDIF
IF(_TM1==2)
F_SP_RP(0,S_ANP,_RPZ,0)
IF(_TM9==1)
F_SP_TRA(103122)
ELSE
F_SP_TRA(3122)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
F_SP_RP(9,_X,_RPZ,0,_Y)
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N30 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
IF(_F_RELEAS==0)
_XX=$P_AXN1 _ZZ=$P_AXN3 _YY=$P_AXN2
SBLON
N35 G90 G0 G40 AX[_XX]=_X AX[_ZZ]=_RPZ AX[_YY]=_Y
SBLOF
ENDIF
ENDIF
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
IF(_TM1==0)OR(_TM1==2)
IF(_TM6==2)AND(_BA10==0)AND(_BA1==1)
IF(_TM9==1)
_MERKER_C=3
ELSE
_MERKER_C=1
ENDIF
ELSE
IF(_TM9==1)
_MERKER_C=4
ELSE
_MERKER_C=0
ENDIF
ENDIF
ELSE
IF(_TM6==2)
_MERKER_C=2
ELSE
_MERKER_C=0
ENDIF
ENDIF
IF(_MERKER_C==0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_MERKER_C==1)
_VARI=_VARI+100
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==2)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>1)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
IF(_MERKER_C==3)
_VARI=_VARI+300
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==4)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N40 CYCLE63(_NAME,_VARI,_RPZB,_Z0,_SC,_Z1,_F,_FZ,_DXY,_DZ,_UXY,_UZ,_E_DIR,_X,_Y,_FZR,_FZ,_FZ,_FS,_ZFS,,,_UMODE,_GMODE,_DMODE,_AMODE)
ELSE
_SC_FIRST_CONT=0
ENDIF
IF(_MERKER_C==1)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
IF(_MERKER_C==3)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
G[29]=_P29
_RETS:
_F_RELEAS=0
SBLON
RET
_AXNAME_A:
IF($P_GG[6]==1)
_XX=$P_AXN1
_ZZ=$P_AXN3
ELSE
IF($P_GG[6]==2)
_XX=$P_AXN2
_ZZ=$P_AXN1
ELSE
_XX=$P_AXN3
_ZZ=$P_AXN2
ENDIF
ENDIF
_AXNAME_E:
_FEHL1: STOPRE
N906341 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_CP_DR_SPF
PROC F_CP_DR(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,STRING[70] _NAME,REAL _Z0,REAL _Z1,INT _Z1A,REAL _UZ,INT _ST,INT _METRIC,REAL _SCAL_XY,REAL _SCAL_Z,REAL _MAX_R,STRING[32] _TR,INT _DR,REAL _DXY,REAL _UXY,INT _DXYA,STRING[21] _CHECK1,STRING[21] _CHECK2,REAL _C0,REAL __X,REAL __Y,INT _BA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn contour pocket pre drilling
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _P29,_PMZ,_TM1,_TM3,_TM6,_TM7,_MD_CLAMP,_VARI,_UMODE,_GMODE,_DMODE,_AMODE
DEF REAL _FAK1,_FAK2,_RPX,_RPZB,_RPZ,_X,_Y,_SPZ,_Z_TR,_SC
DEF FRAME _CYC_FR
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
IF(_E_S_LINE)
IF(_E_S_LINE==$P_LINENO[0])
_E_S_LINE=0
ELSE
IF(_SC_CHAN=="")
GOTOF _RETS
ENDIF
ENDIF
ENDIF
OFFN=0
_P29=$P_GG[29]
DIAMCYCOF
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_CP_DR_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
ENDIF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM6=TRUNC(_TMOD/100000) MOD 10
_TM7=TRUNC(_TMOD/1000000) MOD 10
IF(_TM1==0)AND(_TM7)
_Z0=_Z0/2
IF(_Z1A==90)
_Z1=_Z1/2
ENDIF
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N10 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
F_SP_RPT(2,_TMOD)
IF S_CALL_FROM_MA_JOG_STEP
_E_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RPZB=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RPZB=_F_RP_ACT*_FAK2
ENDIF
IF(_TM1==6)
IF(_RPZB<=_Z0+_SC) GOTOF _FEHL1
ENDIF
IF(_TM3==1)
_PMZ=1
ELSE
_PMZ=-1
ENDIF
_X=__X
_Y=__Y
_VARI=0
_VARI=_VARI+1000*(_ST MOD 10)
IF(_BA B_AND 'H80')
_VARI=_VARI+10000
ENDIF
_UMODE=0
_GMODE=0
_DMODE=10
IF((_ST DIV 100) MOD 10)
_DMODE=_DMODE+10
ENDIF
_AMODE=0
IF(_Z1A==91)
_AMODE=_AMODE+1
ENDIF
IF(_DXYA==1)
_AMODE=_AMODE+10
ENDIF
IF((_BA B_AND 'H100')=='H100')
_AMODE=_AMODE+1000
ENDIF
_NAME="/_N_WKS_DIR/_N_TEMP_WPD/_N_"<<_NAME<<"_MPF"
IF((_BA B_AND 'B100000')=='B000000')
_CYC_FR=$P_CYCFRAME
IF(_TM1<2)
IF(_TM1==0)
F_SP_TRA(2102,_Z0)
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,_Z0,_C0)
ENDIF
ELSE
IF(_TM1==2)
F_SP_TRA(2122)
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_TM1==3)
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
N11 CYCLE64(_NAME,_VARI,_RPZB,_Z0,_SC,_Z1,_F,_DXY,_UXY,_UZ,_E_DIR,_TR,_DR,_UMODE,_GMODE+200,_DMODE,_AMODE,_X,_Y)
$P_CYCFRAME=_CYC_FR
_X=_SC_POS[0]
_Y=_SC_POS[1]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Startpunkt berechnet:")
WRITE(_LOG,_LOG_FILE,"_SC_POS[0]="<<_SC_POS[0]<<" _SC_POS[1]="<<_SC_POS[1]<<" _SC_POS[2]="<<_SC_POS[2]<<" _SC_POS[3]="<<_SC_POS[3])
ENDIF
ENDIF
F_SP_TRA(0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Startpunkt: X="<<_X<<" Y="<<_Y)
ENDIF
REPEAT S_EBENE_A S_EBENE_E
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_TM1==1)OR(_TM1==3)OR(_TM1==6)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N40 CYCLE64(_NAME,_VARI,_RPZB,_Z0,_SC,_Z1,_F,_DXY,_UXY,_UZ,_E_DIR,_TR,_DR,_UMODE,_GMODE,_DMODE,_AMODE,_X,_Y)
ELSE
_SC_FIRST_CONT=0
ENDIF
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
G[29]=_P29
_RETS:
_F_RELEAS=0
SBLON
RET
_AXNAME_A:
IF($P_GG[6]==1)
_XX=$P_AXN1
_ZZ=$P_AXN3
ELSE
IF($P_GG[6]==2)
_XX=$P_AXN2
_ZZ=$P_AXN1
ELSE
_XX=$P_AXN3
_ZZ=$P_AXN2
ENDIF
ENDIF
_AXNAME_E:
S_EBENE_A:
IF(_TM1<2)
_SPZ=_Y
IF(_F_RELEAS==0)
IF(_TM3==0)
_RPX=_F_RPT[0]*_FAK2
ELSE
_RPX=_F_RPT[2]*_FAK2
ENDIF
ENDIF
IF(_TM1==0)
F_SP_RP(0,_RPX,_SPZ,0)
F_SP_TRA(3102,_Z0)
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,_Z0,_C0)
F_SP_RP(0,_RPX,_SPZ,0,_X)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N15 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
IF(_F_RELEAS==0)
_XX=$P_AXN3 _ZZ=$P_AXN2 _YY=$P_AXN1
SBLON
N20 G90 G0 G40 AX[_XX]=_RPX AX[_ZZ]=_SPZ AX[_YY]=_X
SBLOF
ENDIF
ELSE
IF(_F_RELEAS==0)
REPEAT _AXNAME_A _AXNAME_E
_Z_TR=$P_PFRAME[_ZZ,TR]*_FAK1
IF($MN_MM_FRAME_FINE_TRANS)
_Z_TR=_Z_TR+$P_PFRAME[_ZZ,FI]*_FAK1
ENDIF
IF(_TM1==6)
_RPZ=_F_RPT[5]*_FAK2
ELSE
IF(_TM3==0)
_RPZ=_F_RPT[1]*_FAK2-_Z_TR
ELSE
_RPZ=_F_RPT[3]*_FAK2-_Z_TR
ENDIF
ENDIF
ENDIF
IF(_TM1==2)
F_SP_RP(0,SQRT(POT(_X)+POT(_Y)),_RPZ,0)
F_SP_TRA(3122)
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
F_SP_RP(9,_X,_RPZ,0,_Y)
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N30 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
IF(_F_RELEAS==0)
_XX=$P_AXN1 _ZZ=$P_AXN3 _YY=$P_AXN2
SBLON
N35 G90 G0 G40 AX[_XX]=_X AX[_ZZ]=_RPZ AX[_YY]=_Y
SBLOF
ENDIF
ENDIF
IF(_TM6==0)
_TM6=2
ENDIF
S_EBENE_E:
_FEHL1: STOPRE
N906421 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_CP_RE_SPF
PROC F_CP_RE(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,STRING[70] _NAME,REAL _R1,REAL _R2,REAL _Z0,REAL _Z1,INT _Z1A,REAL _DXY,REAL _DZ,REAL _UXY,REAL _UZ,REAL _RP,REAL _SC,INT _DIR,STRING[21] _CHECK1,STRING[21] _CHECK2,INT _ST,STRING[32] _TR,INT _DR,INT _METRIC,REAL _SCAL_XY,REAL _SCAL_Z,INT _DXYA,REAL _C0,REAL __X,REAL __Y,INT _BA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn contour pocket residual material
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _P29,_PMZ,_TM1,_TM3,_TM6,_TM7,_TM9,_MD_CLAMP,_VARI,_UMODE,_GMODE,_DMODE,_AMODE,S_MD_BREAK,_MERKER_C=0
DEF REAL _FAK1,_FAK2,_RPX,_RPZ,_RPZB,_X,_Y,_SPZ,_Z_TR
DEF FRAME _CYC_FR
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
IF(_E_S_LINE)
IF(_E_S_LINE==$P_LINENO[0])
_E_S_LINE=0
ELSE
IF(_SC_CHAN=="")
GOTOF _RETS
ENDIF
ENDIF
ENDIF
OFFN=0
_P29=$P_GG[29]
DIAMCYCOF
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_CP_RE_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
ENDIF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM7=TRUNC(_TMOD/1000000) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
IF(_TM1==0)AND(_TM7)
_Z0=_Z0/2
IF(_Z1A==90)
_Z1=_Z1/2
ENDIF
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N10 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
F_SP_RPT(2,_TMOD)
IF S_CALL_FROM_MA_JOG_STEP
_E_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RPZB=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RPZB=_F_RP_ACT*_FAK2
ENDIF
IF(_TM1==6)
IF(_RPZB<=_Z0+_SC) GOTOF _FEHL1
ENDIF
IF(_TM3==1)
_PMZ=1
ELSE
_PMZ=-1
ENDIF
_VARI=1
_VARI=_VARI+1000*(_ST MOD 10)
_UMODE=0
_GMODE=0
_DMODE=1100
IF((_ST DIV 100) MOD 10)
_DMODE=_DMODE+100
ENDIF
_AMODE=0
IF(_Z1A==91)
_AMODE=_AMODE+1
ENDIF
IF(_DXYA==1)
_AMODE=_AMODE+10
ENDIF
_NAME="/_N_WKS_DIR/_N_TEMP_WPD/_N_"<<_NAME<<"_MPF"
_X=__X
_Y=__Y
IF((_BA B_AND 'B100000')=='B000000')
_CYC_FR=$P_CYCFRAME
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_Z0)
ELSE
F_SP_TRA(2102,_Z0)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,_Z0,_C0)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_TM1==3)
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
N11 CYCLE63(_NAME,_VARI,_RPZB,_Z0,_SC,_Z1,_F,,_DXY,_DZ,_UXY,_UZ,_E_DIR,,,,,,,,_TR,_DR,_UMODE,_GMODE+200,_DMODE,_AMODE)
$P_CYCFRAME=_CYC_FR
F_SP_TRA(0)
_X=_SC_POS[0]
_Y=_SC_POS[1]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Startpunkt berechnet:")
WRITE(_LOG,_LOG_FILE,"_SC_POS[0]="<<_SC_POS[0]<<" _SC_POS[1]="<<_SC_POS[1]<<" _SC_POS[2]="<<_SC_POS[2]<<" _SC_POS[3]="<<_SC_POS[3])
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Startpunkt: X="<<_X<<" Y="<<_Y)
ENDIF
IF(_TM1<2)
_SPZ=_Y
IF(_F_RELEAS==0)
IF(_TM3==0)
_RPX=_F_RPT[0]*_FAK2
ELSE
_RPX=_F_RPT[2]*_FAK2
ENDIF
ENDIF
IF(_TM1==0)
F_SP_RP(0,_RPX,_SPZ,0)
IF(_TM9==1)
F_SP_TRA(103102,_Z0)
ELSE
F_SP_TRA(3102,_Z0)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,_Z0,_C0)
F_SP_RP(0,_RPX,_SPZ,0,_X)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N15 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
IF(_F_RELEAS==0)
_XX=$P_AXN3 _ZZ=$P_AXN2 _YY=$P_AXN1
SBLON
N20 G90 G0 G40 AX[_XX]=_RPX AX[_ZZ]=_SPZ AX[_YY]=_X
SBLOF
ENDIF
ELSE
IF(_F_RELEAS==0)
REPEAT _AXNAME_A _AXNAME_E
_Z_TR=$P_PFRAME[_ZZ,TR]*_FAK1
IF($MN_MM_FRAME_FINE_TRANS)
_Z_TR=_Z_TR+$P_PFRAME[_ZZ,FI]*_FAK1
ENDIF
IF(_TM1==6)
_RPZ=_F_RPT[5]*_FAK2
ELSE
IF(_TM3==0)
_RPZ=_F_RPT[1]*_FAK2-_Z_TR
ELSE
_RPZ=_F_RPT[3]*_FAK2-_Z_TR
ENDIF
ENDIF
ENDIF
IF(_TM1==2)
F_SP_RP(0,SQRT(POT(_X)+POT(_Y)),_RPZ,0)
IF(_TM9==1)
F_SP_TRA(103122)
ELSE
F_SP_TRA(3122)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
F_SP_RP(0,_X,_RPZ,0,_Y)
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N30 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
IF(_F_RELEAS==0)
_XX=$P_AXN1 _ZZ=$P_AXN3 _YY=$P_AXN2
SBLON
N35 G90 G0 G40 AX[_XX]=_X AX[_ZZ]=_RPZ AX[_YY]=_Y
SBLOF
ENDIF
ENDIF
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
IF(_TM1==0)OR(_TM1==2)
IF(_TM9==1)
_MERKER_C=4
ELSE
_MERKER_C=0
ENDIF
ELSE
IF(_TM6==2)
_MERKER_C=2
ELSE
_MERKER_C=0
ENDIF
ENDIF
IF(_MERKER_C==0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_MERKER_C==2)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>1)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
IF(_MERKER_C==4)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N40 CYCLE63(_NAME,_VARI,_RPZB,_Z0,_SC,_Z1,_F,,_DXY,_DZ,_UXY,_UZ,_E_DIR,,,,,,,,_TR,_DR,_UMODE,_GMODE,_DMODE,_AMODE)
ELSE
_SC_FIRST_CONT=0
ENDIF
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
G[29]=_P29
_RETS:
_F_RELEAS=0
SBLON
RET
_AXNAME_A:
IF($P_GG[6]==1)
_XX=$P_AXN1
_ZZ=$P_AXN3
ELSE
IF($P_GG[6]==2)
_XX=$P_AXN2
_ZZ=$P_AXN1
ELSE
_XX=$P_AXN3
_ZZ=$P_AXN2
ENDIF
ENDIF
_AXNAME_E:
_FEHL1: STOPRE
N906361 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_DR_SPF
PROC F_DR(INT _OB,INT _BO,INT _IDD,STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,REAL __Z1,INT _Z1A,REAL _DT,INT _POS,INT _BA,INT _MODE,REAL S_ZA,REAL S_FA,REAL S_ZD,REAL S_FD,REAL S_D3D) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Drilling
DEF AXIS _ZZ
DEF INT _PM,_TYP=0,_TM1,_TM3,_TM6,_MAN,_I,_DIR,_AMODE[3],_GMODE,_MD_CLAMP,_VARI
DEF REAL _FAK1,_FAK2,_Z,_SD,_SC,_ZREF,_RP,_RTP,_Z1
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_ZREF=_F_PS_REF*_FAK2
_RP=_F_RP_ACT*_FAK2
IF(_OB==0)
IF(NOT _E_MC)
GOTOF _RET
ENDIF
IF(_IDD>=0)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD]
_DD=_E_TR[_IDD,1] _F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6] _Z1=_E_TR[_IDD,7] _Z1A=_E_TR[_IDD,8]
_DT=_E_TR[_IDD,9] _BA=_E_TR[_IDD,10] _MODE=_E_TR[_IDD,11]
S_ZA=_E_TR[_IDD,12] S_FA=_E_TR[_IDD,13] S_ZD=_E_TR[_IDD,14] S_FD=_E_TR[_IDD,15]
_IDD=-1
ENDIF
_ZZ=$P_AXN3
_TM1=_TMOD MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM6=TRUNC(_TMOD/100000) MOD 10
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
IF($P_MC==0)
_F_INIT=1
ENDIF
ELSE
_SC=_E_SC*_FAK2
ENDIF
_Z=_Z1
IF(_Z1A MOD 2==1)
IF(_TM3==0)
_Z=_ZREF-ABS(_Z)
ELSE
_Z=_ZREF+ABS(_Z)
ENDIF
ENDIF
IF(_Z>_ZREF)
_PM=1
ELSE
_PM=-1
ENDIF
IF((_TM3==0)AND(_PM==1))OR((_TM3==1)AND(_PM==-1)) GOTOF _FEHL3
IF(_Z1A==0) OR (_Z1A==1)
IF($P_TOOLNO)
_TYP=$P_AD[1]
ENDIF
IF(_TYP<200) OR (_TYP>299) GOTOF _FEHL1
IF($P_TOOLNO>0)AND(_TYP<>205)AND(_TYP<>210)AND(_TYP<>231)AND(_TYP<>240)AND(_TYP<>241)AND(_TYP<>242)AND(_TYP<>250)
IF(_Z1A<90)AND($P_AD[24]>0)AND($P_AD[24]<180)
_Z=_Z+$P_TOOLR*_FAK1/TAN($P_AD[24]/2)*_PM
ENDIF
ENDIF
ENDIF
_AMODE[1]=2 _GMODE=0
_AMODE[2]=(_BA B_AND 'B11000')/'B1000'*10
_VARI=(_BA B_AND 'B10000000')/'B10000000'*1000+(_BA B_AND 'B100000000')/'B100000000'*10000
F_SP_ED(_SD)
_E_BO=_BO+(_E_BO B_AND 65535)
_RTP=_ZREF-(_SC+_SD)*_PM
N10 F_TFS(,,,_F,_FAA,,0,2,0)
_AMODE[0]=_AMODE[1]+_AMODE[2]+_MODE
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N30 CYCLE82(_RTP,_ZREF,_SC,_Z,,_DT,_GMODE,0,_AMODE[0],_VARI,S_ZA,S_FA,S_ZD,S_FD)
ELSE
N35 G0 AX[_ZZ]=_ZREF
ENDIF
ELSE
IF(_OB==3)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD] _DD=_E_TR[_IDD,1]
_F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4] _SA=_E_TR[_IDD,5]
_TMOD=_E_TR[_IDD,6]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_MAN==0)
N40 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
_F_RELEAS=0
ELSE
_F_INIT=2
_F_RELEAS=1
N41 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+100+_TM3*100000)
ENDIF
ENDIF
ELSE
IF(_E_IR<_E_MAX)
_Z1=__Z1
IF(_TMOD MOD 10 ==0)
IF(_Z1A==0)OR(_Z1A==90)
IF((_BA B_AND 'B11000')<>'B00000')
_Z1=_Z1/2
ENDIF
ENDIF
ENDIF
_E_TS1[_E_IR]=_T _E_TS2[_E_IR]=_TF
_E_TR[_E_IR,0]=SET(2,_DD,_F,_FAA,_S,_SA,_TMOD,_Z1,_Z1A,_DT,_BA,_MODE,S_ZA,S_FA,S_ZD,S_FD)
_E_IR=_E_IR+1
IF(_POS>=0)
_E_POS=_POS
ENDIF
ELSE
GOTOF _FEHL2
ENDIF
IF(_OB==2)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
_E_S_LINE=0
_RETS:
RET
_FEHL1: STOPRE
N908201 SETAL(61070)
RET
_FEHL2: STOPRE
N908202 SETAL(61200)
RET
_FEHL3: STOPRE
N908203 SETAL(61242)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_DR_BGF_SPF
PROC F_DR_BGF(INT _OB,INT _BO,INT _IDD,STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,REAL __Z1,INT _Z1A,REAL _D,REAL _DF,REAL _V1,REAL _ZR,REAL _FR,INT _FRA,REAL _F2,INT _F2A,REAL _Z2,REAL _DG,REAL _P,INT _PA,REAL _FI,REAL _FM,INT _FZG,INT _FZZ,INT _FZN,REAL _FS,INT _FSA,INT _POS,STRING[20] _PTAB,STRING[20] _PTABA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Drill and thread milling
DEF AXIS _ZZ,_CC
DEF INT _DIR,_I,_MD_CLAMP,_PM,_TM1,_TM3,_TM6,_MAN,_AMODE[3],_VARI,_CDIR,_FFA,_PITA
DEF REAL _FAK1,_FAK2,_DAM,_RTP,_SC,_SD,_Z,_Z1,_ZREF,_ANG
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_ZREF=_F_PS_REF*_FAK2
IF(_OB==0)
IF(NOT _E_MC)
GOTOF _RET
ENDIF
IF(_IDD>=0)
_T =_E_TS1[_IDD] _TF=_E_TS2[_IDD]
_DD =_E_TR[_IDD,1] _F =_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA =_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6] _BA =_E_TR[_IDD,7] _Z1=_E_TR[_IDD,8]
_Z1A=_E_TR[_IDD,9] _DG=_E_TR[_IDD,10] _DF =_E_TR[_IDD,11] _V1=_E_TR[_IDD,12]
_ZR =_E_TR[_IDD,13] _FR=_E_TR[_IDD,14] _FRA=_E_TR[_IDD,15] _F2=_E_TR[_IDD,16]
_F2A=_E_TR[_IDD,17] _Z2=_E_TR[_IDD,18] _D =_E_TR[_IDD,19] _P=_E_TR[_IDD,20]
_PA =_E_TR[_IDD,21] _FS=_E_TR[_IDD,22] _FSA=_E_TR[_IDD,23]
_IDD=-1
ENDIF
_TM1=_TMOD MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM6=TRUNC(_TMOD/100000) MOD 10
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
IF($P_MC==0)
_F_INIT=1
ENDIF
ELSE
_SC=_E_SC*_FAK2
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_CC=_F_S_AX[_F_MASPI]
_ANG=_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]-$P_ACTFRAME[_CC,TR]
ENDIF
IF(_TM1<2)
F_SP_TRA(2012,,_ANG)
ELSE
IF(_TM1==2)
F_SP_TRA(2122)
ELSE
F_SP_TRA(2002+_TM1*10,,_ANG)
ENDIF
ENDIF
_ZZ=$P_AXN3
_Z=_Z1
IF(_Z1A MOD 2==1)
IF(_TM3==0)
_Z=_ZREF-ABS(_Z)
ELSE
_Z=_ZREF+ABS(_Z)
ENDIF
ENDIF
_AMODE[1]=0
IF(_Z>_ZREF)
_PM=1
ELSE
_PM=-1
ENDIF
IF((_TM3==0)AND(_PM==1))OR((_TM3==1)AND(_PM==-1)) GOTOF _FEHL1
IF((_BA B_AND 'B11000000')=='B10000000')
_AMODE[2]=10 _DAM=_DF
ELSE
IF((_BA B_AND 'B11000000')=='B01000000')
_AMODE[2]=0 _DAM=_DF
ELSE
_AMODE[2]=10 _DAM=_DF*100
ENDIF
ENDIF
_AMODE[0]=_AMODE[1]+_AMODE[2]
_VARI=0
_VARI=_VARI+10*(_BA B_AND 'B000010')/'B000010'
_VARI=_VARI+100*(_BA B_AND 'B100000')/'B100000'
_VARI=_VARI+1000*(_BA B_AND 'B000100')/'B000100'
_VARI=_VARI+10000*(_BA B_AND 'B000001')
IF(_BA B_AND 'B011000'=='B000000')
_CDIR=0
ELSE
IF(_BA B_AND 'B011000'=='B001000')
_CDIR=1
ELSE
_CDIR=4
ENDIF
ENDIF
_FFA=0
IF(_FAA==3)
_FFA=_FFA+1
ENDIF
IF(_FRA==3)
_FFA=_FFA+10
ENDIF
IF(_F2A==2)
_FFA=_FFA+100
ENDIF
IF(_FSA==2)
_FFA=_FFA+1000
ENDIF
IF(_PA _DEC2 == 0)
_PITA=1
ELSE
IF(_PA _DEC1 == 0)
_PITA=1
ELSE
IF(_PA _DEC1 == 1)
_PITA=3
ELSE
IF(_PA _DEC1 == 2)
_PITA=4
ELSE
_PITA=2
ENDIF
ENDIF
ENDIF
ENDIF
F_SP_ED(_SD)
_E_BO=_BO+(_E_BO B_AND 65535)
_RTP=_ZREF-(_SC+_SD)*_PM
N10 F_TFS(,,,_F,_FAA,,0,2,0)
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N30 CYCLE78(_RTP,_ZREF,_SC,_Z,$SCS_DRILL_SPOT_DIST*_FAK1,_D,_ZR,_DG,_P,_PITA,_DAM,_V1,_VARI,_CDIR,_Z2,_F,_FR,_F2,_FS,_FFA,,,,,0,_AMODE[0])
ELSE
N35 G0 AX[_ZZ]=_ZREF
ENDIF
ELSE
IF(_OB==3)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD] _DD=_E_TR[_IDD,1]
_F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_MAN==0)
N40 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
_F_RELEAS=0
ELSE
_F_INIT=2
_F_RELEAS=1
N41 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+100+_TM3*100000)
ENDIF
ENDIF
ELSE
IF(_E_IR<_E_MAX)
_Z1=__Z1
IF(_TMOD MOD 10 ==0)
IF(_Z1A==90)
IF((_BA B_AND 'B11000')<>'B00000')
_Z1=_Z1/2
ENDIF
ENDIF
ENDIF
_E_TS1[_E_IR]=_T _E_TS2[_E_IR]=_TF
_E_TR[_E_IR,0]=SET(8,_DD,_F,_FAA,_S,_SA,_TMOD,_BA,_Z1,_Z1A,_DG,_DF,_V1,_ZR,_FR,_FRA,_F2,_F2A,_Z2,_D,_P,_PA,_FS,_FSA)
_E_IR=_E_IR+1
IF(_POS>=0)
_E_POS=_POS
ENDIF
ELSE
GOTOF _FEHL2
ENDIF
IF(_OB==2)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
_E_S_LINE=0
_RETS:
RET
_FEHL1: STOPRE
N907801 SETAL(61242)
RET
_FEHL2: STOPRE
N907803 SETAL(61200)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_DR_BOR_SPF
PROC F_DR_BOR(INT _OB,INT _BO,INT _IDD,STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,REAL __Z1,INT _Z1A,REAL _DT,INT _ST,INT _POS,REAL _A0,REAL _D0,INT _BA,REAL S_D3D) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Boring 2, Turning
; Funktion ist so:
DEF AXIS _XX,_YY,_ZZ,S_AX1,S_AX3
DEF INT _DIR,_I,_M3_5,_MD_CLAMP,_PM,_SDIR,_TM1,_TM3,_TM6,_MAN,_AMODE[3],_GMODE,_UMODE
DEF REAL _FAK1,_FAK2,_POSS,_RPA,_RPAP,_RPE,_RTP,_SC,_SD,_SD1,_SD2,_Z,_Z1,_ZREF,_RPO,_XS,_YS,S_RPA_MKS,S_RPO_MKS,S_ANP,S_VAA
DEF FRAME S_FVAR
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_ZREF=_F_PS_REF*_FAK2
IF(_OB==0)
IF(NOT _E_MC)
GOTOF _RET
ENDIF
IF(_IDD>=0)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD]
_DD=_E_TR[_IDD,1] _F =_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S =_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6] _Z1=_E_TR[_IDD,7] _Z1A=_E_TR[_IDD,8]
_DT=_E_TR[_IDD,9] _ST=_E_TR[_IDD,10] _A0=_E_TR[_IDD,11] _D0 =_E_TR[_IDD,12]
_BA=_E_TR[_IDD,13]
_IDD=-1
ENDIF
_TM1=_TMOD MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM6=TRUNC(_TMOD/100000) MOD 10
S_AX3=$P_AXN3
IF(_TM1<=1)
_ZZ=$P_AXN2
IF(_TM1==1)
S_AX1=$P_AXN1
ELSE
_XX=$P_AXN3
ENDIF
ELSE
S_AX1=$P_AXN1
IF(_TM1==2)AND($P_TRAFO)
_XX=$P_AXN1
_YY=$P_AXN2
_ZZ=$P_AXN3
ENDIF
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
IF($P_MC==0)
_F_INIT=1
ENDIF
ELSE
_SC=_E_SC*_FAK2
ENDIF
_Z=_Z1
IF(_Z1A MOD 2==1)
IF(_TM3==0)
_Z=_ZREF-ABS(_Z)
ELSE
_Z=_ZREF+ABS(_Z)
ENDIF
ENDIF
IF(_Z>_ZREF)
_PM=1
ELSE
_PM=-1
ENDIF
IF((_TM3==0)AND(_PM==1))OR((_TM3==1)AND(_PM==-1)) GOTOF _FEHL1
_M3_5=TRUNC($TC_DP25[$P_TOOLNO,1]/256)MOD 4
IF(_M3_5==2)
_SDIR=4
ELSE
_SDIR=3
ENDIF
IF(_D0<0)OR(_A0<0)GOTOF _FEHL2
IF (NOT ($SCS_FUNCTION_MASK_DRILL_SET B_AND 'B1000000') )
_POSS=(_A0+2*360+_E_C_DIR*$P_ACTFRAME[S_AX3,RT])MOD 360
ELSE
_POSS=_A0
ENDIF
IF(_ST==1)
_RPE=_D0
_RPAP=-_PM*_RPE/$P_ACTFRAME[S_AX3,SC]
IF(_TM1==0)
_RPA=0
_RPO=-_RPE/$P_ACTFRAME[_ZZ,SC]
ELSE
_RPA=-_RPE/$P_ACTFRAME[S_AX1,SC]
_RPO=0
ENDIF
IF(_TM1==2)AND($P_TRAFO)
IF(_RPE<>0)
_YY=$P_AXN2
S_FVAR=CTRANS(X,$P_EP[_XX],Y,$P_EP[_YY])
S_FVAR=$P_PFRAME:S_FVAR
_XS=S_FVAR[_XX,TR]*_FAK1
_YS=S_FVAR[_YY,TR]*_FAK1
S_ANP=ABS(SQRT(_XS*_XS+_YS*_YS))
IF(S_ANP<_RPE)
GOTOF _FEHL4
ENDIF
S_VAA=_RPA/S_ANP
S_RPA_MKS=_XS*S_VAA
S_RPO_MKS=_YS*S_VAA
S_FVAR=CTRANS()
S_FVAR=CROT(Z,-$P_PFRAME[_ZZ,RT]):CTRANS(X,S_RPA_MKS,Y,S_RPO_MKS)
_RPA=S_FVAR[_XX,TR]
_RPO=S_FVAR[_YY,TR]
ENDIF
ENDIF
ELSE
_RPA=0
_RPO=0
_RPAP=0
ENDIF
_GMODE=0
_AMODE[1]=2
_AMODE[2]=(_BA B_AND 'B11000')/'B1000'*10
_AMODE[0]=_AMODE[1]+_AMODE[2]
F_SP_ED(_SD)
_E_BO=_BO+(_E_BO B_AND 65535)
_RTP=_ZREF-(_SC+_SD)*_PM
N10 F_TFS(,,,_F,_FAA,,0,2,0)
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_UMODE=3+_F_MASPI*10
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N30 CYCLE86(_RTP,_ZREF,_SC,_Z,,_DT,_SDIR,_RPA,_RPO,_RPAP,_POSS,_GMODE,0,_AMODE[0],_UMODE)
ELSE
N35 G0 AX[S_AX3]=_ZREF
ENDIF
ELSE
IF(_OB==3)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD] _DD=_E_TR[_IDD,1]
_F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_MAN==0)
N40 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
_F_RELEAS=0
ELSE
_F_INIT=2
_F_RELEAS=1
N41 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+100+_TM3*100000)
ENDIF
ENDIF
ELSE
IF(_E_IR<_E_MAX)
_Z1=__Z1
IF(_TMOD MOD 10 ==0)
IF(_Z1A==90)
IF((_BA B_AND 'B11000')<>'B00000')
_Z1=_Z1/2
ENDIF
ENDIF
ENDIF
_E_TS1[_E_IR]=_T _E_TS2[_E_IR]=_TF
_E_TR[_E_IR,0]=SET(5,_DD,_F,_FAA,_S,_SA,_TMOD,_Z1,_Z1A,_DT,_ST,_A0,_D0,_BA)
_E_IR=_E_IR+1
IF(_POS>=0)
_E_POS=_POS
ENDIF
ELSE
GOTOF _FEHL3
ENDIF
IF(_OB==2)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
_E_S_LINE=0
_RETS:
RET
_FEHL1: STOPRE
N908601 SETAL(61242)
RET
_FEHL2:STOPRE
N908602 SETAL(61224)
RET
_FEHL3: STOPRE
N908603 SETAL(61200)
RET
_FEHL4: STOPRE
N908604 SETAL(61867)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_DR_PEC_SPF
PROC F_DR_PEC(INT _OB,INT _BO,INT _IDD,STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,REAL __Z1,INT _Z1A,REAL _D,REAL _DF,REAL _U,REAL _V2,REAL _DT,INT _POS,REAL _V3,REAL _FRF,REAL S_D3D) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Deep Hole Drilling
DEF AXIS _ZZ
DEF INT _PM,_TYP,_TM1,_TM3,_TM6,_TM8,_MAN,_I,_DIR,_MD_CLAMP,_AMODE[9],_GMODE,_DMODE
DEF REAL _FAK1,_FAK2,_SC,_SD,_Z,_ZREF,_RP,_RTP,_DTB,_VARI,_DIS1,_DAM,_FD1,_FDPR,_MDEP,_Z1
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_ZREF=_F_PS_REF*_FAK2
_RP=_F_RP_ACT*_FAK2
IF(_OB==0)
IF(NOT _E_MC)
GOTOF _RET
ENDIF
IF(_IDD>=0)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD]
_DD=_E_TR[_IDD,1] _F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6] _BA=_E_TR[_IDD,7] _Z1=_E_TR[_IDD,8]
_Z1A=_E_TR[_IDD,9] _D=_E_TR[_IDD,10] _DF=_E_TR[_IDD,11] _U =_E_TR[_IDD,12]
_DT=_E_TR[_IDD,13] _V2=_E_TR[_IDD,14] _V3=_E_TR[_IDD,15] _FRF=_E_TR[_IDD,16]
_IDD=-1
ENDIF
_ZZ=$P_AXN3
_TM1=_TMOD MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM6=TRUNC(_TMOD/100000) MOD 10
_TM8=TRUNC(_TMOD/10000000) MOD 10
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
IF($P_MC==0)
_F_INIT=1
ENDIF
ELSE
_SC=_E_SC*_FAK2
ENDIF
_Z=_Z1
IF(_Z1A MOD 2==1)
IF(_TM3==0)
_Z=_ZREF-ABS(_Z)
ELSE
_Z=_ZREF+ABS(_Z)
ENDIF
ENDIF
IF(_Z>_ZREF)
_PM=1
ELSE
_PM=-1
ENDIF
IF((_TM3==0)AND(_PM==1))OR((_TM3==1)AND(_PM==-1)) GOTOF _FEHL3
_FDPR=_D
IF(_Z1A==0) OR (_Z1A==1)
IF($P_TOOLNO)
_TYP=$P_AD[1]
ENDIF
IF(_TYP<200) OR (_TYP>299) GOTOF _FEHL1
IF($P_TOOLNO>0)AND(_TYP<>205)AND(_TYP<>210)AND(_TYP<>231)AND(_TYP<>240)AND(_TYP<>241)AND(_TYP<>242)AND(_TYP<>250)
IF(_Z1A<90)AND($P_AD[24]>0)AND($P_AD[24]<180)
IF(_FDPR==ABS(_ZREF-_Z))
_FDPR=_FDPR+$P_TOOLR*_FAK1/TAN($P_AD[24]/2)
ENDIF
_Z=_Z+$P_TOOLR*_FAK1/TAN($P_AD[24]/2)*_PM
ENDIF
ENDIF
ENDIF
_AMODE[1]=2 _GMODE=0
F_SP_ED(_SD)
IF(_BA B_AND 'B0001')
_VARI=0 _DTB=0
_AMODE[2]=10
IF(_V2==0)
_VARI=2 _DTB=1
_AMODE[2]=20
ENDIF
ELSE
_VARI=1
IF(_BA B_AND 'B0010')
_DIS1=_V3 _AMODE[7]=2000000
ELSE
_DIS1=0 _AMODE[7]=1000000
ENDIF
ENDIF
_AMODE[3]=100
_AMODE[4]=(_BA B_AND 'B1100000')/'B100000'*1000
_AMODE[5]=10000
_DAM=_DF _MDEP=_U
_AMODE[6]=(_BA B_AND 'B1100')/'B100'*100000
IF(_AMODE[6]==0)
_DAM=_DAM*100 _AMODE[6]=200000
ENDIF
IF(_AMODE[6]==200000)
IF(_DAM==100)
_MDEP=_FDPR
ENDIF
ENDIF
_FD1=_FRF
_AMODE[8]=(_BA B_AND 'B1100000')/'B100000'
IF(_AMODE[8]==0)
_FD1=100
ENDIF
_AMODE[8]=10000000
_AMODE[0]=_AMODE[1]+_AMODE[2]+_AMODE[3]+_AMODE[4]+_AMODE[5]+_AMODE[6]+_AMODE[7]+_AMODE[8]
_DMODE=0
IF(_TM8==1)
_DMODE=_DMODE+10000
ENDIF
_E_BO=_BO+(_E_BO B_AND 65535)
_RTP=_ZREF-(_SC+_SD)*_PM
N10 F_TFS(,,,_F,_FAA,,0,2,0)
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N30 CYCLE83(_RTP,_ZREF,_SC,_Z,,,_FDPR,_DAM,_DTB,0,_FD1,_VARI,,_MDEP,_V2,_DT,_DIS1,_GMODE,_DMODE,_AMODE[0])
ELSE
N35 G0 AX[_ZZ]=_ZREF
ENDIF
ELSE
IF(_OB==3)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD] _DD=_E_TR[_IDD,1]
_F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4] _SA=_E_TR[_IDD,5]
_TMOD=_E_TR[_IDD,6]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_MAN==0)
N40 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
_F_RELEAS=0
ELSE
_F_INIT=2
_F_RELEAS=1
N41 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+100+_TM3*100000)
ENDIF
ENDIF
ELSE
IF(_E_IR<_E_MAX)
_Z1=__Z1
IF(_TMOD MOD 10 ==0)
IF(_Z1A==0)OR(_Z1A==90)
IF((_BA B_AND 'B1100000')<>'B0000000')
_Z1=_Z1/2
ENDIF
ENDIF
ENDIF
_E_TS1[_E_IR]=_T _E_TS2[_E_IR]=_TF
_E_TR[_E_IR,0]=SET(4,_DD,_F,_FAA,_S,_SA,_TMOD,_BA,_Z1,_Z1A,_D,_DF,_U,_DT,_V2,_V3,_FRF)
_E_IR=_E_IR+1
IF(_POS>=0)
_E_POS=_POS
ENDIF
ELSE
GOTOF _FEHL2
ENDIF
IF(_OB==2)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
_E_S_LINE=0
_RETS:
RET
_FEHL1: STOPRE
N908301 SETAL(61070)
RET
_FEHL2: STOPRE
N908302 SETAL(61200)
RET
_FEHL3: STOPRE
N908303 SETAL(61242)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_DR_REA_SPF
PROC F_DR_REA(INT _OB,INT _BO,INT _IDD,STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,REAL _FR,INT _FRA,REAL __Z1,INT _Z1A,REAL _DT,INT _POS,INT _BA,REAL S_D3D) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Reaming
DEF AXIS _ZZ
DEF INT _PM,_TM1,_TM3,_TM6,_MAN,_I,_DIR,_MD_CLAMP,_AMODE[3]
DEF REAL _FAK1,_FAK2,_SC,_SD,_Z,_ZREF,_RP,_RTP,_Z1
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_ZREF=_F_PS_REF*_FAK2
_RP=_F_RP_ACT*_FAK2
IF(_OB==0)
IF(NOT _E_MC)
GOTOF _RET
ENDIF
IF(_IDD>=0)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD]
_DD=_E_TR[_IDD,1] _F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6] _FR=_E_TR[_IDD,7] _FRA=_E_TR[_IDD,8]
_Z1=_E_TR[_IDD,9] _Z1A=_E_TR[_IDD,10] _DT=_E_TR[_IDD,11] _BA=_E_TR[_IDD,12]
_IDD=-1
ENDIF
_ZZ=$P_AXN3
_TM1=_TMOD MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM6=TRUNC(_TMOD/100000) MOD 10
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
IF($P_MC==0)
_F_INIT=1
ENDIF
ELSE
_SC=_E_SC*_FAK2
ENDIF
_Z=_Z1
IF(_Z1A MOD 2==1)
IF(_TM3==0)
_Z=_ZREF-ABS(_Z)
ELSE
_Z=_ZREF+ABS(_Z)
ENDIF
ENDIF
IF(_Z>_ZREF)
_PM=1
ELSE
_PM=-1
ENDIF
IF((_TM3==0)AND(_PM==1))OR((_TM3==1)AND(_PM==-1)) GOTOF _FEHL1
_AMODE[1]=2
_AMODE[2]=(_BA B_AND 'B11000')/'B1000'*10
F_SP_ED(_SD)
_E_BO=_BO+(_E_BO B_AND 65535)
_RTP=_ZREF-(_SC+_SD)*_PM
N10 F_TFS(,,,_F,_FAA,,0,2,0)
_AMODE[0]=_AMODE[1]+_AMODE[2]
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N30 CYCLE85(_RTP,_ZREF,_SC,_Z,,_DT,_F,_FR,,0,_AMODE[0])
ELSE
N35 G0 AX[_ZZ]=_ZREF
ENDIF
ELSE
IF(_OB==3)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD] _DD=_E_TR[_IDD,1]
_F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4] _SA=_E_TR[_IDD,5]
_TMOD=_E_TR[_IDD,6]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_MAN==0)
N40 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
_F_RELEAS=0
ELSE
_F_INIT=2
_F_RELEAS=1
N41 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+100+_TM3*100000)
ENDIF
ENDIF
ELSE
IF(_E_IR<_E_MAX)
_Z1=__Z1
IF(_TMOD MOD 10 ==0)
IF(_Z1A==90)
IF((_BA B_AND 'B11000')<>'B00000')
_Z1=_Z1/2
ENDIF
ENDIF
ENDIF
_E_TS1[_E_IR]=_T _E_TS2[_E_IR]=_TF
_E_TR[_E_IR,0]=SET(3,_DD,_F,_FAA,_S,_SA,_TMOD,_FR,_FRA,_Z1,_Z1A,_DT,_BA)
_E_IR=_E_IR+1
IF(_POS>=0)
_E_POS=_POS
ENDIF
ELSE
SETAL(61200)
RET
ENDIF
IF(_OB==2)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
_E_S_LINE=0
_RETS:
RET
_FEHL1: STOPRE
N908501 SETAL(61242)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_DR_SIN_SPF
PROC F_DR_SIN(INT _OB,INT _BO,INT _IDD,STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,REAL __Z1,INT _Z1A,REAL _DT,INT _POS,INT _BA,REAL S_D3D) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Centering
DEF AXIS _ZZ
DEF INT _PM,_TYP,_TM1,_TM3,_TM6,_MAN,_I,_DIR,_MD_CLAMP,_AMODE[3],_GMODE,_Z1AI
DEF REAL _FAK1,_FAK2,_SC,_SD,_Z,_ZREF,_RP,_RTP,_Z1,S_DM
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_ZREF=_F_PS_REF*_FAK2
_RP=_F_RP_ACT*_FAK2
IF(_OB==0)
IF(NOT _E_MC)
GOTOF _RET
ENDIF
IF(_IDD>=0)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD]
_DD=_E_TR[_IDD,1] _F =_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S =_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6] __Z1=_E_TR[_IDD,7] _Z1A=_E_TR[_IDD,8]
_DT=_E_TR[_IDD,9] _BA=_E_TR[_IDD,10]
_IDD=-1
ENDIF
_ZZ=$P_AXN3
_TM1=_TMOD MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM6=TRUNC(_TMOD/100000) MOD 10
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
IF($P_MC==0)
_F_INIT=1
ENDIF
ELSE
_SC=_E_SC*_FAK2
ENDIF
_Z=__Z1
IF(_Z1A==2)
IF($P_TOOLNO)
_TYP=$P_AD[1]
ENDIF
IF(_TYP<200) OR (_TYP>299) GOTOF _FEHL1
IF($P_TOOLNO>0)AND(_TYP<>205)AND(_TYP<>210)AND(_TYP<>231)AND(_TYP<>240)AND(_TYP<>241)AND(_TYP<>242)AND(_TYP<>250)
IF($P_AD[24]>0)AND($P_AD[24]<180)
IF(_TM3==0)
_Z=_ZREF-_Z/2/TAN($P_AD[24]/2)
ELSE
_Z=_ZREF+_Z/2/TAN($P_AD[24]/2)
ENDIF
ELSE
_Z=_ZREF
ENDIF
ELSE
_Z=_ZREF
ENDIF
ENDIF
IF($MCS_FUNCTION_MASK_DRILL B_AND 'B1000')
IF(_SA==2)
REPEAT S_DM_A S_DM_E
REPEAT S_SV_A S_SV_E
N20 F_TFS(,,,,,_S,1)
ENDIF
ENDIF
IF(_Z1A MOD 2==1)
IF(_TM3==0)
_Z=_ZREF-ABS(_Z)
ELSE
_Z=_ZREF+ABS(_Z)
ENDIF
ENDIF
IF(_Z>_ZREF)
_PM=1
ELSE
_PM=-1
ENDIF
IF((_TM3==0)AND(_PM==1))OR((_TM3==1)AND(_PM==-1)) GOTOF _FEHL4
_AMODE[1]=2 _GMODE=0
_AMODE[2]=(_BA B_AND 'B11000')/'B1000'*10
F_SP_ED(_SD)
_E_BO=_BO+(_E_BO B_AND 65535)
_RTP=_ZREF-(_SC+_SD)*_PM
N10 F_TFS(,,,_F,_FAA,,0,2,0)
_AMODE[0]=_AMODE[1]+_AMODE[2]
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N30 CYCLE82(_RTP,_ZREF,_SC,_Z,,_DT,_GMODE,0,_AMODE[0])
ELSE
N35 G0 AX[_ZZ]=_ZREF
ENDIF
ELSE
IF(_OB==3)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD] _DD=_E_TR[_IDD,1]
_F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
S_DM=0
REPEAT S_SV_A S_SV_E
IF(_MAN==0)
N40 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
_F_RELEAS=0
ELSE
_F_INIT=2
_F_RELEAS=1
N41 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+100+_TM3*100000)
ENDIF
ENDIF
ELSE
IF(_E_IR<_E_MAX)
_Z1=__Z1
IF(_TMOD MOD 10 ==0)
IF(_Z1A==90)
IF((_BA B_AND 'B11000')<>'B00000')
_Z1=_Z1/2
ENDIF
ENDIF
ENDIF
_E_TS1[_E_IR]=_T _E_TS2[_E_IR]=_TF
_E_TR[_E_IR,0]=SET(1,_DD,_F,_FAA,_S,_SA,_TMOD,_Z1,_Z1A,_DT,_BA)
_E_IR=_E_IR+1
IF(_POS>=0)
_E_POS=_POS
ENDIF
ELSE
GOTOF _FEHL2
ENDIF
IF(_OB==2)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
_E_S_LINE=0
_RETS:
RET
S_DM_A:
S_DM=0
IF($MCS_FUNCTION_MASK_DRILL B_AND 'B1000')
IF(_Z1A==2)
S_DM=__Z1
ELSE
_Z1=__Z1
_Z1AI=_Z1A
IF(_Z1AI==90)
_Z1=_ZREF-_Z1
_Z1AI=91
ENDIF
IF(_Z1AI==91)
IF($P_TOOLNO)
_TYP=$P_AD[1]
ENDIF
IF(_TYP<200) OR (_TYP>299) GOTOF _FEHL1
IF($P_TOOLNO>0)
IF($P_AD[24]>0)AND($P_AD[24]<180)
S_DM=_Z1*2*TAN($P_AD[24]/2)
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
S_DM_E:
S_SV_A:
IF($MCS_FUNCTION_MASK_DRILL B_AND 'B1000')
IF(_SA==2)
IF(_Z1A==2)
S_DM=__Z1
ENDIF
IF(S_DM)
IF(__Z1==0) GOTOF _FEHL3
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]<>3)
_S=1000*_S/($PI*S_DM/_FAK2)
ELSE
_S=12*_S/($PI*S_DM)
ENDIF
ELSE
IF($P_GG[13]<>4)
_S=12*_S/($PI*S_DM/_FAK2)
ELSE
_S=1000*_S/($PI*S_DM)
ENDIF
ENDIF
IF(_S>999999)
_S=999999
ENDIF
_SA=1
ELSE
_S=0
_SA=1
ENDIF
ENDIF
ENDIF
S_SV_E:
_FEHL1: STOPRE
N908101 SETAL(61070)
RET
_FEHL2: STOPRE
N908102 SETAL(61200)
RET
_FEHL3: STOPRE
N908103 SETAL(61217)
RET
_FEHL4: STOPRE
SETAL(61242)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_DR_TAP_SPF
PROC F_DR_TAP(INT _OB,INT _BO,INT _IDD,STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,REAL __Z1,INT _Z1A,REAL _FI,REAL _FM,INT _FZG,INT _FZZ,INT _FZN,INT _POS,INT _SE,INT _CL,INT _BA,REAL _D,REAL _V2,REAL _SR,STRING[20] _PTAB,STRING[20] _PTABA,INT _TECHNO,REAL _DT,REAL S_D3D) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Tapping
DEF AXIS _ZZ
DEF INT _PM,_M3_4=3,_M3_5,_TM1,_TM3,_TM6,_MAN,_I,_DIR,_MD_CLAMP,_DMODE,_AMODE,_PITA,_VARI,_SDIR,_M_SDR,_M_AGF,S_ENC
DEF REAL _FAK1,_FAK2,_FAK3,_FAK4,_SC,_SD,_Z,_ZREF,_RP,_RTP,_VRT,_Z1,_F1
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK3=1/$MN_SCALING_VALUE_INCH
ELSE
_FAK3=1
ENDIF
_FAK4=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==3)
_FAK4=$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==4)
_FAK4=1/$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_ZREF=_F_PS_REF*_FAK2
_RP=_F_RP_ACT*_FAK2
IF(_OB==0)
IF(NOT _E_MC)
GOTOF _RET
ENDIF
IF(_IDD>=0)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD]
_DD=_E_TR[_IDD,1] _F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6] _Z1=_E_TR[_IDD,7] _Z1A=_E_TR[_IDD,8]
_SE=_E_TR[_IDD,9] _BA=_E_TR[_IDD,10] _D=_E_TR[_IDD,11] _V2=_E_TR[_IDD,12]
_SR=_E_TR[_IDD,13] _TECHNO=_E_TR[_IDD,14] _DT=_E_TR[_IDD,15]
_IDD=-1
IF(_SR==0)
_SR=_S
ENDIF
IF(_SA==2)
D=_DD
IF($P_TOOLR>0)
IF($MN_SCALING_SYSTEM_IS_METRIC)
_S=1000*_S/($PI*2*$P_TOOLR*_FAK4)
_SR=1000*_SR/($PI*2*$P_TOOLR*_FAK4)
ELSE
_S=12*_S/($PI*2*$P_TOOLR*_FAK4)
_SR=12*_SR/($PI*2*$P_TOOLR*_FAK4)
ENDIF
IF(_S>999999)
_S=999999
ENDIF
IF(_SR>999999)
_SR=999999
ENDIF
ELSE
GOTOF _FEHL1
ENDIF
ENDIF
IF(_FAA _DEC2 == 0)
_PITA=1
ELSE
IF(_FAA _DEC1 == 0)
_PITA=1
ELSE
IF(_FAA _DEC1 == 1)
_PITA=3
ELSE
IF(_FAA _DEC1 == 2)
_PITA=4
ELSE
_PITA=2
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
_ZZ=$P_AXN3
_TM1=_TMOD MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM6=TRUNC(_TMOD/100000) MOD 10
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
IF($P_MC==0)
_F_INIT=1
ENDIF
ELSE
_SC=_E_SC*_FAK2
ENDIF
_Z=_Z1
IF(_Z1A MOD 2==1)
IF(_TM3==0)
_Z=_ZREF-ABS(_Z)
ELSE
_Z=_ZREF+ABS(_Z)
ENDIF
ENDIF
IF(_Z>_ZREF)
_PM=1
ELSE
_PM=-1
ENDIF
IF((_TM3==0)AND(_PM==1))OR((_TM3==1)AND(_PM==-1)) GOTOF _FEHL2
F_SP_ED(_SD)
IF(_BA B_AND 'B11000000'=='B10000000')
_M_AGF=1
IF($MCS_FUNCTION_MASK_DRILL B_AND 'B100')AND(_BA B_AND 'B100000000'=='B100000000')
S_ENC=11
ELSE
S_ENC=0
ENDIF
ELSE
_M_AGF=0
S_ENC=0
IF(_BA B_AND 'B11' == 'B01')
_VARI=1
IF(_BA B_AND 'B1100' == 'B1000')
_VRT=_V2
ELSE
IF(_BA B_AND 'B1100' == 'B0100')
_VRT=_F
ELSE
IF(_V2==0)
_VRT=_F
ELSE
_VRT=_V2
ENDIF
ENDIF
ENDIF
ELSE
IF(_BA B_AND 'B11' == 'B10')
_VARI=2
ELSE
_VARI=0
ENDIF
ENDIF
ENDIF
_DMODE=0
IF(_BA B_AND 'B10000'==0)
_DMODE=_DMODE+1000
ENDIF
_AMODE=2
_M3_5=TRUNC($TC_DP25[$P_TOOLNO,1]/256)MOD 4
IF(_M3_5==1)
_AMODE=_AMODE+1000
_M3_4=3
ELSE
IF(_M3_5==2)
_AMODE=_AMODE+2000
_M3_4=4
ELSE
GOTOF _FEHL3
ENDIF
ENDIF
IF(_BA B_AND 'B1100' == 'B0100')
_AMODE=_AMODE+1000000
ELSE
_AMODE=_AMODE+2000000
ENDIF
IF(_SE==0)
_M3_4=5
ENDIF
IF(_M_AGF==1)
_SDIR=TRUNC($TC_DP25[$P_TOOLNO,1]/256)MOD 4
IF(_SDIR==2)
_M_SDR=3
ELSE
_M_SDR=4
ENDIF
_M3_4=5
S=_S M=7-_M_SDR
ENDIF
_E_BO=_BO+(_E_BO B_AND 65535)
_RTP=_ZREF-(_SC+_SD)*_PM
F_TFS(,,,,,,,2,0)
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_M_AGF==0)
N30 CYCLE84(_RTP,_ZREF,_SC,_Z,,0,_M3_4,,_F,0,_S,_SR,3,_PITA,_TECHNO,_VARI,_D,_VRT,,,,,_DMODE,_AMODE)
ELSE
IF(_F1==0)
_F1=$P_F
ELSE
G95 F=_F1
ENDIF
N31 CYCLE840(_RTP,_ZREF,_SC,_Z,,_DT,_M_SDR,_M3_4,S_ENC,,_F,3,_PITA,_TECHNO,,,,,_DMODE,2)
ENDIF
ELSE
N35 G0 AX[_ZZ]=_ZREF
ENDIF
S=_SE
ELSE
IF(_OB==3)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD] _DD=_E_TR[_IDD,1]
_F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4] _SA=_E_TR[_IDD,5]
_TMOD=_E_TR[_IDD,6] _SE=_E_TR[_IDD,9] _BA=_E_TR[_IDD,10] _D=_E_TR[_IDD,11]
_V2=_E_TR[_IDD,12] _SR=_E_TR[_IDD,13] _TECHNO=_E_TR[_IDD,14] _DT=_E_TR[_IDD,15]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_FAA _DEC2 == 0)
_F1=_F*_FAK3
ELSE
IF(_FAA _DEC1 == 0)
_F1=_F*_FAK3
ELSE
IF(_FAA _DEC1 == 1)
_F1=_F*$MN_SCALING_VALUE_INCH*_FAK3
ELSE
IF(_FAA _DEC1 == 2)
_F1=_F*$PI*_FAK3
ELSE
_F1=$MN_SCALING_VALUE_INCH/_F*_FAK3
ENDIF
ENDIF
ENDIF
ENDIF
IF(_MAN==0)
N40 F_TFS(_T,_TF,_DD,_F1,3,_SE,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
_F_RELEAS=0
ELSE
_F_INIT=2
_F_RELEAS=1
N41 F_TFS(_T,,_DD,_F1,3,_SE,_SA,2,8)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+100+_TM3*100000)
ENDIF
ENDIF
ELSE
IF(_E_IR<_E_MAX)
_Z1=__Z1
IF(_TMOD MOD 10 ==0)
IF(_Z1A==90)
IF((_BA B_AND 'B100000')<>'B000000')
_Z1=_Z1/2
ENDIF
ENDIF
ENDIF
_E_TS1[_E_IR]=_T _E_TS2[_E_IR]=_TF
_E_TR[_E_IR,0]=SET(6,_DD,_F,_FAA,_S,_SA,_TMOD,_Z1,_Z1A,_SE,_BA,_D,_V2,_SR,_TECHNO,_DT)
_E_IR=_E_IR+1
IF(_POS>=0)
_E_POS=_POS
ENDIF
ELSE
SETAL(61200)
RET
ENDIF
IF(_OB==2)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
_E_S_LINE=0
_RETS:
RET
_FEHL1: STOPRE
N908401 SETAL(61217)
RET
_FEHL2: STOPRE
N908402 SETAL(61242)
RET
_FEHL3: STOPRE
N908403 SETAL(61293,_T)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_DR_PEC2_SPF
PROC F_DR_PEC2(INT _OB,INT _BO,INT _IDD,STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,REAL __Z1,INT _Z1A,REAL __D,REAL FRF,REAL _DF,REAL _V1,REAL _V2,REAL _V3,REAL _DT,INT _POS,_E_MAC_DR_PEC2) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Deep Hole Drilling 2
DEF AXIS _ZZ
DEF INT _PM,_TM1,_TM3,_TM6,_TM8,_MAN,_I,_DIR,_MD_CLAMP,_GMODE,_DMODE,_M7_8,_MB2,_MB3,_MB5,_MB9,_SDAC,S_SA,S_AMODEI,S_AMODE2I
DEF REAL _FAK1,_FAK2,_SC,_SD,_Z,_ZREF,_RP,_RTP,S_S,_Z1,_D
DEF STRING[10] S_CON,S_COFF
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_DR_PEC2_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"F_DR_PEC2(_OB="<<_OB<<",_BO="<<_BO<<",_IDD="<<_IDD<<",_T="<<_T<<",_TF="<<_TF<<",_DD="<<_DD<<",_F="<<_F<<",_FAA="<<_FAA<<",_S="<<_S<<",_SA="<<_SA<<",_TMOD="<<_TMOD<<",")
WRITE(_LOG,_LOG_FILE,"          _BA="<<_BA<<",_Z1="<<_Z1<<",_Z1A="<<_Z1A<<",_D="<<_D<<",FRF="<<FRF<<",_DF="<<_DF<<",_V1="<<_V1<<",_V2="<<_V2<<",_V3="<<_V3<<",_DT="<<_DT<<",_POS="<<_POS<<",")
WRITE(_LOG,_LOG_FILE,"          DTB="<<DTB<<",DTS="<<DTS<<",VARI="<<VARI<<",S_FP="<<S_FP<<",S_SDAC2="<<S_SDAC2<<",S_SV2="<<S_SV2<<",S_SPOS="<<S_SPOS<<",S_ZA="<<S_ZA<<",S_FA="<<S_FA<<",")
WRITE(_LOG,_LOG_FILE,"          S_ZP="<<S_ZP<<",S_FS="<<S_FS<<",S_ZS1="<<S_ZS1<<",S_ZS2="<<S_ZS2<<",S_N="<<S_N<<",S_ZD="<<S_ZD<<",S_FD="<<S_FD<<",S_FR="<<S_FR<<",S_SDAC3="<<S_SDAC3<<",S_SV3="<<S_SV3<<",")
WRITE(_LOG,_LOG_FILE,"          _AMODE="<<_AMODE<<",S_AMODE2="<<S_AMODE2<<",S_AMODE3="<<S_AMODE3<<",S_ZPV="<<S_ZPV<<")")
WRITE(_LOG,_LOG_FILE,"Aufruf aus "<<SUBSTR($P_PROG[$P_STACK-1],3,STRLEN($P_PROG[$P_STACK-1])-3-4))
ENDIF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_ZREF=_F_PS_REF*_FAK2
_RP=_F_RP_ACT*_FAK2
IF(_OB==0)
IF(NOT _E_MC)
GOTOF _RET
ENDIF
IF(_IDD>=0)
_T =_E_TS1[_IDD] _TF =_E_TS2[_IDD]
_DD =_E_TR[_IDD,1] _F =_E_TR[_IDD,2] _FAA =_E_TR[_IDD,3] _S =_E_TR[_IDD,4]
_SA =_E_TR[_IDD,5] _TMOD =_E_TR[_IDD,6] _BA =_E_TR[_IDD,7] _Z1 =_E_TR[_IDD,8]
_Z1A =_E_TR[_IDD,9] _D =_E_TR[_IDD,10] FRF =_E_TR[_IDD,11] _DF =_E_TR[_IDD,12]
_V1 =_E_TR[_IDD,13] _V2 =_E_TR[_IDD,14] _V3 =_E_TR[_IDD,15] _DT =_E_TR[_IDD,16]
DTB =_E_TR[_IDD,17] DTS =_E_TR[_IDD,18] VARI =_E_TR[_IDD,19] S_FP =_E_TR[_IDD,20]
S_SDAC2 =_E_TR[_IDD,21] S_SV2 =_E_TR[_IDD,22] S_SPOS =_E_TR[_IDD,23] S_ZA =_E_TR[_IDD,24]
S_FA =_E_TR[_IDD,25] S_ZP =_E_TR[_IDD,26] S_FS =_E_TR[_IDD,27] S_ZS1 =_E_TR[_IDD,28]
S_ZS2 =_E_TR[_IDD,29] S_N =_E_TR[_IDD,30] S_ZD =_E_TR[_IDD,31] S_FD =_E_TR[_IDD,32]
S_FR =_E_TR[_IDD,33] S_SDAC3 =_E_TR[_IDD,34] S_SV3 =_E_TR[_IDD,35] _AMODE =_E_TR[_IDD,36]
S_AMODE2=_E_TR[_IDD,37] S_AMODE3=_E_TR[_IDD,38] S_ZPV =_E_TR[_IDD,39]
_IDD=-1
ENDIF
_ZZ=$P_AXN3
_TM1=_TMOD MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM6=TRUNC(_TMOD/100000) MOD 10
_TM8=TRUNC(_TMOD/10000000) MOD 10
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK2
ELSE
_SC=_E_SC*_FAK2
ENDIF
_Z=_Z1
IF(_Z1A MOD 2==1)
IF(_TM3==0)
_Z=_ZREF-ABS(_Z)
ELSE
_Z=_ZREF+ABS(_Z)
ENDIF
ENDIF
IF(_Z>_ZREF)
_PM=1
ELSE
_PM=-1
ENDIF
IF((_TM3==0)AND(_PM==1))OR((_TM3==1)AND(_PM==-1)) GOTOF _FEHL2
F_SP_ED(_SD)
_SDAC=3
IF($P_TOOLNO)
IF((TRUNC($TC_DP25[$P_TOOLNO,1]/256)MOD 4)==2)
_SDAC=4
ENDIF
ENDIF
_GMODE=0
IF(_Z1A<=1)
_GMODE=_GMODE+10
ENDIF
_DMODE=0
IF(_TM8==1)
_DMODE=_DMODE+10000
ENDIF
S_AMODEI=_AMODE
IF(_Z1A MOD 2==0)
S_AMODEI=S_AMODEI+1
ENDIF
S_AMODE2I=S_AMODE2
IF(_FAA==3)
S_AMODE2I=S_AMODE2I+1
ENDIF
IF(_SA==2)
S_AMODE2I=S_AMODE2I+1000000
ENDIF
IF($P_TOOL)
_M7_8=TRUNC($P_AD[25]/1024)MOD 4
IF((_M7_8 B_AND 3)==3)AND($MCS_M_CODE_COOLANT_1_AND_2_ON > -1)
_MB9=$MCS_M_CODE_ALL_COOLANTS_OFF
_MB5=$MCS_M_CODE_COOLANT_1_AND_2_ON
ELSE
IF(_M7_8 B_AND 1)
_MB2=$MCS_M_CODE_COOLANT_1_ON
ENDIF
IF(_M7_8 B_AND 2)
_MB3=$MCS_M_CODE_COOLANT_2_ON
ENDIF
IF(_M7_8==1)OR(_M7_8==2)
_MB9=$MCS_M_CODE_ALL_COOLANTS_OFF
ENDIF
ENDIF
IF(_MB5)
IF($MCS_ENABLE_QUICK_M_CODES B_AND 'B1000')
S_CON="M=QU("<<_MB5<<")"
ELSE
S_CON="M="<<_MB5
ENDIF
ELSE
IF(_MB2)
IF($MCS_ENABLE_QUICK_M_CODES B_AND 'B0010')
S_CON="M=QU("<<_MB2<<")"
ELSE
S_CON="M="<<_MB2
ENDIF
ELSE
IF(_MB3)
IF($MCS_ENABLE_QUICK_M_CODES B_AND 'B0100')
S_CON="M=QU("<<_MB3<<")"
ELSE
S_CON="M="<<_MB3
ENDIF
ENDIF
ENDIF
ENDIF
IF(S_CON<>"")
IF(_MB9)
IF($MCS_ENABLE_QUICK_M_CODES B_AND 'B0001')
S_COFF="M=QU("<<_MB9<<")"
ELSE
S_COFF="M="<<_MB9
ENDIF
ENDIF
ENDIF
ENDIF
_E_BO=_BO+(_E_BO B_AND 65535)
_RTP=_ZREF-(_SC+_SD)*_PM
N10 F_TFS(,,,_F,_FAA,,0,2,0)
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N30 CYCLE830(_RTP,_ZREF,_SC,_Z1,_D,_DF,DTB,DTS,FRF,VARI,_V1,_V2,_DT,_V3,S_FP,S_SDAC2,S_SV2,_F,_SDAC,_S,S_SPOS,S_ZA,S_FA,S_ZP,S_FS,S_ZS1,S_ZS2,S_N,S_ZD,S_FD,S_FR,S_SDAC3,S_SV3,S_CON,S_COFF,_GMODE,_DMODE,S_AMODEI,S_AMODE2I,S_AMODE3,S_ZPV)
ELSE
N35 G0 AX[_ZZ]=_ZREF
ENDIF
ELSE
IF(_OB==3)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD] _DD=_E_TR[_IDD,1]
_F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] VARI=_E_TR[_IDD,19] S_SDAC2 =_E_TR[_IDD,21]
S_SV2=_E_TR[_IDD,22] S_AMODE2=_E_TR[_IDD,37]
IF((VARI _DEC5)<2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"ohne Pilotbohrung")
ENDIF
S_SA=_SA
S_S=_S
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"mit Pilotbohrung")
ENDIF
IF((S_AMODE2 _DEC8)==0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Anfahren mit konstanter Spindeldrehzahl")
ENDIF
S_SA=1+(S_SDAC2*10)
S_S=S_SV2
ELSE
IF((S_AMODE2 _DEC8)==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Anfahren mit konstanter Schnittgeschwindigkeit")
ENDIF
S_SA=2+(S_SDAC2*10)
S_S=S_SV2
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Anfahren mit Spindeldrehzahl in % von der Bohrdrehzahl")
ENDIF
S_SA=1+(S_SDAC2*10)
S_S=_S*S_SV2/100
ENDIF
ENDIF
IF(S_SDAC2==5)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"M5")
ENDIF
S_S=0
ENDIF
ENDIF
_TMOD=_E_TR[_IDD,6]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_MAN==0)
N40 F_TFS(_T,_TF,_DD,_F,_FAA,S_S,S_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
_F_RELEAS=0
ELSE
_F_INIT=2
_F_RELEAS=1
N41 F_TFS(_T,,_DD,_F,_FAA,S_S,S_SA,2,8)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+100+_TM3*100000)
ENDIF
ENDIF
ELSE
IF(_E_IR<_E_MAX)
_Z1=__Z1
_D=__D
IF(_TMOD MOD 10 ==0)
IF(_Z1A==0)OR(_Z1A==90)
_Z1=_Z1/2
ENDIF
IF((_AMODE _DEC5)==1)
_D=_D/2
ENDIF
ENDIF
_E_TS1[_E_IR]=_T _E_TS2[_E_IR]=_TF
_E_TR[_E_IR,0]=SET(9,_DD,_F,_FAA,_S,_SA,_TMOD,_BA,_Z1,_Z1A,_D,FRF,_DF,_V1,_V2,_V3,_DT,DTB,DTS,VARI,S_FP,S_SDAC2,S_SV2,S_SPOS,S_ZA,S_FA,S_ZP,S_FS,S_ZS1,S_ZS2,S_N,S_ZD,S_FD,S_FR,S_SDAC3,S_SV3,_AMODE,S_AMODE2,S_AMODE3,S_ZPV)
_E_IR=_E_IR+1
IF(_POS>=0)
_E_POS=_POS
ENDIF
ELSE
GOTOF _FEHL1
ENDIF
IF(_OB==2)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
_E_S_LINE=0
_RETS:
RET
_FEHL1: STOPRE
N908301 SETAL(61200)
RET
_FEHL2: STOPRE
N908302 SETAL(61242)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_DRILL_SPF
PROC F_DRILL(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,REAL _Z0,INT _Z0A,REAL _Z1,INT _Z1A,REAL _D,REAL _DF,REAL _U,REAL _V2,REAL _DT,REAL _V3,REAL _XD,REAL _FRF,REAL S_D3D) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.008 ;DATE: 2024-05-15
;ShopTurn: Centric Deep Hole Drilling
DEF AXIS _XX,_ZZ,_YY
DEF INT _BA1,_PM,_P29,_TYP,_SL,_OU,_MAN,_TM1=2,_TM3=0,_TM8,_I,_DIR,_AMODE[9],_GMODE,_DMODE,_WTYP,_AXN
DEF REAL _FAK1,_FAK2,_SC,_SD,_RTP,_RP,_RP_SD,_DTB,_VARI,_DIS1,_XS,_YS,_ZS
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF(_Z1A==0) OR (_Z1A==1)
_XD=0
ENDIF
IF(ABS(_XD)>$SCS_DRILL_MID_MAX_ECCENT*_FAK2) GOTOF _FEHL3
_P29=$P_GG[29]
DIAMCYCOF
_MAN=TRUNC(_TMOD/10) MOD 10
_TM8=TRUNC(_TMOD/10000000) MOD 10
IF(_MAN==0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N15 F_TFS(_T,_TF,_DD,,,,,1,0)
IF($P_TOOLNO)
_TYP=$P_ADT[1]
ENDIF
IF($P_S[_F_S_NR[1]]==0)OR($P_SDIR[_F_S_NR[1]]==5)OR((_TYP>=500)AND(_TYP<=599))
F_SP_BC(5,0,0)
ELSE
F_SP_BC(5,0,_SC_A_NO_VAL)
ENDIF
N17 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,7)
ELSE
N20 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,0)
ENDIF
F_SP_TRA(2050)
ELSE
_F_INIT=2
_F_RELEAS=1
IF(_MAN==1)
_F_MASPI=0
N24 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,1,8)
ELSE
_F_MASPI=2
N26 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,3,8)
ENDIF
F_SP_TRA(2050)
ENDIF
IF($P_TOOLNO)
_TYP=$P_ADT[1]
ENDIF
IF(_Z1A==90) OR (_Z1A==91)
IF(_TYP==560)
_SL=$P_ADT[2]
IF(_SL==1)OR(_SL==2)
_OU=1
ENDIF
IF(_SL==3)OR(_SL==4)
_OU=-1
ENDIF
_XD=_XD+$P_ADT[9]*_OU
ENDIF
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_F_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
ELSE
_SC=_E_SC*_FAK2
ENDIF
IF(_Z1A==90)OR(_Z1A==0)
_Z1=_Z0-_Z1
ELSE
_Z1=ABS(_Z1)
ENDIF
_AMODE[1]=1
IF(_Z1<0)GOTOF _FEHL2
_PM=-1
IF(_MAN==0)
IF(_TMOD MOD 10 <2)
_TMOD=_TMOD+2
ENDIF
F_SP_RPT(1,_TMOD)
_RP=_F_RP_ACT*_FAK2
ENDIF
IF(_Z1A==0) OR (_Z1A==1)
IF(_TYP<200) OR (_TYP>299) GOTOF _FEHL1
IF($P_TOOLNO>0)AND(_TYP<>205)AND(_TYP<>210)AND(_TYP<>231)AND(_TYP<>240)AND(_TYP<>241)AND(_TYP<>242)AND(_TYP<>250)
IF(_Z1A<90)AND($P_ADT[24]>0)AND($P_ADT[24]<180)
IF(_D==_Z1)
_D=_D+$P_TOOLR*_FAK1/TAN($P_ADT[24]/2)
ENDIF
_Z1=_Z1+$P_TOOLR*_FAK1/TAN($P_ADT[24]/2)
ENDIF
ENDIF
ENDIF
F_SP_ED(_SD)
_BA1=_BA B_AND 'B0001'
IF(_MAN==0)
_RTP=_F_RP_ACT*_FAK2-_SD*_PM
ELSE
_RTP=_Z0+(_SC+_SD)
ENDIF
IF(_MAN==0)
_RP_SD=_F_RP_ACT*_FAK2-_SD*_PM
ENDIF
IF(_BA B_AND 'B0001')
_VARI=0 _DTB=0
_AMODE[2]=10
IF(_V2==0)
_VARI=2 _DTB=1
_AMODE[2]=20
ENDIF
ELSE
_VARI=1
IF(_BA B_AND 'B0010')
_DIS1=_V3 _AMODE[7]=2000000
ELSE
_DIS1=0 _AMODE[7]=1000000
ENDIF
ENDIF
_AMODE[3]=100
_AMODE[4]=(_BA B_AND 'B1100000')/'B100000'*1000
_AMODE[5]=10000
_AMODE[6]=(_BA B_AND 'B1100')/'B100'*100000
IF(_AMODE[6]==0)
_DF=_DF*100 _AMODE[6]=200000
ENDIF
IF(_AMODE[6]==200000)
IF(_DF==100)
_U=_D
ENDIF
ENDIF
_AMODE[8]=(_BA B_AND 'B1100000')/'B100000'
IF(_AMODE[8]==0)
_FRF=100
ENDIF
_AMODE[8]=10000000
_AMODE[0]=_AMODE[1]+_AMODE[2]+_AMODE[3]+_AMODE[4]+_AMODE[5]+_AMODE[6]+_AMODE[7]+_AMODE[8]
_DMODE=0
IF(_TM8==1)
_DMODE=_DMODE+10000
ENDIF
_AXN=3
IF($P_TOOLNO)AND($P_TOOL)
_WTYP=$P_AD[1]
IF(_WTYP>=500)AND(_WTYP<=599)
G18
_AXN=1
ENDIF
ENDIF
IF(_MAN==0)
N25 F_SP_RP(32,,_Z0)
N30 F_SP_RP(0,_XD,_RP,0)
F_SP_TRA(1050)
ENDIF
IF($P_GG[6]==1)
_ZZ=$P_AXN3
_XX=$P_AXN1
IF(_F_Y_AXIS==1)
_YY=$P_AXN2
ENDIF
ELSE
_ZZ=$P_AXN1
_XX=$P_AXN2
IF(_F_Y_AXIS==1)
_YY=$P_AXN3
ENDIF
ENDIF
IF(_MAN==0)
SBLON
IF(_F_RELEAS==0)
N40 G0 G90 AX[_XX]=_XD AX[_ZZ]=_RP_SD
ELSE
N42 G0 G90 AX[_XX]=_XD
ENDIF
SBLOF
ELSE
_XS=$P_EP[_XX]*_FAK1 _ZS=$P_EP[_ZZ]*_FAK1
IF(_F_Y_AXIS==1)
_YS=$P_EP[_YY]*_FAK1
ENDIF
IF(_ZS<_Z0+(_SC+_SD)) GOTOF _FEHL4
SBLON
IF(_F_Y_AXIS==0)
N46 G90 G0 AX[_XX]=_XD AX[_ZZ]=_RTP
ELSE
N48 G90 G0 AX[_XX]=_XD AX[_ZZ]=_RTP AX[_YY]=0
ENDIF
SBLOF
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
N50 CYCLE83(_RTP,_Z0,_SC,,_Z1,,_D,_DF,_DTB,0,_FRF,_VARI,_AXN,_U,_V2,_DT,_DIS1,_GMODE,_DMODE,_AMODE[0])
ENDIF
IF(_MAN<>0)
SBLON
IF(_F_Y_AXIS==0)
N70 G90 G0 AX[_XX]=_XS AX[_ZZ]=_ZS
ELSE
N80 G90 G0 AX[_XX]=_XS AX[_ZZ]=_ZS AX[_YY]=_YS
ENDIF
SBLOF
ENDIF
F_SP_TRA(2040)
G[29]=_P29
_E_S_LINE=0
_RETS:
_F_RELEAS=0
SBLON
RET
_FEHL1: STOPRE
N908341 SETAL(61070)
RET
_FEHL2: STOPRE
N908342 SETAL(61242)
RET
_FEHL3: STOPRE
N908343 SETAL(61261)
RET
_FEHL4: STOPRE
N908344 SETAL(61284)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_END_SPF
PROC F_END(INT _ST,INT _N,INT _NNR) PREPRO SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.94.00.00.004 ;DATE: 2020-03-23
;ShopTurn: End of program
DEF INT _NPV1
DEF STRING[40] _STR
IF(_E_REPEAT)
_E_REPEAT=0
RET("F_HEAD")
ENDIF
F_SP_TRA(0)
IF($P_STACK==_E_JS_PRG)AND(_ST B_AND 1)
_E_FIRST_PART=0
_E_REPEAT=1
CUST_TECHCYC(135)
IF(_SC_CHAN_ST<>"")
N90 EXECSTRING("WAITM(107,"<<_SC_CHAN_ST<<")")
ENDIF
GOTOS
ENDIF
IF($P_STACK==_E_JS_PRG)
CUST_TECHCYC(136)
IF(_F_NPV[0]>=0)AND(_F_SUB_STA B_AND 'H0001')
WRTPR("IGNORE(7,10)",1)
_NPV1=_F_NPV[0]+1
G[8]=_NPV1
;ELSE
; IF(_F_NPV[1]==$P_UIFRNUM)
; WRTPR("IGNORE(7,10)",1)
; G[8]=1
; ENDIF
ENDIF
_F_MASPI=0
IF(_SC_CHAN_ST<>"")
N100 EXECSTRING("WAITM(103,"<<_SC_CHAN_ST<<")")
ENDIF
IF(NOT _F_AX_EXISTS[4])OR($P_SMODE[_F_S_NR[0]]==1)
M[_F_S_NR[0]]=5
ENDIF
IF(_F_S_NR[1]>0)
M[_F_S_NR[1]]=5
ENDIF
IF(_F_S_NR[2])
IF($AA_COUP_ACT[_F_S_AX[2]])
WAITS(_F_S_NR[2])
ELSE
IF(NOT _F_AX_EXISTS[5])OR($P_SMODE[_F_S_NR[2]]==1)
M[_F_S_NR[2]]=5
ENDIF
ENDIF
ENDIF
_E_JS_PRG=0
_E_ST_PRG=0
ENDIF
_E_PRG_TYPE[$P_STACK-1]=0
SBLON
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_GROOV_SPF
PROC F_GROOV(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,INT _L,REAL __X0,INT _X0A,REAL _Z0,INT _Z0A,REAL _B1,REAL _T1,REAL _A0,REAL _A1,REAL _A2,REAL _RF1,REAL _RF2,REAL _RF3,REAL _RF4,REAL _U,INT _N,REAL _P,INT _NR,REAL _B2,REAL _T2,REAL _D,INT _ARM,REAL __XS,REAL _ZS,REAL _T1_ABS,REAL _T2_ABS,REAL _UX,REAL _UZ,REAL _BETA,INT _BETAA,REAL _GAMA,REAL S_POLA,INT S_FR_M,REAL S_FR_I,STRING[32] S_TRA,REAL S_XC,REAL S_YC,REAL _SV2,REAL _C0,REAL S_FB) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Grooving Cycle
DEF AXIS _XX,_ZZ,_YY,_CC,_AX1,_AX2,_AX3
DEF INT _MAN,_P29,_TYP,_VA,_AMODE[9],_BA1,_RFNR,S_MODE_BC,_AI,_LP,S_IPT,S_PL,_TM1,_DMODE,_TCI,_NPV,S_Y_TURN,S_C805_AMODE
DEF REAL _B12,_BS,_FAK1,_FAK2,_FF2,_PZ=0.8,_SC,_T12,_TA0,_TA1,_TA2,_TD,_XST,_YST,_ZST,_OFM,_X0,_XS,S_ROT_Z,_SD,_RP,_RTP,S_A1TC,S_A2TC
DEF STRING[32] _TC
DEF FRAME _WPFR
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_GROOV_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
ENDIF
IF(_E_SM_PRG)AND((_TMOD _DEC4)==0) GOTOF _FEHL10
IF(_E_ST_PRG)AND((_TMOD _DEC4)==1) GOTOF _FEHL11
_X0=__X0
IF((_BA B_AND 'H4000')=='H4000')
IF(_X0A==90)
_X0=_X0/2
ENDIF
ENDIF
_MAN=TRUNC(_TMOD/10) MOD 10
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_TD=0.0001
_AI=1-((_L DIV 2)MOD 2)*2
_LP=1-((_L DIV 4)MOD 2)
IF((_L MOD 8)==1)OR((_L MOD 8)==4)OR((_L MOD 8)==2)OR((_L MOD 8)==7)
_TA0=TAN(_A0)
ELSE
_TA0=-TAN(_A0)
ENDIF
_TA1=TAN(_A1)
_TA2=TAN(_A2)
IF S_CALL_FROM_MA_JOG_STEP
_F_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
ELSE
_SC=_E_SC*_FAK2
ENDIF
IF(_ARM==0)
_A0=-_A0
ENDIF
IF(_BA B_AND 4)
_B12=2
ELSE
_B12=1
ENDIF
IF(_BA B_AND 8)
_T12=2
ELSE
_T12=1
ENDIF
IF(_TMOD _DEC9)==1
S_IPT=1
ENDIF
IF(_TMOD _DEC9)==3
S_Y_TURN=1
ENDIF
_TM1=_TMOD MOD 10
_C0=((_C0 MOD 360)+360)MOD 360
_P29=$P_GG[29]
DIAMCYCOF
IF(NOT((_FAA==1)OR(_FAA==3))) GOTOF _FEHL3
IF(_MAN==0)
IF(_E_SM_PRG)
IF(S_IPT==1)
IF($PC_TRAFO_TYPE_NAME=="TRAORI_STAT")
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: DFM -> M5")
WRITE(_LOG,_LOG_FILE,"IPT: DFM -> SPOS=0")
ENDIF
M[_F_S_NR[_F_MASPI]]=5
SPOS[_F_S_NR[_F_MASPI]]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N333 E_TFS")
ENDIF
N333 E_TFS(_T,_TF,_DD,,,,,11)
TRAFOOF
G18
IF(_GAMA==180)
_XX=$P_AXN2
$P_CYCFRAME=$P_CYCFRAME:CMIRROR(_XX)
ENDIF
ELSE
N70 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=S_FR_M
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
_ZZ=$P_AXN1
S_ROT_Z=$P_ACTFRAME[_ZZ,RT]
N71 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
IF($P_ACTFRAME[_ZZ,RT]<>S_ROT_Z)
IF($P_EP[_ZZ]*_FAK1<_F_RPT[1]*_FAK2)
N715 G0 G90 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
ENDIF
N72 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
ENDIF
ELSE
IF(S_IPT==1)
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_F_TRAMA _DEC2 ==6)
_TCI=$P_TC
S_A1TC=$P_TCANG[1]
S_A2TC=$P_TCANG[2]
_NPV=$P_GG[8]
_WPFR=$P_WPFRAME
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Stirn B vor N250 F_TFS")
WRITE(_LOG,_LOG_FILE,"  _F_TRAMA="<<_F_TRAMA)
WRITE(_LOG,_LOG_FILE,"  $P_TC="<<$P_TC)
WRITE(_LOG,_LOG_FILE,"  _TC_A1="<<_TC_A1)
WRITE(_LOG,_LOG_FILE,"  _TC_A2="<<_TC_A2)
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[1]="<<$P_TCANG[1])
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[2]="<<$P_TCANG[2])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR13[_TCI]="<<$TC_CARR13[_TCI])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR14[_TCI]="<<$TC_CARR14[_TCI])
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N250 F_TFS")
ENDIF
N250 F_TFS(_T,_TF,_DD,,,,,1,0)
IF(_TCI)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Stirn B nach N250 F_TFS")
WRITE(_LOG,_LOG_FILE,"  _F_TRAMA="<<_F_TRAMA)
WRITE(_LOG,_LOG_FILE,"  $P_TC="<<$P_TC)
WRITE(_LOG,_LOG_FILE,"  _TC_A1="<<_TC_A1)
WRITE(_LOG,_LOG_FILE,"  _TC_A2="<<_TC_A2)
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[1]="<<$P_TCANG[1])
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[2]="<<$P_TCANG[2])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR13[_TCI]="<<$TC_CARR13[_TCI])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR14[_TCI]="<<$TC_CARR14[_TCI])
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N800 CYCLE800 direkt: "<<S_A1TC<<"/"<<S_A2TC)
ENDIF
N800 CYCLE800(0,$TC_CARR34[_TCI],220000,192,0,0,0,S_A1TC,S_A2TC,0,0,0,0,0,0,1001)
$P_WPFRAME=_WPFR
$P_WPFR=$P_WPFRAME
G[8]=_NPV
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: G18 TRAFOOF")
ENDIF
F_SP_TRA(2040)
_XX=$P_AXN2
IF(NOT _TCI)
N255 F_SP_BC(4,_SC_A_NO_VAL,0)
ENDIF
IF(_GAMA==180)
$P_CYCFRAME=$P_CYCFRAME:CMIRROR(_XX)
ENDIF
ELSE
IF S_Y_TURN
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Y-Drehen")
ENDIF
N1800 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
IF(_SC_Y_TURN)
IF(_SC_Y_TURN_GAMA<>_GAMA)
F_SP_RP(1,,,1)
ENDIF
IF(_BA B_AND 'H1000000' == 'H1000000')
IF(_SC_Y_TURN==-90)
F_SP_RP(1,,,1)
ENDIF
ELSE
IF(_SC_Y_TURN==90)
F_SP_RP(1,,,1)
ENDIF
ENDIF
ENDIF
IF(_F_TC_DEF[2]==0)
_TC=""
ELSE
_TC=$TC_CARR34[_F_TC_DEF[2]]
ENDIF
IF(_BA B_AND 'H1000000' == 'H1000000')
S_C805_AMODE=1000
ENDIF
N1805 CYCLE805(1,_TC,_GAMA,,,,S_C805_AMODE)
N1810 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,7)
ELSE
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N16 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
N17 F_SP_BC(4,_BETA,_GAMA)
N18 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,7)
ELSE
N19 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,0)
F_SP_TRA(2040)
ENDIF
ENDIF
ENDIF
ENDIF
ELSE
IF($MCS_TECHNOLOGY==2)
N80 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=0
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
N81 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
N82 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
ELSE
_F_INIT=2
_F_RELEAS=1
IF(_MAN==1)
_F_MASPI=0
N14 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,1,8)
ELSE
_F_MASPI=2
N15 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,3,8)
ENDIF
F_SP_TRA(2040)
ENDIF
ENDIF
IF($P_TOOLNO==0) GOTOF _FEHL0
IF($P_TOOL==0) GOTOF _FEHL5
_TYP=$P_AD[1]
IF(S_Y_TURN)
IF(_TYP<>525)AND(_TYP<>535) GOTOF _FEHL2
ELSE
IF(_TYP<>520)AND(_TYP<>521)AND(_TYP<>530)AND(_TYP<>531) GOTOF _FEHL2
ENDIF
_BS=$P_AD[9]
_BS=_BS*_FAK1
IF(_BS<=0) GOTOF _FEHL1
_XX=$P_AXN2 _ZZ=$P_AXN1
IF(_T12==2)
IF((ABS(_A0)>_TD)AND(ABS(_A0-180)>_TD)AND(ABS(_A0+180)>_TD))
IF(_B12==1)
_T1=-(_B1+_T2*(_TA2+1/_TA0))/(_TA1-1/_TA0)
ELSE
_T1=_T2+_B2*_TA0
ENDIF
ELSE
_T1=_T2
ENDIF
ELSE
IF((ABS(_A0)>_TD)AND(ABS(_A0-180)>_TD)AND(ABS(_A0+180)>_TD))
IF(_B12==1)
_T2=-(_B1+_T1*(_TA1-1/_TA0))/(_TA2+1/_TA0)
ELSE
_T2=_T1-_B2*_TA0
ENDIF
ELSE
_T2=_T1
ENDIF
ENDIF
IF(_B12==2)
_B1=_B2-_T1*_TA1-_T2*_TA2
ENDIF
IF(_B12==1)
_B2=_B1+_T1*_TA1+_T2*_TA2
ENDIF
IF((_BA MOD 4)==3)
_FF2=_F*$SCS_TURN_FIN_FEED_PERCENT/100
ELSE
_FF2=_F
ENDIF
IF(_L>7)
_VA=1000
_L=_L-8
ELSE
_VA=0
ENDIF
IF(_BA B_AND 'H20')
_VA=_VA+10000
ENDIF
IF(_MAN==0)AND(S_IPT==0)
F_SP_RPT(0,_L MOD 8)
ENDIF
IF(_F_Y_AXIS==1)
_YY=$P_AXN3
ENDIF
IF(_MAN)
_XST=$P_EP[_XX]*_FAK1 _ZST=$P_EP[_ZZ]*_FAK1
IF(_F_Y_AXIS==1)
_YST=$P_EP[_YY]*_FAK1
ENDIF
ENDIF
CASE _L OF 0 GOTOF _FALL1 1 GOTOF _FALL2 2 GOTOF _FALL3 3 GOTOF _FALL4 4 GOTOF _FALL5 5 GOTOF _FALL6 6 GOTOF _FALL7 7 GOTOF _FALL8 DEFAULT GOTOF _FEHL_VARI
_FALL1: _VA=100+_VA
GOTOF _FALL0
_FALL2: _VA=500+_VA
GOTOF _FALL0
_FALL3: _VA=300+_VA
GOTOF _FALL0
_FALL4: _VA=700+_VA
GOTOF _FALL0
_FALL5: _VA=800+_VA
GOTOF _FALL0
_FALL6: _VA=600+_VA
GOTOF _FALL0
_FALL7: _VA=400+_VA
GOTOF _FALL0
_FALL8: _VA=200+_VA
_FALL0:
_BA1=_BA MOD 4
CASE _BA1 OF 1 GOTOF _SCHRUPP 2 GOTOF _SCHLICHT 3 GOTOF _KOMPLETT DEFAULT GOTOF _FEHL_VARI
_SCHRUPP: _VA=_VA+10
GOTOF _BAEND
_SCHLICHT: _VA=_VA+20
GOTOF _BAEND
_KOMPLETT: _VA=_VA+30
_BAEND:
_DMODE=0
IF((_BA B_AND 'H400000')=='H400000')
_DMODE=10
ENDIF
IF((_BA B_AND 'H08')=='H00')
_AMODE[1]=0
ELSE
_AMODE[1]=1
ENDIF
IF((_BA B_AND 'H10')=='H00')
_AMODE[2]=10
ELSE
_AMODE[2]=0
ENDIF
_AMODE[2]=10
IF((_BA B_AND 'H04')=='H00')
_AMODE[3]=100
ELSE
_AMODE[3]=0
ENDIF
_RFNR=1
_AMODE[4]=0
IF((_BA B_AND 'HC0')=='H000')
IF(_RF1<0)
_RF1=ABS(_RF1) _AMODE[4]=1000
ENDIF
ELSE
IF((_BA B_AND 'HC0')=='H80')
IF(_RF1<0) GOTOF _FEHL8
_AMODE[4]=1000
ELSE
IF(_RF1<0) GOTOF _FEHL9
ENDIF
ENDIF
_RFNR=2
_AMODE[5]=0
IF((_BA B_AND 'H300')=='H000')
IF(_RF2<0)
_RF2=ABS(_RF2) _AMODE[5]=10000
ENDIF
ELSE
IF((_BA B_AND 'H300')=='H200')
IF(_RF2<0) GOTOF _FEHL8
_AMODE[5]=10000
ELSE
IF(_RF2<0) GOTOF _FEHL9
ENDIF
ENDIF
_RFNR=3
_AMODE[6]=0
IF((_BA B_AND 'HC00')=='H000')
IF(_RF3<0)
_RF3=ABS(_RF3) _AMODE[6]=100000
ENDIF
ELSE
IF((_BA B_AND 'HC00')=='H800')
IF(_RF3<0) GOTOF _FEHL8
_AMODE[6]=100000
ELSE
IF(_RF3<0) GOTOF _FEHL9
ENDIF
ENDIF
_RFNR=4
_AMODE[7]=0
IF((_BA B_AND 'H3000')=='H000')
IF(_RF4<0)
_RF4=ABS(_RF4) _AMODE[7]=1000000
ENDIF
ELSE
IF((_BA B_AND 'H3000')=='H2000')
IF(_RF4<0) GOTOF _FEHL8
_AMODE[7]=1000000
ELSE
IF(_RF4<0) GOTOF _FEHL9
ENDIF
ENDIF
IF((_BA B_AND 'H800000')=='H800000')
_AMODE[8]=10000000
ELSE
_AMODE[8]=0
ENDIF
_AMODE[0]=_AMODE[1]+_AMODE[2]+_AMODE[3]+_AMODE[4]+_AMODE[5]+_AMODE[6]+_AMODE[7]+_AMODE[8]
IF(S_IPT==1)
IF($P_CUTMOD)
CUTMOD=0
ENDIF
IF($P_CUTMODK<>"")
CUTMODK="CLEAR"
ENDIF
ENDIF
N140 CYCLE930(_X0*2,_Z0,_B1,_B2,_T1,_T2,_A0,_A1,_A2,_RF1,_RF2,_RF3,_RF4,_U,_D,_SC,_VA,0,_N,_P,_F,_NR,_UX,_UZ,_DMODE,_AMODE[0],200,S_FB)
_ZS=_SC_POS[0]*_FAK1
_XS=_SC_POS[1]*_FAK1
IF(S_IPT==1)
IF(_GAMA==180)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Gamma 180 -> Spiegelung X entfernt")
ENDIF
$P_CYCFRAME=$P_CYCFRAME:CMIRROR(_XX)
ENDIF
IF(_E_SM_PRG)
ELSE
IF(_GAMA==180)
_XS=_XS-2*$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]
ENDIF
ENDIF
IF(_LP==1)
IF(_AI==1)
IF(_A0>0)
_XS=_XS+(_T1*_TA1+_B1/2)*_TA0
ENDIF
ELSE
IF(_A0<0)
_XS=_XS-(_T1*_TA1+_B1/2)*_TA0
ENDIF
ENDIF
ELSE
IF(_AI==1)
ELSE
GOTOF _FEHL12
ENDIF
ENDIF
IF(_E_SM_PRG)
E_SP_ED(_SD)
_RP=_E_RP*_FAK2
_RTP=_RP-_SD
G17
N31 E_SP_RP(2,_RTP,S_XC,S_YC,_RTP)
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: F_SP_BC")
ENDIF
F_SP_BC(_TM1)
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2
_RTP=_RP
IF(_TM1==1)
F_SP_TRA(2012,,_C0)
F_SP_RP(0,_RP,_YS,0,_XS)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N32 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
F_SP_RP(9,S_XC+_XS,_RP,0,S_YC)
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N33 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2 _AX3=$P_AXN3
IF(_F_RELEAS==0)
SBLON
N34 G90 G0 G40 AX[_AX1]=S_XC+_XS AX[_AX2]=S_YC AX[_AX3]=_RP
N340 G90 G0 G40 AX[_AX3]=_ZS
SBLOF
ENDIF
ENDIF
ENDIF
IF($MCS_TECHNOLOGY==2)
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H0000')
DIAM90
ELSE
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H8000')
DIAMON
ELSE
DIAMOF
ENDIF
ENDIF
IF(S_IPT==0)
_P29=$P_GG[29]
ENDIF
DIAMCYCOF
ENDIF
IF(S_IPT==1)
IF(_E_SM_PRG)
S_PL=_E_PLANE
ELSE
IF(_TM1==1)
S_PL=3
ELSE
S_PL=1
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N806 Anwahl Interpolationsdrehen")
ENDIF
IF(_E_SM_PRG)
N806 CYCLE806(0001,S_XC,S_YC,_GAMA,_S,_SV2,5,_SA-1+100,S_PL,S_TRA,2*_XS,_RP)
SBLON
G4 F0
SBLOF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N334 E_TFS")
ENDIF
N334 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
SBLON
G4 F0
SBLOF
ELSE
N806 CYCLE806(0001,S_XC,S_YC,_GAMA,_S,_SV2,5,_SA-1,S_PL,S_TRA)
SBLON
G4 F0
SBLOF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N251 F_TFS")
ENDIF
N251 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,,0)
SBLON
G4 F0
SBLOF
ENDIF
DIAMCYCOF
SBLON
N810 G0 G90 AX[_ZZ]=_ZS
SBLOF
ELSE
IF S_Y_TURN
SBLON
IF($P_EP[_ZZ]*_FAK1<_F_RPT[1]*_FAK2)AND($P_EP[_YY]<>0)
N1840 G0 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
IF($P_EP[_ZZ]*_FAK1>_F_RPT[1]*_FAK2)
N1850 G0 AX[_XX]=_F_RPT[0]*_FAK2 AX[_ZZ]=_F_RPT[1]*_FAK2
ELSE
N1860 G0 AX[_XX]=_F_RPT[0]*_FAK2
ENDIF
N1870 G0 AX[_YY]=0
N1880 G0 AX[_ZZ]=_ZS
N1890 G0 G90 AX[_XX]=_XS AX[_ZZ]=_ZS
SBLOF
ELSE
IF(_MAN==0)
IF(_AI==-1)
F_SP_RP(3,_XS,_ZS)
ENDIF
N20 F_SP_RP(0,_XS,_ZS,0)
IF(_F_RELEAS==0)
IF((_L MOD 8)<4)
SBLON
N24 G0 G90 AX[_XX]=_F_RP_ACT*_FAK2 AX[_ZZ]=_ZS
SBLOF
ELSE
SBLON
N26 G0 G90 AX[_XX]=_XS AX[_ZZ]=_F_RP_ACT*_FAK2
SBLOF
ENDIF
ENDIF
F_SP_TRA(1040)
ELSE
_OFM=0.5*_BS*ABS(_TA0)
IF((_L MOD 8)<4)
IF(_XST*_AI<_X0*_AI) GOTOF _FEHL7
SBLON
IF(_F_Y_AXIS==0)
N30 G0 G90 AX[_XX]=_XS+(_SC+_OFM)*_AI AX[_ZZ]=_ZS
ELSE
N52 G0 G90 AX[_XX]=_XS+(_SC+_OFM)*_AI AX[_ZZ]=_ZS AX[_YY]=0
ENDIF
SBLOF
ELSE
IF(_ZST*_AI<_Z0*_AI) GOTOF _FEHL7
SBLON
IF(_F_Y_AXIS==0)
N54 G0 G90 AX[_XX]=_XS AX[_ZZ]=_ZS+(_SC+_OFM)*_AI
ELSE
N36 G0 G90 AX[_XX]=_XS AX[_ZZ]=_ZS+(_SC+_OFM)*_AI AX[_YY]=0
ENDIF
SBLOF
ENDIF
ENDIF
ENDIF
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
N40 CYCLE930(_X0*2,_Z0,_B1,_B2,_T1,_T2,_A0,_A1,_A2,_RF1,_RF2,_RF3,_RF4,_U,_D,_SC,_VA,0,_N,_P,_F,_NR,_UX,_UZ,_DMODE,_AMODE[0],0,S_FB)
ELSE
IF(_LP==1)
N41 G90 G0 AX[_XX]=_F_RP_ACT*_FAK2 AX[_ZZ]=_Z0
ELSE
N42 G90 G0 AX[_XX]=_X0 AX[_ZZ]=_F_RP_ACT*_FAK2
ENDIF
ENDIF
IF(_MAN==0)
IF(_E_ST_PRG)
IF(_AI==-1)
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
F_SP_RP(4,$P_EP[_XX]*_FAK1,$P_EP[_ZZ]*_FAK1)
ENDIF
ENDIF
IF(S_IPT==1)
SBLON
N124 G0 G90 AX[_XX]=_XS
CYCLE806(0)
N125 G0 G90 AX[_ZZ]=_RTP
SBLOF
S_M_OK=0
ENDIF
ELSE
IF(S_IPT==1)
SBLON
N110 G0 G90 AX[_XX]=_XS
SBLOF
CYCLE806(0)
S_M_OK=0
G[29]=_P29
_ZZ=$P_AXN3
N130 G0 G90 AX[_ZZ]=_RTP
ELSE
SBLON
IF(_LP==1)
N150 G0 G90 AX[_XX]=_F_RP_ACT*_FAK2
IF(_AI==-1)
N155 G0 G90 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
ELSE
N160 G0 G90 AX[_ZZ]=_F_RP_ACT*_FAK2
IF(_AI==-1)
N165 G0 G90 AX[_XX]=_F_RPT[0]*_FAK2
ENDIF
ENDIF
SBLOF
F_SP_RP(101,,,1)
ENDIF
ENDIF
ELSE
SBLON
IF(_F_Y_AXIS==0)
N50 G90 G0 AX[_XX]=_XST AX[_ZZ]=_ZST
ELSE
N60 G90 G0 AX[_XX]=_XST AX[_ZZ]=_ZST AX[_YY]=_YST
ENDIF
SBLOF
ENDIF
G[29]=_P29
_E_S_LINE=0
_RETS:
_F_RELEAS=0
SBLON
RET
_FEHL0: STOPRE
N993000 SETAL(61009)
RET
_FEHL1: STOPRE
N993001 SETAL(61602)
RET
_FEHL2: STOPRE
N993002 SETAL(61212)
RET
_FEHL3: STOPRE
N993003 SETAL(61240)
RET
_FEHL5: STOPRE
N993005 SETAL(61000)
RET
_FEHL_6: STOPRE
N993006 SETAL(61908)
RET
_FEHL_VARI: STOPRE
SETAL(61002)
RET
_FEHL7: STOPRE
N993007 SETAL(61284)
RET
_FEHL8: STOPRE
N993008 SETAL(61022,"(FS"<<_RFNR<<")  ")
RET
_FEHL9: STOPRE
N993009 SETAL(61022,"(R"<<_RFNR<<")  ")
RET
_FEHL10: STOPRE
N993010 SETAL(61862)
RET
_FEHL11: STOPRE
N993011 SETAL(61863)
RET
_FEHL12: STOPRE
N993012 SETAL(61242)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_HEAD_SPF
PROC F_HEAD(INT __ST,REAL __XA1,REAL _ZA1,REAL __XI1,REAL _ZI1,REAL _XRA1,REAL _ZRA1,REAL _XRI1,REAL _ZRI1,REAL __XT1,REAL _ZT1,REAL _SC,REAL _S1,REAL _S2,INT __MU,INT _DIR,INT _ST2,INT _BLNR,REAL _ZB1,REAL _XRR1,INT _VER,INT __BL1,INT _N1,REAL _L1,REAL _B1,REAL _H1,INT _NPV1,REAL _ZV1,STRING[24] _JOB,INT _ST3,INT _ST4,INT _NPV2,REAL _ZV2,INT _BL2,REAL _XA2,REAL _ZA2,REAL _XI2,REAL _ZI2,REAL _ZB2,_E_MAC_F_HEAD) PREPRO SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.007 ;DATE: 2024-04-23
;ShopTurn: Program head
DEF AXIS _ZZ,_Z2
DEF INT _I,_ST,_MU,_N,_BL1,_BLA,_RAA,_WWPE,_WWPA,_XRAA,_XRAE,_ZRAA,_ZRAE,_XRIA,_XRIE,_ZRIA,_ZRIE,_VARI1,_VARI2,_VARI0,_XRRA,_XRRE,_SP,_NPV_1,_WM,S_Z2_GO,S_TS
DEF INT _BLT[2,7]=SET(0,2,0,0,4,3,1, -1,0,6,1,5,4,0)
DEF REAL _FAK1,_FAK2,_XA,_ZA,_XI,_L,_B,_H,_XA1,_XI1,_XT1,_XRA,_ZRA,_XRI,_ZRI,_XT,_ZT,_XRR,_Z_INK,S_Z2_POS
DEF STRING[30] _SERR
DEF STRING[40] _STR
DEF INT _LOG,_LOG_ON
DEF STRING[35] _LOG_FILE
_E_PRG_TYPE[$P_STACK-1]=2
IF(_E_JS_PRG==0)
_E_JS_PRG=$P_STACK
_E_ST_PRG=1
ENDIF
_E_MAN=0
IF(NOT(__ST B_AND 'H10000000'))
_SERR=<<$P_PROG_NAME[$P_STACK-1]
IF($P_STACK==_E_JS_PRG)
GOTOF _FEHL1
ELSE
GOTOF _FEHL2
ENDIF
ENDIF
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_HEAD_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
IF(NOT(__ST B_AND 'H08000000'))AND($P_STACK==_E_JS_PRG)
DELETE(_LOG,_LOG_FILE)
ENDIF
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"F_HEAD(...)")
WRITE(_LOG,_LOG_FILE,"  _E_S_LINE="<<_E_S_LINE)
ENDIF
IF(NOT(__ST B_AND 'H08000000'))AND($P_STACK==_E_JS_PRG)
CYCLE218(1)
ENDIF
_ST=__ST _MU=__MU
_XA1=__XA1 _XI1=__XI1 _XT1=__XT1
_BL1=__BL1
IF(NOT(_ST2 B_AND 'H800'))
IF((_ST B_AND 'H00010001')=='H00010001')
_XA1=_XA1*2
ENDIF
IF((_ST B_AND 'H00040004')=='H00040004')
_XI1=_XI1*2
ENDIF
IF((_ST B_AND 'H00100010')=='H00100010')
_XRA1=_XRA1*2
ENDIF
IF((_ST B_AND 'H00400040')=='H00400040')
_XRI1=_XRI1*2
ENDIF
_WWPE=(_ST B_AND 'H8300'=='H8300')
_WWPA=(_ST B_AND 'H04000000'=='H04000000')
IF(_WWPE)AND(_WWPA==0)
_XT1=_XT1*2
ENDIF
_XRR1=_XRR1*2
ENDIF
IF(_ST2 B_AND 'H00010000')AND(_NPV1==0)
_ST2=_ST2 B_AND (B_NOT 'H00002000')
ENDIF
IF(NOT(_ST B_AND 'H08000000'))AND($P_STACK==_E_JS_PRG)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N10 CYCLE210(0)")
ENDIF
N10 CYCLE210(0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_BC(9)")
ENDIF
F_SP_BC(9)
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N20 CUST_TECHCYC(4)")
ENDIF
N20 CUST_TECHCYC(4)
IF(_F_S_NR[2])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N30 CUST_TECHCYC(24)")
ENDIF
N30 CUST_TECHCYC(24)
ENDIF
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_F_S_NR[1])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N40 CUST_TECHCYC(14)")
ENDIF
N40 CUST_TECHCYC(14)
ENDIF
F_SP_INI(2)
_E_IR=0
_E_BO=0
_E_POS=0
_SC_WO=0
_E_POS_RP=1
_F_SUB_TRZ=0
_F_SUB_GRP=0
_F_SUB_ANG=0
_F_SUB_FAN=0
_F_SUB_CUT=0
_F_SUB_STA=0
_F_TAILSTOCK[0]=0
_F_TAILSTOCK[1]=0
_F_RTL[0]=_SC_NO_VAL
_F_RTL[1]=_SC_NO_VAL
_F_NCK_CHAN_INFO[$P_CHANNO-1]=0
IF(_ST2 B_AND 'H4000')
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N50 CYCLE208("<<_JOB<<")")
ENDIF
N50 CYCLE208(_JOB)
IF((_ST2 B_AND 'H1000')==0)
_SP=0
ELSE
IF((_ST2 B_AND 'H0400')==0)
_SP=0
ELSE
_SP=2
ENDIF
ENDIF
_BL1=_BLT[1,_E_RT[_SP/2,0]+1]
_BL2=_BLT[1,_E_RT[1-_SP/2,0]+1]
IF(NOT(_ST2 B_AND 'H400'))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SUB_SP(5,,,,,,,,,"<<_F_NPV[0]<<")")
ENDIF
F_SUB_SP(5,,,,,,,,,_F_NPV[0])
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SUB_SP(6,,,,,,,,,"<<_F_NPV[1]<<")")
ENDIF
F_SUB_SP(6,,,,,,,,,_F_NPV[1])
ENDIF
ELSE
IF(NOT(_ST B_AND 'H2000'))
_MU=-1
ENDIF
IF(NOT(_ST2 B_AND 'H200'))
IF(NOT(_ST2 B_AND 'H1000'))
_NPV1=$P_GG[8]-1
ELSE
_NPV1=-1
ENDIF
ENDIF
IF(NOT(_ST2 B_AND 'H1000'))
_MODE2=_MODE2-(_MODE2 _DEC1)+(_MODE1 _DEC1)
ENDIF
IF(_BL1==0)
_BL1=((_ST B_AND 'H01000000')DIV'H01000000')+((_ST B_AND 'H20000000')DIV'H10000000')
IF(_BL1==0)
_BL1=6
ENDIF
ENDIF
_VARI1=0
_VARI2=0
_VARI0=0
IF(NOT(_ST2 B_AND 'H1000'))
_VARI1=1
IF(_F_AX_EXISTS[2])
_VARI2=3
ENDIF
ELSE
IF(NOT(_ST2 B_AND 'H400'))
_VARI1=1
ELSE
_VARI1=2
ENDIF
IF((_ST4 B_AND 'H1000'))
IF(NOT(_ST4 B_AND 'H400'))
_VARI2=1
ELSE
_VARI2=2
ENDIF
ENDIF
ENDIF
IF(_ST2 B_AND 'H2000')
_VARI1=_VARI1+10
ENDIF
IF(_ST4 B_AND 'H2000')
_VARI2=_VARI2+10
ENDIF
IF(_ST2 B_AND 'H100')
_VARI1=_VARI1+100
ENDIF
IF(_ST4 B_AND 'H100')
_VARI2=_VARI2+100
ENDIF
IF(_ST B_AND 'H40000')
_VARI1=_VARI1+1000
ENDIF
IF(_ST3 B_AND 'H40000')
_VARI2=_VARI2+1000
ENDIF
IF(_ST B_AND 'H80000')
_VARI1=_VARI1+10000
ENDIF
IF(_ST3 B_AND 'H80000')
_VARI2=_VARI2+10000
ENDIF
IF(_ST2 B_AND 'H10')
_VARI1=_VARI1+100000
ENDIF
IF(_ST4 B_AND 'H10')
_VARI2=_VARI2+100000
ENDIF
IF(_ST2 B_AND 'H8000')
_VARI0=_VARI0+1
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N60 CYCLE209(...)")
ENDIF
N60 CYCLE209(_MU,_VARI1,_NPV1,_ZV1,_BLT[0,_BL1],_XA1,_XI1,_ZA1,_ZI1,_ZB1,_N1,_L1,_B1,_H1,_S1,_VARI2,_NPV2,_ZV2,_BLT[0,_BL2],_XA2,_XI2,_ZA2,_ZI2,_ZB2,_N2,_L2,_B2,_H2,_S2,_VARI0,_ZW,_MODE1,S_ZC1,S_ZS1,S_ZE1,S_XR1,S_ZR1,_MODE2,S_ZC2,S_ZS2,S_ZE2,S_XR2,S_ZR2)
IF(_VARI1 _DEC1==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SUB_SP(5,,,,,,,,,"<<_F_NPV[0]<<")")
ENDIF
F_SUB_SP(5,,,,,,,,,_F_NPV[0])
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SUB_SP(6,,,,,,,,,"<<_F_NPV[1]<<")")
ENDIF
F_SUB_SP(6,,,,,,,,,_F_NPV[1])
ENDIF
ENDIF
ENDIF
IF(_ST B_AND 'H08000000')
IF(_ST2 B_AND 'H400')
_BL1=_BLT[1,_E_RT[1,0]+1]
ELSE
_BL1=_BLT[1,_E_RT[0,0]+1]
ENDIF
ENDIF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF(_ST B_AND 'H00000002')
_F_RTL[0]=_ZA1/_FAK2
ENDIF
IF(_ST B_AND 'H00000008')
_F_RTL[1]=_ZI1/_FAK2
ENDIF
_BLA=_BL1
IF((_ST2 B_AND 'H1000')==0)
_SP=0
ELSE
IF((_ST2 B_AND 'H0400')==0)
_SP=0
ELSE
_SP=2
ENDIF
ENDIF
_RAA=((_ST B_AND 'H02000000')DIV'H02000000')+((_ST B_AND 'H40000000')DIV'H20000000')
_XRA=_XRA1
_XRAA=_ST B_AND 'H00100000'
_XRAE=_ST B_AND 'H00000010'
_ZRA=_ZRA1
_ZRAA=_ST B_AND 'H00200000'
_ZRAE=_ST B_AND 'H00000020'
_XRI=_XRI1
_XRIA=_ST B_AND 'H00400000'
_XRIE=_ST B_AND 'H00000040'
_ZRI=_ZRI1
_ZRIA=_ST B_AND 'H00800000'
_ZRIE=_ST B_AND 'H00000080'
REPEAT _M_RP_A _M_RP_E
IF(_ST2 B_AND 'H0080')
IF(_ST2 B_AND 'H0020')
_XRRA=1
ELSE
_XRRA=2
ENDIF
ELSE
_XRRA=0
ENDIF
_XRR=_XRR1
_XRRE=_ST2 B_AND 'H0040'
REPEAT _M_RS_A _M_RS_E
_WWPE=(_ST B_AND 'H8300'=='H8300')
_WWPA=(_ST B_AND 'H04000000'=='H04000000')
_XT=_XT1
_ZT=_ZT1
REPEAT _M_WWP_A _M_WWP_E
IF((_ST2 B_AND 'H1000')==0)
_SP=2
REPEAT _M_RP_A _M_RP_E
REPEAT _M_WWP_A _M_WWP_E
ELSE
IF((_ST4 B_AND 'H00001000'))
_BLA=_BL2
IF((_ST4 B_AND 'H00000400')==0)
_SP=0
ELSE
_SP=2
ENDIF
_RAA=((_ST3 B_AND 'H02000000')DIV'H02000000')+((_ST3 B_AND 'H40000000')DIV'H20000000')
_XRA=_XRA2
_XRAA=_ST3 B_AND 'H00100000'
_XRAE=1
_ZRA=_ZRA2
_ZRAA=_ST3 B_AND 'H00200000'
_ZRAE=1
_XRI=_XRI2
_XRIA=_ST3 B_AND 'H00400000'
_XRIE=1
_ZRI=_ZRI2
_ZRIA=1
_ZRIE=1
REPEAT _M_RP_A _M_RP_E
IF(_ST4 B_AND 'H0020')
_XRRA=1
ELSE
_XRRA=2
ENDIF
_XRR=_XRR2
_XRRE=1
REPEAT _M_RS_A _M_RS_E
_WWPE=1
_WWPA=(_ST3 B_AND 'H04000000'=='H04000000')
_XT=_XT2
_ZT=_ZT2
REPEAT _M_WWP_A _M_WWP_E
ENDIF
ENDIF
IF(NOT(_ST B_AND 'H08000000'))AND($P_STACK==_E_JS_PRG)
_F_RPT[0]=_F_RPTM[_F_MASPI/2,0]
_F_RPT[1]=_F_RPTM[_F_MASPI/2,1]
_F_RPT[2]=_F_RPTM[_F_MASPI/2,2]
_F_RPT[3]=_F_RPTM[_F_MASPI/2,3]
_F_RPT[4]=_F_RPTM[_F_MASPI/2,4]
_F_RPT[5]=_SC_NO_VAL
_F_RPT[6]=_F_RPTM[_F_MASPI/2,6]
_F_RPT[7]=_F_RPTM[_F_MASPI/2,7]
_F_RPT[8]=_F_RPTM[_F_MASPI/2,8]
IF(_LOG_ON)
IF(_F_MASPI==0)
WRITE(_LOG,_LOG_FILE,"Aktive Rckzugsebenen fr: Hauptspindel: (X im Radius)")
ELSE
WRITE(_LOG,_LOG_FILE,"Aktive Rckzugsebenen fr: Gegenspindel: (X im Radius)")
ENDIF
WRITE(_LOG,_LOG_FILE,"  XRA="<<_F_RPT[0])
WRITE(_LOG,_LOG_FILE,"  ZRA="<<_F_RPT[1])
WRITE(_LOG,_LOG_FILE,"  XRI="<<_F_RPT[2])
WRITE(_LOG,_LOG_FILE,"  ZRI="<<_F_RPT[3])
WRITE(_LOG,_LOG_FILE,"  XRRA="<<_F_RPT[4])
WRITE(_LOG,_LOG_FILE,"  Z,max Stirn B="<<_F_RPT[5])
WRITE(_LOG,_LOG_FILE,"  XRA,ink="<<_F_RPT[6])
WRITE(_LOG,_LOG_FILE,"  ZRA,ink="<<_F_RPT[7])
WRITE(_LOG,_LOG_FILE,"  XRI,ink="<<_F_RPT[8])
ENDIF
ENDIF
_F_TCP[0]=_F_TCP_M[_F_MASPI/2,0]
_F_TCP[1]=_F_TCP_M[_F_MASPI/2,1]
_F_TCP[2]=_F_TCP_M[_F_MASPI/2,2]
IF(_LOG_ON)
IF(_F_MASPI==0)
WRITE(_LOG,_LOG_FILE,"Aktiver Werkzeugwechselpunkt fr: Hauptspindel: (X im Radius)")
ELSE
WRITE(_LOG,_LOG_FILE,"Aktiver Werkzeugwechselpunkt fr: Gegenspindel: (X im Radius)")
ENDIF
IF(_F_TCP[2]==0)
WRITE(_LOG,_LOG_FILE,"  Werkzeugwechselpunkt im WKS:")
ELSE
WRITE(_LOG,_LOG_FILE,"  Werkzeugwechselpunkt im MKS:")
ENDIF
WRITE(_LOG,_LOG_FILE,"    XT="<<_F_TCP[0])
WRITE(_LOG,_LOG_FILE,"    ZT="<<_F_TCP[1])
ENDIF
IF(_ST B_AND 'H08000000')
IF(_ST B_AND 'H0800')
IF(_ST2 B_AND 'H1400'=='H1400')
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"G26 S["<<_F_S_NR[2]<<"]="<<_S1)
WRITE(_LOG,_LOG_FILE,"LIMS["<<_F_S_NR[2]<<"]="<<_S1)
ENDIF
G26 S[_F_S_NR[2]]=_S1
LIMS[_F_S_NR[2]]=_S1
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"G26 S["<<_F_S_NR[0]<<"]="<<_S1)
WRITE(_LOG,_LOG_FILE,"LIMS["<<_F_S_NR[0]<<"]="<<_S1)
ENDIF
G26 S[_F_S_NR[0]]=_S1
LIMS[_F_S_NR[0]]=_S1
ENDIF
ENDIF
IF(_ST B_AND 'H1000')AND(_F_S_NR[2])
IF(_F_S_NR[2]<>_F_S_NR[0])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"G26 S["<<_F_S_NR[2]<<"]="<<_S2)
WRITE(_LOG,_LOG_FILE,"LIMS["<<_F_S_NR[2]<<"]="<<_S2)
ENDIF
G26 S[_F_S_NR[2]]=_S2
LIMS[_F_S_NR[2]]=_S2
ENDIF
ENDIF
ENDIF
IF(_ST B_AND 'H0400')
_E_SC=_SC*1/_FAK2
ENDIF
IF(_ST B_AND 'H4000')
_E_DIR=_DIR
ENDIF
IF(NOT(_ST B_AND 'H08000000'))AND($P_STACK==_E_JS_PRG)
IF(_E_FIRST_PART)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N70 CUST_TECHCYC(131)")
ENDIF
N70 CUST_TECHCYC(131)
ENDIF
IF($P_SEARCHL)
IF($P_SEARCHL==2)OR($P_SEARCHL==4)
IF($MCS_FUNCTION_MASK_TECH B_AND 'B1000' == 0)
_SERR="MD 52212 (Bit 3=1)"
GOTOF _FEHL5
ENDIF
ELSE
IF($P_SEARCHL==5)
IF($MCS_FUNCTION_MASK_TECH B_AND 'B100000' == 0)
_SERR="MD 52212 (Bit 5=1)"
GOTOF _FEHL5
ENDIF
ELSE
GOTOF _FEHL6
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUT2DF")
WRITE(_LOG,_LOG_FILE,"SETMS("<<_F_S_NR[0]<<")")
ENDIF
CUT2DF
SETMS(_F_S_NR[0])
G0
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND($P_TC)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N80 CUST_800(11,"<<$P_TC<<")")
ENDIF
N80 CUST_800(11,$P_TC)
ENDIF
G4F0
MMC("CMM_INTERN,BLOCKOFFSET,0,0","N")
G4F0
WRTPR("BLOCK_OFFSET(0)",1)
IF(NOT $P_SEARCH)AND(NOT $P_ISTEST)
_F_RP_DIR[0]=_F_RP_DIR_S
_F_RP_DIR_T=_F_RP_DIR_T_S
ENDIF
IF($MN_SIM_ENVIRONMENT B_AND 'B100')
_F_RP_DIR[0]=99
ELSE
IF($P_TOOLNO>0)
IF($TC_TP2[$P_TOOLNO]<>_F_RP_DIR_T)
_F_RP_DIR[0]=0
ENDIF
ELSE
_F_RP_DIR[0]=0
ENDIF
ENDIF
S_TS=0
IF(_SC_CHAN_ST<>"")
IF((MATCH(_SC_CHAN_ST<<",",<<$P_CHANNO<<",")<>-1)AND($MCS_FUNCTION_MASK_TURN B_AND 'H04'))
IF((_F_TAILSTOCK[0]==1)OR(_F_TAILSTOCK[1]==1))
_F_NCK_TAILSTOCK[$P_CHANNO-1]=1
ELSE
_F_NCK_TAILSTOCK[$P_CHANNO-1]=0
ENDIF
ENDIF
_WM=107
REPEAT _SYNC_A _SYNC_E
_I=1
WHILE((_I<=10)AND(S_TS==0))
IF(_F_NCK_TAILSTOCK[_I-1]==1)
S_TS=1
ENDIF
_I=_I+1
ENDWHILE
IF((S_TS==1)AND(_F_NCK_TAILSTOCK[$P_CHANNO-1]<>-1))
FOR _I=1 TO 10
IF((MATCH(_SC_CHAN_ST<<",",<<_I<<",")<>-1)AND(_F_NCK_TAILSTOCK[_I-1]<>-1))
IF(S_TS<>_F_NCK_TAILSTOCK[_I-1])
GOTOF _FEHL4
ENDIF
ENDIF
ENDFOR
ENDIF
_WM=108
REPEAT _SYNC_A _SYNC_E
ELSE
IF(($MCS_FUNCTION_MASK_TURN B_AND 'H04')AND((_F_TAILSTOCK[0]==1)OR(_F_TAILSTOCK[1]==1)))
S_TS=1
ENDIF
ENDIF
IF(_F_AX_EXISTS[3])AND(_F_S_NR[2])
IF((_F_ZW<>_SC_NO_VAL)OR($SCS_SUB_SPINDLE_REL_POS<>0)OR($MAS_AXIS_MCS_POSITION[2,_F_S_AX[6]]<>0))AND(S_TS==0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Gegenspindel freifahren:")
ENDIF
_Z2=_F_S_AX[3]
IF(_F_ZW<>_SC_NO_VAL)
S_Z2_POS=_F_ZW*_FAK2-$P_ACTFRAME[_Z2,TR]*_FAK1
ELSE
S_Z2_POS=$SCS_SUB_SPINDLE_REL_POS*_FAK1-$P_ACTFRAME[_Z2,TR]*_FAK1
ENDIF
IF(_SC_CHAN_ST=="")
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  einkanalig -> direkt fahren")
WRITE(_LOG,_LOG_FILE,"  N100 G0 Z2="<<S_Z2_POS)
ENDIF
SBLON
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N100 G0 POS[_Z2]=AC(S_Z2_POS)
ELSE
N105 G0 AX[_Z2]=AC(S_Z2_POS)
ENDIF
SBLOF
ELSE
_F_NCK_CHAN_INFO[0]=REP(0)
_WM=108
REPEAT _SYNC_A _SYNC_E
_F_NCK_CHAN_INFO[$P_CHANNO-1]='B1'
IF($P_ISTEST)AND(NOT $AC_SERUPRO)
_F_NCK_CHAN_INFO[$P_CHANNO-1]=_F_NCK_CHAN_INFO[$P_CHANNO-1]+'B10'
ENDIF
IF($AA_TYP[_Z2]==1)
_F_NCK_CHAN_INFO[$P_CHANNO-1]=_F_NCK_CHAN_INFO[$P_CHANNO-1]+'B100'
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  _F_NCK_CHAN_INFO["<<$P_CHANNO-1<<"]="<<_F_NCK_CHAN_INFO[$P_CHANNO-1])
ENDIF
_WM=107
REPEAT _SYNC_A _SYNC_E
IF((_F_NCK_CHAN_INFO[$P_CHANNO-1] B_AND 'B111')=='B101')
S_Z2_GO=1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Z2 im Kanal und kein Testlauf")
ENDIF
ELSE
S_Z2_GO=1
_I=0
WHILE((_I<10)AND(S_Z2_GO))
IF((_F_NCK_CHAN_INFO[_I] B_AND 'B111')=='B101')
S_Z2_GO=0
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Kanal "<<_I+1<<" soll Z2 fahren")
ENDIF
ENDIF
_I=_I+1
ENDWHILE
IF(S_Z2_GO==1)
S_Z2_GO=0
_I=0
WHILE((_I<10)AND(S_Z2_GO==0))
IF((_F_NCK_CHAN_INFO[_I] B_AND 'B011')=='B001')
IF($P_CHANNO-1==_I)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Z2 in den Kanal holen und fahren (GETD)")
ENDIF
S_Z2_GO=1
GETD(_Z2)
_I=10
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Kanal "<<_I+1<<" soll Z2 fahren")
ENDIF
_I=10
ENDIF
ENDIF
_I=_I+1
ENDWHILE
ENDIF
ENDIF
IF(S_Z2_GO)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  N110 G0 Z2="<<S_Z2_POS)
ENDIF
SBLON
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N110 G0 POS[_Z2]=AC(S_Z2_POS)
ELSE
N115 G0 AX[_Z2]=AC(S_Z2_POS)
ENDIF
SBLOF
ENDIF
_WM=108
REPEAT _SYNC_A _SYNC_E
IF($AA_TYP[_Z2]<>1)
IF($AA_IW[_Z2]<>S_Z2_POS)
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N120 G0 POS[_Z2]=AC(S_Z2_POS)
ELSE
N125 G0 AX[_Z2]=AC(S_Z2_POS)
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
IF NOT(((_ST2 B_AND 'H1400')=='H1000')AND((_ST4 B_AND 'H1400')=='H1400'))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N150 CYCLE211(0)")
ENDIF
N150 CYCLE211(0)
ENDIF
IF(_ST2 B_AND 'H5000')
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N160 CYCLE211(1)")
ENDIF
N160 CYCLE211(1)
ENDIF
IF (((_ST2 B_AND 'H1400')=='H1000')AND((_ST4 B_AND 'H1400')=='H1400'))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N170 CYCLE211(0)")
ENDIF
N170 CYCLE211(0)
ENDIF
ENDIF
IF($MN_SIM_ENVIRONMENT B_AND 'B100')
IF(NOT(_ST B_AND 'H08000000'))AND($P_STACK==_E_JS_PRG)
IF(_F_AX_EXISTS[3])AND($MCS_FUNCTION_MASK_TURN B_AND 'H04')
_Z2=_F_S_AX[3]
IF($AA_TYP[_Z2]==1)
IF($P_GG[6]==1)
_ZZ=$P_AXN3
ELSE
IF($P_GG[6]==2)
_ZZ=$P_AXN1
ELSE
_ZZ=$P_AXN2
ENDIF
ENDIF
IF(_F_AX_EXISTS[2])AND(_F_AX_EXISTS[3])
IF(_F_TAILSTOCK[0])
SBLON
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N200 G0 POS[_Z2]=AC(_E_RT[0,3]*_FAK2+$P_ACTFRAME[_ZZ,TR]*_FAK1+$MAS_TAILSTOCK_PARAMETER[1,_F_S_AX[5]]*_FAK1-$P_ACTFRAME[_Z2,TR]*_FAK1)
ELSE
N205 G0 AX[_Z2]=AC(_E_RT[0,3]*_FAK2+$P_ACTFRAME[_ZZ,TR]*_FAK1+$MAS_TAILSTOCK_PARAMETER[1,_F_S_AX[5]]*_FAK1-$P_ACTFRAME[_Z2,TR]*_FAK1)
ENDIF
SBLOF
ENDIF
IF(_F_TAILSTOCK[1])
_Z_INK=($P_ACTFRAME[_ZZ,TR]-$MAS_TAILSTOCK_PARAMETER[1,_F_S_AX[6]])*_FAK1
SBLON
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N300 G0 POS[_Z2]=IC(-_Z_INK)
ELSE
N305 G0 AX[_Z2]=IC(-_Z_INK)
ENDIF
SBLOF
IF(_F_NPV[1]>0)
$P_UIFR[_F_NPV[1],_ZZ,TR]=$P_UIFR[_F_NPV[1],_ZZ,TR]-_Z_INK/_FAK1
IF($P_GG[8]==_F_NPV[1]+1)
_NPV_1=_F_NPV[1]+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"G[8]="<<_NPV_1)
ENDIF
N310 G[8]=_NPV_1
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
IF(_SC_CHAN_ST<>"")
_WM=108
REPEAT _SYNC_A _SYNC_E
ENDIF
ENDIF
ENDIF
IF($MCS_FUNCTION_MASK_TURN B_AND 'H04')
FIXTURE("","","","TAILSTOCK",_F_TAILSTOCK[0])
FIXTURE("","","","TAILSTOCK",_F_TAILSTOCK[1]+'H1000')
ENDIF
IF(NOT(_ST B_AND 'H08000000'))AND($P_STACK==_E_JS_PRG)
IF(_E_FIRST_PART)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N400 CUST_TECHCYC(132)")
ENDIF
N400 CUST_TECHCYC(132)
ENDIF
ENDIF
SBLON
RET
_M_RP_A:
IF(_ST2 B_AND 4)
_XA=_E_RT[_SP/2,1]*_FAK2
_ZA=_E_RT[_SP/2,3]*_FAK2
_XI=_E_RT[_SP/2,4]*_FAK2
_N=_E_RT[_SP/2,8]
_L=_E_RT[_SP/2,9]*_FAK2
_B=_E_RT[_SP/2,10]*_FAK2
_H=_E_RT[_SP/2,11]*_FAK2
IF(_BLA>0)
IF(_BLA<>1)
IF(_RAA==0)
_XRIE=0
_ZRIE=0
_ST=_ST B_AND (B_NOT 'H00000080')
ELSE
IF(_RAA==3)
_ST=_ST B_AND (B_NOT 'H00000080')
ENDIF
ENDIF
ELSE
IF(_RAA==0)
_ST=_ST B_AND (B_NOT 'H00000080')
ENDIF
ENDIF
ENDIF
IF(_XRAE)
_F_RPTM[_SP/2,6]=_SC_NO_VAL
IF(_XRAA)
_F_RPTM[_SP/2,0]=_XRA/2/_FAK2
ELSE
IF(_BLA==-1) GOTOF _FEHL3
IF(_BLA==4)
_F_RPTM[_SP/2,0]=(SQRT(POT(_B)+POT(_H))/2+_XRA)/_FAK2
ELSE
IF(_BLA==5)
_F_RPTM[_SP/2,0]=(_L/(2*SIN(180/_N))+_XRA)/_FAK2
ELSE
_F_RPTM[_SP/2,0]=(_XA+_XRA)/_FAK2
_F_RPTM[_SP/2,6]=_XRA/_FAK2
ENDIF
ENDIF
ENDIF
ELSE
IF(_F_RPTM[_SP/2,6]<>_SC_NO_VAL)
IF(_BLA==-1)
_F_RPTM[_SP/2,0]=_SC_NO_VAL
ELSE
IF(_BLA==4)
_F_RPTM[_SP/2,0]=(SQRT(POT(_B)+POT(_H))/2)/_FAK2+_F_RPTM[_SP/2,6]
ELSE
IF(_BLA==5)
_F_RPTM[_SP/2,0]=(_L/(2*SIN(180/_N)))/_FAK2+_F_RPTM[_SP/2,6]
ELSE
_F_RPTM[_SP/2,0]=_XA/_FAK2+_F_RPTM[_SP/2,6]
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
IF(_ZRAE)
IF(_ZRAA)
_F_RPTM[_SP/2,1]=_ZRA/_FAK2
_F_RPTM[_SP/2,7]=_SC_NO_VAL
ELSE
IF(_BLA==-1) GOTOF _FEHL3
_F_RPTM[_SP/2,1]=(_ZA+_ZRA)/_FAK2
_F_RPTM[_SP/2,7]=_ZRA/_FAK2
ENDIF
ELSE
IF(_F_RPTM[_SP/2,7]<>_SC_NO_VAL)
IF(_BLA==-1)
_F_RPTM[_SP/2,1]=_SC_NO_VAL
ELSE
_F_RPTM[_SP/2,1]=_ZA/_FAK2+_F_RPTM[_SP/2,7]
ENDIF
ENDIF
ENDIF
IF(_XRIE)
_F_RPTM[_SP/2,8]=_SC_NO_VAL
IF(_XRIA)
_F_RPTM[_SP/2,2]=_XRI/2/_FAK2
ELSE
IF(_BLA==1)
_F_RPTM[_SP/2,2]=(_XI-_XRI)/_FAK2
_F_RPTM[_SP/2,8]=_XRI/_FAK2
ELSE
GOTOF _FEHL3
ENDIF
ENDIF
ELSE
IF(_F_RPTM[_SP/2,8]<>_SC_NO_VAL)
IF(_BLA==1)
_F_RPTM[_SP/2,2]=_XI/_FAK2-_F_RPTM[_SP/2,8]
ELSE
_F_RPTM[_SP/2,2]=_SC_NO_VAL
ENDIF
ENDIF
ENDIF
IF(_ZRIE)
IF(_ZRIA)
_F_RPTM[_SP/2,3]=_ZRI/_FAK2
ELSE
GOTOF _FEHL3
ENDIF
ENDIF
IF(_XRAE OR _ZRAE OR _XRIE OR _ZRIE)
IF(_BLA<>1)
IF(_RAA==0)
_F_RPTM[_SP/2,2]=_SC_NO_VAL
_F_RPTM[_SP/2,3]=_SC_NO_VAL
ELSE
IF(_RAA==3)
_F_RPTM[_SP/2,3]=_SC_NO_VAL
ENDIF
ENDIF
ELSE
IF(_RAA==0)
_F_RPTM[_SP/2,3]=_SC_NO_VAL
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
IF(_SP==0)
WRITE(_LOG,_LOG_FILE,"Hauptspindel: (X im Radius)")
ELSE
WRITE(_LOG,_LOG_FILE,"Gegenspindel: (X im Radius)")
ENDIF
WRITE(_LOG,_LOG_FILE,"  XRA="<<_F_RPTM[_SP/2,0])
WRITE(_LOG,_LOG_FILE,"  ZRA="<<_F_RPTM[_SP/2,1])
WRITE(_LOG,_LOG_FILE,"  XRI="<<_F_RPTM[_SP/2,2])
WRITE(_LOG,_LOG_FILE,"  ZRI="<<_F_RPTM[_SP/2,3])
WRITE(_LOG,_LOG_FILE,"  Z,max Stirn B="<<_F_RPTM[_SP/2,5])
WRITE(_LOG,_LOG_FILE,"  XRA,ink="<<_F_RPTM[_SP/2,6])
WRITE(_LOG,_LOG_FILE,"  ZRA,ink="<<_F_RPTM[_SP/2,7])
WRITE(_LOG,_LOG_FILE,"  XRI,ink="<<_F_RPTM[_SP/2,8])
ENDIF
ENDIF
_M_RP_E:
_M_RS_A:
IF(_XRRA)
IF(_XRRA==1)AND($MCS_FUNCTION_MASK_TURN B_AND 'H04')
_F_TAILSTOCK[_SP/2]=1
IF(_XRRE)
_F_RPTM[_SP/2,4]=_XRR/_FAK2/2
ENDIF
ELSE
_F_TAILSTOCK[_SP/2]=0
_F_RPTM[_SP/2,4]=_SC_NO_VAL
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Reitstock:")
WRITE(_LOG,_LOG_FILE,"    XRRA="<<_F_RPTM[_SP/2,4])
ENDIF
ENDIF
ENDIF
_M_RS_E:
_M_WWP_A:
IF(_WWPE)
IF(_WWPA)
_F_TCP_M[_SP/2,0]=_XT/_FAK2
ELSE
_F_TCP_M[_SP/2,0]=_XT/_FAK2/2
ENDIF
_F_TCP_M[_SP/2,1]=_ZT/_FAK2
_F_TCP_M[_SP/2,2]=_WWPA
ENDIF
IF(_LOG_ON)
IF(_WWPA==0)
WRITE(_LOG,_LOG_FILE,"  Werkzeugwechselpunkt im WKS:")
ELSE
WRITE(_LOG,_LOG_FILE,"  Werkzeugwechselpunkt im MKS:")
ENDIF
WRITE(_LOG,_LOG_FILE,"    XT="<<_F_TCP_M[_SP/2,0])
WRITE(_LOG,_LOG_FILE,"    ZT="<<_F_TCP_M[_SP/2,1])
ENDIF
_M_WWP_E:
_SYNC_A:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"WAITM("<<_WM<<","<<_SC_CHAN_ST<<")")
ENDIF
N970 EXECSTRING("WAITM("<<_WM<<","<<_SC_CHAN_ST<<")")
N975 STOPRE
_SYNC_E:
_FEHL1: STOPRE
N932801 SETAL(61235,_SERR)
RET
_FEHL2: STOPRE
N932802 SETAL(61236,_SERR)
RET
_FEHL3: STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Alarm 61297 Bezug fr inkrementale Rckzugsebene fehlt")
ENDIF
N932803 SETAL(61297)
RET
_FEHL4: STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Alarm 61864 Auswahl Reitstock ja/nein muss in allen Kanlen gleich sein")
ENDIF
N932804 SETAL(61864)
RET
_FEHL5: STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Alarm 61166 Maschinendatum prfen: "<<_SERR)
ENDIF
N932805 SETAL(61166,_SERR)
RET
_FEHL6: STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Alarm 61869 Satzsuchlauf nur mit Berechnung mglich")
ENDIF
N932805 SETAL(61869)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_HOME_SPF
PROC F_HOME(INT _MODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Approach Tool Change Position
DEF AXIS _XX,_YY,_ZZ,S_XX,S_YY,S_ZZ
DEF INT _P29
DEF REAL _FAK1
DEF STRING[40] S_STRAL
DEF FRAME _WPFRAME,_FRAME,_VECT
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_HOME_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
; DELETE(_LOG,_LOG_FILE)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"Aufruf aus "<<SUBSTR($P_PROG[$P_STACK-1],3,STRLEN($P_PROG[$P_STACK-1])-3-4))
WRITE(_LOG,_LOG_FILE,"F_HOME("<<_MODE<<")")
ENDIF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
GOTOF _RET
ENDIF
IF(_MODE<0)OR(_MODE>3)
S_STRAL="_MODE"
GOTOF _FEHL3
ENDIF
IF(_MODE==0)
IF(_E_ST_PRG==0) GOTOF _FEHL1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Rckzug Drehen")
ENDIF
IF(_F_RPT[0]<>_F_RPTM[_F_MASPI/2,0])OR(_F_RPT[1]<>_F_RPTM[_F_MASPI/2,1])OR(_F_RPT[2]<>_F_RPTM[_F_MASPI/2,2])OR(_F_RPT[3]<>_F_RPTM[_F_MASPI/2,3])OR(_F_RPT[4]<>_F_RPTM[_F_MASPI/2,4])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"-> zuerst auf _F_RP_ACT")
ENDIF
N9 F_SP_RP(103,,,1)
_F_RPT[0]=_F_RPTM[_F_MASPI/2,0]
_F_RPT[1]=_F_RPTM[_F_MASPI/2,1]
_F_RPT[2]=_F_RPTM[_F_MASPI/2,2]
_F_RPT[3]=_F_RPTM[_F_MASPI/2,3]
_F_RPT[4]=_F_RPTM[_F_MASPI/2,4]
ENDIF
N10 F_SP_RP(1,,,1)
ENDIF
IF(_MODE==1)OR(_MODE==2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Rckzug Drehen auf Frsmaschinen")
ENDIF
IF(_E_SM_PRG==0) GOTOF _FEHL2
IF($P_GG[6]==1)
_ZZ=$P_AXN3
_XX=$P_AXN1
_YY=$P_AXN2
ELSE
IF($P_GG[6]==2)
_ZZ=$P_AXN1
_XX=$P_AXN2
_YY=$P_AXN3
ELSE
_ZZ=$P_AXN2
_XX=$P_AXN3
_YY=$P_AXN1
ENDIF
ENDIF
IF(_E_PLANE==1)
S_ZZ=$P_AXN3
S_XX=$P_AXN1
S_YY=$P_AXN2
ELSE
IF(_E_PLANE==2)
S_ZZ=$P_AXN1
S_XX=$P_AXN2
S_YY=$P_AXN3
ELSE
S_ZZ=$P_AXN2
S_XX=$P_AXN3
S_YY=$P_AXN1
ENDIF
ENDIF
IF(_E_TURN_TRAFO<>"")AND(_E_TURN_TRAFO==$PC_TRAFO_NAME)
N100 F_SP_RP(100,,,1)
IF(_LOG_ON)
IF(ABS(_F_RP_DIR[0])==2)
WRITE(_LOG,_LOG_FILE,"  -> Rckzugsebene Drehen (RP=X"<<_F_RP_ACT<<"): X"<<$P_EP[_XX]<<" Y"<<$P_EP[_YY]<<" Z"<<$P_EP[_ZZ])
ELSE
WRITE(_LOG,_LOG_FILE,"  -> Rckzugsebene Drehen (RP=Z"<<_F_RP_ACT<<"): X"<<$P_EP[_XX]<<" Y"<<$P_EP[_YY]<<" Z"<<$P_EP[_ZZ])
ENDIF
ENDIF
ENDIF
ENDIF
IF(_MODE==2)
_P29=$P_GG[29]
DIAMCYCOF
_VECT=CTRANS()
_VECT[S_XX,TR]=$P_EP[S_XX]*_FAK1
_VECT[S_YY,TR]=$P_EP[S_YY]*_FAK1
_VECT[S_ZZ,TR]=$P_EP[S_ZZ]*_FAK1
_FRAME=$P_WPFRAME:$P_TRAFRAME_P
_FRAME[S_XX,TR]=0
_FRAME[S_YY,TR]=0
_FRAME[S_ZZ,TR]=0
_VECT=INVFRAME(_FRAME):_VECT
IF(_VECT[S_ZZ,TR]<_E_RP)
_VECT[S_ZZ,TR]=_E_RP
_VECT=_FRAME:_VECT
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  -> Rckzugsebene Frsen (RP="<<_E_RP<<"): X"<<_VECT[_XX,TR]<<" Y"<<_VECT[_YY,TR]<<" Z"<<_VECT[_ZZ,TR])
ENDIF
N110 SBLON
N120 G0 G90 G40 AX[_XX]=_VECT[_XX,TR] AX[_YY]=_VECT[_YY,TR] AX[_ZZ]=_VECT[_ZZ,TR]
N130 SBLOF
ENDIF
G[29]=_P29
ENDIF
IF(_MODE==3)
IF(_E_ST_PRG==0) GOTOF _FEHL1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Rckzug Drehen auf XRA")
ENDIF
N300 F_SP_RP(102,,,1)
ENDIF
_RET:
SBLON
RET
_FEHL1:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Alarm 61865 Aufruf eines ShopTurn-Zyklus nur in einem ShopTurn-Programm zulssig")
ENDIF
N932901 SETAL(61865)
RET
_FEHL2:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Alarm 61866 Aufruf eines ShopMill-Zyklus nur in einem ShopMill-Programm zulssig")
ENDIF
N932902 SETAL(61866)
RET
_FEHL3: STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Alarm 61019 Parameter "<<S_STRAL<<" falsch definiert")
ENDIF
N932903 SETAL(61019,S_STRAL)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MANAGE_SPF
PROC F_MANAGE PREPRO SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Management
DEF INT _I,_IT,_IP,_TEC,_POS,_BOT,_BOP,_S_TEC,_S_POS,_OB,_CUR_POS,_CUR_TEC
DEF REAL _FAK1,_FAK2,_RP,_SC
DEF STRING[128] _STR
DEF INT _LOG,_LOG_ON
DEF STRING[35] _LOG_FILE
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_MANAGE_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
DELETE(_LOG,_LOG_FILE)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"F_MANAGE")
ENDIF
;$P_CYCFRAME=CTRANS()
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_E_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RP=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RP=_F_RP_ACT*_FAK2
ENDIF
_TEC=0
_POS=0
FOR _I=0 TO _E_IR-1
IF(_E_TR[_I,0]>0)AND(_POS==0)
_TEC=_TEC+1
ENDIF
IF(_E_TR[_I,0]<0)
_POS=_POS+1
ENDIF
ENDFOR
IF((_TEC+_POS)<>_E_IR) GOTOF _FEHL1
IF(_TEC<=0) GOTOF _FEHL2
IF(_POS<=0) GOTOF _FEHL3
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_TEC="<<_TEC)
WRITE(_LOG,_LOG_FILE,"_POS="<<_POS)
ENDIF
IF($AC_SERUPRO)
IF(_E_SEARCH[3]==$P_LINENO[0])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"SERUPRO")
WRITE(_LOG,_LOG_FILE,"  _E_SEARCH:"<<_E_SEARCH[0]<<","<<_E_SEARCH[1]<<","<<_E_SEARCH[2]<<","<<_E_SEARCH[3])
ENDIF
_S_TEC=_E_SEARCH[0]
_S_POS=_E_SEARCH[1]
_E_NSP=MAXVAL(0,_E_SEARCH[2])
_E_SEARCH[0]=0
_E_SEARCH[1]=0
_E_SEARCH[2]=0
ELSE
_S_TEC=0
_S_POS=0
_E_NSP=0
ENDIF
ELSE
IF($P_SEARCH)
_S_TEC=0
_S_POS=0
_E_NSP=0
ELSE
IF(_E_SEARCH[0]>=_TEC)OR(_E_SEARCH[1]>=_POS) GOTOF _FEHL4
_S_TEC=_E_SEARCH[0]
_S_POS=_E_SEARCH[1]
_E_NSP=MAXVAL(0,_E_SEARCH[2])
_E_SEARCH[0]=0
_E_SEARCH[1]=0
_E_SEARCH[2]=0
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_S_TEC="<<_S_TEC)
WRITE(_LOG,_LOG_FILE,"_S_POS="<<_S_POS)
WRITE(_LOG,_LOG_FILE,"_E_NSP="<<_E_NSP)
ENDIF
_STR="CMM_INTERN"<<","<<"BLOCKOFFSET"<<","<<_POS-1<<","<<_POS-1+_TEC
G4F0
MMC(_STR,"N")
G4F0
WRTPR("BLOCK_OFFSET("<<_POS-1+_TEC-_S_TEC<<","<<_POS-1-_S_POS<<")",1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"BLOCK_OFFSET("<<_POS-1+_TEC-_S_TEC<<","<<_POS-1-_S_POS<<")")
ENDIF
_E_ONETIME=0
S_E_ACT_TECH=_S_TEC
FOR _IT=_S_TEC TO _TEC-1
_BOT=(_E_IR-_IT-1)*65536
S_E_ACT_TECH=S_E_ACT_TECH+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Tec _IT="<<_IT)
WRITE(_LOG,_LOG_FILE,"    S_E_ACT_TECH="<<S_E_ACT_TECH)
WRITE(_LOG,_LOG_FILE,"    Zyk:"<<_E_TR[_IT,0])
WRITE(_LOG,_LOG_FILE,"    _BOT:"<<_BOT)
ENDIF
CASE _E_TR[_IT,0] OF 1 GOTOF _M_T1 2 GOTOF _M_T2 3 GOTOF _M_T3 4 GOTOF _M_T4 5 GOTOF _M_T5 6 GOTOF _M_T6 7 GOTOF _M_T7 8 GOTOF _M_T8 9 GOTOF _M_T9
CASE _E_TR[_IT,0] OF 11 GOTOF _M_T11 12 GOTOF _M_T12 13 GOTOF _M_T13 14 GOTOF _M_T14 15 GOTOF _M_T15 16 GOTOF _M_T16
CASE _E_TR[_IT,0] OF 101 GOTOF _M_T101 102 GOTOF _M_T102 103 GOTOF _M_T103 104 GOTOF _M_T104 105 GOTOF _M_T105 106 GOTOF _M_T106 107 GOTOF _M_T107 108 GOTOF _M_T108
GOTOF _FEHL5
_M_T1:F_DR_SIN(3,_BOT,_IT)
MCALL F_DR_SIN(0,_BOT,_IT)
GOTOF _MCT
_M_T2:F_DR(3,_BOT,_IT)
MCALL F_DR(0,_BOT,_IT)
GOTOF _MCT
_M_T3:F_DR_REA(3,_BOT,_IT)
MCALL F_DR_REA(0,_BOT,_IT)
GOTOF _MCT
_M_T4:F_DR_PEC(3,_BOT,_IT)
MCALL F_DR_PEC(0,_BOT,_IT)
GOTOF _MCT
_M_T5:F_DR_BOR(3,_BOT,_IT)
MCALL F_DR_BOR(0,_BOT,_IT)
GOTOF _MCT
_M_T6:F_DR_TAP(3,_BOT,_IT)
MCALL F_DR_TAP(0,_BOT,_IT)
GOTOF _MCT
_M_T7:F_MI_TR(3,_BOT,_IT)
MCALL F_MI_TR(0,_BOT,_IT)
GOTOF _MCT
_M_T8:F_DR_BGF(3,_BOT,_IT)
MCALL F_DR_BGF(0,_BOT,_IT)
GOTOF _MCT
_M_T9:F_DR_PEC2(3,_BOT,_IT)
MCALL F_DR_PEC2(0,_BOT,_IT)
GOTOF _MCT
_M_T11:F_PO_REC(3,_BOT,_IT)
MCALL F_PO_REC(0,_BOT,_IT)
GOTOF _MCT
_M_T12:F_PO_CIR(3,_BOT,_IT)
MCALL F_PO_CIR(0,_BOT,_IT)
GOTOF _MCT
_M_T13:F_PI_REC(3,_BOT,_IT)
MCALL F_PI_REC(0,_BOT,_IT)
GOTOF _MCT
_M_T14:F_PI_CIR(3,_BOT,_IT)
MCALL F_PI_CIR(0,_BOT,_IT)
GOTOF _MCT
_M_T15:F_SL_LON(3,_BOT,_IT)
MCALL F_SL_LON(0,_BOT,_IT)
GOTOF _MCT
_M_T16:F_SL_OPN(3,_BOT,_IT)
MCALL F_SL_OPN(0,_BOT,_IT)
GOTOF _MCT
_M_T101:F_DR_O1(3,_BOT,_IT)
IF(_E_ONETIME)GOTOF _M_ONETIME
MCALL F_DR_O1(0,_BOT,_IT)
GOTOF _MCT
_M_T102:F_DR_O2(3,_BOT,_IT)
IF(_E_ONETIME)GOTOF _M_ONETIME
MCALL F_DR_O2(0,_BOT,_IT)
GOTOF _MCT
_M_T103:F_DR_O3(3,_BOT,_IT)
IF(_E_ONETIME)GOTOF _M_ONETIME
MCALL F_DR_O3(0,_BOT,_IT)
GOTOF _MCT
_M_T104:F_DR_O4(3,_BOT,_IT)
IF(_E_ONETIME)GOTOF _M_ONETIME
MCALL F_DR_O4(0,_BOT,_IT)
GOTOF _MCT
_M_T105:F_DR_O5(3,_BOT,_IT)
IF(_E_ONETIME)GOTOF _M_ONETIME
MCALL F_DR_O5(0,_BOT,_IT)
GOTOF _MCT
_M_T106:F_DR_O6(3,_BOT,_IT)
IF(_E_ONETIME)GOTOF _M_ONETIME
MCALL F_DR_O6(0,_BOT,_IT)
GOTOF _MCT
_M_T107:F_DR_O7(3,_BOT,_IT)
IF(_E_ONETIME)GOTOF _M_ONETIME
MCALL F_DR_O7(0,_BOT,_IT)
GOTOF _MCT
_M_T108:F_DR_O8(3,_BOT,_IT)
IF(_E_ONETIME)GOTOF _M_ONETIME
MCALL F_DR_O8(0,_BOT,_IT)
GOTOF _MCT
_MCT:
S_E_ACT_POSM=0
FOR _IP=_TEC TO _E_IR-1
_BOP=_E_IR-_IP-1
S_E_ACT_POSM=S_E_ACT_POSM+1
IF(_IP<_TEC+_S_POS)
_OB=4
_E_MC=0
ELSE
_OB=0
_CUR_POS=_BOP
_CUR_TEC=_BOT DIV 65536
_STR="CMM_INTERN"<<","<<"BLOCKOFFSET"<<","<<_CUR_POS<<","<<_CUR_TEC
G4F0
MMC(_STR,"N")
G4F0
WRTPR("BLOCK_OFFSET("<<_CUR_TEC<<","<<_CUR_POS<<")",1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"BLOCK_OFFSET("<<_CUR_TEC<<","<<_CUR_POS<<")")
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"    Pos _IP="<<_IP)
WRITE(_LOG,_LOG_FILE,"      Zyk:"<<_E_TR[_IP,0])
WRITE(_LOG,_LOG_FILE,"      _OB:"<<_OB)
ENDIF
CASE _E_TR[_IP,0] OF -1 GOTOF _M_P1 -2 GOTOF _M_P2 -3 GOTOF _M_P3 -4 GOTOF _M_P4 -5 GOTOF _M_P5
GOTOF _FEHL6
_M_P1:F_PS_SEQ(_OB,_BOP,_IP)
GOTOF _MCP
_M_P2:F_PS_ROW(_OB,_BOP,_IP)
GOTOF _MCP
_M_P3:F_PS_MRX(_OB,_BOP,_IP)
GOTOF _MCP
_M_P4:F_PS_CIR(_OB,_BOP,_IP)
GOTOF _MCP
_M_P5:F_PS_FRA(_OB,_BOP,_IP)
GOTOF _MCP
_MCP:
IF(_IP==_TEC+_S_POS)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"    normal weiter")
ENDIF
_E_NSP=0
ENDIF
ENDFOR
MCALL
_M_ONETIME:
_E_ONETIME=0
_S_POS=0
ENDFOR
_RET:
_E_IR=0
_E_BO=0
WRTPR("POSITIONS(0)")
G4F0
MMC("CMM_INTERN,BLOCKOFFSET,0,0","N")
G4F0
WRTPR("BLOCK_OFFSET(0,0)",1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"BLOCK_OFFSET(0,0)")
ENDIF
RET
_FEHL1: STOPRE
N933001 SETAL(61201)
RET
_FEHL2: STOPRE
N933002 SETAL(61202)
RET
_FEHL3: STOPRE
N933003 SETAL(61203)
RET
_FEHL4: STOPRE
N933004 SETAL(61210)
RET
_FEHL5: STOPRE
N933005 SETAL(61204)
RET
_FEHL6: STOPRE
N933006 SETAL(61205)
RET
_FEHL7: STOPRE
N933007 SETAL(61012)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MI_CON_SPF
PROC F_MI_CON(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,REAL __Z0,INT _Z0A,REAL __Z1,INT _Z1A,REAL _DZ,REAL _UXY,REAL _UZ,INT _ST1,REAL _LS1,INT _FRK,INT _ST2,REAL _LS2,REAL _FZ,INT _FZA,REAL _C0,REAL _DN,REAL _X,REAL _Y,REAL _FS,REAL __ZFS,INT _ZFSA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Contour milling
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _AS1,_AS2,_BA1,_BA10,_BA100,_BA10000,_PMZ,_TM1,_TM3,_TM5,_TM6,_TM9,_P29,_UMODE=0,_MERKER_C=0,_VARI,_I,_DIR,_AMODE[4],_DMODE,_MD_CLAMP,S_MD_BREAK
DEF REAL _FAK1,_FAK2,_FF3,_SD,_SC,_RP,_RP_SD,_RTP,_ZREF,_Z0,_Z1,_ZFS,_OFFN
DEF REAL _LSM=0.001,_LSI=0.0001
DEF FRAME _CYC_FR
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0])
_SC_FIRST_CONT=0
GOTOF _RETS
ENDIF
_Z0=__Z0 _Z1=__Z1 _ZFS=__ZFS
IF(_TMOD MOD 10 ==0)
IF(_BA B_AND 'H80'=='H80')
_Z0=_Z0/2
IF(_Z1A==90)
_Z1=_Z1/2
ENDIF
IF(_ZFSA==90)
_ZFS=_ZFS/2
ENDIF
ENDIF
ENDIF
_P29=$P_GG[29]
DIAMCYCOF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM5=TRUNC(_TMOD/10000) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
IF(_Z1A<>90)
IF(_TM3==0)
_Z1=_Z0-ABS(_Z1)
ELSE
_Z1=_Z0+ABS(_Z1)
ENDIF
ENDIF
_AMODE[1]=0
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N10 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
F_SP_RPT(2,_TMOD)
IF S_CALL_FROM_MA_JOG_STEP
_E_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RP=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RP=_F_RP_ACT*_FAK2
ENDIF
_ZREF=_Z0
_BA1=_BA B_AND 'B111'
IF(_BA1==5)
IF(_ZFSA==91)
_Z1=_Z0-ABS(_ZFS)
ELSE
_Z1=_ZFS
_ZFS=ABS(_Z0-_ZFS)
ENDIF
_DZ=_ZFS _UZ=0 _UXY=_FS
_AMODE[3]=100
ENDIF
_AMODE[2]=0
_AMODE[0]=_AMODE[1]+_AMODE[2]+_AMODE[3]
IF(_Z1>_Z0)
_PMZ=1
ELSE
_PMZ=-1
ENDIF
IF((_TM3==0)AND(_PMZ==1))OR((_TM3==1)AND(_PMZ==-1)) GOTOF _FEHL6
IF(_BA1==1)AND(_DZ<=0) GOTOF _FEHL4
_BA10=0
_BA100=(_BA B_AND 'B11000')/8
_BA10000=(_BA B_AND 'B1000000')/64
_VARI=_BA1+_BA10*10+_BA100*100+_BA10000*10000
IF(((_BA B_AND 'B110000000000')/'B10000000000')==1)
_VARI=_VARI+100000
ENDIF
IF(((_BA B_AND 'B110000000000')/'B10000000000')==2)
_VARI=_VARI+200000
ENDIF
IF(_BA1==1)AND(_FRK==40)
_UXY=0
ENDIF
F_SP_ED(_SD)
IF(_BA100==0)
_RTP=_RP-_SD*_PMZ
ELSE
_RTP=_Z0-(_SC+_SD)*_PMZ
ENDIF
_RP_SD=_F_RP_ACT*_FAK2-_SD*_PMZ
_AS1=(_ST1 B_AND 'B1111')
IF(_FRK==40)AND((_AS1>0)AND(_AS1<>4)) GOTOF _FEHL5
IF(_AS1<>4)
_AS1=_AS1+1
IF(_ST1 B_AND 'B00010000')
_AS1=_AS1+10
ENDIF
_AS2=(_ST2 B_AND 'B1111')
IF(_FRK==40)AND(_AS2>0) GOTOF _FEHL5
_AS2=_AS2+1
IF(_ST2 B_AND 'B00010000')
_AS2=_AS2+10
ENDIF
IF(_LS1<0) GOTOF _FEHL2 IF(_LS2<0) GOTOF _FEHL3
IF(_LS1==0)
IF($P_GG[13]==2)OR($P_GG[13]==4)
_LS1=_LSM
ELSE
_LS1=_LSI
ENDIF
ENDIF
IF(_LS2==0)
IF($P_GG[13]==2)OR($P_GG[13]==4)
_LS2=_LSM
ELSE
_LS2=_LSI
ENDIF
ENDIF
ENDIF
IF($P_F_TYPE==11)OR($P_F_TYPE==33)
IF(_FZA==0)
_DMODE=10
ELSE
_DMODE=20
ENDIF
ELSE
IF(_FZA==0)
_DMODE=20
ELSE
_DMODE=10
ENDIF
ENDIF
_DMODE=_DMODE+1000
_CYC_FR=$P_CYCFRAME
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(103102,_Z0)
ELSE
F_SP_TRA(3102,_Z0)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,_Z0,_C0)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(103122)
ELSE
F_SP_TRA(3122)
ENDIF
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC+_SD) GOTOF _FEHL7
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_TM1==3)
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
N12 CYCLE72(,_RTP,_Z0,_SC,_Z1,_DZ,_UXY,_UZ,_F,_FZ,_VARI,_FRK,_AS1,_LS1,_FF3,_AS2,_LS2,_UMODE,_FS,_ZFS,200,_DMODE,_AMODE[0])
$P_CYCFRAME=_CYC_FR
F_SP_TRA(0)
IF(_TM1<2)
IF(_TM1==0)
F_SP_RP(0,_RP,_SC_POS[1]*_FAK1,0)
F_SP_TRA(1102)
IF(_TM5==1)AND(_FRK<>40)
_OFFN=$P_OFFN*_FAK2
OFFN=-_DN
IF(_TM9==1)
F_SP_TRA(112102,_Z0)
ELSE
F_SP_TRA(12102,_Z0)
ENDIF
ELSE
IF(_TM9==1)
F_SP_TRA(102102,_Z0)
ELSE
F_SP_TRA(02102,_Z0)
ENDIF
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
IF(_TM5==1)AND(_FRK<>40)
F_SP_TRA(12012,_Z0,_C0)
ELSE
F_SP_TRA(02012,_Z0,_C0)
ENDIF
F_SP_RP(0,_RP,_SC_POS[1]*_FAK1,0,_SC_POS[0]*_FAK1)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
_YY=$P_AXN1 _ZZ=$P_AXN2 _XX=$P_AXN3
IF(_F_RELEAS==0)
SBLON
N15 G90 G0 G40 AX[_XX]=_RP_SD AX[_ZZ]=_SC_POS[1]*_FAK1 AX[_YY]=_SC_POS[0]*_FAK1
SBLOF
ENDIF
ELSE
IF(_TM1==2)
F_SP_RP(0,_SC_POS[3]*_FAK1,_RP,0)
IF(_TM9==1)
F_SP_TRA(103122)
ELSE
F_SP_TRA(3122)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
F_SP_RP(9,_SC_POS[0]*_FAK1,_RP,0,_SC_POS[1]*_FAK1)
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
_XX=$P_AXN1 _YY=$P_AXN2 _ZZ=$P_AXN3
IF(_F_RELEAS==0)
SBLON
N35 G90 G0 G40 AX[_XX]=_SC_POS[0]*_FAK1 AX[_ZZ]=_RP_SD AX[_YY]=_SC_POS[1]*_FAK1
SBLOF
ENDIF
ENDIF
SETMS(_F_S_NR[1])
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
IF(_TM1==0)OR(_TM1==2)
IF(_TM6==2)AND(_AS1==4)AND(_BA1==1)
IF(_TM9==1)
_MERKER_C=3
ELSE
_MERKER_C=1
ENDIF
ELSE
IF(_TM9==1)
_MERKER_C=4
ELSE
_MERKER_C=0
ENDIF
ENDIF
ELSE
IF(_TM6==2)
_MERKER_C=2
ELSE
_MERKER_C=0
ENDIF
ENDIF
IF(_MERKER_C==0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_MERKER_C==1)
_VARI=_VARI+1000
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==2)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>1)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
IF(_MERKER_C==3)
_VARI=_VARI+3000
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==4)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N50 CYCLE72(,_RTP,_Z0,_SC,_Z1,_DZ,_UXY,_UZ,_F,_FZ,_VARI,_FRK,_AS1,_LS1,_FF3,_AS2,_LS2,_UMODE,_FS,_ZFS,100,_DMODE,_AMODE[0])
IF(_MERKER_C==1)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
IF(_MERKER_C==3)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ELSE
_SC_FIRST_CONT=0
ENDIF
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
IF(_TM1==0)AND(_TM5==1)AND(_FRK<>40)
OFFN=_OFFN
ENDIF
G[29]=_P29
_E_S_LINE=0
_RETS:
_F_RELEAS=0
SBLON
RET
_FEHL1: STOPRE
N907201 SETAL(61002)
RET
_FEHL2: STOPRE
N907202 SETAL(61223)
RET
_FEHL3: STOPRE
N907203 SETAL(61224)
RET
_FEHL4: STOPRE
N907204 SETAL(61610)
RET
_FEHL5: STOPRE
N907205 SETAL(61115)
RET
_FEHL6: STOPRE
N907206 SETAL(61242)
RET
_FEHL7: STOPRE
N907207 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MI_EDG_SPF
PROC F_MI_EDG(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,REAL _D,REAL _Z0,INT _Z0A,REAL _Z1,INT _Z1A,INT _N,REAL _SWL,REAL _A0,REAL _RF1,REAL _DZ,REAL _DXY,REAL _UZ,REAL _UXY,INT _DXYA,REAL _FS,REAL _ZFS,INT _ZFSA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Multi Edge Milling
DEF AXIS _XX,_YY,_ZZ,_CC,_YYR
DEF INT _BA1,_BA2,_BA3,_FFA,_MAN,_PMZ,_P29,_TM1,_TM3,_TM6,_TM8,_TM9,_VARI,_I,_DIR,_AMODE[5],_MD_CLAMP,_DMODE,S_MD_BREAK,_MERKER_C=0
DEF REAL _FAK1,_FAK2,_RC,_RP,_RP_SD,_RTP,_SC,_SD,_SD1,_SD2,_XS,_YS,_ZS
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_P29=$P_GG[29]
DIAMCYCOF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
IF($P_MC==0)
_F_INIT=1
ENDIF
ELSE
_SC=_E_SC*_FAK2
ENDIF
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM8=TRUNC(_TMOD/10000000) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
_MAN=TRUNC(_TMOD/10) MOD 10
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_MAN==0)
N2 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
ELSE
_F_INIT=2
_F_RELEAS=1
N6 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
ENDIF
IF(_MAN==0)
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2
ENDIF
IF(_Z1A<>90)
IF(_TM3==0)
_Z1=_Z0-ABS(_Z1)
ELSE
_Z1=_Z0+ABS(_Z1)
ENDIF
ENDIF
_AMODE[1]=0
_BA1=_BA B_AND 'B111'
IF(_BA1<1)OR(_BA1>5)OR(_BA1==3) GOTOF _FEHL1
IF(_BA1==4)
_BA1=3
ENDIF
_AMODE[2]=10*_DXYA
IF(_BA1==5)
IF(_ZFSA==91)
_Z1=_Z0-ABS(_ZFS)
ELSE
_Z1=_ZFS
_ZFS=ABS(_Z0-_ZFS)
ENDIF
_DZ=_ZFS _UXY=_FS
_AMODE[2]=0
_AMODE[3]=100
ENDIF
_BA3=(_BA B_AND 'B110000')/'B10000'
IF(_BA3<0)OR(_BA3>2) GOTOF _FEHL5
IF(_BA3==0)
IF(_RF1>=0)
_AMODE[4]=0
ELSE
_AMODE[4]=1000
ENDIF
ELSE
IF(_RF1<0) GOTOF _FEHL6
IF(_BA3==1)
_AMODE[4]=0
ELSE
_AMODE[4]=1000
ENDIF
ENDIF
_RC=ABS(_RF1)
_AMODE[0]=_AMODE[1]+_AMODE[2]+_AMODE[3]+_AMODE[4]
_DMODE=0
IF(_TM8==1)
_DMODE=_DMODE+10000
ENDIF
IF(_Z1>_Z0)
_PMZ=1
ELSE
_PMZ=-1
ENDIF
IF((_TM3==0)AND(_PMZ==1))OR((_TM3==1)AND(_PMZ==-1)) GOTOF _FEHL3
_BA2=(_BA B_AND 'B00001000')/'B00001000'
_VARI=_BA1+_BA2*10
IF(_BA B_AND 'B10000000000')
_VARI=_VARI+100000
ENDIF
_FFA=_FAA-1
F_SP_ED(_SD)
_RTP=_Z0-(_SC+_SD)*_PMZ
IF(_MAN==0)
_RP_SD=_F_RP_ACT*_FAK2-_SD*_PMZ
ENDIF
IF(_F<=0) GOTOF _FEHL2
IF(_TM1<2)
GOTOF _FEHL1
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC+_SD) GOTOF _FEHL7
ENDIF
F_SP_TRA(2002+_TM1*10,,0)
ENDIF
ENDIF
N98 CYCLE79(_RTP,_Z0,_SC,_Z1,_N,_SWL,0,0,_A0,_RC,_D,_DXY,_DZ,_UXY,_UZ,_F,_E_DIR,_VARI,_FS,_ZFS,200,_DMODE,_AMODE[0])
F_SP_TRA(0)
IF(_TM1==2)
IF(_MAN==0)
F_SP_RP(0,_SC_POS[3]*_FAK1,_RP,0)
IF(_TM9==1)
F_SP_TRA(103122)
ELSE
F_SP_TRA(3122)
ENDIF
G17
_XX=$P_AXN1 _YY=$P_AXN2 _ZZ=$P_AXN3
ELSE
F_SP_TRA(2022)
_XX=$P_AXN1 _ZZ=$P_AXN3
_XS=$P_EP[_XX]*_FAK1 _ZS=$P_EP[_ZZ]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN2
_YS=$P_EP[_YYR]*_FAK1
ENDIF
IF((_PMZ==-1)AND(_ZS<_RTP)) OR ((_PMZ==1)AND(_ZS>_RTP)) GOTOF _FEHL4
IF(_TM9==1)
F_SP_TRA(103122)
ELSE
N55 F_SP_TRA(3122)
ENDIF
_YY=$P_AXN2
ENDIF
ENDIF
IF(_TM1==3)OR(_TM1==6)
F_SP_TRA(2002+_TM1*10,,0)
IF(_MAN==0)
F_SP_RP(9,_SC_POS[0]*_FAK1,_RP,0,_SC_POS[1]*_FAK1)
G17
_XX=$P_AXN1 _YY=$P_AXN2 _ZZ=$P_AXN3
ELSE
_XX=$P_AXN1 _YY=$P_AXN2 _ZZ=$P_AXN3 _YYR=$P_AXN2
_XS=$P_EP[_XX]*_FAK1 _YS=$P_EP[_YYR]*_FAK1 _ZS=$P_EP[_ZZ]*_FAK1
IF((_PMZ==-1)AND(_ZS<_RTP)) OR ((_PMZ==1)AND(_ZS>_RTP)) GOTOF _FEHL4
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N70 G0 G90 AX[_CC]=0
SBLOF
ENDIF
ENDIF
ENDIF
IF(_MAN==0)
IF(_F_RELEAS==0)
SBLON
N90 G90 G0 G40 AX[_XX]=_SC_POS[0]*_FAK1 AX[_YY]=_SC_POS[1]*_FAK1 AX[_ZZ]=_RP_SD
SBLOF
ENDIF
ELSE
SBLON
N95 G90 G0 G40 AX[_XX]=_SC_POS[0]*_FAK1 AX[_YY]=_SC_POS[1]*_FAK1 AX[_ZZ]=_RTP
SBLOF
ENDIF
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
IF(_TM1==0)OR(_TM1==2)
IF(_TM9==1)
_MERKER_C=4
ELSE
_MERKER_C=0
ENDIF
ELSE
IF(_TM6==2)
_MERKER_C=2
ELSE
_MERKER_C=0
ENDIF
ENDIF
IF(_MERKER_C==0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_MERKER_C==2)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>1)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
IF(_MERKER_C==4)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N100 CYCLE79(_RTP,_Z0,_SC,_Z1,_N,_SWL,0,0,_A0,_RC,_D,_DXY,_DZ,_UXY,_UZ,_F,_E_DIR,_VARI,_FS,_ZFS,100,_DMODE,_AMODE[0])
ENDIF
IF(_MAN<>0)
F_SP_TRA(2022)
IF(_F_Y_AXIS==0)
SBLON
N120 G90 G0 AX[_XX]=_XS AX[_ZZ]=_ZS
SBLOF
ELSE
SBLON
N160 G90 G0 AX[_XX]=_XS AX[_ZZ]=_ZS AX[_YYR]=_YS
SBLOF
ENDIF
ENDIF
G[29]=_P29
_E_S_LINE=0
_RETS:
_F_RELEAS=0
SBLON
RET
_FEHL1:STOPRE
N907901 SETAL(61002)
RET
_FEHL2:STOPRE
N907902 SETAL(61003)
RET
_FEHL3: STOPRE
N907903 SETAL(61242)
RET
_FEHL4: STOPRE
N907904 SETAL(61284)
RET
_FEHL5:STOPRE
N907905 SETAL(61019," R1/FS1 ")
RET
_FEHL6: STOPRE
N907906 SETAL(61022," R1/FS1 ")
RET
_FEHL7: STOPRE
N907907 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MI_PL_SPF
PROC F_MI_PL(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,REAL _Z0,INT _Z0A,REAL _Z1,INT _Z1A,REAL _DZ,REAL _UZ,REAL _X0,INT _X0A,REAL _Y0,INT _Y0A,REAL _X1,INT _X1A,REAL _Y1,INT _Y1A,REAL _DXY,INT _DXYA,REAL _C0,INT _LIM,REAL _A0) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Extended face milling
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _BA1,_BA10,_PMZ,_P29,_TM1,_TM3,_TM6,_MAN=0,_MD_CLAMP,_I,_DIR,_AMODE[6]
DEF REAL _FAK1,_FAK2,_SD,_SC,_RP,_RP_SD,_XS,_YS,_X,_Y,_Z
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
OFFN=0
_P29=$P_GG[29]
DIAMCYCOF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_F_INIT=1
_MAN=1
_F_RELEAS=0
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
ELSE
_SC=_E_SC*_FAK2
ENDIF
N10 G40 G90
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM6=TRUNC(_TMOD/100000) MOD 10
IF(_Z1A<>90)
IF(_TM3==0)
_Z1=_Z0-ABS(_Z1)
ELSE
_Z1=_Z0+ABS(_Z1)
ENDIF
ENDIF
_AMODE[1]=0
IF(_Z1>_Z0)
_PMZ=1
ELSE
_PMZ=-1
ENDIF
IF((_TM3==0)AND(_PMZ==1))OR((_TM3==1)AND(_PMZ==-1)) GOTOF _FEHL6
IF(_X1A<>91)
_AMODE[4]=1
ELSE
_AMODE[4]=0
ENDIF
IF(_Y1A<>91)
_AMODE[5]=1
ELSE
_AMODE[5]=0
ENDIF
_BA1=0 _BA10=0
IF(_BA B_AND 'B00000001')
_BA1=1
ENDIF
IF(_BA B_AND 'B00000010')
_BA1=_BA1+2
ENDIF
IF(_BA1==0) OR (_BA1==3) GOTOF _FEHL1
IF(_BA B_AND 'B00000100')
_BA10=20
ELSE
_BA10=10
ENDIF
IF(_BA B_AND 'B00001000')
_BA10=_BA10+20
ENDIF
_BA=_BA1+_BA10
IF(_BA1==1)AND(_DZ<=0) GOTOF _FEHL2
IF((_BA==12)OR(_BA==22))AND(_UZ<=0) GOTOF _FEHL3
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_MAN)
N30 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,8)
ELSE
N40 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
ENDIF
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_MAN*1000+_TM3*100000)
ENDIF
F_SP_ED(_SD)
IF(_MAN==0)
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2
ENDIF
IF(_TM1<2)
IF(_TM1==0)
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,,_C0)
_YY=$P_AXN1 _ZZ=$P_AXN2 _XX=$P_AXN3
_XS=_X0 _YS=_Y0
IF(_MAN==0)
F_SP_RP(0,_RP,_YS,0,_XS)
ELSE
_Z=$P_EP[_XX]*_FAK1
IF(_Z<_Z0+_SC) GOTOF _FEHL5
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
ELSE
IF(_TM1==2)
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC+_SD) GOTOF _FEHL4
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(3002+_TM1*10,,_C0)
_XX=$P_AXN1 _YY=$P_AXN2 _ZZ=$P_AXN3
_XS=_X0 _YS=_Y0
IF(_MAN==0)
F_SP_RP(9,_XS,_RP,0,_YS)
ELSE
_Z=$P_EP[_ZZ]*_FAK1
IF(_Z<_Z0+_SC) GOTOF _FEHL5
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
IF(_MAN==0)
_RP_SD=_F_RP_ACT*_FAK2-_SD*_PMZ
ENDIF
_X=$P_EP[_XX]*_FAK1 _Y=$P_EP[_YY]*_FAK1 _Z=$P_EP[_ZZ]*_FAK1
_X0=_XS _Y0=_YS
IF(_MAN==1)
_RP=_Z
ENDIF
IF(_F_RELEAS==0)
IF(_TM1<2)
IF(_TM1==0)
ELSE
SBLON
N19 G90 G0 G40 AX[_XX]=_RP_SD AX[_YY]=_X0 AX[_ZZ]=_Y0
SBLOF
ENDIF
ELSE
IF(_TM1==2)
ELSE
SBLON
N20 G90 G0 G40 AX[_XX]=_X0 AX[_YY]=_Y0 AX[_ZZ]=_RP_SD
SBLOF
ENDIF
ENDIF
ENDIF
_AMODE[2]=_DXYA
_AMODE[0]=_AMODE[1]+10*_AMODE[2]+1000*_AMODE[4]+10000*_AMODE[5]
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_TM1==1)OR(_TM1==3)OR(_TM1==6)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N50 CYCLE61(_Z0-(_SC+_SD)*_PMZ,_Z0,_SC,_Z1,_X0,_Y0,_X1,_Y1,_DZ,_DXY,_UZ,_F,_BA,_LIM,0,_AMODE[0],0,_A0)
ENDIF
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
IF(_MAN==1)
SBLON
N80 G0 AX[_XX]=_X AX[_YY]=_Y AX[_ZZ]=_Z
SBLOF
ENDIF
_RET:
G[29]=_P29
_E_S_LINE=0
_RETS:
_F_RELEAS=0
SBLON
RET
_FEHL1: STOPRE
N906101 SETAL(61002)
RET
_FEHL2: STOPRE
N906102 SETAL(61610)
RET
_FEHL3: STOPRE
N906103 SETAL(62103)
RET
_FEHL4: STOPRE
N906104 SETAL(61742,"RP")
RET
_FEHL5: STOPRE
N906105 SETAL(61284)
RET
_FEHL6: STOPRE
N906106 SETAL(61242)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MI_TR_SPF
PROC F_MI_TR(INT _OB,INT _BO,INT _IDD,STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,REAL _Z1,INT _Z1A,REAL _P,INT _PA,REAL _D,REAL _KK,REAL _DXY,REAL _U,REAL _A0,INT _NT,REAL _FI,REAL _FM,INT _FZG,INT _FZZ,INT _FZN,INT _POS,INT _DXYA,STRING[20] _PTAB,STRING[20] _PTABA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.005 ;DATE: 2024-04-03
;ShopTurn: Thread Milling
DEF AXIS _AX1,_AX2,_AX3,_CC
DEF INT _BA1,_BA10,_BA100,_PMZ,_TYP,_VARI,_P29,_TM1,_TM3,_TM6,_TM9,_MAN,_MD_CLAMP,_I,_DIR,_PITA,_AMODE,S_MD_BREAK,_MERKER_C=0
DEF REAL _FAK1,_FAK2,_RP,_RTP,_SC,_SD,_X0,_Y0,_Z,_ZREF,_ANG
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
_P29=$P_GG[29]
DIAMCYCOF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF(_F_PS_REF<>_SC_NO_VAL)
_ZREF=_F_PS_REF*_FAK2
ENDIF
_RP=_F_RP_ACT*_FAK2
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
IF(_OB==0)
IF(NOT _E_MC)
GOTOF _RET
ENDIF
IF(_IDD>=0)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD]
_DD=_E_TR[_IDD,1] _F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6]
_BA=_E_TR[_IDD,7] _Z1=_E_TR[_IDD,8] _Z1A=_E_TR[_IDD,9]
_P=_E_TR[_IDD,10] _D=_E_TR[_IDD,11] _KK=_E_TR[_IDD,12] _DXY=_E_TR[_IDD,13]
_U=_E_TR[_IDD,14] _A0=_E_TR[_IDD,15] _NT=_E_TR[_IDD,16] _DXYA=_E_TR[_IDD,17]
_PA=_E_TR[_IDD,18]
IF(_DXYA==1)
_DXY=_DXY/100*(2*$P_TOOLR*_FAK1)
ENDIF
_IDD=-1
ENDIF
_TM1=_TMOD MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
IF($P_MC==0)
_F_INIT=1
ENDIF
ELSE
_SC=_E_SC*_FAK2
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_CC=_F_S_AX[_F_MASPI]
_ANG=_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]-$P_ACTFRAME[_CC,TR]
ENDIF
IF(_TM1<2)
F_SP_TRA(2012,,_ANG)
_AX1=$P_AXN1 _AX2=$P_AXN2
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
F_SP_TRA(2002+_TM1*10,,_ANG)
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2
ENDIF
_X0=$P_EP[_AX1]*_FAK1 _Y0=$P_EP[_AX2]*_FAK1
_AX3=$P_AXN3
_Z=_Z1
IF(_Z1A<>90)
IF(_TM3==0)
_Z=_ZREF-ABS(_Z)
ELSE
_Z=_ZREF+ABS(_Z)
ENDIF
ENDIF
_AMODE=0
IF(_Z>_ZREF)
_PMZ=1
ELSE
_PMZ=-1
ENDIF
IF((_TM3==0)AND(_PMZ==1))OR((_TM3==1)AND(_PMZ==-1)) GOTOF _FEHL4
F_SP_ED(_SD)
_BA1=0 _BA10=10 _BA100=0 _TYP=0
IF(_BA B_AND 'B00000001')
_BA1=1
ENDIF
IF(_BA B_AND 'B00000010')
_BA1=_BA1+2
ENDIF
IF(_BA1==0)OR(_BA1==3) GOTOF _FEHL0
IF(_BA B_AND 16)
_BA10=20
ENDIF
IF(_BA B_AND 4)
_BA100=100
ENDIF
IF(_BA B_AND 8)
_TYP=1
ENDIF
_VARI=_BA1+_BA10+_BA100
IF(_PA _DEC2 <0)OR(_PA _DEC2 >1)OR(_PA _DEC1 <0)OR(_PA _DEC1 >3) GOTOF _FEHL3
IF(_PA _DEC2 ==0)
_PITA=0
ELSE
IF(_PA _DEC1 ==0)
_PITA=1
ELSE
IF(_PA _DEC1 ==1)
_PITA=3
ENDIF
IF(_PA _DEC1 ==2)
_PITA=4
ENDIF
IF(_PA _DEC1 ==3)
_PITA=2
ENDIF
ENDIF
ENDIF
_E_BO=_BO+(_E_BO B_AND 65535)
_RTP=_ZREF-(_SC+_SD)*_PMZ/$P_ACTFRAME[_AX3,SC]
N10 F_TFS(,,,_F,_FAA)
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
SETMS(_F_S_NR[1])
IF(_TM1==0)OR(_TM1==2)
IF(_TM9==1)
_MERKER_C=4
ELSE
_MERKER_C=0
ENDIF
ELSE
IF(_TM6==2)
_MERKER_C=2
ELSE
_MERKER_C=0
ENDIF
ENDIF
IF(_MERKER_C==0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_MERKER_C==2)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>1)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
IF(_MERKER_C==4)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N30 CYCLE70(_RTP,_ZREF,_SC,_Z,_D,_KK,_U,_P,_NT,_DXY,_F,_TYP,_X0,_Y0,_A0,_VARI,_PITA,,_PTAB,_PTABA,100,0,_AMODE)
ENDIF
ELSE
IF(_OB==3)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD] _DD=_E_TR[_IDD,1]
_F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4] _SA=_E_TR[_IDD,5]
_TMOD=_E_TR[_IDD,6]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_MAN==0)
N40 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
_F_RELEAS=0
ELSE
_F_INIT=2
_F_RELEAS=1
N41 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+100+_TM3*100000)
ENDIF
ENDIF
ELSE
IF(_E_IR<_E_MAX)
_E_TS1[_E_IR]=_T _E_TS2[_E_IR]=_TF
_E_TR[_E_IR,0]=SET(7,_DD,_F,_FAA,_S,_SA,_TMOD,_BA,_Z1,_Z1A,_P,_D,_KK,_DXY,_U,_A0,_NT,_DXYA,_PA)
_E_IR=_E_IR+1
IF(_POS>=0)
_E_POS=_POS
ENDIF
ELSE
GOTOF _FEHL2
ENDIF
IF(_OB==2)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
G[29]=_P29
_E_S_LINE=0
_RETS:
SBLON
RET
_FEHL0: STOPRE
N907000 SETAL(61002)
RET
_FEHL2: STOPRE
N907002 SETAL(61200)
RET
_FEHL3: STOPRE
N807003 SETAL(61001)
RET
_FEHL4: STOPRE
N907004 SETAL(61242)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MI_TXT_SPF
PROC F_MI_TXT(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,REAL _FZ,INT _FZA,REAL __Z0,REAL __Z1,INT _Z1A,REAL _W,REAL _DX,INT _LAGE,REAL _X0,REAL _Y0,REAL _C0,REAL _A1,STRING[100] _TEXT,REAL _XS,REAL _YS,INT _COD,REAL _XM,INT _XMA,REAL _YM,INT _BA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Engraving
DEF AXIS _XX,_ZZ,_CC,_YY,_XXR,_YYR,_ZZR
DEF INT _PMZ,_P29,_MAN,_TM1,_TM3,_TM4,_TM6,_TM9,_UMODE=0,_WTYP,_MD_CLAMP,_I,_DIR,S_MD_BREAK,_MERKER_C=0
DEF INT _VAR,_VAR1,_VAR2,_VAR3,_VAR4,_VAR5,_VAR6,_VAR7,_VAR8,_AMODE,_DMODE
DEF REAL _FAK1,_FAK2,_CP1=0,_CP2=0,_SC,_SD,_RP,_RP_SD,_RTP,_SPX,_SPZ,_XST,_YST,_ZST,_Z0,_Z1
DEF FRAME _CYC_FR
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_P29=$P_GG[29]
DIAMCYCOF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_F_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
ELSE
_SC=_E_SC*_FAK2
ENDIF
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
_TM1=_TMOD MOD 10 _MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10 _TM4=TRUNC(_TMOD/1000) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
_VAR2=TRUNC(_LAGE/10) MOD 10
_Z0=__Z0 _Z1=__Z1
IF(_TM1==0)
IF(_BA B_AND 'B01'=='B01')
_Z0=_Z0/2
IF(_Z1A==90)
_Z1=_Z1/2
ENDIF
ENDIF
ENDIF
IF(_TM6==0)
_TM6=2
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
IF(_Z1A<>90)
IF(_TM3==0)
_Z1=_Z0-ABS(_Z1)
ELSE
_Z1=_Z0+ABS(_Z1)
ENDIF
ENDIF
_AMODE=2
IF(_Z1>_Z0)
_PMZ=1
ELSE
_PMZ=-1
ENDIF
IF((_TM3==0)AND(_PMZ==1))OR((_TM3==1)AND(_PMZ==-1)) GOTOF _FEHL1
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_MAN==0)
N14 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
ELSE
_F_INIT=2
_F_RELEAS=1
N16 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
ENDIF
IF($P_TOOLNO)
_WTYP=$P_AD[1]
ENDIF
F_SP_ED(_SD)
IF($P_F_TYPE==11)OR($P_F_TYPE==33)
IF(_FZA==0)
_DMODE=10
ELSE
_DMODE=20
ENDIF
ELSE
IF(_FZA==0)
_DMODE=20
ELSE
_DMODE=10
ENDIF
ENDIF
IF(_MAN==0)
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2
ENDIF
IF(_MAN==0)
_RP_SD=_F_RP_ACT*_FAK2-_SD*_PMZ
ENDIF
IF(_TM4)AND((_TM1==0)OR(_TM1==1))AND(_VAR2==0)
_VAR1=0
ELSE
_VAR1=_TM4
ENDIF
_VAR2=10*(TRUNC(_LAGE/10) MOD 10)
_VAR3=0
_VAR4=1000*(TRUNC(_LAGE/100) MOD 10)
_VAR5=10000*(TRUNC(_LAGE/1000) MOD 10)
_VAR6=TRUNC(_LAGE/10000) MOD 10
IF(_VAR2==0)AND(_VAR6<>0)
_VAR6=1
ENDIF
IF(_VAR2<>0)AND(_VAR6<>0)
_VAR6=2
ENDIF
_VAR6=100000*_VAR6
_VAR7=1000000*0
_VAR8=10000000*(TRUNC(_LAGE/100000) MOD 10)
_VAR=_VAR1+_VAR2+_VAR3+_VAR4+_VAR5+_VAR6+_VAR7+_VAR8
_RTP=_Z0-(_SC+_SD)*_PMZ
_CYC_FR=$P_CYCFRAME
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_Z0)
ELSE
F_SP_TRA(2102,_Z0)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,_Z0,_C0)
_CP1=_XM _CP2=_YM
ENDIF
IF(_VAR2>0)
IF(_XMA==0)
_CP1=_XM _CP2=_YM
ELSE
_CP1=2*_Z0*$PI*_XM/360 _CP2=_YM
ENDIF
ENDIF
IF(_TM4)AND(_VAR2==0)
_X0=2*_Z0*$PI*_X0/360
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC+_SD) GOTOF _FEHL14
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_TM1==3)
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
N144 CYCLE60(_TEXT,_RTP,_Z0,_SC,_Z1,,_X0,_Y0,_A1,_CP1,_CP2,_W,_DX,_FZ,_F,_VAR,_COD,_UMODE,200,_DMODE,_AMODE)
$P_CYCFRAME=_CYC_FR
F_SP_TRA(0)
IF(_TM1<2)
_SPZ=_SC_POS[1]*_FAK1
IF(_TM1==0)
IF(_MAN==0)
F_SP_RP(0,_RP,_SPZ,0)
ELSE
F_SP_TRA(2002,_Z0)
_XXR=$P_AXN3 _ZZR=$P_AXN2
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN1
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM9==1)
F_SP_TRA(103102,_Z0)
ELSE
F_SP_TRA(3102,_Z0)
ENDIF
ELSE
F_SP_TRA(2012,_Z0,_C0)
IF(_MAN==0)
F_SP_RP(0,_RP,_SPZ,0,_SC_POS[0]*_FAK1)
ELSE
_YYR=$P_AXN1 _ZZR=$P_AXN2 _XXR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N35 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
_YY=$P_AXN1 _ZZ=$P_AXN2 _XX=$P_AXN3
IF(_MAN==0)
IF(_F_RELEAS==0)
SBLON
N40 G90 G0 G40 AX[_XX]=_RP_SD AX[_ZZ]=_SC_POS[1]*_FAK1 AX[_YY]=_SC_POS[0]*_FAK1
SBLOF
ENDIF
ELSE
SBLON
N42 G90 G0 G40 AX[_XX]=_RTP AX[_ZZ]=_SC_POS[1]*_FAK1 AX[_YY]=_SC_POS[0]*_FAK1
SBLOF
ENDIF
ELSE
IF(_F_RELEAS==0)OR(_MAN<>0)
_SPX=_SC_POS[0]*_FAK1
ELSE
_SPX=_SC_POS[0]*_FAK1
ENDIF
IF(_TM1==2)
IF(_MAN==0)
F_SP_RP(0,_SC_POS[3]*_FAK1,_RP,0)
ELSE
F_SP_TRA(2022)
_XXR=$P_AXN1 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN2
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM9==1)
F_SP_TRA(103122)
ELSE
F_SP_TRA(3122)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_MAN==0)
F_SP_RP(9,_SC_POS[0]*_FAK1,_RP,0,_SC_POS[1]*_FAK1)
ELSE
_XXR=$P_AXN1 _YYR=$P_AXN2 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N65 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
_XX=$P_AXN1 _YY=$P_AXN2 _ZZ=$P_AXN3
IF(_MAN==0)
IF(_F_RELEAS==0)
SBLON
N70 G90 G0 G40 AX[_XX]=_SC_POS[0]*_FAK1 AX[_ZZ]=_RP_SD AX[_YY]=_SC_POS[1]*_FAK1
SBLOF
ENDIF
ELSE
SBLON
N72 G90 G0 G40 AX[_XX]=_SC_POS[0]*_FAK1 AX[_ZZ]=_RTP AX[_YY]=_SC_POS[1]*_FAK1
SBLOF
ENDIF
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
IF(_TM1==0)OR(_TM1==2)
IF(_TM9==1)
_MERKER_C=4
ELSE
_MERKER_C=0
ENDIF
ELSE
IF(_TM6==2)
_MERKER_C=2
ELSE
_MERKER_C=0
ENDIF
ENDIF
IF(_MERKER_C==0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_MERKER_C==2)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>1)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
IF(_MERKER_C==4)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N150 CYCLE60(_TEXT,_RTP,_Z0,_SC,_Z1,,_X0,_Y0,_A1,_CP1,_CP2,_W,_DX,_FZ,_F,_VAR,_COD,_UMODE,100,_DMODE,_AMODE)
ENDIF
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
IF(_MAN<>0)
IF(_TM1>=2)
IF(_TM1==2)
F_SP_TRA(2022)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N160 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N170 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ELSE
IF(_TM1==0)
F_SP_TRA(2012,_Z0,_C0)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N180 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N190 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ENDIF
ENDIF
G[29]=_P29
_E_S_LINE=0
_RETS:
_F_RELEAS=0
SBLON
RET
_FEHL1: STOPRE
N906001 SETAL(61242)
RET
_FEHL2: STOPRE
N906002 SETAL(61212)
RET
_FEHL13: STOPRE
N906013 SETAL(61284)
RET
_FEHL14: STOPRE
N906014 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_DSO_SPF
PROC F_MP_DSO(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _BETA,INT _BETAA,REAL S_Z,REAL S_X,INT S_MVAR,INT S_KNUM,INT S_KNUM1,INT S_PRNUM,REAL S_SETV,INT S_MA,REAL S_SZA,REAL S_SZO,REAL S_FA,REAL S_TSA,INT S_NMSP,STRING[32] S_TNAME,INT S_DLNUM,REAL S_TZL,REAL S_TDIF,REAL S_TUL,REAL S_TLL,REAL S_TMV,INT S_K,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE,INT _DP) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.90.00.00.001 ;DATE: 2018-02-22
;ShopTurn: Measure part: Diameter outside
DEF AXIS _XX,_YY,_ZZ
DEF INT _P29,_TYP
DEF REAL _FAK1,_FAK2
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
S_X=S_X/2
_P29=$P_GG[29]
DIAMCYCOF
N10 G40 G90
F_SP_TRA(2040)
_ZZ=$P_AXN1 _XX=$P_AXN2
IF(_F_Y_AXIS<>0)
_YY=$P_AXN3
ENDIF
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N25 F_TFS(_T,_TF,_DD,,,,,_F_MASPI+1,0)
N26 F_SP_BC(10004,_BETA,0)
ELSE
N28 F_TFS(_T,_TF,_DD,,,,,_F_MASPI+1,0)
ENDIF
IF($P_TOOLNO==0) GOTOF _FEHL0
IF($P_TOOL==0) GOTOF _FEHL1
_TYP=$P_AD[1]
IF(_TYP<>580)AND(_TYP<>710) GOTOF _FEHL2
F_SP_RPT(5)
IF(_F_RELEAS==0)
IF(S_MA==3)
N45 F_SP_RP(0,0,S_Z,0,S_X)
ELSE
N50 F_SP_RP(0,S_X,S_Z,0,0)
ENDIF
ENDIF
SBLON
IF(_F_Y_AXIS<>0)
IF(S_MA==3)
N52 G0 G90 AX[_XX]=0 AX[_ZZ]=S_Z AX[_YY]=S_X
ELSE
N55 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z AX[_YY]=0
ENDIF
ELSE
N56 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z
ENDIF
SBLOF
_DMODE=_DMODE-(_DMODE _DEC1)
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
N994 CYCLE994(S_MVAR,S_KNUM,S_KNUM1,S_PRNUM,S_SETV,S_MA,S_SZA,S_SZO,S_FA,S_TSA,S_NMSP,S_TNAME,S_DLNUM,S_TZL,S_TDIF,S_TUL,S_TLL,S_TMV,S_K,S_EVNUM,S_MCBIT,_DMODE,_AMODE,_DP)
ELSE
IF(_F_Y_AXIS<>0)
N1000 G0 AX[_XX]=S_X AX[_ZZ]=S_Z AX[_YY]=0
ELSE
N1001 G0 AX[_XX]=S_X AX[_ZZ]=S_Z
ENDIF
ENDIF
G[29]=_P29
_E_S_LINE=0
_RETS:
_F_RELEAS=0
SBLON
RET
_FEHL0: STOPRE
N999400 SETAL(61009)
RET
_FEHL1: STOPRE
N999401 SETAL(61000)
RET
_FEHL2: STOPRE
N999402 SETAL(61212)
RET
_FEHL3: STOPRE
N999403 SETAL(61415)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_DSI_SPF
PROC F_MP_DSI(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _BETA,INT _BETAA,REAL S_Z,REAL S_X,INT S_MVAR,INT S_KNUM,INT S_KNUM1,INT S_PRNUM,REAL S_SETV,INT S_MA,REAL S_SZA,REAL S_SZO,REAL S_FA,REAL S_TSA,INT S_NMSP,STRING[32] S_TNAME,INT S_DLNUM,REAL S_TZL,REAL S_TDIF,REAL S_TUL,REAL S_TLL,REAL S_TMV,INT S_K,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE,INT _DP) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.90.00.00.001 ;DATE: 2018-02-22
;ShopTurn: Measure part: Diameter inside
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
F_MP_DSO(_T,_TF,_DD,_BETA,_BETAA,S_Z,S_X,S_MVAR,S_KNUM,S_KNUM1,S_PRNUM,S_SETV,S_MA,S_SZA,S_SZO,S_FA,S_TSA,S_NMSP,S_TNAME,S_DLNUM,S_TZL,S_TDIF,S_TUL,S_TLL,S_TMV,S_K,S_EVNUM,S_MCBIT,_DMODE,_AMODE,_DP)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_PARTOF_SPF
PROC F_PARTOF(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,REAL __X0,REAL _Z0,REAL __X1,INT __X1A,REAL __X2,INT __X2A,REAL _RFF,REAL _SE,REAL _FE,REAL __XM,INT _ST,REAL _SMAX,REAL _BETA,INT _BETAA,REAL _GAMA,INT _BA,REAL S_POLA,INT S_FR_M,REAL S_FR_I,STRING[32] S_TRA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Part cut-off cycle
DEF AXIS _XX,_ZZ,_Z2,_YY
DEF INT _EXM,_G60_64,_MAN,_P29,_TYP,_SL,_X1A,_X2A,_AMODE[6],S_MODE_BC,_VARI,S_Y_TURN,S_C805_AMODE
DEF INT _SLT[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,2,1,4,3,7,6,5,8,9)
DEF INT _SLX[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,4,3,2,1,5,8,7,6,9)
DEF REAL _FAK1,_FAK2,_OFFZ,_SC,_WR,_WB,_XS,_YS,_ZS,_RC,_X0,_X1,_X2,_XM,S_ROT_Z
DEF STRING[32] _TC
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
IF(NOT _F_SUBSP)
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
ELSE
IF(_E_S_LINE==$P_LINENO[0])
_E_S_LINE=0
ENDIF
ENDIF
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_PARTOF_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
ENDIF
IF(_E_SM_PRG)AND((_TMOD _DEC4)==0) GOTOF _FEHL11
IF(_E_ST_PRG)AND((_TMOD _DEC4)==1) GOTOF _FEHL12
IF(_BA B_AND 'B11' <0)OR(_BA B_AND 'B11' >2) GOTOF _FEHL9
_X1A=__X1A _X2A=__X2A
IF(_BA B_AND 'B11' == 0)
_X0=__X0 _XM=__XM
IF(_X1A==90)
_X1=__X1
ELSE
_X1=_X0-ABS(__X1) _X1A=90
ENDIF
IF(_X2A==90)
_X2=__X2
ELSE
_X2=_X1-ABS(__X2) _X2A=90
ENDIF
ELSE
_X0=__X0/2 _XM=__XM/2
IF(_X1A==90)
_X1=__X1/2
ELSE
_X1=_X0-ABS(__X1) _X1A=90
ENDIF
IF(_X2A==90)
_X2=__X2/2
ELSE
_X2=_X1-ABS(__X2) _X2A=90
ENDIF
ENDIF
IF((_X0-_X1)<ABS(_RFF)) GOTOF _FEHL4
IF(_X1>=_X0) GOTOF _FEHL4
IF(_X2>_X1) GOTOF _FEHL4
_EXM=($MCS_FUNCTION_MASK_TURN B_AND 'H02')*(_ST B_AND 'H01')
IF(_EXM)AND(_XM>_X0-ABS(_RFF)) GOTOF _FEHL4
_MAN=TRUNC(_TMOD/10) MOD 10
IF(_MAN==0)
IF(_F_BAR_START==0)
GOTOF _RET
ENDIF
ENDIF
IF(_TMOD _DEC9)==3
S_Y_TURN=1
ENDIF
IF(_E_SM_PRG)
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H0000')
DIAM90
ELSE
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H8000')
DIAMON
ELSE
DIAMOF
ENDIF
ENDIF
ENDIF
_P29=$P_GG[29]
DIAMCYCOF
_G60_64=$P_GG[10]
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_F_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
ELSE
_SC=_E_SC*_FAK2
ENDIF
IF(_MAN==0)
IF(_SA==2)AND(_SMAX>0)
LIMS=_SMAX
ENDIF
IF(_E_SM_PRG)
N10 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=S_FR_M
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
_ZZ=$P_AXN1
S_ROT_Z=$P_ACTFRAME[_ZZ,RT]
N11 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
IF($P_ACTFRAME[_ZZ,RT]<>S_ROT_Z)
IF($P_EP[_ZZ]*_FAK1<_F_RPT[1]*_FAK2)
N115 G0 G90 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
ENDIF
N12 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
ELSE
IF S_Y_TURN
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Y-Drehen")
ENDIF
N1800 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
IF(_SC_Y_TURN)
IF(_SC_Y_TURN_GAMA<>_GAMA)
F_SP_RP(1,,,1)
ENDIF
IF(_BA B_AND 'H1000000' == 'H1000000')
IF(_SC_Y_TURN==-90)
F_SP_RP(1,,,1)
ENDIF
ELSE
IF(_SC_Y_TURN==90)
F_SP_RP(1,,,1)
ENDIF
ENDIF
ENDIF
IF(_F_TC_DEF[2]==0)
_TC=""
ELSE
_TC=$TC_CARR34[_F_TC_DEF[2]]
ENDIF
IF(_BA B_AND 'H1000000' == 'H1000000')
S_C805_AMODE=1000
ENDIF
N1805 CYCLE805(1,_TC,_GAMA,,,,S_C805_AMODE)
N1810 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,7)
ELSE
IF(_F_SUBSP==1)
N19 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
ELSE
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N20 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
N21 F_SP_BC(4,_BETA,_GAMA)
N22 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,7)
ELSE
N23 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,0)
F_SP_TRA(2040)
ENDIF
ENDIF
ENDIF
ENDIF
ELSE
IF($MCS_TECHNOLOGY==2)
N13 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=0
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
N14 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
N15 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
ELSE
_F_INIT=2
_F_RELEAS=1
IF(_MAN==1)
_F_MASPI=0
N24 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,1,8)
ELSE
_F_MASPI=2
N26 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,3,8)
ENDIF
F_SP_TRA(2040)
ENDIF
ENDIF
IF((_BA B_AND 'B11')==0)
IF(_RFF>=0)
_AMODE[4]=0
ELSE
_AMODE[4]=1000
ENDIF
ELSE
IF(_RFF<0) GOTOF _FEHL10
IF((_BA B_AND 'B11')==1)
_AMODE[4]=0
ELSE
_AMODE[4]=1000
ENDIF
ENDIF
_RC=ABS(_RFF)
IF($P_TOOLNO==0) GOTOF _FEHL0
IF($P_TOOL==0) GOTOF _FEHL3
_TYP=$P_ADT[1]
_WR=$P_TOOLR*_FAK1
_WB=$P_ADT[9]
_WB=_WB*_FAK1
IF(S_Y_TURN)
IF(_TYP<>525)AND(_TYP<>535) GOTOF _FEHL2
ELSE
IF(_TYP<>520)AND(_TYP<>521)AND(_TYP<>530)AND(_TYP<>531) GOTOF _FEHL2
ENDIF
IF(_WB<=0) GOTOF _FEHL1
IF(_WR<=0) GOTOF _FEHL6
_XX=$P_AXN2 _ZZ=$P_AXN1
IF(_F_Y_AXIS==1)
_YY=$P_AXN3
ENDIF
_SL_CHECK_A:
_SL=$P_ADT[2]
IF(NOT(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'H00200000')AND($P_CUTMOD))AND NOT(($P_CUTMODK==$PC_TRAFO_NAME)AND($P_CUTMODK<>""))AND(NOT S_Y_TURN))
_SL=_SLT[$P_ACTFRAME[_ZZ,MI],_SL]
_SL=_SLX[$P_ACTFRAME[_XX,MI],_SL]
ENDIF
IF(_F_SUBSP==0)AND(NOT((_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')))AND(_SL<>3)AND(_SL<>4) GOTOF _FEHL5
IF(_SL==4)
_OFFZ=_WB
ELSE
_OFFZ=0
ENDIF
_SL_CHECK_E:
IF(_MAN==0)
F_SP_RPT(0,1)
ELSE
_XS=$P_EP[_XX]*_FAK1 _ZS=$P_EP[_ZZ]*_FAK1
IF(_F_Y_AXIS==1)
_YS=$P_EP[_YY]*_FAK1
ENDIF
ENDIF
IF S_Y_TURN
_XS=_F_RPT[0]*_FAK2
_ZS=_Z0-_WB+_OFFZ
SBLON
IF($P_EP[_ZZ]*_FAK1<_F_RPT[1]*_FAK2)AND($P_EP[_YY]<>0)
N1840 G0 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
IF($P_EP[_ZZ]*_FAK1>_F_RPT[1]*_FAK2)
N1850 G0 AX[_XX]=_F_RPT[0]*_FAK2 AX[_ZZ]=_F_RPT[1]*_FAK2
ELSE
N1860 G0 AX[_XX]=_F_RPT[0]*_FAK2
ENDIF
N1870 G0 AX[_YY]=0
N1880 G0 AX[_ZZ]=_ZS
N1890 G0 G90 AX[_XX]=_XS AX[_ZZ]=_ZS
SBLOF
ELSE
IF(_MAN==0)
IF(_F_SUBSP==0)AND((_X2<=0)OR(_E_RT[0,0]==2))AND(_F_BAR_START<>1)
WRTPR("NPVSET(0,3)",1)
ENDIF
IF(_F_S_NR[2])
WRTPR("NPVSET("<<ABS(_Z0/_FAK2-_F_RTL[1])<<",7)",1)
_F_SUB_CUT=_Z0/_FAK2
_F_SUB_STA=_F_SUB_STA B_OR 'H0002'
ENDIF
IF(_F_SUBSP==1)
_E_TR[12,0]=_Z0-_WB
N1000 F_SUB_SP(-3)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N29 F_SP_BC(4,_BETA,_GAMA)
REPEAT _SL_CHECK_A _SL_CHECK_E
IF(_SL<>3)AND(_SL<>4) GOTOF _FEHL5
ENDIF
F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,7)
F_SP_RPT(0,1)
ENDIF
N30 F_SP_RP(0,_X0,_Z0-_WB+_OFFZ,0)
IF(_F_RELEAS==0)
SBLON
N35 G0 G90 AX[_XX]=_F_RP_ACT*_FAK2 AX[_ZZ]=_Z0-_WB+_OFFZ
SBLOF
ENDIF
ELSE
IF(_XS<_X0) GOTOF _FEHL8
SBLON
IF(_F_Y_AXIS==0)
N70 G90 G0 G40 AX[_XX]=_X0+_SC AX[_ZZ]=_Z0-_WB+_OFFZ
ELSE
N80 G90 G0 G40 AX[_XX]=_X0+_SC AX[_ZZ]=_Z0-_WB+_OFFZ AX[_YY]=0
ENDIF
SBLOF
ENDIF
ENDIF
IF($MCS_FUNCTION_MASK_TURN B_AND 'H02')AND(_ST B_AND 'H01')
CUST_TECHCYC(100)
ENDIF
IF(_MAN==0)
F_SP_TRA(3040)
ENDIF
IF(_F_SUBSP==0)
_VARI=0
ELSE
_VARI=1
ENDIF
_VARI=_VARI+10*_ST
_AMODE[5]=0
IF(_SA==2)AND(_SMAX>0)
_AMODE[5]=10000
ENDIF
_AMODE[0]=_AMODE[4]+_AMODE[5]
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
N50 CYCLE92(_X0*2,_Z0,_X1*2,_X2*2,_RC,_SC,_S,_SMAX,$P_SDIR[$P_MSNUM],$P_F,_FE,_SE,_XM*2,_VARI,,0,_AMODE[0])
ENDIF
IF(_F_SUBSP==1)AND(_F_AX_EXISTS[3])
_Z2=_F_S_AX[3]
IF($MA_FIXED_STOP_ALARM_MASK[_Z2] B_AND 'H0002')AND($SCS_TURN_PART_OFF_CTRL_DIST>0)AND($SCS_TURN_PART_OFF_CTRL_FEED>0)AND($SCS_TURN_PART_OFF_CTRL_FORCE>0)AND(NOT $P_ISTEST)AND(NOT $P_DRYRUN)AND(NOT $P_SEARCH)AND(NOT $AC_SERUPRO)AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100'))
SBLON
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N52 G1 G94 FA[_Z2]=$SCS_TURN_PART_OFF_CTRL_FEED FXS[_Z2]=1 FXST[_Z2]=$SCS_TURN_PART_OFF_CTRL_FORCE FXSW[_Z2]=$SCS_TURN_PART_OFF_CTRL_DIST*_FAK2 POS[_Z2]=IC($SCS_TURN_PART_OFF_CTRL_DIST*_FAK2)
ELSE
N53 G1 G94 F=$SCS_TURN_PART_OFF_CTRL_FEED FXS[_Z2]=1 FXST[_Z2]=$SCS_TURN_PART_OFF_CTRL_FORCE FXSW[_Z2]=$SCS_TURN_PART_OFF_CTRL_DIST*_FAK2 AX[_Z2]=IC($SCS_TURN_PART_OFF_CTRL_DIST*_FAK2)
ENDIF
SBLOF
IF($AA_FXS[_Z2]==1)
STOPRE
FXS[_Z2]=0
GOTOF _FEHL7
ENDIF
ENDIF
SBLON
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N55 G0 G90 POS[_Z2]=IC(2*_SC)
N56 G0 G90 AX[_ZZ]=IC(_SC*(1-2*$P_ACTFRAME[_ZZ,MI]))
ELSE
N57 G0 G90 AX[_ZZ]=IC(_SC*(1-2*$P_ACTFRAME[_ZZ,MI])) AX[_Z2]=IC(2*_SC)
ENDIF
SBLOF
ENDIF
IF(_SA==2)AND(_SMAX>0)
LIMS=$AC_SMAXVELO[_F_S_NR[_F_MASPI]]
ENDIF
IF(_MAN==0)
IF(_E_ST_PRG)
SBLON
N160 G0 G90 AX[_XX]=_X0+_SC
SBLOF
IF(_F_SUBSP==1)
N1100 F_SUB_SP(-4)
ENDIF
IF(_F_SUBSP==0)AND(_F_SUB_STA B_AND 'H0001')
_F_SUBSP=2
IF(_SC_CHAN_ST<>"")
_SC_NCK_NPV[5]=_F_SUBSP
ENDIF
ENDIF
ELSE
SBLON
N165 G0 G90 AX[_XX]=_F_RP_ACT*_FAK2
SBLOF
N166 F_SP_RP(101,,,1)
ENDIF
ELSE
SBLON
IF(_F_Y_AXIS==0)
N170 G90 G0 AX[_XX]=_XS AX[_ZZ]=_ZS
ELSE
N180 G90 G0 AX[_XX]=_XS AX[_ZZ]=_ZS AX[_YY]=_YS
ENDIF
SBLOF
ENDIF
G[29]=_P29
G[10]=_G60_64
_RET:
_E_S_LINE=0
_RETS:
_F_BAR_START=-1
_F_RELEAS=0
SBLON
RET
_FEHL0: STOPRE
N909200 SETAL(61009)
RET
_FEHL1: STOPRE
N909201 SETAL(61602)
RET
_FEHL2: STOPRE
N909202 SETAL(61212)
RET
_FEHL3: STOPRE
N909203 SETAL(61000)
RET
_FEHL4: STOPRE
N909204 SETAL(61609)
RET
_FEHL5: STOPRE
N909205 SETAL(61608)
RET
_FEHL6: STOPRE
N909206 SETAL(61007)
RET
_FEHL7:STOPRE
N909207 SETAL(61255)
RET
_FEHL8: STOPRE
N909208 SETAL(61284)
RET
_FEHL9:STOPRE
N909209 SETAL(61019," R/FS ")
RET
_FEHL10:STOPRE
N909210 SETAL(61022," R/FS ")
RET
_FEHL11: STOPRE
N909211 SETAL(61862)
RET
_FEHL12: STOPRE
N909212 SETAL(61863)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_PI_CIR_SPF
PROC F_PI_CIR(INT _OB,INT _BO,INT _IDD,STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,REAL _Z0,INT _Z0A,REAL _Z1,INT _Z1A,REAL _DZ,REAL _UZ,REAL _X0,INT _X0A,REAL _Y0,INT _Y0A,REAL _C0,REAL _D,REAL _UXY,REAL _D1,REAL _DXY,REAL _A0,INT _POS,REAL _FS,REAL _ZFS,INT _ZFSA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Circular spigot milling
DEF AXIS _AX1,_AX2,_AX3,_CC,_ZZ,_XXR,_YYR,_ZZR
DEF INT _VARI,_PMZ,_INI=1,_MAN,_TM1,_TM3,_TM4,_TM6,_TM8,_TM9,_P29,_I,_DIR,_AMODE,_MD_CLAMP,_DMODE,S_MD_BREAK,_MERKER_C=0
DEF REAL _FAK1,_FAK2,_SD,_SD1,_SD2,_SC,_RP,_RP_SD,_ZREF=0,_RTP,_XS,_YS,_ANG,_XST,_YST,_ZST
DEF FRAME _CYC_FR
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
_P29=$P_GG[29]
DIAMCYCOF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
IF($P_MC==0)
_F_INIT=1
ENDIF
ELSE
_SC=_E_SC*_FAK2
ENDIF
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
IF(_OB==0)OR(_OB==4)
IF(_OB==0)
IF(NOT _E_MC)
GOTOF _RET
ENDIF
IF(_INI)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD]
_DD=_E_TR[_IDD,1] _F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6] _BA=_E_TR[_IDD,7]
_Z0A=_E_TR[_IDD,9] _Z1A=_E_TR[_IDD,11] _DZ=_E_TR[_IDD,12]
_UZ=_E_TR[_IDD,13] _X0A=_E_TR[_IDD,15]
_Y0A=_E_TR[_IDD,17] _D=_E_TR[_IDD,18] _UXY=_E_TR[_IDD,19] _D1=_E_TR[_IDD,20]
_DXY=_E_TR[_IDD,21] _A0=_E_TR[_IDD,22] _C0=_E_TR[_IDD,23]
_FS=_E_TR[_IDD,24]
_INI=0
ENDIF
IF(_F_PS_REF<>_SC_NO_VAL)
_ZREF=_F_PS_REF*_FAK2
ENDIF
_Z0=_ZREF _Z1=_E_TR[_IDD,10] _ZFS=_E_TR[_IDD,25] _ZFSA=_E_TR[_IDD,26]
_TM1=_TMOD MOD 10 _TM3=TRUNC(_TMOD/100) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_CC=_F_S_AX[_F_MASPI]
_ANG=_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]-$P_ACTFRAME[_CC,TR]
ENDIF
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_ZREF)
ELSE
F_SP_TRA(2102,_ZREF)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_ANG)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
F_SP_TRA(2002+_TM1*10,,_ANG)
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2
_XS=$P_EP[_AX1]*_FAK1 _YS=$P_EP[_AX2]*_FAK1
_E_BO=_BO+(_E_BO B_AND 65535)
N10 F_TFS(,,,_F,_FAA,,,2,0)
_M_1:
IF(_Z1A<>90)
IF(_TM3==0)
_Z1=_Z0-ABS(_Z1)
ELSE
_Z1=_Z0+ABS(_Z1)
ENDIF
ENDIF
_VARI=_BA B_AND 'B111'
IF(_VARI==5)
IF(_ZFSA==91)
_Z1=_Z0-ABS(_ZFS)
ELSE
_Z1=_ZFS
_ZFS=ABS(_Z0-_ZFS)
ENDIF
_DZ=_ZFS _DXY=_FS _UZ=0 _UXY=_FS
_AMODE=102
ENDIF
IF(_BA B_AND 'B10000000000')
_VARI=_VARI+100000
ENDIF
IF(_Z1>_Z0)
_PMZ=1
ELSE
_PMZ=-1
ENDIF
IF((_TM3==0)AND(_PMZ==1))OR((_TM3==1)AND(_PMZ==-1)) GOTOF _FEHL7
F_SP_ED(_SD)
_RTP=_ZREF-(_SC+_SD)*_PMZ
_M_2:
ELSE
_TM1=_TMOD MOD 10 _MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10 _TM4=TRUNC(_TMOD/1000) MOD 10
_TM8=TRUNC(_TMOD/10000000) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
_E_BO=0
IF(_MAN==0)
N14 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
ELSE
_F_INIT=2
_F_RELEAS=1
N16 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
ENDIF
IF(_MAN==0)
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2
ENDIF
_ZREF=_Z0
REPEAT _M_1 _M_2
IF(_MAN==0)
_RP_SD=_F_RP_ACT*_FAK2-_SD*_PMZ
ENDIF
_CYC_FR=$P_CYCFRAME
IF(_TM1<2)
IF(_TM1==0)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=2*_Z0*$PI*_X0/360 _YS=_Y0
ENDIF
ELSE
_XS=_X0 _YS=_Y0
ENDIF
ELSE
IF(_TM1==2)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC+_SD) GOTOF _FEHL14
ENDIF
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
IF(_TM1==3)
_ZZ=$P_AXN3
_C0=((_C0 MOD 360)+360)MOD 360
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
_ANG=_C0
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_ZREF)
ELSE
F_SP_TRA(2102,_ZREF)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_ANG)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
F_SP_TRA(2002+_TM1*10,,_ANG)
ENDIF
ENDIF
_DMODE=0
IF(_TM8==1)
_DMODE=_DMODE+10000
ENDIF
N95 CYCLE77(_RTP,_ZREF,_SC,_Z1,,_D,_XS,_YS,_DZ,_UXY,_UZ,_F,_F,_E_DIR,_VARI,_D1,_FS,_ZFS,200,_DMODE,_AMODE)
$P_CYCFRAME=_CYC_FR
F_SP_TRA(0)
IF(_TM1<2)
IF(_TM1==0)
IF(_MAN==0)
F_SP_RP(0,_RP,_YS,0)
ELSE
F_SP_TRA(2002,_Z0)
_XXR=$P_AXN3 _ZZR=$P_AXN2
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN1
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM9==1)
F_SP_TRA(103102,_Z0)
ELSE
F_SP_TRA(3102,_Z0)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_C0)
IF(_MAN==0)
F_SP_RP(0,_RP,_YS,0,_XS)
ELSE
_YYR=$P_AXN1 _ZZR=$P_AXN2 _XXR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N45 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
ELSE
IF(_TM1==2)
IF(_MAN==0)
F_SP_RP(0,_SC_POS[3]*_FAK1,_RP,0)
ELSE
F_SP_TRA(2022)
_XXR=$P_AXN1 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN2
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM9==1)
F_SP_TRA(103122)
ELSE
F_SP_TRA(3122)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_MAN==0)
F_SP_RP(9,_SC_POS[0]*_FAK1,_RP,0,_SC_POS[1]*_FAK1)
ELSE
_XXR=$P_AXN1 _YYR=$P_AXN2 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N85 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2 _AX3=$P_AXN3
IF(_MAN==0)
IF(_F_RELEAS==0)
SBLON
N70 G90 G0 G40 AX[_AX1]=_SC_POS[0]*_FAK1 AX[_AX2]=_SC_POS[1]*_FAK1 AX[_AX3]=_RP_SD
SBLOF
ENDIF
ELSE
SBLON
N90 G90 G0 G40 AX[_AX1]=_SC_POS[0]*_FAK1 AX[_AX2]=_SC_POS[1]*_FAK1 AX[_AX3]=_RTP
SBLOF
ENDIF
ENDIF
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
IF(_TM1==0)OR(_TM1==2)
IF(_TM9==1)
_MERKER_C=4
ELSE
_MERKER_C=0
ENDIF
ELSE
IF(_TM6==2)
_MERKER_C=2
ELSE
_MERKER_C=0
ENDIF
ENDIF
IF(_MERKER_C==0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_MERKER_C==1)
_VARI=_VARI+100
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==2)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>1)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
IF(_MERKER_C==3)
_VARI=_VARI+300
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==4)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N100 CYCLE77(_RTP,_ZREF,_SC,_Z1,,_D,_XS,_YS,_DZ,_UXY,_UZ,_F,_F,_E_DIR,_VARI,_D1,_FS,_ZFS,100,_DMODE,_AMODE)
IF(_MERKER_C==1)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
IF(_MERKER_C==3)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_OB==4)AND(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
IF(_MAN<>0)
IF(_TM1>=2)
IF(_TM1==2)
F_SP_TRA(2022)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N160 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N170 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ELSE
IF(_TM1==0)
F_SP_TRA(2012,_ZREF,_C0)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N180 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N190 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ENDIF
ENDIF
ELSE
IF(_OB==3)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD] _DD=_E_TR[_IDD,1]
_F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4] _SA=_E_TR[_IDD,5]
_TMOD=_E_TR[_IDD,6]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N200 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
_F_RELEAS=0
ELSE
IF(_E_IR<_E_MAX)
_E_TS1[_E_IR]=_T _E_TS2[_E_IR]=_TF
_E_TR[_E_IR,0]=SET(14,_DD,_F,_FAA,_S,_SA,_TMOD,_BA,_Z0,_Z0A,_Z1,_Z1A,_DZ,_UZ,_X0,_X0A,_Y0,_Y0A,_D,_UXY,_D1,_DXY,_A0,_C0,_FS,_ZFS,_ZFSA)
_E_IR=_E_IR+1
IF(_POS>=0)
_E_POS=_POS
ENDIF
ELSE
GOTOF _FEHL2
ENDIF
IF(_OB==2)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
G[29]=_P29
_E_S_LINE=0
_RETS:
IF(_E_POS==0)
_F_RELEAS=0
ENDIF
SBLON
RET
_FEHL2: STOPRE
N907702 SETAL(61200)
RET
_FEHL7: STOPRE
N907707 SETAL(61242)
RET
_FEHL13: STOPRE
N907713 SETAL(61284)
RET
_FEHL14: STOPRE
N907714 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_PI_REC_SPF
PROC F_PI_REC(INT _OB,INT _BO,INT _IDD,STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,REAL _Z0,INT _Z0A,REAL _Z1,INT _Z1A,REAL _DZ,REAL _UZ,INT _REF,REAL _X0,INT _X0A,REAL _Y0,INT _Y0A,REAL _C0,REAL _L,REAL _W,REAL _R,REAL _A0,REAL _DXY,REAL _UXY,REAL _L1,REAL _W1,INT _POS,REAL _FS,REAL _ZFS,INT _ZFSA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Rectangular spigot milling
DEF AXIS _AX1,_AX2,_AX3,_CC,_ZZ,_XXR,_YYR,_ZZR
DEF INT _BA1,_PMZ,_INI=1,_MAN,_TM1,_TM3,_TM4,_TM6,_TM8,_TM9,_P29,_I,_DIR,_AMODE3,_MD_CLAMP,_DMODE,S_MD_BREAK,_MERKER_C=0,_VARI
DEF REAL _FAK1,_FAK2,_RP,_RP_SD,_SC,_SD,_SD1,_SD2,_ZREF=0,_RTP,_XS,_YS,_ANG,_XST,_YST,_ZST
DEF FRAME _CYC_FR
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
_P29=$P_GG[29]
DIAMCYCOF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
IF($P_MC==0)
_F_INIT=1
ENDIF
ELSE
_SC=_E_SC*_FAK2
ENDIF
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
IF(_OB==0)OR(_OB==4)
IF(_OB==0)
IF(NOT _E_MC)
GOTOF _RET
ENDIF
IF(_INI)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD]
_DD=_E_TR[_IDD,1] _F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6] _BA=_E_TR[_IDD,7]
_Z0A=_E_TR[_IDD,9] _Z1A=_E_TR[_IDD,11] _DZ=_E_TR[_IDD,12]
_UZ=_E_TR[_IDD,13] _REF=_E_TR[_IDD,14] _X0A=_E_TR[_IDD,16]
_Y0A=_E_TR[_IDD,18]
_R=_E_TR[_IDD,21] _A0=_E_TR[_IDD,22] _DXY=_E_TR[_IDD,23] _UXY=_E_TR[_IDD,24]
_L1=_E_TR[_IDD,25] _W1=_E_TR[_IDD,26] _C0=_E_TR[_IDD,27]
_FS=_E_TR[_IDD,28]
_INI=0
ENDIF
IF(_F_PS_REF<>_SC_NO_VAL)
_ZREF=_F_PS_REF*_FAK2
ENDIF
_Z0=_ZREF _Z1=_E_TR[_IDD,10] _L=_E_TR[_IDD,19] _W=_E_TR[_IDD,20]
_ZFS=_E_TR[_IDD,29] _ZFSA=_E_TR[_IDD,30]
_TM1=_TMOD MOD 10 _TM3=TRUNC(_TMOD/100) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_CC=_F_S_AX[_F_MASPI]
_ANG=_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]-$P_ACTFRAME[_CC,TR]
ENDIF
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_ZREF)
ELSE
F_SP_TRA(2102,_ZREF)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_ANG)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
F_SP_TRA(2002+_TM1*10,,_ANG)
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2
_XS=$P_EP[_AX1]*_FAK1 _YS=$P_EP[_AX2]*_FAK1
_E_BO=_BO+(_E_BO B_AND 65535)
N10 F_TFS(,,,_F,_FAA,,,2,0)
_M_1:
IF(_Z1A<>90)
IF(_TM3==0)
_Z1=_Z0-ABS(_Z1)
ELSE
_Z1=_Z0+ABS(_Z1)
ENDIF
ENDIF
_BA1=_BA B_AND 'B111'
IF(_BA1==5)
IF(_ZFSA==91)
_Z1=_Z0-ABS(_ZFS)
ELSE
_Z1=_ZFS
_ZFS=ABS(_Z0-_ZFS)
ENDIF
_DZ=_ZFS _DXY=_FS _UZ=0 _UXY=_FS
_AMODE3=100
ENDIF
_VARI=_BA1
IF(_BA B_AND 'B10000000000')
_VARI=_VARI+100000
ENDIF
IF(_Z1>_Z0)
_PMZ=1
ELSE
_PMZ=-1
ENDIF
IF((_TM3==0)AND(_PMZ==1))OR((_TM3==1)AND(_PMZ==-1)) GOTOF _FEHL7
F_SP_ED(_SD)
_RTP=_ZREF-(_SC+_SD)*_PMZ
IF(_L<=0)OR(_W<=0) GOTOF _FEHL3
IF(_R<0)OR(_W<2*_R)OR(_L<2*_R) GOTOF _FEHL3
_M_2:
ELSE
_TM1=_TMOD MOD 10 _MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10 _TM4=TRUNC(_TMOD/1000) MOD 10
_TM8=TRUNC(_TMOD/10000000) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
_E_BO=0
IF(_MAN==0)
N14 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
ELSE
_F_INIT=2
_F_RELEAS=1
N16 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
ENDIF
IF(_MAN==0)
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2
ENDIF
_ZREF=_Z0
REPEAT _M_1 _M_2
IF(_MAN==0)
_RP_SD=_F_RP_ACT*_FAK2-_SD*_PMZ
ENDIF
_CYC_FR=$P_CYCFRAME
IF(_TM1<2)
IF(_TM1==0)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=2*_Z0*$PI*_X0/360 _YS=_Y0
ENDIF
ELSE
_XS=_X0 _YS=_Y0
ENDIF
ELSE
IF(_TM1==2)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC+_SD) GOTOF _FEHL14
ENDIF
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
IF(_TM1==3)
_ZZ=$P_AXN3
_C0=((_C0 MOD 360)+360)MOD 360
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
_ANG=_C0
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_ZREF)
ELSE
F_SP_TRA(2102,_ZREF)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_ANG)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
F_SP_TRA(2002+_TM1*10,,_ANG)
ENDIF
ENDIF
_DMODE=0
IF(_TM8==1)
_DMODE=_DMODE+10000
ENDIF
N95 CYCLE76(_RTP,_ZREF,_SC,_Z1,,_L,_W,_R,_XS,_YS,_A0,_DZ,_UXY,_UZ,_F,_F,_E_DIR,_VARI,_L1,_W1,_FS,_ZFS,1200,_DMODE,2+_AMODE3)
$P_CYCFRAME=_CYC_FR
F_SP_TRA(0)
IF(_TM1<2)
IF(_TM1==0)
IF(_MAN==0)
F_SP_RP(0,_RP,_YS,0)
ELSE
F_SP_TRA(2002,_Z0)
_XXR=$P_AXN3 _ZZR=$P_AXN2
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN1
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM9==1)
F_SP_TRA(103102,_Z0)
ELSE
F_SP_TRA(3102,_Z0)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_C0)
IF(_MAN==0)
F_SP_RP(0,_RP,_SC_POS[1]*_FAK1,0,_SC_POS[0]*_FAK1)
ELSE
_YYR=$P_AXN1 _ZZR=$P_AXN2 _XXR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
ELSE
IF(_TM1==2)
IF(_MAN==0)
F_SP_RP(0,_SC_POS[3]*_FAK1,_RP,0)
ELSE
F_SP_TRA(2022)
_XXR=$P_AXN1 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN2
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM9==1)
F_SP_TRA(103122)
ELSE
F_SP_TRA(3122)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_MAN==0)
F_SP_RP(9,_SC_POS[0]*_FAK1,_RP,0,_SC_POS[1]*_FAK1)
ELSE
_XXR=$P_AXN1 _YYR=$P_AXN2 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N85 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2 _AX3=$P_AXN3
IF(_MAN==0)
IF(_F_RELEAS==0)
SBLON
N70 G90 G0 G40 AX[_AX1]=_SC_POS[0]*_FAK1 AX[_AX2]=_SC_POS[1]*_FAK1 AX[_AX3]=_RP_SD
SBLOF
ENDIF
ELSE
SBLON
N90 G90 G0 G40 AX[_AX1]=_SC_POS[0]*_FAK1 AX[_AX2]=_SC_POS[1]*_FAK1 AX[_AX3]=_RTP
SBLOF
ENDIF
ENDIF
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
IF(_TM1==0)OR(_TM1==2)
IF(_TM9==1)
_MERKER_C=4
ELSE
_MERKER_C=0
ENDIF
ELSE
IF(_TM6==2)
_MERKER_C=2
ELSE
_MERKER_C=0
ENDIF
ENDIF
IF(_MERKER_C==0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_MERKER_C==1)
_VARI=_VARI+100
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==2)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>1)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
IF(_MERKER_C==3)
_VARI=_VARI+300
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==4)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N100 CYCLE76(_RTP,_ZREF,_SC,_Z1,,_L,_W,_R,_XS,_YS,_A0,_DZ,_UXY,_UZ,_F,_F,_E_DIR,_VARI,_L1,_W1,_FS,_ZFS,1100,_DMODE,2+_AMODE3)
IF(_MERKER_C==1)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
IF(_MERKER_C==3)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_OB==4)AND(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
IF(_MAN<>0)
IF(_TM1>=2)
IF(_TM1==2)
F_SP_TRA(2022)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N160 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N170 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ELSE
IF(_TM1==0)
F_SP_TRA(2012,_ZREF,_C0)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N180 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N190 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ENDIF
ENDIF
ELSE
IF(_OB==3)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD] _DD=_E_TR[_IDD,1]
_F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4] _SA=_E_TR[_IDD,5]
_TMOD=_E_TR[_IDD,6]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N200 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
_F_RELEAS=0
ELSE
IF(_E_IR<_E_MAX)
_E_TS1[_E_IR]=_T _E_TS2[_E_IR]=_TF
_E_TR[_E_IR,0]=SET(13,_DD,_F,_FAA,_S,_SA,_TMOD,_BA,_Z0,_Z0A,_Z1,_Z1A,_DZ,_UZ,_REF,_X0,_X0A,_Y0,_Y0A,_L,_W,_R,_A0,_DXY,_UXY,_L1,_W1,_C0,_FS,_ZFS,_ZFSA)
_E_IR=_E_IR+1
IF(_POS>=0)
_E_POS=_POS
ENDIF
ELSE
GOTOF _FEHL2
ENDIF
IF(_OB==2)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
G[29]=_P29
_E_S_LINE=0
_RETS:
IF(_E_POS==0)
_F_RELEAS=0
ENDIF
SBLON
RET
_FEHL2: STOPRE
N907602 SETAL(61200)
RET
_FEHL3: STOPRE
N907603 SETAL(61605)
RET
_FEHL7: STOPRE
N907607 SETAL(61242)
RET
_FEHL13: STOPRE
N907613 SETAL(61284)
RET
_FEHL14: STOPRE
N907614 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_PO_CIR_SPF
PROC F_PO_CIR(INT _OB,INT _BO,INT _IDD,STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,REAL _FZ,INT _FZA,REAL _FZR,REAL __Z0,INT _Z0A,REAL __Z1,INT _Z1A,REAL _DZ,REAL _X0,INT _X0A,REAL _Y0,INT _Y0A,REAL _C0,REAL _D,REAL _UXY,REAL _UZ,REAL _D1,REAL _AZ,REAL _DXY,INT _POS,INT _DXYA,REAL _FS,REAL __ZFS,INT _ZFSA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Circular Pocket
DEF AXIS _AX1,_AX2,_AX3,_CC,_ZZ,_XXR,_YYR,_ZZR
DEF INT _BA1,_BA10,_BA1000,_PMZ,_VARI,_INI=1,_MAN,_TM1,_TM3,_TM4,_TM6,_TM8,_TM9,_P29,_UMODE=0,_MERKER_C=0,_MD_CLAMP,_I,_DIR,_GMODE,_DMODE,_AMODE,S_MD_BREAK
DEF REAL _FAK1,_FAK2,_SD,_SD1,_SD2,_SC,_RP,_RP_SD,_RTP,_ZREF,_XS,_YS,_ANG,_XST,_YST,_ZST,_Z0,_Z1,_ZFS
DEF FRAME _CYC_FR
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
_P29=$P_GG[29]
DIAMCYCOF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
IF($P_MC==0)
_F_INIT=1
ENDIF
ELSE
_SC=_E_SC*_FAK2
ENDIF
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
IF(_OB==0)OR(_OB==4)
_DMODE=0
IF(_OB==0)
IF(NOT _E_MC)
GOTOF _RET
ENDIF
IF(_INI)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD]
_DD=_E_TR[_IDD,1] _F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6] _BA=_E_TR[_IDD,7] _FZ=_E_TR[_IDD,8]
_FZA=_E_TR[_IDD,9] _FZR=_E_TR[_IDD,10] _Z0A=_E_TR[_IDD,12]
_Z1A=_E_TR[_IDD,14] _DZ=_E_TR[_IDD,15]
_X0A=_E_TR[_IDD,17] _Y0A=_E_TR[_IDD,19] _D=_E_TR[_IDD,20]
_UXY=_E_TR[_IDD,21] _UZ=_E_TR[_IDD,22] _D1=_E_TR[_IDD,23] _AZ=_E_TR[_IDD,24]
_DXYA=_E_TR[_IDD,26] _C0=_E_TR[_IDD,27]
_FS=_E_TR[_IDD,28]
_INI=0
ENDIF
IF(_F_PS_REF<>_SC_NO_VAL)
_ZREF=_F_PS_REF*_FAK2
ENDIF
_Z0=_ZREF _Z1=_E_TR[_IDD,13] _DXY=_E_TR[_IDD,25] _ZFS=_E_TR[_IDD,29] _ZFSA=_E_TR[_IDD,30]
_TM1=_TMOD MOD 10 _TM3=TRUNC(_TMOD/100) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_CC=_F_S_AX[_F_MASPI]
_ANG=_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]-$P_ACTFRAME[_CC,TR]
ENDIF
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_ZREF)
ELSE
F_SP_TRA(2102,_ZREF)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_ANG)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
F_SP_TRA(2002+_TM1*10,,_ANG)
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2
_XS=$P_EP[_AX1]*_FAK1 _YS=$P_EP[_AX2]*_FAK1
_E_BO=_BO+(_E_BO B_AND 65535)
N10 F_TFS(,,,_F,_FAA,,,2,0)
_M_1:
IF(_DXYA==1)
_DXY=_DXY/100*(2*$P_TOOLR*_FAK1)
ENDIF
IF(_Z1A<>90)
IF(_TM3==0)
_Z1=_Z0-ABS(_Z1)
ELSE
_Z1=_Z0+ABS(_Z1)
ENDIF
ENDIF
_BA1=_BA B_AND 'B111' _BA1000=(_BA B_AND 'B1010000000')/'B10000000'
IF(_BA1<1)OR(_BA1>5) GOTOF _FEHL3
_AMODE=0
IF(_BA1==5)
IF(_ZFSA==91)
_Z1=_Z0-ABS(_ZFS)
ELSE
_Z1=_ZFS
_ZFS=ABS(_Z0-_ZFS)
ENDIF
_AMODE=100
ENDIF
IF(_Z1>_Z0)
_PMZ=1
ELSE
_PMZ=-1
ENDIF
IF((_TM3==0)AND(_PMZ==1))OR((_TM3==1)AND(_PMZ==-1)) GOTOF _FEHL12
IF(_BA1==1)
IF(_DXY>$P_TOOLR*_FAK1*2) GOTOF _FEHL7
IF(_UXY>=_D/2) GOTOF _FEHL10
ENDIF
IF(_BA B_AND 'B01000000'==0)
_GMODE=10001
ELSE
_GMODE=20001
ENDIF
IF(_BA B_AND 'B01000000'==0)OR(_BA1<>1)
_D1=0 _AZ=0
ELSE
IF($P_TOOLR*_FAK1*2>_D1) GOTOF _FEHL9
IF(_AZ<=0) GOTOF _FEHL11
IF(_UXY>(_D-_D1)/2) GOTOF _FEHL10
ENDIF
IF(_BA1<>5)
IF(_UXY>$P_TOOLR*_FAK1*2) GOTOF _FEHL10
ENDIF
IF(_BA1000)
IF(_BA1000>1)
_BA1000=_BA1000-2
ENDIF
IF((_BA1000==1)AND(_FZA==2))
_FZA=1
ENDIF
ENDIF
IF(_FZA<>2)OR((_BA B_AND 'B111')==5)
_BA10=1
ELSE
_BA10=2
ENDIF
_VARI=_BA1+_BA10*10+_BA1000*1000
IF(_BA1<>5)
IF(_DZ<=0) GOTOF _FEHL5
ENDIF
F_SP_ED(_SD)
_RTP=_ZREF-(_SC+_SD)*_PMZ
IF($P_TOOLR<0) GOTOF _FEHL8
IF(_FZA==2) AND NOT ((_BA B_AND 'B111')==5)
IF(_FZ<=0) GOTOF _FEHL1
IF(_FZR<=0) GOTOF _FEHL2
IF(_FZ>_DZ)
_FZ=_DZ
ENDIF
ENDIF
_M_2:
ELSE
_TM1=_TMOD MOD 10 _MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10 _TM4=TRUNC(_TMOD/1000) MOD 10
_TM8=TRUNC(_TMOD/10000000) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
_Z0=__Z0 _Z1=__Z1 _ZFS=__ZFS
IF(_TM1==0)
IF((_BA B_AND 'B100000000')<>'B000000000')
_Z0=_Z0/2
IF(_Z1A==90)
_Z1=_Z1/2
ENDIF
IF(_ZFSA==90)
_ZFS=_ZFS/2
ENDIF
ENDIF
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
_E_BO=0
IF(_MAN==0)
N14 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'B1')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
ELSE
_F_INIT=2
_F_RELEAS=1
N16 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
ENDIF
IF(_MAN==0)
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2
ENDIF
_ZREF=_Z0
REPEAT _M_1 _M_2
IF(_MAN==0)
_RP_SD=_F_RP_ACT*_FAK2-_SD*_PMZ
ENDIF
_CYC_FR=$P_CYCFRAME
IF(_TM1<2)
IF(_TM1==0)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=2*_Z0*$PI*_X0/360 _YS=_Y0
ENDIF
ELSE
_XS=_X0 _YS=_Y0
ENDIF
ELSE
IF(_TM1==2)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC+_SD) GOTOF _FEHL14
ENDIF
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
IF(_TM1==3)
_ZZ=$P_AXN3
_C0=((_C0 MOD 360)+360)MOD 360
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
_ANG=_C0
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_ZREF)
ELSE
F_SP_TRA(2102,_ZREF)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_ANG)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
F_SP_TRA(2002+_TM1*10,,_ANG)
ENDIF
ENDIF
IF(_TM8==1)
_DMODE=10000
ENDIF
N98 POCKET4(_RTP,_Z0,_SC,_Z1,_D/2,_XS,_YS,_DZ,_UXY,_UZ,_F,_FZ,_E_DIR,_VARI,_DXY,_D1/2,_AZ,_FZR,_FZ,0,_FS,_ZFS,_GMODE+200,_DMODE,_AMODE)
$P_CYCFRAME=_CYC_FR
F_SP_TRA(0)
IF(_TM1<2)
IF(_TM1==0)
IF(_MAN==0)
F_SP_RP(0,_RP,_YS,0)
ELSE
F_SP_TRA(2002,_Z0)
_XXR=$P_AXN3 _ZZR=$P_AXN2
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN1
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM9==1)
F_SP_TRA(103102,_Z0)
ELSE
F_SP_TRA(3102,_Z0)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_C0)
IF(_MAN==0)
F_SP_RP(0,_RP,_YS,0,_XS)
ELSE
_YYR=$P_AXN1 _ZZR=$P_AXN2 _XXR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N45 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
ELSE
IF(_TM1==2)
IF(_MAN==0)
F_SP_RP(0,_SC_POS[3]*_FAK1,_RP,0)
ELSE
F_SP_TRA(2022)
_XXR=$P_AXN1 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN2
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM9==1)
F_SP_TRA(103122)
ELSE
F_SP_TRA(3122)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_MAN==0)
F_SP_RP(9,_SC_POS[0]*_FAK1,_RP,0,_SC_POS[1]*_FAK1)
ELSE
_XXR=$P_AXN1 _YYR=$P_AXN2 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N85 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2 _AX3=$P_AXN3
IF(_MAN==0)
IF(_F_RELEAS==0)
SBLON
N90 G90 G0 G40 AX[_AX1]=_SC_POS[0]*_FAK1 AX[_AX2]=_SC_POS[1]*_FAK1 AX[_AX3]=_RP_SD
SBLOF
ENDIF
ELSE
SBLON
N95 G90 G0 G40 AX[_AX1]=_SC_POS[0]*_FAK1 AX[_AX2]=_SC_POS[1]*_FAK1 AX[_AX3]=_RTP
SBLOF
ENDIF
ENDIF
IF(_MAN==0)
N100 F_TFS("","",_DD,_F,_FAA,_S,_SA,2,0)
ELSE
N102 F_TFS("","",_DD,_F,_FAA,_S,_SA,2,8)
ENDIF
IF($P_F_TYPE==11)OR($P_F_TYPE==33)
IF(_FZA==0)
_DMODE=_DMODE+10
ELSE
_DMODE=_DMODE+20
ENDIF
ELSE
IF(_FZA==0)
_DMODE=_DMODE+20
ELSE
_DMODE=_DMODE+10
ENDIF
ENDIF
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
IF(_TM1==0)OR(_TM1==2)
IF(_TM6==2)AND(_BA10==1)AND(_BA1==1)
IF(_TM9==1)
_MERKER_C=3
ELSE
_MERKER_C=1
ENDIF
ELSE
IF(_TM9==1)
_MERKER_C=4
ELSE
_MERKER_C=0
ENDIF
ENDIF
ELSE
IF(_TM6==2)
_MERKER_C=2
ELSE
_MERKER_C=0
ENDIF
ENDIF
IF(_MERKER_C==0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_MERKER_C==1)
_VARI=_VARI+100
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==2)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>1)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
IF(_MERKER_C==3)
_VARI=_VARI+300
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==4)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N150 POCKET4(_RTP,_ZREF,_SC,_Z1,_D/2,_XS,_YS,_DZ,_UXY,_UZ,_F,_FZ,_E_DIR,_VARI,_DXY,_D1/2,_AZ,_FZR,_FZ,_UMODE,_FS,_ZFS,_GMODE,_DMODE,_AMODE)
IF(_MERKER_C==1)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
IF(_MERKER_C==3)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_OB==4)AND(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
IF(_MAN<>0)
IF(_TM1>=2)
IF(_TM1==2)
F_SP_TRA(2022)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N160 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N170 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ELSE
IF(_TM1==0)
F_SP_TRA(2012,_ZREF,_C0)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N180 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N190 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ENDIF
ENDIF
ELSE
IF(_OB==3)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD] _DD=_E_TR[_IDD,1]
_F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4] _SA=_E_TR[_IDD,5]
_TMOD=_E_TR[_IDD,6]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N200 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'B1')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
_F_RELEAS=0
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2 _ZREF=_Z0
ELSE
IF(_E_IR<_E_MAX)
_Z0=__Z0 _Z1=__Z1 _ZFS=__ZFS
IF(_TMOD MOD 10 ==0)
IF((_BA B_AND 'B100000000')<>'B000000000')
_Z0=_Z0/2
IF(_Z1A==90)
_Z1=_Z1/2
ENDIF
IF(_ZFSA==90)
_ZFS=_ZFS/2
ENDIF
ENDIF
ENDIF
_E_TS1[_E_IR]=_T _E_TS2[_E_IR]=_TF
_E_TR[_E_IR,0]=SET(12,_DD,_F,_FAA,_S,_SA,_TMOD,_BA,_FZ,_FZA,_FZR,_Z0,_Z0A,_Z1,_Z1A,_DZ,_X0,_X0A,_Y0,_Y0A,_D,_UXY,_UZ,_D1,_AZ,_DXY,_DXYA,_C0,_FS,_ZFS,_ZFSA)
_E_IR=_E_IR+1
IF(_POS>=0)
_E_POS=_POS
ENDIF
ELSE
GOTOF _FEHL4
ENDIF
IF(_OB==2)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
G[29]=_P29
_E_S_LINE=0
_RETS:
IF(_E_POS==0)
_F_RELEAS=0
ENDIF
SBLON
RET
_FEHL1: STOPRE
N930801 SETAL(61214)
RET
_FEHL2: STOPRE
N930802 SETAL(61213)
RET
_FEHL3: STOPRE
N930803 SETAL(61002)
RET
_FEHL4: STOPRE
N930804 SETAL(61200)
RET
_FEHL5: STOPRE
N930805 SETAL(61610)
RET
_FEHL7: STOPRE
N930807 SETAL(61222)
RET
_FEHL8: STOPRE
N930808 SETAL(61112)
RET
_FEHL9: STOPRE
N930809 SETAL(61006)
RET
_FEHL10: STOPRE
N930810 SETAL(61010)
RET
_FEHL11: STOPRE
N930811 SETAL(61215)
RET
_FEHL12: STOPRE
N930812 SETAL(61242)
RET
_FEHL13: STOPRE
N930813 SETAL(61284)
RET
_FEHL14: STOPRE
N930814 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_PO_REC_SPF
PROC F_PO_REC(INT _OB,INT _BO,INT _IDD,STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,REAL _FZ,INT _FZA,REAL _FZR,REAL __Z0,INT _Z0A,REAL __Z1,INT _Z1A,REAL _DZ,INT _REF,REAL _X0,INT _X0A,REAL _Y0,INT _Y0A,REAL _C0,REAL _L,REAL _W,REAL _R,REAL _A0,REAL _UXY,REAL _UZ,REAL _L1,REAL _W1,REAL _AZ,REAL _DXY,INT _POS,INT _DXYA,REAL _FS,REAL __ZFS,INT _ZFSA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Rectangular pocket
DEF AXIS _AX1,_AX2,_AX3,_CC,_ZZ,_XXR,_YYR,_ZZR
DEF INT _BA1,_BA10,_PMZ,_VARI,_INI=1,_P29,_MAN,_TM1,_TM3,_TM4,_TM6,_TM8,_TM9,_UMODE=0,_MERKER_C=0,_I,_DIR,_GMODE,_DMODE,_AMODE,_MD_CLAMP,S_MD_BREAK
DEF REAL _FAK1,_FAK2,_DP1,_RAD1,_SD,_SD1,_SD2,_SC,_RP,_RP_SD,_ZREF,_RTP,_XS,_YS,_ANG,_XST,_YST,_ZST,_Z0,_Z1,_ZFS
DEF FRAME _CYC_FR
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
_P29=$P_GG[29]
DIAMCYCOF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
IF($P_MC==0)
_F_INIT=1
ENDIF
ELSE
_SC=_E_SC*_FAK2
ENDIF
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
IF(_OB==0)OR(_OB==4)
_DMODE=0
IF(_OB==0)
IF(NOT _E_MC)
GOTOF _RET
ENDIF
IF(_INI)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD]
_DD=_E_TR[_IDD,1] _F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6] _BA=_E_TR[_IDD,7] _FZ=_E_TR[_IDD,8]
_FZA=_E_TR[_IDD,9] _FZR=_E_TR[_IDD,10] _Z0A=_E_TR[_IDD,12]
_Z1A=_E_TR[_IDD,14] _DZ=_E_TR[_IDD,15] _REF=_E_TR[_IDD,16]
_X0A=_E_TR[_IDD,18] _Y0A=_E_TR[_IDD,20]
_L=_E_TR[_IDD,21] _W=_E_TR[_IDD,22] _R=_E_TR[_IDD,23] _A0=_E_TR[_IDD,24]
_UXY=_E_TR[_IDD,25] _UZ=_E_TR[_IDD,26] _L1=_E_TR[_IDD,27] _W1=_E_TR[_IDD,28]
_AZ=_E_TR[_IDD,29] _DXYA=_E_TR[_IDD,31] _C0=_E_TR[_IDD,32]
_FS=_E_TR[_IDD,33]
_INI=0
ENDIF
IF(_F_PS_REF<>_SC_NO_VAL)
_ZREF=_F_PS_REF*_FAK2
ENDIF
_Z0=_ZREF _Z1=_E_TR[_IDD,13] _DXY=_E_TR[_IDD,30] _ZFS=_E_TR[_IDD,34] _ZFSA=_E_TR[_IDD,35]
_TM1=_TMOD MOD 10 _TM3=TRUNC(_TMOD/100) MOD 10
_TM4=TRUNC(_TMOD/1000) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_CC=_F_S_AX[_F_MASPI]
_ANG=_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]-$P_ACTFRAME[_CC,TR]
ENDIF
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_ZREF)
ELSE
F_SP_TRA(2102,_ZREF)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_ANG)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
F_SP_TRA(2002+_TM1*10,,_ANG)
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2
_XS=$P_EP[_AX1]*_FAK1 _YS=$P_EP[_AX2]*_FAK1
_E_BO=_BO+(_E_BO B_AND 65535)
N10 F_TFS(,,,_F,_FAA,,,2,0)
_M_1:
IF(_DXYA==1)
_DXY=_DXY/100*(2*$P_TOOLR*_FAK1)
ENDIF
IF(_Z1A<>90)
IF(_TM3==0)
_Z1=_Z0-ABS(_Z1)
ELSE
_Z1=_Z0+ABS(_Z1)
ENDIF
ENDIF
_BA1=_BA B_AND 'B111'
IF(_BA1<1)OR(_BA1>5) GOTOF _FEHL3
_AMODE=0
IF(_BA1==5)
IF(_ZFSA==91)
_Z1=_Z0-ABS(_ZFS)
ELSE
_Z1=_ZFS
_ZFS=ABS(_Z0-_ZFS)
ENDIF
_AMODE=100
ENDIF
IF(_Z1>_Z0)
_PMZ=1
ELSE
_PMZ=-1
ENDIF
IF((_TM3==0)AND(_PMZ==1))OR((_TM3==1)AND(_PMZ==-1)) GOTOF _FEHL12
IF(_BA1==1)
IF(_DXY>$P_TOOLR*_FAK1*2) GOTOF _FEHL7
ENDIF
IF(_BA B_AND 'B01000000'==0)
_GMODE=10001
ELSE
_GMODE=20001
ENDIF
_GMODE=_GMODE+1000
IF(_BA B_AND 'B01000000'==0)OR(_BA1<>1)
_L1=0 _W1=0 _AZ=0
ELSE
IF($P_TOOLR*_FAK1>_L1/2)OR($P_TOOLR*_FAK1>_W1/2) GOTOF _FEHL11
IF(_AZ<=0) GOTOF _FEHL11
IF(_UXY>(_L-_L1)/2)OR(_UXY>(_W-_W1)/2) GOTOF _FEHL10
ENDIF
IF(_BA1<>5)
IF(_UXY>$P_TOOLR*_FAK1*2) GOTOF _FEHL10
ENDIF
IF((_FZA<>2)AND(_FZA<>3))OR((_BA B_AND 'B111')==5)
_BA10=1
ELSE
IF(_FZA==2)
_BA10=2
ELSE
_BA10=3
ENDIF
ENDIF
_VARI=_BA1+_BA10*10
IF(_BA B_AND 'B10000000000')
_VARI=_VARI+100000
ENDIF
IF(_BA1<>5)
IF(_DZ<=0) GOTOF _FEHL5
ENDIF
F_SP_ED(_SD)
_RTP=_ZREF-(_SC+_SD)*_PMZ
IF($P_TOOLR<0) GOTOF _FEHL8
IF(_FZA==2) AND NOT ((_BA B_AND 'B111')==5)
IF(_FZ<=0) GOTOF _FEHL1
IF(_FZR<=0) GOTOF _FEHL2
IF(_FZ>_DZ)
_FZ=_DZ
ENDIF
ENDIF
IF(_FZA==2)
_RAD1=_FZR
ENDIF
IF(_FZA==3)
_RAD1=_FZ
ENDIF
_M_2:
ELSE
_TM1=_TMOD MOD 10 _MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10 _TM4=TRUNC(_TMOD/1000) MOD 10
_TM8=TRUNC(_TMOD/10000000) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
_Z0=__Z0 _Z1=__Z1 _ZFS=__ZFS
IF(_TM1==0)
IF((_BA B_AND 'B10000000')<>'B00000000')
_Z0=_Z0/2
IF(_Z1A==90)
_Z1=_Z1/2
ENDIF
IF(_ZFSA==90)
_ZFS=_ZFS/2
ENDIF
ENDIF
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
_E_BO=0
IF(_MAN==0)
N14 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
ELSE
_F_INIT=2
_F_RELEAS=1
N16 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
ENDIF
IF(_MAN==0)
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2
ENDIF
_ZREF=_Z0
REPEAT _M_1 _M_2
IF(_MAN==0)
_RP_SD=_F_RP_ACT*_FAK2-_SD*_PMZ
ENDIF
_CYC_FR=$P_CYCFRAME
IF(_TM1<2)
IF(_TM1==0)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=2*_Z0*$PI*_X0/360 _YS=_Y0
ENDIF
ELSE
_XS=_X0 _YS=_Y0
ENDIF
ELSE
IF(_TM1==2)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC+_SD) GOTOF _FEHL14
ENDIF
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
IF(_TM1==3)
_ZZ=$P_AXN3
_C0=((_C0 MOD 360)+360)MOD 360
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
_ANG=_C0
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_ZREF)
ELSE
F_SP_TRA(2102,_ZREF)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_ANG)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
F_SP_TRA(2002+_TM1*10,,_ANG)
ENDIF
ENDIF
IF(_TM8==1)
_DMODE=_DMODE+10000
ENDIF
N98 POCKET3(_RTP,_Z0,_SC,_Z1,_L,_W,_R,_XS,_YS,_A0,_DZ,_UXY,_UZ,_F,_FZ,_E_DIR,_VARI,_DXY,_L1,_W1,_AZ,_RAD1,_FZ,0,_FS,_ZFS,_GMODE+200,_DMODE,_AMODE)
$P_CYCFRAME=_CYC_FR
F_SP_TRA(0)
IF(_TM1<2)
IF(_TM1==0)
IF(_MAN==0)
F_SP_RP(0,_RP,_YS,0)
ELSE
F_SP_TRA(2002,_Z0)
_XXR=$P_AXN3 _ZZR=$P_AXN2
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN1
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM9==1)
F_SP_TRA(103102,_Z0)
ELSE
F_SP_TRA(3102,_Z0)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_C0)
IF(_MAN==0)
F_SP_RP(0,_RP,_YS,0,_XS)
ELSE
_YYR=$P_AXN1 _ZZR=$P_AXN2 _XXR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N45 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
ELSE
IF(_TM1==2)
IF(_MAN==0)
F_SP_RP(0,_SC_POS[3]*_FAK1,_RP,0)
ELSE
F_SP_TRA(2022)
_XXR=$P_AXN1 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN2
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM9==1)
F_SP_TRA(103122)
ELSE
F_SP_TRA(3122)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_MAN==0)
F_SP_RP(9,_SC_POS[0]*_FAK1,_RP,0,_SC_POS[1]*_FAK1)
ELSE
_XXR=$P_AXN1 _YYR=$P_AXN2 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N85 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2 _AX3=$P_AXN3
IF(_MAN==0)
IF(_F_RELEAS==0)
SBLON
N90 G90 G0 G40 AX[_AX1]=_SC_POS[0]*_FAK1 AX[_AX2]=_SC_POS[1]*_FAK1 AX[_AX3]=_RP_SD
SBLOF
ENDIF
ELSE
SBLON
N95 G90 G0 G40 AX[_AX1]=_SC_POS[0]*_FAK1 AX[_AX2]=_SC_POS[1]*_FAK1 AX[_AX3]=_RTP
SBLOF
ENDIF
ENDIF
IF(_MAN==0)
N100 F_TFS("","",_DD,_F,_FAA,_S,_SA,2,0)
ELSE
N102 F_TFS("","",_DD,_F,_FAA,_S,_SA,2,8)
ENDIF
IF($P_F_TYPE==11)OR($P_F_TYPE==33)
IF(_FZA==0)
_DMODE=_DMODE+10
ELSE
_DMODE=_DMODE+20
ENDIF
ELSE
IF(_FZA==0)
_DMODE=_DMODE+20
ELSE
_DMODE=_DMODE+10
ENDIF
ENDIF
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
IF(_TM1==0)OR(_TM1==2)
IF(_TM6==2)AND(_BA10==1)AND(_BA1==1)
IF(_TM9==1)
_MERKER_C=3
ELSE
_MERKER_C=1
ENDIF
ELSE
IF(_TM9==1)
_MERKER_C=4
ELSE
_MERKER_C=0
ENDIF
ENDIF
ELSE
IF(_TM6==2)
_MERKER_C=2
ELSE
_MERKER_C=0
ENDIF
ENDIF
IF(_MERKER_C==0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_MERKER_C==1)
_VARI=_VARI+100
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==2)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>1)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
IF(_MERKER_C==3)
_VARI=_VARI+300
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==4)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N150 POCKET3(_RTP,_ZREF,_SC,_Z1,_L,_W,_R,_XS,_YS,_A0,_DZ,_UXY,_UZ,_F,_FZ,_E_DIR,_VARI,_DXY,_L1,_W1,_AZ,_RAD1,_FZ,_UMODE,_FS,_ZFS,_GMODE,_DMODE,_AMODE)
IF(_MERKER_C==1)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
IF(_MERKER_C==3)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_OB==4)AND(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
IF(_MAN<>0)
IF(_TM1>=2)
IF(_TM1==2)
F_SP_TRA(2022)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N160 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N170 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ELSE
IF(_TM1==0)
F_SP_TRA(2012,_ZREF,_C0)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N180 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N190 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ENDIF
ENDIF
ELSE
IF(_OB==3)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD] _DD=_E_TR[_IDD,1]
_F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4] _SA=_E_TR[_IDD,5]
_TMOD=_E_TR[_IDD,6]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N200 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
_F_RELEAS=0
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2 _ZREF=_Z0
ELSE
IF(_E_IR<_E_MAX)
_Z0=__Z0 _Z1=__Z1 _ZFS=__ZFS
IF(_TMOD MOD 10 ==0)
IF((_BA B_AND 'B10000000')<>'B00000000')
_Z0=_Z0/2
IF(_Z1A==90)
_Z1=_Z1/2
ENDIF
IF(_ZFSA==90)
_ZFS=_ZFS/2
ENDIF
ENDIF
ENDIF
_E_TS1[_E_IR]=_T _E_TS2[_E_IR]=_TF
_E_TR[_E_IR,0]=SET(11,_DD,_F,_FAA,_S,_SA,_TMOD,_BA,_FZ,_FZA,_FZR,_Z0,_Z0A,_Z1,_Z1A,_DZ,_REF,_X0,_X0A,_Y0,_Y0A,_L,_W,_R,_A0,_UXY,_UZ,_L1,_W1,_AZ,_DXY,_DXYA,_C0,_FS,_ZFS,_ZFSA)
_E_IR=_E_IR+1
IF(_POS>=0)
_E_POS=_POS
ENDIF
ELSE
GOTOF _FEHL4
ENDIF
IF(_OB==2)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
G[29]=_P29
_E_S_LINE=0
_RETS:
IF(_E_POS==0)
_F_RELEAS=0
ENDIF
SBLON
RET
_FEHL1: STOPRE
N930701 SETAL(61214)
RET
_FEHL2: STOPRE
N930702 SETAL(61213)
RET
_FEHL3: STOPRE
N930703 SETAL(61002)
RET
_FEHL4: STOPRE
N930704 SETAL(61200)
RET
_FEHL5: STOPRE
N930705 SETAL(61610)
RET
_FEHL7: STOPRE
N930707 SETAL(61222)
RET
_FEHL8: STOPRE
N930708 SETAL(61112)
RET
_FEHL10: STOPRE
N930710 SETAL(61010)
RET
_FEHL11: STOPRE
N930711 SETAL(61215)
RET
_FEHL12: STOPRE
N930712 SETAL(61242)
RET
_FEHL13: STOPRE
N930713 SETAL(61284)
RET
_FEHL14: STOPRE
N930714 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_PS_CIR_SPF
PROC F_PS_CIR(INT _OB,INT _BO,INT _IDD,INT _TMOD,REAL _C0,REAL __Z0,INT _Z0A,REAL _X0,INT _X0A,REAL _Y0,INT _Y0A,REAL _R,REAL _A0,REAL _A1,INT _N,INT _ST,INT _NR,REAL _FC,STRING[200] _HIDE,INT _BA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: positions circle
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _I,_G,_TM1,_TM3,_TM4,_MAN,_PM,_POS,_MAX_POS,_INI,_FIRST,_FOUND,_NUM,_NSP,_P29,S_MIRROR_X,S_MIRROR_Y,S_ACT_POS,S_NUM_POS
DEF REAL _A,_ANG,_DIS,_DX,_DY,_FAK1,_FAK2,_SC,_RP,_X00,_Y00,_Z0,S_T_LEN
DEF BOOL _Y_EXISTS
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF(_OB==0)
IF(_IDD>=0)
_TMOD=_E_TR[_IDD,1] _C0 =_E_TR[_IDD,2] _Z0=_E_TR[_IDD,3] _Z0A=_E_TR[_IDD,4]
_X0 =_E_TR[_IDD,5] _X0A=_E_TR[_IDD,6] _Y0=_E_TR[_IDD,7] _Y0A=_E_TR[_IDD,8]
_R =_E_TR[_IDD,9] _A0 =_E_TR[_IDD,10] _A1=_E_TR[_IDD,11] _N =_E_TR[_IDD,12]
_ST =_E_TR[_IDD,13] _FC=_E_TR[_IDD,14] _BA=_E_TR[_IDD,15]
_HIDE=_E_TS1[_IDD]
_IDD=-1
ENDIF
_FC=$SCS_CIRCLE_RAPID_FEED
_P29=$P_GG[29]
DIAMCYCOF
IF($P_MC==0) GOTOF _FEHL6
IF(_N<=0) GOTOF _FEHL1
_HIDE=","<<_HIDE<<","
_INI=1
_NUM=0
REPEAT
REPEAT _NPOS1 _NPOS2
UNTIL _FOUND==FALSE
S_NUM_POS=S_ACT_POS
_INI=1
_NSP=_E_NSP
_NUM=_NSP
REPEAT _NPOS1 _NPOS2
_NUM=0
IF(_NSP>=1)
S_ACT_POS=S_ACT_POS+_NSP
ENDIF
IF(NOT _FOUND)
IF(_NSP==0)
GOTOF _FEHL1
ELSE
GOTOF _FEHL4
ENDIF
ENDIF
_TM1=_TMOD MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
_PM=2*(TRUNC(_TMOD/100) MOD 10)-1
_TM4=TRUNC(_TMOD/1000) MOD 10
F_SP_RPT(3,_TMOD)
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RP=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RP=_F_RP_ACT*_FAK2
ENDIF
_F_PS_REF=_Z0*1/_FAK2
IF(_TM1==6)
IF(_RP<=_F_PS_REF+_SC) GOTOF _FEHL8
ENDIF
_E_BO=_BO
IF((_ST MOD 10)==0)
_A1=360/_N
ENDIF
IF((TRUNC(_ST/10)MOD 10)==0)
_G=0
ELSE
IF(_A1>0)
_G=3
ELSE
_G=2
ENDIF
ENDIF
IF(_F_TRAANG)OR(_F_Y_AXIS)
_Y_EXISTS=TRUE
ELSE
_Y_EXISTS=FALSE
ENDIF
IF(_MAN)
IF(_RP*_PM>_Z0*_PM) GOTOF _FEHL7
ENDIF
IF(_TM1<=1)
IF(_TM1==0)
_E_MC=0
F_SP_TRA(2003,_Z0)
IF(_MAN)
ELSE
F_SP_RP(0,_RP,_Y0,1)
ENDIF
IF($ON_TRAFO_TYPE_MASK B_AND 'B10000010')
F_SP_TRA(2103,_Z0)
_YY=$P_AXN1
S_MIRROR_Y=1-2*$P_ACTFRAME[_YY,MI]
F_SP_TRA(2003,_Z0)
ENDIF
F_SP_TRA(1003,_Z0)
_CC=_F_S_AX[_F_MASPI]
_ZZ=$P_AXN2
_XX=$P_AXN3
_FIRST=1
WHILE(_FOUND)
_SC_WO=0
_E_MC=0
IF(_FIRST==0)
SBLON
N100 G0 G40 G90 AX[_XX]=_RP
SBLOF
ELSE
_FIRST=0
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
_E_MC=1
_A=_A0+_I*_A1
IF(S_MIRROR_Y==-1)
_A=-_A
ENDIF
_A=-_A*_F_C_DIR[_F_MASPI/2]
_A=((_A MOD 360)+360)MOD 360
N110 SBLON
N120 G90 G0 G40 AX[_CC]=DC(_A) AX[_XX]=_RP AX[_ZZ]=_Y0
N130 SBLOF
_E_MC=0
_E_BO=_BO
F_SP_TRA(2003,_Z0)
REPEAT _NPOS1 _NPOS2
ENDWHILE
IF($ON_TRAFO_TYPE_MASK B_AND 'B10000010')
F_SP_TRA(2103,_Z0)
ELSE
F_SP_TRA(2003,_Z0)
ENDIF
ELSE
_E_MC=0
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2013,,_C0)
IF(_MAN)
ELSE
F_SP_RP(0,_RP,_Y0+_R*SIN(_A0+_I*_A1),1,_X0+_R*COS(_A0+_I*_A1))
ENDIF
_YY=$P_AXN1
_ZZ=$P_AXN2
_XX=$P_AXN3
_CC=_F_S_AX[_F_MASPI]
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
SBLON
N195 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_FIRST=1
WHILE(_FOUND)
_SC_WO=_A0+_I*_A1
_E_MC=0
IF(_FIRST==0)
SBLON
N200 G0 G40 G90 AX[_XX]=_RP
SBLOF
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
_E_MC=1
_A=_A0+_I*_A1
_A=((_A MOD 360)+360)MOD 360
IF(_G==0)OR(_FIRST==1)
N210 SBLON
N211 G0 G9 G40 G90 AX[_YY]=_X0+_R*COS(_A) AX[_XX]=_RP AX[_ZZ]=_Y0+_R*SIN(_A)
N212 SBLOF
_FIRST=0
ELSE
IF(_G==2)
N220 SBLON
N221 G94 FB=_FC G2 G9 G40 G90 AX[_YY]=_X0+_R*COS(_A) AX[_ZZ]=_Y0+_R*SIN(_A) IP[_YY]=AC(_X0) IP[_ZZ]=AC(_Y0) AX[_XX]=_RP
N222 SBLOF
ELSE
N230 SBLON
N231 G94 FB=_FC G3 G9 G40 G90 AX[_YY]=_X0+_R*COS(_A) AX[_ZZ]=_Y0+_R*SIN(_A) IP[_YY]=AC(_X0) IP[_ZZ]=AC(_Y0) AX[_XX]=_RP
N232 SBLOF
ENDIF
ENDIF
_E_MC=0
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
F_SP_TRA(2013,,_C0)
IF((_G>0)AND(($P_EP[_XX]*_FAK1<>_X0+_DX)OR($P_EP[_YY]*_FAK1<>_Y0+_DY)))
SBLON
N240 G0 G9 G40 G90 AX[_YY]=_X0+_R*COS(_A) AX[_XX]=_RP AX[_ZZ]=_Y0+_R*SIN(_A)
SBLOF
ENDIF
_E_BO=_BO
REPEAT _NPOS1 _NPOS2
ENDWHILE
F_SP_TRA(2013,,_C0)
ENDIF
IF(_MAN)
N250 G0 G9 G40 G90 AX[_XX]=_RP
ENDIF
ELSE
IF(_TM1==2)
IF(_TM4==0)
_E_MC=0
IF($ON_TRAFO_TYPE_MASK B_AND 'B10000010')
F_SP_TRA(2123)
_YY=$P_AXN2
S_MIRROR_Y=1-2*$P_ACTFRAME[_YY,MI]
ELSE
F_SP_TRA(2023)
ENDIF
_CC=_F_S_AX[_F_MASPI]
_XX=$P_AXN1
_ZZ=$P_AXN3
S_MIRROR_X=1-2*$P_ACTFRAME[_XX,MI]
IF($MCS_REV_2_BORDER_TOOL_LENGTH)AND(_F_T_REV2)
S_MIRROR_X=-S_MIRROR_X
IF(_F_Y_AXIS)OR($P_TRAFO B_AND 'H100')
S_MIRROR_Y=-S_MIRROR_Y
ENDIF
ENDIF
F_SP_TRA(2023)
IF(_MAN)
ELSE
F_SP_RP(0,_R,_RP,1)
ENDIF
F_SP_TRA(1023)
_FIRST=1
WHILE(_FOUND)
_SC_WO=_A0+_I*_A1
_E_MC=0
IF(_FIRST==0)
SBLON
N300 G0 G40 G90 AX[_ZZ]=_RP
SBLOF
ELSE
_FIRST=0
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
_E_MC=1
_A=_A0+_I*_A1
IF(S_MIRROR_X==-1)
_A=180-_A
ENDIF
IF(S_MIRROR_Y==-1)
_A=360-_A
ENDIF
_A=-_A*_F_C_DIR[_F_MASPI/2]
_A=((_A MOD 360)+360)MOD 360
N310 SBLON
N320 G90 G0 G40 AX[_CC]=DC(_A) AX[_ZZ]=_RP AX[_XX]=_R*S_MIRROR_X
N330 SBLOF
_E_MC=0
_E_BO=_BO
F_SP_TRA(2023)
REPEAT _NPOS1 _NPOS2
ENDWHILE
ELSE
_E_MC=0
F_SP_TRA(2023)
IF(_MAN)
ELSE
_SC_WO=_A0+_I*_A1
_DX=_X0+COS(_SC_WO)*_R
_DY=_Y0+SIN(_SC_WO)*_R
_DIS=SQRT(ABS(_DX*_DX+_DY*_DY))
F_SP_RP(0,_DIS,_RP,1)
ENDIF
F_SP_TRA(3123)
_XX=$P_AXN1
_YY=$P_AXN2
_ZZ=$P_AXN3
_FIRST=1
WHILE(_FOUND)
_SC_WO=_A0+_I*_A1
_DX=COS(_SC_WO)*_R _DY=SIN(_SC_WO)*_R
_E_MC=0
IF(_FIRST==0)
SBLON
N400 G0 G40 G90 AX[_ZZ]=_RP
SBLOF
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
_E_BO=_BO
_E_MC=1
IF(_G==0)OR(_FIRST==1)
N410 SBLON
N411 G0 G9 G40 G90 AX[_XX]=_X0+_DX AX[_YY]=_Y0+_DY AX[_ZZ]=_RP
N412 SBLOF
_FIRST=0
ELSE
IF(_G==2)
N420 SBLON
N421 G94 FB=_FC G2 G9 G40 G90 AX[_XX]=_X0+_DX AX[_YY]=_Y0+_DY IP[_XX]=AC(_X0) IP[_YY]=AC(_Y0) AX[_ZZ]=_RP
N422 SBLOF
ELSE
N430 SBLON
N431 G94 FB=_FC G3 G9 G40 G90 AX[_XX]=_X0+_DX AX[_YY]=_Y0+_DY IP[_XX]=AC(_X0) IP[_YY]=AC(_Y0) AX[_ZZ]=_RP
N432 SBLOF
ENDIF
ENDIF
_E_MC=0
F_SP_TRA(2123)
IF((_G>0)AND(($P_EP[_XX]*_FAK1<>_X0+_DX)OR($P_EP[_YY]*_FAK1<>_Y0+_DY)))
SBLON
N440 G0 G9 G40 G90 AX[_XX]=_X0+_DX AX[_YY]=_Y0+_DY
SBLOF
ENDIF
_E_BO=_BO
REPEAT _NPOS1 _NPOS2
ENDWHILE
ENDIF
IF($ON_TRAFO_TYPE_MASK B_AND 'B10000010')
F_SP_TRA(2123)
ELSE
F_SP_TRA(2023)
ENDIF
ELSE
_E_MC=0
_C0=((_C0 MOD 360)+360)MOD 360
IF(_X0A==1)OR(_Y0A==1)
_ANG=_X0 _DIS=_Y0
_X0=_DIS*COS(_ANG) _Y0=_DIS*SIN(_ANG)
ENDIF
IF(_TM4==0)
IF(_TM1==3)
_X0=0 _Y0=0
ENDIF
ENDIF
F_SP_TRA(2003+_TM1*10,,_C0)
IF(_TM1==3)
_X00=(_X0+COS(_A0+_I*_A1)*_R)*COS(-_C0*_F_C_DIR[_F_MASPI/2])+(_Y0+SIN(_A0+_I*_A1)*_R)*SIN(-_C0*_F_C_DIR[_F_MASPI/2])
_Y00=(_Y0+SIN(_A0+_I*_A1)*_R)*COS(-_C0*_F_C_DIR[_F_MASPI/2])-(_X0+COS(_A0+_I*_A1)*_R)*SIN(-_C0*_F_C_DIR[_F_MASPI/2])
ELSE
IF(_TM4==0)
_X00=_X0
_Y00=_Y0
ELSE
_X00=(_X0+COS(_A0+_I*_A1)*_R)
_Y00=(_Y0+SIN(_A0+_I*_A1)*_R)
ENDIF
ENDIF
IF(_MAN)
ELSE
F_SP_RP(0,_X00,_RP,1,_Y00)
ENDIF
_XX=$P_AXN1
_YY=$P_AXN2
_ZZ=$P_AXN3
_CC=_F_S_AX[_F_MASPI]
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
SBLON
N490 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
_FIRST=1
WHILE(_FOUND)
_SC_WO=_A0+_I*_A1
_DX=COS(_SC_WO)*_R _DY=SIN(_SC_WO)*_R
_E_MC=0
IF(_FIRST==0)
SBLON
N500 G0 G40 G90 AX[_ZZ]=_RP
SBLOF
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
_E_BO=_BO
_E_MC=1
IF(_TM4==0)AND(_TM1==6)
_SC_WO=0
_A=_A0+_I*_A1
_A=-_A*_F_C_DIR[_F_MASPI/2]
_A=((_A MOD 360)+360)MOD 360
$P_CYCFRAME[_CC,TR]=_A+_F_TRA_C
WRTPR("CPOS("<<$P_PFRAME[_CC,TR]+$P_CYCFRAME[_CC,TR]<<")",1)
F_SP_TRA(2003+_TM1*10,,_TC_A2)
N502 SBLON
N504 G0 G9 G40 G90 AX[_XX]=_X0 AX[_YY]=_Y0 AX[_ZZ]=_RP AX[_CC]=DC(_TC_A2)
N506 SBLOF
_FIRST=0
GOTOF _STIRN_B
ENDIF
IF(_G==0)OR(_FIRST==1)
N510 SBLON
N511 G0 G9 G40 G90 AX[_XX]=_X0+_DX AX[_YY]=_Y0+_DY AX[_ZZ]=_RP
N512 SBLOF
_FIRST=0
ELSE
IF(_G==2)
N520 SBLON
N521 G94 FB=_FC G2 G9 G40 G90 AX[_XX]=_X0+_DX AX[_YY]=_Y0+_DY IP[_XX]=AC(_X0) IP[_YY]=AC(_Y0) AX[_ZZ]=_RP
N522 SBLOF
ELSE
N530 SBLON
N531 G94 FB=_FC G3 G9 G40 G90 AX[_XX]=_X0+_DX AX[_YY]=_Y0+_DY IP[_XX]=AC(_X0) IP[_YY]=AC(_Y0) AX[_ZZ]=_RP
N532 SBLOF
ENDIF
ENDIF
_STIRN_B:
_E_MC=0
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
F_SP_TRA(2003+_TM1*10,,_C0)
IF((_G>0)AND(($P_EP[_XX]*_FAK1<>_X0+_DX)OR($P_EP[_YY]*_FAK1<>_Y0+_DY)))AND(NOT((_TM4==0)AND(_TM1==6)))
SBLON
N540 G0 G9 G40 G90 AX[_XX]=_X0+_DX AX[_YY]=_Y0+_DY
SBLOF
ENDIF
_E_BO=_BO
REPEAT _NPOS1 _NPOS2
ENDWHILE
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ELSE
$P_CYCFRAME[_CC,TR]=_F_TRA_C
WRTPR("CPOS("<<$P_PFRAME[_CC,TR]+$P_CYCFRAME[_CC,TR]<<")",1)
ENDIF
ENDIF
IF(_MAN)
N550 G0 G9 G40 G90 AX[_ZZ]=_RP
ENDIF
ENDIF
_SC_WO=0;
G[29]=_P29
ELSE
IF(_OB==4)
_TMOD=_E_TR[_IDD,1] _Z0=_E_TR[_IDD,3]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
IF(_TM1<=1)
IF(_TM1==0)AND($ON_TRAFO_TYPE_MASK B_AND 'B10000010')
F_SP_TRA(2103,_Z0)
ELSE
F_SP_TRA(2003+_TM1*10,_Z0)
ENDIF
ELSE
IF(_TM1==2)AND($ON_TRAFO_TYPE_MASK B_AND 'B10000010')
F_SP_TRA(2123)
ELSE
F_SP_TRA(2003+_TM1*10)
ENDIF
ENDIF
ELSE
IF(_E_IR>=_E_MAX) GOTOF _FEHL2
_Z0=__Z0
IF(_TMOD MOD 10 ==0)
IF(_BA B_AND 'B01'=='B01')
_Z0=_Z0/2
ENDIF
ENDIF
_E_TR[_E_IR, 0]=SET(-4,_TMOD,_C0,_Z0,_Z0A)
_E_TR[_E_IR, 5]=SET(_X0,_X0A,_Y0,_Y0A,_R,_A0,_A1,_N,_ST,_FC,_BA)
_E_TS1[_E_IR]=_HIDE
_E_IR=_E_IR+1
IF(_E_POS<1) GOTOF _FEHL3
_E_POS=_E_POS-1
IF(_E_POS==0)
F_MANAGE
ENDIF
ENDIF
ENDIF
_E_S_LINE=0
_RETS:
IF(_E_POS==0)
_F_RELEAS=0
ENDIF
SBLON
RET
_NPOS1:
IF(_INI)
_INI=0
_POS=0
S_ACT_POS=0
_MAX_POS=_N
ENDIF
_FOUND=0
WHILE(_FOUND<=_NUM)AND(_POS<_MAX_POS)
_POS=_POS+1
_I=(_POS-1)
IF(MATCH(_HIDE,","<<_POS<<",")<0)AND(_POS<=_MAX_POS)
_FOUND=_FOUND+1
ENDIF
ENDWHILE
IF(_FOUND<=_NUM)
_FOUND=0
ELSE
S_ACT_POS=S_ACT_POS+1
ENDIF
_NPOS2:
_FEHL1: STOPRE
N930301 SETAL(61103)
RET
_FEHL2: STOPRE
N930302 SETAL(61200)
RET
_FEHL3: STOPRE
N930303 SETAL(61205)
RET
_FEHL4: STOPRE
N930304 SETAL(61210)
RET
_FEHL5: STOPRE
N930305 SETAL(61211)
RET
_FEHL6: STOPRE
N930306 SETAL(62100)
M0
RET
_FEHL7: STOPRE
N930307 SETAL(61284)
RET
_FEHL8: STOPRE
N930308 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_PS_FRA_SPF
PROC F_PS_FRA(INT _OB,INT _BO,INT _IDD,INT _TMOD,REAL _C0,REAL __Z0,INT _Z0A,REAL _X0,INT _X0A,REAL _Y0,INT _Y0A,REAL _A0,REAL _L1,INT _N1,REAL _L2,INT _N2,INT _NR,REAL _AX,REAL _AY,STRING[200] _HIDE,INT _BA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.05.08.00 ;DATE: 2011-01-12
;ShopTurn: positions frame
DEF INT _Z0
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
G4 F0
IF(_OB==0)OR(_OB==4)
F_PS_MRX(_OB,_BO,_IDD)
ELSE
IF(_E_IR>=_E_MAX) GOTOF _FEHL1
_Z0=__Z0
IF(_TMOD MOD 10 ==0)
IF(_BA B_AND 'B01'=='B01')
_Z0=_Z0/2
ENDIF
ENDIF
_E_TR[_E_IR, 0]=SET(-5,_TMOD,_C0,_Z0,_Z0A,_X0,_X0A,_Y0,_Y0A,_A0)
_E_TR[_E_IR,10]=SET(_L1,_N1,_L2,_N2,_AX,_AY,1,_BA)
_E_TS1[_E_IR]=_HIDE
_E_IR=_E_IR+1
IF(_E_POS<1) GOTOF _FEHL2
_E_POS=_E_POS-1
IF(_E_POS==0)
F_MANAGE
ENDIF
ENDIF
_RETS:
RET
_FEHL1: STOPRE
N980121 SETAL(61200)
RET
_FEHL2: STOPRE
N980122 SETAL(61205)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_PS_MRX_SPF
PROC F_PS_MRX(INT _OB,INT _BO,INT _IDD,INT _TMOD,REAL _C0,REAL __Z0,INT _Z0A,REAL _X0,INT _X0A,REAL _Y0,INT _Y0A,REAL _A0,REAL _L1,INT _N1,REAL _L2,INT _N2,INT _NR,REAL _AX,REAL _AY,STRING[200] _HIDE,INT _MODE,INT _BA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: posistions matrix
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _I1,_I2,_TM1,_TM3,_MAN,_PM,_FOUND,_NSP,_POS,_MAX_POS,_NUM,_INI,_FIRST,_P29,S_ACT_POS,S_NUM_POS
DEF REAL _X,_Y,_Z,_DX,_DY,_DZ,_X00,_Y00,_Z00,_SII,_CO,_FAK1,_FAK2,_SC,_RP,_R,_Z0
DEF BOOL _Y_EXISTS
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF(_OB==0)
IF(_IDD>=0)
_TMOD=_E_TR[_IDD,1] _C0 =_E_TR[_IDD,2] _Z0=_E_TR[_IDD,3] _Z0A=_E_TR[_IDD,4]
_X0 =_E_TR[_IDD,5] _X0A=_E_TR[_IDD,6] _Y0=_E_TR[_IDD,7] _Y0A=_E_TR[_IDD,8]
_A0 =_E_TR[_IDD,9] _L1 =_E_TR[_IDD,10] _N1=_E_TR[_IDD,11] _L2 =_E_TR[_IDD,12]
_N2 =_E_TR[_IDD,13]
_AX =_E_TR[_IDD,14] _AY =_E_TR[_IDD,15] _MODE=_E_TR[_IDD,16] _BA=_E_TR[_IDD,17]
_HIDE=_E_TS1[_IDD]
_IDD=-1
ENDIF
_P29=$P_GG[29]
DIAMCYCOF
IF($P_MC==0) GOTOF _FEHL6
IF(_N1<=0)OR(_N2<=0) GOTOF _FEHL1
IF(_AX<=-90)OR(_AX>=90) GOTOF _FEHL9
IF(_AY<=-90)OR(_AY>=90) GOTOF _FEHL9
IF(_N1>1)AND(_L1==0) GOTOF _FEHL8
IF(_N2>1)AND(_L2==0) GOTOF _FEHL8
IF(_MODE==1)AND((_N1==1)OR(_N2==1))
_MODE=0
ENDIF
_HIDE=","<<_HIDE<<","
_INI=1
_NUM=0
REPEAT
REPEAT _NPOS1 _NPOS2
UNTIL _FOUND==FALSE
S_NUM_POS=S_ACT_POS
_INI=1
_NSP=_E_NSP
_NUM=_NSP
REPEAT _NPOS1 _NPOS2
_NUM=0
IF(_NSP>=1)
S_ACT_POS=S_ACT_POS+_NSP
ENDIF
IF(NOT _FOUND)
IF(_NSP==0)
GOTOF _FEHL1
ELSE
GOTOF _FEHL4
ENDIF
ENDIF
_TM1=_TMOD MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
_PM=2*(TRUNC(_TMOD/100) MOD 10)-1
F_SP_RPT(3,_TMOD)
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RP=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RP=_F_RP_ACT*_FAK2
ENDIF
_F_PS_REF=_Z0*1/_FAK2
IF(_TM1==6)
IF(_RP<=_F_PS_REF+_SC) GOTOF _FEHL10
ENDIF
_E_BO=_BO
IF(_F_TRAANG)OR(_F_Y_AXIS)
_Y_EXISTS=TRUE
ELSE
_Y_EXISTS=FALSE
ENDIF
IF(_MAN)
IF(_RP*_PM>_Z0*_PM) GOTOF _FEHL7
ENDIF
IF(_TM1<=1)
IF(_TM1==0)
_Y00=_X0
_Z00=_Y0
_R=_Z00+SIN(_A0)*_I1*_L1+COS(_A0)*_I2*_L2
_E_MC=0
F_SP_TRA(2003,_Z0)
IF(_MAN)
ELSE
F_SP_RP(0,_RP,_R,1)
ENDIF
F_SP_TRA(3103,_Z0)
_YY=$P_AXN1
_ZZ=$P_AXN2
_XX=$P_AXN3
_SII=SIN(_A0)
_CO=COS(_A0)
_FIRST=1
WHILE(_FOUND)
_Y=_I1*_L1-_I2*_L2*TAN(_AY)
_Z=_I2*_L2+_I1*_L1*TAN(_AX)
_DY=_CO*_Y-_SII*_Z _DZ=_SII*_Y+_CO*_Z
_E_MC=0
IF(_FIRST==0)
SBLON
N100 G0 G40 G90 AX[_XX]=_RP
SBLOF
ELSE
_FIRST=0
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
_E_MC=1
_E_BO=_BO
SBLON
N120 G0 G9 G40 G90 AX[_YY]=_Y00+_DY AX[_ZZ]=_Z00+_DZ AX[_XX]=_RP
SBLOF
_E_MC=0
_E_BO=_BO
F_SP_TRA(2103,_Z0)
REPEAT _NPOS1 _NPOS2
ENDWHILE
ELSE
_Y00=_X0
_Z00=_Y0
_SII=SIN(_A0)
_CO=COS(_A0)
_R=_Z00+_SII*_I1*_L1+_CO*_I2*_L2
_E_MC=0
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2013,,_C0)
IF(_MAN)
ELSE
F_SP_RP(0,_RP,_R,1,_X0)
ENDIF
_YY=$P_AXN1
_ZZ=$P_AXN2
_XX=$P_AXN3
_CC=_F_S_AX[_F_MASPI]
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
SBLON
N200 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_FIRST=1
WHILE(_FOUND)
_Y=_I1*_L1-_I2*_L2*TAN(_AY)
_Z=_I2*_L2+_I1*_L1*TAN(_AX)
_DY=_CO*_Y-_SII*_Z _DZ=_SII*_Y+_CO*_Z
_E_MC=0
IF(_FIRST==0)
SBLON
N210 G0 G40 G90 AX[_XX]=_RP
SBLOF
ELSE
_FIRST=0
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
_E_MC=1
_E_BO=_BO
SBLON
N220 G0 G9 G40 G90 AX[_YY]=_Y00+_DY AX[_ZZ]=_Z00+_DZ AX[_XX]=_RP
SBLOF
_E_MC=0
_E_BO=_BO
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
F_SP_TRA(2013,,_C0)
REPEAT _NPOS1 _NPOS2
ENDWHILE
ENDIF
IF(_MAN)
N250 G0 G9 G40 G90 AX[_XX]=_RP
ENDIF
ELSE
IF(_TM1==2)
_SII=SIN(_A0)
_CO=COS(_A0)
_DX=_CO*_I1*_L1-_SII*_I2*_L2
_DY=_SII*_I1*_L1+_CO*_I2*_L2
_R=SQRT(POT(_X0+_DX)+POT(_Y0+_DY))
_E_MC=0
F_SP_TRA(2023)
IF(_MAN)
ELSE
F_SP_RP(0,_R,_RP,1)
ENDIF
F_SP_TRA(3123)
_XX=$P_AXN1
_YY=$P_AXN2
_ZZ=$P_AXN3
_FIRST=1
WHILE(_FOUND)
_X=_I1*_L1-_I2*_L2*TAN(_AY)
_Y=_I2*_L2+_I1*_L1*TAN(_AX)
_DX=_CO*_X-_SII*_Y _DY=_SII*_X+_CO*_Y
_E_MC=0
IF(_FIRST==0)
SBLON
N300 G0 G40 G90 AX[_ZZ]=_RP
SBLOF
ELSE
_FIRST=0
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
_E_MC=1
SBLON
N320 G0 G9 G40 G90 AX[_XX]=_X0+_DX AX[_YY]=_Y0+_DY AX[_ZZ]=_RP
SBLOF
_E_MC=0
_E_BO=_BO
F_SP_TRA(2123)
REPEAT _NPOS1 _NPOS2
ENDWHILE
ELSE
_SII=SIN(_A0)
_CO=COS(_A0)
_DX=_CO*_I1*_L1-_SII*_I2*_L2
_DY=_SII*_I1*_L1+_CO*_I2*_L2
_R=SQRT(POT(_X0+_DX)+POT(_Y0+_DY))
_E_MC=0
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2003+_TM1*10,,_C0)
IF(_TM1==3)
_X00=(_X0+_DX)*COS(-_C0*_F_C_DIR[_F_MASPI/2])+(_Y0+_DY)*SIN(-_C0*_F_C_DIR[_F_MASPI/2])
_Y00=(_Y0+_DY)*COS(-_C0*_F_C_DIR[_F_MASPI/2])-(_X0+_DX)*SIN(-_C0*_F_C_DIR[_F_MASPI/2])
ELSE
_X00=_X0+_DX
_Y00=_Y0+_DY
ENDIF
IF(_MAN)
ELSE
F_SP_RP(0,_X00,_RP,1,_Y00)
ENDIF
_XX=$P_AXN1
_YY=$P_AXN2
_ZZ=$P_AXN3
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N330 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
_FIRST=1
WHILE(_FOUND)
_X=_I1*_L1-_I2*_L2*TAN(_AY)
_Y=_I2*_L2+_I1*_L1*TAN(_AX)
_DX=_CO*_X-_SII*_Y _DY=_SII*_X+_CO*_Y
_E_MC=0
IF(_FIRST==0)
SBLON
N400 G0 G40 G90 AX[_ZZ]=_RP
SBLOF
ELSE
_FIRST=0
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
_E_MC=1
SBLON
N420 G0 G9 G40 G90 AX[_XX]=_X0+_DX AX[_YY]=_Y0+_DY AX[_ZZ]=_RP
SBLOF
_E_MC=0
_E_BO=_BO
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
F_SP_TRA(2003+_TM1*10,,_C0)
REPEAT _NPOS1 _NPOS2
ENDWHILE
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
IF(_MAN)
N450 G0 G9 G40 G90 AX[_ZZ]=_RP
ENDIF
ENDIF
G[29]=_P29
ELSE
IF(_OB==4)
_TMOD=_E_TR[_IDD,1] _Z0=_E_TR[_IDD,3]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
IF(_TM1<=1)
IF(_TM1==0)
F_SP_TRA(2103,_Z0)
ELSE
F_SP_TRA(2013,_Z0)
ENDIF
ELSE
IF(_TM1==2)
F_SP_TRA(2123)
ELSE
F_SP_TRA(2003+_TM1*10)
ENDIF
ENDIF
ELSE
IF(_E_IR>=_E_MAX) GOTOF _FEHL2
_Z0=__Z0
IF(_TMOD MOD 10 ==0)
IF(_BA B_AND 'B01'=='B01')
_Z0=_Z0/2
ENDIF
ENDIF
_E_TR[_E_IR, 0]=SET(-3,_TMOD,_C0,_Z0,_Z0A)
_E_TR[_E_IR, 5]=SET(_X0,_X0A,_Y0,_Y0A,_A0,_L1,_N1,_L2,_N2,_AX,_AY,_MODE,_BA)
_E_TS1[_E_IR]=_HIDE
_E_IR=_E_IR+1
IF(_E_POS<1) GOTOF _FEHL3
_E_POS=_E_POS-1
IF(_E_POS==0)
F_MANAGE
ENDIF
ENDIF
ENDIF
_E_S_LINE=0
_RETS:
IF(_E_POS==0)
_F_RELEAS=0
ENDIF
SBLON
RET
_NPOS1:
IF(_INI)
_INI=0
_POS=0
S_ACT_POS=0
IF(_MODE==0)
_MAX_POS=_N1*_N2
ELSE
_MAX_POS=2*(_N1+_N2)-4
ENDIF
ENDIF
_FOUND=0
WHILE(_FOUND<=_NUM)AND(_POS<_MAX_POS)
_POS=_POS+1
IF(_MODE==0)
_I1=(_POS-1)MOD _N1
_I2=(_POS-1)DIV _N1
IF(_I2 MOD 2)
_I1=_N1-_I1-1
ENDIF
ELSE
IF(_POS<=_N1-1)
_I1=_POS-1
_I2=0
ELSE
IF(_POS<=_N1+_N2-2)
_I1=_N1-1
_I2=_POS-_N1
ELSE
IF(_POS<=2*_N1+_N2-3)
_I1=2*_N1+_N2-2-_POS
_I2=_N2-1
ELSE
_I1=0
_I2=_MAX_POS-_POS+1
ENDIF
ENDIF
ENDIF
ENDIF
IF(MATCH(_HIDE,","<<_POS<<",")<0)AND(_POS<=_MAX_POS)
_FOUND=_FOUND+1
ENDIF
ENDWHILE
IF(_FOUND<=_NUM)
_FOUND=0
ELSE
S_ACT_POS=S_ACT_POS+1
ENDIF
_NPOS2:
_FEHL1: STOPRE
N980101 SETAL(61103)
RET
_FEHL2: STOPRE
N980102 SETAL(61200)
RET
_FEHL3: STOPRE
N980103 SETAL(61205)
RET
_FEHL4: STOPRE
N980104 SETAL(61210)
RET
_FEHL5: STOPRE
N980105 SETAL(61211)
RET
_FEHL6: STOPRE
N980106 SETAL(62100)
M0
RET
_FEHL7: STOPRE
N980107 SETAL(61284)
RET
_FEHL8: STOPRE
N980108 SETAL(61118)
RET
_FEHL9: STOPRE
N980109 SETAL(61184)
RET
_FEHL10: STOPRE
N980110 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_PS_ROW_SPF
PROC F_PS_ROW(INT _OB,INT _BO,INT _IDD,INT _TMOD,REAL _C0,REAL __Z0,INT _Z0A,REAL _X0,INT _X0A,REAL _Y0,INT _Y0A,REAL _A0,REAL _L,INT _N,INT _NR,STRING[200] _HIDE,REAL _L0,INT _BA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: positions row
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _I,_TM1,_TM3,_MAN,_PM,_FOUND,_NSP,_POS,_MAX_POS,_NUM,_INI,_FIRST,_P29,S_ACT_POS,S_NUM_POS
DEF REAL _X,_Y,_DX,_DY,_DZ,_X00,_Y00,_Z00,_SII,_CO,_FAK1,_FAK2,_SC,_RP,_R,_Z0
DEF BOOL _Y_EXISTS
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF(_OB==0)
IF(_IDD>=0)
_TMOD=_E_TR[_IDD,1] _C0 =_E_TR[_IDD,2] _Z0=_E_TR[_IDD,3] _Z0A=_E_TR[_IDD,4]
_X0 =_E_TR[_IDD,5] _X0A=_E_TR[_IDD,6] _Y0=_E_TR[_IDD,7] _Y0A=_E_TR[_IDD,8]
_A0 =_E_TR[_IDD,9] _L0 =_E_TR[_IDD,10] _L =_E_TR[_IDD,11] _N =_E_TR[_IDD,12]
_BA=_E_TR[_IDD,13]
_HIDE=_E_TS1[_IDD]
_IDD=-1
ENDIF
_P29=$P_GG[29]
DIAMCYCOF
IF($P_MC==0) GOTOF _FEHL6
IF(_N<=0) GOTOF _FEHL1
IF(_N>1)AND(_L==0) GOTOF _FEHL8
_HIDE=","<<_HIDE<<","
_INI=1
_NUM=0
REPEAT
REPEAT _NPOS1 _NPOS2
UNTIL _FOUND==FALSE
S_NUM_POS=S_ACT_POS
_INI=1
_NSP=_E_NSP
_NUM=_NSP
REPEAT _NPOS1 _NPOS2
_NUM=0
IF(_NSP>=1)
S_ACT_POS=S_ACT_POS+_NSP
ENDIF
IF(NOT _FOUND)
IF(_NSP==0)
GOTOF _FEHL1
ELSE
GOTOF _FEHL4
ENDIF
ENDIF
_TM1=_TMOD MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
_PM=2*(TRUNC(_TMOD/100) MOD 10)-1
F_SP_RPT(3,_TMOD)
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RP=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RP=_F_RP_ACT*_FAK2
ENDIF
_F_PS_REF=_Z0*1/_FAK2
IF(_TM1==6)
IF(_RP<=_F_PS_REF+_SC) GOTOF _FEHL9
ENDIF
_E_BO=_BO
IF(_F_TRAANG)OR(_F_Y_AXIS)
_Y_EXISTS=TRUE
ELSE
_Y_EXISTS=FALSE
ENDIF
IF(_MAN)
IF(_RP*_PM>_Z0*_PM) GOTOF _FEHL7
ENDIF
IF(_TM1<=1)
IF(_TM1==0)
_Y00=_X0
_Z00=_Y0
_R=_Z00+SIN(_A0)*_I*_L
_E_MC=0
F_SP_TRA(2003,_Z0)
IF(_MAN)
ELSE
F_SP_RP(0,_RP,_R,1)
ENDIF
F_SP_TRA(3103,_Z0)
_YY=$P_AXN1
_ZZ=$P_AXN2
_XX=$P_AXN3
_SII=SIN(_A0)
_CO=COS(_A0)
_FIRST=1
WHILE(_FOUND)
_Y=_L0+_I*_L
_DY=_CO*_Y _DZ=_SII*_Y
_E_MC=0
IF(_FIRST==0)
SBLON
N100 G0 G40 G90 AX[_XX]=_RP
SBLOF
ELSE
_FIRST=0
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
_E_MC=1
_E_BO=_BO
SBLON
N120 G0 G9 G40 G90 AX[_YY]=_Y00+_DY AX[_ZZ]=_Z00+_DZ AX[_XX]=_RP
SBLOF
_E_MC=0
_E_BO=_BO
F_SP_TRA(2103,_Z0)
REPEAT _NPOS1 _NPOS2
ENDWHILE
ELSE
_Y00=_X0
_Z00=_Y0
_SII=SIN(_A0)
_CO=COS(_A0)
_R=_Z00+_SII*(_L0+_I*_L)
_E_MC=0
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2013,,_C0)
IF(_MAN)
ELSE
F_SP_RP(0,_RP,_R,1,_X0)
ENDIF
_YY=$P_AXN1
_ZZ=$P_AXN2
_XX=$P_AXN3
_CC=_F_S_AX[_F_MASPI]
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
SBLON
N195 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_FIRST=1
WHILE(_FOUND)
_Y=_L0+_I*_L
_DY=_CO*_Y _DZ=_SII*_Y
_E_MC=0
IF(_FIRST==0)
SBLON
N200 G0 G40 G90 AX[_XX]=_RP
SBLOF
ELSE
_FIRST=0
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
_E_MC=1
_E_BO=_BO
SBLON
N205 G0 G9 G40 G90 AX[_YY]=_Y00+_DY AX[_ZZ]=_Z00+_DZ AX[_XX]=_RP
SBLOF
_E_MC=0
_E_BO=_BO
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
F_SP_TRA(2013,,_C0)
REPEAT _NPOS1 _NPOS2
ENDWHILE
ENDIF
IF(_MAN)
N210 G0 G9 G40 G90 AX[_XX]=_RP
ENDIF
ELSE
IF(_TM1==2)
_SII=SIN(_A0)
_CO=COS(_A0)
_DX=_CO*(_L0+_I*_L)
_DY=_SII*(_L0+_I*_L)
_R=SQRT(POT(_X0+_DX)+POT(_Y0+_DY))
_E_MC=0
F_SP_TRA(2023)
IF(_MAN)
ELSE
F_SP_RP(0,_R,_RP,1)
ENDIF
F_SP_TRA(3123)
_XX=$P_AXN1
_YY=$P_AXN2
_ZZ=$P_AXN3
_FIRST=1
WHILE(_FOUND)
_X=_L0+_I*_L
_DX=_CO*_X _DY=_SII*_X
_E_MC=0
IF(_FIRST==0)
SBLON
N300 G0 G40 G90 AX[_ZZ]=_RP
SBLOF
ELSE
_FIRST=0
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
_E_MC=1
SBLON
N320 G0 G9 G40 G90 AX[_XX]=_X0+_DX AX[_YY]=_Y0+_DY AX[_ZZ]=_RP
SBLOF
_E_MC=0
_E_BO=_BO
F_SP_TRA(2123)
REPEAT _NPOS1 _NPOS2
ENDWHILE
ELSE
_SII=SIN(_A0)
_CO=COS(_A0)
_DX=_CO*(_L0+_I*_L)
_DY=_SII*(_L0+_I*_L)
_R=SQRT(POT(_X0+_DX)+POT(_Y0+_DY))
_E_MC=0
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2003+_TM1*10,,_C0)
IF(_TM1==3)
_X00=(_X0+_DX)*COS(-_C0*_F_C_DIR[_F_MASPI/2])+(_Y0+_DY)*SIN(-_C0*_F_C_DIR[_F_MASPI/2])
_Y00=(_Y0+_DY)*COS(-_C0*_F_C_DIR[_F_MASPI/2])-(_X0+_DX)*SIN(-_C0*_F_C_DIR[_F_MASPI/2])
ELSE
_X00=_X0+_DX
_Y00=_Y0+_DY
ENDIF
_XX=$P_AXN1
_YY=$P_AXN2
_ZZ=$P_AXN3
IF(_MAN)
ELSE
F_SP_RP(0,_X00,_RP,1,_Y00)
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N395 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
_FIRST=1
WHILE(_FOUND)
_X=_L0+_I*_L
_DX=_CO*_X _DY=_SII*_X
_E_MC=0
IF(_FIRST==0)
SBLON
N400 G0 G40 G90 AX[_ZZ]=_RP
SBLOF
ELSE
_FIRST=0
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
_E_MC=1
SBLON
N420 G0 G9 G40 G90 AX[_XX]=_X0+_DX AX[_YY]=_Y0+_DY AX[_ZZ]=_RP
SBLOF
_E_MC=0
_E_BO=_BO
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
F_SP_TRA(2003+_TM1*10,,_C0)
REPEAT _NPOS1 _NPOS2
ENDWHILE
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
IF(_MAN)
N430 G0 G9 G40 G90 AX[_ZZ]=_RP
ENDIF
ENDIF
G[29]=_P29
ELSE
IF(_OB==4)
_TMOD=_E_TR[_IDD,1] _Z0=_E_TR[_IDD,3]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
IF(_TM1<=1)
IF(_TM1==0)
F_SP_TRA(2103,_Z0)
ELSE
F_SP_TRA(2013,_Z0)
ENDIF
ELSE
IF(_TM1==2)
F_SP_TRA(2123)
ELSE
F_SP_TRA(2003+_TM1*10)
ENDIF
ENDIF
ELSE
IF(_E_IR>=_E_MAX) GOTOF _FEHL2
_Z0=__Z0
IF(_TMOD MOD 10 ==0)
IF(_BA B_AND 'B01'=='B01')
_Z0=_Z0/2
ENDIF
ENDIF
_E_TR[_E_IR, 0]=SET(-2,_TMOD,_C0,_Z0,_Z0A)
_E_TR[_E_IR, 5]=SET(_X0,_X0A,_Y0,_Y0A,_A0,_L0,_L,_N,_BA)
_E_TS1[_E_IR]=_HIDE
_E_IR=_E_IR+1
IF(_E_POS<1) GOTOF _FEHL3
_E_POS=_E_POS-1
IF(_E_POS==0)
F_MANAGE
ENDIF
ENDIF
ENDIF
_E_S_LINE=0
_RETS:
IF(_E_POS==0)
_F_RELEAS=0
ENDIF
SBLON
RET
_NPOS1:
IF(_INI)
_INI=0
_POS=0
S_ACT_POS=0
_MAX_POS=_N
ENDIF
_FOUND=0
WHILE(_FOUND<=_NUM)AND(_POS<_MAX_POS)
_POS=_POS+1
_I=_POS-1
IF(MATCH(_HIDE,","<<_POS<<",")<0)AND(_POS<=_MAX_POS)
_FOUND=_FOUND+1
ENDIF
ENDWHILE
IF(_FOUND<=_NUM)
_FOUND=0
ELSE
S_ACT_POS=S_ACT_POS+1
ENDIF
_NPOS2:
_FEHL1: STOPRE
N930201 SETAL(61103)
RET
_FEHL2: STOPRE
N930202 SETAL(61200)
RET
_FEHL3: STOPRE
N930203 SETAL(61205)
RET
_FEHL4: STOPRE
N930204 SETAL(61210)
RET
_FEHL5: STOPRE
N930205 SETAL(61211)
RET
_FEHL6: STOPRE
N930206 SETAL(62100)
M0
RET
_FEHL7: STOPRE
N930207 SETAL(61284)
RET
_FEHL8: STOPRE
N930208 SETAL(61118)
RET
_FEHL9: STOPRE
N930209 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_PS_SEQ_SPF
PROC F_PS_SEQ(INT _OB,INT _BO,INT _IDD,INT _TMOD,REAL _C0,REAL __Z0,INT _Z0A,REAL _X0,INT _X0A,REAL _Y0,INT _Y0A,REAL _X1,INT _X1A,REAL _Y1,INT _Y1A,REAL _X2,INT _X2A,REAL _Y2,INT _Y2A,REAL _X3,INT _X3A,REAL _Y3,INT _Y3A,REAL _X4,INT _X4A,REAL _Y4,INT _Y4A,REAL _X5,INT _X5A,REAL _Y5,INT _Y5A,REAL _X6,INT _X6A,REAL _Y6,INT _Y6A,REAL _X7,INT _X7A,REAL _Y7,INT _Y7A,INT _NR,INT _BA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: positions sequential
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _P29,_I,_XA,_YA,_IDM,_NSP,_TRI,_TM1,_TM3,_TM4,_MAN,_PM,S_SSL,S_ACT_POS,S_NUM_POS
DEF REAL _FAK1,_FAK2,_SC,_X,_XP,_Y,_YP,_RP,_TR[8,2],_R,_X00,_Y00,_Z0
DEF BOOL _Y_EXISTS
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF(_OB==0)
IF(_IDD>=0)
_TMOD=_E_TR[_IDD,1] _C0=_E_TR[_IDD,2] _Z0=_E_TR[_IDD,3] _Z0A=_E_TR[_IDD,4]
_IDM=_IDD
_IDD=-1
ENDIF
_P29=$P_GG[29]
DIAMCYCOF
_TM1=_TMOD MOD 10
_MAN=TRUNC(_TMOD/10) MOD 10
_PM=2*(TRUNC(_TMOD/100) MOD 10)-1
_TM4=TRUNC(_TMOD/1000) MOD 10
IF($P_MC==0) GOTOF _FEHL6
_NSP=_E_NSP
IF(_NSP)
S_SSL=1
ENDIF
IF(_NSP>=8) GOTOF _FEHL4
S_ACT_POS=_NSP+1
F_SP_RPT(3,_TMOD)
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RP=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RP=_F_RP_ACT*_FAK2
ENDIF
_F_PS_REF=_Z0*1/_FAK2
IF(_TM1==6)
IF(_RP<=_F_PS_REF+_SC) GOTOF _FEHL8
ENDIF
_E_BO=_BO
_TRI=-1
FOR _I=0 TO 7
_X =_E_TR[_IDM,5+4*_I] _XA=_E_TR[_IDM,6+4*_I]
_Y =_E_TR[_IDM,7+4*_I] _YA=_E_TR[_IDM,8+4*_I]
IF(_XA>0)OR(_YA>0)
IF(_XA==0)
_X=_XP
ELSE
IF(_XA==91)
_X=_X+_XP
ENDIF
ENDIF
IF(_YA==0)
_Y=_YP
ELSE
IF(_YA==91)
_Y=_Y+_YP
ENDIF
ENDIF
_XP=_X
_YP=_Y
IF(_I>=_NSP)
_TRI=_TRI+1
IF(_TM4==0)OR(_TM1==1)
_TR[_TRI,0]=_X
ELSE
_TR[_TRI,0]=((_X MOD 360)+360)MOD 360
ENDIF
_TR[_TRI,1]=_Y
ENDIF
ELSE
_NSP=_NSP+1
IF(_I==0)
_XP=_SC_NO_VAL
_YP=_SC_NO_VAL
ENDIF
ENDIF
ENDFOR
IF(_TRI<0)AND(S_SSL) GOTOF _FEHL4
IF(_TRI<0) GOTOF _FEHL1
S_NUM_POS=S_ACT_POS+_TRI
IF(_F_TRAANG)OR(_F_Y_AXIS)
_Y_EXISTS=TRUE
ELSE
_Y_EXISTS=FALSE
ENDIF
IF(_MAN)
IF(_RP*_PM>_Z0*_PM) GOTOF _FEHL7
ENDIF
IF(_TM1<=1)
IF(_TM1==0)
IF(_TM4==0)
_E_MC=0
F_SP_TRA(2003,_Z0)
IF(_MAN)
ELSE
F_SP_RP(0,_RP,_TR[0,1],1)
ENDIF
F_SP_TRA(3103,_Z0)
_YY=$P_AXN1
_ZZ=$P_AXN2
_XX=$P_AXN3
FOR _I=0 TO _TRI
_E_MC=0
IF(_I>0)
SBLON
N100 G0 G40 G90 AX[_XX]=_RP
SBLOF
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
S_ACT_POS=S_ACT_POS+1
_E_BO=_BO
_E_MC=1
N110 SBLON
N120 G90 G0 G40 AX[_YY]=_TR[_I,0] AX[_ZZ]=_TR[_I,1] AX[_XX]=_RP
N130 SBLOF
_E_MC=0
_E_BO=_BO
F_SP_TRA(2103,_Z0)
ENDFOR
ELSE
_E_MC=0
F_SP_TRA(2003)
IF(_MAN)
ELSE
F_SP_RP(0,_RP,_TR[0,1],1)
ENDIF
F_SP_TRA(1003,_Z0)
_ZZ=$P_AXN2
_CC=_F_S_AX[_F_MASPI]
_XX=$P_AXN3
FOR _I=0 TO _TRI
_E_MC=0
IF(_I>0)
SBLON
N200 G0 G40 G90 AX[_XX]=_RP
SBLOF
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
S_ACT_POS=S_ACT_POS+1
_E_BO=_BO
_E_MC=1
N210 SBLON
N220 G90 G0 G40 AX[_CC]=DC(_TR[_I,0]) AX[_ZZ]=_TR[_I,1] AX[_XX]=_RP
N230 SBLOF
_E_MC=0
_E_BO=_BO
F_SP_TRA(2003)
ENDFOR
ENDIF
IF($ON_TRAFO_TYPE_MASK B_AND 'B10000010')
F_SP_TRA(2103,_Z0)
ELSE
F_SP_TRA(2003,_Z0)
ENDIF
ELSE
_E_MC=0
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2013,,_C0)
IF(_MAN)
ELSE
F_SP_RP(0,_RP,_TR[0,1],1,_TR[0,0])
ENDIF
_YY=$P_AXN1
_ZZ=$P_AXN2
_XX=$P_AXN3
_CC=_F_S_AX[_F_MASPI]
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
SBLON
N290 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
FOR _I=0 TO _TRI
_E_MC=0
IF(_I>0)
SBLON
N300 G0 G40 G90 AX[_XX]=_RP
SBLOF
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
S_ACT_POS=S_ACT_POS+1
_E_BO=_BO
_E_MC=1
N310 SBLON
N320 G90 G0 G40 AX[_YY]=_TR[_I,0] AX[_ZZ]=_TR[_I,1] AX[_XX]=_RP
N330 SBLOF
_E_MC=0
_E_BO=_BO
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
F_SP_TRA(2013,,_C0)
ENDFOR
ENDIF
IF(_MAN)
N350 G0 G9 G40 G90 AX[_XX]=_RP
ENDIF
ELSE
IF(_TM1==2)
IF(_TM4==0)
_R=SQRT(POT(_TR[0,0])+POT(_TR[0,1]))
_E_MC=0
F_SP_TRA(2023)
IF(_MAN)
ELSE
F_SP_RP(0,_R,_RP,1)
ENDIF
F_SP_TRA(3123)
_XX=$P_AXN1
_YY=$P_AXN2
_ZZ=$P_AXN3
FOR _I=0 TO _TRI
_E_MC=0
_R=SQRT(POT(_TR[_I,0])+POT(_TR[_I,1]))
IF(_I>0)
SBLON
N400 G0 G40 G90 AX[_ZZ]=_RP
SBLOF
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
S_ACT_POS=S_ACT_POS+1
_E_BO=_BO
_E_MC=1
N410 SBLON
N420 G90 G0 G40 AX[_XX]=_TR[_I,0] AX[_YY]=_TR[_I,1] AX[_ZZ]=_RP
N430 SBLOF
_E_MC=0
_E_BO=_BO
F_SP_TRA(2123)
ENDFOR
ELSE
_E_MC=0
F_SP_TRA(2023)
IF(_MAN)
ELSE
F_SP_RP(0,_TR[0,1],_RP,1)
ENDIF
F_SP_TRA(1023)
_XX=$P_AXN1
_CC=_F_S_AX[_F_MASPI]
_ZZ=$P_AXN3
FOR _I=0 TO _TRI
_SC_WO=_TR[_I,0]
_E_MC=0
IF(_I>0)
SBLON
N500 G0 G40 G90 AX[_ZZ]=_RP
SBLOF
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
S_ACT_POS=S_ACT_POS+1
_E_MC=1
N510 SBLON
N520 G90 G0 G40 AX[_CC]=DC(_TR[_I,0]) AX[_XX]=_TR[_I,1] AX[_ZZ]=_RP
N530 SBLOF
_E_MC=0
_E_BO=_BO
F_SP_TRA(2023)
ENDFOR
_SC_WO=0;
ENDIF
IF($ON_TRAFO_TYPE_MASK B_AND 'B10000010')
F_SP_TRA(2123)
ELSE
F_SP_TRA(2023)
ENDIF
ELSE
IF(_TM4==0)
_R=SQRT(POT(_TR[0,0])+POT(_TR[0,1]))
_E_MC=0
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2003+_TM1*10,,_C0)
IF(_TM1==3)
_X00=_TR[0,0]*COS(-_C0*_F_C_DIR[_F_MASPI/2])+_TR[0,1]*SIN(-_C0*_F_C_DIR[_F_MASPI/2])
_Y00=_TR[0,1]*COS(-_C0*_F_C_DIR[_F_MASPI/2])-_TR[0,0]*SIN(-_C0*_F_C_DIR[_F_MASPI/2])
ELSE
_X00=_TR[0,0]
_Y00=_TR[0,1]
ENDIF
IF(_MAN)
ELSE
F_SP_RP(0,_X00,_RP,1,_Y00)
ENDIF
_XX=$P_AXN1
_YY=$P_AXN2
_ZZ=$P_AXN3
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N590 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
FOR _I=0 TO _TRI
_E_MC=0
_R=SQRT(POT(_TR[_I,0])+POT(_TR[_I,1]))
IF(_I>0)
SBLON
N600 G0 G40 G90 AX[_ZZ]=_RP
SBLOF
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
S_ACT_POS=S_ACT_POS+1
_E_BO=_BO
_E_MC=1
N610 SBLON
N620 G90 G0 G40 AX[_XX]=_TR[_I,0] AX[_YY]=_TR[_I,1] AX[_ZZ]=_RP
N630 SBLOF
_E_MC=0
_E_BO=_BO
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
F_SP_TRA(2003+_TM1*10,,_C0)
ENDFOR
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ELSE
_E_MC=0
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2003+_TM1*10,,_C0)
IF(_TM1==3)
_X00=_TR[0,1]*COS(_TR[0,0]+_C0*_F_C_DIR[_F_MASPI/2])
_Y00=_TR[0,1]*SIN(_TR[0,0]+_C0*_F_C_DIR[_F_MASPI/2])
ELSE
_X00=_TR[0,1]*COS(_TR[0,0])
_Y00=_TR[0,1]*SIN(_TR[0,0])
ENDIF
IF(_MAN)
ELSE
F_SP_RP(0,_X00,_RP,1,_Y00)
ENDIF
_XX=$P_AXN1
_YY=$P_AXN2
_ZZ=$P_AXN3
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N690 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
FOR _I=0 TO _TRI
_E_MC=0
IF(_I>0)
SBLON
N700 G0 G40 G90 AX[_ZZ]=_RP
SBLOF
ENDIF
WRTPR("POSITIONS("<<S_E_ACT_TECH<<","<<S_E_ACT_POSM<<","<<S_ACT_POS<<","<<S_NUM_POS<<","<<$P_LINENO[0]<<","<<$P_PROG[0]<<")")
S_ACT_POS=S_ACT_POS+1
_E_MC=1
N710 SBLON
N720 G90 G0 G40 AX[_XX]=_TR[_I,1]*COS(_TR[_I,0]) AX[_YY]=_TR[_I,1]*SIN(_TR[_I,0]) AX[_ZZ]=_RP
N730 SBLOF
_E_MC=0
_E_BO=_BO
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
F_SP_TRA(2003+_TM1*10,,_C0)
ENDFOR
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
IF(_MAN)
N750 G0 G9 G40 G90 AX[_ZZ]=_RP
ENDIF
ENDIF
G[29]=_P29
ELSE
IF(_OB==4)
_TMOD=_E_TR[_IDD,1] _Z0=_E_TR[_IDD,3]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
IF(_TM1<=1)
IF(_TM1==0)AND($ON_TRAFO_TYPE_MASK B_AND 'B10000010')
F_SP_TRA(2103,_Z0)
ELSE
F_SP_TRA(2003+_TM1*10,_Z0)
ENDIF
ELSE
IF(_TM1==2)AND($ON_TRAFO_TYPE_MASK B_AND 'B10000010')
F_SP_TRA(2123)
ELSE
F_SP_TRA(2003+_TM1*10)
ENDIF
ENDIF
ELSE
IF(_E_IR>=_E_MAX) GOTOF _FEHL2
_Z0=__Z0
IF(_TMOD MOD 10 ==0)
IF(_BA B_AND 'B01'=='B01')
_Z0=_Z0/2
ENDIF
ENDIF
_E_TR[_E_IR, 0]=SET(-1,_TMOD,_C0,_Z0,_Z0A)
_E_TR[_E_IR, 5]=SET(_X0,_X0A,_Y0,_Y0A,_X1,_X1A,_Y1,_Y1A,_X2,_X2A,_Y2,_Y2A)
_E_TR[_E_IR,17]=SET(_X3,_X3A,_Y3,_Y3A,_X4,_X4A,_Y4,_Y4A,_X5,_X5A,_Y5,_Y5A)
_E_TR[_E_IR,29]=SET(_X6,_X6A,_Y6,_Y6A,_X7,_X7A,_Y7,_Y7A)
_E_IR=_E_IR+1
IF(_E_POS<1) GOTOF _FEHL3
_E_POS=_E_POS-1
IF(_E_POS==0)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
_E_S_LINE=0
_RETS:
IF(_E_POS==0)
_F_RELEAS=0
ENDIF
SBLON
RET
_FEHL1: STOPRE
N980201 SETAL(61103)
RET
_FEHL2: STOPRE
N980202 SETAL(61200)
RET
_FEHL3: STOPRE
N980203 SETAL(61205)
RET
_FEHL4: STOPRE
N980204 SETAL(61210)
RET
_FEHL5: STOPRE
N980205 SETAL(61211)
RET
_FEHL6: STOPRE
N980206 SETAL(62100)
M0
RET
_FEHL7: STOPRE
N980207 SETAL(61284)
RET
_FEHL8: STOPRE
N980208 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_REL_BC_SPF
PROC F_REL_BC(STRING[32] _T,STRING[32] _TF,INT _DD,INT _MODE,INT _MODE1,INT _MODE2,REAL _F1,INT _F1A,REAL __X1,REAL _Z1,REAL _BETA2,INT _BETA2A,REAL _GAMA2,REAL _F3,INT _F3A,REAL __X3,REAL _Z3,REAL _F4,INT _F4A,REAL __X4,REAL _Z4,REAL _BETA5,INT _BETA5A,REAL _GAMA5,REAL _F6,INT _F6A,REAL __X6,REAL _Z6,REAL _Y1,REAL _Y6) SAVE SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.90.00.00.010 ;DATE: 2018-08-24
;ShopTurn: Retract Cycle - BC
DEF AXIS _XX,_YY,_ZZ
DEF INT _FAA,_FAM,_BCMOD,_NF,_ST
DEF REAL _BET,_GAM,_FAK1,_F,_FM,_X,_Y,_Z,_X_MERKER,_Z_MERKER,_X1,_X3,_X4,_X6
DEF STRING [80] _CMD
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
IF(_F1A==4)
_MODE1=_MODE1 B_OR 'H0001'
ENDIF
IF(_F3A==4)
_MODE1=_MODE1 B_OR 'H0040'
ENDIF
IF(_F4A==4)
_MODE1=_MODE1 B_OR 'H0200'
ENDIF
IF(_F6A==4)
_MODE1=_MODE1 B_OR 'H8000'
ENDIF
IF(_MODE B_AND 'B11' == 0)AND(_MODE1==0) GOTOF _RET
_X1=__X1 _X3=__X3 _X4=__X4 _X6=__X6
IF(_MODE B_AND 'B100' == 'B100')
IF((_MODE2 B_AND 'H00002')/'H00002' == 0)
_X1=_X1/2
ENDIF
IF((_MODE2 B_AND 'H00080')/'H00080' == 0)
_X3=_X3/2
ENDIF
IF((_MODE2 B_AND 'H00400')/'H00400' == 0)
_X4=_X4/2
ENDIF
IF((_MODE2 B_AND 'H10000')/'H10000' == 0)
_X6=_X6/2
ENDIF
ENDIF
G40 G90
DIAMCYCOF
IF($P_GG[6]==1)
_XX=$P_AXN1
_ZZ=$P_AXN3
IF(_F_Y_AXIS)
_YY=$P_AXN2
ENDIF
ELSE
IF($P_GG[6]==2)
_XX=$P_AXN2
_ZZ=$P_AXN1
IF(_F_Y_AXIS)
_YY=$P_AXN3
ENDIF
ELSE
_XX=$P_AXN3
_ZZ=$P_AXN2
IF(_F_Y_AXIS)
_YY=$P_AXN1
ENDIF
ENDIF
ENDIF
F_SP_TRA(0)
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_X_MERKER=$P_EP[_XX]*_FAK1 _Z_MERKER=$P_EP[_ZZ]*_FAK1
IF($P_GG[1]==1)
_FAA=4
_CMD="G0 G90 "
ELSE
_FAA=1 _F=$P_F
_CMD="G1 G90 G971 F=_F "
ENDIF
IF(_MODE1 B_AND 'H100007')
_ST=1
IF(_MODE1 B_AND 'H1')
_F=_F1
ELSE
_F=0
ENDIF
_FAA=_F1A
IF(_FAA==4)
_CMD="G0 G90 "
ELSE
_CMD="G1 G90 G971 F=_F "
ENDIF
IF(_MODE1 B_AND 'H2')
IF(_MODE2 B_AND 'H2')
_X=_X_MERKER+_X1
ELSE
_X=_X1
ENDIF
_CMD=_CMD<<"AX[_XX]=_X "
ELSE
_X=_X_MERKER
ENDIF
IF(_MODE1 B_AND 'H4')
IF(_MODE2 B_AND 'H4')
_Z=_Z_MERKER+_Z1
ELSE
_Z=_Z1
ENDIF
_CMD=_CMD<<"AX[_ZZ]=_Z "
ELSE
_Z=_Z_MERKER
ENDIF
IF(_MODE1 B_AND 'H100000')
IF(_MODE2 B_AND 'H100000')
_Y=$P_EP[_YY]*_FAK1+_Y1
ELSE
_Y=_Y1
ENDIF
_CMD=_CMD<<"AX[_YY]=_Y "
ENDIF
ELSE
_ST=0
_X=_X_MERKER _Z=_Z_MERKER
_F=0
_FAA=_F1A
ENDIF
_FM=_F _FAM=_FAA
IF(_ST)
SBLON
EXECSTRING(_CMD)
SBLOF
ENDIF
_BCMOD=107
IF(_MODE1 B_AND 'H30')
IF(_MODE1 B_AND 'H10')
_BET=_BETA2
ELSE
_BET=_SC_A_NO_VAL
ENDIF
IF(_MODE1 B_AND 'H20')
_GAM=_GAMA2
ELSE
_GAM=_SC_A_NO_VAL
ENDIF
IF(_MODE1 B_AND 'H40000')
IF(_MODE2 B_AND 'H40000')
_NF=10
ELSE
_NF=0
ENDIF
_BCMOD=_BCMOD+_NF
ENDIF
N200 F_SP_BC(_BCMOD,_BET,_GAM)
ENDIF
_X_MERKER=$P_EP[_XX]*_FAK1 _Z_MERKER=$P_EP[_ZZ]*_FAK1
IF(_FAM==4)
_FAA=4
_CMD="G0 G90 "
ELSE
_FAA=1 _F=_FM
_CMD="G1 G90 G971 F=_F "
ENDIF
IF(_MODE1 B_AND 'H1C0')
_ST=1
IF(_MODE1 B_AND 'H40')
_F=_F3 _FAA=_F3A
ELSE
_F=_FM _FAA=_FAM
ENDIF
IF(_FAA==4)
_CMD="G0 G90 "
ELSE
_CMD="G1 G90 G971 F=_F "
ENDIF
IF(_MODE1 B_AND 'H80')
IF(_MODE2 B_AND 'H80')
_X=_X3+_X_MERKER
ELSE
_X=_X3
ENDIF
_CMD=_CMD<<"AX[_XX]=_X "
ELSE
_X=_X_MERKER
ENDIF
IF(_MODE1 B_AND 'H100')
IF(_MODE2 B_AND 'H100')
_Z=_Z3+_Z_MERKER
ELSE
_Z=_Z3
ENDIF
_CMD=_CMD<<"AX[_ZZ]=_Z "
ELSE
_Z=_Z_MERKER
ENDIF
ELSE
_ST=0
_X=_X_MERKER _Z=_Z_MERKER
_F=_FM _FAA=_FAM
ENDIF
_FM=_F _FAM=_FAA
IF(_ST)
SBLON
EXECSTRING(_CMD)
SBLOF
ENDIF
IF((_MODE B_AND 'B11')>0)
IF((_MODE B_AND 'B11')==1)
F_TFS(_T,_TF,_DD,,0,,0,0,4)
ELSE
F_TFS(_T,_TF,_DD,,0,,0,0,9)
ENDIF
_F_INIT=1
ENDIF
_X_MERKER=$P_EP[_XX]*_FAK1 _Z_MERKER=$P_EP[_ZZ]*_FAK1
IF($AC_SERUPRO)AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100'))
IF(_E_SEARCH[3]==$P_LINENO[0])
F_SP_LAB
ENDIF
ENDIF
IF(_FAM==4)
_FAA=4
_CMD="G0 G90 "
ELSE
_FAA=1 _F=_FM
_CMD="G1 G90 G971 F=_F "
ENDIF
IF(_MODE1 B_AND 'HE00')
_ST=1
IF(_MODE1 B_AND 'H200')
_F=_F4 _FAA=_F4A
ELSE
_F=_FM _FAA=_FAM
ENDIF
IF(_FAA==4)
_CMD="G0 G90 "
ELSE
_CMD="G1 G90 G971 F=_F "
ENDIF
IF(_MODE1 B_AND 'H400')
IF(_MODE2 B_AND 'H400')
_X=_X_MERKER+_X4
ELSE
_X=_X4
ENDIF
_CMD=_CMD<<"AX[_XX]=_X "
ELSE
_X=_X_MERKER
ENDIF
IF(_MODE1 B_AND 'H800')
IF(_MODE2 B_AND 'H800')
_Z=_Z_MERKER+_Z4
ELSE
_Z=_Z4
ENDIF
_CMD=_CMD<<"AX[_ZZ]=_Z "
ELSE
_Z=_Z_MERKER
ENDIF
ELSE
_ST=0
_X=_X_MERKER _Z=_Z_MERKER
_F=_FM _FAA=_FAM
ENDIF
_FM=_F _FAM=_FAA
IF(_ST)
SBLON
EXECSTRING(_CMD)
SBLOF
ENDIF
_BCMOD=107
IF(_MODE1 B_AND 'H6000')
IF(_MODE1 B_AND 'H2000')
_BET=_BETA5
ELSE
_BET=_SC_A_NO_VAL
ENDIF
IF(_MODE1 B_AND 'H4000')
_GAM=_GAMA5
ELSE
_GAM=_SC_A_NO_VAL
ENDIF
IF(_MODE1 B_AND 'H80000')
IF(_MODE2 B_AND 'H80000')
_NF=10
ELSE
_NF=0
ENDIF
_BCMOD=_BCMOD+_NF
ENDIF
N500 F_SP_BC(_BCMOD,_BET,_GAM)
ENDIF
_X_MERKER=$P_EP[_XX]*_FAK1 _Z_MERKER=$P_EP[_ZZ]*_FAK1
IF(_FAM==4)
_FAA=4
_CMD="G0 G90 "
ELSE
_FAA=1 _F=_FM
_CMD="G1 G90 G971 F=_F "
ENDIF
IF(_MODE1 B_AND 'H238000')
_ST=1
IF(_MODE1 B_AND 'H8000')
_F=_F6 _FAA=_F6A
ELSE
_F=_FM _FAA=_FAM
ENDIF
IF(_FAA==4)
_CMD="G0 G90 "
ELSE
_CMD="G1 G90 G971 F=_F "
ENDIF
IF(_MODE1 B_AND 'H10000')
IF(_MODE2 B_AND 'H10000')
_X=_X6+_X_MERKER
ELSE
_X=_X6
ENDIF
_CMD=_CMD<<"AX[_XX]=_X "
ENDIF
IF(_MODE1 B_AND 'H20000')
IF(_MODE2 B_AND 'H20000')
_Z=_Z6+_Z_MERKER
ELSE
_Z=_Z6
ENDIF
_CMD=_CMD<<"AX[_ZZ]=_Z "
ENDIF
IF(_MODE1 B_AND 'H100000')
IF(_MODE2 B_AND 'H100000')
_Y=$P_EP[_YY]*_FAK1+_Y6
ELSE
_Y=_Y6
ENDIF
_CMD=_CMD<<"AX[_YY]=_Y "
ENDIF
ELSE
_ST=0 _F=_FM _FAA=_FAM
ENDIF
IF(_ST)
SBLON
EXECSTRING(_CMD)
SBLOF
ENDIF
_F_RELEAS=1
_RET:
_RETS:
SBLON
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_RELEAS_SPF
PROC F_RELEAS(STRING[32] _T,STRING[32] _TF,INT _DD,INT _MODE,INT _MODE1,INT _MODE2,REAL _F1,INT _F1A,REAL __X1,REAL _Z1,REAL _F2,INT _F2A,REAL __X2,REAL _Z2,REAL _F3,INT _F3A,REAL __X3,REAL _Z3,REAL _F4,INT _F4A,REAL __X4,REAL _Z4,REAL _F5,INT _F5A,REAL __X5,REAL _Z5,REAL _F6,INT _F6A,REAL __X6,REAL _Z6) SAVE SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 02.06.17.00 ;DATE: 2009-05-26
;ShopTurn: Retract Cycle
DEF AXIS _XX,_ZZ
DEF INT _MASK1,_MASK2,_I,_II,_ST[6],_FAA[6]
DEF REAL _X[6],_Z[6],_F[6],_FAK1,_X_MERKER,_Z_MERKER,_X1,_X2,_X3,_X4,_X5,_X6
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
IF(_MODE B_AND 'B11' == 0)AND(_MODE1==0) GOTOF _RET
_X1=__X1 _X2=__X2 _X3=__X3 _X4=__X4 _X5=__X5 _X6=__X6
IF(_MODE B_AND 'B100' == 'B100')
IF((_MODE2 B_AND 'H00002')/'H00002' == 0)
_X1=_X1/2
ENDIF
IF((_MODE2 B_AND 'H00010')/'H00010' == 0)
_X2=_X2/2
ENDIF
IF((_MODE2 B_AND 'H00080')/'H00080' == 0)
_X3=_X3/2
ENDIF
IF((_MODE2 B_AND 'H00400')/'H00400' == 0)
_X4=_X4/2
ENDIF
IF((_MODE2 B_AND 'H02000')/'H02000' == 0)
_X5=_X5/2
ENDIF
IF((_MODE2 B_AND 'H10000')/'H10000' == 0)
_X6=_X6/2
ENDIF
ENDIF
DIAMCYCOF
IF($P_GG[6]==1)
_XX=$P_AXN1
_ZZ=$P_AXN3
ELSE
IF($P_GG[6]==2)
_XX=$P_AXN2
_ZZ=$P_AXN1
ELSE
_XX=$P_AXN3
_ZZ=$P_AXN2
ENDIF
ENDIF
N10 G40 G90
F_SP_TRA(0)
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_X_MERKER=$P_EP[_XX]*_FAK1 _Z_MERKER=$P_EP[_ZZ]*_FAK1
_I=0
_MASK1='B111'
_MASK2='B1'
IF(_MODE1 B_AND _MASK1)
_ST[_I]=1
IF(_MODE1 B_AND _MASK2)
_F[_I]=_F1
ELSE
_F[_I]=0
ENDIF
_FAA[_I]=_F1A
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
IF(_MODE2 B_AND _MASK2)
_X[_I]=_X1+_X_MERKER
ELSE
_X[_I]=_X1
ENDIF
ELSE
_X[_I]=_X_MERKER
ENDIF
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
IF(_MODE2 B_AND _MASK2)
_Z[_I]=_Z1+_Z_MERKER
ELSE
_Z[_I]=_Z1
ENDIF
ELSE
_Z[_I]=_Z_MERKER
ENDIF
ELSE
_ST[_I]=0
_X[_I]=_X_MERKER
_Z[_I]=_Z_MERKER
_F[_I]=0
_FAA[_I]=_F1A
_MASK2=_MASK2*4
ENDIF
_I=_I+1
_MASK1=_MASK1*8
IF(_MODE1 B_AND _MASK1)
_ST[_I]=1
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
_F[_I]=_F2
_FAA[_I]=_F2A
ELSE
_F[_I]=_F[_I-1]
IF(_F2A<>4)
_FAA[_I]=_FAA[_I-1]
ELSE
_FAA[_I]=4
ENDIF
ENDIF
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
IF(_MODE2 B_AND _MASK2)
_X[_I]=_X[_I-1]+_X2
ELSE
_X[_I]=_X2
ENDIF
ELSE
_X[_I]=_X[_I-1]
ENDIF
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
IF(_MODE2 B_AND _MASK2)
_Z[_I]=_Z[_I-1]+_Z2
ELSE
_Z[_I]=_Z2
ENDIF
ELSE
_Z[_I]=_Z[_I-1]
ENDIF
ELSE
_ST[_I]=0
_X[_I]=_X[_I-1]
_Z[_I]=_Z[_I-1]
_F[_I]=_F[_I-1]
IF(_F2A<>4)
_FAA[_I]=_FAA[_I-1]
ELSE
_FAA[_I]=4
ENDIF
_MASK2=_MASK2*8
ENDIF
_I=_I+1
_MASK1=_MASK1*8
IF(_MODE1 B_AND _MASK1)
_ST[_I]=1
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
_F[_I]=_F3
_FAA[_I]=_F3A
ELSE
_F[_I]=_F[_I-1]
IF(_F3A<>4)
_FAA[_I]=_FAA[_I-1]
ELSE
_FAA[_I]=4
ENDIF
ENDIF
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
IF(_MODE2 B_AND _MASK2)
_X[_I]=_X[_I-1]+_X3
ELSE
_X[_I]=_X3
ENDIF
ELSE
_X[_I]=_X[_I-1]
ENDIF
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
IF(_MODE2 B_AND _MASK2)
_Z[_I]=_Z[_I-1]+_Z3
ELSE
_Z[_I]=_Z3
ENDIF
ELSE
_Z[_I]=_Z[_I-1]
ENDIF
ELSE
_ST[_I]=0
_X[_I]=_X[_I-1]
_Z[_I]=_Z[_I-1]
_F[_I]=_F[_I-1]
IF(_F3A<>4)
_FAA[_I]=_FAA[_I-1]
ELSE
_FAA[_I]=4
ENDIF
_MASK2=_MASK2*8
ENDIF
IF(_ST[0]==0)AND(_ST[1]==0)AND(_ST[2]==0)AND(_MODE B_AND 'B11' ==0)
GOTOF _MEND
ENDIF
FOR _II=0 TO 2
IF(_ST[_II])
SBLON
IF(_FAA[_II]==4)
N100 G0 AX[_XX]=_X[_II] AX[_ZZ]=_Z[_II]
ELSE
N110 G1 G971 AX[_XX]=_X[_II] AX[_ZZ]=_Z[_II] F=_F[_II]
ENDIF
SBLOF
ENDIF
ENDFOR
IF(_II==2)AND(_MODE B_AND 'B11' >0)
IF(_MODE B_AND 'B11' ==1)
F_TFS(_T,_TF,_DD,,0,,0,0,4)
ELSE
F_TFS(_T,_TF,_DD,,0,,0,0,9)
ENDIF
_F_INIT=1
ENDIF
_X_MERKER=$P_EP[_XX]*_FAK1 _Z_MERKER=$P_EP[_ZZ]*_FAK1
_MEND:
_I=_I+1
_MASK1=_MASK1*8
IF(_MODE1 B_AND _MASK1)
_ST[_I]=1
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
_F[_I]=_F4
_FAA[_I]=_F4A
ELSE
IF(_MODE B_AND 'B11' ==0)
_F[_I]=_F[_I-1]
_FAA[_I]=_FAA[_I-1]
ELSE
_F[_I]=0
_FAA[_I]=_F4A
ENDIF
ENDIF
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
IF(_MODE2 B_AND _MASK2)
IF(_MODE B_AND 'B11' ==0)
_X[_I]=_X[_I-1]+_X4
ELSE
_X[_I]=_X4+_X_MERKER
ENDIF
ELSE
_X[_I]=_X4
ENDIF
ELSE
_X[_I]=_X_MERKER
ENDIF
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
IF(_MODE2 B_AND _MASK2)
IF(_MODE B_AND 'B11' ==0)
_Z[_I]=_Z[_I-1]+_Z4
ELSE
_Z[_I]=_Z_MERKER+_Z4
ENDIF
ELSE
_Z[_I]=_Z4
ENDIF
ELSE
_Z[_I]=_Z_MERKER
ENDIF
ELSE
_ST[_I]=0
IF(_MODE B_AND 'B11' ==0)
_X[_I]=_X[_I-1]
_Z[_I]=_Z[_I-1]
_F[_I]=_F[_I-1]
_FAA[_I]=_FAA[_I-1]
ELSE
_X[_I]=_X_MERKER
_Z[_I]=_Z_MERKER
_F[_I]=0
_FAA[_I]=_FAA[_I-1]
ENDIF
_MASK2=_MASK2*8
ENDIF
_I=_I+1
_MASK1=_MASK1*8
IF(_MODE1 B_AND _MASK1)
_ST[_I]=1
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
_F[_I]=_F5
_FAA[_I]=_F5A
ELSE
_F[_I]=_F[_I-1]
IF(_F5A<>4)
_FAA[_I]=_FAA[_I-1]
ELSE
_FAA[_I]=4
ENDIF
ENDIF
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
IF(_MODE2 B_AND _MASK2)
_X[_I]=_X[_I-1]+_X5
ELSE
_X[_I]=_X5
ENDIF
ELSE
_X[_I]=_X[_I-1]
ENDIF
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
IF(_MODE2 B_AND _MASK2)
_Z[_I]=_Z[_I-1]+_Z5
ELSE
_Z[_I]=_Z5
ENDIF
ELSE
_Z[_I]=_Z[_I-1]
ENDIF
ELSE
_ST[_I]=0
_X[_I]=_X[_I-1]
_Z[_I]=_Z[_I-1]
_F[_I]=_F[_I-1]
IF(_F5A<>4)
_FAA[_I]=_FAA[_I-1]
ELSE
_FAA[_I]=4
ENDIF
_MASK2=_MASK2*8
ENDIF
_I=_I+1
_MASK1=_MASK1*8
IF(_MODE1 B_AND _MASK1)
_ST[_I]=1
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
_F[_I]=_F6
_FAA[_I]=_F6A
ELSE
_F[_I]=_F[_I-1]
IF(_F6A<>4)
_FAA[_I]=_FAA[_I-1]
ELSE
_FAA[_I]=4
ENDIF
ENDIF
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
IF(_MODE2 B_AND _MASK2)
_X[_I]=_X[_I-1]+_X6
ELSE
_X[_I]=_X6
ENDIF
ELSE
_X[_I]=_X[_I-1]
ENDIF
_MASK2=_MASK2*2
IF(_MODE1 B_AND _MASK2)
IF(_MODE2 B_AND _MASK2)
_Z[_I]=_Z[_I-1]+_Z6
ELSE
_Z[_I]=_Z6
ENDIF
ELSE
_Z[_I]=_Z[_I-1]
ENDIF
ELSE
_ST[_I]=0
_X[_I]=_X[_I-1]
_Z[_I]=_Z[_I-1]
_F[_I]=_F[_I-1]
IF(_F6A<>4)
_FAA[_I]=_FAA[_I-1]
ELSE
_FAA[_I]=4
ENDIF
_MASK2=_MASK2*8
ENDIF
N150 G90
FOR _II=3 TO 5
IF(_ST[_II])
SBLON
IF(_FAA[_II]==4)
N200 G0 AX[_XX]=_X[_II] AX[_ZZ]=_Z[_II]
ELSE
N210 G1 G971 AX[_XX]=_X[_II] AX[_ZZ]=_Z[_II] F=_F[_II]
ENDIF
SBLOF
ENDIF
ENDFOR
_F_RELEAS=1
_RET:
_RETS:
SBLON
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_ROT_C_SPF
PROC F_ROT_C(REAL _ANG,INT _ANGA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.04.12.00 ;DATE: 2011-03-17
;ShopTurn: C-Translation Cycle
F_SP_TRA(300)
F_SP_TRA(0)
IF(_ANGA)
$P_PFRAME[_F_S_AX[_F_MASPI],TR]=$P_PFRAME[_F_S_AX[_F_MASPI],TR]+_ANG
ELSE
$P_PFRAME[_F_S_AX[_F_MASPI],TR]=_ANG
ENDIF
G4 F0
F_SP_TRA(200)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_ROU_Z_SPF
PROC F_ROU_Z(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _MODE,INT _TMOD,STRING[70] _NP1,STRING[32] _NP2,STRING[32] _NP3,STRING[70] _NP4,STRING[70] _NP5,STRING[32] _NP6,STRING[32] _NP7,STRING[70] _NP8,INT _VARI,REAL _FR,REAL _DX,REAL _DZ,REAL _D,INT _DA,REAL _UX,REAL _UZ,REAL _U,INT _UA,REAL _U1,INT _U1A,INT _BLANK,REAL _APX,INT _APXA,REAL _APZ,INT _APZA,INT _BORDER,REAL __XA,REAL _ZA,REAL __XB,REAL _ZB,REAL __XS,REAL __ZS,REAL __XR1,REAL __XR2,_E_MAC_ROU_Z) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Extended Stock Removal cycle
DEF AXIS _XX,_YY,_ZZ,_CC,_AX1,_AX2,_AX3
DEF INT _I,_P29,_VARI_10,__VARI,_GMODE,_DMODE,_AMODE,_GG10,_WM,_TM8,_MAN,S_MODE_BC,_AI,_LP,S_XAI,S_IPT,S_PL,_TM1,_TCI,_NPV,S_Y_TURN,S_C805_AMODE
DEF REAL _XS,_ZS,_XA,_XB,_XR1,_XR2,_FAK1,_FAK2,_RP,_SC,_XRPM,_YRPM,_ZRPM,S_ROT_Z,_SD,_RTP,S_A1TC,S_A2TC
DEF STRING[20] S_CHAN
DEF STRING[32] _TC
DEF FRAME _CYC_FR,_WPFR
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
IF(_E_S_LINE)
IF(_E_S_LINE==$P_LINENO[0])
_E_S_LINE=0
ELSE
IF(_SC_CHAN_ST=="")
GOTOF _RETS
ENDIF
ENDIF
ENDIF
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_ROU_Z_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
ENDIF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF(_VARI _DEC3 == 4)OR(_VARI _DEC3 == 5)
IF(_SC_CHAN_ST=="")
IF(NOT(_BA B_AND 'B10000'))
GOTOF _FEHL1
ELSE
GOTOF _FEHL0
ENDIF
ENDIF
_WM=104
REPEAT _SYNC_A _SYNC_E
IF(NOT(_BA B_AND 'B10000'))
_SC_NCK_ROU_R[0]=_VARI _DEC2
_SC_NCK_ROU_R[1]=_F
_SC_NCK_ROU_R[2]=_FAA
_SC_NCK_ROU_R[3]=_S
_SC_NCK_ROU_R[4]=_SA
_SC_NCK_ROU_R[5]=_DCH
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fhrungskanal: F="<<_F<<" S="<<_S)
ENDIF
IF(_DCH<0)
IF(_SA==1)
N10 G972 S=_S
ENDIF
IF(_SA==2)
N12 G962 S=_S
ENDIF
_S=0
_SA=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fhrungskanal: F="<<_F<<" S="<<_S)
ENDIF
ENDIF
_WM=105
REPEAT _SYNC_A _SYNC_E
IF(_BA B_AND 'B10000')
_VARI=_VARI-10*(_VARI _DEC2)+10*_SC_NCK_ROU_R[0]
_F =_SC_NCK_ROU_R[1]
_FAA =_SC_NCK_ROU_R[2]
_DCH=_SC_NCK_ROU_R[5]
IF(_DCH<0)
_S=_SC_NCK_ROU_R[3]
_SA=_SC_NCK_ROU_R[4]
ELSE
_S=0
_SA=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Folgekanal: F="<<_F)
ENDIF
ENDIF
_WM=104
REPEAT _SYNC_A _SYNC_E
IF(_BA B_AND 'B10000')
_SC_NCK_ROU_R[0]=REP(0,5)
ENDIF
_WM=105
REPEAT _SYNC_A _SYNC_E
ENDIF
_VARI_10=(_VARI MOD 100) DIV 10
_MAN=_TMOD _DEC2
IF(_MAN)
F_SP_INI(0)
ENDIF
IF(_TMOD _DEC9)==1
S_IPT=1
ENDIF
IF(_TMOD _DEC9)==3
S_Y_TURN=1
ENDIF
_TM1=_TMOD MOD 10
_C0=((_C0 MOD 360)+360)MOD 360
_P29=$P_GG[29]
DIAMCYCOF
_CYC_FR=$P_CYCFRAME
IF(_MAN)
IF($MCS_TECHNOLOGY==2)
N20 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=0
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
N21 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
N22 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
ELSE
_F_RELEAS=0
IF(_MAN==2)
_F_MASPI=2
ELSE
_F_MASPI=0
ENDIF
_F_INIT=1
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N15 F_TFS(_T,,_DD,,,,,_F_MASPI+1,8)
F_SP_TRA(2040)
N16 F_SP_BC(104,_BETA,_GAMA)
N17 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,_F_MASPI+1,7)
ELSE
N18 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,_F_MASPI+1,8)
F_SP_TRA(2040)
ENDIF
ENDIF
ELSE
IF(_E_SM_PRG)
IF(S_IPT==1)
IF($PC_TRAFO_TYPE_NAME=="TRAORI_STAT")
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: DFM -> M5")
WRITE(_LOG,_LOG_FILE,"IPT: DFM -> SPOS=0")
ENDIF
M[_F_S_NR[_F_MASPI]]=5
SPOS[_F_S_NR[_F_MASPI]]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N333 E_TFS")
ENDIF
N333 E_TFS(_T,_TF,_DD,,,,,11)
TRAFOOF
G18
IF(_GAMA==180)
_XX=$P_AXN2
$P_CYCFRAME=$P_CYCFRAME:CMIRROR(_XX)
ENDIF
ELSE
N30 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=S_FR_M
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
_ZZ=$P_AXN1
S_ROT_Z=$P_ACTFRAME[_ZZ,RT]
N31 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
IF($P_ACTFRAME[_ZZ,RT]<>S_ROT_Z)
IF($P_EP[_ZZ]*_FAK1<_F_RPT[1]*_FAK2)
SBLON
N315 G0 G90 AX[_ZZ]=_F_RPT[1]*_FAK2
SBLOF
ENDIF
ENDIF
N320 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
ENDIF
ELSE
IF(S_IPT==1)
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_F_TRAMA _DEC2 ==6)
_TCI=$P_TC
S_A1TC=$P_TCANG[1]
S_A2TC=$P_TCANG[2]
_NPV=$P_GG[8]
_WPFR=$P_WPFRAME
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Stirn B vor N250 F_TFS")
WRITE(_LOG,_LOG_FILE,"  _F_TRAMA="<<_F_TRAMA)
WRITE(_LOG,_LOG_FILE,"  $P_TC="<<$P_TC)
WRITE(_LOG,_LOG_FILE,"  _TC_A1="<<_TC_A1)
WRITE(_LOG,_LOG_FILE,"  _TC_A2="<<_TC_A2)
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[1]="<<$P_TCANG[1])
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[2]="<<$P_TCANG[2])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR13[_TCI]="<<$TC_CARR13[_TCI])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR14[_TCI]="<<$TC_CARR14[_TCI])
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N250 F_TFS")
ENDIF
N250 F_TFS(_T,_TF,_DD,,,,,1,0)
IF(_TCI)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Stirn B nach N250 F_TFS")
WRITE(_LOG,_LOG_FILE,"  _F_TRAMA="<<_F_TRAMA)
WRITE(_LOG,_LOG_FILE,"  $P_TC="<<$P_TC)
WRITE(_LOG,_LOG_FILE,"  _TC_A1="<<_TC_A1)
WRITE(_LOG,_LOG_FILE,"  _TC_A2="<<_TC_A2)
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[1]="<<$P_TCANG[1])
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[2]="<<$P_TCANG[2])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR13[_TCI]="<<$TC_CARR13[_TCI])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR14[_TCI]="<<$TC_CARR14[_TCI])
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N800 CYCLE800 direkt: "<<S_A1TC<<"/"<<S_A2TC)
ENDIF
N800 CYCLE800(0,$TC_CARR34[_TCI],220000,192,0,0,0,S_A1TC,S_A2TC,0,0,0,0,0,0,1001)
$P_WPFRAME=_WPFR
$P_WPFR=$P_WPFRAME
G[8]=_NPV
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: G18 TRAFOOF")
ENDIF
F_SP_TRA(2040)
_XX=$P_AXN2
IF(NOT _TCI)
N255 F_SP_BC(4,_SC_A_NO_VAL,0)
ENDIF
IF(_GAMA==180)
$P_CYCFRAME=$P_CYCFRAME:CMIRROR(_XX)
ENDIF
ELSE
IF S_Y_TURN
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Y-Drehen")
ENDIF
N1800 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
IF(_SC_Y_TURN)
IF(_SC_Y_TURN_GAMA<>_GAMA)
F_SP_RP(1,,,1)
ENDIF
IF(_BA B_AND 'H1000000' == 'H1000000')
IF(_SC_Y_TURN==-90)
F_SP_RP(1,,,1)
ENDIF
ELSE
IF(_SC_Y_TURN==90)
F_SP_RP(1,,,1)
ENDIF
ENDIF
ENDIF
IF(_F_TC_DEF[2]==0)
_TC=""
ELSE
_TC=$TC_CARR34[_F_TC_DEF[2]]
ENDIF
IF(_BA B_AND 'H1000000' == 'H1000000')
S_C805_AMODE=1000
ENDIF
N1805 CYCLE805(1,_TC,_GAMA,,,,S_C805_AMODE)
N1810 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,7)
ELSE
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N25 F_TFS(_T,_TF,_DD,,,,,1,0)
IF(_VARI _DEC3 == 4)OR(_VARI _DEC3 == 5)
IF(NOT(_BA B_AND 'B10000'))
_WM=104
REPEAT _SYNC_A _SYNC_E
ENDIF
ENDIF
F_SP_TRA(2040)
N26 F_SP_BC(4,_BETA,_GAMA)
N27 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,7)
ELSE
N28 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,0)
IF(_VARI _DEC3 == 4)OR(_VARI _DEC3 == 5)
IF(NOT(_BA B_AND 'B10000'))
_WM=104
REPEAT _SYNC_A _SYNC_E
ENDIF
ENDIF
F_SP_TRA(2040)
ENDIF
IF(_VARI _DEC3 == 4)OR(_VARI _DEC3 == 5)
IF(_BA B_AND 'B10000')
_WM=104
REPEAT _SYNC_A _SYNC_E
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
_GG10=$P_GG[10]
IF(_GG10<2)
_GG10=2
ENDIF
N200 G40 G[10]=_GG10 G90
IF(_NP4<>"")
_NP4="/_N_WKS_DIR/_N_TEMP_WPD/_N_"<<_NP4<<"_MPF"
ENDIF
IF(_NP5<>"")
_NP5="/_N_WKS_DIR/_N_TEMP_WPD/_N_"<<_NP5<<"_MPF"
ENDIF
IF(_NP8<>"")
_NP8="/_N_WKS_DIR/_N_TEMP_WPD/_N_"<<_NP8<<"_MPF"
ENDIF
IF(_MAN==0)AND(S_IPT==0)
F_SP_RPT(0,(_VARI_10-1)*2)
ENDIF
IF(_MAN==0)
IF(_VARI_10<=2)
_RP=_F_RP_ACT*_FAK2*2
ELSE
_RP=_F_RP_ACT*_FAK2
ENDIF
IF(S_IPT==0)
S_RPI=_RP
ENDIF
ENDIF
_XX=$P_AXN2 _ZZ=$P_AXN1
IF(_F_Y_AXIS==1)
_YY=$P_AXN3
ENDIF
IF(_MAN)
_XRPM=$P_EP[_XX]*_FAK1 _ZRPM=$P_EP[_ZZ]*_FAK1
IF(_F_Y_AXIS==1)
_YRPM=$P_EP[_YY]*_FAK1
ENDIF
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_F_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
ELSE
_SC=_E_SC*_FAK2
ENDIF
__VARI=0
__VARI=__VARI+ 1*(_VARI MOD 10)
__VARI=__VARI+ 10*((_VARI DIV 100) MOD 10)
__VARI=__VARI+ 100*((_VARI DIV 100000) MOD 10)
__VARI=__VARI+ 1000*((_VARI DIV 10) MOD 10)
__VARI=__VARI+ 10000*_UA
__VARI=__VARI+ 100000*((_VARI DIV 1000) MOD 10)
__VARI=__VARI+ 1000000*((_VARI DIV 10000) MOD 10)
__VARI=__VARI+10000000*0
_GMODE=0
IF(_BORDER B_AND 'B0000001')
_GMODE=_GMODE+1000
ENDIF
IF(NOT(_BORDER B_AND 'B0001000'))
_GMODE=_GMODE+10000
ENDIF
IF(NOT(_BORDER B_AND 'B0010000'))
_GMODE=_GMODE+100000
ENDIF
IF(NOT(_BORDER B_AND 'B0100000'))
_GMODE=_GMODE+1000000
ENDIF
IF(NOT(_BORDER B_AND 'B1000000'))
_GMODE=_GMODE+10000000
ENDIF
_DMODE=0
_DMODE=_DMODE+10*((_MODE MOD 10)+1)
_DMODE=_DMODE+100*(_MODE DIV 10)
_TM8=TRUNC(_TMOD/10000000) MOD 10
IF((_TM8==1)AND((_MODE==0)OR(_MODE==1)OR(_MODE==2)))
_DMODE=_DMODE+10000
ENDIF
_AMODE=0
IF(_DA B_AND 'B001')
_AMODE=_AMODE+1
ENDIF
IF(_DA B_AND 'B010')
_AMODE=_AMODE+10
ENDIF
IF(NOT(_DA B_AND 'B100'))
_AMODE=_AMODE+100
ENDIF
_AMODE=_AMODE+1000*_U1A
IF(_NP8<>"")
_AMODE=_AMODE+10000
ENDIF
_AMODE=_AMODE+100000*(_APXA MOD 10)
_AMODE=_AMODE+1000000*(_APZA MOD 10)
IF(NOT(_BORDER B_AND 'B0000010'))
_AMODE=_AMODE+10000000
ENDIF
IF(NOT(_BORDER B_AND 'B0000100'))
_AMODE=_AMODE+100000000
ENDIF
IF(_BA B_AND 'B10000')
_AMODE=_AMODE+1000000000
ENDIF
_XA=__XA
_XB=__XB
_XS=__XS/2
_ZS=__ZS
_XR1=__XR1
_XR2=__XR2
IF((_BA B_AND 'B1')==0)
IF(_BLANK==1)AND((_APXA MOD 10)==0)
_APX=_APX*2
ENDIF
_XA=_XA*2
IF(_BORDER B_AND 'B0000010')
_XB=_XB*2
ENDIF
_XS=__XS
_XR1=_XR1*2
_XR2=_XR2*2
ENDIF
IF((_VARI _DEC2)<=2)
_LP=1
ELSE
_LP=0
ENDIF
IF((_VARI _DEC2)B_AND 1)
_AI=1
ELSE
_AI=-1
ENDIF
IF(_LP)
S_XAI=MAXVAL(_AI,0)
ELSE
S_XAI=2-(_VARI _DEC6)
ENDIF
IF(_N<1)
_N=1
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Startpunkt berechnen:")
ENDIF
IF(S_IPT==1)
IF($P_CUTMOD)
CUTMOD=0
ENDIF
IF($P_CUTMODK<>"")
CUTMODK="CLEAR"
ENDIF
ENDIF
N220 CYCLE952(_NP4,_NP5,_NP8,__VARI,_F,_FR,S_RPI,_D,_DX,_DZ,_UX,_UZ,_U,_U1,_BLANK,_APX,_APZ,_XA,_ZA,_XB,_ZB,_XR1,_XR2,_N,_P,_DI,_E_SC*_FAK2,,_GMODE+200,_DMODE,_AMODE,_PK,_DCH,_FS)
_XS=_SC_POS[1]
_ZS=_SC_POS[0]
_XE=_SC_POS[5]
_ZE=_SC_POS[4]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_SC_POS[0]="<<_SC_POS[0]<<" _SC_POS[1]="<<_SC_POS[1]<<" _SC_POS[2]="<<_SC_POS[2]<<" _SC_POS[3]="<<_SC_POS[3]<<" _SC_POS[4]="<<_SC_POS[4]<<" _SC_POS[5]="<<_SC_POS[5])
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  XS="<<_XS<<" ZS="<<_ZS<<" / XE="<<_XE<<" ZE="<<_ZE)
ENDIF
IF(S_IPT==1)
IF((_VARI _DEC1)==3)
IF(S_XAI)
_XS=MAXVAL(_XS,_XE)
ELSE
_XS=MINVAL(_XS,_XE)
ENDIF
ENDIF
IF(_GAMA==180)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Gamma 180 -> Spiegelung X entfernt")
ENDIF
$P_CYCFRAME=$P_CYCFRAME:CMIRROR(_XX)
ENDIF
IF(_E_SM_PRG)
ELSE
IF(_GAMA==180)
_XS=_XS-2*$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]
ENDIF
ENDIF
IF((_VARI _DEC1)==3)
_XS=_XS+(_DX+_SC)*(2*S_XAI-1)
ELSE
IF(_LP==1)
_XS=_XS+(_D+_SC)*_AI
ENDIF
ENDIF
IF(_E_SM_PRG)
E_SP_ED(_SD)
_RP=_E_RP*_FAK2
_RTP=_RP-_SD
G17
N310 E_SP_RP(2,_RTP,S_XC,S_YC,_RTP)
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: F_SP_BC")
ENDIF
F_SP_BC(_TM1)
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2
_RTP=_RP
IF(_TM1==1)
F_SP_TRA(2012,,_C0)
F_SP_RP(0,_RP,_YS,0,_XS)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N32 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
F_SP_RP(9,S_XC+_XS,_RP,0,S_YC)
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N33 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2 _AX3=$P_AXN3
IF(_F_RELEAS==0)
SBLON
N34 G90 G0 G40 AX[_AX1]=S_XC+_XS AX[_AX2]=S_YC AX[_AX3]=_RP
N340 G90 G0 G40 AX[_AX3]=_ZS
SBLOF
ENDIF
ENDIF
ENDIF
IF($MCS_TECHNOLOGY==2)
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H0000')
DIAM90
ELSE
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H8000')
DIAMON
ELSE
DIAMOF
ENDIF
ENDIF
IF(S_IPT==0)
_P29=$P_GG[29]
ENDIF
DIAMCYCOF
ENDIF
IF(S_IPT==1)
IF(_E_SM_PRG)
S_PL=_E_PLANE
ELSE
IF(_TM1==1)
S_PL=3
ELSE
S_PL=1
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N806 Anwahl Interpolationsdrehen")
ENDIF
IF(_E_SM_PRG)
N806 CYCLE806(0001,S_XC,S_YC,_GAMA,_S,_SV2,5,_SA-1+100,S_PL,S_TRA,2*_XS,_RP)
SBLON
G4 F0
SBLOF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N334 E_TFS")
ENDIF
N334 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
SBLON
G4 F0
SBLOF
ELSE
N806 CYCLE806(0001,S_XC,S_YC,_GAMA,_S,_SV2,5,_SA-1,S_PL,S_TRA)
SBLON
G4 F0
SBLOF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N251 F_TFS")
ENDIF
N251 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,,0)
SBLON
G4 F0
SBLOF
ENDIF
DIAMCYCOF
SBLON
N810 G0 G90 AX[_ZZ]=_ZS
SBLOF
ELSE
IF S_Y_TURN
SBLON
IF($P_EP[_ZZ]*_FAK1<_F_RPT[1]*_FAK2)AND($P_EP[_YY]<>0)
N1840 G0 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
IF($P_EP[_ZZ]*_FAK1>_F_RPT[1]*_FAK2)
N1850 G0 AX[_XX]=_F_RPT[0]*_FAK2 AX[_ZZ]=_F_RPT[1]*_FAK2
ELSE
N1860 G0 AX[_XX]=_F_RPT[0]*_FAK2
ENDIF
N1870 G0 AX[_YY]=0
N1880 G0 AX[_ZZ]=_ZS
N1890 G0 G90 AX[_XX]=_XS AX[_ZZ]=_ZS
SBLOF
ELSE
IF(_MAN)
SBLON
IF(_F_Y_AXIS==1)
N360 G90 G0 AX[_YY]=0
ENDIF
N35 G0 G90 AX[_XX]=_XS AX[_ZZ]=_ZS
SBLOF
ELSE
IF((_VARI _DEC2)==1)
N361 F_SP_RP(20,_XS,_ZS)
N362 F_SP_RP(21,_XE,_ZE)
ENDIF
IF((_VARI _DEC2)==2)
N363 F_SP_RP(22,_XS,_ZS)
N364 F_SP_RP(23,_XE,_ZE)
ENDIF
IF((_VARI _DEC2)==3)
N365 F_SP_RP(24,_XS,_ZS)
N366 F_SP_RP(25,_XE,_ZE)
ENDIF
IF((_VARI _DEC2)==4)
N367 F_SP_RP(26,_XS,_ZS)
N368 F_SP_RP(27,_XE,_ZE)
ENDIF
IF(_F_RELEAS==0)
N36 F_SP_RP(0,_XS,_ZS,0)
F_SP_TRA(1040)
ELSE
N37 F_SP_RP(0,,,0)
F_SP_TRA(1040)
ENDIF
ENDIF
ENDIF
ENDIF
N40 CYCLE952(_NP4,_NP5,_NP8,__VARI,_F,_FR,S_RPI,_D,_DX,_DZ,_UX,_UZ,_U,_U1,_BLANK,_APX,_APZ,_XA,_ZA,_XB,_ZB,_XR1,_XR2,_N,_P,_DI,_E_SC*_FAK2,,_GMODE,_DMODE,_AMODE,_PK,_DCH,_FS)
IF(_VARI _DEC3 == 4)OR(_VARI _DEC3 == 5)
IF(_F_RELEAS==0)
IF(_SA==2)AND(((NOT(_BA B_AND 'B10000'))AND(_DCH>=0))OR((_BA B_AND 'B10000')AND(_DCH<0)))
N45 G97
ENDIF
IF((_VARI _DEC2)<=2)
N500 F_SP_RP(0,_F_RP_ACT,$P_EP[_ZZ],0)
ELSE
N550 F_SP_RP(0,$P_EP[_XX],_F_RP_ACT,0)
ENDIF
ENDIF
_WM=105
REPEAT _SYNC_A _SYNC_E
ENDIF
IF(_MAN==0)
IF((_VARI _DEC2)==2)
IF(_F_RELEAS==0)
IF(S_IPT==0)
IF($P_EP[_XX]>=_F_RPT[0]*_FAK2)
SBLON
N58 G90 G0 AX[_XX]=_F_RP_ACT*_FAK2
SBLOF
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
IF(_MAN==0)
IF(_E_ST_PRG)
IF(S_IPT==1)
CYCLE806(0)
S_M_OK=0
SBLON
N125 G0 G90 AX[_ZZ]=_RTP
SBLOF
ENDIF
ELSE
IF(S_IPT==1)
CYCLE806(0)
S_M_OK=0
G[29]=_P29
_ZZ=$P_AXN3
SBLON
N130 G0 G90 AX[_ZZ]=_RTP
SBLOF
ELSE
SBLON
IF(_LP==1)
N50 G0 G90 AX[_XX]=_F_RP_ACT*_FAK2
IF(_AI==-1)
N52 G0 G90 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
ELSE
N55 G0 G90 AX[_ZZ]=_F_RP_ACT*_FAK2
IF(_AI==-1)
N57 G0 G90 AX[_XX]=_F_RPT[0]*_FAK2
ENDIF
ENDIF
SBLOF
N560 F_SP_RP(101,,,1)
ENDIF
ENDIF
ELSE
N60 G90 G0 AX[_XX]=_XRPM AX[_ZZ]=_ZRPM
IF(_F_Y_AXIS==1)
N62 G90 G0 AX[_YY]=_YRPM
ENDIF
ENDIF
G[29]=_P29
$P_CYCFRAME=_CYC_FR
_RETS:
_F_RELEAS=0
SBLON
RET
_SYNC_A:
IF(S_CHAN=="")
S_CHAN=_SC_CHAN_ST
IF(INDEX(S_CHAN,",")<>RINDEX(S_CHAN,","))
S_CHAN=""<<$P_CHANNO<<","<<_PK
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Kanle: "<<_SC_CHAN_ST<<" -> "<<S_CHAN)
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"WAITM("<<_WM<<","<<S_CHAN<<")")
ENDIF
N100 EXECSTRING("WAITM("<<_WM<<","<<S_CHAN<<")")
N110 STOPRE
_SYNC_E:
_FEHL0:STOPRE
N995200 SETAL(61743)
RET
_FEHL1:STOPRE
N995201 SETAL(61744)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_ROUGH_SPF
PROC F_ROUGH(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,INT _L,REAL __X0,INT _X0A,REAL _Z0,INT _Z0A,REAL __X1,INT _X1A,REAL _Z1,INT _Z1A,REAL __XM,INT _XMA,REAL _ZM,INT _ZMA,INT _XZA,REAL _RF1,REAL _RF2,REAL _RF3,REAL _D,REAL _UX,REAL _UZ,INT _NR,REAL _A1,REAL _A2,REAL _BETA,INT _BETAA,REAL _GAMA,REAL S_POLA,INT S_FR_M,REAL S_FR_I,STRING[32] S_TRA,REAL S_XC,REAL S_YC,REAL _SV2,REAL _C0) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn/ShopMill: Roughing edge cycle
DEF AXIS _XX,_ZZ,_YY,_CC,_AX1,_AX2,_AX3
DEF INT _VARI,_PM,_AI,_LP,_I,_XPM,_ZPM,_LF[8],_P29,_TYP,_SL,_MAN,_LAGE,_AMODE[8],_DMODE,_RFNR,S_MODE_BC,S_IPT,S_PL,_TM1,_TCI,_NPV,S_Y_TURN,S_C805_AMODE
DEF INT _LT[8]=set(0,1,2,3,3,1,2,0)
DEF INT _SLT[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,2,1,4,3,7,6,5,8,9)
DEF INT _SLX[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,4,3,2,1,5,8,7,6,9)
DEF REAL _F2,_FAK1,_FAK2,_X,_Z,_XS,_ZS,_SC,_OF,_Y,_X0,_X1,_XM,S_ROT_Z,_SD,_RP,_RTP,S_A1TC,S_A2TC
DEF STRING[32] _TC
DEF FRAME _WPFR
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_ROUGH_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
ENDIF
IF NOT S_CALL_FROM_MA_JOG_STEP
IF(_E_SM_PRG)AND((_TMOD _DEC4)==0) GOTOF _FEHL9
IF(_E_ST_PRG)AND((_TMOD _DEC4)==1) GOTOF _FEHL10
ENDIF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_X0=__X0 _X1=__X1 _XM=__XM
IF(_BA B_AND 'H8000' == 'H8000')
IF(_X0A==90)
_X0=_X0/2
ENDIF
IF(_X1A==90)
_X1=_X1/2
ENDIF
IF(_XMA==90)
_XM=_XM/2
ENDIF
ENDIF
IF(_F_BAR_START==0)
GOTOF _RET
ENDIF
_MAN=(_TMOD DIV 10)MOD 10
IF(_BA B_AND 'B010000000')
IF(_BA B_AND 'B100000000')
_MAN=2
ELSE
_MAN=1
ENDIF
ENDIF
IF(_MAN)
F_SP_INI(0)
ENDIF
IF(_TMOD _DEC9)==1
S_IPT=1
ENDIF
IF(_TMOD _DEC9)==3
S_Y_TURN=1
ENDIF
_TM1=_TMOD MOD 10
_C0=((_C0 MOD 360)+360)MOD 360
_P29=$P_GG[29]
DIAMCYCOF
IF(_BA B_AND 'B11' == 'B01')
_VARI=10
ELSE
IF(_BA B_AND 'B11' == 'B10')
_VARI=20
ELSE
GOTOF _FEHL1
ENDIF
ENDIF
IF(_L<0)OR(_L>7) GOTOF _FEHL6
IF(_L<4)
_VARI=_VARI+1
ELSE
_VARI=_VARI+2
ENDIF
_LAGE=_LT[_L]
IF(_BA B_AND 'B00001000')
_VARI=_VARI+1000
ENDIF
_RFNR=1
_AMODE[5]=0
IF(_BA B_AND 'H600'=='H000')
IF(_RF1<0)
_RF1=ABS(_RF1) _AMODE[5]=10000
ENDIF
ELSE
IF(_BA B_AND 'H600'=='H400')
IF(_RF1<0) GOTOF _FEHL7
_AMODE[5]=10000
ELSE
IF(_RF1<0) GOTOF _FEHL8
ENDIF
ENDIF
_RFNR=2
_AMODE[6]=0
IF(_BA B_AND 'H1800'=='H0000')
IF(_RF2<0)
_RF2=ABS(_RF2) _AMODE[6]=100000
ENDIF
ELSE
IF(_BA B_AND 'H1800'=='H1000')
IF(_RF2<0) GOTOF _FEHL7
_AMODE[6]=100000
ELSE
IF(_RF1<0) GOTOF _FEHL8
ENDIF
ENDIF
_RFNR=3
_AMODE[7]=0
IF(_BA B_AND 'H6000'=='H0000')
IF(_RF3<0)
_RF3=ABS(_RF3) _AMODE[7]=1000000
ENDIF
ELSE
IF(_BA B_AND 'H6000'=='H4000')
IF(_RF3<0) GOTOF _FEHL7
_AMODE[7]=1000000
ELSE
IF(_RF3<0) GOTOF _FEHL8
ENDIF
ENDIF
N10 G40 G90
IF(NOT((_FAA==1)OR(_FAA==3))) GOTOF _FEHL4
IF(_MAN)
IF($MCS_TECHNOLOGY==2)
N20 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=0
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
N21 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
N22 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
ELSE
_F_RELEAS=0
_VARI=_VARI+10000
IF(_MAN==2)
_F_MASPI=2
ELSE
_F_MASPI=0
ENDIF
_F_INIT=1
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N15 F_TFS(_T,,_DD,,,,,_F_MASPI+1,8)
F_SP_TRA(2040)
N16 F_SP_BC(104,_BETA,_GAMA)
N17 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,_F_MASPI+1,7)
ELSE
N18 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,_F_MASPI+1,8)
F_SP_TRA(2040)
ENDIF
ENDIF
ELSE
IF(_E_SM_PRG)
IF(S_IPT==1)
IF($PC_TRAFO_TYPE_NAME=="TRAORI_STAT")
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: DFM -> M5")
WRITE(_LOG,_LOG_FILE,"IPT: DFM -> SPOS=0")
ENDIF
M[_F_S_NR[_F_MASPI]]=5
SPOS[_F_S_NR[_F_MASPI]]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N333 E_TFS")
ENDIF
N333 E_TFS(_T,_TF,_DD,,,,,11)
TRAFOOF
G18
IF(_GAMA==180)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Gamma 180 -> Spiegelung X")
ENDIF
_XX=$P_AXN2
$P_CYCFRAME=$P_CYCFRAME:CMIRROR(_XX)
ENDIF
ELSE
N30 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=S_FR_M
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
_ZZ=$P_AXN1
S_ROT_Z=$P_ACTFRAME[_ZZ,RT]
N31 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
IF($P_ACTFRAME[_ZZ,RT]<>S_ROT_Z)
IF($P_EP[_ZZ]*_FAK1<_F_RPT[1]*_FAK2)
N315 G0 G90 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
ENDIF
N320 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
ENDIF
ELSE
IF(S_IPT==1)
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_F_TRAMA _DEC2 ==6)
_TCI=$P_TC
S_A1TC=$P_TCANG[1]
S_A2TC=$P_TCANG[2]
_NPV=$P_GG[8]
_WPFR=$P_WPFRAME
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Stirn B vor N250 F_TFS")
WRITE(_LOG,_LOG_FILE,"  _F_TRAMA="<<_F_TRAMA)
WRITE(_LOG,_LOG_FILE,"  $P_TC="<<$P_TC)
WRITE(_LOG,_LOG_FILE,"  _TC_A1="<<_TC_A1)
WRITE(_LOG,_LOG_FILE,"  _TC_A2="<<_TC_A2)
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[1]="<<$P_TCANG[1])
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[2]="<<$P_TCANG[2])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR13[_TCI]="<<$TC_CARR13[_TCI])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR14[_TCI]="<<$TC_CARR14[_TCI])
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N250 F_TFS")
ENDIF
N250 F_TFS(_T,_TF,_DD,,,,,1,0)
IF(_TCI)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Stirn B nach N250 F_TFS")
WRITE(_LOG,_LOG_FILE,"  _F_TRAMA="<<_F_TRAMA)
WRITE(_LOG,_LOG_FILE,"  $P_TC="<<$P_TC)
WRITE(_LOG,_LOG_FILE,"  _TC_A1="<<_TC_A1)
WRITE(_LOG,_LOG_FILE,"  _TC_A2="<<_TC_A2)
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[1]="<<$P_TCANG[1])
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[2]="<<$P_TCANG[2])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR13[_TCI]="<<$TC_CARR13[_TCI])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR14[_TCI]="<<$TC_CARR14[_TCI])
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N800 CYCLE800 direkt: "<<S_A1TC<<"/"<<S_A2TC)
ENDIF
N800 CYCLE800(0,$TC_CARR34[_TCI],220000,192,0,0,0,S_A1TC,S_A2TC,0,0,0,0,0,0,1001)
$P_WPFRAME=_WPFR
$P_WPFR=$P_WPFRAME
G[8]=_NPV
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: G18 TRAFOOF")
ENDIF
F_SP_TRA(2040)
_XX=$P_AXN2
IF(NOT _TCI)
N255 F_SP_BC(4,_SC_A_NO_VAL,0)
ENDIF
IF(_GAMA==180)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Gamma 180 -> Spiegelung X")
ENDIF
$P_CYCFRAME=$P_CYCFRAME:CMIRROR(_XX)
ENDIF
ELSE
IF S_Y_TURN
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Y-Drehen")
ENDIF
N1800 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
IF(_SC_Y_TURN)
IF(_SC_Y_TURN_GAMA<>_GAMA)
F_SP_RP(1,,,1)
ENDIF
IF(_BA B_AND 'H1000000' == 'H1000000')
IF(_SC_Y_TURN==-90)
F_SP_RP(1,,,1)
ENDIF
ELSE
IF(_SC_Y_TURN==90)
F_SP_RP(1,,,1)
ENDIF
ENDIF
ENDIF
IF(_F_TC_DEF[2]==0)
_TC=""
ELSE
_TC=$TC_CARR34[_F_TC_DEF[2]]
ENDIF
IF(_BA B_AND 'H1000000' == 'H1000000')
S_C805_AMODE=1000
ENDIF
N1805 CYCLE805(1,_TC,_GAMA,,,,S_C805_AMODE)
N1810 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,7)
ELSE
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N25 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
N26 F_SP_BC(4,_BETA,_GAMA)
N27 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,7)
ELSE
N28 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,0)
F_SP_TRA(2040)
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
IF($P_TOOLNO==0) GOTOF _FEHL0
IF($P_TOOL==0) GOTOF _FEHL2
_TYP=$P_ADT[1]
IF(_TYP<500)OR(_TYP>599) GOTOF _FEHL3
_XX=$P_AXN2 _ZZ=$P_AXN1
IF(_MAN==0)AND(S_IPT==0)
F_SP_RPT(0,_L)
ENDIF
_X=$P_EP[_XX]*_FAK1 _Z=$P_EP[_ZZ]*_FAK1
IF(_F_Y_AXIS==1)
_YY=$P_AXN3
ENDIF
IF(_MAN)
_Y=$P_EP[_YY]*_FAK1
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_F_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
ELSE
_SC=_E_SC*_FAK2
ENDIF
_I=_L
_PM=1-(_I MOD 2)*2
_I=_I DIV 2
_AI=1-(_I MOD 2)*2
_LP=1-(_I DIV 2)
IF($P_TOOLNO>0)
IF(S_IPT)
_SL=$TC_DP2[$P_TOOLNO,$P_TOOL]
ELSE
_SL=$P_ADT[2]
ENDIF
IF(NOT(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'H00200000')AND($P_CUTMOD))AND NOT(($P_CUTMODK==$PC_TRAFO_NAME)AND($P_CUTMODK<>""))AND(NOT S_Y_TURN))
_SL=_SLT[$P_ACTFRAME[_ZZ,MI],_SL]
_SL=_SLX[$P_ACTFRAME[_XX,MI],_SL]
ENDIF
IF(_SL>0)
_LF[0]=4 _LF[1]=3 _LF[2]=1 _LF[3]=2
_LF[4]=2 _LF[5]=3 _LF[6]=1 _LF[7]=4
IF(_LF[_L]<>_SL) GOTOF _FEHL5
ENDIF
ENDIF
_XPM=-_AI _ZPM=_PM
IF(_LP) GOTOF _MI
_XPM=_PM _ZPM=-_AI
_MI:
IF(_X0A<>90)
_X0=_X0+_X
ENDIF
IF(_Z0A<>90)
_Z0=_Z0+_Z
ENDIF
IF(_X1A<>90)
_X1=_X0+ABS(_X1)*_XPM
ENDIF
IF(_Z1A<>90)
_Z1=_Z0+ABS(_Z1)*_ZPM
ENDIF
IF(_XMA<>90)
_XM=_X0+ABS(_XM)*_XPM
ENDIF
IF(_ZMA<>90)
_ZM=_Z0+ABS(_ZM)*_ZPM
ENDIF
_AMODE[0]=0+_AMODE[5]+_AMODE[6]+_AMODE[7]
_SC=ABS(_SC)
IF(_AI==1)
IF($SCS_TURN_ROUGH_O_RELEASE_DIST==-1)
_OF=_SC
ELSE
_OF=ABS($SCS_TURN_ROUGH_O_RELEASE_DIST)*_FAK1
ENDIF
ELSE
IF($SCS_TURN_ROUGH_I_RELEASE_DIST==-1)
_OF=_SC
ELSE
_OF=ABS($SCS_TURN_ROUGH_I_RELEASE_DIST)*_FAK1
ENDIF
ENDIF
IF(_OF>_SC)
_OF=_SC
ELSE
_SC=_OF
ENDIF
IF(_LP)
_XS=_X0+_OF*_AI _ZS=_Z0-_OF*_PM
ELSE
_ZS=_Z0+_OF*_AI _XS=_X0-_OF*_PM
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Startpunkt XS="<<_XS<<" ZS="<<_ZS)
ENDIF
IF(S_IPT==1)
IF(_GAMA==180)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Gamma 180 -> Spiegelung X entfernt")
ENDIF
$P_CYCFRAME=$P_CYCFRAME:CMIRROR(_XX)
ENDIF
IF(_E_SM_PRG)
E_SP_ED(_SD)
_RP=_E_RP*_FAK2
_RTP=_RP-_SD
G17
N310 E_SP_RP(2,_RTP,S_XC,S_YC,_RTP)
ELSE
IF(_GAMA==180)
_XS=_XS-2*$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Gamma 180 -> Startpunkt XS="<<_XS)
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: F_SP_BC")
ENDIF
F_SP_BC(_TM1)
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2
_RTP=_RP
IF(_TM1==1)
F_SP_TRA(2012,,_C0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Mantel Y Startpunkt vorpositionieren: RP="<<_RP<<" YS="<<_YS<<" XS="<<_XS)
ENDIF
F_SP_RP(0,_RP,_YS,0,_XS)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N32 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Stirn: TRAFOOF, G17, Fraesen")
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Stirn: Startpunkt in X und Z anfahren: X="<<S_XC+_XS<<" Z="<<_RP<<" Y="<<S_YC)
ENDIF
F_SP_RP(9,S_XC+_XS,_RP,0,S_YC)
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N33 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2 _AX3=$P_AXN3
IF(_F_RELEAS==0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Startposition anfahren G17: X="<<S_XC+_XS<<" Y="<<S_YC<<" Z="<<_RP)
ENDIF
SBLON
N34 G90 G0 G40 AX[_AX1]=S_XC+_XS AX[_AX2]=S_YC AX[_AX3]=_RP
SBLOF
ENDIF
ENDIF
ENDIF
IF($MCS_TECHNOLOGY==2)
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H0000')
DIAM90
ELSE
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H8000')
DIAMON
ELSE
DIAMOF
ENDIF
ENDIF
IF(S_IPT==0)
_P29=$P_GG[29]
ENDIF
DIAMCYCOF
ENDIF
IF(S_IPT==1)
IF(_E_SM_PRG)
S_PL=_E_PLANE
ELSE
IF(_TM1==1)
S_PL=3
ELSE
S_PL=1
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N806 Anwahl Interpolationsdrehen")
ENDIF
IF(_E_SM_PRG)
N806 CYCLE806(0001,S_XC,S_YC,_GAMA,_S,_SV2,5,_SA-1+100,S_PL,S_TRA,2*_XS,_RP)
SBLON
G4 F0
SBLOF
IF(_LOG_ON)
_CC=_F_S_AX[1]
WRITE(_LOG,_LOG_FILE,"IPT: N334 E_TFS WKS X="<<$P_EP[_XX]<<" C="<<$P_EP[_CC])
ENDIF
N334 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
SBLON
G4 F0
SBLOF
ELSE
N806 CYCLE806(0001,S_XC,S_YC,_GAMA,_S,_SV2,5,_SA-1,S_PL,S_TRA)
SBLON
G4 F0
SBLOF
IF(_LOG_ON)
_CC=_F_S_AX[1]
WRITE(_LOG,_LOG_FILE,"IPT: N251 F_TFS WKS X="<<$P_EP[_XX]<<" C="<<$P_EP[_CC])
ENDIF
N251 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,,0)
SBLON
G4 F0
SBLOF
ENDIF
DIAMCYCOF
SBLON
N810 G0 G90 AX[_ZZ]=_ZS
SBLOF
ELSE
IF S_Y_TURN
IF($P_EP[_ZZ]*_FAK1<_F_RPT[1]*_FAK2)AND($P_EP[_YY]<>0)
N1840 G0 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
SBLON
IF($P_EP[_ZZ]*_FAK1>_F_RPT[1]*_FAK2)
N1850 G0 AX[_XX]=_F_RPT[0]*_FAK2 AX[_ZZ]=_F_RPT[1]*_FAK2
ELSE
N1860 G0 AX[_XX]=_F_RPT[0]*_FAK2
ENDIF
N1870 G0 AX[_YY]=0
N1880 G0 AX[_ZZ]=_ZS
N1890 G0 G90 AX[_XX]=_XS AX[_ZZ]=_ZS
SBLOF
ELSE
IF(_MAN)
SBLON
IF(_F_Y_AXIS==0)
N35 G0 G90 AX[_XX]=_XS AX[_ZZ]=_ZS
ELSE
N36 G0 G90 AX[_XX]=_XS AX[_ZZ]=_ZS AX[_YY]=0
ENDIF
SBLOF
ELSE
IF(_F_RELEAS==0)
IF(_AI==-1)
N40 F_SP_RP(3,_XS,_ZS)
ENDIF
N45 F_SP_RP(0,_XS,_ZS,0)
SBLON
IF(_LP==1)
N50 G0 G90 AX[_XX]=_F_RP_ACT*_FAK2 AX[_ZZ]=_ZS
ELSE
N51 G0 G90 AX[_XX]=_XS AX[_ZZ]=_F_RP_ACT*_FAK2
ENDIF
SBLOF
ELSE
N54 F_SP_RP(0,,,0)
SBLON
N55 G0 G90 AX[_XX]=_XS AX[_ZZ]=_ZS
SBLOF
ENDIF
ENDIF
F_SP_TRA(1040)
ENDIF
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N100 CYCLE951")
ENDIF
N100 CYCLE951(_X0*2,_Z0,_X1*2,_Z1,_XM*2,_ZM,_LAGE,_D,_UX,_UZ,_VARI,_RF1,_RF2,_RF3,_SC,_F,_NR,0,_AMODE[0])
ENDIF
SBLON
IF(_MAN==0)
IF(_E_ST_PRG)
SBLON
IF(_LP==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N105 G0 G90 X="<<_X0+_SC*_AI)
ENDIF
N105 G0 G90 AX[_XX]=_X0+_SC*_AI
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N115 G0 G90 Z="<<_Z0+_SC*_AI)
ENDIF
N115 G0 G90 AX[_ZZ]=_Z0+_SC*_AI
IF(S_IPT==1)
N120 G0 G90 AX[_XX]=_X0-_SC*_PM
ENDIF
ENDIF
SBLOF
IF(S_IPT==0)
IF(_AI==-1)
F_SP_RP(4,$P_EP[_XX]*_FAK1,$P_EP[_ZZ]*_FAK1)
ENDIF
ENDIF
IF(S_IPT==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: CYCLE806(0)")
ENDIF
CYCLE806(0)
S_M_OK=0
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N125 G0 G90 Z="<<_RTP)
ENDIF
SBLON
N125 G0 G90 AX[_ZZ]=_RTP
SBLOF
ENDIF
ELSE
IF(S_IPT==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N110 G0 G90 X="<<_XS)
ENDIF
SBLON
N110 G0 G90 AX[_XX]=_XS
SBLOF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: CYCLE806(0)")
ENDIF
CYCLE806(0)
S_M_OK=0
G[29]=_P29
_ZZ=$P_AXN3
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N130 G0 G90 Z="<<_RTP)
ENDIF
SBLON
N130 G0 G90 AX[_ZZ]=_RTP
SBLOF
ELSE
SBLON
IF(_LP==1)
N150 G0 G90 AX[_XX]=_F_RP_ACT*_FAK2
IF(_AI==-1)
N155 G0 G90 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
ELSE
N160 G0 G90 AX[_ZZ]=_F_RP_ACT*_FAK2
IF(_AI==-1)
N165 G0 G90 AX[_XX]=_F_RPT[0]*_FAK2
ENDIF
ENDIF
SBLOF
F_SP_RP(101,,,1)
ENDIF
ENDIF
ELSE
IF(_LAGE==0)
IF($P_EP[_XX]>_X)
N170 G90 G0 AX[_ZZ]=_Z0-_SC
ENDIF
IF($P_EP[_ZZ]<_Z)
N171 G90 G0 AX[_XX]=_X0+_SC
ENDIF
ENDIF
IF(_LAGE==1)
IF($P_EP[_XX]>_X)
N172 G90 G0 AX[_ZZ]=_Z0+_SC
ENDIF
IF($P_EP[_ZZ]>_Z)
N173 G90 G0 AX[_XX]=_X0+_SC
ENDIF
ENDIF
IF(_LAGE==2)
IF($P_EP[_XX]<_X)
N174 G90 G0 AX[_ZZ]=_Z0-_SC
ENDIF
IF($P_EP[_ZZ]<_Z)
N175 G90 G0 AX[_XX]=_X0-_SC
ENDIF
ENDIF
IF(_LAGE==3)
IF($P_EP[_XX]<_X)
N176 G90 G0 AX[_ZZ]=_Z0+_SC
ENDIF
IF($P_EP[_ZZ]>_Z)
N177 G90 G0 AX[_XX]=_X0-_SC
ENDIF
ENDIF
IF(_F_Y_AXIS==1)
N180 G90 G0 AX[_XX]=_X AX[_ZZ]=_Z AX[_YY]=_Y
ELSE
N185 G90 G0 AX[_XX]=_X AX[_ZZ]=_Z
ENDIF
ENDIF
SBLOF
G[29]=_P29
_RET:
_E_S_LINE=0
_RETS:
_F_BAR_START=-1
_F_RELEAS=0
SBLON
RET
_FEHL0: STOPRE
N995100 SETAL(61009)
RET
_FEHL1: STOPRE
N995101 SETAL(61002)
RET
_FEHL2: STOPRE
N995102 SETAL(61000)
RET
_FEHL3: STOPRE
N995103 SETAL(61212)
RET
_FEHL4: STOPRE
N995104 SETAL(61240)
RET
_FEHL5: STOPRE
N995105 SETAL(61608)
RET
_FEHL6: STOPRE
N995106 SETAL(61532)
RET
_FEHL7: STOPRE
N995107 SETAL(61022,"(FS"<<_RFNR<<")  ")
RET
_FEHL8: STOPRE
N995108 SETAL(61022,"(R"<<_RFNR<<")  ")
RET
_FEHL9: STOPRE
N995109 SETAL(61862)
RET
_FEHL10: STOPRE
N995110 SETAL(61863)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_S_ASUP_SPF
PROC F_S_ASUP SBLOF SAVE DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.005 ;DATE: 2024-03-27
;ShopTurn: Cycle for Actions after Block Search
DEF AXIS _Z2,_AX
DEF INT _TI,_TII,_TFI,_DD,_SA,_SMODE=0,_I,_MSNUM,S_MSNUM2,_T_ST_NEW,_C1_GO,_C2_GO,_B_GO,_TCI,_TRAFO,_TRAFO_NUM,_TRAFO_PAR,_TRAFO_AXIS,_S_NR,S_TI,S_THNR,_P15,S_TRA_NO,S_DL=-1
DEF REAL _FAK1,_S,_POS,_MODR,_MODS
DEF STRING[32] _T,_TF
DEF STRING[40] _CMD,_STR,S_F_STR
DEF INT _LOG,_LOG_ON
DEF STRING[35] _LOG_FILE
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_S_ASUP_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
DELETE(_LOG,_LOG_FILE)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"$P_SEARCHL="<<$P_SEARCHL)
WRITE(_LOG,_LOG_FILE,"$AC_SERUPRO="<<$AC_SERUPRO)
WRITE(_LOG,_LOG_FILE,"_E_T_NEW   ="<<_E_T_NEW)
WRITE(_LOG,_LOG_FILE,"_E_D_NEW   ="<<_E_D_NEW)
WRITE(_LOG,_LOG_FILE,"_E_S_NEW   ="<<_E_S_NEW)
WRITE(_LOG,_LOG_FILE,"_E_SA_NEW  ="<<_E_SA_NEW)
IF($P_TC)
WRITE(_LOG,_LOG_FILE,"TC=="<<$P_TC)
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[1]="<<$P_TCANG[1])
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[2]="<<$P_TCANG[2])
WRITE(_LOG,_LOG_FILE,"  _TC_A1="<<_TC_A1)
WRITE(_LOG,_LOG_FILE,"  _TC_A2="<<_TC_A2)
ENDIF
ENDIF
IF($P_SEARCHL==2)OR($P_SEARCHL==4)OR($AC_SERUPRO)
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_MSNUM=$P_MSNUM
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Masterspindel: S"<<_MSNUM)
ENDIF
_P15=$P_GG[15]
IF($P_F_TYPE==11)OR($P_F_TYPE==33)
IF($P_FZ>0)
S_F_STR="FZ="<<$P_FZ
ENDIF
ELSE
IF($P_F>0)
S_F_STR="F="<<$P_F
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"G"<<_P15+92<<" aktiv "<<S_F_STR)
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CYCLE210(0)")
ENDIF
CYCLE210(0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_INI(1)")
ENDIF
F_SP_INI(1)
_TRAFO_AXIS=-1
_TRAFO_NUM=-1
_TRAFO_PAR=1
IF($P_TRAFO)
IF($PC_TRAFO_NAME=="")
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"klass. Trafo")
ENDIF
IF(ISVAR("$P_TRAFO_NUM"))
_TRAFO_NUM=$P_TRAFO_NUM
ELSE
FOR _I=1 TO 20
_STR="$MC_TRAFO_TYPE_"<<_I
IF(ISVAR(_STR))
_CMD="_TRAFO="<<_STR
EXECSTRING(_CMD)
IF($P_TRAFO==_TRAFO)
IF($P_TRAFO_PARSET==_TRAFO_PAR)
_TRAFO_NUM=_I
GOTOF _TRAFO_END
ELSE
_TRAFO_PAR=_TRAFO_PAR+1
ENDIF
ENDIF
ENDIF
ENDFOR
_TRAFO_END:
ENDIF
IF(_TRAFO_NUM>0)AND($P_TRAFO B_AND 'H300')
_CMD="_TRAFO_AXIS=$MC_TRAFO_AXES_IN_"<<_TRAFO_NUM<<"[1]"
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Kommandostring: "<<_CMD)
ENDIF
EXECSTRING(_CMD)
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"kin. Trafo: "<<$PC_TRAFO_NAME)
ENDIF
IF($PC_TRAFO_TYPE_NAME=="TRANSMIT_K")OR($PC_TRAFO_TYPE_NAME=="TRACYL_K")
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  "<<$PC_TRAFO_TYPE_NAME)
ENDIF
S_TRA_NO=NAMETOINT("$NT_NAME",$PC_TRAFO_NAME,TRUE)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  S_TRA_NO="<<S_TRA_NO)
ENDIF
IF(S_TRA_NO>=1)
_STR=$NT_ROT_AX_NAME[S_TRA_NO,1]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Kettenelement="<<_STR)
ENDIF
_I=NAMETOINT("$NK_NAME",_STR,TRUE)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Kettenelement="<<_I)
ENDIF
IF(_I>=0)
_STR=$NK_AXIS[_I]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Maschinenachse="<<_STR)
ENDIF
_I=0
WHILE(_I<S_AXES_PER_CHAN)AND(_TRAFO_AXIS==-1)
IF($MC_AXCONF_MACHAX_USED[_I]>0)
IF($MN_AXCONF_MACHAX_NAME_TAB[$MC_AXCONF_MACHAX_USED[_I]-1]==_STR)
_TRAFO_AXIS=_I+1
ENDIF
ENDIF
_I=_I+1
ENDWHILE
ENDIF
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  _TRAFO_AXIS="<<_TRAFO_AXIS)
ENDIF
ENDIF
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_TCI="<<$P_TC)
ENDIF
_TCI=$P_TC
ENDIF
F_SP_TRA(300)
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(($P_TC)OR(_TC_NUM))AND($P_TC<>_F_TC_DEF[2])AND($P_TC<>_F_TC_DEF[3])
IF($P_TC)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_TCARR(,,,,128,,,,,,,,,,,)")
ENDIF
F_TCARR(,,,,128,,,,,,,,,,,)
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_TCARR(0,,,,128,,,,,,,,,,,)")
ENDIF
F_TCARR("0",,,,128,,,,,,,,,,,)
ENDIF
ENDIF
F_SP_TRA(200)
IF(_F_AX_EXISTS[3])AND(NOT _F_TAILSTOCK[0])
_Z2=_F_S_AX[3]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N101 G0 G90 "<<AXSTRING(_Z2)<<"="<<$AC_RETPOINT[_Z2]*_FAK1)
ENDIF
IF($AA_FXS[_Z2]==0)
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N101 G0 G90 POS[_Z2]=$AC_RETPOINT[_Z2]*_FAK1
ELSE
N102 G0 G90 AX[_Z2]=$AC_RETPOINT[_Z2]*_FAK1
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N8 G40")
ENDIF
N8 G40
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(300)")
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(0)")
ENDIF
F_SP_TRA(300)
F_SP_TRA(0)
GETEXET(_TII)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_TII="<<_TII)
ENDIF
IF(_E_T_NEW=="")
_B_GO=1
IF(_TII)
_T=$TC_TP2[_TII]
_DD=$P_TOOL
S_DL=$P_DLNO
ELSE
_T="0"
_DD=0
S_DL=-1
ENDIF
ELSE
_E_SSL_JS_T=1
_B_GO=0
_T=_E_T_NEW
_DD=_E_D_NEW
ENDIF
IF(_E_S_NEW<0)
_T_ST_NEW=0
_S=0
_SA=0
ELSE
_T_ST_NEW=1
_S=_E_S_NEW
_SA=_E_SA_NEW
_SMODE=_F_SMODE
_TI=GETT(_T,0)
IF(_TI>0)AND(_DD>0)
IF($TC_DP1[_TI,_DD]==560)
_S=0
_SA=51
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Sonderfall: Drehbohrer")
ENDIF
ENDIF
ENDIF
ENDIF
_E_T_NEW=""
_E_D_NEW=0
_E_S_NEW=-1
_E_SA_NEW=0
_F_SMODE=0
IF(_T_ST_NEW==1)
_TFI=-1
ELSE
GETSELT(_TFI)
ENDIF
IF(_TFI>0)
_TF=$TC_TP2[_TFI]
ELSE
IF(_TFI==0)
_TF="0"
ELSE
_TF=""
ENDIF
ENDIF
_F_INIT=1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(140)")
ENDIF
CUST_TECHCYC(140)
IF($P_MSNUM)
IF($MA_GEAR_STEP_CHANGE_ENABLE[SPI($P_MSNUM)]B_AND'B11')
IF($P_SEARCH_SMODE[$P_MSNUM]==1)OR($P_SEARCH_SMODE[$P_MSNUM]==2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N90 M["<<$P_MSNUM<<"]="<<$P_SEARCH_SGEAR[$P_MSNUM])
ENDIF
N90 M[$P_MSNUM]=$P_SEARCH_SGEAR[$P_MSNUM]
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N100 F_TFS("<<_T<<","<<_TF<<","<<_DD<<",0,0,"<<_S<<","<<_SA<<","<<_SMODE<<",2)")
ENDIF
N100 F_TFS(_T,_TF,_DD,0,0,_S,_SA,_SMODE,2)
IF(_T_ST_NEW==0)
IF S_DL>=0
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"DL="<<S_DL)
ENDIF
DL=S_DL
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(141)")
ENDIF
CUST_TECHCYC(141)
IF(_F_S_NR[0]==$P_MSNUM)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_SMODE=1")
ENDIF
_SMODE=1
ELSE
IF(_F_S_NR[1]==$P_MSNUM)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_SMODE=2")
ENDIF
_SMODE=2
ELSE
IF(_F_S_NR[2]==$P_MSNUM)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_SMODE=3")
ENDIF
_SMODE=3
ENDIF
ENDIF
ENDIF
IF($P_MSNUM<>_MSNUM)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"SETMS("<<_MSNUM<<")")
ENDIF
SETMS(_MSNUM)
ENDIF
IF(_P15<>$P_GG[15])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"G"<<_P15+92<<" "<<S_F_STR)
ENDIF
G[15]=_P15
EXECSTRING(S_F_STR)
ENDIF
IF($MN_SEARCH_RUN_MODE B_AND 'B100')
FOR _I=0 TO S_AXES_PER_CHAN-1
_STR="$MC_AXCONF_CHANAX_NAME_TAB["<<_I<<"]"
IF(ISVAR(_STR))
_STR=$MC_AXCONF_CHANAX_NAME_TAB[_I]
IF(_STR<>"")AND($MC_AXCONF_MACHAX_USED[_I])
_AX=AXNAME(_STR)
_S_NR=$MA_SPIND_ASSIGN_TO_MACHAX[_AX]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"AX"<<_I+1<<" "<<AXSTRING(_AX)<<" S"<<_S_NR)
IF _S_NR>0
WRITE(_LOG,_LOG_FILE,"  $P_SEARCH_S="<<$P_SEARCH_S[_S_NR])
WRITE(_LOG,_LOG_FILE,"  $P_SEARCH_SDIR="<<$P_SEARCH_SDIR[_S_NR])
WRITE(_LOG,_LOG_FILE,"  $P_SEARCH_SMODE="<<$P_SEARCH_SMODE[_S_NR])
WRITE(_LOG,_LOG_FILE,"  $P_SEARCH_SPOS="<<$P_SEARCH_SPOS[_S_NR])
WRITE(_LOG,_LOG_FILE,"  $P_SEARCH_SPOSMODE="<<$P_SEARCH_SPOSMODE[_S_NR])
WRITE(_LOG,_LOG_FILE,"  $P_SEARCH_SGEAR="<<$P_SEARCH_SGEAR[_S_NR])
ENDIF
ENDIF
IF(_S_NR>0)AND($P_SEARCH_SMODE[_S_NR]==2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  -> Spindel im Positionierbetrieb")
WRITE(_LOG,_LOG_FILE,"     N114 SPOS["<<_S_NR<<"]="<<$P_SEARCH_SPOS[_S_NR])
ENDIF
N114 SPOS[_S_NR]=$P_SEARCH_SPOS[_S_NR]
ENDIF
IF(_S_NR>0)AND($P_SEARCH_SMODE[_S_NR]<>1)AND(($P_GG[15]<>4)OR($P_SEARCH_S[_S_NR]<>0))
IF($P_SEARCH_SMODE[_S_NR]<>0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  -> kein Spindelbetrieb ($P_SEARCH_SMODE="<<$P_SEARCH_SMODE[_S_NR]<<")")
WRITE(_LOG,_LOG_FILE,"     N112 S["<<_S_NR<<"]="<<$P_SEARCH_S[_S_NR])
ENDIF
N112 S[_S_NR]=$P_SEARCH_S[_S_NR]
ENDIF
_S_NR=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  S"<<_S_NR<<" WSP="<<_F_S_NR[1]<<" $P_TOOLNO="<<$P_TOOLNO<<" T,SSL="<<_TII)
ENDIF
IF(_S_NR>0)AND((_S_NR<>_F_S_NR[1])OR($P_TOOLNO==_TII))
IF($P_SEARCH_SDIR[_S_NR]<>-19)AND($P_SEARCH_SDIR[_S_NR]<>-5)
IF(_S_NR==$P_MSNUM)AND($P_GG[15]==4)AND($P_SEARCH_S[_S_NR]==0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"     N115 M["<<_S_NR<<"]="<<$P_SEARCH_SDIR[_S_NR])
ENDIF
N115 M[_S_NR]=$P_SEARCH_SDIR[_S_NR]
ELSE
IF($P_SEARCH_S_TYPE[_S_NR]==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"     N120 G972 S["<<_S_NR<<"]="<<$P_SEARCH_S[_S_NR]<<" M["<<_S_NR<<"]="<<$P_SEARCH_SDIR[_S_NR])
ENDIF
N120 G972 S[_S_NR]=$P_SEARCH_S[_S_NR] M[_S_NR]=$P_SEARCH_SDIR[_S_NR]
ENDIF
IF($P_SEARCH_S_TYPE[_S_NR]==2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"     N121 SVC["<<_S_NR<<"]="<<$P_SEARCH_S[_S_NR]<<" M["<<_S_NR<<"]="<<$P_SEARCH_SDIR[_S_NR])
ENDIF
N121 SVC[_S_NR]=$P_SEARCH_S[_S_NR] M[_S_NR]=$P_SEARCH_SDIR[_S_NR]
ENDIF
IF($P_SEARCH_S_TYPE[_S_NR]==3)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"     N122 G962 S["<<_S_NR<<"]="<<$P_SEARCH_S[_S_NR]<<" M["<<_S_NR<<"]="<<$P_SEARCH_SDIR[_S_NR])
ENDIF
N122 G962 S[_S_NR]=$P_SEARCH_S[_S_NR] M[_S_NR]=$P_SEARCH_SDIR[_S_NR]
ENDIF
IF($P_SEARCH_S_TYPE[_S_NR]==4)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"     N123 G962 S["<<_S_NR<<"]="<<$P_SEARCH_S[_S_NR]<<" M["<<_S_NR<<"]="<<$P_SEARCH_SDIR[_S_NR])
ENDIF
N123 G962 S[_S_NR]=$P_SEARCH_S[_S_NR] M[_S_NR]=$P_SEARCH_SDIR[_S_NR]
ENDIF
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  -> nichts ausgeben (M=-19) oder (M=-5)")
ENDIF
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  -> nichts ausgeben")
ENDIF
ENDIF
ENDIF
ENDIF
ENDFOR
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(142)")
ENDIF
CUST_TECHCYC(142)
ENDIF
F_SP_TRA(200)
IF($P_TRAFO<>0)
_F_INIT=1
ENDIF
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND($P_TC)AND(_TC_FR MOD 10)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N200 CUST_800("<<40+(_TC_FR MOD 10)<<","<<$P_TC<<")")
ENDIF
N200 CUST_800(40+(_TC_FR MOD 10),$P_TC)
ENDIF
IF((($P_TRAFO B_AND 'H100')OR($P_TRAFO B_AND 'H200'))AND(_F_AX_NR[4]==_TRAFO_AXIS))
_C1_GO=0
ELSE
_C1_GO=1
ENDIF
IF(_F_S_NR[2])
IF((($P_TRAFO B_AND 'H100')OR($P_TRAFO B_AND 'H200'))AND(_F_AX_NR[5]==_TRAFO_AXIS))
_C2_GO=0
ELSE
_C2_GO=1
ENDIF
ELSE
_C2_GO=0
ENDIF
IF(_F_EBENE>=0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(68)")
ENDIF
CUST_TECHCYC(68)
ENDIF
IF(_F_AX_EXISTS[4])AND(($P_SMODE[_F_S_NR[0]]==4)OR($P_SMODE[_F_S_NR[0]]==2))AND(_C1_GO)
IF($AC_SMODE[_F_S_NR[0]]<>4)AND($AC_SMODE[_F_S_NR[0]]<>2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(1)")
ENDIF
CUST_TECHCYC(1)
ENDIF
_AX=_F_S_AX[0]
_POS=$AC_RETPOINT[_AX]
IF($MA_ROT_IS_MODULO[_AX])
_MODR=$MA_MODULO_RANGE[_AX]
_MODS=$MA_MODULO_RANGE_START[_AX]
_POS=((((_POS-_MODS) MOD _MODR)+_MODR) MOD _MODR)+_MODS
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N300 G0 G90 "<<AXSTRING(_AX)<<"="<<_POS)
ENDIF
N300 G0 G90 AX[_AX]=_POS
ENDIF
IF(_F_AX_EXISTS[5])AND(($P_SMODE[_F_S_NR[2]]==4)OR($P_SMODE[_F_S_NR[2]]==2))AND(_C2_GO)
IF($AC_SMODE[_F_S_NR[2]]<>4)AND($AC_SMODE[_F_S_NR[2]]<>2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(21)")
ENDIF
CUST_TECHCYC(21)
ENDIF
_AX=_F_S_AX[2]
_POS=$AC_RETPOINT[_AX]
IF($MA_ROT_IS_MODULO[_AX])
_MODR=$MA_MODULO_RANGE[_AX]
_MODS=$MA_MODULO_RANGE_START[_AX]
_POS=((((_POS-_MODS) MOD _MODR)+_MODR) MOD _MODR)+_MODS
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N400 G0 G90 "<<AXSTRING(_AX)<<"="<<_POS)
ENDIF
N400 G0 G90 AX[_AX]=_POS
ENDIF
IF(_F_AX_EXISTS[6])AND(_B_GO)
_AX=_F_S_AX[4]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N500 G0 G90 "<<AXSTRING(_AX)<<"="<<$AC_RETPOINT[_AX])
ENDIF
N500 G0 G90 AX[_AX]=$AC_RETPOINT[_AX]
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_F_S_NR[1])AND(($P_SMODE[_F_S_NR[1]]==4)OR($P_SMODE[_F_S_NR[1]]==2))
IF($AC_SMODE[_F_S_NR[1]]<>4)AND($AC_SMODE[_F_S_NR[1]]<>2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(14)")
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(11)")
ENDIF
CUST_TECHCYC(14)
CUST_TECHCYC(11)
ENDIF
_AX=_F_S_AX[1]
N600 G0 G90 AX[_AX]=$AC_RETPOINT[_AX]
ENDIF
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND($P_TC<>_TCI)
TCARR=_TCI
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(30)")
ENDIF
CUST_TECHCYC(30)
M17

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SIM_SPF
PROC F_SIM(INT _TYPE,INT _STAT,REAL _P1,REAL _P2,REAL _P3,REAL _P4,REAL _P5,REAL _P6,REAL _P7,REAL _ZB,INT _RSTOCK,REAL _XR)
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 02.06.15.00 ;DATE: 2009-04-29
;ShopTurn: Simulation Cycle
DEF AXIS _ZZ,_Z2
DEF REAL _Z_TRANS,_Z2_TRANS=0,_FAK1,_FAK2
DEF STRING[128] _STR
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF($P_GG[6]==1)
_ZZ=$P_AXN3
ELSE
IF($P_GG[6]==2)
_ZZ=$P_AXN1
ELSE
_ZZ=$P_AXN2
ENDIF
ENDIF
_Z_TRANS=($P_SETFRAME[_ZZ,TR]+$P_IFRAME[_ZZ,TR])*_FAK1
IF($MN_MM_FRAME_FINE_TRANS)
_Z_TRANS=_Z_TRANS+($P_SETFRAME[_ZZ,FI]+$P_IFRAME[_ZZ,FI])*_FAK1
ENDIF
IF(E_MD9803)AND(_F_S_NR[2])
_Z2=AXNAME($MC_AXCONF_CHANAX_NAME_TAB[E_MD9803-1])
_Z2_TRANS=($P_SETFRAME[_Z2,TR]+$P_IFRAME[_Z2,TR])*_FAK1
IF($MN_MM_FRAME_FINE_TRANS)
_Z2_TRANS=_Z2_TRANS+($P_SETFRAME[_Z2,FI]+$P_IFRAME[_Z2,FI])*_FAK1
ENDIF
ENDIF
WRTPR("NPV_BLANK("<<_Z_TRANS/_FAK2<<","<<_Z2_TRANS/_FAK2<<")",1)
CASE _TYPE OF 0 GOTOF _M_T0 1 GOTOF _M_T1 2 GOTOF _M_T2 3 GOTOF _M_T3 10 GOTOF _M_T10 11 GOTOF _M_T11 12 GOTOF _M_T12 13 GOTOF _M_T13 14 GOTOF _M_T14 15 GOTOF _M_T15 DEFAULT GOTOF _M_T
_M_T0: WRTPR("END()",1)
GOTOF _M_T
_M_T1: WRTPR("CLEAN()",1)
GOTOF _M_T
_M_T2: WRTPR("STOP()",1)
GOTOF _M_T
_M_T3: WRTPR("START()",1)
GOTOF _M_T
_M_T10:_STR="BLOCK("<<_P2<<","<<_P3<<","<<_P4<<","<<_ZB<<","
IF(_STAT==0)
_STR=_STR<<_P5<<","
ELSE
_STR=_STR<<_P4-_P5<<","
ENDIF
_STR=_STR<<"0,"<<_RSTOCK<<","<<_XR<<")"
WRTPR(_STR,1)
GOTOF _M_T
_M_T11:_STR="CYL("<<_P2<<","<<_P3<<","<<_P4<<","<<_P1<<","
IF(_STAT==0)
_STR=_STR<<_P5<<","
ELSE
IF(_P1==1)
_STR=_STR<<_P5+_P2<<","
ELSE
IF(_P1==2)
_STR=_STR<<_P5+_P3<<","
ELSE
_STR=_STR<<_P4-_P5<<","
ENDIF
ENDIF
ENDIF
_STR=_STR<<_P6<<",0,0,"
_STR=_STR<<_ZB<<","<<_RSTOCK<<","<<_XR<<")"
WRTPR(_STR,1)
GOTOF _M_T
_M_T12:_STR="CYL("<<_P2<<","<<_P3<<","<<_P4<<","<<_P1<<","
IF(_STAT==0)
_STR=_STR<<_P5<<","
ELSE
IF(_P1==1)
_STR=_STR<<_P5+_P2<<","
ELSE
IF(_P1==2)
_STR=_STR<<_P5+_P3<<","
ELSE
_STR=_STR<<_P4-_P5<<","
ENDIF
ENDIF
ENDIF
_STR=_STR<<_P6<<","<<_P7<<",0,"
_STR=_STR<<_ZB<<","<<_RSTOCK<<","<<_XR<<")"
WRTPR(_STR,1)
GOTOF _M_T
_M_T13:_STR="CYL(0,0,0,"<<_P1<<",0,0,0,"<<_STAT<<")"
WRTPR(_STR,1)
GOTOF _M_T
_M_T14:_STR="BLOCK("<<_P2<<","<<_P3<<","<<_P4<<","<<_ZB<<","
IF(_STAT==0)
_STR=_STR<<_P5<<","
ELSE
_STR=_STR<<_P4-_P5<<","
ENDIF
_STR=_STR<<"1,"<<_RSTOCK<<","<<_XR<<")"
WRTPR(_STR,1)
GOTOF _M_T
_M_T15:_STR="PINOLE("<<_STAT<<","<<_P1<<")"
WRTPR(_STR,1)
GOTOF _M_T
_M_T:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SL_CIR_SPF
PROC F_SL_CIR(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,REAL _FZ,REAL __Z0,INT _Z0A,REAL __Z1,INT _Z1A,REAL _DZ,REAL _U,REAL _X0,INT _X0A,REAL _Y0,INT _Y0A,REAL _C0,REAL _W,REAL _R,REAL _A0,REAL _A1,REAL _A2,INT _N,INT _ST,REAL _FS,REAL __ZFS,INT _ZFSA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Circumferential Slot
DEF AXIS _AX1,_AX2,_AX3,_CC,_ZZ,_XXR,_YYR,_ZZR
DEF INT _VARI,_BA1,_BA10,_PMZ,_P29,_TM1,_TM3,_TM4,_TM6,_TM8,_TM9,_UMODE=0,_MERKER_C=0,_MAN,_I,_DIR,_DMODE,_AMODE[4],_MD_CLAMP,S_MD_BREAK
DEF REAL _FAK1,_FAK2,_SD,_WZR,_RP,_RP_SD,_SC,_RTP,_XS,_YS,_XST,_YST,_ZST,_Z0,_Z1,_ZFS,_ANG,_ZREF
DEF FRAME _CYC_FR
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_Z0=__Z0 _Z1=__Z1 _ZFS=__ZFS
IF(_TMOD MOD 10 ==0)
IF(_BA B_AND 'H100'=='H100')
_Z0=_Z0/2
IF(_Z1A==90)
_Z1=_Z1/2
ENDIF
IF(_ZFSA==90)
_ZFS=_ZFS/2
ENDIF
ENDIF
ENDIF
_P29=$P_GG[29]
DIAMCYCOF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_F_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
ELSE
_SC=_E_SC*_FAK2
ENDIF
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
_TM1=_TMOD MOD 10 _MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10 _TM4=TRUNC(_TMOD/1000) MOD 10
_TM8=TRUNC(_TMOD/10000000) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_MAN==0)
N14 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
ELSE
_F_INIT=2
_F_RELEAS=1
N16 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
ENDIF
_DMODE=1000
IF(_TM8==1)
_DMODE=_DMODE+10000
ENDIF
IF(_MAN==0)
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2
ENDIF
IF(_Z1A<>90)
IF(_TM3==0)
_Z1=_Z0-ABS(_Z1)
ELSE
_Z1=_Z0+ABS(_Z1)
ENDIF
ENDIF
_AMODE[1]=2
_BA1=_BA B_AND 'B111'
IF(_BA1<1)OR(_BA1>5) GOTOF _FEHL3
IF(_BA1==4)
_BA1=3
ENDIF
IF(_BA1==5)
IF(_ZFSA==91)
_Z1=_Z0-ABS(_ZFS)
ELSE
_Z1=_ZFS
_ZFS=ABS(_Z0-_ZFS)
ENDIF
_AMODE[3]=100
ENDIF
_AMODE[0]=_AMODE[1]+_AMODE[3]
IF(_Z1>_Z0)
_PMZ=1
ELSE
_PMZ=-1
ENDIF
IF((_TM3==0)AND(_PMZ==1))OR((_TM3==1)AND(_PMZ==-1)) GOTOF _FEHL12
IF(_BA B_AND 'B10000000')
_BA10=1
ELSE
_BA10=0
ENDIF
IF(_BA1==2)OR(_BA1==3)
IF(_U>$P_TOOLR*_FAK1*2) GOTOF _FEHL10
ENDIF
_WZR=$P_TOOLR*_FAK1
IF(_BA1==1)
IF(2*_WZR<_W/2-_U) GOTOF _FEHL1
ENDIF
IF(_BA1==2)
IF(2*_WZR<_W/2) GOTOF _FEHL1
ENDIF
_VARI=_BA1+_BA10*10
IF(_ST==0)
_A2=0
_VARI=_VARI+1000
ELSE
_VARI=_VARI+2000
ENDIF
IF(_BA B_AND 'B10000000000')
_VARI=_VARI+100000
ENDIF
F_SP_ED(_SD)
_RTP=_Z0-(_SC+_SD)*_PMZ
IF(_MAN==0)
_RP_SD=_F_RP_ACT*_FAK2-_SD*_PMZ
ENDIF
IF(_BA1<>5)
IF(_DZ<=0) GOTOF _FEHL5
ENDIF
IF($P_TOOLR<0) GOTOF _FEHL8
IF(_U<0) GOTOF _FEHL6
_CYC_FR=$P_CYCFRAME
IF(_TM1<2)
IF(_TM1==0)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=2*_Z0*$PI*_X0/360 _YS=_Y0
ENDIF
ELSE
_XS=_X0 _YS=_Y0
ENDIF
ELSE
IF(_TM1==2)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC+_SD) GOTOF _FEHL14
ENDIF
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
IF(_TM1==3)
_ZZ=$P_AXN3
_C0=((_C0 MOD 360)+360)MOD 360
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
_ANG=_C0
_ZREF=_Z0
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_ZREF)
ELSE
F_SP_TRA(2102,_ZREF)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_ANG)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
F_SP_TRA(2002+_TM1*10,,_ANG)
ENDIF
ENDIF
N98 SLOT2(_RTP,_Z0,_SC,_Z1,0,_N,_A1,_W,_XS,_YS,_R,_A0,_A2,_FZ,_F,_DZ,_E_DIR,_U,_VARI,_DZ,,,,0,_FS,_ZFS,200,_DMODE,_AMODE[0])
$P_CYCFRAME=_CYC_FR
F_SP_TRA(0)
IF(_TM1<2)
IF(_TM1==0)
IF(_MAN==0)
F_SP_RP(0,_RP,_YS,0)
ELSE
F_SP_TRA(2002,_Z0)
_XXR=$P_AXN3 _ZZR=$P_AXN2
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN1
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM9==1)
F_SP_TRA(103102,_Z0)
ELSE
F_SP_TRA(3102,_Z0)
ENDIF
ELSE
F_SP_TRA(2012,_Z0,_C0)
IF(_MAN==0)
F_SP_RP(0,_RP,_YS,0,_XS)
ELSE
_YYR=$P_AXN1 _ZZR=$P_AXN2 _XXR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N45 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
ELSE
IF(_TM1==2)
IF(_MAN==0)
F_SP_RP(0,_SC_POS[3]*_FAK1,_RP,0)
ELSE
F_SP_TRA(2022)
_XXR=$P_AXN1 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN2
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM9==1)
F_SP_TRA(103122)
ELSE
F_SP_TRA(3122)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_MAN==0)
F_SP_RP(9,_SC_POS[0]*_FAK1,_RP,0,_SC_POS[1]*_FAK1)
ELSE
_XXR=$P_AXN1 _YYR=$P_AXN2 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N85 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2 _AX3=$P_AXN3
IF(_MAN==0)
IF(_F_RELEAS==0)
SBLON
N90 G90 G0 G40 AX[_AX1]=_SC_POS[0]*_FAK1 AX[_AX2]=_SC_POS[1]*_FAK1 AX[_AX3]=_RP_SD
SBLOF
ENDIF
ELSE
SBLON
N95 G90 G0 G40 AX[_AX1]=_SC_POS[0]*_FAK1 AX[_AX2]=_SC_POS[1]*_FAK1 AX[_AX3]=_RTP
SBLOF
ENDIF
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
IF(_TM1==0)OR(_TM1==2)
IF(_TM6==2)AND(_BA10==1)AND(_BA1==1)
IF(_TM9==1)
_MERKER_C=3
ELSE
_MERKER_C=1
ENDIF
ELSE
IF(_TM9==1)
_MERKER_C=4
ELSE
_MERKER_C=0
ENDIF
ENDIF
ELSE
IF(_TM6==2)
_MERKER_C=2
ELSE
_MERKER_C=0
ENDIF
ENDIF
IF(_MERKER_C==0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_MERKER_C==1)
_VARI=_VARI+100
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==2)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>1)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
IF(_MERKER_C==3)
_VARI=_VARI+300
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==4)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N100 SLOT2(_RTP,_Z0,_SC,_Z1,0,_N,_A1,_W,_XS,_YS,_R,_A0,_A2,_FZ,_F,_DZ,_E_DIR,_U,_VARI,_DZ,,,,_UMODE,_FS,_ZFS,100,_DMODE,_AMODE[0])
IF(_MERKER_C==1)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
IF(_MERKER_C==3)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
IF(_MAN<>0)
IF(_TM1>=2)
IF(_TM1==2)
F_SP_TRA(2022)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N160 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N170 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ELSE
IF(_TM1==0)
F_SP_TRA(2012,_Z0,_C0)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N180 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N190 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ENDIF
ENDIF
G[29]=_P29
_E_S_LINE=0
_RETS:
_F_RELEAS=0
SBLON
RET
_FEHL1: STOPRE
N931101 SETAL(61007)
RET
_FEHL3: STOPRE
N931103 SETAL(61002)
RET
_FEHL5: STOPRE
N931105 SETAL(61610)
RET
_FEHL6: STOPRE
N931106 SETAL(61253)
RET
_FEHL7: STOPRE
N931107 SETAL(61222)
RET
_FEHL8: STOPRE
N931108 SETAL(61112)
RET
_FEHL10: STOPRE
N931110 SETAL(61010)
RET
_FEHL12: STOPRE
N931112 SETAL(61242)
RET
_FEHL13: STOPRE
N931113 SETAL(61284)
RET
_FEHL14: STOPRE
N931114 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SL_LON_SPF
PROC F_SL_LON(INT _OB,INT _BO,INT _IDD,STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,REAL _FZ,INT _FZA,REAL __Z0,INT _Z0A,REAL __Z1,INT _Z1A,REAL _DZ,INT _REF,REAL _X0,INT _X0A,REAL _Y0,INT _Y0A,REAL _C0,REAL _L,REAL _W,REAL _A0,REAL _UXY,REAL _UZ,REAL _DXY,INT _POS,INT _DXYA,REAL _FS,REAL __ZFS,INT _ZFSA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Longitudinal Slot
DEF AXIS _AX1,_AX2,_AX3,_CC,_ZZ,_XXR,_YYR,_ZZR
DEF INT _BA1,_BA10,_PMZ,_VARI,_INI=1,_P29,_TM1,_TM3,_TM4,_TM6,_TM8,_TM9,_UMODE=0,_MERKER_C=0,_MAN,_I,_DIR,_AMODE[4],_DMODE,_GMODE,_MD_CLAMP,S_MD_BREAK
DEF REAL _FAK1,_FAK2,_RP,_RP_SD,_SC,_SD,_SD1,_SD2,_ZREF,_RTP,_XS,_YS,_ANG,_XST,_YST,_ZST,_Z0,_Z1,_ZFS
DEF FRAME _CYC_FR
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
_P29=$P_GG[29]
DIAMCYCOF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
IF($P_MC==0)
_F_INIT=1
ENDIF
ELSE
_SC=_E_SC*_FAK2
ENDIF
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
IF(_OB==0)OR(_OB==4)
_DMODE=0
IF(_OB==0)
IF(NOT _E_MC)
GOTOF _RET
ENDIF
IF(_INI)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD]
_DD=_E_TR[_IDD,1] _F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6] _BA=_E_TR[_IDD,7] _FZ=_E_TR[_IDD,8]
_FZA=_E_TR[_IDD,9] _Z0A=_E_TR[_IDD,11]
_Z1A=_E_TR[_IDD,13] _DZ=_E_TR[_IDD,14] _REF=_E_TR[_IDD,15]
_X0A=_E_TR[_IDD,17] _Y0A=_E_TR[_IDD,19] _L=_E_TR[_IDD,20]
_W=_E_TR[_IDD,21] _A0=_E_TR[_IDD,22] _UXY=_E_TR[_IDD,23] _UZ=_E_TR[_IDD,24]
_DXYA=_E_TR[_IDD,26] _C0=_E_TR[_IDD,27]
_FS=_E_TR[_IDD,28]
_INI=0
ENDIF
IF(_F_PS_REF<>_SC_NO_VAL)
_ZREF=_F_PS_REF*_FAK2
ENDIF
_Z0=_ZREF _Z1=_E_TR[_IDD,12] _DXY=_E_TR[_IDD,25] _ZFS=_E_TR[_IDD,29] _ZFSA=_E_TR[_IDD,30]
_TM1=_TMOD MOD 10 _TM3=TRUNC(_TMOD/100) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_CC=_F_S_AX[_F_MASPI]
_ANG=_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]-$P_ACTFRAME[_CC,TR]
ENDIF
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_ZREF)
ELSE
F_SP_TRA(2102,_ZREF)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_ANG)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
F_SP_TRA(2002+_TM1*10,,_ANG)
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2
_XS=$P_EP[_AX1]*_FAK1 _YS=$P_EP[_AX2]*_FAK1
_E_BO=_BO+(_E_BO B_AND 65535)
N10 F_TFS(,,,_F,_FAA,,,2,0)
_M_1:
IF(_DXYA==1)
_DXY=_DXY/100*(2*$P_TOOLR*_FAK1)
ENDIF
_AMODE[2]=0
IF(_Z1A<>90)
IF(_TM3==0)
_Z1=_Z0-ABS(_Z1)
ELSE
_Z1=_Z0+ABS(_Z1)
ENDIF
ENDIF
_AMODE[1]=0
_BA1=_BA B_AND 'B111'
IF(_BA1<1)OR(_BA1==3)OR(_BA1>5) GOTOF _FEHL3
IF(_BA1==5)
IF(_ZFSA==91)
_Z1=_Z0-ABS(_ZFS)
ELSE
_Z1=_ZFS
_ZFS=ABS(_Z0-_ZFS)
ENDIF
_AMODE[3]=100
ENDIF
_AMODE[0]=_AMODE[1]+_AMODE[2]+_AMODE[3]
_GMODE=1000+10000
IF(_Z1>_Z0)
_PMZ=1
ELSE
_PMZ=-1
ENDIF
IF((_TM3==0)AND(_PMZ==1))OR((_TM3==1)AND(_PMZ==-1)) GOTOF _FEHL12
IF(_BA1==1)
IF(_DXY>$P_TOOLR*_FAK1*2) GOTOF _FEHL7
ENDIF
IF(_BA1<>5)
IF(_UXY>$P_TOOLR*_FAK1*2) GOTOF _FEHL10
ENDIF
IF(_FZA<>2)OR((_BA B_AND 'B111')==5)
_BA10=1
ELSE
_BA10=3
ENDIF
_VARI=_BA1+_BA10*10
IF(_BA B_AND 'B10000000000')
_VARI=_VARI+100000
ENDIF
IF(_BA1<>5)
IF(_DZ<=0) GOTOF _FEHL5
ENDIF
F_SP_ED(_SD)
_RTP=_ZREF-(_SC+_SD)*_PMZ
IF($P_TOOLR<0) GOTOF _FEHL8
_M_2:
ELSE
_TM1=_TMOD MOD 10 _MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10 _TM4=TRUNC(_TMOD/1000) MOD 10
_TM8=TRUNC(_TMOD/10000000) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
_Z0=__Z0 _Z1=__Z1 _ZFS=__ZFS
IF(_TM1==0)
IF((_BA B_AND 'B1000')<>'B0000')
_Z0=_Z0/2
IF(_Z1A==90)
_Z1=_Z1/2
ENDIF
IF(_ZFSA==90)
_ZFS=_ZFS/2
ENDIF
ENDIF
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
_E_BO=0
IF(_MAN==0)
N14 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
ELSE
_F_INIT=2
_F_RELEAS=1
N16 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
ENDIF
IF(_MAN==0)
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2
ENDIF
_ZREF=_Z0
REPEAT _M_1 _M_2
IF(_MAN==0)
_RP_SD=_F_RP_ACT*_FAK2-_SD*_PMZ
ENDIF
_CYC_FR=$P_CYCFRAME
IF(_TM1<2)
IF(_TM1==0)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=2*_Z0*$PI*_X0/360 _YS=_Y0
ENDIF
ELSE
_XS=_X0 _YS=_Y0
ENDIF
ELSE
IF(_TM1==2)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC+_SD) GOTOF _FEHL14
ENDIF
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
IF(_TM1==3)
_ZZ=$P_AXN3
_C0=((_C0 MOD 360)+360)MOD 360
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
_ANG=_C0
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_ZREF)
ELSE
F_SP_TRA(2102,_ZREF)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_ANG)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
F_SP_TRA(2002+_TM1*10,,_ANG)
ENDIF
ENDIF
IF(_TM8==1)
_DMODE=_DMODE+10000
ENDIF
N98 POCKET3(_RTP,_Z0,_SC,_Z1,_L,_W,_W/2,_XS,_YS,_A0,_DZ,_UXY,_UZ,_F,_FZ,_E_DIR,_VARI,_DXY,0,0,0,_FZ,0,0,_FS,_ZFS,_GMODE+200,_DMODE,_AMODE[0])
$P_CYCFRAME=_CYC_FR
F_SP_TRA(0)
IF(_TM1<2)
IF(_TM1==0)
IF(_MAN==0)
F_SP_RP(0,_RP,_YS,0)
ELSE
F_SP_TRA(2002,_Z0)
_XXR=$P_AXN3 _ZZR=$P_AXN2
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN1
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM9==1)
F_SP_TRA(103102,_Z0)
ELSE
F_SP_TRA(3102,_Z0)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_C0)
IF(_MAN==0)
F_SP_RP(0,_RP,_YS,0,_XS)
ELSE
_YYR=$P_AXN1 _ZZR=$P_AXN2 _XXR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N45 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
ELSE
IF(_TM1==2)
IF(_MAN==0)
F_SP_RP(0,_SC_POS[3]*_FAK1,_RP,0)
ELSE
F_SP_TRA(2022)
_XXR=$P_AXN1 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN2
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM9==1)
F_SP_TRA(103122)
ELSE
F_SP_TRA(3122)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_MAN==0)
F_SP_RP(9,_SC_POS[0]*_FAK1,_RP,0,_SC_POS[1]*_FAK1)
ELSE
_XXR=$P_AXN1 _YYR=$P_AXN2 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL13
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N85 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2 _AX3=$P_AXN3
IF(_MAN==0)
IF(_F_RELEAS==0)
SBLON
N90 G90 G0 G40 AX[_AX1]=_SC_POS[0]*_FAK1 AX[_AX2]=_SC_POS[1]*_FAK1 AX[_AX3]=_RP_SD
SBLOF
ENDIF
ELSE
SBLON
N95 G90 G0 G40 AX[_AX1]=_SC_POS[0]*_FAK1 AX[_AX2]=_SC_POS[1]*_FAK1 AX[_AX3]=_RTP
SBLOF
ENDIF
ENDIF
IF(_MAN==0)
N100 F_TFS("","",_DD,_F,_FAA,_S,_SA,2,0)
ELSE
N102 F_TFS("","",_DD,_F,_FAA,_S,_SA,2,8)
ENDIF
IF($P_F_TYPE==11)OR($P_F_TYPE==33)
IF(_FZA==0)
_DMODE=_DMODE+10
ELSE
_DMODE=_DMODE+20
ENDIF
ELSE
IF(_FZA==0)
_DMODE=_DMODE+20
ELSE
_DMODE=_DMODE+10
ENDIF
ENDIF
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
IF(_TM1==0)OR(_TM1==2)
IF(_TM6==2)AND(_BA10==1)AND(_BA1==1)
IF(_TM9==1)
_MERKER_C=3
ELSE
_MERKER_C=1
ENDIF
ELSE
IF(_TM9==1)
_MERKER_C=4
ELSE
_MERKER_C=0
ENDIF
ENDIF
ELSE
IF(_TM6==2)
_MERKER_C=2
ELSE
_MERKER_C=0
ENDIF
ENDIF
IF(_MERKER_C==0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_MERKER_C==1)
_VARI=_VARI+100
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==2)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>1)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
IF(_MERKER_C==3)
_VARI=_VARI+300
_UMODE=_F_MASPI*10
ENDIF
IF(_MERKER_C==4)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N150 POCKET3(_RTP,_ZREF,_SC,_Z1,_L,_W,_W/2,_XS,_YS,_A0,_DZ,_UXY,_UZ,_F,_FZ,_E_DIR,_VARI,_DXY,0,0,0,_FZ,0,_UMODE,_FS,_ZFS,_GMODE+100,_DMODE,_AMODE[0])
IF(_MERKER_C==1)
IF(_TM1==0)AND((_W-2*_UXY)==2*$P_TOOLR*_FAK1)AND((((_A0 MOD 360)+360)MOD 180)==90)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ELSE
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_MERKER_C==3)
IF(_TM1==0)AND((_W-2*_UXY)==2*$P_TOOLR*_FAK1)AND((((_A0 MOD 360)+360)MOD 180)==90)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ELSE
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
ENDIF
IF(_OB==4)AND(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
IF(_MAN<>0)
IF(_TM1>=2)
IF(_TM1==2)
F_SP_TRA(2022)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N160 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N170 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ELSE
IF(_TM1==0)
F_SP_TRA(2012,_ZREF,_C0)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N180 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N190 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ENDIF
ENDIF
ELSE
IF(_OB==3)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD] _DD=_E_TR[_IDD,1]
_F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4] _SA=_E_TR[_IDD,5]
_TMOD=_E_TR[_IDD,6]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N200 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
_F_RELEAS=0
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2 _ZREF=_Z0
ELSE
IF(_E_IR<_E_MAX)
_Z0=__Z0 _Z1=__Z1 _ZFS=__ZFS
IF(_TMOD MOD 10 ==0)
IF((_BA B_AND 'B1000')<>'B0000')
_Z0=_Z0/2
IF(_Z1A==90)
_Z1=_Z1/2
ENDIF
IF(_ZFSA==90)
_ZFS=_ZFS/2
ENDIF
ENDIF
ENDIF
_E_TS1[_E_IR]=_T _E_TS2[_E_IR]=_TF
_E_TR[_E_IR,0]=SET(15,_DD,_F,_FAA,_S,_SA,_TMOD,_BA,_FZ,_FZA,_Z0,_Z0A,_Z1,_Z1A,_DZ,_REF,_X0,_X0A,_Y0,_Y0A,_L,_W,_A0,_UXY,_UZ,_DXY,_DXYA,_C0,_FS,_ZFS,_ZFSA)
_E_IR=_E_IR+1
IF(_POS>=0)
_E_POS=_POS
ENDIF
ELSE
GOTOF _FEHL4
ENDIF
IF(_OB==2)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
G[29]=_P29
_E_S_LINE=0
_RETS:
IF(_E_POS==0)
_F_RELEAS=0
ENDIF
SBLON
RET
_FEHL3: STOPRE
N931003 SETAL(61002)
RET
_FEHL4: STOPRE
N931004 SETAL(61200)
RET
_FEHL5: STOPRE
N931005 SETAL(61610)
RET
_FEHL7: STOPRE
N931007 SETAL(61222)
RET
_FEHL8: STOPRE
N931008 SETAL(61112)
RET
_FEHL10: STOPRE
N931010 SETAL(61010)
RET
_FEHL12: STOPRE
N931012 SETAL(61242)
RET
_FEHL13: STOPRE
N931013 SETAL(61284)
RET
_FEHL14: STOPRE
N931014 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SP_LAB_SPF
PROC F_SP_LAB DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.04.22.00 ;DATE: 2011-09-07
;Subprogram to set the search run label
DEF INT S_UP=6
IF($P_STACK<S_UP)
F_SP_LAB
ELSE
IF($P_STACK==S_UP)
_E_LAB_SSL:
G4 F0
ELSE
N934701 SETAL(61854)
ENDIF
ENDIF
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SL_OPN_SPF
PROC F_SL_OPN(INT _OB,INT _BO,INT _IDD,STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,INT _CDIR,REAL __Z0,REAL __Z1,INT _Z1A,REAL _DZ,INT _REF,REAL _X0,INT _X0A,REAL _Y0,INT _Y0A,REAL _C0,REAL _L,REAL _W,REAL _A0,REAL _UXY,REAL _UZ,REAL _DXY,INT _DXYA,INT _POS,REAL _FS,REAL __ZFS,INT _ZFSA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Open Slot
DEF AXIS _AX1,_AX2,_AX3,_CC,_ZZ,_XXR,_YYR,_ZZR
DEF INT _BA1,_BA2,_INI=1,_MAN,_PMZ,_P29,_TM1,_TM3,_TM4,_TM6,_TM8,_TM9,_I,_DIR,_VARI,_AMODE[5],_DMODE,_MD_CLAMP,S_MD_BREAK,_MERKER_C=0
DEF REAL _ANG,_FAK1,_FAK2,_RP,_RP_SD,_RTP,_SC,_SD,_SD1,_SD2,_XS,_YS,_XST,_YST,_ZREF,_ZST,_Z0,_Z1,_ZFS
DEF FRAME _CYC_FR
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
G4 F0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_P29=$P_GG[29]
DIAMCYCOF
G40 G90 NORM
IF S_CALL_FROM_MA_JOG_STEP
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
IF($P_MC==0)
_F_INIT=1
ENDIF
ELSE
_SC=_E_SC*_FAK2
ENDIF
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
IF(_OB==0)OR(_OB==4)
IF(_OB==0)
IF(NOT _E_MC)
GOTOF _RET
ENDIF
IF(_INI)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD]
_DD=_E_TR[_IDD,1] _F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4]
_SA=_E_TR[_IDD,5] _TMOD=_E_TR[_IDD,6] _BA=_E_TR[_IDD,7]
_Z1A=_E_TR[_IDD,11] _DZ=_E_TR[_IDD,12] _REF=_E_TR[_IDD,13]
_X0A=_E_TR[_IDD,15] _Y0A=_E_TR[_IDD,17]
_C0=_E_TR[_IDD,18] _L=_E_TR[_IDD,19] _W=_E_TR[_IDD,20] _A0=_E_TR[_IDD,21]
_UXY=_E_TR[_IDD,22] _UZ=_E_TR[_IDD,23] _DXYA=_E_TR[_IDD,25]
_FS=_E_TR[_IDD,26]
_INI=0
ENDIF
IF(_F_PS_REF<>_SC_NO_VAL)
_ZREF=_F_PS_REF*_FAK2
ENDIF
_CDIR=_E_TR[_IDD,8] _Z0=_ZREF _Z1=_E_TR[_IDD,10] _DXY=_E_TR[_IDD,24]
_ZFS=_E_TR[_IDD,27] _ZFSA=_E_TR[_IDD,28]
_TM1=_TMOD MOD 10 _TM3=TRUNC(_TMOD/100) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
_CC=_F_S_AX[_F_MASPI]
_ANG=_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]-$P_ACTFRAME[_CC,TR]
ENDIF
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_ZREF)
ELSE
F_SP_TRA(2102,_ZREF)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_ANG)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
F_SP_TRA(2002+_TM1*10,,_ANG)
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2
_XS=$P_EP[_AX1]*_FAK1 _YS=$P_EP[_AX2]*_FAK1
_E_BO=_BO+(_E_BO B_AND 65535)
N10 F_TFS(,,,_F,_FAA,,,2,0)
_M_1:
IF(_Z1A<>90)
IF(_TM3==0)
_Z1=_Z0-ABS(_Z1)
ELSE
_Z1=_Z0+ABS(_Z1)
ENDIF
ENDIF
_AMODE[1]=0
_BA1=(_BA B_AND 'B111') _BA2=0
IF(_BA1<1)OR(_BA1==3)OR(_BA1>7) GOTOF _FEHL1
IF(_BA1==1)OR(_BA1==2)OR(_BA1==4)
_VARI=_BA1
ENDIF
IF(_BA1==6)
_VARI=3
ENDIF
IF(_BA1==7)
_VARI=5
ENDIF
_AMODE[2]=10*_DXYA
_AMODE[4]=1000*(_BA B_AND 'H400')/'H400'
IF(_BA1==5)
_VARI=6
IF(_ZFSA==91)
_Z1=_Z0-ABS(_ZFS)
ELSE
_Z1=_ZFS
_ZFS=ABS(_Z0-_ZFS)
ENDIF
_DZ=_ZFS _DXY=_FS _UZ=0 _UXY=_FS
_AMODE[2]=0
_AMODE[3]=100
ENDIF
IF(_BA B_AND 'B1000')
_BA2=1
ENDIF
IF(_BA B_AND 'B10000')
_BA2=_BA2+2
ENDIF
IF(_BA2<1)OR(_BA2>2) GOTOF _FEHL1
_VARI=_VARI+_BA2*1000
IF(_Z1>_Z0)
_PMZ=1
ELSE
_PMZ=-1
ENDIF
IF((_TM3==0)AND(_PMZ==1))OR((_TM3==1)AND(_PMZ==-1)) GOTOF _FEHL2
F_SP_ED(_SD)
_RTP=_ZREF-(_SC+_SD)*_PMZ
_AMODE[0]=_AMODE[1]+_AMODE[2]+_AMODE[3]+_AMODE[4]
_M_2:
ELSE
_TM1=_TMOD MOD 10 _MAN=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10 _TM4=TRUNC(_TMOD/1000) MOD 10
_TM8=TRUNC(_TMOD/10000000) MOD 10
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
_Z0=__Z0 _Z1=__Z1 _ZFS=__ZFS
IF(_TM1==0)
IF((_BA B_AND 'B100000')<>'B000000')
_Z0=_Z0/2
IF(_Z1A==90)
_Z1=_Z1/2
ENDIF
IF(_ZFSA==90)
_ZFS=_ZFS/2
ENDIF
ENDIF
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
_E_BO=0
IF(_MAN==0)
N14 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
ELSE
_F_INIT=2
_F_RELEAS=1
N16 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,2,8)
ENDIF
IF(_MAN==0)
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2
ENDIF
_ZREF=_Z0
REPEAT _M_1 _M_2
IF(_MAN==0)
_RP_SD=_F_RP_ACT*_FAK2-_SD*_PMZ
ENDIF
_CYC_FR=$P_CYCFRAME
IF(_TM1<2)
IF(_TM1==0)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=2*_Z0*$PI*_X0/360 _YS=_Y0
ENDIF
ELSE
_XS=_X0 _YS=_Y0
ENDIF
ELSE
IF(_TM1==2)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC+_SD) GOTOF _FEHL5
ENDIF
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
IF(_TM1==3)
_ZZ=$P_AXN3
_C0=((_C0 MOD 360)+360)MOD 360
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
_ANG=_C0
IF(_TM1<2)
IF(_TM1==0)
IF(_TM9==1)
F_SP_TRA(102102,_ZREF)
ELSE
F_SP_TRA(2102,_ZREF)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_ANG)
ENDIF
ELSE
IF(_TM1==2)
IF(_TM9==1)
F_SP_TRA(102122)
ELSE
F_SP_TRA(2122)
ENDIF
ELSE
F_SP_TRA(2002+_TM1*10,,_ANG)
ENDIF
ENDIF
_DMODE=0
IF(_TM8==1)
_DMODE=_DMODE+10000
ENDIF
N98 CYCLE899(_RTP,_ZREF,_SC,_Z1,_L,_W,_XS,_YS,_A0,_DZ,_DXY,_UXY,_UZ,_F,_CDIR,_VARI,200+_REF*1000,_DMODE,_AMODE[0],,_FS,_ZFS)
$P_CYCFRAME=_CYC_FR
F_SP_TRA(0)
IF(_TM1<2)
IF(_TM1==0)
IF(_MAN==0)
F_SP_RP(0,_RP,_YS,0)
ELSE
F_SP_TRA(2002,_Z0)
_XXR=$P_AXN3 _ZZR=$P_AXN2
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN1
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL4
ENDIF
IF(_TM9==1)
F_SP_TRA(103102,_Z0)
ELSE
F_SP_TRA(3102,_Z0)
ENDIF
ELSE
F_SP_TRA(2012,_ZREF,_C0)
IF(_MAN==0)
F_SP_RP(0,_RP,_YS,0,_XS)
ELSE
_YYR=$P_AXN1 _ZZR=$P_AXN2 _XXR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_XST*_PMZ>_RTP*_PMZ) GOTOF _FEHL4
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N45 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
ELSE
IF(_TM1==2)
IF(_MAN==0)
F_SP_RP(0,_SC_POS[3]*_FAK1,_RP,0)
ELSE
F_SP_TRA(2022)
_XXR=$P_AXN1 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_F_Y_AXIS<>0)
_YYR=$P_AXN2
_YST=$P_EP[_YYR]*_FAK1
ENDIF
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL4
ENDIF
IF(_TM9==1)
F_SP_TRA(103122)
ELSE
F_SP_TRA(3122)
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_MAN==0)
F_SP_RP(9,_SC_POS[0]*_FAK1,_RP,0,_SC_POS[1]*_FAK1)
ELSE
_XXR=$P_AXN1 _YYR=$P_AXN2 _ZZR=$P_AXN3
_XST=$P_EP[_XXR]*_FAK1 _YST=$P_EP[_YYR]*_FAK1 _ZST=$P_EP[_ZZR]*_FAK1
IF(_ZST*_PMZ>_RTP*_PMZ) GOTOF _FEHL4
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N85 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2 _AX3=$P_AXN3
IF(_MAN==0)
IF(_F_RELEAS==0)
SBLON
N90 G90 G0 G40 AX[_AX1]=_SC_POS[0]*_FAK1 AX[_AX2]=_SC_POS[1]*_FAK1 AX[_AX3]=_RP_SD
SBLOF
ENDIF
ELSE
SBLON
N95 G90 G0 G40 AX[_AX1]=_SC_POS[0]*_FAK1 AX[_AX2]=_SC_POS[1]*_FAK1 AX[_AX3]=_RTP
SBLOF
ENDIF
ENDIF
IF(_MAN==0)
N100 F_TFS("","",_DD,_F,_FAA,_S,_SA,2,0)
ELSE
N102 F_TFS("","",_DD,_F,_FAA,_S,_SA,2,8)
ENDIF
IF(_TM6==0)
_TM6=2
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
IF(_TM1==0)OR(_TM1==2)
IF(_TM9==1)
_MERKER_C=4
ELSE
_MERKER_C=0
ENDIF
ELSE
IF(_TM6==2)
_MERKER_C=2
ELSE
_MERKER_C=0
ENDIF
ENDIF
IF(_MERKER_C==0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_MERKER_C==2)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>1)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
IF(_MERKER_C==4)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N150 CYCLE899(_RTP,_ZREF,_SC,_Z1,_L,_W,_XS,_YS,_A0,_DZ,_DXY,_UXY,_UZ,_F,_CDIR,_VARI,100+_REF*1000,_DMODE,_AMODE[0],,_FS,_ZFS)
ENDIF
IF(_OB==4)AND(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
IF(_MAN<>0)
IF(_TM1>=2)
IF(_TM1==2)
F_SP_TRA(2022)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N160 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N170 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ELSE
IF(_TM1==0)
F_SP_TRA(2012,_ZREF,_C0)
ENDIF
IF(_F_Y_AXIS==0)
SBLON
N180 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST
SBLOF
ELSE
SBLON
N190 G90 G0 AX[_XXR]=_XST AX[_ZZR]=_ZST AX[_YYR]=_YST
SBLOF
ENDIF
ENDIF
ENDIF
ELSE
IF(_OB==3)
_T=_E_TS1[_IDD] _TF=_E_TS2[_IDD] _DD=_E_TR[_IDD,1]
_F=_E_TR[_IDD,2] _FAA=_E_TR[_IDD,3] _S=_E_TR[_IDD,4] _SA=_E_TR[_IDD,5]
_TMOD=_E_TR[_IDD,6]
_TM1=_TMOD MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N200 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,2,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
_F_RELEAS=0
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2 _ZREF=_Z0
ELSE
IF(_E_IR<_E_MAX)
_Z0=__Z0 _Z1=__Z1 _ZFS=__ZFS
IF(_TMOD MOD 10 ==0)
IF((_BA B_AND 'B100000')<>'B000000')
_Z0=_Z0/2
IF(_Z1A==90)
_Z1=_Z1/2
ENDIF
IF(_ZFSA==90)
_ZFS=_ZFS/2
ENDIF
ENDIF
ENDIF
_E_TS1[_E_IR]=_T _E_TS2[_E_IR]=_TF
_E_TR[_E_IR,0]=SET(16,_DD,_F,_FAA,_S,_SA,_TMOD,_BA,_CDIR,_Z0,_Z1,_Z1A,_DZ,_REF,_X0,_X0A,_Y0,_Y0A,_C0,_L,_W,_A0,_UXY,_UZ,_DXY,_DXYA,_FS,_ZFS,_ZFSA)
_E_IR=_E_IR+1
IF(_POS>=0)
_E_POS=_POS
ENDIF
ELSE
GOTOF _FEHL3
ENDIF
IF(_OB==2)
F_MANAGE
ENDIF
ENDIF
ENDIF
_RET:
G[29]=_P29
_E_S_LINE=0
_RETS:
IF(_E_POS==0)
_F_RELEAS=0
ENDIF
SBLON
RET
_FEHL1: STOPRE
N989901 SETAL(61002)
RET
_FEHL2: STOPRE
N989902 SETAL(61242)
RET
_FEHL3: STOPRE
N989903 SETAL(61200)
RET
_FEHL4: STOPRE
N989904 SETAL(61284)
RET
_FEHL5: STOPRE
N989905 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SP_BC_SPF
PROC F_SP_BC(INT _MODE,REAL _BETA,REAL _GAMA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.002 ;DATE: 2024-01-09
;ShopTurn: Swivelling Cycle
DEF AXIS _ZZ
DEF INT _I,_II,_III,_H,_FOUND
DEF INT _TCI=0,_DIR=0,_STATUS=0,_MASPI=0,_MOD1,_MOD2,_MOD3,_MOD4,_MODUS,_BFACE=0,S_READY=0,_MOD5,_MOD6,S_TI,S_MTI,S_MTP,S_MTTYP,S_MTA,S_MTAV,S_TURN
DEF REAL _PDEG,_A,_B,_C,_D_B,_D_C,S_BB,S_CC,S_C
DEF STRING[32] _TC
DEF FRAME _PFRAME
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_SP_BC_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
; DELETE(_LOG,_LOG_FILE)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"_MODE="<<_MODE<<" Beta="<<_BETA<<" Gamma="<<_GAMA)
ENDIF
IF($P_GG[6]==1)
_ZZ=$P_AXN3
ELSE
IF($P_GG[6]==2)
_ZZ=$P_AXN1
ELSE
_ZZ=$P_AXN2
ENDIF
ENDIF
S_M_BEGIN:
_MODUS=57
_MOD1=_MODE MOD 10
_MOD2=TRUNC(_MODE/10) MOD 10
_MOD3=TRUNC(_MODE/100) MOD 10
_MOD4=_MODE _DEC4
_MOD5=_MODE _DEC5
_MOD6=_MODE _DEC6
_PDEG=$MN_INT_INCR_PER_DEG
IF(_MOD1==8)
S_TURN=FALSE
IF($P_TOOL)
IF($P_AD[1]>=500)AND($P_AD[1]<=599)
S_TURN=TRUE
ENDIF
ENDIF
IF(S_TURN)
IF(_F_TC_ACT>0)
_F_TC_DEF[2]=_F_TC_ACT
ENDIF
_TCI=_F_TC_DEF[2]
ELSE
IF(_F_TC_ACT>0)
_F_TC_DEF[3]=_F_TC_ACT
ENDIF
_TCI=_F_TC_DEF[3]
ENDIF
ELSE
IF(_MOD1==6)
IF(_F_TC_ACT>0)
_F_TC_DEF[_F_MASPI/2]=_F_TC_ACT
ENDIF
_TCI=_F_TC_DEF[_F_MASPI/2]
ELSE
IF(_MOD1==9)
IF(_F_TC_ACT>0)
_F_TC_DEF[2]=_F_TC_ACT
ENDIF
_TCI=_F_TC_DEF[2]
ELSE
IF(_MOD1==4)
IF(_F_TC_ACT>0)
_F_TC_DEF[2]=_F_TC_ACT
ENDIF
_TCI=_F_TC_DEF[2]
ELSE
IF(_F_TC_ACT>0)
_F_TC_DEF[3]=_F_TC_ACT
ENDIF
_TCI=_F_TC_DEF[3]
ENDIF
ENDIF
ENDIF
ENDIF
S_BB=_BETA
S_CC=_GAMA
IF(S_BB<>_SC_A_NO_VAL)
S_BB=S_BB+_F_TC_DIFF_B*(1-_F_MASPI)
ENDIF
_TC_N_WZ=_MOD2
IF(_MOD2)
N4 CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
N5 CUST_TECHCYC(1+_F_MASPI*10)
ENDIF
IF(_MOD1<6)OR(_MOD1==9)
_F_TRA_C=0
IF(_MOD1==9)
$P_CYCFRAME=CTRANS()
ELSE
$P_CYCFRAME[_F_S_AX[_F_MASPI],TR]=_F_TRA_C
ENDIF
ENDIF
IF(_MOD1==9)
IF((_TCI==0)OR((_TCI==$P_TC)AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100')))) GOTOF _RET
CYCLE213(_TCI)
S_BB=$P_EP[AXNAME($TC_CARR35[_TCI])]
IF(($P_SMODE[_F_S_NR[1]]==4)OR($P_SMODE[_F_S_NR[1]]==2))AND($TC_CARR36[_TCI]<>"")
S_CC=$P_EP[AXNAME($TC_CARR36[_TCI])]
ELSE
S_CC=0
ENDIF
WRTPR("IGNORE(16,0)",1)
REPEAT _DEL_FRAME_A _DEL_FRAME_E
REPEAT _SET_TCARR_A _SET_TCARR_E
WRTPR("IGNORE(32,0)",1)
GOTOF _RET
ENDIF
IF(_F_TC_ACT)AND(_MOD1<>6)
S_CC=_SC_A_NO_VAL
ENDIF
IF(_MOD1==7)OR(_MOD1==8)
IF(_MOD1==7)
_TCI=$P_TC
ENDIF
IF(_TCI==0)OR(($P_SUBPAR[2]==0)AND($P_SUBPAR[3]==0)) GOTOF _RET
IF(S_BB==_SC_A_NO_VAL)AND(_C==_SC_A_NO_VAL) GOTOF _RET
IF(S_BB==_SC_A_NO_VAL)
CYCLE213(_TCI)
S_BB=$P_EP[AXNAME($TC_CARR35[_TCI])]
ELSE
IF(_MOD1==7)
REPEAT _GEO2AX_A _GEO2AX_E
ENDIF
ENDIF
IF(S_CC<>_SC_A_NO_VAL)
IF(_TCI==_F_TC_DEF[2]) ;AND($P_TOOL)
;IF($P_AD[1]<500)OR($P_AD[1]>599)
; S_CC=_SC_A_NO_VAL
;ENDIF
ELSE
S_CC=_SC_A_NO_VAL
ENDIF
ENDIF
WRTPR("IGNORE(16,0)",1)
IF(_MOD1==8)
REPEAT _DEL_FRAME_A _DEL_FRAME_E
ENDIF
REPEAT _SET_TCARR_A _SET_TCARR_E
IF(S_CC<>_SC_A_NO_VAL)
CUST_TECHCYC(14)
CUST_TECHCYC(11)
IF(_MOD2)
N18 F_SWIV_H(_TCI,S_BB,_SC_A_NO_VAL)
_TC_N_WZ=0
ENDIF
ENDIF
N20 F_SWIV_H(_TCI,S_BB,S_CC)
IF(S_CC<>_SC_A_NO_VAL)
CUST_TECHCYC(13)
IF($P_SMODE[_F_S_NR[1]]==1)
_F_SP_CL_TURN=1
ELSE
_F_SP_CL_TURN=0
ENDIF
ENDIF
WRTPR("IGNORE(32,0)",1)
GOTOF _RET
ENDIF
IF(_MOD1==6)
IF(_TCI)
CYCLE213(_TCI)
S_BB=_TC_A1
IF(_TC_A2<>_SC_A_NO_VAL)
S_CC=_TC_A2
ELSE
S_CC=$P_EP[AXNAME($TC_CARR36[_TCI])]
ENDIF
IF(_TCI)AND(_TCI==$P_TC)AND(($P_AD[1]>=500)AND($P_AD[1]<=599))
S_CC=$TC_CARR14[_TCI]
ENDIF
IF(ROUND(S_BB*_PDEG)<>ROUND($P_EP[AXNAME($TC_CARR35[_TCI])]*_PDEG))OR(ROUND(S_CC*_PDEG)<>ROUND($P_EP[AXNAME($TC_CARR36[_TCI])]*_PDEG))
WRTPR("IGNORE(16,0)",1)
IF(_TCI<>$P_TC)
REPEAT _SET_TCARR_A _SET_TCARR_E
ENDIF
IF(_MOD3==0)
N40 F_SP_RP(1,,,1)
ENDIF
IF(S_CC<>_SC_A_NO_VAL)
IF(S_CC-$P_ACTFRAME[_F_S_AX[_F_MASPI],TR]<$TC_CARR31[_TCI])
S_CC=S_CC+360
ENDIF
IF(S_CC-$P_ACTFRAME[_F_S_AX[_F_MASPI],TR]>$TC_CARR33[_TCI])
S_CC=S_CC-360
ENDIF
ENDIF
N46 CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
N48 CUST_TECHCYC(1+_F_MASPI*10)
N50 F_SWIV_H(_TCI,S_BB,S_CC)
WRTPR("IGNORE(32,0)",1)
ENDIF
WRTPR("CPOS("<<$P_PFRAME[_F_S_AX[_F_MASPI],TR]+$P_CYCFRAME[_F_S_AX[_F_MASPI],TR]<<")",1)
ENDIF
CUST_TECHCYC(14)
G17
GOTOF _RET
ENDIF
IF(_MOD1==4)OR(_MOD1==5)
_DIR=_F_MASPI-1
_MASPI=1
IF(_TCI==0) GOTOF _RET
_STATUS=_MOD2*10+200
IF(S_BB==_SC_A_NO_VAL)
CYCLE213(_TCI)
S_BB=($P_EP[AXNAME($TC_CARR35[_TCI])]-_F_MASPI*90)/(1-_F_MASPI)
ENDIF
_A=0 _B=S_BB _C=S_CC
REPEAT _GEO2AX_A _GEO2AX_E
IF(_MOD1==5)
IF(S_CC<>_SC_A_NO_VAL)
_MOD1=4
ENDIF
ENDIF
ELSE
_DIR=1-_F_MASPI
_MASPI=_F_MASPI
_STATUS=_MOD2*10+900
S_CC=_SC_A_NO_VAL
IF(_MOD1==0)OR(_MOD1==1)
IF(_MOD6==0)
_BETA=90
ELSE
_BETA=-90
ENDIF
ENDIF
IF(_MOD1==2)OR(_MOD1==3)
IF(_MOD6==0)
_BETA=0
ELSE
_BETA=180
ENDIF
ENDIF
IF(_F_MASPI==0)
S_BB=_BETA+_F_TC_DIFF_B
ELSE
S_BB=(180-_BETA)+_F_TC_DIFF_B
ENDIF
ENDIF
IF(_TCI)
IF(_MOD1<>6)AND(_F_RP_DIR[0]==6)
_BFACE=1
N60 F_SP_RP(7,,,1)
ENDIF
CYCLE213(_TCI)
_D_B=ABS(ROUND(S_BB*_PDEG)-ROUND($P_EP[AXNAME($TC_CARR35[_TCI])]*_PDEG))
IF(_D_B>180*_PDEG)
_D_B=ABS(_D_B-360*_PDEG)
ENDIF
IF(S_CC<>_SC_A_NO_VAL)
S_TI=$P_TOOLNO
S_MTA=0
IF(S_TI>0)
S_MTI=$A_MYMTN[S_TI]
S_C=ROUND($P_EP[AXNAME($TC_CARR36[_TCI])])
IF(S_MTI>0)
S_MTP=$A_MYMTLN[S_TI]
S_MTTYP=$TC_MTP_KD[S_MTI]
IF(S_MTTYP==1)
S_MTA=(S_MTP-1)*360/$TC_MTPN[S_MTI]
ELSE
IF(S_MTTYP==3)
S_MTA=$TC_MTPPA[S_MTI,S_MTP]
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Multitool:")
WRITE(_LOG,_LOG_FILE,"  T="<<S_TI<<" MT="<<S_MTI<<" Platz="<<S_MTP<<" Typ="<<S_MTTYP<<" Winkel="<<S_MTA)
ENDIF
ENDIF
ENDIF
IF(S_MTI>0)
S_MTAV=ROUND($P_EP[AXNAME($TC_CARR36[_TCI])])-ROUND($AA_IM[AXNAME($TC_CARR36[_TCI])])
ELSE
S_MTAV=0
ENDIF
_D_C=ABS(ROUND((S_CC-S_C+S_MTA+S_MTAV)*_PDEG))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  _D_C=S_CC-S_C+S_MTA+S_MTAV")
WRITE(_LOG,_LOG_FILE,"  "<<_D_C<<"="<<S_CC<<"-"<<S_C<<"+"<<S_MTA<<"+"<<S_MTAV)
ENDIF
IF(_D_C>180*_PDEG)
_D_C=ABS(_D_C-360*_PDEG)
ENDIF
ELSE
_D_C=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"B="<<S_BB<<" C="<<S_CC)
WRITE(_LOG,_LOG_FILE,"dB="<<_D_B<<" dC="<<_D_C)
ENDIF
IF(_D_B>$MAS_CLAMPING_TOLERANCE[_F_S_AX[4]]*_PDEG)OR((S_CC<>_SC_A_NO_VAL)AND((_D_C>$MAS_CLAMPING_TOLERANCE[_F_S_AX[1]]*_PDEG)OR(($P_SMODE[_F_S_NR[1]]==1)AND(_F_SP_CL_TURN==0))))
IF(_MOD3==0)AND(_MOD4==0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Rueckzug auf WWP")
IF(_D_B>$MAS_CLAMPING_TOLERANCE[_F_S_AX[4]]*_PDEG)
WRITE(_LOG,_LOG_FILE,"  _D_B>$MAS_CLAMPING_TOLERANCE ("<<_D_B<<")")
ENDIF
IF((S_CC<>_SC_A_NO_VAL)AND(_D_C>$MAS_CLAMPING_TOLERANCE[_F_S_AX[1]]*_PDEG))
WRITE(_LOG,_LOG_FILE,"  _D_C>$MAS_CLAMPING_TOLERANCE ("<<_D_C<<")")
ENDIF
IF((S_CC<>_SC_A_NO_VAL)AND(($P_SMODE[_F_S_NR[1]]==1)AND(_F_SP_CL_TURN==0)))
WRITE(_LOG,_LOG_FILE,"  C vorher Achsbetrieb, jetzt Spindelbetrieb")
ENDIF
ENDIF
IF(_BFACE)
N70 F_SP_RP(8,,,1)
ELSE
N72 F_SP_RP(1,,,1)
ENDIF
ENDIF
IF(_MOD1==4)OR(_MOD1==5)
CUST_TECHCYC(14)
ENDIF
IF(S_CC<>_SC_A_NO_VAL)
CUST_TECHCYC(1+_MASPI*10)
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SWIV_H("<<_TCI<<",B="<<S_BB<<",C="<<S_CC<<")")
ENDIF
N80 F_SWIV_H(_TCI,S_BB,S_CC)
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"dB="<<_D_B<<" dC="<<_D_C)
ENDIF
ENDIF
IF(_MOD1==4)
IF(_MOD5==0)
CUST_TECHCYC(13)
ELSE
CUST_TECHCYC(14)
CUST_TECHCYC(11)
ENDIF
IF($P_SMODE[_F_S_NR[1]]==1)
_F_SP_CL_TURN=1
ELSE
_F_SP_CL_TURN=0
ENDIF
ELSE
CUST_TECHCYC(14)
ENDIF
IF(_MOD1==4)
G18
ELSE
IF(_MOD1==0)OR(_MOD1==1)
G19
ELSE
G17
ENDIF
ENDIF
WRTPR("IGNORE(16,0)",1)
IF(_MOD1<=5)
REPEAT _DEL_FRAME_A _DEL_FRAME_E
REPEAT _SET_TCARR_A _SET_TCARR_E
ELSE
_TC=$TC_CARR34[_TCI]
IF(_DIR==1)
_STATUS=_STATUS+20000
ENDIF
IF(_DIR==-1)
_STATUS=_STATUS+10000
ENDIF
_DIR=0
_PFRAME=$P_PFRAME
$P_PFRAME=CTRANS()
N100 CYCLE800(0,_TC,_STATUS,_MODUS,0,0,0,_A,_B,_C,0,0,0,_DIR,0,0)
$P_PFRAME=_PFRAME
ENDIF
;MSG("F_SP_BC: SOL="<<$P_TCSOL<<" A1="<<$P_TCANG[1]<<" A2="<<$P_TCANG[2]<<" A3="<<$P_TCANG[3]<<" A4="<<$P_TCANG[4]<<" MODE="<<_MODUS<<" STATUS="<<_STATUS<<" A="<<_A<<" B="<<_B<<" C="<<_C<<" BB="<<S_BB<<" CC="<<S_CC)
;M0
;STOPRE
WRTPR("IGNORE(32,0)",1)
ENDIF
_RET:
IF(NOT S_READY)
IF($AC_SERUPRO)AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100'))
IF(_E_SEARCH[3]==$P_LINENO[0])
F_SP_LAB
S_READY=1
GOTOB S_M_BEGIN
ENDIF
ENDIF
ENDIF
N50 CUTMOD=_TCI
SBLON
RET
_DEL_FRAME_A:
PAROTOF TOROTOF
$P_WPFRAME=CTRANS() $P_WPFR=$P_WPFRAME
$P_PARTFRAME=CTRANS() $P_PARTFR=$P_PARTFRAME
$P_TOOLFRAME=CTRANS() $P_TOOLFR=$P_TOOLFRAME
TCARR=0
WRTPR("SWIV_TR(4,0,0,0,0,0,0)",1)
_DEL_FRAME_E:
_SET_TCARR_A:
$TC_CARR13[_TCI]=S_BB
IF(S_CC<>_SC_A_NO_VAL)
$TC_CARR14[_TCI]=S_CC
ELSE
$TC_CARR14[_TCI]=0
ENDIF
N300 TCOABS TCARR=_TCI
_TC_A1=$P_TCANG[1]
_TC_A2=$P_TCANG[2]
IF(NOT $P_SEARCH)AND(NOT $AC_SERUPRO)AND(NOT $P_ISTEST)AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100'))
IF($MC_TOOL_CARRIER_RESET_VALUE<>_TCI)
STOPRE
$MC_TOOL_CARRIER_RESET_VALUE=_TCI
ENDIF
_TC_NUM=_TCI
ENDIF
_SET_TCARR_E:
_GEO2AX_A:
IF($P_ACTFRAME[_ZZ,MI])
S_BB=180-S_BB
IF(S_CC<>_SC_A_NO_VAL)
S_CC=S_CC+180
ENDIF
ENDIF
IF(S_BB<$TC_CARR30[_TCI])
S_BB=S_BB+360
ENDIF
IF(S_BB>$TC_CARR32[_TCI])
S_BB=S_BB-360
ENDIF
IF(S_CC<>_SC_A_NO_VAL)
S_CC=((((S_CC-0) MOD 360)+360) MOD 360)+0
ENDIF
IF(S_CC<>_SC_A_NO_VAL)AND(($P_AD[1]<500)OR($P_AD[1]>599))
S_CC=0
ENDIF
_GEO2AX_E:

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SP_CHA_SPF
PROC F_SP_CHA(INT _MODE,REAL _FS,REAL _ZFS) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.04.16.00 ;DATE: 2011-05-30
;ShopTurn: Internal Cycle for Champfering
DEF INT _TYP,_VORZ
DEF REAL _TOOLR,_TANGO,_DEEP,_FAK1,_FAK2
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_TYP=$P_AD[1]
_TOOLR=$P_TOOLR*_FAK1
_TANGO=0
_DEEP=0
_VORZ=1
IF(_TYP==200)OR(_TYP==220)
_TANGO=$P_AD[24]/2
REPEAT _FASAN_A _FASAN_E
IF(_TANGO)
_DEEP=_TOOLR/_TANGO
ENDIF
ENDIF
IF(_TYP==140)
IF($P_AD[11])
_TANGO=90-$P_AD[11]
ENDIF
REPEAT _FASAN_A _FASAN_E
IF(_TANGO)
_DEEP=($P_AD[7]-$P_TOOLR*_FAK1)/_TANGO
ENDIF
_TOOLR=0
ENDIF
IF(_TYP==155)OR(_TYP==156)
_TANGO=$P_AD[11]
REPEAT _FASAN_A _FASAN_E
_TOOLR=0
ENDIF
IF(_FS<=0) GOTOF _FEHL1
IF(_ZFS<=0) GOTOF _FEHL3
IF(_TYP==140)
IF($P_AD[7]>0)
IF(_FS>$P_AD[7]-$P_TOOLR*_FAK1) GOTOF _FEHL2
ENDIF
ELSE
IF(_TYP<>155)AND(_TYP<>156)
IF(_FS>$P_TOOLR*_FAK1) GOTOF _FEHL2
ENDIF
ENDIF
IF(_TANGO)
IF(_ZFS*_TANGO<_FS) GOTOF _FEHL3
IF(_DEEP)
IF(_ZFS>_DEEP) GOTOF _FEHL4
ENDIF
ENDIF
IF(NOT _TANGO)
_TANGO=1
ENDIF
IF(NOT _MODE)
_VORZ=-_VORZ
ENDIF
OFFN=$P_OFFN*_FAK2-_VORZ*(_TOOLR-(_ZFS*_TANGO-_FS))
RET
_FASAN_A:
IF(_TANGO>=0)AND(_TANGO<90)
_TANGO=TAN(_TANGO)
ELSE
GOTOF _FEHL5
ENDIF
_FASAN_E:
_FEHL1: STOPRE
N701 SETAL(61270)
RET
_FEHL2: STOPRE
N702 SETAL(61271)
RET
_FEHL3: STOPRE
N703 SETAL(61272)
RET
_FEHL4: STOPRE
N704 SETAL(61273)
RET
_FEHL5: STOPRE
N705 SETAL(61274)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SP_ED_SPF
PROC F_SP_ED(VAR REAL S_ED) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.08.02.00.074 ;DATE: 2017-04-05
;ShopTurn: Edge Difference
DEF INT _SL,_DIR=1,_I,S_LI,_WTYP
DEF REAL _FAK1,_SD=0,_SD1,_SD2
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_SP_ED_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
;DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
ENDIF
IF(($P_TOOLNO)AND($P_TOOL)AND($MCS_FUNCTION_MASK_TECH B_AND 'B100'))
_WTYP=$P_ADT[1]
IF(_WTYP<400)OR(_WTYP>599)
IF($SC_TOOL_LENGTH_CONST<>18)AND($SC_TOOL_LENGTH_CONST<>-18)
GOTOF _FEHL1
ENDIF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_SL=$P_ADT[2]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Aktive Schneidenlage: "<<_SL)
ENDIF
IF((_SL>=5)AND(_SL<=8))
IF((_SL==6)OR(_SL==8))
S_LI=ABS($P_ACT_TOOL_LENGTH_INDEX[0])
ELSE
S_LI=ABS($P_ACT_TOOL_LENGTH_INDEX[2])
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Geo. Lnge "<<S_LI)
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Schneidenlage "<<_SL<<" wird nicht behandelt!")
ENDIF
GOTOF _RET
ENDIF
_SD2=$P_ATDT[2+S_LI,$P_TOOL]+$P_ATDT[11+S_LI,$P_TOOL]+$P_ATDT[20+S_LI,$P_TOOL]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Anzahl Schneiden: "<<$P_TOOLND[$P_TOOLNO])
WRITE(_LOG,_LOG_FILE,"Aktive Werkzeuggesamtlnge: "<<_SD2)
ENDIF
_DIR=1
IF(NOT((_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')))
IF((_SL==5)OR(_SL==6))
_DIR=-_DIR
ENDIF
ENDIF
FOR _I=1 TO $P_TOOLND[$P_TOOLNO]
IF($P_ATDT[2,$P_TOOLD[$P_TOOLNO,_I]]==$P_ATDT[2,$P_TOOL])
_SD1=$P_ATDT[2+S_LI,$P_TOOLD[$P_TOOLNO,_I]]+$P_ATDT[11+S_LI,$P_TOOLD[$P_TOOLNO,_I]]+$P_ATDT[20+S_LI,$P_TOOLD[$P_TOOLNO,_I]]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  SD1="<<_SD1)
ENDIF
IF((_SD1*_DIR>_SD2*_DIR)AND(_SD<ABS(_SD1-_SD2)*_FAK1))
_SD=ABS(_SD1-_SD2)*_FAK1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  -> SD="<<_SD)
ENDIF
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  SL="<<$P_ATDT[2,$P_TOOLD[$P_TOOLNO,_I]])
ENDIF
ENDIF
ENDFOR
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Dreh- und Schleifwerkzeuge werden nicht betrachtet")
GOTOF _RET
ENDIF
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Funktion <Anfahrlogik fr Stufenbohrer> nicht freigeschaltet oder keine Schneide aktiv")
ENDIF
ENDIF
_RET:
S_ED=_SD
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Schneidendifferenz="<<S_ED)
ENDIF
RET
_FEHL1:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 1: SD42940 $SC_TOOL_LENGTH_CONST muss gleich 18 oder -18 sein")
ENDIF
N934801 SETAL(61098,"SD42940 must be equal 18/-18.")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SP_EF_SPF
PROC F_SP_EF(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,CHAR _FO,INT _L,REAL __X0,INT _X0A,REAL _Z0,INT _Z0A,REAL __X1,INT _X1A,REAL _Z1,INT _Z1A,INT _RT,REAL __V,INT _VA,REAL _BETA,INT _BETAA,REAL _GAMA,INT _BA,REAL S_POLA,INT S_FR_M,REAL S_FR_I,STRING[32] S_TRA,REAL S_XC,REAL S_YC,REAL _SV2,REAL _C0) SBLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Internal Cycle to Thread Undercut, Form E+F
DEF AXIS _XX,_ZZ,_YY,_CC,_AX1,_AX2,_AX3
DEF INT _AI,_LF[4],_P29,_PM,_TYP,_SL,_MAN,_GG10,S_MODE_BC,S_IPT,S_PL,_TM1,_TCI,_NPV,S_Y_TURN,S_C805_AMODE
DEF INT _SLT[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,2,1,4,3,7,6,5,8,9)
DEF INT _SLX[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,4,3,2,1,5,8,7,6,9)
DEF REAL _R[10],_T2[10],_FF[10],_G[10],_R1,_T1,_F1,_G1,_X,_Z,_FAK1,_FAK2,_FAK3,_SC,_SPX,_SPZ,_P1Z,_P2X,_P2Z,_P3Z,_P4X,_P4Z,_P5X,_P6X,_P6Z,_YS,_V,_X0,_X1,S_ROT_Z,_XS,_ZS,_SD,_RP,_RTP,S_A1TC,S_A2TC
DEF STRING[32] _TC
DEF FRAME _WPFR
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_SP_EF_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
ENDIF
IF(_E_SM_PRG)AND((_TMOD _DEC4)==0) GOTOF _FEHL7
IF(_E_ST_PRG)AND((_TMOD _DEC4)==1) GOTOF _FEHL8
_X0=__X0 _X1=__X1 _V=__V
IF(_TMOD _DEC9)==1
S_IPT=1
ENDIF
IF(_TMOD _DEC9)==3
S_Y_TURN=1
ENDIF
_TM1=_TMOD MOD 10
_C0=((_C0 MOD 360)+360)MOD 360
_P29=$P_GG[29]
DIAMCYCOF
_MAN=TRUNC(_TMOD/10) MOD 10
_R[0]=0.6 _R[1]=1.0 _R[2]=1.0 _R[3]=1.6 _R[4]=2.5 _R[5]=4.0 _R[6]=0.4 _R[7]=0.6 _R[8]=0.1 _R[9]=0.2
_T2[0]=0.3 _T2[1]=0.4 _T2[2]=0.2 _T2[3]=0.3 _T2[4]=0.4 _T2[5]=0.5 _T2[6]=0.2 _T2[7]=0.2 _T2[8]=0.1 _T2[9]=0.1
_FF[0]=2.5 _FF[1]=4 _FF[2]=2.5 _FF[3]=4 _FF[4]=5 _FF[5]=7 _FF[6]=2 _FF[7]=2 _FF[8]=0.5 _FF[9]=1
_G[0]=2.1 _G[1]=3.2 _G[2]=1.8 _G[3]=3.1 _G[4]=4.8 _G[5]=6.4 _G[6]=1.1 _G[7]=1.4 _G[8]=0.8 _G[9]=0.9
IF (_FO<>"E")AND(_FO<>"F") GOTOF _FEHL2
IF(_BA B_AND 'B10000000' == 'B10000000')
IF(_X0A==90)
_X0=_X0/2
ENDIF
IF(_X1A==90)
_X1=_X1/2
ENDIF
IF(_VA==90)
_V=_V/2
ENDIF
ENDIF
_PM=1-(_L MOD 2)*2
_AI=1-((_L DIV 2) MOD 2)*2
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK3=1/$MN_SCALING_VALUE_INCH
ELSE
_FAK3=1
ENDIF
N10 G90
IF(NOT((_FAA==1)OR(_FAA==3))) GOTOF _FEHL3
IF(_MAN==0)
IF(_E_SM_PRG)
IF(S_IPT==1)
IF($PC_TRAFO_TYPE_NAME=="TRAORI_STAT")
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: DFM -> M5")
WRITE(_LOG,_LOG_FILE,"IPT: DFM -> SPOS=0")
ENDIF
M[_F_S_NR[_F_MASPI]]=5
SPOS[_F_S_NR[_F_MASPI]]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N333 E_TFS")
ENDIF
N333 E_TFS(_T,_TF,_DD,,,,,11)
TRAFOOF
G18
IF(_GAMA==180)
_XX=$P_AXN2
$P_CYCFRAME=$P_CYCFRAME:CMIRROR(_XX)
ENDIF
ELSE
N13 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=S_FR_M
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
_ZZ=$P_AXN1
S_ROT_Z=$P_ACTFRAME[_ZZ,RT]
N14 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
IF($P_ACTFRAME[_ZZ,RT]<>S_ROT_Z)
IF($P_EP[_ZZ]*_FAK1<_F_RPT[1]*_FAK2)
N145 G0 G90 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
ENDIF
N15 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
ENDIF
ELSE
IF(S_IPT==1)
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_F_TRAMA _DEC2 ==6)
_TCI=$P_TC
S_A1TC=$P_TCANG[1]
S_A2TC=$P_TCANG[2]
_NPV=$P_GG[8]
_WPFR=$P_WPFRAME
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Stirn B vor N250 F_TFS")
WRITE(_LOG,_LOG_FILE,"  _F_TRAMA="<<_F_TRAMA)
WRITE(_LOG,_LOG_FILE,"  $P_TC="<<$P_TC)
WRITE(_LOG,_LOG_FILE,"  _TC_A1="<<_TC_A1)
WRITE(_LOG,_LOG_FILE,"  _TC_A2="<<_TC_A2)
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[1]="<<$P_TCANG[1])
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[2]="<<$P_TCANG[2])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR13[_TCI]="<<$TC_CARR13[_TCI])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR14[_TCI]="<<$TC_CARR14[_TCI])
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N250 F_TFS")
ENDIF
N250 F_TFS(_T,_TF,_DD,,,,,1,0)
IF(_TCI)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Stirn B nach N250 F_TFS")
WRITE(_LOG,_LOG_FILE,"  _F_TRAMA="<<_F_TRAMA)
WRITE(_LOG,_LOG_FILE,"  $P_TC="<<$P_TC)
WRITE(_LOG,_LOG_FILE,"  _TC_A1="<<_TC_A1)
WRITE(_LOG,_LOG_FILE,"  _TC_A2="<<_TC_A2)
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[1]="<<$P_TCANG[1])
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[2]="<<$P_TCANG[2])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR13[_TCI]="<<$TC_CARR13[_TCI])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR14[_TCI]="<<$TC_CARR14[_TCI])
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N800 CYCLE800 direkt: "<<S_A1TC<<"/"<<S_A2TC)
ENDIF
N800 CYCLE800(0,$TC_CARR34[_TCI],220000,192,0,0,0,S_A1TC,S_A2TC,0,0,0,0,0,0,1001)
$P_WPFRAME=_WPFR
$P_WPFR=$P_WPFRAME
G[8]=_NPV
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: G18 TRAFOOF")
ENDIF
F_SP_TRA(2040)
_XX=$P_AXN2
IF(NOT _TCI)
N255 F_SP_BC(4,_SC_A_NO_VAL,0)
ENDIF
IF(_GAMA==180)
$P_CYCFRAME=$P_CYCFRAME:CMIRROR(_XX)
ENDIF
ELSE
IF S_Y_TURN
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Y-Drehen")
ENDIF
N1800 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
IF(_SC_Y_TURN)
IF(_SC_Y_TURN_GAMA<>_GAMA)
F_SP_RP(1,,,1)
ENDIF
IF(_BA B_AND 'H1000000' == 'H1000000')
IF(_SC_Y_TURN==-90)
F_SP_RP(1,,,1)
ENDIF
ELSE
IF(_SC_Y_TURN==90)
F_SP_RP(1,,,1)
ENDIF
ENDIF
ENDIF
IF(_F_TC_DEF[2]==0)
_TC=""
ELSE
_TC=$TC_CARR34[_F_TC_DEF[2]]
ENDIF
IF(_BA B_AND 'H1000000' == 'H1000000')
S_C805_AMODE=1000
ENDIF
N1805 CYCLE805(1,_TC,_GAMA,,,,S_C805_AMODE)
N1810 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,7)
ELSE
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N16 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
N17 F_SP_BC(4,_BETA,_GAMA)
N18 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,7)
ELSE
N20 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,0)
F_SP_TRA(2040)
ENDIF
ENDIF
ENDIF
ENDIF
ELSE
IF($MCS_TECHNOLOGY==2)
N21 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=0
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
N22 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
N23 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
ELSE
_F_INIT=2
_F_RELEAS=1
IF(_MAN==1)
_F_MASPI=0
N24 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,1,8)
ELSE
_F_MASPI=2
N26 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,3,8)
ENDIF
F_SP_TRA(2040)
ENDIF
ENDIF
_TYP=$P_ADT[1]
IF(_TYP<500)OR(_TYP>599) GOTOF _FEHL4
_XX=$P_AXN2 _ZZ=$P_AXN1
IF(_MAN==0)AND(S_IPT==0)
F_SP_RPT(0,_L)
ENDIF
_X=$P_EP[_XX]*_FAK1 _Z=$P_EP[_ZZ]*_FAK1
IF(_F_Y_AXIS==1)
_YY=$P_AXN3
_YS=$P_EP[_YY]*_FAK1
ENDIF
IF(_X0A<>90)
_X0=_X0+_X
ENDIF
IF(_Z0A<>90)
_Z0=_Z0+_Z
ENDIF
IF(_X1A<>91)
_X1=(_X1-_X0)*_AI
ELSE
_X1=ABS(_X1)
ENDIF
IF(_FO=="F")
IF(_Z1A<>91)
_Z1=-(_Z1-_Z0)*_PM
ELSE
_Z1=ABS(_Z1)
ENDIF
ELSE
IF(_VA<>91)
_V=(_V-_X0)*_AI
ELSE
_V=ABS(_V)
ENDIF
ENDIF
IF S_CALL_FROM_MA_JOG_STEP
_F_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
ELSE
_SC=_E_SC*_FAK2
ENDIF
IF($P_TOOLNO>0)
IF(S_IPT)
_SL=$TC_DP2[$P_TOOLNO,$P_TOOL]
ELSE
_SL=$P_ADT[2]
ENDIF
IF(NOT(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'H00200000')AND($P_CUTMOD))AND NOT(($P_CUTMODK==$PC_TRAFO_NAME)AND($P_CUTMODK<>""))AND(NOT S_Y_TURN))
_SL=_SLT[$P_ACTFRAME[_ZZ,MI],_SL]
_SL=_SLX[$P_ACTFRAME[_XX,MI],_SL]
ENDIF
IF(_SL>0)
_LF[0]=4 _LF[1]=3 _LF[2]=1 _LF[3]=2
IF _LF[_L]<>_SL GOTOF _FEHL1
ENDIF
ENDIF
_R1=_R[_RT]*_FAK3
_T1=_T2[_RT]*_FAK3
_F1=_FF[_RT]*_FAK3
_G1=_G[_RT]*_FAK3
IF($P_TOOLR*_FAK1 > _R1) GOTOF _FEHL6
_P2X=-_T1
_P2Z=_F1-_T1/TAN(15)
_P1Z=_P2Z+(_T1+_X1+_SC)/TAN(15)
_SPX=_X1+_SC
_SPZ=_P1Z+1*_FAK3
IF(_FO=="E")
_P3Z=0
_P4X=_V
_P4Z=0
ELSE
_P3Z=-_G1*TAN(8)
_P4X=_Z1/TAN(8)+_G1-_T1
_P4Z=_Z1
ENDIF
_SPX=_X0+_SPX*_AI
_SPZ=_Z0-_SPZ*_PM
_P1Z=_Z0-_P1Z*_PM
_P2Z=_Z0-_P2Z*_PM
_P2X=_X0+_P2X*_AI
_P3Z=_Z0-_P3Z*_PM
_P4Z=_Z0-_P4Z*_PM
_P4X=_X0+_P4X*_AI
IF(_FO=="F")
IF(_VA==90)
_P5X=_V
ELSE
_P5X=_P4X+ABS(_V)*_AI
ENDIF
_P6Z=_P4Z
_P6X=_P5X+_SC*_AI
ELSE
_P6Z=_P4Z-_SC*SIN(8)*_PM
_P6X=_P4X+_SC*COS(8)*_AI
ENDIF
_XS=_P6X
_ZS=_SPZ
IF(S_IPT==1)
IF(_GAMA==180)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Gamma 180 -> Spiegelung X entfernt")
ENDIF
$P_CYCFRAME=$P_CYCFRAME:CMIRROR(_XX)
ENDIF
IF(_E_SM_PRG)
E_SP_ED(_SD)
_RP=_E_RP*_FAK2
_RTP=_RP-_SD
G17
N310 E_SP_RP(2,_RTP,S_XC,S_YC,_RTP)
ELSE
IF(_GAMA==180)
_XS=_XS-2*$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: F_SP_BC")
ENDIF
F_SP_BC(_TM1)
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2
_SC_POS[0]=(S_XC+_XS)/_FAK1
_SC_POS[1]=S_YC/_FAK1
IF(_TM1==1)
F_SP_TRA(2012,,_C0)
F_SP_RP(0,_RP,_YS,0,_XS)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N32 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
F_SP_RP(9,_SC_POS[0]*_FAK1,_RP,0,_SC_POS[1]*_FAK1)
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N33 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2 _AX3=$P_AXN3
IF(_F_RELEAS==0)
SBLON
N34 G90 G0 G40 AX[_AX1]=_SC_POS[0]*_FAK1 AX[_AX2]=_SC_POS[1]*_FAK1 AX[_AX3]=_RP
N340 G90 G0 G40 AX[_AX3]=_ZS
SBLOF
ENDIF
ENDIF
ENDIF
IF($MCS_TECHNOLOGY==2)
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H0000')
DIAM90
ELSE
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H8000')
DIAMON
ELSE
DIAMOF
ENDIF
ENDIF
IF(S_IPT==0)
_P29=$P_GG[29]
ENDIF
DIAMCYCOF
ENDIF
IF(S_IPT==1)
IF(_E_SM_PRG)
S_PL=_E_PLANE
ELSE
IF(_TM1==1)
S_PL=3
ELSE
S_PL=1
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N806 Anwahl Interpolationsdrehen")
ENDIF
IF(_E_SM_PRG)
N806 CYCLE806(0001,S_XC,S_YC,_GAMA,_S,_SV2,5,_SA-1+100,S_PL,S_TRA,2*_XS,_RP)
SBLON
G4 F0
SBLOF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N334 E_TFS")
ENDIF
N334 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
SBLON
G4 F0
SBLOF
ELSE
N806 CYCLE806(0001,S_XC,S_YC,_GAMA,_S,_SV2,5,_SA-1,S_PL,S_TRA)
SBLON
G4 F0
SBLOF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N251 F_TFS")
ENDIF
N251 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,,0)
SBLON
G4 F0
SBLOF
ENDIF
DIAMCYCOF
SBLON
N810 G0 G90 AX[_ZZ]=_ZS
SBLOF
ELSE
IF S_Y_TURN
SBLON
IF($P_EP[_ZZ]*_FAK1<_F_RPT[1]*_FAK2)AND($P_EP[_YY]<>0)
N1840 G0 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
IF($P_EP[_ZZ]*_FAK1>_F_RPT[1]*_FAK2)
N1850 G0 AX[_XX]=_F_RPT[0]*_FAK2 AX[_ZZ]=_F_RPT[1]*_FAK2
ELSE
N1860 G0 AX[_XX]=_F_RPT[0]*_FAK2
ENDIF
N1870 G0 AX[_YY]=0
N1880 G0 AX[_ZZ]=_ZS
N1890 G0 G90 AX[_XX]=_XS AX[_ZZ]=_ZS
SBLOF
ELSE
IF(_MAN==0)
IF(_AI==-1)
F_SP_RP(3,_SPX,_SPZ)
ENDIF
N30 F_SP_RP(0,_SPX,_SPZ,0)
IF(_F_RELEAS==0)
SBLON
N31 G0 G90 AX[_XX]=_F_RP_ACT*_FAK2 AX[_ZZ]=_SPZ
SBLOF
ENDIF
F_SP_TRA(1040)
ELSE
IF((_X*_AI<=_X0*_AI)OR(_Z*_PM>=_Z0*_PM)) GOTOF _FEHL5
SBLON
IF(_F_Y_AXIS==0)
N321 G0 G90 AX[_XX]=_SPX AX[_ZZ]=_SPZ
ELSE
N331 G0 G90 AX[_XX]=_SPX AX[_ZZ]=_SPZ AX[_YY]=0
ENDIF
SBLOF
ENDIF
ENDIF
ENDIF
_GG10=$P_GG[10]
IF(_GG10<2)
_GG10=2
ENDIF
SBLON
N35 G0 G40 G[10]=_GG10 AX[_XX]=_SPX AX[_ZZ]=_SPZ
SBLOF
IF (_L==1)OR(_L==2) GOTOF _M1
N40 G41
GOTOF _M2
N45 _M1:G42
_M2:
N50 AX[_ZZ]=_P1Z
N60 G1 AX[_ZZ]=_P2Z AX[_XX]=_P2X RND=_R1
N70 AX[_ZZ]=_P3Z RND=_R1
N80 AX[_ZZ]=_P4Z AX[_XX]=_P4X
IF(_FO=="F")
N90 AX[_XX]=_P5X
ENDIF
SBLON
N100 G0 G40 G60 AX[_XX]=_P6X AX[_ZZ]=_P6Z
IF(_MAN==0)
IF(_E_ST_PRG)
IF(_AI==-1)
F_SP_RP(4,$P_EP[_XX]*_FAK1,$P_EP[_ZZ]*_FAK1)
ENDIF
IF(S_IPT==1)
CYCLE806(0)
S_M_OK=0
IF(_TM1==6)
N125 G0 G90 AX[_ZZ]=_RP
ENDIF
ENDIF
ELSE
IF(S_IPT==1)
SBLON
N110 G0 G90 AX[_XX]=_XS
SBLOF
CYCLE806(0)
S_M_OK=0
G[29]=_P29
_ZZ=$P_AXN3
SBLON
N130 G0 G90 AX[_ZZ]=_RTP
SBLOF
ELSE
SBLON
N131 G0 G90 AX[_XX]=_F_RP_ACT*_FAK2
IF(_AI==-1)
N140 G0 G90 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
SBLOF
F_SP_RP(101,,,1)
ENDIF
ENDIF
ELSE
SBLON
IF(_F_Y_AXIS==0)
N150 G90 G0 AX[_XX]=_X AX[_ZZ]=_Z
ELSE
N160 G90 G0 AX[_XX]=_X AX[_ZZ]=_Z AX[_YY]=_YS
ENDIF
SBLOF
ENDIF
SBLOF
GOTOF _RET
_FEHL1: STOPRE
N994081 SETAL(61608)
RET
_FEHL2: STOPRE
N994082 SETAL(61609)
RET
_FEHL3: STOPRE
N994083 SETAL(61240)
RET
_FEHL4:STOPRE
N994084 SETAL(61212)
RET
_FEHL5: STOPRE
N994085 SETAL(61284)
RET
_FEHL6: STOPRE
N994086 SETAL(61006)
RET
_FEHL7: STOPRE
N994087 SETAL(61862)
RET
_FEHL8: STOPRE
N994088 SETAL(61863)
RET
_RET:
G[29]=_P29
_F_RELEAS=0
SBLON
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SP_INI_SPF
PROC F_SP_INI(INT _MODE,REAL _SC,INT _DIR) PREPRO SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.92.00.00.001 ;DATE: 2019-01-16
;ShopTurn: Initialization Cycle
DEF INT _I,_WS_CINV,_HS_CINV,_GS_CINV,_P29,_R29,_KODIR[48]
DEF REAL _FAK1,_FAK2
DEF STRING[200] _STR
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_SP_INI_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
ENDIF
IF(_MODE==0)
CYCLE210(0)
ENDIF
IF(_MODE==1)
CYCLE210(1)
ENDIF
IF(_MODE==0)OR(_MODE==2)
IF(_MODE==0)
_F_RELEAS=1
ELSE
_F_RELEAS=0
ENDIF
_F_INIT=2
_F_MASPI=0
_F_SUBSP=0
_F_TRA_T=0
_F_TRA_TS=""
_F_TRA_N=0
_F_TRA_CUTK=""
_F_TRA_D=0
_F_TRA_K=0
_F_TRA_Y=0
_F_TRA_FI=0
_F_TRA_S=1
_F_TRA_M=0
_F_TRA_Z=0
_F_TRA_C=0
_F_TRAFO=0
_F_TRAMA=99999
_F_BAR_START=-1
_F_PLANE=0
IF NOT ($MCS_FUNCTION_MASK_TECH B_AND 'H01')
_TC_NUM=0
ENDIF
FOR _I=0 TO 30
_F_NCK_CL_STATE[_I]=0
_F_NCK_CL_ANG[_I]=_SC_A_NO_VAL
ENDFOR
ENDIF
IF(_MODE==0)
_P29=$P_GG[29]
_R29=$MC_GCODE_RESET_VALUES[28]
IF(_P29<>_R29)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"G-Gruppe[29]="<<_P29<<" <> Resetval.="<<_R29)
ENDIF
;GOTOF _FEHL6
ENDIF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_E_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1/_FAK2
_E_DIR=_DIR
_F_NPV[0]=-1
_F_NPV[1]=-1
CUT2DF
ENDIF
IF(_MODE==4)
IF(_E_JS_PRG==0)
_E_JS_PRG=1
ENDIF
IF($MCS_TECHNOLOGY==1)
_E_ST_PRG=1
ENDIF
IF($MCS_TECHNOLOGY==2)
_E_SM_PRG=1
ENDIF
ENDIF
SBLON
RET
_FEHL1: STOPRE
N933601 SETAL(61288)
RET
_FEHL2: STOPRE
N933602 SETAL(61289)
RET
_FEHL3: STOPRE
N933603 SETAL(61290)
RET
_FEHL4: STOPRE
N933604 SETAL(61291)
RET
_FEHL5: STOPRE
N933605 SETAL(61292)
RET
_FEHL6: STOPRE
N933606 SETAL(61294)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SP_IS_SPF
PROC F_SP_IS(INT _MODE,VAR INT _STAT,REAL _P11,REAL _P12,REAL _P21,REAL _P22,VAR REAL _RPT[]) SAVE DISPLOF PREPRO
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.07.01.00 ;DATE: 2013-12-09
;ShopTurn: Intersection Cycle
DEF INT _I
DEF REAL _FAK2,_FAK3
DEF REAL _UE=1000000
DEF REAL _U
DEF REAL _RP[5]
DEF REAL _TG[2,6]
DEF REAL _SB[5,6]
DEF REAL _KT[2,6]
DEF REAL _SP[2,2]
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_SP_IS_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_FAK3=1
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK3=1/$MN_SCALING_VALUE_INCH
ENDIF
_U=0.1/$MN_INT_INCR_PER_MM
_UE=_UE*_FAK3
;_U=_U*_FAK3
_RP[0]=_RPT[0]*_FAK2
_RP[1]=_RPT[1]*_FAK2
IF(_RPT[2]<>_SC_NO_VAL)
_RP[2]=_RPT[2]*_FAK2
ELSE
_RP[2]=-_UE
ENDIF
IF(_RPT[3]<>_SC_NO_VAL)
_RP[3]=_RPT[3]*_FAK2
ELSE
_RP[3]=-_UE
ENDIF
IF(_RPT[4]<>_SC_NO_VAL)
_RP[4]=_RPT[4]*_FAK2
ELSE
_RP[4]=0
ENDIF
IF(_MODE==0)
IF(_P11<_RP[0])AND(_P11>_RP[2])AND(_P12<_RP[1])AND(_P12>_RP[3])
_STAT=1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Punkt liegt im Schutzbereich: "<<_P11<<"/"<<_P12)
ENDIF
ELSE
_STAT=0
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Punkt liegt nicht im Schutzbereich: "<<_P11<<"/"<<_P12)
ENDIF
ENDIF
ENDIF
IF(_MODE==1)
_TG[0,1]=_RP[2] _TG[0,2]=-_UE
_TG[1,1]=_RP[2] _TG[1,2]=_RP[3]
IF(_TG[1,2]==-_UE)
_TG[1,2]=_RP[1]-_U
ENDIF
IF(_TG[0,1]==-_UE)
_TG[0,1]=0
_TG[1,1]=0
ELSE
_TG[0,1]=_TG[0,1]+_U
_TG[1,1]=_TG[1,1]+_U
ENDIF
_SB[0,1]=_RP[0]-_U _SB[0,2]=_RP[1]-_U
_SB[1,1]=_RP[2]+_U _SB[1,2]=_RP[1]-_U
_SB[2,1]=_RP[2]+_U _SB[2,2]=_RP[3]+_U
_SB[3,1]=_RP[0]-_U _SB[3,2]=_RP[3]+_U
_SB[4,1]=_SB[0,1] _SB[4,2]=_SB[0,2]
_KT[0,1]=_P11 _KT[0,2]=_P12
_KT[1,1]=_P21 _KT[1,2]=_P22
_STAT= ISPOINTS(_TG[0],_KT[0],_SP)
_STAT=_STAT OR ISPOINTS(_SB[0],_KT[0],_SP)
_STAT=_STAT OR ISPOINTS(_SB[1],_KT[0],_SP)
_STAT=_STAT OR ISPOINTS(_SB[2],_KT[0],_SP)
_STAT=_STAT OR ISPOINTS(_SB[3],_KT[0],_SP)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  TG ="<<_TG[0,1]<<"/"<<_TG[0,2]<<"->"<<_TG[1,1]<<"/"<<_TG[1,2])
WRITE(_LOG,_LOG_FILE,"  SB0="<<_SB[0,1]<<"/"<<_SB[0,2]<<"->"<<_SB[1,1]<<"/"<<_SB[1,2])
WRITE(_LOG,_LOG_FILE,"  SB1="<<_SB[1,1]<<"/"<<_SB[1,2]<<"->"<<_SB[2,1]<<"/"<<_SB[2,2])
WRITE(_LOG,_LOG_FILE,"  SB2="<<_SB[2,1]<<"/"<<_SB[2,2]<<"->"<<_SB[3,1]<<"/"<<_SB[3,2])
WRITE(_LOG,_LOG_FILE,"  SB3="<<_SB[3,1]<<"/"<<_SB[3,2]<<"->"<<_SB[4,1]<<"/"<<_SB[4,2])
WRITE(_LOG,_LOG_FILE,"  KT ="<<_KT[0,1]<<"/"<<_KT[0,2]<<"->"<<_KT[1,1]<<"/"<<_KT[1,2])
_I=ISPOINTS(_TG[0],_KT[0],_SP)
WRITE(_LOG,_LOG_FILE,"  TG/KT  -> "<<_I)
_I=ISPOINTS(_SB[0],_KT[0],_SP)
WRITE(_LOG,_LOG_FILE,"  SB0/KT -> "<<_I)
_I=ISPOINTS(_SB[1],_KT[0],_SP)
WRITE(_LOG,_LOG_FILE,"  SB1/KT -> "<<_I)
_I=ISPOINTS(_SB[2],_KT[0],_SP)
WRITE(_LOG,_LOG_FILE,"  SB2/KT -> "<<_I)
_I=ISPOINTS(_SB[3],_KT[0],_SP)
WRITE(_LOG,_LOG_FILE,"  SB3/KT -> "<<_I)
IF(_STAT)
WRITE(_LOG,_LOG_FILE,"  Gerade KT schneidet Schutzbereich!")
ELSE
WRITE(_LOG,_LOG_FILE,"  Gerade KT schneidet Schutzbereich nicht!")
ENDIF
ENDIF
ENDIF
IF(_MODE==2)
_SB[0,1]=_RP[4]-_U _SB[0,2]=_RP[1]+_U
_SB[1,1]=-_UE _SB[1,2]=_RP[1]+_U
_SB[2,1]=_RP[4]-_U _SB[2,2]=_RP[1]+_U
_SB[3,1]=_RP[4]-_U _SB[3,2]=+_UE
_KT[0,1]=_P11 _KT[0,2]=_P12
_KT[1,1]=_P21 _KT[1,2]=_P22
_STAT= ISPOINTS(_SB[0],_KT[0],_SP)
_STAT=_STAT OR ISPOINTS(_SB[2],_KT[0],_SP)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  SB0="<<_SB[0,1]<<"/"<<_SB[0,2]<<"->"<<_SB[1,1]<<"/"<<_SB[1,2])
WRITE(_LOG,_LOG_FILE,"  SB2="<<_SB[2,1]<<"/"<<_SB[2,2]<<"->"<<_SB[3,1]<<"/"<<_SB[3,2])
WRITE(_LOG,_LOG_FILE,"  KT ="<<_KT[0,1]<<"/"<<_KT[0,2]<<"->"<<_KT[1,1]<<"/"<<_KT[1,2])
_I=ISPOINTS(_SB[0],_KT[0],_SP)
WRITE(_LOG,_LOG_FILE,"  SB0/KT -> "<<_I)
_I=ISPOINTS(_SB[2],_KT[0],_SP)
WRITE(_LOG,_LOG_FILE,"  SB2/KT -> "<<_I)
IF(_STAT)
WRITE(_LOG,_LOG_FILE,"  Gerade KT schneidet Reitstock!")
ELSE
WRITE(_LOG,_LOG_FILE,"  Gerade KT schneidet Reitstock nicht!")
ENDIF
ENDIF
IF(_STAT==0)
IF(_P11<_RP[4])AND(_P12>_RP[1])
_STAT=1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Startpunkt von KT liegt im Reitstockbereich!")
ENDIF
ENDIF
ENDIF
ENDIF
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SP_RP_SPF
PROC F_SP_RP(INT _POSR,REAL _X0,REAL _Z0,INT _MODE,REAL _Y0) SAVE PREPRO SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.005 ;DATE: 2024-04-03
;ShopTurn: Retract Cycle
DEF AXIS _XX,_YY,_ZZ
DEF INT _P6,_P29,_I,_STAT,_PAR,_ERR,_ERRM,_NUM=0,S_NUM_ADD=0,_ST_RP=0,_PARK=0,S_ZIEL=0,_TCI=0,_ST_RETRACT=0,_INTERPOL=0,_WTYP,_SL,_TM1,_TM3,_DIR
DEF INT _II,_III,_H,_FOUND,S_Y_TURN
DEF INT _SLT[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,2,1,4,3,7,6,5,8,9)
DEF INT _SLX[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,4,3,2,1,5,8,7,6,9)
DEF REAL _P[8,2],_TCP[3],_TCPWKS[3]=REP(0),_TCPENS[3],_ACTPOS[3],_ZP[3],_TOOLL[3],_FAK1,_FAK2,S_FAK_PLAN,_PARK_Y=0,_Z_TR,_SD,_TEMP_RPT[5],S_WWP_Y,S_DIR_Z,S_DIR_X
DEF REAL _NO_VAL=1EX300
DEF REAL _RPT[6]=REP(1EX300)
DEF REAL S_RP_TOL=1EX-7
DEF BOOL _NOGO_TCP=0,_Y_EXISTS
DEF FRAME _PFRAME,_WPFRAME,_PARTFRAME,_FRAME,_VECT
DEF INT _MD9898='H00200000'
DEF INT _MD9899=0
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF($MC_TOOL_PARAMETER_DEF_MASK B_AND 'B1000000')AND($MC_DIAMETER_AX_DEF<>"")
S_FAK_PLAN=1/2
ELSE
S_FAK_PLAN=1
ENDIF
IF((NOT(_MD9898 B_AND 'H01000000'))AND(_Y0<>_SC_NO_VAL)AND($P_SUBPAR[3]))
_INTERPOL=1
ENDIF
IF(_POSR==9)
_POSR=0
_INTERPOL=0
ENDIF
_Y_EXISTS=FALSE
_YY=NO_AXIS
IF($P_GG[6]==1)
_ZZ=$P_AXN3
_XX=$P_AXN1
IF(_F_TRAANG)OR(_F_Y_AXIS)
_YY=$P_AXN2
_Y_EXISTS=TRUE
ENDIF
ELSE
IF($P_GG[6]==2)
_ZZ=$P_AXN1
_XX=$P_AXN2
IF(_F_TRAANG)OR(_F_Y_AXIS)
_YY=$P_AXN3
_Y_EXISTS=TRUE
ENDIF
ELSE
_ZZ=$P_AXN2
_XX=$P_AXN3
IF(_F_TRAANG)OR(_F_Y_AXIS)
_YY=$P_AXN1
_Y_EXISTS=TRUE
ENDIF
ENDIF
ENDIF
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_SP_RP_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
; DELETE(_LOG,_LOG_FILE)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"Aufruf aus "<<SUBSTR($P_PROG[$P_STACK-1],3,STRLEN($P_PROG[$P_STACK-1])-3-4))
WRITE(_LOG,_LOG_FILE,"F_SP_RP("<<_POSR<<","<<_X0<<","<<_Z0<<","<<_MODE<<","<<_Y0<<")")
IF($MN_SCALING_SYSTEM_IS_METRIC)
WRITE(_LOG,_LOG_FILE,"Grundsystem: Metric")
ELSE
WRITE(_LOG,_LOG_FILE,"Grundsystem: Inch")
ENDIF
WRITE(_LOG,_LOG_FILE,"G"<<16+$P_GG[6])
WRITE(_LOG,_LOG_FILE,"G7"<<1-($P_GG[13] MOD 2)<<SUBSTR("0",0,($P_GG[13]-1)/2)<<": "<<_FAK1<<" / "<<_FAK2)
WRITE(_LOG,_LOG_FILE,"Wertefolge: X/Z")
WRITE(_LOG,_LOG_FILE,"RP: "<<_F_RPT[0]*_FAK2<<"/"<<_F_RPT[1]*_FAK2<<"/"<<_F_RPT[2]*_FAK2<<"/"<<_F_RPT[3]*_FAK2<<"/XR:"<<_F_RPT[4]*_FAK2)
WRITE(_LOG,_LOG_FILE,"Letzte/neue Richtung: "<<_F_RP_DIR[0]<<"/"<<_F_RP_DIR[1])
IF(_Y_EXISTS)
WRITE(_LOG,_LOG_FILE,"Actframe,TR="<<$P_ACTFRAME[_XX,TR]<<" "<<$P_ACTFRAME[_YY,TR]<<" "<<$P_ACTFRAME[_ZZ,TR])
WRITE(_LOG,_LOG_FILE,"Actframe,RT="<<$P_ACTFRAME[_XX,RT]<<" "<<$P_ACTFRAME[_YY,RT]<<" "<<$P_ACTFRAME[_ZZ,RT])
ELSE
WRITE(_LOG,_LOG_FILE,"Actframe,TR="<<$P_ACTFRAME[_XX,TR]<<" "<<$P_ACTFRAME[_ZZ,TR])
WRITE(_LOG,_LOG_FILE,"Actframe,RT="<<$P_ACTFRAME[_XX,RT]<<" "<<$P_ACTFRAME[_ZZ,RT])
ENDIF
CASE _POSR OF 0 GOTOF S_POSR_0 1 GOTOF S_POSR_1 2 GOTOF S_POSR_2 3 GOTOF S_POSR_3 4 GOTOF S_POSR_4 5 GOTOF S_POSR_5 6 GOTOF S_POSR_6 7 GOTOF S_POSR_7 8 GOTOF S_POSR_8 9 GOTOF S_POSR_9 10 GOTOF S_POSR_10 11 GOTOF S_POSR_11
CASE _POSR OF 20 GOTOF S_POSR_20 21 GOTOF S_POSR_21 22 GOTOF S_POSR_22 23 GOTOF S_POSR_23 24 GOTOF S_POSR_24 25 GOTOF S_POSR_25 26 GOTOF S_POSR_26 27 GOTOF S_POSR_27
CASE _POSR OF 30 GOTOF S_POSR_30 31 GOTOF S_POSR_31 32 GOTOF S_POSR_32 33 GOTOF S_POSR_33
CASE _POSR OF 100 GOTOF S_POSR_100 101 GOTOF S_POSR_101 102 GOTOF S_POSR_102 103 GOTOF S_POSR_103
WRITE(_LOG,_LOG_FILE,"Fehler: _POSR unbekannt ("<<_POSR<<")")
S_POSR_0:
S_POSR_9:
WRITE(_LOG,_LOG_FILE,"Richtung: Zur Bearbeitung("<<_X0<<"/"<<_Z0<<")")
GOTOF S_POSR_END
S_POSR_1:
S_POSR_2:
S_POSR_7:
S_POSR_8:
WRITE(_LOG,_LOG_FILE,"Richtung: Zum Werkzeugwechsel")
WRITE(_LOG,_LOG_FILE,"WWP: "<<_F_TCP[0]*_FAK2<<"/"<<_F_TCP[1]*_FAK2<<":"<<_F_TCP[2]<<"(0=WKS;1=MKS)")
GOTOF S_POSR_END
S_POSR_3:
WRITE(_LOG,_LOG_FILE,"Check: Startpunkt ("<<_X0<<"/"<<_Z0<<")")
GOTOF S_POSR_END
S_POSR_4:
WRITE(_LOG,_LOG_FILE,"Check: Endpunkt ("<<_X0<<"/"<<_Z0<<")")
GOTOF S_POSR_END
S_POSR_5:
WRITE(_LOG,_LOG_FILE,"Richtung: Zur Parkposition WKS("<<_X0<<"/"<<_Z0<<")")
GOTOF S_POSR_END
S_POSR_6:
WRITE(_LOG,_LOG_FILE,"Richtung: Zur Parkposition MKS("<<_X0<<"/"<<_Z0<<")")
GOTOF S_POSR_END
S_POSR_10:
WRITE(_LOG,_LOG_FILE,"Zielpunkt anfahren WKS("<<_X0<<"/"<<_Z0<<"/"<<_Y0<<")")
GOTOF S_POSR_END
S_POSR_11:
WRITE(_LOG,_LOG_FILE,"Zielpunkt anfahren MKS("<<_X0<<"/"<<_Z0<<"/"<<_Y0<<")")
GOTOF S_POSR_END
S_POSR_20:
WRITE(_LOG,_LOG_FILE,"Check Konturabspanen Startpunkt X- Aussen ("<<_X0<<"/"<<_Z0<<")")
GOTOF S_POSR_END
S_POSR_21:
WRITE(_LOG,_LOG_FILE,"Check Konturabspanen Endpunkt X- Aussen ("<<_X0<<"/"<<_Z0<<")")
GOTOF S_POSR_END
S_POSR_22:
WRITE(_LOG,_LOG_FILE,"Check Konturabspanen Startpunkt X+ Innen ("<<_X0<<"/"<<_Z0<<")")
GOTOF S_POSR_END
S_POSR_23:
WRITE(_LOG,_LOG_FILE,"Check Konturabspanen Endpunkt X+ Innen ("<<_X0<<"/"<<_Z0<<")")
GOTOF S_POSR_END
S_POSR_24:
WRITE(_LOG,_LOG_FILE,"Check Konturabspanen Startpunkt Z- Stirnseite ("<<_X0<<"/"<<_Z0<<")")
GOTOF S_POSR_END
S_POSR_25:
WRITE(_LOG,_LOG_FILE,"Check Konturabspanen Endpunkt Z- Stirnseite ("<<_X0<<"/"<<_Z0<<")")
GOTOF S_POSR_END
S_POSR_26:
WRITE(_LOG,_LOG_FILE,"Check Konturabspanen Startpunkt Z+ Rueckseite ("<<_X0<<"/"<<_Z0<<")")
GOTOF S_POSR_END
S_POSR_27:
WRITE(_LOG,_LOG_FILE,"Check Konturabspanen Endpunkt Z+ Rueckseite ("<<_X0<<"/"<<_Z0<<")")
GOTOF S_POSR_END
S_POSR_30:
WRITE(_LOG,_LOG_FILE,"Check Startpunkt X- Aussen ("<<_X0<<")")
GOTOF S_POSR_END
S_POSR_31:
WRITE(_LOG,_LOG_FILE,"Check Startpunkt X+ Innen ("<<_X0<<")")
GOTOF S_POSR_END
S_POSR_32:
WRITE(_LOG,_LOG_FILE,"Check Startpunkt Z- Stirnseite ("<<_Z0<<")")
GOTOF S_POSR_END
S_POSR_33:
WRITE(_LOG,_LOG_FILE,"Check Startpunkt Z+ Rueckseite ("<<_Z0<<")")
GOTOF S_POSR_END
S_POSR_100:
WRITE(_LOG,_LOG_FILE,"aus Rckzugsbereich herausfahren, bis MKS +Z mglich (fr Drehen ShopMill)")
GOTOF S_POSR_END
S_POSR_101:
WRITE(_LOG,_LOG_FILE,"Auf ZRA herausfahren (fr Drehen ShopMill)")
GOTOF S_POSR_END
S_POSR_102:
WRITE(_LOG,_LOG_FILE,"Auf XRA herausfahren (fr Drehen)")
GOTOF S_POSR_END
S_POSR_103:
WRITE(_LOG,_LOG_FILE,"Auf _F_RP_ACT herausfahren (fr Drehen)")
GOTOF S_POSR_END
S_POSR_END:
ENDIF
_RPT[0]=SET(_F_RPT[0],_F_RPT[1],_F_RPT[2],_F_RPT[3],_F_RPT[4],_F_RPT[5])
_P6=$P_GG[6]
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND($P_TOOL)AND($P_TC)AND(_PARK<>1)AND(S_ZIEL<>1)
G18
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"fest G18")
ENDIF
ENDIF
IF($P_TOOL)
F_SP_ED(_SD)
_SL=$P_ADT[2]
IF($P_AD[1]==505)OR($P_AD[1]==515)OR($P_AD[1]==525)OR($P_AD[1]==535)
S_Y_TURN=1
ENDIF
IF(NOT(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'H00200000')AND($P_CUTMOD))AND NOT(($P_CUTMODK==$PC_TRAFO_NAME)AND($P_CUTMODK<>""))AND(NOT S_Y_TURN))
_SL=_SLT[$P_ACTFRAME[_ZZ,MI],_SL]
_SL=_SLX[$P_ACTFRAME[_XX,MI],_SL]
ENDIF
IF(_SD)
IF(_SL==8)
_RPT[0]=_RPT[0]+_SD/_FAK2
IF(_F_RPT[4]<>_NO_VAL)
_RPT[4]=_RPT[4]+_SD/_FAK2
ENDIF
ELSE
IF(_SL==6)
IF(_F_RPT[2]<>_NO_VAL)
_RPT[2]=_RPT[2]-_SD/_FAK2
ENDIF
ELSE
IF(_SL==7)
_RPT[1]=_RPT[1]+_SD/_FAK2
ELSE
IF(_F_RPT[3]<>_NO_VAL)
_RPT[3]=_RPT[3]-_SD/_FAK2
ENDIF
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Schneidendifferenz: "<<_SD<<" Lage: "<<_SL)
WRITE(_LOG,_LOG_FILE,"RP,korr: "<<_RPT[0]*_FAK2<<"/"<<_RPT[1]*_FAK2<<"/"<<_RPT[2]*_FAK2<<"/"<<_RPT[3]*_FAK2<<"/XR:"<<_RPT[4]*_FAK2)
ENDIF
ENDIF
ENDIF
IF((_RPT[0]<=_RPT[2])AND(_RPT[2]<>_NO_VAL))OR((_RPT[1]<=_RPT[3])AND(_RPT[3]<>_NO_VAL))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"ALARM: Die aeussere Rueckzugsebene muss groesser als die Innere sein")
ENDIF
GOTOF _FEHL11
ENDIF
_Z_TR=$P_PFRAME[_ZZ,TR]*_FAK1
IF($MN_MM_FRAME_FINE_TRANS)
_Z_TR=_Z_TR+$P_PFRAME[_ZZ,FI]*_FAK1
ENDIF
IF(_POSR==3)OR(_POSR==4)
IF(NOT(_MD9899 B_AND 1))
IF(_X0>=_RPT[0]*_FAK2)OR(_Z0+_Z_TR>=_RPT[1]*_FAK2)OR((_X0<=_RPT[2]*_FAK2)AND(_RPT[2]<>_NO_VAL))OR((_Z0+_Z_TR<=_RPT[3]*_FAK2)AND(_RPT[3]<>_NO_VAL))
IF(_POSR==3) GOTOF _FEHL9
IF(_POSR==4) GOTOF _FEHL10
ENDIF
ENDIF
GOTOF _RET
ENDIF
IF(_POSR>=20)AND(_POSR<=27)
IF(NOT(_MD9899 B_AND 1))
IF(_POSR==20)OR(_POSR==21)
IF(_X0-S_RP_TOL>_RPT[0]*_FAK2)OR(_Z0+_Z_TR-S_RP_TOL>_RPT[1]*_FAK2)OR((_Z0+_Z_TR+S_RP_TOL<_RPT[3]*_FAK2)AND(_RPT[3]<>_NO_VAL))
IF(_POSR==20) GOTOF _FEHL9
IF(_POSR==21) GOTOF _FEHL10
ENDIF
ENDIF
IF(_POSR==22)OR(_POSR==23)
IF(_Z0+_Z_TR-S_RP_TOL>_RPT[1]*_FAK2)OR((_X0+S_RP_TOL<_RPT[2]*_FAK2)AND(_RPT[2]<>_NO_VAL))OR((_Z0+_Z_TR+S_RP_TOL<_RPT[3]*_FAK2)AND(_RPT[3]<>_NO_VAL))
IF(_POSR==22) GOTOF _FEHL9
IF(_POSR==23) GOTOF _FEHL10
ENDIF
ENDIF
IF(_POSR==24)OR(_POSR==25)
IF(_X0-S_RP_TOL>_RPT[0]*_FAK2)OR(_Z0+_Z_TR-S_RP_TOL>_RPT[1]*_FAK2)OR((_X0+S_RP_TOL<_RPT[2]*_FAK2)AND(_RPT[2]<>_NO_VAL))
IF(_POSR==24) GOTOF _FEHL9
IF(_POSR==25) GOTOF _FEHL10
ENDIF
ENDIF
IF(_POSR==26)OR(_POSR==27)
IF(_X0-S_RP_TOL>_RPT[0]*_FAK2)OR((_X0+S_RP_TOL<_RPT[2]*_FAK2)AND(_RPT[2]<>_NO_VAL))OR((_Z0+_Z_TR+S_RP_TOL<_RPT[3]*_FAK2)AND(_RPT[3]<>_NO_VAL))
IF(_POSR==26) GOTOF _FEHL9
IF(_POSR==27) GOTOF _FEHL10
ENDIF
ENDIF
ENDIF
GOTOF _RET
ENDIF
IF(_POSR>=30)AND(_POSR<=33)
IF(_POSR==30)
IF(_X0-S_RP_TOL>_RPT[0]*_FAK2)
GOTOF _FEHL9
ENDIF
ENDIF
IF(_POSR==31)
IF((_X0+S_RP_TOL<_RPT[2]*_FAK2)AND(_RPT[2]<>_NO_VAL))
GOTOF _FEHL9
ENDIF
ENDIF
IF(_POSR==32)
IF(_Z0+_Z_TR-S_RP_TOL>_RPT[1]*_FAK2)
GOTOF _FEHL9
ENDIF
ENDIF
IF(_POSR==33)
IF((_Z0+_Z_TR+S_RP_TOL<_RPT[3]*_FAK2)AND(_RPT[3]<>_NO_VAL))
GOTOF _FEHL9
ENDIF
ENDIF
GOTOF _RET
ENDIF
IF(((_MODE B_AND 'B01')==0)AND(_F_RELEAS==1))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"nicht anfahren wegen _F_RELEAS=1")
ENDIF
GOTOF _END
ENDIF
IF($MCS_FUNCTION_MASK_TECH B_AND 'H1000')
IF(_Z_TR>0)
SETAL(62201)
M0
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"ALARM: Z-Verschiebung wirkt nicht auf die Rckzugsebenen! Z-TRANS="<<_Z_TR)
ENDIF
ENDIF
ENDIF
IF(_E_ST_PRG)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(300)")
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(0)")
ENDIF
F_SP_TRA(300)
F_SP_TRA(0)
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"$P_PFRAME=CTRANS()")
ENDIF
_PFRAME=$P_PFRAME
$P_PFRAME=CTRANS()
_P29=$P_GG[29]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"DIAMOF")
ENDIF
DIAMCYCOF
IF(_LOG_ON)
IF(_F_Y_AXIS)
WRITE(_LOG,_LOG_FILE,"Aktuelle Pos. (WKS): X"<<$P_EP[_XX]*_FAK1<<" Z"<<$P_EP[_ZZ]*_FAK1<<" Y"<<$P_EP[_YY]*_FAK1)
WRITE(_LOG,_LOG_FILE,"              (MKS): X"<<$AA_IM[_XX]*_FAK1<<" Z"<<$AA_IM[_ZZ]*_FAK1<<" Y"<<$AA_IM[_YY]*_FAK1)
ELSE
WRITE(_LOG,_LOG_FILE,"Aktuelle Pos. (WKS): X"<<$P_EP[_XX]*_FAK1<<" Z"<<$P_EP[_ZZ]*_FAK1)
WRITE(_LOG,_LOG_FILE,"              (MKS): X"<<$AA_IM[_XX]*_FAK1<<" Z"<<$AA_IM[_ZZ]*_FAK1)
ENDIF
IF($P_TOOLNO)AND($P_TOOL)
WRITE(_LOG,_LOG_FILE,"Ti="<<$P_TOOLNO<<" Typ="<<$TC_DP1[$P_TOOLNO,$P_TOOL]<<" D"<<$P_TOOL<<" $P_TOOLL: L1="<<$P_TOOLL[1]<<" L2="<<$P_TOOLL[2]<<" L3="<<$P_TOOLL[3])
WRITE(_LOG,_LOG_FILE,"$P_ACT_TOOL_LENGTH_INDEX[0]="<<$P_ACT_TOOL_LENGTH_INDEX[0]<<" [1]="<<$P_ACT_TOOL_LENGTH_INDEX[1]<<" [2]="<<$P_ACT_TOOL_LENGTH_INDEX[2])
ENDIF
ENDIF
IF(_POSR==100)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"DFM: Freifahren bis Z MKS")
ENDIF
_POSR=0
_INTERPOL=1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"WPFRAME:  X "<<$P_WPFRAME[_XX,RT]<<"  Y "<<$P_WPFRAME[_YY,RT]<<"  Z "<<$P_WPFRAME[_ZZ,RT])
WRITE(_LOG,_LOG_FILE,"TRAFRAME: X "<<$P_TRAFRAME_P[_XX,RT]<<"  Y "<<$P_TRAFRAME_P[_YY,RT]<<"  Z "<<$P_TRAFRAME_P[_ZZ,RT])
ENDIF
_VECT=CTRANS()
_VECT[_ZZ,TR]=1
_FRAME=$P_WPFRAME:$P_TRAFRAME_P
_FRAME[_XX,TR]=0
_FRAME[_YY,TR]=0
_FRAME[_ZZ,TR]=0
_VECT=INVFRAME(_FRAME):_VECT
S_DIR_Z=_VECT[_ZZ,TR]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Richtung WKS-Z im MKS: X "<<_VECT[_XX,TR]<<"  Y "<<_VECT[_YY,TR]<<"  Z "<<_VECT[_ZZ,TR])
ENDIF
_VECT=CTRANS()
_VECT[_XX,TR]=1
_FRAME=$P_WPFRAME:$P_TRAFRAME_P
_FRAME[_XX,TR]=0
_FRAME[_YY,TR]=0
_FRAME[_ZZ,TR]=0
_VECT=INVFRAME(_FRAME):_VECT
S_DIR_X=_VECT[_ZZ,TR]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Richtung WKS-X im MKS: X "<<_VECT[_XX,TR]<<"  Y "<<_VECT[_YY,TR]<<"  Z "<<_VECT[_ZZ,TR])
WRITE(_LOG,_LOG_FILE,"letzte Zustellrichtung: "<<_F_RP_DIR[0])
ENDIF
_Y0=0
_X0=$P_EP[_XX]*_FAK1
_Z0=$P_EP[_ZZ]*_FAK1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"akt.: Z"<<_Z0<<" X"<<_X0)
ENDIF
IF(_F_RP_DIR[0]==-1)
IF(S_DIR_Z>=0)
_Z0=_RPT[1]*_FAK2
ELSE
IF(S_DIR_X>=0)
_Z0=_RPT[1]*_FAK2
_X0=_RPT[0]*_FAK2
ELSE
GOTOF _FEHL14
ENDIF
ENDIF
ENDIF
IF(_F_RP_DIR[0]==-2)
IF(S_DIR_X>=0)
_X0=_RPT[0]*_FAK2
ELSE
IF(S_DIR_Z>=0)
_Z0=_RPT[1]*_FAK2
_X0=_RPT[0]*_FAK2
ELSE
GOTOF _FEHL14
ENDIF
ENDIF
ENDIF
IF(_F_RP_DIR[0]==1)
IF(S_DIR_X>=0)
_Z0=_RPT[3]*_FAK2
_X0=_RPT[0]*_FAK2
ELSE
IF(S_DIR_Z>=0)
_Z0=_RPT[1]*_FAK2
_X0=_RPT[0]*_FAK2
ELSE
GOTOF _FEHL14
ENDIF
ENDIF
ENDIF
IF(_F_RP_DIR[0]==2)
IF(S_DIR_Z>=0)
_Z0=_RPT[1]*_FAK2
_X0=_RPT[2]*_FAK2
ELSE
IF(S_DIR_X>=0)
_Z0=_RPT[1]*_FAK2
_X0=_RPT[0]*_FAK2
ELSE
GOTOF _FEHL14
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Ziel: Z"<<_Z0<<" X"<<_X0)
ENDIF
ENDIF
IF(_POSR==101)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"DFM: Freifahren bis ZRA")
ENDIF
_POSR=0
_INTERPOL=1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"letzte Zustellrichtung: "<<_F_RP_DIR[0])
ENDIF
_Y0=0
_X0=$P_EP[_XX]*_FAK1
_Z0=$P_EP[_ZZ]*_FAK1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"akt.: Z"<<_Z0<<" X"<<_X0)
ENDIF
IF(_F_RP_DIR[0]==-1)
_Z0=_RPT[1]*_FAK2
ENDIF
IF(_F_RP_DIR[0]==-2)
_Z0=_RPT[1]*_FAK2
ENDIF
IF(_F_RP_DIR[0]==1)
_X0=_RPT[0]*_FAK2
_Z0=_RPT[1]*_FAK2
S_NUM_ADD=1
ENDIF
IF(_F_RP_DIR[0]==2)
_X0=_RPT[2]*_FAK2
_Z0=_RPT[1]*_FAK2
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Ziel: Z"<<_Z0<<" X"<<_X0)
ENDIF
ENDIF
IF(_POSR==102)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Drehen: Freifahren bis XRA")
ENDIF
IF(_F_RP_DIR[0]==1)OR(_F_RP_DIR[0]==2)OR(_F_RP_DIR[0]==-1)OR(_F_RP_DIR[0]==-2)
_POSR=0
_INTERPOL=1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"letzte Zustellrichtung: "<<_F_RP_DIR[0])
ENDIF
_Y0=0
_X0=$P_EP[_XX]*_FAK1
_Z0=$P_EP[_ZZ]*_FAK1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"akt.: Z"<<_Z0<<" X"<<_X0)
ENDIF
IF(_X0<_RPT[0]*_FAK2)
_X0=_RPT[0]*_FAK2
IF(_F_RP_DIR[0]==-1)
IF(_Z0<_RPT[1]*_FAK2)
_Z0=_RPT[1]*_FAK2
ENDIF
ELSE
IF(_F_RP_DIR[0]==-2)
ELSE
IF(_F_RP_DIR[0]==1)
IF(_Z0>_RPT[3]*_FAK2)
_Z0=_RPT[3]*_FAK2
ENDIF
;S_NUM_ADD=1
ELSE
IF(_F_RP_DIR[0]==2)
IF(_Z0<_RPT[1]*_FAK2)
_Z0=_RPT[1]*_FAK2
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Ziel: Z"<<_Z0<<" X"<<_X0)
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"letzte Zustellrichtung unbekannt")
ENDIF
GOTOF _RET
ENDIF
ENDIF
IF(_POSR==103)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Drehen: Freifahren bis _F_RP_ACT")
WRITE(_LOG,_LOG_FILE,"_F_RP_DIR="<<_F_RP_DIR[0]<<"/"<<_F_RP_DIR[1])
ENDIF
IF(_F_RP_DIR[0]==1)OR(_F_RP_DIR[0]==2)OR(_F_RP_DIR[0]==-1)OR(_F_RP_DIR[0]==-2)
_POSR=0
_INTERPOL=1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"letzte Zustellrichtung: "<<_F_RP_DIR[0])
ENDIF
_Y0=0
_X0=$P_EP[_XX]*_FAK1
_Z0=$P_EP[_ZZ]*_FAK1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"akt.: Z"<<_Z0<<" X"<<_X0)
ENDIF
IF(_F_RP_DIR[0]==-1)
IF(_Z0<_RPT[1]*_FAK2)
_Z0=_RPT[1]*_FAK2
ENDIF
ELSE
IF(_F_RP_DIR[0]==-2)
IF(_X0<_RPT[0]*_FAK2)
_X0=_RPT[0]*_FAK2
ENDIF
ELSE
IF(_F_RP_DIR[0]==1)
IF(_Z0>_RPT[3]*_FAK2)
_Z0=_RPT[3]*_FAK2
ENDIF
ELSE
IF(_F_RP_DIR[0]==2)
IF(_X0>_RPT[2]*_FAK2)
_X0=_RPT[2]*_FAK2
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Ziel: Z"<<_Z0<<" X"<<_X0)
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"letzte Zustellrichtung unbekannt")
ENDIF
GOTOF _RET
ENDIF
ENDIF
IF(_F_TC_ACT)AND((_F_TRAANG)OR(_F_Y_AXIS))
IF(_F_TCP[2]==1)
_PARK_Y=$P_SETFR[_YY,TR]
ENDIF
ENDIF
IF(_POSR==2)
_ST_RP=1
_POSR=1
ENDIF
IF(_POSR==5)OR(_POSR==6)
_PAR=_PAR+'B1000'
_PARK=_POSR-4
_POSR=1
ENDIF
IF(_POSR==7)
_NOGO_TCP=1
_POSR=1
ELSE
_PAR=4*(_MD9898 B_AND 'H0100')/'H0100'
ENDIF
IF(_POSR==10)OR(_POSR==11)
S_ZIEL=_POSR-9
IF(_POSR==11)
IF($P_TOOLNO)AND($P_TOOL)
_Y0=_Y0-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[1])]*_FAK1
ENDIF
ENDIF
_POSR=0
ENDIF
IF(_POSR>1)AND(_POSR<>8) GOTOF _FEHL12
_PAR=_PAR+_POSR
IF($MN_SIM_ENVIRONMENT B_AND 'B100')
_PAR=_PAR+2
ENDIF
IF($MCS_FUNCTION_MASK_TECH B_AND 'H4000')
_PAR=_PAR+'H20'
ENDIF
S_WWP_Y=$MCS_TOOL_CHANGE_POS_Y*_FAK1
IF(_SC_Y_TURN)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"vorher Y-Drehen aktiv!")
ENDIF
N800 G0 AX[_XX]=_F_RPT[0]
N801 G0 AX[_ZZ]=_F_RPT[1]
N805 CYCLE805()
ENDIF
IF(_POSR)
IF(_PARK)
_TCP[0]=_X0/_FAK2
_TCP[1]=_Z0/_FAK2
_TCP[2]=_PARK-1
IF(_PARK==1)
_PAR=_PAR B_OR 'B10000'
ENDIF
IF($MCS_SUB_SPINDLE_PARK_POS_Y)
REPEAT _PARK2WKS_A _PARK2WKS_E
ENDIF
IF(_PARK==1)
IF($P_TOOLNO)AND($P_TOOL)
_Y0=-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[1])]*_FAK1
ELSE
_Y0=0
ENDIF
ENDIF
ELSE
IF(S_ZIEL)
IF(S_ZIEL==2)
REPEAT S_ZIEL2WKS_A S_ZIEL2WKS_E
ENDIF
_TCP[0]=_X0/_FAK2
_TCP[1]=_Z0/_FAK2
_TCP[2]=0
IF(S_ZIEL==1)
_PAR=_PAR B_OR 'B10000'
ENDIF
ELSE
_TCP[0]=_F_TCP[0]
_TCP[1]=_F_TCP[1]
_TCP[2]=_F_TCP[2]
ENDIF
ENDIF
IF(NOT _F_AX_EXISTS[6])OR(($MCS_FUNCTION_MASK_TECH B_AND 'H01')==0)
IF(_PARK)OR(S_ZIEL==0)
IF($P_TOOLNO)AND($P_TOOL)
_Y0=-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[1])]*_FAK1
ELSE
_Y0=0
ENDIF
IF(_TCP[2]==0)
_TCPWKS[0]=_TCP[0]*_FAK2
IF(_PARK)
_TCPWKS[1]=_Y0+_PARK_Y
ELSE
IF(S_WWP_Y==0)
IF($MCS_FUNCTION_MASK_TECH B_AND 'H2000')
_TCPWKS[1]=_Y0
ELSE
_TCPWKS[1]=0
ENDIF
ELSE
_TCPWKS[1]=_Y0+S_WWP_Y
ENDIF
ENDIF
_TCPWKS[2]=_TCP[1]*_FAK2
F_SP_RPF(0,_TCPWKS)
ELSE
$AC_MEAS_VALID=0
$AC_MEAS_TYPE=24
$AC_MEAS_P1_COORD=2
$AC_MEAS_P2_COORD=0
$AA_MEAS_POINT1[_XX]=(_TCP[0]*_FAK2)/_FAK1
$AA_MEAS_POINT1[_ZZ]=(_TCP[1]*_FAK2)/_FAK1
IF(_Y_EXISTS)
$AA_MEAS_POINT1[_YY]=_PARK_Y
ENDIF
_ERR=MEASURE()
IF(_ERR)
_ERR=6
GOTOF _END
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"MEASURE:")
WRITE(_LOG,_LOG_FILE,"  MKS: X="<<$AA_MEAS_POINT1[_XX]<<" Z="<<$AA_MEAS_POINT1[_ZZ])
WRITE(_LOG,_LOG_FILE,"  WKS: X="<<$AA_MEAS_POINT2[_XX]<<" Z="<<$AA_MEAS_POINT2[_ZZ])
ENDIF
_TCPWKS[0]=$AA_MEAS_POINT2[_XX]*_FAK1*S_FAK_PLAN
IF(_Y_EXISTS)
IF(_PARK)
_TCPWKS[1]=$AA_MEAS_POINT2[_YY]*_FAK1+_Y0
ELSE
IF(S_WWP_Y==0)
IF($MCS_FUNCTION_MASK_TECH B_AND 'H2000')
_TCPWKS[1]=$AA_MEAS_POINT2[_YY]*_FAK1+_Y0
ELSE
_TCPWKS[1]=0
ENDIF
ELSE
_TCPWKS[1]=$AA_MEAS_POINT2[_YY]*_FAK1+_Y0+S_WWP_Y
ENDIF
ENDIF
ENDIF
_TCPWKS[2]=$AA_MEAS_POINT2[_ZZ]*_FAK1
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_TCPWKS[]="<<_TCPWKS[0]<<" "<<_TCPWKS[1]<<" "<<_TCPWKS[2])
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_TCP,ori[]="<<_TCP[0]<<" "<<_TCP[1]<<" "<<_TCP[2]<<" $P_TC="<<$P_TC)
ENDIF
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND($P_TOOL)AND($P_TC)AND(_PARK<>1)AND(S_ZIEL<>1)
_PAR=_PAR B_OR 'B10000'
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"$P_CUTMOD="<<$P_CUTMOD)
WRITE(_LOG,_LOG_FILE,"$P_TC="<<$P_TC)
WRITE(_LOG,_LOG_FILE,"TC_CARR4 5 6="<<$PC_TCARR_OFFSET[2,0]<<" "<<$PC_TCARR_OFFSET[2,1]<<" "<<$PC_TCARR_OFFSET[2,2])
ENDIF
_TOOLL[0]=$PC_TCARR_OFFSET[2,0]
_TOOLL[1]=$PC_TCARR_OFFSET[2,1]
_TOOLL[2]=$PC_TCARR_OFFSET[2,2]
IF($P_TOOLNO)AND($P_TOOL)
_TOOLL[0]=_TOOLL[0]+$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]
_TOOLL[1]=_TOOLL[1]-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[1])]
_TOOLL[2]=_TOOLL[2]+$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[2])]
ENDIF
IF($TC_CARR23[$P_TC]=="T")
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"TC_CARR15 16 17="<<$PC_TCARR_OFFSET[3,0]<<" "<<$PC_TCARR_OFFSET[3,1]<<" "<<$PC_TCARR_OFFSET[3,2])
ENDIF
_TOOLL[0]=_TOOLL[0]+$PC_TCARR_OFFSET[3,0]
_TOOLL[1]=_TOOLL[1]+$PC_TCARR_OFFSET[3,1]
_TOOLL[2]=_TOOLL[2]+$PC_TCARR_OFFSET[3,2]
ENDIF
CYCLE213($P_TC)
IF(NOT _Y_EXISTS)
_VECT=CTRANS(_XX,_TOOLL[0],_ZZ,_TOOLL[2])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"VECT="<<_VECT[_XX,TR]<<" "<<_VECT[_ZZ,TR])
ENDIF
IF(_POSR)AND(_TCP[2]==0)
_FRAME[_ZZ,MI]=$P_ACTFRAME[_ZZ,MI]
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"FRAME="<<_FRAME[_XX,TR]<<" "<<_FRAME[_ZZ,TR])
WRITE(_LOG,_LOG_FILE,"TC_CARR13 14 24(B-Offset)="<<$TC_CARR13[$P_TC]<<" "<<$TC_CARR14[$P_TC]<<" "<<$PC_TCARR_AX_OFFSET[1])
WRITE(_LOG,_LOG_FILE,"_TC_A1="<<_TC_A1<<" _TC_A2="<<_TC_A2)
WRITE(_LOG,_LOG_FILE,"$P_TCANG[1]="<<$P_TCANG[1]<<" $P_TCANG[2]="<<$P_TCANG[2])
WRITE(_LOG,_LOG_FILE,"Pos "<<$TC_CARR35[$P_TC]<<"="<<$P_EP[AXNAME($TC_CARR35[$P_TC])])
ENDIF
_FRAME=_FRAME:CRPL(0,$P_TCANG[1]-$PC_TCARR_AX_OFFSET[1])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CROT Y="<<$P_TCANG[1]-$PC_TCARR_AX_OFFSET[1])
ENDIF
IF($P_TC==_F_TC_DEF[2])AND($P_ADT[1]>=500)AND($P_ADT[1]<599)
_FRAME=_FRAME:CRPL(0,$P_TCANG[1]-$PC_TCARR_AX_OFFSET[1])
_FRAME=_FRAME:CROT(_ZZ,$P_TCANG[2])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"FRAME,TR="<<_FRAME[_XX,TR]<<" "<<_FRAME[_ZZ,TR])
WRITE(_LOG,_LOG_FILE,"FRAME,RT="<<_FRAME[_XX,RT]<<" "<<$P_TCANG[1]-$PC_TCARR_AX_OFFSET[1]<<" "<<_FRAME[_ZZ,RT])
ENDIF
ENDIF
_VECT=_FRAME:_VECT
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"VECT="<<_VECT[_XX,TR]<<" "<<_VECT[_ZZ,TR])
ENDIF
_VECT[_XX,TR]=_VECT[_XX,TR]+$PC_TCARR_OFFSET[1,0]
_VECT[_ZZ,TR]=_VECT[_ZZ,TR]+$PC_TCARR_OFFSET[1,2]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"TC="<<$P_TC<<" B="<<$P_TCANG[1]<<" C="<<$$P_TCANG[2]<<" X="<<_TCP[0]<<" Z="<<_TCP[1]<<" TRX="<<_VECT[_XX,TR]<<" TRZ="<<_VECT[_ZZ,TR])
ENDIF
_TCP[0]=_TCP[0]-_VECT[_XX,TR]
_TCP[1]=_TCP[1]-_VECT[_ZZ,TR]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_TCP,2[]="<<_TCP[0]<<" "<<_TCP[1]<<" Y0="<<_Y0)
ENDIF
ELSE
_VECT=CTRANS(_XX,_TOOLL[0],_YY,_TOOLL[1],_ZZ,_TOOLL[2])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"VECT="<<_VECT[_XX,TR]<<" "<<_VECT[_YY,TR]<<" "<<_VECT[_ZZ,TR])
ENDIF
IF(_POSR)AND(_TCP[2]==0)
_FRAME[_ZZ,MI]=$P_ACTFRAME[_ZZ,MI]
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"FRAME="<<_FRAME[_XX,TR]<<" "<<_FRAME[_YY,TR]<<" "<<_FRAME[_ZZ,TR])
WRITE(_LOG,_LOG_FILE,"TC_CARR13 14 24(B-Offset)="<<$TC_CARR13[$P_TC]<<" "<<$TC_CARR14[$P_TC]<<" "<<$PC_TCARR_AX_OFFSET[1])
WRITE(_LOG,_LOG_FILE,"_TC_A1="<<_TC_A1<<" _TC_A2="<<_TC_A2)
WRITE(_LOG,_LOG_FILE,"$P_TCANG[1]="<<$P_TCANG[1]<<" $P_TCANG[2]="<<$P_TCANG[2])
WRITE(_LOG,_LOG_FILE,"Pos "<<$TC_CARR35[$P_TC]<<"="<<$P_EP[AXNAME($TC_CARR35[$P_TC])])
ENDIF
_FRAME=_FRAME:CROT(_YY,$P_TCANG[1]-$PC_TCARR_AX_OFFSET[1])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CROT Y="<<$P_TCANG[1]-$PC_TCARR_AX_OFFSET[1])
ENDIF
IF($P_TC==_F_TC_DEF[2])AND($P_ADT[1]>=500)AND($P_ADT[1]<599)
_FRAME=_FRAME:CROT(_ZZ,$P_TCANG[2])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"FRAME,TR="<<_FRAME[_XX,TR]<<" "<<_FRAME[_YY,TR]<<" "<<_FRAME[_ZZ,TR])
WRITE(_LOG,_LOG_FILE,"FRAME,RT="<<_FRAME[_XX,RT]<<" "<<_FRAME[_YY,RT]<<" "<<_FRAME[_ZZ,RT])
ENDIF
ENDIF
_VECT=_FRAME:_VECT
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"VECT="<<_VECT[_XX,TR]<<" "<<_VECT[_YY,TR]<<" "<<_VECT[_ZZ,TR])
ENDIF
_VECT[_XX,TR]=_VECT[_XX,TR]+$PC_TCARR_OFFSET[1,0]
_VECT[_YY,TR]=_VECT[_YY,TR]+$PC_TCARR_OFFSET[1,1]
_VECT[_ZZ,TR]=_VECT[_ZZ,TR]+$PC_TCARR_OFFSET[1,2]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"TC="<<$P_TC<<" B="<<$P_TCANG[1]<<" C="<<$P_TCANG[2]<<" X="<<_TCP[0]<<" Z="<<_TCP[1]<<" TRX="<<_VECT[_XX,TR]<<" TRY="<<_VECT[_YY,TR]<<" TRZ="<<_VECT[_ZZ,TR])
ENDIF
_TCP[0]=_TCP[0]-_VECT[_XX,TR]
_TCP[1]=_TCP[1]-_VECT[_ZZ,TR]
_Y0=_VECT[_YY,TR]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_TCP,2[]="<<_TCP[0]<<" "<<_TCP[1]<<" Y0="<<_Y0)
ENDIF
ENDIF
ENDIF
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND((_F_TRAANG)OR(_F_Y_AXIS))AND(S_ZIEL<>1)
IF(_TCP[2]==0)
_TCPWKS[0]=_TCP[0]*_FAK2
IF(_PARK)OR(S_ZIEL)
_TCPWKS[1]=_Y0+_PARK_Y
ELSE
IF(S_WWP_Y==0)
IF($MCS_FUNCTION_MASK_TECH B_AND 'H2000')
_TCPWKS[1]=_Y0
ELSE
_TCPWKS[1]=0
ENDIF
ELSE
_TCPWKS[1]=_Y0+S_WWP_Y
ENDIF
ENDIF
_TCPWKS[2]=_TCP[1]*_FAK2
F_SP_RPF(0,_TCPWKS)
ELSE
$AC_MEAS_VALID=0
$AC_MEAS_TYPE=24
$AC_MEAS_P1_COORD=2
$AC_MEAS_P2_COORD=0
$AA_MEAS_POINT1[_XX]=(_TCP[0]*_FAK2)/_FAK1
$AA_MEAS_POINT1[_ZZ]=(_TCP[1]*_FAK2)/_FAK1
$AA_MEAS_POINT1[_YY]=_PARK_Y
_ERR=MEASURE()
IF(_ERR)
_ERR=6
GOTOF _END
ENDIF
_TCPWKS[0]=$AA_MEAS_POINT2[_XX]*_FAK1*S_FAK_PLAN
IF(_PARK)OR(S_ZIEL)
_TCPWKS[1]=$AA_MEAS_POINT2[_YY]*_FAK1+_Y0
ELSE
IF(S_WWP_Y==0)
IF($MCS_FUNCTION_MASK_TECH B_AND 'H2000')
_TCPWKS[1]=$AA_MEAS_POINT2[_YY]*_FAK1+_Y0
ELSE
_TCPWKS[1]=0
ENDIF
ELSE
_TCPWKS[1]=$AA_MEAS_POINT2[_YY]*_FAK1+_Y0+S_WWP_Y
ENDIF
ENDIF
_TCPWKS[2]=$AA_MEAS_POINT2[_ZZ]*_FAK1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Actframe,TR="<<$P_ACTFRAME[_XX,TR]<<" "<<$P_ACTFRAME[_YY,TR]<<" "<<$P_ACTFRAME[_ZZ,TR])
WRITE(_LOG,_LOG_FILE,"Actframe,RT="<<$P_ACTFRAME[_XX,RT]<<" "<<$P_ACTFRAME[_YY,RT]<<" "<<$P_ACTFRAME[_ZZ,RT])
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"TCPWKS="<<_TCPWKS[0]<<" "<<_TCPWKS[1]<<" "<<_TCPWKS[2])
ENDIF
_TCPENS[0]=_TCPWKS[0]
_TCPENS[1]=_TCPWKS[1]
_TCPENS[2]=_TCPWKS[2]
F_SP_RPF(1,_TCPENS)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"TCPENS="<<_TCPENS[0]<<" "<<_TCPENS[1]<<" "<<_TCPENS[2])
ENDIF
_TCP[0]=_TCPWKS[0]/_FAK2
_TCP[1]=_TCPWKS[2]/_FAK2
_TCP[2]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_TCP,WKS[]="<<_TCP[0]<<" "<<_TCP[1]<<" "<<_TCP[2])
ENDIF
ELSE
_TCP[0]=_X0
_TCP[1]=_Z0+_Z_TR
_TCP[2]=0
ENDIF
IF(_POSR==8)OR((_POSR)AND(_F_RP_DIR[0]==7))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"nur WZW-Punkt anfahren")
ENDIF
_F_RP_DIR[0]=0
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND($P_TC)
_TCPWKS[0]=_TCPWKS[0]*(1-2*$P_ACTFRAME[_XX,MI])
REPEAT _WZW_WKS_A _WZW_WKS_E
ELSE
REPEAT _WZW_TC0_A _WZW_TC0_E
ENDIF
GOTOF _RESTORE
ENDIF
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_RPT[5]<>_SC_NO_VAL)AND(((_POSR)AND(_PARK==0)AND(_F_RP_DIR[0]==6))OR((_POSR==0)AND(_F_RP_DIR[1]==6)))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"B-Achse: ShopTurn Rueckzugslogik anwenden?")
ENDIF
IF(_POSR)AND(_PARK==0)AND(_F_RP_DIR[0]==6)
IF($P_EP[_ZZ]*_FAK1<_RPT[5]*_FAK2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Nach Stirn B auf RP herausziehen: "<<$P_EP[_XX]*_FAK1<<"/"<<_RPT[5]*_FAK2)
ENDIF
SBLON
N1 G0 G90 AX[_ZZ]=_RPT[5]*_FAK2
SBLOF
ENDIF
IF(_TCPWKS[2]<_RPT[5]*_FAK2)
REPEAT _CHECK_WZW_A _CHECK_WZW_E
IF(_STAT)
_ZP[0]=_RPT[0]*_FAK2 _ZP[1]=_Y0 _ZP[2]=_RPT[1]*_FAK2
F_SP_RPF(0,_ZP)
IF(_ZP[2]>=_RPT[5]*_FAK2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Nach Stirn B auf Ecke Rueckzugsbereich fahren: "<<_ZP[0]<<"/"<<_ZP[2])
ENDIF
SBLON
N2 G0 G90 AX[_XX]=_ZP[0] AX[_YY]=_ZP[1] AX[_ZZ]=_ZP[2]
SBLOF
REPEAT _CHECK_WZW_A _CHECK_WZW_E
ENDIF
IF(_STAT)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Nach Stirn B Werkzeugwechselpunkt in XY anfahren: "<<_TCPWKS[0]<<"/"<<_RPT[5]*_FAK2)
ENDIF
N3 F_SP_RPB(1,0,_TCPWKS[0],_TCPWKS[1],_TCPWKS[2])
REPEAT _CHECK_WZW_A _CHECK_WZW_E
;IF(_STAT) GOTOF _FEHL3
IF(_STAT) GOTOF _ST_LOGIC
ENDIF
ENDIF
ENDIF
IF(_NOGO_TCP==0)
REPEAT _WZW_WKS_A _WZW_WKS_E
ENDIF
GOTOF _RESTORE
ENDIF
IF(_POSR==0)AND(_F_RP_DIR[1]==6)
IF($P_EP[_ZZ]*_FAK1<_RPT[5]*_FAK2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Vor Stirn B auf RP herausziehen: "<<$P_EP[_XX]*_FAK1<<"/"<<_RPT[5]*_FAK2)
ENDIF
;_ZP[0]=$P_EP[_XX]*_FAK1 _ZP[1]=$P_EP[_YY]*_FAK1 _ZP[2]=_RPT[5]*_FAK2
;REPEAT _CHECK_ZP_A _CHECK_ZP_E
;IF(_STAT) GOTOF _FEHL2
;IF(_STAT) GOTOF _ST_LOGIC
N5 F_SP_RPB(10,_RPT[5]*_FAK2,_X0,_Y0,_Z0)
IF($P_EP[_ZZ]*_FAK1<_RPT[5]*_FAK2)
_ZP[0]=_X0 _ZP[1]=_Y0 _ZP[2]=_Z0
REPEAT _CHECK_ZP_A _CHECK_ZP_E
;IF(_STAT) GOTOF _FEHL2
IF(_STAT) GOTOF _ST_LOGIC
ENDIF
ENDIF
GOTOF _RESTORE
ENDIF
ENDIF
_ST_LOGIC:
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
IF($P_TC)
IF($TC_CARR23[$P_TC]<>"P")
_ST_RETRACT=1
_ZP[0]=_TCP[0] _ZP[1]=_TCPWKS[1] _ZP[2]=_TCP[1]
F_SP_RPF(1,_ZP)
_TCP[0]=_ZP[0] _TCPWKS[1]=_ZP[1] _TCP[1]=_ZP[2]
_WPFRAME=$P_WPFRAME
_PARTFRAME=$P_PARTFRAME
WRTPR("IGNORE(16,0)",1)
$P_WPFRAME=CTRANS()
$P_PARTFRAME=CTRANS()
WRTPR("IGNORE(32,0)",1)
ENDIF
ENDIF
IF(_POSR)AND(_F_RP_DIR[0]==6)
_F_RP_ACT=_RPT[1] _F_RP_DIR[0]=-1
ENDIF
IF(_POSR==0)AND(_F_RP_DIR[1]==6)
_F_RP_ACT=_RPT[1] _F_RP_DIR[1]=-1
ENDIF
ENDIF
F_SP_IS(0,_STAT,$P_EP[_XX]*_FAK1,$P_EP[_ZZ]*_FAK1,,,_RPT)
IF(_STAT==0)
_TEMP_RPT[0]=_RPT[0] _TEMP_RPT[1]=_RPT[1] _TEMP_RPT[4]=_RPT[4]
_TEMP_RPT[2]=-_RPT[0] _TEMP_RPT[3]=_SC_NO_VAL
F_SP_IS(0,_STAT,$P_EP[_XX]*_FAK1,$P_EP[_ZZ]*_FAK1,,,_TEMP_RPT)
IF(_STAT==0)
_F_RP_DIR[0]=0
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_F_RP_DIR[0]=0, da Wkz. nicht innerhalb RP-Rechteck ("<<$P_EP[_XX]*_FAK1<<","<<$P_EP[_ZZ]*_FAK1<<")")
STOPRE
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Wkz. nicht innerhalb RP-Rechteck, aber innen ("<<$P_EP[_XX]*_FAK1<<","<<$P_EP[_ZZ]*_FAK1<<")")
STOPRE
ENDIF
ENDIF
ENDIF
IF(_STAT==1)AND(_F_RP_DIR[0]==0)AND(($P_SEARCH)OR(($AC_SERUPRO)AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100'))))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_F_RP_DIR[0]=-1, damit Wkz bei SSL zum WWP kann")
STOPRE
ENDIF
_F_RP_DIR[0]=-1
ENDIF
IF(_TCP[2]==1)OR(S_ZIEL==2)
IF($P_TC)AND(($MCS_FUNCTION_MASK_TECH B_AND 'H01')==0)
IF($TC_CARR23[$P_TC]<>"P")
_TCP[0]=_TCP[0]-$PC_TCARR_OFFSET[1,0]
_TCP[1]=_TCP[1]-$PC_TCARR_OFFSET[1,2]
ENDIF
ENDIF
ENDIF
IF($MN_SIM_ENVIRONMENT B_AND 'B100')
IF($P_TOOLNO==0)AND($P_TOOL<>0)
D0
ENDIF
ENDIF
IF($MCS_FUNCTION_MASK_TECH B_AND 'H10')
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N10 F_SP_RP2(_F_RP_DIR,_RPT,_TCP,_NUM,_P,_ERR,_PAR)")
ENDIF
N10 F_SP_RP2(_F_RP_DIR,_RPT,_TCP,_NUM,_P,_ERR,_PAR)
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N15 RETRCALC(_F_RP_DIR,_RPT,_TCP,_NUM,_P,_ERR,_PAR)")
ENDIF
N15 RETRCALC(_F_RP_DIR,_RPT,_TCP,_NUM,_P,_ERR,_PAR)
ENDIF
IF(($MN_SIM_ENVIRONMENT B_AND 'B100')AND(_ERR==1))
;WRTPR("IGNORE(16,0)",1)
IF(_F_TCP[2])
REPEAT _WZW_TC0_A _WZW_TC0_E
ELSE
REPEAT _WZW_WKS_A _WZW_WKS_E
ENDIF
;WRTPR("IGNORE(32,0)",1)
GOTOF _END
ENDIF
IF(_ERR==0)
_NUM=_NUM+S_NUM_ADD
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_NUM=_NUM+"<<S_NUM_ADD<<": Sonderfall")
ENDIF
IF((_POSR==0)AND((_Z_TR<0)OR(_INTERPOL)))
_NUM=_NUM+1
IF(_LOG_ON)
IF(_Z_TR<0)
WRITE(_LOG,_LOG_FILE,"NUM wegen neg. TRANS ("<<_Z_TR<<") um 1 auf "<<_NUM<<" erhoeht!")
ELSE
WRITE(_LOG,_LOG_FILE,"NUM wegen interpol. Anfahren um 1 auf "<<_NUM<<" erhoeht!")
ENDIF
ENDIF
ENDIF
IF(_POSR)AND(_NOGO_TCP)AND(_NUM>0)
_NUM=_NUM-1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_NUM=_NUM-1: Werkzeugwechselpunkt nicht anfahren")
ENDIF
ENDIF
FOR _I=0 TO _NUM-1
IF(_ST_RP==1)AND(_I==_NUM-1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(112)")
ENDIF
CUST_TECHCYC(112)
ENDIF
IF(((_F_TRAANG)OR(_F_Y_AXIS))AND(_I==_NUM-1)AND(((_POSR==1)AND(NOT _NOGO_TCP))OR(((_POSR==0)AND(_INTERPOL)))))OR(_E_SM_PRG)
IF(_POSR)AND(S_ZIEL==0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N20 Punkt "<<_I<<" anfahren: X"<<_P[_I,0]<<" Z"<<_P[_I,1]<<" Y"<<_TCPWKS[1])
STOPRE
ENDIF
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND($P_TC)AND(_PARK==0)
IF($P_TOOL)AND($P_GG[6]==2)
IF($P_ADT[1]>=500)AND($P_ADT[1]<=599)
_TCPWKS[0]=_TCPWKS[0]*(1-2*$P_ACTFRAME[_XX,MI])
IF(_F_TCP[2])
REPEAT _WZW_TC0_A _WZW_TC0_E
ELSE
REPEAT _WZW_WKS_A _WZW_WKS_E
ENDIF
GOTOF _SKIP
ENDIF
ENDIF
ENDIF
SBLON
N20 G0 G90 AX[_XX]=_P[_I,0] AX[_ZZ]=_P[_I,1] AX[_YY]=_TCPWKS[1]
SBLOF
_SKIP:
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N22 Punkt "<<_I<<" anfahren: X"<<_P[_I,0]<<" Z"<<_P[_I,1]<<" Y"<<_Y0)
STOPRE
ENDIF
SBLON
N22 G0 G90 AX[_XX]=_P[_I,0] AX[_ZZ]=_P[_I,1] AX[_YY]=_Y0
SBLOF
ENDIF
ELSE
IF($P_TOOLNO)AND($P_TOOL)
_WTYP=$TC_DP1[$P_TOOLNO,$P_TOOL]
ELSE
_WTYP=0
ENDIF
IF((_WTYP>=500)AND(_WTYP<599))AND((_F_TRAANG)OR(_F_Y_AXIS))AND(_POSR==0)AND((_P[_I,0]==_F_RPT[0]*_FAK2)OR(_P[_I,0]==_F_RPT[2]*_FAK2)OR(_P[_I,1]==_F_RPT[1]*_FAK2)OR(_P[_I,1]==_F_RPT[3]*_FAK2))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N32 Punkt "<<_I<<" anfahren: X"<<_P[_I,0]<<" Z"<<_P[_I,1]<<" Y"<<_Y0)
STOPRE
ENDIF
SBLON
N32 G0 G90 AX[_XX]=_P[_I,0] AX[_ZZ]=_P[_I,1] AX[_YY]=_Y0
SBLOF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N30 Punkt "<<_I<<" anfahren: X"<<_P[_I,0]<<" Z"<<_P[_I,1])
STOPRE
ENDIF
SBLON
N30 G0 G90 AX[_XX]=_P[_I,0] AX[_ZZ]=_P[_I,1]
SBLOF
ENDIF
ENDIF
IF(_LOG_ON)
IF(_F_Y_AXIS)
WRITE(_LOG,_LOG_FILE," (MKS): X"<<$AA_IM[_XX]*_FAK1<<" Z"<<$AA_IM[_ZZ]*_FAK1<<" Y"<<$AA_IM[_YY]*_FAK1)
ELSE
WRITE(_LOG,_LOG_FILE," (MKS): X"<<$AA_IM[_XX]*_FAK1<<" Z"<<$AA_IM[_ZZ]*_FAK1)
ENDIF
STOPRE
ENDIF
ENDFOR
IF(_POSR)AND(_PARK==0)AND(_NOGO_TCP==0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(116)")
ENDIF
CUST_TECHCYC(116)
ENDIF
ELSE
_ERRM=_ERR
IF(_ERR>100)
_ERR=6
ENDIF
IF(_ERR==5)AND(S_ZIEL)
_ERR=13
ENDIF
CASE _ERR OF 1 GOTOF _FEHL1 2 GOTOF _FEHL2 3 GOTOF _FEHL3 4 GOTOF _FEHL4 5 GOTOF _FEHL5 6 GOTOF _FEHL6 7 GOTOF _FEHL7 8 GOTOF _FEHL8 13 GOTOF _FEHL13
GOTOF _FEHL7
ENDIF
_RESTORE:
G[6]=_P6
G[29]=_P29
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_ST_RETRACT)
WRTPR("IGNORE(16,0)",1)
$P_WPFRAME=_WPFRAME
$P_PARTFRAME=_PARTFRAME
WRTPR("IGNORE(32,0)",1)
ENDIF
$P_PFRAME=_PFRAME
IF(_E_ST_PRG)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(200)")
ENDIF
F_SP_TRA(200)
ENDIF
_END:
IF NOT((_POSR==1)AND(_MD9898 B_AND 'H0100'))
_F_RP_DIR[0]=_F_RP_DIR[1]
ENDIF
IF(NOT $P_SEARCH)AND(NOT $AC_SERUPRO)AND(NOT $P_ISTEST)
_F_RP_DIR_S=_F_RP_DIR[0]
ENDIF
_RET:
RET
_CHECK_WZW_A:
_ACTPOS[0]=$P_EP[_XX]*_FAK1
_ACTPOS[1]=$P_EP[_YY]*_FAK1
_ACTPOS[2]=$P_EP[_ZZ]*_FAK1
F_SP_RPF(1,_ACTPOS)
F_SP_IS(1,_STAT,_ACTPOS[0],_ACTPOS[2],_TCPENS[0],_TCPENS[2],_RPT)
_CHECK_WZW_E:
_CHECK_ZP_A:
_ACTPOS[0]=$P_EP[_XX]*_FAK1
_ACTPOS[1]=$P_EP[_YY]*_FAK1
_ACTPOS[2]=$P_EP[_ZZ]*_FAK1
F_SP_RPF(1,_ACTPOS)
F_SP_RPF(1,_ZP)
F_SP_IS(1,_STAT,_ACTPOS[0],_ACTPOS[2],_ZP[0],_ZP[2],_RPT)
_CHECK_ZP_E:
_PARK2WKS_A:
IF(_PARK==1)
$AC_MEAS_VALID=0
$AC_MEAS_TYPE=24
$AC_MEAS_P1_COORD=2
$AC_MEAS_P2_COORD=0
$AA_MEAS_POINT1[_XX]=0
$AA_MEAS_POINT1[_ZZ]=0
$AA_MEAS_POINT1[_YY]=$MCS_SUB_SPINDLE_PARK_POS_Y*_FAK1
_ERR=MEASURE()
IF(_ERR)
_ERR=6
GOTOF _END
ENDIF
_PARK_Y=$AA_MEAS_POINT2[_YY]*_FAK1
ELSE
_PARK_Y=$MCS_SUB_SPINDLE_PARK_POS_Y*_FAK1
ENDIF
_PARK2WKS_E:
S_ZIEL2WKS_A:
IF(_PARK==1)
$AC_MEAS_VALID=0
$AC_MEAS_TYPE=24
$AC_MEAS_P1_COORD=2
$AC_MEAS_P2_COORD=0
$AA_MEAS_POINT1[_XX]=0
$AA_MEAS_POINT1[_ZZ]=0
IF(_Y_EXISTS)
$AA_MEAS_POINT1[_YY]=$MCS_SUB_SPINDLE_PARK_POS_Y*_FAK1
ENDIF
_ERR=MEASURE()
IF(_ERR)
_ERR=6
GOTOF _END
ENDIF
IF(_Y_EXISTS)
_PARK_Y=$AA_MEAS_POINT2[_YY]*_FAK1
ENDIF
ELSE
_PARK_Y=$MCS_SUB_SPINDLE_PARK_POS_Y*_FAK1
ENDIF
S_ZIEL2WKS_E:
_WZW_WKS_A:
IF(_LOG_ON)
IF(_Y_EXISTS)
WRITE(_LOG,_LOG_FILE,"Werkzeugwechselpunkt im aktuellen WKS anfahren: "<<_TCPWKS[0]<<"/"<<_TCPWKS[1]<<"/"<<_TCPWKS[2])
ELSE
WRITE(_LOG,_LOG_FILE,"Werkzeugwechselpunkt im aktuellen WKS anfahren: "<<_TCPWKS[0]<<"/"<<_TCPWKS[2])
ENDIF
ENDIF
SBLON
IF(_Y_EXISTS)
N100 G0 G90 AX[_XX]=_TCPWKS[0] AX[_YY]=_TCPWKS[1] AX[_ZZ]=_TCPWKS[2]
ELSE
N101 G0 G90 AX[_XX]=_TCPWKS[0] AX[_ZZ]=_TCPWKS[2]
ENDIF
SBLOF
_F_RP_DIR[1]=0
_WZW_WKS_E:
_WZW_TC0_A:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Werkzeugwechselpunkt mit TCARR=0 anfahren: "<<_F_TCP[0]<<"/"<<_F_TCP[1]<<":"<<_F_TCP[2]<<"(0=WKS;1=MKS)")
ENDIF
_TCI=$P_TC
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_TCI)
TCARR=0
ENDIF
SBLON
IF(_F_TCP[2])
IF(_Y_EXISTS)
IF(S_WWP_Y==0)
IF($MCS_FUNCTION_MASK_TECH B_AND 'H2000')
IF($MN_G53_TOOLCORR B_AND 'H01')OR($P_TOOL==0)OR($P_TOOLNO==0)
N102 G0 SUPA G90 AX[_XX]=(_F_TCP[0]*_FAK2) AX[_ZZ]=(_F_TCP[1]*_FAK2) AX[_YY]=_Y0
ELSE
N103 G0 SUPA G90 AX[_XX]=(_F_TCP[0]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]*_FAK1) AX[_ZZ]=(_F_TCP[1]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[2])]*_FAK1) AX[_YY]=_Y0
ENDIF
ELSE
IF($MN_G53_TOOLCORR B_AND 'H01')OR($P_TOOL==0)OR($P_TOOLNO==0)
N104 G0 SUPA G90 AX[_XX]=(_F_TCP[0]*_FAK2) AX[_ZZ]=(_F_TCP[1]*_FAK2) AX[_YY]=0
ELSE
N105 G0 SUPA G90 AX[_XX]=(_F_TCP[0]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]*_FAK1) AX[_ZZ]=(_F_TCP[1]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[2])]*_FAK1) AX[_YY]=0
ENDIF
ENDIF
ELSE
IF($MN_G53_TOOLCORR B_AND 'H01')OR($P_TOOL==0)OR($P_TOOLNO==0)
N106 G0 SUPA G90 AX[_XX]=(_F_TCP[0]*_FAK2) AX[_ZZ]=(_F_TCP[1]*_FAK2) AX[_YY]=_Y0+S_WWP_Y
ELSE
N107 G0 SUPA G90 AX[_XX]=(_F_TCP[0]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]*_FAK1) AX[_ZZ]=(_F_TCP[1]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[2])]*_FAK1) AX[_YY]=_Y0+S_WWP_Y
ENDIF
ENDIF
ELSE
IF($MN_G53_TOOLCORR B_AND 'H01')OR($P_TOOL==0)OR($P_TOOLNO==0)
N108 G0 SUPA G90 AX[_XX]=(_F_TCP[0]*_FAK2) AX[_ZZ]=(_F_TCP[1]*_FAK2)
ELSE
N109 G0 SUPA G90 AX[_XX]=(_F_TCP[0]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]*_FAK1) AX[_ZZ]=(_F_TCP[1]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[2])]*_FAK1)
ENDIF
ENDIF
ELSE
IF(_Y_EXISTS)
IF(S_WWP_Y==0)
IF($MCS_FUNCTION_MASK_TECH B_AND 'H2000')
IF($P_TOOLNO)AND($P_TOOL)
N119 G0 G90 AX[_XX]=(_F_TCP[0]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]*_FAK1) AX[_ZZ]=(_F_TCP[1]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[2])]*_FAK1) AX[_YY]=_Y0
ELSE
N120 G0 G90 AX[_XX]=(_F_TCP[0]*_FAK2) AX[_ZZ]=(_F_TCP[1]*_FAK2) AX[_YY]=_Y0
ENDIF
ELSE
IF($P_TOOLNO)AND($P_TOOL)
N121 G0 G90 AX[_XX]=(_F_TCP[0]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]*_FAK1) AX[_ZZ]=(_F_TCP[1]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[2])]*_FAK1) AX[_YY]=0
ELSE
N122 G0 G90 AX[_XX]=(_F_TCP[0]*_FAK2) AX[_ZZ]=(_F_TCP[1]*_FAK2) AX[_YY]=0
ENDIF
ENDIF
ELSE
IF($P_TOOLNO)AND($P_TOOL)
N123 G0 G90 AX[_XX]=(_F_TCP[0]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]*_FAK1) AX[_ZZ]=(_F_TCP[1]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[2])]*_FAK1) AX[_YY]=_Y0+S_WWP_Y
ELSE
N124 G0 G90 AX[_XX]=(_F_TCP[0]*_FAK2) AX[_ZZ]=(_F_TCP[1]*_FAK2) AX[_YY]=_Y0+S_WWP_Y
ENDIF
ENDIF
ELSE
IF($P_TOOLNO)AND($P_TOOL)
N125 G0 G90 AX[_XX]=(_F_TCP[0]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]*_FAK1) AX[_ZZ]=(_F_TCP[1]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[2])]*_FAK1)
ELSE
N126 G0 G90 AX[_XX]=(_F_TCP[0]*_FAK2) AX[_ZZ]=(_F_TCP[1]*_FAK2)
ENDIF
ENDIF
ENDIF
SBLOF
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_TCI)
G4 F0
TCOABS TCARR=_TCI
ENDIF
_F_RP_DIR[1]=0
_WZW_TC0_E:
_FEHL1:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 1: Rueckzugsrichtung unbekannt. Werkzeug manuell zurueckziehen!")
ENDIF
N933801 SETAL(61237)
RET
_FEHL2:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 2: Bearbeitungsrichtung unbekannt!")
ENDIF
N933802 SETAL(61238)
RET
_FEHL3:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 3: Werkzeugwechselpunkt liegt im Rueckzugsbereich!")
ENDIF
N933803 SETAL(61239)
RET
_FEHL4:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 4: Rueckzugsebene fuer diese Bearbeitungsrichtung nicht definiert!")
ENDIF
N933804 SETAL(61241)
RET
_FEHL5:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 5: Werkzeugwechselpunkt korrigieren, Werkzeugspitze im Rueckzugsbereich!")
ENDIF
N933805 SETAL(61243)
RET
_FEHL6:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 6: interner Zyklusfehler bei Frame-Berechnung (MEASURE->"<<_ERRM<<")")
ENDIF
N933806 SETAL(61403)
RET
_FEHL7:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 7: Interner Zyklenfehler ("<<_ERR<<")")
ENDIF
N933807 SETAL(61099,""<<_ERR)
RET
_FEHL8:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 8: Parkposition liegt unterhalb der Rueckzugsebene XRA")
ENDIF
N933808 SETAL(61285)
RET
_FEHL9:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 9: Startpunkt der Bearbeitung liegt ausserhalb der Rueckzugsebenen")
ENDIF
N933809 SETAL(61281)
RET
_FEHL10:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 10: Endpunkt der Bearbeitung liegt ausserhalb der Rueckzugsebenen")
ENDIF
N933810 SETAL(61282)
RET
_FEHL11:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 11: Die aeussere Rueckzugsebene muss groesser als die Innere sein")
ENDIF
N933811 SETAL(61229)
RET
_FEHL12:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 12: Interner Zyklenfehler (_POSR="<<_POSR<<")")
ENDIF
N933812 SETAL(61099,"_POSR="<<_POSR)
RET
_FEHL13:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 13: Zielpunkt liegt im Rueckzugsbereich!")
ENDIF
N933813 SETAL(61855)
RET
_FEHL14:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 14: Kollisionsgefahr beim automatischen Rueckzug. Werkzeug manuell zurueckziehen!")
ENDIF
N933814 SETAL(61870)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SP_RP2_SPF
PROC F_SP_RP2(VAR INT _RP_DIR[],VAR REAL _RPT[],VAR REAL _TCP[],VAR INT _NUM,VAR REAL _P[,2],VAR INT _ERR,INT _PAR) SAVE SBLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.94.00.00.005 ;DATE: 2020-04-01
;ShopTurn: Retract Calculation Cycle
DEF AXIS _XX,_YY,_ZZ
DEF INT _I,_STAT,_STAT2,_SP_IN_RP=0,_TRAANG,_NUM_DEL=0,_INT
DEF REAL _FAK1,_FAK2,_FAK3,S_FAK_PLAN,_AS,_AE,_DX,_DZ
DEF REAL _SP[2],_EP[2],_EPM[2,2]
DEF REAL _E[3,2]
DEF REAL _NO_VAL=1EX300
DEF STRING[40] _STR
DEF INT _TEST_RETRCALC=0
DEF INT _TNR
DEF STRING[40] _PRG_TEST
DEF STRING[200] _TEST_STR
DEF CHAR _AZ=34
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
DIAMCYCOF
_TRAANG=0
IF($ON_TRAFO_TYPE_MASK B_AND 'H08')
IF($MC_TRAFO_MODE_MASK B_AND 'H01')AND($MC_TRAFO_RESET_VALUE>0)
_INT=$MC_TRAFO_RESET_VALUE
_STR="_INT=$MC_TRAFO_TYPE_"<<_INT
EXECSTRING(_STR)
IF(_INT B_AND 'H400')
_TRAANG=2
ENDIF
ENDIF
IF(_TRAANG==0)
IF($P_TRAFO B_AND 'H400')
_TRAANG=1
ENDIF
ENDIF
ENDIF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_FAK3=1
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK3=1/$MN_SCALING_VALUE_INCH
ENDIF
IF($MC_TOOL_PARAMETER_DEF_MASK B_AND 'B1000000')AND($MC_DIAMETER_AX_DEF<>"")
S_FAK_PLAN=1/2
ELSE
S_FAK_PLAN=1
ENDIF
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_SP_RP2_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"Uebergabeparameter:")
WRITE(_LOG,_LOG_FILE,"_RP_DIR[]="<<_RP_DIR[0]<<" / "<<_RP_DIR[1])
WRITE(_LOG,_LOG_FILE,"   _RPT[]="<<_RPT[0]<<" / "<<_RPT[1]<<" / "<<_RPT[2]<<" / "<<_RPT[3]<<" / "<<_RPT[4])
WRITE(_LOG,_LOG_FILE,"   _TCP[]="<<_TCP[0]<<" / "<<_TCP[1]<<" / "<<_TCP[2])
IF($MN_SCALING_SYSTEM_IS_METRIC)
WRITE(_LOG,_LOG_FILE,"Grundsystem: Metric")
ELSE
WRITE(_LOG,_LOG_FILE,"Grundsystem: Inch")
ENDIF
WRITE(_LOG,_LOG_FILE,"G7"<<1-($P_GG[13] MOD 2)<<SUBSTR("0",0,($P_GG[13]-1)/2)<<": "<<_FAK1<<" / "<<_FAK2<<" / "<<_FAK3)
WRITE(_LOG,_LOG_FILE,"Wertefolge: X/Z")
ENDIF
; Testprogramm fuer NCK-Test generieren:
IF(_TEST_RETRCALC)
_TNR=R0
R0=R0+1
_PRG_TEST="/_N_MPF_DIR/_N_TE_"
IF(_TNR<10)
_PRG_TEST=_PRG_TEST<<"0"
ENDIF
IF(_TNR<100)
_PRG_TEST=_PRG_TEST<<"0"
ENDIF
IF(_TNR<1000)
_PRG_TEST=_PRG_TEST<<"0"
ENDIF
IF(_TNR<10000)
_PRG_TEST=_PRG_TEST<<"0"
ENDIF
_PRG_TEST=_PRG_TEST<<_TNR<<"_MPF"
MSG("Testprogramm: "<<_PRG_TEST)
DELETE(_LOG,_PRG_TEST)
IF(NOT $MN_SCALING_SYSTEM_IS_METRIC)
WRITE(_LOG,_PRG_TEST,"; $MN_SCALING_SYSTEM_IS_METRIC=0 ; ACHTUNG: Grundsystem Inch!")
ENDIF
WRITE(_LOG,_PRG_TEST,"DEF INT _RP_DIR[2],_NUM,_ERR,_PAR,_LOG,_I")
WRITE(_LOG,_PRG_TEST,"DEF REAL _RPT[5],_TCP[3],_P[8,2],_PM[8,2]")
WRITE(_LOG,_PRG_TEST,"G18")
WRITE(_LOG,_PRG_TEST,"DIAMCYCOF")
WRITE(_LOG,_PRG_TEST,"G[13]="<<$P_GG[13])
WRITE(_LOG,_PRG_TEST,"_RP_DIR[0]=SET("<<_RP_DIR[0]<<","<<_RP_DIR[1]<<")")
WRITE(_LOG,_PRG_TEST,"_RPT[0]=SET("<<_RPT[0]<<","<<_RPT[1]<<","<<_RPT[2]<<","<<_RPT[3]<<","<<_RPT[4]<<")")
WRITE(_LOG,_PRG_TEST,"_TCP[0]=SET("<<_TCP[0]<<","<<_TCP[1]<<","<<_TCP[2]<<")")
WRITE(_LOG,_PRG_TEST,"_PAR="<<_PAR)
IF(_PAR B_AND 'B0001')AND(_TCP[2])
WRITE(_LOG,_PRG_TEST,"T0")
WRITE(_LOG,_PRG_TEST,"M6")
WRITE(_LOG,_PRG_TEST,"D0")
WRITE(_LOG,_PRG_TEST,"TRANS X="<<($P_EPM[X]-$P_EP[X])*_FAK1<<" Z="<<($P_EPM[Z]-$P_EP[Z])*_FAK1)
ENDIF
WRITE(_LOG,_PRG_TEST,"G0 X"<<$P_EP[X]*_FAK1<<" Z"<<$P_EP[Z]*_FAK1)
WRITE(_LOG,_PRG_TEST,"IF(R0==0)")
WRITE(_LOG,_PRG_TEST,"  RETRCALC(_RP_DIR,_RPT,_TCP,_NUM,_P,_ERR,_PAR)")
WRITE(_LOG,_PRG_TEST,"ELSE")
WRITE(_LOG,_PRG_TEST,"  F_SP_RP2(_RP_DIR,_RPT,_TCP,_NUM,_P,_ERR,_PAR)")
WRITE(_LOG,_PRG_TEST,"ENDIF")
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Zielpunkt: "<<_TCP[0]<<"/"<<_TCP[1]<<":"<<_TCP[2]<<"(0=WKS;1=MKS)")
WRITE(_LOG,_LOG_FILE,"RP: "<<_RPT[0]*_FAK2<<"/"<<_RPT[1]*_FAK2<<"/"<<_RPT[2]*_FAK2<<"/"<<_RPT[3]*_FAK2<<"/XR:"<<_RPT[4]*_FAK2)
WRITE(_LOG,_LOG_FILE,"Letzte/neue Richtung: "<<_RP_DIR[0]<<"/"<<_RP_DIR[1])
IF((_PAR B_AND 'B0001')==0)
WRITE(_LOG,_LOG_FILE,"Zur Bearbeitung")
ENDIF
IF((_PAR B_AND 'B1000')<>0)
WRITE(_LOG,_LOG_FILE,"Zur Parkposition")
ENDIF
IF(_PAR B_AND 'B0100')
WRITE(_LOG,_LOG_FILE,"Wegfahren zum Werkzeugwechselpunkt abschalten")
ENDIF
ENDIF
IF($P_GG[6]==1)
_ZZ=$P_AXN3
_XX=$P_AXN1
IF(_TRAANG)
_YY=$P_AXN2
ENDIF
ELSE
IF($P_GG[6]==2)
_ZZ=$P_AXN1
_XX=$P_AXN2
IF(_TRAANG)
_YY=$P_AXN3
ENDIF
ELSE
_ZZ=$P_AXN2
_XX=$P_AXN3
IF(_TRAANG)
_YY=$P_AXN1
ENDIF
ENDIF
ENDIF
_NUM=0
_ERR=0
_SP[0]=$P_EP[_XX]*_FAK1
_SP[1]=$P_EP[_ZZ]*_FAK1
IF((_PAR B_AND 'B0001')==0)
_EP[0]=_TCP[0]
_EP[1]=_TCP[1]
IF(_RP_DIR[1]==1)
IF(_EP[0]<=0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Endpunkt in X korrigiert ("<<_EP[0]<<"->0.001*_FAK3)")
ENDIF
_EP[0]=0.001*_FAK3
ENDIF
ENDIF
ELSE
IF(_LOG_ON)AND(_RP_DIR[1])
WRITE(_LOG,_LOG_FILE,"Werkzeugwechselpunkt hat keine Bearbeitungsrichtung -> neue Richtung: "<<_RP_DIR[1])
ENDIF
_RP_DIR[1]=0
IF(_TCP[2]==0)
_EP[0]=_TCP[0]*_FAK2*(1-2*$P_ACTFRAME[_XX,MI])
_EP[1]=_TCP[1]*_FAK2
IF($P_TOOLNO)AND($P_TOOL)AND((_PAR B_AND 'B10000')==0)
_EP[0]=_EP[0]-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]*_FAK1*(1-2*$P_ACTFRAME[_XX,MI])
_EP[1]=_EP[1]-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[2])]*_FAK1*(1-2*$P_ACTFRAME[_ZZ,MI])
ENDIF
ELSE
$AC_MEAS_VALID=0
$AC_MEAS_TYPE=24
$AC_MEAS_P1_COORD=2
$AC_MEAS_P2_COORD=0
IF($P_TOOLNO)AND($P_TOOL)AND((_PAR B_AND 'B10000')==0)
$AA_MEAS_POINT1[_XX]=(_TCP[0]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]*_FAK1)/_FAK1
$AA_MEAS_POINT1[_ZZ]=(_TCP[1]*_FAK2-$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[2])]*_FAK1)/_FAK1
ELSE
$AA_MEAS_POINT1[_XX]=(_TCP[0]*_FAK2)/_FAK1
$AA_MEAS_POINT1[_ZZ]=(_TCP[1]*_FAK2)/_FAK1
ENDIF
IF(_TRAANG)
$AA_MEAS_POINT1[_YY]=0
ENDIF
_ERR=MEASURE()
IF(_ERR)
_ERR=_ERR+100
GOTOF _END
ENDIF
_EP[0]=$AA_MEAS_POINT2[_XX]*_FAK1*S_FAK_PLAN
_EP[1]=$AA_MEAS_POINT2[_ZZ]*_FAK1
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Zum Werkzeugwechsel: "<<_EP[0]<<"/"<<_EP[1]<<" (WKS)")
ENDIF
IF((_PAR B_AND 'B1000')<>0)
IF(_EP[0]<_RPT[0]*_FAK2)
_ERR=8
GOTOF _END
ENDIF
ELSE
IF(NOT(_PAR B_AND 'H20'))OR($P_TOOL)
F_SP_IS(0,_STAT,_EP[0],_EP[1],,,_RPT)
IF(_STAT)
_ERR=5
GOTOF _END
ENDIF
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"SP="<<_SP[0]<<"/"<<_SP[1]<<" EP="<<_EP[0]<<"/"<<_EP[1])
ENDIF
IF((_PAR B_AND 'B0001')==1)
ELSE
IF((_PAR B_AND 'B1000')<>0)
IF(_EP[0]<_RPT[0]*_FAK2)
_ERR=8
GOTOF _END
ENDIF
ELSE
IF(_RP_DIR[1]==0)
_ERR=2
GOTOF _END
ENDIF
ENDIF
ENDIF
IF(_RP_DIR[0]==99)
_RP_DIR[0]=0
IF(_PAR B_AND 'B0010')
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Bei Simulation direkt zum Endpunkt: "<<_EP[0]<<"/"<<_EP[1])
ENDIF
_P[_NUM,0]=_EP[0]
_P[_NUM,1]=_EP[1]
_NUM=1
GOTOF _END
ENDIF
ENDIF
IF(_PAR B_AND 'H20')AND($P_TOOL==0)
IF(_PAR B_AND 'B0001')
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Ohne Schneide direkt zum Werkzeugwechselpunkt: "<<_EP[0]<<"/"<<_EP[1])
ENDIF
_P[_NUM,0]=_EP[0]
_P[_NUM,1]=_EP[1]
_NUM=1
GOTOF _END
ENDIF
ENDIF
IF(_RP_DIR[0]==0)
F_SP_IS(0,_STAT,_SP[0],_SP[1],,,_RPT)
IF(_STAT)
_ERR=1
GOTOF _END
ENDIF
;
IF(_LOG_ON)AND(_NUM>0)
WRITE(_LOG,_LOG_FILE,"Rueckzug auf Punkt "<<_P[_NUM-1,0]<<"/"<<_P[_NUM-1,1])
ENDIF
ENDIF
IF(_RP_DIR[0]==2)
F_SP_IS(0,_STAT,_SP[0],_SP[1],,,_RPT)
IF(_STAT)AND(_RPT[2]==_NO_VAL)
_ERR=1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Innere Rueckzugsebene nicht angegeben!")
ENDIF
GOTOF _END
ENDIF
ENDIF
IF(_RP_DIR[0]==1)
F_SP_IS(0,_STAT,_SP[0],_SP[1],,,_RPT)
IF(_STAT)AND(_RPT[3]==_NO_VAL)
_ERR=1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Hintere Rueckzugsebene nicht angegeben!")
ENDIF
GOTOF _END
ENDIF
ENDIF
IF(_RP_DIR[0]==-1)AND(_SP[1]<_RPT[1]*_FAK2)
_SP_IN_RP=1
_P[_NUM,0]=_SP[0]
_P[_NUM,1]=_RPT[1]*_FAK2
_SP[1]=_P[_NUM,1]
_NUM=_NUM+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Nach Vorderseitenbearbeitung auf RP herausziehen: "<<_P[_NUM-1,0]<<"/"<<_P[_NUM-1,1])
ENDIF
ENDIF
IF(_RP_DIR[0]==1)AND(_RPT[3]<>_NO_VAL)AND(_SP[1]>_RPT[3]*_FAK2)
_SP_IN_RP=1
_P[_NUM,0]=_SP[0]
_P[_NUM,1]=_RPT[3]*_FAK2
_SP[1]=_P[_NUM,1]
_NUM=_NUM+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Nach Rueckseitenbearbeitung auf RP herausziehen: "<<_P[_NUM-1,0]<<"/"<<_P[_NUM-1,1])
ENDIF
ENDIF
IF(_RP_DIR[0]==-2)AND(_SP[0]<_RPT[0]*_FAK2)
_SP_IN_RP=1
_P[_NUM,0]=_RPT[0]*_FAK2
_P[_NUM,1]=_SP[1]
_SP[0]=_P[_NUM,0]
_NUM=_NUM+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Nach Aussenbearbeitung auf RP herausziehen: "<<_P[_NUM-1,0]<<"/"<<_P[_NUM-1,1])
ENDIF
ENDIF
IF(_RP_DIR[0]==2)AND(_RPT[2]<>_NO_VAL)AND(_SP[0]>_RPT[2]*_FAK2)
_SP_IN_RP=1
_P[_NUM,0]=_RPT[2]*_FAK2
_P[_NUM,1]=_SP[1]
_SP[0]=_P[_NUM,0]
_NUM=_NUM+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Nach Innenbearbeitung auf RP herausziehen: "<<_P[_NUM-1,0]<<"/"<<_P[_NUM-1,1])
ENDIF
ENDIF
IF(_RP_DIR[0]==2)AND(_RP_DIR[1]<>2)AND(_RPT[2]<>_NO_VAL)AND(_SP[0]<=_RPT[2]*_FAK2)AND(_SP[1]<_RPT[1]*_FAK2)
_SP_IN_RP=_SP_IN_RP+1
_P[_NUM,0]=_SP[0]
_P[_NUM,1]=_RPT[1]*_FAK2
_SP[1]=_P[_NUM,1]
_NUM=_NUM+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Nach Innenbearbeitung seitlich aus dem Teil herausfahren: "<<_P[_NUM-1,0]<<"/"<<_P[_NUM-1,1])
ENDIF
ENDIF
IF(_RPT[4]<>_NO_VAL)AND(_SP[0]<_RPT[4]*_FAK2)AND(_SP[1]>_RPT[1]*_FAK2)
_SP_IN_RP=_SP_IN_RP+1
_P[_NUM,0]=_RPT[4]*_FAK2
_P[_NUM,1]=_SP[1]
_SP[0]=_P[_NUM,0]
_NUM=_NUM+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Senkrecht aus Reitstock herausfahren: "<<_P[_NUM-1,0]<<"/"<<_P[_NUM-1,1])
ENDIF
ENDIF
IF(_RP_DIR[1]==1)AND(_RPT[3]==_NO_VAL)
_ERR=4
GOTOF _END
ENDIF
IF(_RP_DIR[1]==2)AND(_RPT[2]==_NO_VAL)
_ERR=4
GOTOF _END
ENDIF
_EPM[0,0]=_NO_VAL
_EPM[1,0]=_NO_VAL
IF(_RP_DIR[1]==-1)AND(_EP[1]<_RPT[1]*_FAK2)
_EPM[0,0]=_EP[0]
_EPM[0,1]=_EP[1]
_EP[1]=_RPT[1]*_FAK2
_NUM_DEL=_NUM_DEL+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Vorderseitenbearbeitung: Endpunkt gemerkt und verschoben: "<<_EP[0]<<"/"<<_EP[1])
ENDIF
ENDIF
IF(_RP_DIR[1]==1)AND(_RPT[3]<>_NO_VAL)AND(_EP[1]>_RPT[3]*_FAK2)
_EPM[0,0]=_EP[0]
_EPM[0,1]=_EP[1]
_EP[1]=_RPT[3]*_FAK2
_NUM_DEL=_NUM_DEL+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Rueckseitenbearbeitung: Endpunkt gemerkt und verschoben: "<<_EP[0]<<"/"<<_EP[1])
ENDIF
ENDIF
IF(_RP_DIR[1]==-2)AND(_EP[0]<_RPT[0]*_FAK2)
_EPM[0,0]=_EP[0]
_EPM[0,1]=_EP[1]
_EP[0]=_RPT[0]*_FAK2
_NUM_DEL=_NUM_DEL+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Aussenbearbeitung: Endpunkt gemerkt und verschoben: "<<_EP[0]<<"/"<<_EP[1])
ENDIF
ENDIF
IF(_RP_DIR[1]==2)AND(_RPT[2]<>_NO_VAL)AND(_EP[0]>_RPT[2]*_FAK2)
_EPM[0,0]=_EP[0]
_EPM[0,1]=_EP[1]
_EP[0]=_RPT[2]*_FAK2
_NUM_DEL=_NUM_DEL+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Innenbearbeitung: Endpunkt gemerkt und verschoben: "<<_EP[0]<<"/"<<_EP[1])
ENDIF
ENDIF
IF(_RP_DIR[0]<>2)AND(_RP_DIR[1]==2)AND(_EP[1]<=_RPT[1]*_FAK2)AND(_EP[0]<>_SP[0])
_EPM[1,0]=_EP[0]
_EPM[1,1]=_EP[1]
_EP[1]=_RPT[1]*_FAK2
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Innenbearbeitung: Endpunkt gemerkt und nach ZRA verschoben: "<<_EP[0]<<"/"<<_EP[1])
ENDIF
ENDIF
IF(_RPT[4]<>_NO_VAL)AND(_EP[0]<_RPT[4]*_FAK2)AND(_EP[1]>_RPT[1]*_FAK2)
_EPM[1,0]=_EP[0]
_EPM[1,1]=_EP[1]
_EP[0]=_RPT[4]*_FAK2
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Endpunkt im Reitstock: Endpunkt gemerkt und nach ZRA verschoben: "<<_EP[0]<<"/"<<_EP[1])
ENDIF
ENDIF
F_SP_IS(1,_STAT,_SP[0],_SP[1],_EP[0],_EP[1],_RPT)
IF(_STAT==0)AND(_RPT[4]<>_NO_VAL)
F_SP_IS(2,_STAT2,_SP[0],_SP[1],_EP[0],_EP[1],_RPT)
IF(_LOG_ON)AND(_STAT2)
WRITE(_LOG,_LOG_FILE,"Kollision mit Reitstock!")
ENDIF
ENDIF
IF(_STAT)OR(_STAT2)
IF(_RPT[2]==_NO_VAL)OR(_RPT[3]==_NO_VAL)
_DX=_SP[0]-_RPT[0]*_FAK2
_DZ=_SP[1]-_RPT[1]*_FAK2
IF(ABS(_DX)<0.001*_FAK3)
_DX=0
ENDIF
IF(_DX==0)AND(_DZ==0)
_DZ=_DZ+0.001*_FAK3
ENDIF
_AS=ATAN2(_DX,_DZ)
_DX=_EP[0]-_RPT[0]*_FAK2
_DZ=_EP[1]-_RPT[1]*_FAK2
IF(ABS(_DX)<0.001*_FAK3)
_DX=0
ENDIF
IF(_DX==0)AND(_DZ==0)
_DZ=_DZ+0.001*_FAK3
ENDIF
_AE=ATAN2(_DX,_DZ)
ELSE
_DX=_SP[0]-_RPT[2]*_FAK2
_DZ=_SP[1]-_RPT[3]*_FAK2
IF(ABS(_DX)<0.001*_FAK3)
_DX=0
ENDIF
IF(_DX==0)AND(_DZ==0)
_DZ=_DZ-0.001*_FAK3
ENDIF
_AS=ATAN2(_DX,_DZ)
_DX=_EP[0]-_RPT[2]*_FAK2
_DZ=_EP[1]-_RPT[3]*_FAK2
IF(ABS(_DX)<0.001*_FAK3)
_DX=0
ENDIF
IF(_DX==0)AND(_DZ==0)
_DZ=_DZ-0.001*_FAK3
ENDIF
_AE=ATAN2(_DX,_DZ)
IF(_AS==180)
_AS=-180
ENDIF
IF(_AE==180)
_AE=-180
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Winkel: _AS="<<_AS<<" _AE="<<_AE)
ENDIF
IF(_AE>_AS)
_E[1,0]=_RPT[0]*_FAK2 _E[1,1]=_RPT[1]*_FAK2
_E[0,1]=_RPT[1]*_FAK2
IF(_RPT[2]==_NO_VAL)
_E[0,0]=_E[1,0]
ELSE
_E[0,0]=_RPT[2]*_FAK2
ENDIF
_E[2,0]=_RPT[0]*_FAK2
IF(_RPT[3]==_NO_VAL)
_E[2,1]=_E[1,1]
ELSE
_E[2,1]=_RPT[3]*_FAK2
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Linksherum")
ENDIF
ELSE
_E[1,0]=_RPT[0]*_FAK2 _E[1,1]=_RPT[1]*_FAK2
_E[0,0]=_RPT[0]*_FAK2
IF(_RPT[3]==_NO_VAL)
_E[0,1]=_E[1,1]
ELSE
_E[0,1]=_RPT[3]*_FAK2
ENDIF
_E[2,1]=_RPT[1]*_FAK2
IF(_RPT[2]==_NO_VAL)
_E[2,0]=_E[1,0]
ELSE
_E[2,0]=_RPT[2]*_FAK2
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Rechtsherum")
ENDIF
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Direkt zum Endpunkt!")
ENDIF
ENDIF
_I=0
WHILE((_STAT)OR(_STAT2))AND(_I<3)
IF(_NUM>7)
_ERR=7
GOTOF _END
ENDIF
F_SP_IS(1,_STAT,_SP[0],_SP[1],_EP[0],_EP[1],_RPT)
IF(_STAT)
_I=0
REPEAT
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"SP="<<_SP[0]<<"/"<<_SP[1]<<" Ecke="<<_E[_I,0]<<"/"<<_E[_I,1]<<" _I="<<_I<<" _STAT="<<_STAT)
ENDIF
F_SP_IS(1,_STAT,_SP[0],_SP[1],_E[_I,0],_E[_I,1],_RPT)
_I=_I+1
UNTIL(NOT _STAT)OR(_I>2)
_STAT=0
WHILE(NOT _STAT)AND(_I<=2)
F_SP_IS(1,_STAT,_SP[0],_SP[1],_E[_I,0],_E[_I,1],_RPT)
IF(NOT _STAT)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Naechster Punkt geht auch: _I="<<_I<<" "<<_E[_I,0]<<"/"<<_E[_I,1])
ENDIF
_I=_I+1
ENDIF
ENDWHILE
_P[_NUM,0]=_E[_I-1,0]
_P[_NUM,1]=_E[_I-1,1]
_STAT=1
ELSE
_P[_NUM,0]=_EP[0]
_P[_NUM,1]=_EP[1]
ENDIF
IF(_RPT[4]<>_NO_VAL)
F_SP_IS(2,_STAT2,_SP[0],_SP[1],_P[_NUM,0],_P[_NUM,1],_RPT)
IF(_LOG_ON)AND(_STAT2)
WRITE(_LOG,_LOG_FILE,"Kollision mit Reitstock!")
ENDIF
ENDIF
IF(_STAT2)
_P[_NUM,0]=_RPT[4]*_FAK2
_P[_NUM,1]=_RPT[1]*_FAK2
_NUM=_NUM+1
_I=0
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Kollision mit Reitstock -> Ecke anfahren: "<<_P[_NUM-1,0]<<"/"<<_P[_NUM-1,1])
ENDIF
ELSE
IF(_STAT)
_NUM=_NUM+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Zwischenpunkt eingetragen: "<<_P[_NUM-1,0]<<"/"<<_P[_NUM-1,1])
ENDIF
ENDIF
ENDIF
IF(_STAT)OR(_STAT2)
_SP[0]=_P[_NUM-1,0]
_SP[1]=_P[_NUM-1,1]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Startpunkt verschoben: "<<_SP[0]<<"/"<<_SP[1])
ENDIF
ENDIF
ENDWHILE
IF(_EPM[1,0]<>_NO_VAL)
_P[_NUM,0]=_EP[0]
_P[_NUM,1]=_EP[1]
_NUM=_NUM+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Gemerkten Eckpunkt 2 anfahren: "<<_P[_NUM-1,0]<<"/"<<_P[_NUM-1,1])
ENDIF
_EP[0]=_EPM[1,0]
_EP[1]=_EPM[1,1]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Gemerkten Endpunkt 2 zurueckgeschrieben: "<<_EP[0]<<"/"<<_EP[1])
ENDIF
ENDIF
IF(_EPM[0,0]<>_NO_VAL)
_P[_NUM,0]=_EP[0]
_P[_NUM,1]=_EP[1]
_NUM=_NUM+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Gemerkten Endpunkt 1 anfahren: "<<_P[_NUM-1,0]<<"/"<<_P[_NUM-1,1])
ENDIF
_EP[0]=_EPM[0,0]
_EP[1]=_EPM[0,1]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Gemerkten Endpunkt 1 zurueckgeschrieben: "<<_EP[0]<<"/"<<_EP[1])
ENDIF
ENDIF
_P[_NUM,0]=_EP[0]
_P[_NUM,1]=_EP[1]
_NUM=_NUM+1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Endpunkt anfahren: "<<_EP[0]<<"/"<<_EP[1])
ENDIF
IF((_PAR B_AND 'B0001')==1)
IF(_PAR B_AND 'B0100')
_NUM=_SP_IN_RP
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Punkte entfernt: nur aus RP herausfahren")
ENDIF
ENDIF
ELSE
_NUM=_NUM-(_NUM_DEL+1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,""<<_NUM_DEL+1<<" Punkt(e) am Ende entfernt!")
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Anzahl Punkte: "<<_NUM)
FOR _I=0 TO _NUM-1
WRITE(_LOG,_LOG_FILE,"Punkt "<<_I<<": "<<_P[_I,0]<<"/"<<_P[_I,1])
ENDFOR
ENDIF
_END:
IF(_LOG_ON)AND(_ERR)
WRITE(_LOG,_LOG_FILE,"Fehler: "<<_ERR)
ENDIF
IF(_TEST_RETRCALC)
IF(_ERR==0)
WRITE(_LOG,_PRG_TEST,"IF(_NUM<>"<<_NUM<<")")
_TEST_STR="  WRITE(_LOG,"<<_AZ<<"/_N_MPF_DIR/_N_TE_ERR_MPF"<<_AZ<<","<<_AZ<<_TNR<<": _NUM falsch ("<<_AZ<<"<<_NUM<<"<<_AZ<<" statt "<<_NUM<<")"<<_AZ<<")"
WRITE(_LOG,_PRG_TEST,_TEST_STR)
WRITE(_LOG,_PRG_TEST,"ENDIF")
FOR _I=0 TO _NUM-1
WRITE(_LOG,_PRG_TEST,"_PM["<<_I<<",0]="<<_P[_I,0])
WRITE(_LOG,_PRG_TEST,"_PM["<<_I<<",1]="<<_P[_I,1])
ENDFOR
WRITE(_LOG,_PRG_TEST,"FOR _I=0 TO "<<_NUM-1)
WRITE(_LOG,_PRG_TEST,"  IF(_P[_I,0]<>_PM[_I,0])")
_TEST_STR="    WRITE(_LOG,"<<_AZ<<"/_N_MPF_DIR/_N_TE_ERR_MPF"<<_AZ<<","<<_AZ<<_TNR<<": _P["<<_AZ<<"<<_I<<"<<_AZ<<",0] falsch ("<<_AZ<<"<<_P[_I,0]<<"<<_AZ<<" statt "<<_AZ<<"<<_PM[_I,0]<<"<<_AZ<<")"<<_AZ<<")"
WRITE(_LOG,_PRG_TEST,_TEST_STR)
WRITE(_LOG,_PRG_TEST,"  ENDIF")
WRITE(_LOG,_PRG_TEST,"  IF(_P[_I,1]<>_PM[_I,1])")
_TEST_STR="    WRITE(_LOG,"<<_AZ<<"/_N_MPF_DIR/_N_TE_ERR_MPF"<<_AZ<<","<<_AZ<<_TNR<<": _P["<<_AZ<<"<<_I<<"<<_AZ<<",1] falsch ("<<_AZ<<"<<_P[_I,1]<<"<<_AZ<<" statt "<<_AZ<<"<<_PM[_I,1]<<"<<_AZ<<")"<<_AZ<<")"
WRITE(_LOG,_PRG_TEST,_TEST_STR)
WRITE(_LOG,_PRG_TEST,"  ENDIF")
WRITE(_LOG,_PRG_TEST,"ENDFOR")
ENDIF
WRITE(_LOG,_PRG_TEST,"IF(_ERR<>"<<_ERR<<")")
_TEST_STR="  WRITE(_LOG,"<<_AZ<<"/_N_MPF_DIR/_N_TE_ERR_MPF"<<_AZ<<","<<_AZ<<_TNR<<": _ERR falsch ("<<_AZ<<"<<_ERR<<"<<_AZ<<" statt "<<_ERR<<")"<<_AZ<<")"
WRITE(_LOG,_PRG_TEST,_TEST_STR)
WRITE(_LOG,_PRG_TEST,"ENDIF")
WRITE(_LOG,_PRG_TEST,"M30")
ENDIF
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SP_RPB_SPF
PROC F_SP_RPB(INT _MODE,REAL _RP,REAL _XE,REAL _YE,REAL _ZE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.07.70.00 ;DATE: 2016-12-05
;ShopTurn: Retract Cycle - B
DEF AXIS _XX,_YY,_ZZ
DEF INT _NUM,_I,_TESTLIM,_STAT,_STATUS[7],_INC,_AXT[3],_MOD10,_RETVAL,_P6,_LOG_ON,_LOG
DEF REAL _P[7,3],_STARTPOS[3],_MOVDIST[3],_DLIMIT[5],_MAXDIST[3],_START[3],_NORMAL[3],_NORM,_LAMBDA,_LAMX,_LAMY,_LAMZ,_FAK1,S_FAK_PLAN
DEF STRING[4] _STR
DEF STRING[35] _LOG_FILE
_NUM=-1
_STAT=0
_TESTLIM=3
_INC=$MN_INT_INCR_PER_MM
_DLIMIT[0]=0 _DLIMIT[1]=0 _DLIMIT[2]=0
_MOD10=TRUNC(_MODE/10) MOD 10
_MODE=_MODE MOD 10
_P6=$P_GG[6]
G17
IF($P_TC)
IF($TC_CARR23[$P_TC]=="P")
_TESTLIM=0
ENDIF
ELSE
IF($P_TRAFO==0)OR($P_TRAFO>=256)
_TESTLIM=0
ELSE
IF(NOT($P_TRAFO B_AND 'H10'))
_TESTLIM=0
ENDIF
ENDIF
ENDIF
IF($MCS_FUNCTION_MASK_TECH B_AND 'H02')OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_TESTLIM=0
ENDIF
_XX=$P_AXN1 _YY=$P_AXN2 _ZZ=$P_AXN3
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
IF($MC_TOOL_PARAMETER_DEF_MASK B_AND 'B1000000')AND($MC_DIAMETER_AX_DEF<>"")
S_FAK_PLAN=1/2
ELSE
S_FAK_PLAN=1
ENDIF
IF(_TESTLIM==0)
_FEHL0:
IF(_MODE==0)OR(_MODE==2)
IF(_RP>$P_EP[_ZZ]*_FAK1)
N10 SBLON
N11 G0 G90 G40 AX[_ZZ]=_RP
N12 SBLOF
ENDIF
ENDIF
IF(_MODE==1)OR(_MODE==2)
N20 SBLON
N21 G0 G90 G40 AX[_XX]=_XE AX[_YY]=_YE
N22 SBLOF
ENDIF
IF(_MODE==2)
N30 SBLON
N31 G0 G90 G40 AX[_ZZ]=_ZE
N32 SBLOF
ENDIF
GOTOF _RET
ENDIF
IF(_MODE==0)AND(_MOD10==2)
REPEAT _MKS2WKS_A _MKS2WKS_E
ENDIF
_START[0]=$P_EP[_XX]*_FAK1 _START[1]=$P_EP[_YY]*_FAK1 _START[2]=$P_EP[_ZZ]*_FAK1
_STARTPOS[0]=_START[0] _STARTPOS[1]=_START[1] _STARTPOS[2]=_START[2]
_NORMAL[0]=-(_YE-_START[1]) _NORMAL[1]=_XE-_START[0] _NORMAL[2]=0
_NORM=SQRT(POT(_NORMAL[0])+POT(_NORMAL[1])+POT(_NORMAL[2]))
IF(_NORM)
_NORMAL[0]=_NORMAL[0]/_NORM _NORMAL[1]=_NORMAL[1]/_NORM _NORMAL[2]=_NORMAL[2]/_NORM
ENDIF
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_SP_RPB_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
_STR=" +*#"
_AXT[0]=$MC_AXCONF_GEOAX_ASSIGN_TAB[0]
_AXT[1]=$MC_AXCONF_GEOAX_ASSIGN_TAB[1]
_AXT[2]=$MC_AXCONF_GEOAX_ASSIGN_TAB[2]
IF(_AXT[1]==0)
_AXT[1]=2
ENDIF
DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Logfile F_SP_RPB:")
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"ST:       "<<_E_JS_PRG)
WRITE(_LOG,_LOG_FILE,"NCK:      "<<$AN_NCK_VERSION)
IF($P_TC)
WRITE(_LOG,_LOG_FILE,"TCARR:    "<<$TC_CARR34[$P_TC])
ENDIF
WRITE(_LOG,_LOG_FILE,"EBENE:    G"<<$P_GG[6]+16)
IF($MN_SCALING_SYSTEM_IS_METRIC)
WRITE(_LOG,_LOG_FILE,"SYSTEM:   METRIC")
ELSE
WRITE(_LOG,_LOG_FILE,"SYSTEM:   INCH")
ENDIF
IF($P_GG[13]==2)OR($P_GG[13]==4)
WRITE(_LOG,_LOG_FILE,"PROGRAMM: METRIC")
ELSE
WRITE(_LOG,_LOG_FILE,"PROGRAMM: INCH")
ENDIF
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"MODE:     "<<_MOD10<<_MODE)
WRITE(_LOG,_LOG_FILE,"RP:       "<<_RP)
WRITE(_LOG,_LOG_FILE,"START:    "<<ROUND(_INC*_START[0])/_INC<<"  "<<ROUND(_INC*_START[1])/_INC<<"  "<<ROUND(_INC*_START[2])/_INC)
WRITE(_LOG,_LOG_FILE,"ZIEL:     "<<_XE<<"  "<<_YE<<"  "<<_ZE)
WRITE(_LOG,_LOG_FILE,"NORMALE:  "<<ROUND(_INC*_NORMAL[0])/_INC<<"  "<<ROUND(_INC*_NORMAL[1])/_INC<<"  "<<ROUND(_INC*_NORMAL[2])/_INC)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Aktueller Gesamtframe:")
WRITE(_LOG,_LOG_FILE,"TRANS:    "<<$P_ACTFRAME[_XX,TR]<<"  "<<$P_ACTFRAME[_YY,TR]<<"  "<<$P_ACTFRAME[_ZZ,TR])
WRITE(_LOG,_LOG_FILE,"ROT:      "<<$P_ACTFRAME[_XX,RT]<<"  "<<$P_ACTFRAME[_YY,RT]<<"  "<<$P_ACTFRAME[_ZZ,RT])
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Softwareendschalter:")
WRITE(_LOG,_LOG_FILE,"Achse X:  "<<ROUND(_INC*$MA_POS_LIMIT_MINUS[AXNAME("AX"<<_AXT[0])])/_INC<<"  "<<ROUND(_INC*$MA_POS_LIMIT_PLUS[AXNAME("AX"<<_AXT[0])])/_INC)
WRITE(_LOG,_LOG_FILE,"Achse Y:  "<<ROUND(_INC*$MA_POS_LIMIT_MINUS[AXNAME("AX"<<_AXT[1])])/_INC<<"  "<<ROUND(_INC*$MA_POS_LIMIT_PLUS[AXNAME("AX"<<_AXT[1])])/_INC)
WRITE(_LOG,_LOG_FILE,"Achse Z:  "<<ROUND(_INC*$MA_POS_LIMIT_MINUS[AXNAME("AX"<<_AXT[2])])/_INC<<"  "<<ROUND(_INC*$MA_POS_LIMIT_PLUS[AXNAME("AX"<<_AXT[2])])/_INC)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Arbeitsfeldbegrenzung:")
WRITE(_LOG,_LOG_FILE,"Achse X:  "<<ROUND(_INC*$SA_WORKAREA_LIMIT_MINUS[AXNAME("AX"<<_AXT[0])])/_INC<<"  "<<ROUND(_INC*$SA_WORKAREA_LIMIT_PLUS[AXNAME("AX"<<_AXT[0])])/_INC)
WRITE(_LOG,_LOG_FILE,"Achse Y:  "<<ROUND(_INC*$SA_WORKAREA_LIMIT_MINUS[AXNAME("AX"<<_AXT[1])])/_INC<<"  "<<ROUND(_INC*$SA_WORKAREA_LIMIT_PLUS[AXNAME("AX"<<_AXT[1])])/_INC)
WRITE(_LOG,_LOG_FILE,"Achse Z:  "<<ROUND(_INC*$SA_WORKAREA_LIMIT_MINUS[AXNAME("AX"<<_AXT[2])])/_INC<<"  "<<ROUND(_INC*$SA_WORKAREA_LIMIT_PLUS[AXNAME("AX"<<_AXT[2])])/_INC)
ENDIF
IF(_MODE>0)
_MOVDIST[0]=_XE-_STARTPOS[0] _MOVDIST[1]=_YE-_STARTPOS[1] _MOVDIST[2]=_ZE-_STARTPOS[2]
_STAT=CALCPOSI(_STARTPOS,_MOVDIST,_DLIMIT,_MAXDIST,0,_TESTLIM)
IF((TRUNC(_STAT/10) MOD 10)==1) GOTOB _FEHL0
IF((TRUNC(_STAT/10) MOD 10)==2) GOTOF _FEHL2
ENDIF
_DLIMIT[0]=10/_INC _DLIMIT[1]=10/_INC _DLIMIT[2]=10/_INC
IF(ROUND(_INC*ABS(_XE-_START[0]))/_INC)OR(ROUND(_INC*ABS(_YE-_START[1]))/_INC)
_TESTLIM=_TESTLIM+16
ENDIF
IF(_MODE==0)AND(_MOD10==2)
_MOD10=0
ENDIF
IF(_MODE==1)
_RP=_ZE
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"DLIMIT:   "<<_DLIMIT[0])
WRITE(_LOG,_LOG_FILE,"TESTLIM:  "<<_TESTLIM)
ENDIF
IF(_MODE==0)OR(_MODE==2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Rueckzug auf RP:")
ENDIF
_MOVDIST[0]=0 _MOVDIST[1]=0 _MOVDIST[2]=_RP-_STARTPOS[2]
_MAXDIST[0]=_XE-_START[0] _MAXDIST[1]=_YE-_START[1] _MAXDIST[2]=0
REPEAT _CALCPOSI_A _CALCPOSI_E
IF(_MAXDIST[2]>0)
REPEAT _SET_POINT_A _SET_POINT_E
ELSE
_RP=_STARTPOS[2]
ENDIF
IF(_MODE==0)
_XE=_START[0] _YE=_START[1]
ENDIF
IF(TRUNC(_STAT/100000) MOD 10)
REPEAT _NEWDIR_A _NEWDIR_E
REPEAT _CALCPOSI_A _CALCPOSI_E
REPEAT _SET_POINT_A _SET_POINT_E
IF(TRUNC(_STAT/100000) MOD 10)
REPEAT _NEWDIR_A _NEWDIR_E
REPEAT _CALCPOSI_A _CALCPOSI_E
REPEAT _SET_POINT_A _SET_POINT_E
IF(TRUNC(_STAT/100000) MOD 10)
IF(_MOD10)AND(_MODE==2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Zielpunkt E:")
ENDIF
GOTOF _ZIELPUNKT_E
ENDIF
ELSE
IF(_LAMBDA<>_LAMZ)
IF(_MOD10) GOTOF _ZIELPUNKT_Z
ENDIF
ENDIF
ELSE
IF(_LAMBDA<>_LAMZ)
IF(_MOD10) GOTOF _ZIELPUNKT_Z
ENDIF
ENDIF
ENDIF
IF(_MOD10==0)AND(_STARTPOS[2]<_RP) GOTOF _FEHL3
ENDIF
IF(_XE==_START[0])AND(_YE==_START[1])
IF(_MODE==0)
GOTOF _LETSGO
ELSE
GOTOF _ZIELPUNKT_Z
ENDIF
ENDIF
IF(_MODE==1)OR(_MODE==2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Zielpunkt XY:")
ENDIF
_MOVDIST[0]=_XE-_STARTPOS[0] _MOVDIST[1]=_YE-_STARTPOS[1] _MOVDIST[2]=0
_MAXDIST[0]=0 _MAXDIST[1]=0 _MAXDIST[2]=-1
REPEAT _CALCPOSI_A _CALCPOSI_E
REPEAT _SET_POINT_A _SET_POINT_E
_ZIELPUNKT_E:
IF(TRUNC(_STAT/100000) MOD 10)
REPEAT _NEWDIR_A _NEWDIR_E
REPEAT _CALCPOSI_A _CALCPOSI_E
REPEAT _SET_POINT_A _SET_POINT_E
IF(TRUNC(_STAT/100000) MOD 10)
REPEAT _NEWDIR_A _NEWDIR_E
REPEAT _CALCPOSI_A _CALCPOSI_E
REPEAT _SET_POINT_A _SET_POINT_E
ENDIF
ENDIF
ENDIF
_ZIELPUNKT_Z:
IF(_MODE==1)OR(_MODE==2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Zielpunkt Z:")
ENDIF
IF(_TESTLIM>16)
_TESTLIM=_TESTLIM-16
ENDIF
_MOVDIST[0]=_XE-_STARTPOS[0] _MOVDIST[1]=_YE-_STARTPOS[1] _MOVDIST[2]=_ZE-_STARTPOS[2]
REPEAT _CALCPOSI_A _CALCPOSI_E
REPEAT _SET_POINT_A _SET_POINT_E
ENDIF
_LETSGO:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"--------------------")
IF(_MODE==0)
WRITE(_LOG,_LOG_FILE,"Sollpositionen: 1")
WRITE(_LOG,_LOG_FILE,"0   WKS:  "<<ROUND(_INC*_START[0])/_INC<<"  "<<ROUND(_INC*_START[1])/_INC<<"  "<<ROUND(_INC*_START[2])/_INC)
WRITE(_LOG,_LOG_FILE,"1   WKS:  "<<ROUND(_INC*_START[0])/_INC<<"  "<<ROUND(_INC*_START[1])/_INC<<"  "<<_RP)
ENDIF
IF(_MODE==1)
WRITE(_LOG,_LOG_FILE,"Sollpositionen: 2")
WRITE(_LOG,_LOG_FILE,"0   WKS:  "<<ROUND(_INC*_START[0])/_INC<<"  "<<ROUND(_INC*_START[1])/_INC<<"  "<<ROUND(_INC*_START[2])/_INC)
WRITE(_LOG,_LOG_FILE,"1   WKS:  "<<_XE<<"  "<<_YE<<"  "<<ROUND(_INC*_START[2])/_INC)
WRITE(_LOG,_LOG_FILE,"2   WKS:  "<<_XE<<"  "<<_YE<<"  "<<_ZE)
ENDIF
IF(_MODE==2)
WRITE(_LOG,_LOG_FILE,"Sollpositionen: 3")
WRITE(_LOG,_LOG_FILE,"0   WKS:  "<<ROUND(_INC*_START[0])/_INC<<"  "<<ROUND(_INC*_START[1])/_INC<<"  "<<ROUND(_INC*_START[2])/_INC)
WRITE(_LOG,_LOG_FILE,"1   WKS:  "<<ROUND(_INC*_START[0])/_INC<<"  "<<ROUND(_INC*_START[1])/_INC<<"  "<<_RP)
WRITE(_LOG,_LOG_FILE,"2   WKS:  "<<_XE<<"  "<<_YE<<"  "<<_RP)
WRITE(_LOG,_LOG_FILE,"3   WKS:  "<<_XE<<"  "<<_YE<<"  "<<_ZE)
ENDIF
ENDIF
IF(_NUM>=0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Istpositionen: "<<_NUM+1)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"0   WKS:  "<<ROUND(_INC*_START[0])/_INC<<"  "<<ROUND(_INC*_START[1])/_INC<<"  "<<ROUND(_INC*_START[2])/_INC)
FOR _I=0 TO _NUM
WRITE(_LOG,_LOG_FILE,_I+1<<_STR[_STATUS[_I]]<<"  WKS:  "<<ROUND(_INC*_P[_I,0])/_INC<<"  "<<ROUND(_INC*_P[_I,1])/_INC<<"  "<<ROUND(_INC*_P[_I,2])/_INC)
ENDFOR
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"0   MKS:  "<<ROUND(_INC*$P_EPM[_XX])/_INC<<"  "<<ROUND(_INC*$P_EPM[_YY])/_INC<<"  "<<ROUND(_INC*$P_EPM[_ZZ])/_INC)
ENDIF
IF(_NUM>0)AND(_STAT)AND(_STATUS[_NUM]) GOTOF _FEHL4
IF(_NUM>4) GOTOF _FEHL5
FOR _I=0 TO _NUM
N40 SBLON
N41 G0 G90 G40 AX[_XX]=_P[_I,0] AX[_YY]=_P[_I,1] AX[_ZZ]=_P[_I,2]
N42 SBLOF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,_I+1<<_STR[_STATUS[_I]]<<"  MKS:  "<<ROUND(_INC*$P_EPM[_XX])/_INC<<"  "<<ROUND(_INC*$P_EPM[_YY])/_INC<<"  "<<ROUND(_INC*$P_EPM[_ZZ])/_INC)
ENDIF
ENDFOR
ENDIF
IF(_LOG_ON)
_LOG_END_A:
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Markierungen:")
WRITE(_LOG,_LOG_FILE,_STR[0]<<" = Position ohne Grenzverletzung erreicht")
WRITE(_LOG,_LOG_FILE,_STR[2]<<" = Position wegen Grenzverletzung nicht erreicht")
WRITE(_LOG,_LOG_FILE,_STR[1]<<" = Position per Abkuerzung erreicht")
WRITE(_LOG,_LOG_FILE,_STR[3]<<" = Position mit zwei Grenzverletzungen")
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Ende Logfile")
WRITE(_LOG,_LOG_FILE,"--------------------")
_LOG_END_E:
ENDIF
_RET:
G[6]=_P6
RET
_CALCPOSI_A:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"CALCPOSI: Input "<<_NUM+2)
WRITE(_LOG,_LOG_FILE,"STARTPOS: "<<ROUND(_INC*_STARTPOS[0])/_INC<<"  "<<ROUND(_INC*_STARTPOS[1])/_INC<<"  "<<ROUND(_INC*_STARTPOS[2])/_INC)
WRITE(_LOG,_LOG_FILE,"MOVDIST:  "<<ROUND(_INC*_MOVDIST[0])/_INC<<"  "<<ROUND(_INC*_MOVDIST[1])/_INC<<"  "<<ROUND(_INC*_MOVDIST[2])/_INC)
WRITE(_LOG,_LOG_FILE,"MAXDIST:  "<<ROUND(_INC*_MAXDIST[0])/_INC<<"  "<<ROUND(_INC*_MAXDIST[1])/_INC<<"  "<<ROUND(_INC*_MAXDIST[2])/_INC)
ENDIF
_STAT=CALCPOSI(_STARTPOS,_MOVDIST,_DLIMIT,_MAXDIST,0,_TESTLIM)
_DLIMIT[0]=_DLIMIT[0]-2/_INC _DLIMIT[1]=_DLIMIT[1]-2/_INC _DLIMIT[2]=_DLIMIT[2]-2/_INC
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CALCPOSI: Output "<<_NUM+2)
WRITE(_LOG,_LOG_FILE,"STATUS:   "<<_STAT)
WRITE(_LOG,_LOG_FILE,"MOVDIST:  "<<ROUND(_INC*_MOVDIST[0])/_INC<<"  "<<ROUND(_INC*_MOVDIST[1])/_INC<<"  "<<ROUND(_INC*_MOVDIST[2])/_INC)
WRITE(_LOG,_LOG_FILE,"MAXDIST:  "<<ROUND(_INC*_MAXDIST[0])/_INC<<"  "<<ROUND(_INC*_MAXDIST[1])/_INC<<"  "<<ROUND(_INC*_MAXDIST[2])/_INC)
ENDIF
IF(_STAT==-6) GOTOF _FEHL7
IF(_STAT<0) GOTOF _FEHL4
_CALCPOSI_E:
_SET_POINT_A:
IF(_MAXDIST[0]<>0)OR(_MAXDIST[1]<>0)OR(_MAXDIST[2]<>0)
_STARTPOS[0]=_STARTPOS[0]+_MAXDIST[0]
_STARTPOS[1]=_STARTPOS[1]+_MAXDIST[1]
_STARTPOS[2]=_STARTPOS[2]+_MAXDIST[2]
_NUM=_NUM+1
_P[_NUM,0]=_STARTPOS[0] _P[_NUM,1]=_STARTPOS[1] _P[_NUM,2]=_STARTPOS[2]
IF(_STAT==0)
_STATUS[_NUM]=0
IF(_NUM>0)
IF(_STATUS[_NUM-1]>1)
_STATUS[_NUM]=1
ENDIF
ENDIF
ELSE
_STATUS[_NUM]=2
IF(_NUM>0)
IF(_STATUS[_NUM-1]>1)
_STATUS[_NUM]=3
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,_NUM+1<<_STR[_STATUS[_NUM]]<<"  WKS:  "<<ROUND(_INC*_P[_NUM,0])/_INC<<"  "<<ROUND(_INC*_P[_NUM,1])/_INC<<"  "<<ROUND(_INC*_P[_NUM,2])/_INC)
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,_NUM+2<<"   WKS:   Verfahrweg = 0")
ENDIF
ENDIF
_SET_POINT_E:
_NEWDIR_A:
_LAMBDA=0 _LAMX=0 _LAMY=0 _LAMZ=0
IF(_MOVDIST[0]<>0)
_LAMX=(_XE-_STARTPOS[0])/_MOVDIST[0]
ENDIF
IF(_MOVDIST[1]<>0)
_LAMY=(_YE-_STARTPOS[1])/_MOVDIST[1]
ENDIF
IF(_MOVDIST[2]<>0)
_LAMZ=(_RP-_STARTPOS[2])/_MOVDIST[2]
IF(_MOD10)
_LAMBDA=_LAMZ
ENDIF
ENDIF
IF(_LAMZ>0)AND((_LAMZ<_LAMX)OR(_LAMX<=0))AND((_LAMZ<_LAMY)OR(_LAMY<=0))
_LAMBDA=_LAMZ
ELSE
IF(_LAMX>0)AND((_LAMX<=_LAMZ)OR(_LAMZ<=0))AND((_LAMX<=_LAMY)OR(_LAMY<=0))
_LAMBDA=_LAMX
ELSE
IF(_LAMY>0)AND((_LAMY<=_LAMZ)OR(_LAMZ<=0))AND((_LAMY<=_LAMX)OR(_LAMX<=0))
_LAMBDA=_LAMY
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"LAMBDA:   "<<ROUND(_INC*_LAMX)/_INC<<"  "<<ROUND(_INC*_LAMY)/_INC<<"  "<<ROUND(_INC*_LAMZ)/_INC<<" => "<<ROUND(_INC*_LAMBDA)/_INC)
ENDIF
;IF(_LAMBDA>=0)
_MOVDIST[0]=_LAMBDA*_MOVDIST[0]
_MOVDIST[1]=_LAMBDA*_MOVDIST[1]
_MOVDIST[2]=_LAMBDA*_MOVDIST[2]
_MAXDIST[0]=_NORMAL[1]*_MOVDIST[2]-_NORMAL[2]*_MOVDIST[1]
_MAXDIST[1]=_NORMAL[2]*_MOVDIST[0]-_NORMAL[0]*_MOVDIST[2]
_MAXDIST[2]=_NORMAL[0]*_MOVDIST[1]-_NORMAL[1]*_MOVDIST[0]
;ENDIF
_NEWDIR_E:
_MKS2WKS_A:
$AC_MEAS_VALID=0
$AC_MEAS_TYPE=24
$AC_MEAS_P1_COORD=2
$AC_MEAS_P2_COORD=0
$AA_MEAS_POINT1[_XX]=0/_FAK1
$AA_MEAS_POINT1[_YY]=0/_FAK1
$AA_MEAS_POINT1[_ZZ]=1/_FAK1
_RETVAL=MEASURE()
IF(_RETVAL<>0) GOTOF _FEHL6
_XE=$AA_MEAS_POINT2[_XX]*_FAK1*S_FAK_PLAN
_YE=$AA_MEAS_POINT2[_YY]*_FAK1
_ZE=$AA_MEAS_POINT2[_ZZ]*_FAK1
_MKS2WKS_E:
_FEHL1:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Fehler 1: Startpunkt verletzt Grenze! STATUS="<<_STAT)
REPEAT _LOG_END_A _LOG_END_E
ENDIF
N934001 SETAL(61099,"1")
RET
_FEHL2:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Fehler 2: Zielpunkt verletzt Grenze! STATUS="<<_STAT)
REPEAT _LOG_END_A _LOG_END_E
ENDIF
N934002 SETAL(61275)
RET
_FEHL3:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Fehler 3: Rckzugsebene nicht erreicht! NUM="<<_NUM+1)
REPEAT _LOG_END_A _LOG_END_E
ENDIF
N934003 SETAL(61228)
RET
_FEHL4:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Fehler 4: Keine Loesung gefunden! NUM="<<_NUM+1)
REPEAT _LOG_END_A _LOG_END_E
ENDIF
N934004 SETAL(61099,"2")
RET
_FEHL5:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Fehler 5: Mehr als 5 Punkte! NUM="<<_NUM+1)
REPEAT _LOG_END_A _LOG_END_E
ENDIF
N934005 SETAL(61099,"3")
RET
_FEHL6:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Fehler 6: MEASURE(MKS->WKS)! NUM="<<_NUM+1)
REPEAT _LOG_END_A _LOG_END_E
ENDIF
N934006 SETAL(61403)
RET
_FEHL7:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Fehler 7: Achse nicht referenziert! NUM="<<_NUM+1)
REPEAT _LOG_END_A _LOG_END_E
ENDIF
N934007 SETAL(61069)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SP_RPF_SPF
PROC F_SP_RPF(INT _MODE, VAR REAL _P[3]) SAVE DISPLOF PREPRO
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.07.01.00 ;DATE: 2013-12-09
;ShopTurn: Swivelling Frame Cycle
DEF AXIS _XX,_YY,_ZZ
DEF FRAME _FRAME,_VECT
DEF INT _LOG,_LOG_ON
DEF STRING[35] _LOG_FILE
DEF BOOL _Y_EXISTS
IF(_F_TRAANG)OR(_F_Y_AXIS)
_Y_EXISTS=TRUE
ELSE
_Y_EXISTS=FALSE
ENDIF
IF($P_GG[6]==1)
_XX=$P_AXN1
IF(_Y_EXISTS)
_YY=$P_AXN2
ENDIF
_ZZ=$P_AXN3
ELSE
IF($P_GG[6]==2)
_ZZ=$P_AXN1
_XX=$P_AXN2
IF(_Y_EXISTS)
_YY=$P_AXN3
ENDIF
ELSE
IF(_Y_EXISTS)
_YY=$P_AXN1
ENDIF
_ZZ=$P_AXN2
_XX=$P_AXN3
ENDIF
ENDIF
_FRAME=$P_PARTFRAME:$P_WPFRAME:$P_TOOLFRAME
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_SP_RPF_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"MODE:     "<<_MODE)
IF(_Y_EXISTS)
WRITE(_LOG,_LOG_FILE,"TRANS:    "<<_FRAME[_XX,TR]<<"  "<<_FRAME[_YY,TR]<<"  "<<_FRAME[_ZZ,TR])
WRITE(_LOG,_LOG_FILE,"ROT:      "<<_FRAME[_XX,RT]<<"  "<<_FRAME[_YY,RT]<<"  "<<_FRAME[_ZZ,RT])
ELSE
WRITE(_LOG,_LOG_FILE,"TRANS:    "<<_FRAME[_XX,TR]<<"  "<<_FRAME[_ZZ,TR])
WRITE(_LOG,_LOG_FILE,"ROT:      "<<_FRAME[_XX,RT]<<"  "<<_FRAME[_ZZ,RT])
ENDIF
WRITE(_LOG,_LOG_FILE,"INPUT  =  "<<_P[0]<<"  "<<_P[1]<<"  "<<_P[2])
ENDIF
IF(_Y_EXISTS)
_VECT=CTRANS(_XX,_P[0],_YY,_P[1],_ZZ,_P[2])
ELSE
_VECT=CTRANS(_XX,_P[0],_ZZ,_P[2])
ENDIF
IF(_MODE==0)
_VECT=INVFRAME(_FRAME):_VECT
ELSE
_VECT=_FRAME:_VECT
ENDIF
_P[0]=_VECT[_XX,TR]
IF(_Y_EXISTS)
_P[1]=_VECT[_YY,TR]
ENDIF
_P[2]=_VECT[_ZZ,TR]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"OUTPUT =  "<<_P[0]<<"  "<<_P[1]<<"  "<<_P[2])
WRITE(_LOG,_LOG_FILE,"--------------------")
WRITE(_LOG,_LOG_FILE,"Ende Logfile")
WRITE(_LOG,_LOG_FILE,"--------------------")
ENDIF
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SP_RPT_SPF
PROC F_SP_RPT(INT _P1,INT _P2) PREPRO DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.21.00.00.004 ;DATE: 2022-10-21
;ShopTurn: Retract Data Cycle
DEF AXIS _XX,_ZZ
DEF INT _TM1,_TM3,_MAN,_SL,S_Y_TURN
DEF INT _SLT[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,2,1,4,3,7,6,5,8,9)
DEF INT _SLX[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,4,3,2,1,5,8,7,6,9)
DEF REAL _FAK1
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
REPEAT _AXNAME_A _AXNAME_E
IF(_P1==0)
G18
IF(_P2>7)
_P2=_P2-8
ENDIF
IF(_P2<4)
IF(_P2<2)
_F_RP_ACT=_F_RPT[0] _F_RP_DIR[1]=-2
ELSE
_F_RP_ACT=_F_RPT[2] _F_RP_DIR[1]=2
ENDIF
ELSE
IF(_P2<6)
_F_RP_ACT=_F_RPT[1] _F_RP_DIR[1]=-1
ELSE
_F_RP_ACT=_F_RPT[3] _F_RP_DIR[1]=1
ENDIF
ENDIF
ELSE
IF(_P1==4)
IF(_P2==0)
_F_RP_ACT=_F_RPT[2] _F_RP_DIR[1]=2
ENDIF
IF(_P2==1)OR(_P2==2)OR(_P2==3)
_F_RP_ACT=_F_RPT[0] _F_RP_DIR[1]=-2
ENDIF
IF(_P2==4)
_F_RP_ACT=_F_RPT[3] _F_RP_DIR[1]=1
ENDIF
IF(_P2==5)
_F_RP_ACT=_F_RPT[1] _F_RP_DIR[1]=-1
ENDIF
ELSE
IF(_P1==5)
_SL=$P_ADT[2]
IF($P_AD[1]==505)OR($P_AD[1]==515)OR($P_AD[1]==525)OR($P_AD[1]==535)
S_Y_TURN=1
ENDIF
IF(NOT(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'H00200000')AND($P_CUTMOD))AND NOT(($P_CUTMODK==$PC_TRAFO_NAME)AND($P_CUTMODK<>""))AND(NOT S_Y_TURN))
_SL=_SLT[$P_ACTFRAME[_ZZ,MI],_SL]
_SL=_SLX[$P_ACTFRAME[_XX,MI],_SL]
ENDIF
IF(_SL==5)
_F_RP_ACT=_F_RPT[3] _F_RP_DIR[1]=1
ENDIF
IF(_SL==6)
_F_RP_ACT=_F_RPT[2] _F_RP_DIR[1]=2
ENDIF
IF(_SL==7)
_F_RP_ACT=_F_RPT[1] _F_RP_DIR[1]=-1
ENDIF
IF(_SL==8)
_F_RP_ACT=_F_RPT[0] _F_RP_DIR[1]=-2
ENDIF
ELSE
_TM1=_P2 MOD 10
_MAN=TRUNC(_P2/10) MOD 10
_TM3=TRUNC(_P2/100) MOD 10
IF(_TM1>=2)
G17
IF(_TM3==0)
_F_RP_ACT=_F_RPT[1] _F_RP_DIR[1]=-1
ELSE
_F_RP_ACT=_F_RPT[3] _F_RP_DIR[1]=1
ENDIF
IF(_TM1==6)
_F_RP_ACT=_F_RPT[5] _F_RP_DIR[1]=6
ENDIF
IF(_MAN)
_F_RP_ACT=$P_EP[_ZZ]*_FAK1
ENDIF
ELSE
G19
IF(_TM3==0)
_F_RP_ACT=_F_RPT[0] _F_RP_DIR[1]=-2
ELSE
_F_RP_ACT=_F_RPT[2] _F_RP_DIR[1]=2
ENDIF
IF(_MAN)
_F_RP_ACT=$P_EP[_XX]*_FAK1
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
IF(_F_RP_ACT==_SC_NO_VAL)GOTOF _FEHL1
IF($P_TOOLNO>0)
_F_RP_DIR_T=$TC_TP2[$P_TOOLNO]
ELSE
_F_RP_DIR_T="0"
ENDIF
IF(NOT $P_SEARCH)AND(NOT $AC_SERUPRO)
_F_RP_DIR_T_S=_F_RP_DIR_T
ENDIF
IF(ABS(_F_RP_DIR[1])==1)OR(ABS(_F_RP_DIR[1])==6)
_F_RP_ACT=_F_RP_ACT-$P_PFRAME[_ZZ,TR]
IF($MN_MM_FRAME_FINE_TRANS)
_F_RP_ACT=_F_RP_ACT-$P_PFRAME[_ZZ,FI]
ENDIF
ENDIF
IF(ABS(_F_RP_DIR[1])==2)
_F_RP_ACT=_F_RP_ACT-$P_PFRAME[_XX,TR]
IF($MN_MM_FRAME_FINE_TRANS)
_F_RP_ACT=_F_RP_ACT-$P_PFRAME[_XX,FI]
ENDIF
ENDIF
RET
_AXNAME_A:
IF($P_GG[6]==1)
_XX=$P_AXN1
_ZZ=$P_AXN3
ELSE
IF($P_GG[6]==2)
_XX=$P_AXN2
_ZZ=$P_AXN1
ELSE
_XX=$P_AXN3
_ZZ=$P_AXN2
ENDIF
ENDIF
_AXNAME_E:
_FEHL1: STOPRE
N934101 SETAL(61241)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SP_TRA_SPF
PROC F_SP_TRA(INT _TRAMA,REAL _R,REAL _C0) PREPRO SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.94.00.00.004 ;DATE: 2020-03-23
;ShopTurn: Transformation Management Cycle
DEF AXIS _XX,_YY,_ZZ
DEF INT _TRA1,_TRA2,_TRA3,_TRA4,_TRA5,_TRA6,_TAL1,_TAL2,_NPV1,_EBEN,_SPIN,_TRAFO_NUM,_TRAFO_TYPE,S_MD_BREAK
DEF BOOL _Y_ZERO
DEF FRAME _PFRAME
DEF REAL _FAK1
DEF STRING[30] S_STRAL
DEF STRING[200] _STR
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
G4 F0
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_SP_TRA_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"F_SP_TRA("<<_TRAMA<<","<<_R<<","<<_C0<<")")
ENDIF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_TRA1=_TRAMA MOD 10
_TRA2=TRUNC(_TRAMA/10) MOD 10
_TRA3=TRUNC(_TRAMA/100) MOD 10
_TRA4=TRUNC(_TRAMA/1000) MOD 10
_TRA5=TRUNC(_TRAMA/10000) MOD 10
_TRA6=TRUNC(_TRAMA/100000) MOD 10
_TAL1=_F_TRAMA MOD 10
_TAL2=TRUNC(_F_TRAMA/10) MOD 10
IF(_TRA3==2)
IF(TRUNC(_F_TRAMA/100000) MOD 10)
_F_TRAMA=_F_TRAMA-100000
ENDIF
IF(TRUNC(_F_TRAMA/100000) MOD 10)
GOTOF _RET
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"letzte Trafo aktiviert:")
ENDIF
IF(_F_TRA_T)AND(_F_TRA_N)
IF(_F_TRA_N>1000)
IF(_F_TRA_TS=="TRAORI_STAT")
IF(($NT_IDENT[_F_TRA_N MOD 1000,0] _DEC5)>=2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G18")
ENDIF
G18
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  CUST_800(70,"<<(_F_TRA_N MOD 1000)<<")")
ENDIF
CUST_800(70,_F_TRA_N MOD 1000)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  TRAFOON("<<_F_TRA_NS<<")")
ENDIF
TRAFOON(_F_TRA_NS)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  $P_WPFRAME")
ENDIF
$P_WPFRAME=_F_TRA_WP_FR
$P_WPFR=$P_WPFRAME
IF(_F_TRA_CUTK==_F_TRA_NS)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  CUTMODK=NEW")
ENDIF
CUTMODK="NEW"
ENDIF
ENDIF
ELSE
IF(_F_TRA_TS=="TRACYL_K")
IF(_F_TRA_T==514)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  TRAFOON("<<_F_TRA_NS<<","<<_F_TRA_D<<","<<_F_TRA_K<<")")
ENDIF
TRAFOON(_F_TRA_NS,_F_TRA_D,_F_TRA_K)
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  TRAFOON("<<_F_TRA_NS<<","<<_F_TRA_D<<")")
ENDIF
TRAFOON(_F_TRA_NS,_F_TRA_D)
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  TRAFOON("<<_F_TRA_NS<<")")
ENDIF
TRAFOON(_F_TRA_NS)
ENDIF
ENDIF
ELSE
IF(_F_TRA_T B_AND 'H030')OR(_F_TRA_T==72)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  TRAORI("<<_F_TRA_N<<")")
ENDIF
TRAORI(_F_TRA_N)
ENDIF
IF(_F_TRA_T B_AND 'H100')
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  TRANSMIT("<<_F_TRA_N<<")")
ENDIF
TRANSMIT(_F_TRA_N)
ENDIF
IF(_F_TRA_T B_AND 'H200')AND(_F_TRA_D>0)
IF(_F_TRA_T==514)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  TRACYL("<<_F_TRA_D<<","<<_F_TRA_N<<","<<_F_TRA_K<<")")
ENDIF
TRACYL(_F_TRA_D,_F_TRA_N,_F_TRA_K)
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  TRACYL("<<_F_TRA_D<<","<<_F_TRA_N<<")")
ENDIF
TRACYL(_F_TRA_D,_F_TRA_N)
ENDIF
ENDIF
IF(_F_TRAANG==1)AND(_F_TRA_T B_AND 'H400')
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  TRAANG(,"<<_F_TRA_N<<")")
ENDIF
TRAANG(,_F_TRA_N)
ENDIF
ENDIF
ENDIF
IF(_F_TRA_T B_AND 'H300')
_SET_TRANS_Y_A:
REPEAT _AXNAME_Y_A _AXNAME_Y_E
$P_PFRAME[_YY,TR]=_F_TRA_Y
$P_PFRAME[_YY,SC]=_F_TRA_S
$P_PFRAME[_YY,MI]=_F_TRA_M
IF($MN_MM_FRAME_FINE_TRANS)
$P_PFRAME[_YY,FI]=_F_TRA_FI
ENDIF
IF(NOT _F_Y_AXIS)
REPEAT _AXNAME_Z_A _AXNAME_Z_E
$P_PFRAME[_ZZ,RT]=_F_TRA_Z
ENDIF
_SET_TRANS_Y_E:
ENDIF
_F_TRA_T=0
GOTOF _RET
ENDIF
IF(_TRA3==3)
IF(TRUNC(_F_TRAMA/100000) MOD 10)
_F_TRAMA=_F_TRAMA+100000
GOTOF _RET
ENDIF
_F_TRAMA=_F_TRAMA+100000
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Systemvariablen:")
WRITE(_LOG,_LOG_FILE,"  $PC_TRAFO_TYPE_NAME="<<$PC_TRAFO_TYPE_NAME)
WRITE(_LOG,_LOG_FILE,"  $PC_TRAFO_NAME="<<$PC_TRAFO_NAME)
WRITE(_LOG,_LOG_FILE,"  $P_TRAFO="<<$P_TRAFO)
WRITE(_LOG,_LOG_FILE,"  $P_TRAFO_PARSET="<<$P_TRAFO_PARSET)
WRITE(_LOG,_LOG_FILE,"  $P_TRAFO_PAR[0]="<<$P_TRAFO_PAR[0])
WRITE(_LOG,_LOG_FILE,"  $P_TRAFO_PAR[1]="<<$P_TRAFO_PAR[1])
ENDIF
_F_TRA_T=$P_TRAFO
_F_TRA_TS=$PC_TRAFO_TYPE_NAME
_F_TRA_NS=$PC_TRAFO_NAME
_F_TRA_N=$P_TRAFO_PARSET
IF(_F_TRA_T B_AND 'H200')
_F_TRA_D=$P_TRAFO_PAR[0]
IF(_F_TRA_T==514)
_F_TRA_K=$P_TRAFO_PAR[1]
ENDIF
ENDIF
IF(_F_TRA_N>1000)
;_F_TRA_NS=$NT_NAME[_F_TRA_N MOD 1000]
IF(_F_TRA_TS=="TRAORI_STAT")
IF(($NT_IDENT[_F_TRA_N MOD 1000,0] _DEC5)>=2)
_F_TRA_CUTK=$P_CUTMODK
_F_TRA_WP_FR=$P_WPFRAME
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Trafo gespeichert:")
WRITE(_LOG,_LOG_FILE,"  Tpy:"<<_F_TRA_T<<" "<<_F_TRA_TS)
WRITE(_LOG,_LOG_FILE,"  Nr:"<<(_F_TRA_N MOD 1000)<<" "<<_F_TRA_NS)
IF(_F_TRA_T B_AND 'H200')
WRITE(_LOG,_LOG_FILE,"  D="<<_F_TRA_D)
IF(_F_TRA_T==514)
WRITE(_LOG,_LOG_FILE,"  K="<<_F_TRA_K)
ENDIF
ENDIF
IF(_F_TRA_N>1000)
IF(_F_TRA_TS=="TRAORI_STAT")
IF(($NT_IDENT[_F_TRA_N MOD 1000,0] _DEC5)>=2)
WRITE(_LOG,_LOG_FILE,"  CUTMODK="<<_F_TRA_CUTK)
ENDIF
ENDIF
ENDIF
ENDIF
GOTOF _RET
ENDIF
IF(_TRA3==4)
REPEAT _TRAFOF_A _TRAFOF_E
GOTOF _RET
ENDIF
IF(_TRA4==0)OR(_TRA4==4)
_TRAFOF_A:
IF($P_TRAFO<>0)
IF($P_TRAFO B_AND 'H300')
REPEAT _AXNAME_Y_A _AXNAME_Y_E
_F_TRAFO=$P_TRAFO
_F_TRA_Y=$P_PFRAME[_YY,TR]
_F_TRA_S=$P_PFRAME[_YY,SC]
_F_TRA_M=$P_PFRAME[_YY,MI]
IF($MN_MM_FRAME_FINE_TRANS)
_F_TRA_FI=$P_PFRAME[_YY,FI]
ENDIF
IF(NOT _F_Y_AXIS)
REPEAT _AXNAME_Z_A _AXNAME_Z_E
_F_TRA_Z=$P_PFRAME[_ZZ,RT]
ENDIF
ENDIF
IF($P_TRAFO_PARSET>1000)
IF($PC_TRAFO_TYPE_NAME=="TRAORI_STAT")
IF(($NT_IDENT[$P_TRAFO_PARSET MOD 1000,0] _DEC5)>=2)
CYCLE809()
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CYCLE809() Drehtrafo aus")
ENDIF
ENDIF
ENDIF
ENDIF
IF(_F_TRAANG==1)
IF(NOT ($P_TRAFO B_AND 'H400'))
TRAANG
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"TRAANG")
ENDIF
ENDIF
ELSE
TRAFOOF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"TRAFOOF")
ENDIF
ENDIF
ENDIF
_TRAFOF_E:
ENDIF
IF(_TRA4>=2)
_EBEN=_F_EBENE
IF(_TAL2==6)AND(_TRA2<>6)
CUST_TECHCYC(67)
_F_TRAMA=_F_TRAMA-_TAL2*10+_TRA2*10
ENDIF
IF(_TRA1==0)OR(_TRA2==4)
_F_PLANE=61
_F_EBENE=61
CUST_TECHCYC(61)
ELSE
IF(_TRA2==0)
IF(_TRA4==4)
_F_PLANE=62
ELSE
IF(_F_EBENE<>62)
_F_EBENE=62
CUST_TECHCYC(62)
ENDIF
ENDIF
ENDIF
IF(_TRA2==2)
IF(_TRA4==4)
_F_PLANE=63
ELSE
IF(_F_EBENE<>63)
_F_EBENE=63
CUST_TECHCYC(63)
ENDIF
ENDIF
ENDIF
IF(_TRA2==1)
IF(_TRA4==4)
_F_PLANE=64
ELSE
IF(_F_EBENE<>64)
_F_EBENE=64
CUST_TECHCYC(64)
ENDIF
ENDIF
ENDIF
IF(_TRA2==3)
IF(_TRA4==4)
_F_PLANE=65
ELSE
IF(_F_EBENE<>65)
_F_EBENE=65
CUST_TECHCYC(65)
ENDIF
ENDIF
ENDIF
IF(_TRA2==6)
IF(_TRA4==4)
_F_PLANE=66
ELSE
IF(_F_EBENE<>66)
_F_EBENE=66
CUST_TECHCYC(66)
_F_TRAMA=_F_TRAMA-_TAL2*10+_TRA2*10
ENDIF
ENDIF
ENDIF
ENDIF
IF($P_SEARCH)OR($AC_SERUPRO)
_F_EBENE=_EBEN
ENDIF
ENDIF
IF(_TRA4==4) GOTOF _RET
IF(_TRA4 B_AND 'B01')AND(_F_Y_AXIS)
IF(_E_ST_PRG)
REPEAT _TRAFOF_A _TRAFOF_E
ENDIF
_Y_ZERO=FALSE
IF(_TRA1==4)
_Y_ZERO=TRUE
ENDIF
IF(_TRA2==0)OR(_TRA2==2)OR(_TRA2==4)OR(_TRA2==5)
_Y_ZERO=TRUE
ENDIF
IF(_Y_ZERO==TRUE)
_PFRAME=$P_PFRAME
$P_PFRAME=CTRANS()
REPEAT _AXNAME_Y_A _AXNAME_Y_E
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Y=0 fahren")
ENDIF
SBLON
G0 AX[_YY]=AC(0)
SBLOF
$P_PFRAME=_PFRAME
ENDIF
ENDIF
IF(_TRA4 B_AND 'B01')AND(_TRA2==2)AND(_TRA3==1)AND(NOT($P_TRAFO B_AND 'H100'))
IF(NOT _F_Y_AXIS)
REPEAT _TRAFOF_A _TRAFOF_E
ENDIF
_PFRAME=CTRANS()
REPEAT _AXNAME_X_A _AXNAME_X_E
_PFRAME[_XX,TR]=$P_EP[_XX]
IF(_F_Y_AXIS)
REPEAT _AXNAME_Y_A _AXNAME_Y_E
_PFRAME[_YY,TR]=$P_EP[_YY]
ENDIF
_PFRAME=$P_PFRAME:_PFRAME
IF(_PFRAME[_XX,TR]<0)OR(($P_GG[8]>1)AND($P_IFRAME[_XX,TR]+$P_IFRAME[_XX,FI]<$MAS_AXIS_MCS_POSITION[0,_F_S_AX[5]]*_FAK1))
_PFRAME=$P_PFRAME
$P_PFRAME=CTRANS()
IF($P_GG[8]>1)
IF($P_IFRAME[_XX,TR]+$P_IFRAME[_XX,FI]<$MAS_AXIS_MCS_POSITION[0,_F_S_AX[5]]*_FAK1)
$P_PFRAME[_XX,TR]=-$P_IFRAME[_XX,TR]-$P_IFRAME[_XX,FI]+$MAS_AXIS_MCS_POSITION[0,_F_S_AX[5]]*_FAK1
ENDIF
ENDIF
;MSG("F_SP_TRA: X="<<$P_EP[X]<<" XTR="<<$P_ACTFRAME[X,TR])
;M0
;STOPRE
IF($P_EP[_XX]<0)
SBLON
G0 AX[_XX]=AC(0.001)
SBLOF
ENDIF
$P_PFRAME=_PFRAME
ENDIF
ENDIF
G4 F0
IF(_TRAMA)
IF(_TRAMA==4)
_F_TRAMA=_F_TRAMA-_TAL1+_TRAMA
ELSE
_F_TRAMA=_TRAMA
ENDIF
ENDIF
_SPIN=1+_F_MASPI/2
IF(_TRA4 B_AND 'B10')
IF(_E_IR==0)AND(_TRA2<>6)
$P_CYCFRAME=CTRANS()
ENDIF
IF(_TRA2<>0)AND(_TRA2<>2)
_F_TRAFO=0
ENDIF
IF(_TRA1==0)OR(_TRA2==4)
IF(_E_ST_PRG)
REPEAT _TRAFOF_A _TRAFOF_E
ENDIF
REPEAT _C_LOESEN_A _C_LOESEN_E
IF(_TRA2<>5)
G18
ELSE
G17
ENDIF
ELSE
IF(_TRA2==0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Mantel C")
ENDIF
IF(_TRA1<>3)OR(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
REPEAT _C_LOESEN_A _C_LOESEN_E
ENDIF
IF(_TRA3==1)
IF(_F_MASPI==2)
_TRAFO_NUM=_SC_TRACYL[1,3]
ELSE
_TRAFO_NUM=_SC_TRACYL[0,3]
ENDIF
IF(_TRAFO_NUM>0)AND(_TRAFO_NUM<=20)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  klassisch")
ENDIF
_STR="_TRAFO_TYPE=$MC_TRAFO_TYPE_"<<_TRAFO_NUM
EXECSTRING(_STR)
IF(_TRAFO_TYPE==514)
IF($P_TRAFO_PARSET<>_SPIN)OR($P_TRAFO_PAR[0]<>2*_R)OR($P_TRAFO_PAR[1]<>_TRA5)OR(_F_TRAANG==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  TRACYL("<<2*_R<<","<<_SPIN<<","<<_TRA5<<")")
ENDIF
TRACYL(2*_R,_SPIN,_TRA5)
ENDIF
ELSE
IF(NOT($P_TRAFO B_AND 'H200'))
REPEAT _TRAFOF_A _TRAFOF_E
ENDIF
IF(_F_MASPI==2)
IF(_TRA5)
IF(NOT (_TRAFO_TYPE B_AND 'H001'))
REPEAT _TRAFOF_A _TRAFOF_E
_STR="$MC_TRAFO_TYPE_"<<_TRAFO_NUM<<"=513"
EXECSTRING(_STR)
NEWCONF
ENDIF
ELSE
IF(_TRAFO_TYPE B_AND 'H001')
REPEAT _TRAFOF_A _TRAFOF_E
_STR="$MC_TRAFO_TYPE_"<<_TRAFO_NUM<<"=512"
EXECSTRING(_STR)
NEWCONF
ENDIF
ENDIF
ELSE
IF(_TRA5)
IF(NOT (_TRAFO_TYPE B_AND 'H001'))
REPEAT _TRAFOF_A _TRAFOF_E
_STR="$MC_TRAFO_TYPE_"<<_TRAFO_NUM<<"=513"
EXECSTRING(_STR)
NEWCONF
ENDIF
ELSE
IF(_TRAFO_TYPE B_AND 'H001')
REPEAT _TRAFOF_A _TRAFOF_E
_STR="$MC_TRAFO_TYPE_"<<_TRAFO_NUM<<"=512"
EXECSTRING(_STR)
NEWCONF
ENDIF
ENDIF
ENDIF
IF($P_TRAFO_PARSET<>_SPIN)OR($P_TRAFO_PAR[0]<>2*_R)OR(_F_TRAANG==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  TRACYL("<<2*_R<<","<<_SPIN<<")")
ENDIF
TRACYL(2*_R,_SPIN)
ENDIF
ENDIF
ELSE
IF(_TRAFO_NUM>=1001)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  kin. Trafo")
ENDIF
IF(_SC_TRACYL[_F_MASPI/2,0]==514)
;IF($P_TRAFO_PARSET<>_SPIN)OR($P_TRAFO_PAR[0]<>2*_R)OR($P_TRAFO_PAR[1]<>_TRA5)OR(_F_TRAANG==1)
IF($PC_TRAFO_NAME<>$NT_NAME[_SC_TRACYL[_F_MASPI/2,3]MOD 1000])OR($P_TRAFO_PAR[0]<>2*_R)OR($P_TRAFO_PAR[1]<>_TRA5)OR(_F_TRAANG==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  TRACYL("<<2*_R<<","<<_SPIN<<","<<_TRA5<<")")
ENDIF
TRACYL(2*_R,_SPIN,_TRA5)
ENDIF
ELSE
IF(_TRA5)
IF(_SC_TRACYL[_F_MASPI/2,0]==512)
S_STRAL=$NT_NAME[_SC_TRACYL[_F_MASPI/2,3]MOD 1000]
GOTOF _FEHL1
ENDIF
ELSE
IF(_SC_TRACYL[_F_MASPI/2,0]==513)
S_STRAL=$NT_NAME[_SC_TRACYL[_F_MASPI/2,3]MOD 1000]
GOTOF _FEHL1
ENDIF
ENDIF
IF($PC_TRAFO_NAME<>$NT_NAME[_SC_TRACYL[_F_MASPI/2,3]MOD 1000])OR($P_TRAFO_PAR[0]<>2*_R)OR(_F_TRAANG==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  TRACYL("<<2*_R<<","<<_SPIN<<")")
ENDIF
TRACYL(2*_R,_SPIN)
ENDIF
ENDIF
ELSE
S_STRAL="TRACYL "<<_TRAFO_NUM
GOTOF _FEHL2
ENDIF
ENDIF
IF(_F_TRAFO B_AND 'H200')
REPEAT _SET_TRANS_Y_A _SET_TRANS_Y_E
ENDIF
ELSE
REPEAT _TRAFOF_A _TRAFOF_E
ENDIF
G19
ENDIF
IF(_TRA2==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Mantel Y")
ENDIF
REPEAT _Y_LOESEN_A _Y_LOESEN_E
REPEAT _TRAFOF_A _TRAFOF_E
G19
ENDIF
IF(_TRA2==2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Stirn C")
ENDIF
IF(_TRA1<>3)OR(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
REPEAT _C_LOESEN_A _C_LOESEN_E
ENDIF
IF(_TRA3==1)
IF(NOT($P_TRAFO B_AND 'H100'))
REPEAT _TRAFOF_A _TRAFOF_E
ENDIF
IF($P_TRAFO_PARSET<=1000)
IF($P_TRAFO_PARSET<>_SPIN)OR(_F_TRAANG==1)
TRANSMIT(_SPIN)
ENDIF
ELSE
IF($PC_TRAFO_NAME<>$NT_NAME[_SC_TRANSM[_F_MASPI/2,3]MOD 1000])OR(_F_TRAANG==1)
TRANSMIT(_SPIN)
ENDIF
ENDIF
IF(_F_TRAFO B_AND 'H100')
REPEAT _SET_TRANS_Y_A _SET_TRANS_Y_E
ENDIF
IF($MCS_REV_2_BORDER_TOOL_LENGTH)
F_T_REV2
ENDIF
ELSE
REPEAT _TRAFOF_A _TRAFOF_E
ENDIF
G17
ENDIF
IF(_TRA2==3)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Stirn Y")
ENDIF
REPEAT _Y_LOESEN_A _Y_LOESEN_E
REPEAT _TRAFOF_A _TRAFOF_E
G17
ENDIF
IF(_TRA2==6)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Stirn B")
ENDIF
REPEAT _Y_LOESEN_A _Y_LOESEN_E
REPEAT _TRAFOF_A _TRAFOF_E
G17
ENDIF
ENDIF
ENDIF
_RET:
G4 F0
SBLON
RET
_AXNAME_X_A:
IF($P_GG[6]==1)
_XX=$P_AXN1
ELSE
IF($P_GG[6]==2)
_XX=$P_AXN2
ELSE
_XX=$P_AXN3
ENDIF
ENDIF
_AXNAME_X_E:
_AXNAME_Y_A:
IF($P_GG[6]==1)
_YY=$P_AXN2
ELSE
IF($P_GG[6]==2)
_YY=$P_AXN3
ELSE
_YY=$P_AXN1
ENDIF
ENDIF
_AXNAME_Y_E:
_AXNAME_Z_A:
IF($P_GG[6]==1)
_ZZ=$P_AXN3
ELSE
IF($P_GG[6]==2)
_ZZ=$P_AXN1
ELSE
_ZZ=$P_AXN2
ENDIF
ENDIF
_AXNAME_Z_E:
_C_LOESEN_A:
IF(_TRA2==4)OR(_TRA2==5)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
CUST_TECHCYC(2+_F_MASPI*10)
ELSE
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
IF(_TRA6==0)OR(S_MD_BREAK==0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF($P_SMODE[_F_S_NR[_F_MASPI]]<>4)AND($P_SMODE[_F_S_NR[_F_MASPI]]<>2)
CUST_TECHCYC(1+_F_MASPI*10)
ENDIF
ENDIF
_C_LOESEN_E:
_Y_LOESEN_A:
IF(_SC_CHAN_ST<>"")AND($P_SMODE[_F_S_NR[_F_MASPI]]==0)
STOPRE
GETD(_F_S_AX[_F_MASPI])
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
IF((((($AA_IW[_F_S_AX[_F_MASPI]])MOD 360)+360)MOD 360)<>(((_C0+$P_ACTFRAME[_F_S_AX[_F_MASPI],TR])MOD 360)+360)MOD 360)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)AND((((((_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1])MOD 360)+360)MOD 360)<>(((_C0+$P_ACTFRAME[_F_S_AX[_F_MASPI],TR])MOD 360)+360)MOD 360)OR((((_C0 MOD 360)+360)MOD 360)<>((($P_EP[_F_S_AX[_F_MASPI]]MOD 360)+360)MOD 360)))
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
IF($P_SMODE[_F_S_NR[_F_MASPI]]<>4)AND($P_SMODE[_F_S_NR[_F_MASPI]]<>2)
CUST_TECHCYC(1+_F_MASPI*10)
ENDIF
ENDIF
_Y_LOESEN_E:
_FEHL1: STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Alarm 61164 Transformation hat falschen Typ: "<<S_STRAL)
ENDIF
N934201 SETAL(61164,S_STRAL)
RET
_FEHL2: STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Alarm 61165 Transformation falsch eingerichtet: "<<S_STRAL)
ENDIF
N934202 SETAL(61164,S_STRAL)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SUB_SP_SPF
PROC F_SUB_SP(INT _MODE,INT _SDIR,REAL _S,REAL _A1,REAL _Z1,REAL _ZR,INT _ZRA,REAL _FR,REAL _F,INT _NPV,REAL _ZV,REAL _RTL,REAL _ZW,REAL _XP,REAL _ZP,REAL _BETA,INT _BETAA,REAL _GAMA,INT _GAMAA,INT S_ZVA,REAL S_ZVINK,INT _ST) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.21.00.00.001 ;DATE: 2022-07-29
;ShopTurn: Counterspindle
DEF AXIS _ZZ,_Z2,_CC
DEF INT _I,_MOSE1,_MOSE2,_MOSE3,_MOSE4,_MOSE5,_MOSE6,_MOSE7,_MOSE8,_MOSE9,_MOSE10,_NPV1,_NPVM,_WM,S_LS,S_FS,_MIZ_SSL_FA=0
DEF REAL _FAK1,_FAK2,_PULLER,_ROTEL,_MOVE_BP,_BASE,_GES_NPV,_ACT_NPV,_IFR_NPV,_CHUCK,_CHUCK2,_P29,_TRAN_Z2,_L3,_TRZ_SSL_FA=0
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_SUB_SP_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
;DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"_MODE="<<_MODE)
ENDIF
IF($P_GG[6]==1)
_ZZ=$P_AXN3
ELSE
IF($P_GG[6]==2)
_ZZ=$P_AXN1
ELSE
_ZZ=$P_AXN2
ENDIF
ENDIF
IF(_F_AX_EXISTS[3])
_Z2=_F_S_AX[3]
ENDIF
_F_RTL[0]=_E_RT[0,3]
IF((_MODE MOD 10)==5)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Hauptspindel (nur Fokus wechseln)")
ENDIF
REPEAT _VORDERSEITE_A2 _VORDERSEITE_E
GOTOF _RET
ENDIF
IF((_MODE MOD 10)==6)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Gegenspindel (nur Fokus wechseln)")
ENDIF
REPEAT _RUECKSEITE_A2 _RUECKSEITE_E
GOTOF _RET
ENDIF
IF((_MODE MOD 10)==7)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Synchronisieren")
ENDIF
REPEAT _MODUS_A _MODUS_E
REPEAT _SYNCHRONISIEREN_A _SYNCHRONISIEREN_E
GOTOF _RET
ENDIF
IF(_F_AX_EXISTS[3])AND(($SCS_TURN_FIXED_STOP_DIST==0)OR($SCS_TURN_FIXED_STOP_FEED==0)OR($SCS_TURN_FIXED_STOP_FORCE==0)) GOTOF _FEHL3
IF($MAS_SPINDLE_PARAMETER[0,_F_S_AX[6]]+$MAS_SPINDLE_PARAMETER[1,_F_S_AX[6]]+$MAS_SPINDLE_PARAMETER[2,_F_S_AX[6]]==0) GOTOF _FEHL4
IF((S_ZVA==2)AND(_F_AX_EXISTS[3]<>0))OR((S_ZVA<>2)AND(_F_AX_EXISTS[3]==0)) GOTOF _FEHL16
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_MOSE1>0)
N1000 F_SP_RP(7,,,1)
N1100 F_SP_BC(9)
ENDIF
_P29=$P_GG[29]
DIAMCYCOF
F_SP_TRA(2040)
IF(_MODE<0)
_NPV=_E_TR[10,0]
ENDIF
_CHUCK=($MAS_SPINDLE_PARAMETER[0,_F_S_AX[6]]+$MAS_SPINDLE_PARAMETER[1,_F_S_AX[6]])*_FAK2
_CHUCK=_CHUCK-$MAS_AXIS_MCS_POSITION[2,_F_S_AX[6]]*_FAK2
IF(_F_AX_EXISTS[8])
_CHUCK=_CHUCK-$MAS_AXIS_MCS_POSITION[2,_F_S_AX[8]]*_FAK2
ENDIF
_CHUCK2=($MAS_SPINDLE_PARAMETER[0,_F_S_AX[5]]+$MAS_SPINDLE_PARAMETER[1,_F_S_AX[5]])*_FAK2
_CHUCK2=_CHUCK2+$MAS_AXIS_MCS_POSITION[2,_F_S_AX[5]]*_FAK2
IF(_F_AX_EXISTS[7])
_CHUCK2=_CHUCK2+$MAS_AXIS_MCS_POSITION[2,_F_S_AX[7]]*_FAK2
ENDIF
_ROTEL=ABS(_F_RTL[0]-_F_RTL[1])*_FAK2
_NPV1=_NPV+1
_SET_ZTRANS_A:
_BASE=$P_SETFRAME[_ZZ,TR]*_FAK1
_BASE=_BASE+$P_ACTBFRAME[_ZZ,TR]*_FAK1
_IFR_NPV=$P_UIFR[$P_UIFRNUM,_ZZ,TR]*_FAK1
_ACT_NPV=$P_ACTFRAME[_ZZ,TR]*_FAK1
IF(_F_AX_EXISTS[3])
_TRAN_Z2=$P_ACTFRAME[_Z2,TR]*_FAK1
ENDIF
IF($MN_MM_FRAME_FINE_TRANS)
_BASE=_BASE+$P_SETFRAME[_ZZ,FI]*_FAK1
_BASE=_BASE+$P_ACTBFRAME[_ZZ,FI]*_FAK1
_IFR_NPV=_IFR_NPV+$P_UIFR[$P_UIFRNUM,_ZZ,FI]*_FAK1
_ACT_NPV=_ACT_NPV+$P_ACTFRAME[_ZZ,FI]*_FAK1
IF(_F_AX_EXISTS[3])
_TRAN_Z2=_TRAN_Z2+$P_ACTFRAME[_Z2,FI]*_FAK1
ENDIF
ENDIF
_GES_NPV=_IFR_NPV+_BASE
_SET_ZTRANS_E:
_A1=((_A1 MOD 360)+360) MOD 360
IF(_ZW<=0)AND(($SCS_SUB_SPINDLE_REL_POS<>0)OR($MAS_AXIS_MCS_POSITION[2,_F_S_AX[6]]<>0))
_ZW=$SCS_SUB_SPINDLE_REL_POS*_FAK1
ENDIF
WRTPR("NPVSET("<<_GES_NPV/_FAK2<<",6)",1)
S_LS=0
S_FS=2
_MODUS_A:
_MOSE1=_MODE MOD 10
_MOSE2=TRUNC(_MODE/10) MOD 10
_MOSE3=TRUNC(_MODE/100) MOD 10
_MOSE4=TRUNC(_MODE/1000) MOD 10
_MOSE5=TRUNC(_MODE/10000) MOD 10
_MOSE6=TRUNC(_MODE/100000) MOD 10
_MOSE7=TRUNC(_MODE/1000000) MOD 10
_MOSE8=TRUNC(_MODE/10000000) MOD 10
_MOSE9=TRUNC(_MODE/100000000) MOD 10
_MOSE10=TRUNC(_MODE/1000000000) MOD 10
IF(($MCS_FUNCTION_MASK_TURN B_AND 'H8000')==0)
IF(_MOSE1==3)AND(S_ZVA==0)
_MOSE7=1
ENDIF
ENDIF
IF(_ST B_AND 'H0001')AND(_NPV==0)
_MOSE7=1
ENDIF
IF(_MOSE1==8)
IF(_MOSE9==1)
_MOSE1=2
ELSE
_MOSE1=3
ENDIF
ENDIF
IF(_MOSE9==1)
IF(_MOSE1==0)OR(_MOSE1==1)OR(_MOSE1==4)
S_LS=2
S_FS=0
ENDIF
ENDIF
IF(_MOSE1<>4)OR(_SDIR<>5)
_MOSE8=0
ENDIF
IF(_SDIR==5)
_F_SUB_STA=_F_SUB_STA B_AND (B_NOT 'H0010')
ELSE
_F_SUB_STA=_F_SUB_STA B_OR 'H0010'
ENDIF
IF(_MOSE9==1)
_F_SUB_STA=_F_SUB_STA B_OR 'H0020'
ELSE
_F_SUB_STA=_F_SUB_STA B_AND (B_NOT 'H0020')
ENDIF
_MODUS_E:
CASE _MOSE1 OF 0 GOTOF _M0 1 GOTOF _M1 2 GOTOF _M2 3 GOTOF _M3 4 GOTOF _M4 7 GOTOF _M7 -3 GOTOF _M_3 -4 GOTOF _M_4 DEFAULT GOTOF _MEND
_M0:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_M0: Greifen")
ENDIF
_GREIFEN_A:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_GREIFEN_A")
ENDIF
IF(_SC_CHAN_ST<>"")
_WM=107
REPEAT _SYNC_A _SYNC_E
ENDIF
IF(_F_AX_EXISTS[3]==0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"GOTOF _GREIFEN_E1")
ENDIF
GOTOF _GREIFEN_E1
ENDIF
IF(S_LS==0)AND(_F_NPV[0]<0) GOTOF _FEHL7
IF(S_LS==2)AND(_F_NPV[1]<0) GOTOF _FEHL8
IF(_F_NPV[S_LS/2]>=0)AND(_F_MASPI<>S_LS)
_NPVM=_NPV
_NPV=_F_NPV[S_LS/2]
IF(S_LS==2)
REPEAT _RUECKSEITE_A2 _RUECKSEITE_E
ELSE
REPEAT _VORDERSEITE_A2 _VORDERSEITE_E
ENDIF
REPEAT _SET_ZTRANS_A _SET_ZTRANS_E
_NPV=_NPVM
ENDIF
IF(_F_S_NR[1]==$P_MSNUM)
M5
ELSE
IF(_SDIR==5)
M5
ENDIF
ENDIF
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
IF(_BETAA==2)
_BETA=_SC_A_NO_VAL
ENDIF
IF(_GAMAA==0)
_GAMA=_SC_A_NO_VAL
ENDIF
;IF(_BETAA<>2)OR(_GAMAA<>0)
F_SP_BC(4,_BETA,_GAMA)
;ENDIF
ENDIF
IF(_E_S_LINE==0)
IF(_XP==0)AND(_ZP==0)
N1010 F_SP_RP(1,,,1)
ELSE
IF(_MOSE6)
N1011 F_SP_RP(6,_XP,_ZP,1)
ELSE
N1012 F_SP_RP(5,_XP,_ZP,1)
ENDIF
ENDIF
ENDIF
IF(S_LS==2)
IF(_NPV>0)AND((ABS(_MOSE1)<>4)OR(_MOSE7==0))
_PULLER=_GES_NPV-_CHUCK2-_Z1
$P_UIFR[_NPV,_ZZ,TR]=(_IFR_NPV-_PULLER)/_FAK1
$P_UIFR[_NPV,_ZZ,MI]=1
IF($MN_MM_FRAME_FINE_TRANS)
$P_UIFR[_NPV,_ZZ,FI]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"NPV beschreiben (001)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,TR]<<" (TR)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,MI]<<" (MI)")
ENDIF
_NPV1=_NPV+1
G[8]=_NPV1
D=$P_TOOL
IF(_F_AX_EXISTS[3])
_TRAN_Z2=$P_ACTFRAME[_Z2,TR]*_FAK1
IF($MN_MM_FRAME_FINE_TRANS)
_TRAN_Z2=_TRAN_Z2+$P_ACTFRAME[_Z2,FI]*_FAK1
ENDIF
ENDIF
ENDIF
IF(_MOSE4)AND(_MOSE7)
_PULLER=_GES_NPV-_CHUCK2-_Z1
$P_SETFRAME=$P_SETFRAME:CTRANS(_ZZ,-_PULLER/_FAK1)
ENDIF
IF($MNS_FUNCTION_MASK_SIM B_AND 'H4000000')
_GES_NPV=-_GES_NPV
_CHUCK2=-_CHUCK2
ENDIF
IF($MN_SIM_ENVIRONMENT B_AND 'B100')
_CHUCK=$AA_IM[_Z2]*_FAK1-_GES_NPV+_CHUCK2
ELSE
_CHUCK=$P_EPM[_Z2]*_FAK1-_GES_NPV+_CHUCK2
ENDIF
IF($MNS_FUNCTION_MASK_SIM B_AND 'H4000000')
_CHUCK=-_CHUCK
ENDIF
_GES_NPV=0
ENDIF
IF(_ZRA<>90)
_ZR=_Z1+ABS(_ZR)
ENDIF
IF(($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_LS])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_LS])] B_AND 'B010000' == 'B010000'))OR(($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_FS])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_FS])] B_AND 'B010000' == 'B010000'))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"GOTOF _TESTLAUF1")
ENDIF
GOTOF _TESTLAUF1
ENDIF
IF(_SDIR==5)
CUST_TECHCYC(7+10*S_FS)
ELSE
CUST_TECHCYC(8+10*S_FS)
ENDIF
SETMS(_F_S_NR[S_LS])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Spindelkopplung: N500 CUST_TECHCYC("<<(120+S_LS)<<") Definition: Kopplung Gegen-/Hauptspindel")
ENDIF
N500 CUST_TECHCYC(120+S_LS)
G95 S=_S
IF(ABS($AA_S[_F_S_NR[S_LS]])>_S)
WAITS
ENDIF
IF(_MOSE8)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Spindel klemmen: A1="<<_A1)
ENDIF
SPOS[_F_S_NR[S_LS]]=0
SPOS[_F_S_NR[S_FS]]=_A1
CUST_TECHCYC(3+S_LS/2*20)
_F_NCK_CL_STATE[_F_MA_AX_NR[S_LS]-1]=1
_CC=_F_S_AX[S_LS]
_F_NCK_CL_ANG[_F_MA_AX_NR[S_LS]-1]=0+$P_ACTFRAME[_CC,TR]
CUST_TECHCYC(3+S_FS/2*20)
_F_NCK_CL_STATE[_F_MA_AX_NR[S_FS]-1]=1
_CC=_F_S_AX[S_FS]
_F_NCK_CL_ANG[_F_MA_AX_NR[S_FS]-1]=_A1+$P_ACTFRAME[_CC,TR]
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Spindelkopplung: N501 COUPON("<<_F_S_NR[S_FS]<<","<<_F_S_NR[S_LS]<<","<<_A1<<")")
ENDIF
N501 COUPON(SPI(_F_S_NR[S_FS]),SPI(_F_S_NR[S_LS]),_A1)
ENDIF
FIXTURE(,,,"CHUCK_ACTION",1+S_FS/2,1)
;WRTPR("CHUCK(1+S_FS/2,1)",1)
IF(_SDIR<>5)
M=_SDIR S=_S
ELSE
M5
ENDIF
IF(_MOSE3)
CUST_TECHCYC(5+10*S_FS)
ENDIF
IF($MNS_FUNCTION_MASK_SIM B_AND 'H4000000')
$P_CYCFRAME[_Z2,MI]=1
ENDIF
SBLON
IF(_MOSE2==0)OR(_ZR>_Z1+$SCS_TURN_FIXED_STOP_DIST*_FAK1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N21 G0 Z2=AC("<<_ZR+_CHUCK+_GES_NPV-_TRAN_Z2<<")")
ENDIF
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N20 G0 POS[_Z2]=AC(_ZR+_CHUCK+_GES_NPV-_TRAN_Z2)
ELSE
N21 G0 AX[_Z2]=AC(_ZR+_CHUCK+_GES_NPV-_TRAN_Z2)
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N31 G0 Z2=AC("<<_Z1+$SCS_TURN_FIXED_STOP_DIST*_FAK1+_CHUCK+_GES_NPV-_TRAN_Z2<<")")
ENDIF
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N30 G0 POS[_Z2]=AC(_Z1+$SCS_TURN_FIXED_STOP_DIST*_FAK1+_CHUCK+_GES_NPV-_TRAN_Z2)
ELSE
N31 G0 AX[_Z2]=AC(_Z1+$SCS_TURN_FIXED_STOP_DIST*_FAK1+_CHUCK+_GES_NPV-_TRAN_Z2)
ENDIF
ENDIF
SBLOF
IF(_MOSE8==0)
WAITC(_F_S_AX[S_FS],"FINE")
ENDIF
G4F0
IF(_MOSE2)AND(NOT $P_ISTEST)AND(NOT $P_DRYRUN)AND(NOT $P_SEARCH)AND(NOT $AC_SERUPRO)AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100'))
SBLON
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N41 G1 G94 F"<<_FR<<" Z2=AC("<<_Z1+$SCS_TURN_FIXED_STOP_DIST*_FAK1+_CHUCK+_GES_NPV-_TRAN_Z2<<")")
ENDIF
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N40 G1 G94 FA[_Z2]=_FR POS[_Z2]=AC(_Z1+$SCS_TURN_FIXED_STOP_DIST*_FAK1+_CHUCK+_GES_NPV-_TRAN_Z2)
ELSE
N41 G1 G94 F=_FR AX[_Z2]=AC(_Z1+$SCS_TURN_FIXED_STOP_DIST*_FAK1+_CHUCK+_GES_NPV-_TRAN_Z2)
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N51 G1 G94 F"<<$SCS_TURN_FIXED_STOP_FEED<<" FXS[Z2]=1 FXST[Z2]="<<$SCS_TURN_FIXED_STOP_FORCE<<" FXSW[Z2]="<<$SCS_TURN_FIXED_STOP_DIST*_FAK1<<" Z2=AC("<<_Z1-$SCS_TURN_FIXED_STOP_DIST*_FAK1+_CHUCK+_GES_NPV-_TRAN_Z2<<")")
ENDIF
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N50 G1 G94 FA[_Z2]=$SCS_TURN_FIXED_STOP_FEED FXS[_Z2]=1 FXST[_Z2]=$SCS_TURN_FIXED_STOP_FORCE FXSW[_Z2]=$SCS_TURN_FIXED_STOP_DIST*_FAK1 POS[_Z2]=AC(_Z1-$SCS_TURN_FIXED_STOP_DIST*_FAK1+_CHUCK+_GES_NPV-_TRAN_Z2)
ELSE
N51 G1 G94 F=$SCS_TURN_FIXED_STOP_FEED FXS[_Z2]=1 FXST[_Z2]=$SCS_TURN_FIXED_STOP_FORCE FXSW[_Z2]=$SCS_TURN_FIXED_STOP_DIST*_FAK1 AX[_Z2]=AC(_Z1-$SCS_TURN_FIXED_STOP_DIST*_FAK1+_CHUCK+_GES_NPV-_TRAN_Z2)
ENDIF
IF($AA_FXS[_Z2]==2)
STOPRE
FXS[_Z2]=0
N934402 SETAL(61254)
RET
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N61 G1 G94 F"<<$SCS_TURN_FIXED_STOP_FEED<<" FXS[Z2]=0 Z2=IC("<<$SCS_TURN_FIXED_STOP_RETRACTION*_FAK1<<")")
ENDIF
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N60 G1 G94 FA[_Z2]=$SCS_TURN_FIXED_STOP_FEED FXS[_Z2]=0 POS[_Z2]=IC($SCS_TURN_FIXED_STOP_RETRACTION*_FAK1)
ELSE
N61 G1 G94 F=$SCS_TURN_FIXED_STOP_FEED FXS[_Z2]=0 AX[_Z2]=IC($SCS_TURN_FIXED_STOP_RETRACTION*_FAK1)
ENDIF
SBLOF
ELSE
SBLON
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N71 G1 G94 F"<<_FR<<" Z2=AC("<<_Z1+_CHUCK+_GES_NPV-_TRAN_Z2<<")")
ENDIF
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N70 G1 G94 FA[_Z2]=_FR POS[_Z2]=AC(_Z1+_CHUCK+_GES_NPV-_TRAN_Z2)
ELSE
N71 G1 G94 F=_FR AX[_Z2]=AC(_Z1+_CHUCK+_GES_NPV-_TRAN_Z2)
ENDIF
SBLOF
ENDIF
IF($MNS_FUNCTION_MASK_SIM B_AND 'H4000000')
$P_CYCFRAME[_Z2,MI]=0
ENDIF
CUST_TECHCYC(6+10*S_FS)
IF(_MOSE3)
CUST_TECHCYC(9+10*S_FS)
ENDIF
FIXTURE(,,,"CHUCK_ACTION",1+S_FS/2,0)
;WRTPR("CHUCK(1+S_FS/2,0)",1)
WRTPR("NPVSET("<<_Z1/_FAK2<<",8)",1)
_TESTLAUF1:
IF(NOT $P_SEARCH)AND(NOT $AC_SERUPRO)AND(NOT $P_ISTEST)AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100'))AND(_MOSE8==0)
_F_SUB_ANG=$VA_COUP_OFFS[_F_S_AX[S_FS]]
ELSE
_F_SUB_ANG=_A1
ENDIF
_F_SUB_FAN=_MOSE2
_F_SUB_GRP=_Z1/_FAK2
_F_SUB_STA=_F_SUB_STA B_OR 'H0001'
IF(S_LS==2)
_F_SUB_STA=_F_SUB_STA B_OR 'H0004'
ENDIF
IF(_F_NPV[S_LS/2]<0)
_F_NPV[S_LS/2]=$P_UIFRNUM
ENDIF
_GREIFEN_E1:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_GREIFEN_E")
ENDIF
_GREIFEN_E:
IF(_SC_CHAN_ST<>"")
_NPV=-1
REPEAT _SET_NPV_A _SET_NPV_E
ENDIF
GOTOF _MEND
_M1:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_M1: Ziehen")
ENDIF
IF(_SC_CHAN_ST<>"")
_WM=107
REPEAT _SYNC_A _SYNC_E
ENDIF
_PULLER=_Z1
_ZIEHEN_A:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_ZIEHEN_A")
WRITE(_LOG,_LOG_FILE,"  _PULLER="<<_PULLER)
ENDIF
IF(_F_AX_EXISTS[3]==0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"GOTOF _ZIEHEN_E")
ENDIF
GOTOF _ZIEHEN_E
ENDIF
IF(($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_LS])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_LS])] B_AND 'B010000' == 'B010000'))OR(($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_FS])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_FS])] B_AND 'B010000' == 'B010000'))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"GOTOF _TESTLAUF2")
ENDIF
GOTOF _TESTLAUF2
ENDIF
IF($P_SDIR[_F_S_NR[S_LS]]==5)
CUST_TECHCYC(7+10*S_LS)
ELSE
CUST_TECHCYC(8+10*S_LS)
ENDIF
FIXTURE(,,,"CHUCK_ACTION",1+S_LS/2,1)
;WRTPR("CHUCK(1+S_LS/2,1)",1)
IF($MNS_FUNCTION_MASK_SIM B_AND 'H4000000')
$P_CYCFRAME[_Z2,MI]=1
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N81 G1 G94 F"<<_F<<" Z2=IC("<<_PULLER<<")")
ENDIF
SBLON
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N80 G1 G94 FA[_Z2]=_F POS[_Z2]=IC(_PULLER)
ELSE
N81 G1 G94 F=_F AX[_Z2]=IC(_PULLER)
ENDIF
SBLOF
IF($MNS_FUNCTION_MASK_SIM B_AND 'H4000000')
$P_CYCFRAME[_Z2,MI]=0
ENDIF
CUST_TECHCYC(6+10*S_LS)
_TESTLAUF2:
IF(_NPV>0)AND((ABS(_MOSE1)<>4)OR(_MOSE7==0))AND NOT((ABS(_MOSE1)==4)AND(S_LS==2))
WRTPR("NPVSET("<<_PULLER/_FAK2<<",0)",1)
WRTPR("NPVSET("<<(_GES_NPV+_PULLER)/_FAK2<<",6)",1)
IF((($P_SEARCH)OR($AC_SERUPRO))AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100')))AND(_F_SUB_FAN)AND($P_UIFR[_NPV,_ZZ,MI]==0)AND(ABS($P_UIFR[_NPV,_ZZ,TR]*_FAK1-(_IFR_NPV+_PULLER+_ZW-$P_EPM[_Z2]*_FAK1+_ZV))<=2*$SCS_TURN_FIXED_STOP_DIST*_FAK1)
ELSE
IF((($P_SEARCH)OR($AC_SERUPRO))AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100')))AND(_F_SUB_FAN)
_TRZ_SSL_FA=$P_UIFR[_NPV,_ZZ,TR]
_MIZ_SSL_FA=$P_UIFR[_NPV,_ZZ,MI]
_E_TR[1,1]=_TRZ_SSL_FA
_E_TR[2,1]=_MIZ_SSL_FA
ENDIF
IF(S_LS==2)
$P_UIFR[_NPV,_ZZ,TR]=(_IFR_NPV+_PULLER)/_FAK1
$P_UIFR[_NPV,_ZZ,MI]=1
IF($MN_MM_FRAME_FINE_TRANS)
$P_UIFR[_NPV,_ZZ,FI]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"NPV beschreiben (002)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,TR]<<" (TR)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,MI]<<" (MI)")
ENDIF
ELSE
$P_UIFR[_NPV,_ZZ,TR]=(_IFR_NPV+_PULLER)/_FAK1
$P_UIFR[_NPV,_ZZ,MI]=0
IF($MN_MM_FRAME_FINE_TRANS)
$P_UIFR[_NPV,_ZZ,FI]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"NPV beschreiben (003)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,TR]<<" (TR)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,MI]<<" (MI)")
ENDIF
ENDIF
_NPV1=_NPV+1
G[8]=_NPV1
_F_NPV[S_LS/2]=_NPV
D=$P_TOOL
ENDIF
ENDIF
FIXTURE(,,,"CHUCK_ACTION",1+S_LS/2,0)
;WRTPR("CHUCK(1+S_LS/2,0)",1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_ZIEHEN_E")
ENDIF
_ZIEHEN_E:
IF(_SC_CHAN_ST<>"")
REPEAT _SET_NPV_A _SET_NPV_E
ENDIF
GOTOF _MEND
_M2:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_M2: Rueckseite")
ENDIF
IF(_F_SUB_STA B_AND 'H0004')
S_LS=2
S_FS=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  LS="<<S_LS<<" FS="<<S_FS)
ENDIF
IF(_SC_CHAN_ST<>"")
_WM=107
REPEAT _SYNC_A _SYNC_E
IF(_SC_NCK_NPV[0]<>-99)AND(_SC_NCK_NPV[5]==2)
_F_SUBSP=_SC_NCK_NPV[5]
ENDIF
ENDIF
IF(_F_MASPI==S_LS)AND((_F_RP_DIR[0]==1)OR(_F_RP_DIR[0]==2)OR(_F_RP_DIR[0]==-1))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  N200 auf WWP fahren, wegen Wechsel der Masterspindel")
ENDIF
N200 F_SP_RP(1,,,1)
ENDIF
IF((_F_SUB_STA B_AND 'H0001')==0)AND($P_UIFR[$P_UIFRNUM,_ZZ,MI]==0)
S_ZVINK=$MAS_AXIS_MCS_POSITION[2,_F_S_AX[6]]*_FAK2-(_ACT_NPV-_IFR_NPV)-_E_RT[0,6]*_FAK2+S_ZVINK
IF(S_ZVA)AND(_MOSE7==0)
S_ZVINK=S_ZVINK-_ZV
ELSE
S_ZVINK=S_ZVINK-$P_UIFR[_NPV,_ZZ,TR]*_FAK1
ENDIF
WRTPR("NPVSET("<<S_ZVINK/_FAK2<<",10)",1)
ENDIF
_RUECKSEITE_A:
IF(_F_AX_EXISTS[3]==0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"GOTOF _RUECKSEITE_A1")
ENDIF
GOTOF _RUECKSEITE_A1
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_RUECKSEITE_A")
ENDIF
IF($AA_AX_DISABLE_SRC[SPI(_F_S_NR[2])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[2])] B_AND 'B010000' == 'B010000')
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"GOTOF _TESTLAUF3")
ENDIF
GOTOF _TESTLAUF3
ENDIF
IF(_MOSE1<>-4)AND(_F_SUB_STA B_AND 'H0001')AND(_F_SUBSP<>2)
IF($P_SDIR[_F_S_NR[S_LS]]==5)
CUST_TECHCYC(7)
ELSE
CUST_TECHCYC(8)
ENDIF
FIXTURE(,,,"CHUCK_ACTION",1,1)
;WRTPR("CHUCK(1,1)",1)
ENDIF
IF(_MOSE1<>-4)
IF($P_SEARCH)OR($AC_SERUPRO)
_MOVE_BP=_ZW-$P_EPM[_Z2]*_FAK1
ELSE
_MOVE_BP=_ZW-$AA_IM[_Z2]*_FAK1
ENDIF
ELSE
_MOVE_BP=_ZW-_E_TR[16,0]
ENDIF
IF(($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_LS])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_LS])] B_AND 'B010000' == 'B010000'))OR(($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_FS])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_FS])] B_AND 'B010000' == 'B010000'))
_MOVE_BP=_ZW-(_Z1+_CHUCK+_GES_NPV)
ENDIF
IF($MNS_FUNCTION_MASK_SIM B_AND 'H4000000')
_MOVE_BP=-_MOVE_BP
ENDIF
IF(ABS(_MOSE1)==4)AND(_MOVE_BP<2*_E_SC*_FAK2) GOTOF _FEHL17
WORKPIECE(,,,"SET_FOCUS",2)
REPEAT S_Z2_GO_A S_Z2_GO_E
IF(_MOSE8)AND(_MOSE1<>-4)
CUST_TECHCYC(4)
_F_NCK_CL_STATE[_F_MA_AX_NR[0]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[0]-1]=_SC_A_NO_VAL
CUST_TECHCYC(4+20)
_F_NCK_CL_STATE[_F_MA_AX_NR[2]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[2]-1]=_SC_A_NO_VAL
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Spindelkopplung: N502 CUST_TECHCYC("<<(121+S_LS)<<") Definition lschen: Kopplung")
ENDIF
N502 CUST_TECHCYC(121+S_LS)
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Spindelkopplung: N503 COUPOF("<<_F_S_NR[S_FS]<<","<<_F_S_NR[S_LS]<<")")
ENDIF
N503 COUPOF(SPI(_F_S_NR[S_FS]),SPI(_F_S_NR[S_LS]))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Spindelkopplung: N504 CUST_TECHCYC("<<(121+S_LS)<<") Definition lschen: Kopplung")
ENDIF
N504 CUST_TECHCYC(121+S_LS)
M5
ENDIF
_TESTLAUF3:
IF(_F_SUB_STA B_AND 'H0001')
$P_PFRAME[_F_S_AX[2],TR]=$P_PFRAME[_F_S_AX[0],TR]
ENDIF
IF(_F_SUB_STA B_AND 'H0001')
WRTPR("NPVSET("<<_ZV/_FAK2<<",4)",1)
IF((($P_SEARCH)OR($AC_SERUPRO))AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100')))AND(_F_SUB_FAN)AND(_TRZ_SSL_FA<>0)
$P_UIFR[_NPV,_ZZ,TR]=_TRZ_SSL_FA
$P_UIFR[_NPV,_ZZ,MI]=_MIZ_SSL_FA
IF($MN_MM_FRAME_FINE_TRANS)
$P_UIFR[_NPV,_ZZ,FI]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"NPV beschreiben (004)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,TR]<<" (TR)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,MI]<<" (MI)")
ENDIF
ENDIF
IF((($P_SEARCH)OR($AC_SERUPRO))AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100')))AND(_F_SUB_FAN)AND($P_UIFR[_NPV,_ZZ,MI])AND(ABS($P_UIFR[_NPV,_ZZ,TR]*_FAK1-(_IFR_NPV+_MOVE_BP+_ZV))<=2*$SCS_TURN_FIXED_STOP_DIST*_FAK1)
ELSE
IF(_MOSE7==0)
$P_UIFR[_NPV,_ZZ,TR]=(_IFR_NPV+_MOVE_BP+_ZV)/_FAK1
IF($MN_MM_FRAME_FINE_TRANS)
$P_UIFR[_NPV,_ZZ,FI]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"NPV beschreiben (005)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,TR]<<" (TR)")
ENDIF
ENDIF
$P_UIFR[_NPV,_ZZ,MI]=1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,MI]<<" (MI)")
ENDIF
$P_UIFR[_NPV,_F_S_AX[2],TR]=_F_SUB_ANG
ENDIF
WRTPR("NPVSET("<<(_MOVE_BP+_ZV)/_FAK2<<",1)",1)
WRTPR("NPVSET("<<(_GES_NPV+_MOVE_BP+_ZV)/_FAK2<<",6)",1)
ELSE
WRTPR("NPVSET("<<(_F_RTL[1]-_F_RTL[0])<<",4)",1)
IF(_MOSE7==1)
IF($P_UIFR[_NPV,_ZZ,MI]==0) GOTOF _FEHL6
ENDIF
WRTPR("SUBSPOS(1,"<<_ZW/_FAK2<<")",1)
WRTPR("NPVSET("<<($P_UIFR[_NPV,_ZZ,TR]*_FAK1-_IFR_NPV)/_FAK2<<",1)",1)
WRTPR("NPVSET("<<(_GES_NPV+($P_UIFR[_NPV,_ZZ,TR]*_FAK1-_IFR_NPV))/_FAK2<<",6)",1)
IF(_MOSE7==0)AND(_F_MASPI==2)AND(_F_SUB_STA B_AND 'H0008')
$P_UIFR[_NPV,_ZZ,TR]=(_IFR_NPV+_MOVE_BP+_ZV)/_FAK1
IF($MN_MM_FRAME_FINE_TRANS)
$P_UIFR[_NPV,_ZZ,FI]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"NPV beschreiben (006)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,TR]<<" (TR)")
ENDIF
ENDIF
ENDIF
IF($MN_SIM_ENVIRONMENT B_AND 'B100')AND(_MOSE7)
IF(_F_NPV_SET[1])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"GOTOF _RUECKSEITE_A1")
ENDIF
GOTOF _RUECKSEITE_A1
ENDIF
_L3=($MAS_SPINDLE_PARAMETER[0,_F_S_AX[6]]+$MAS_SPINDLE_PARAMETER[1,_F_S_AX[6]])*_FAK2
IF($MAS_SPINDLE_CHUCK_TYPE[_F_S_AX[6]])AND(NOT(_F_SUB_STA B_AND 'H0001'))
_L3=_L3+$MAS_SPINDLE_PARAMETER[2,_F_S_AX[6]]*_FAK2
ENDIF
IF(_F_SUB_STA B_AND 'H0001')
IF(_MOSE1==-4)OR(_F_SUB_STA B_AND 'H0002')
_L3=_L3+ABS(_F_SUB_CUT-_F_SUB_GRP)*_FAK2
ELSE
_L3=_L3+ABS(_E_RT[0,6]*_FAK2-_Z1)
ENDIF
ELSE
IF(_E_RT[1,0]>0)AND($ON_HMI_FUNCTION_MASK[0] B_AND 'H0008')
_L3=_L3+ABS(_E_RT[1,7]*_FAK2)
ELSE
IF(_E_RT[0,0]>0)
_L3=($MAS_SPINDLE_PARAMETER[0,_F_S_AX[6]]+$MAS_SPINDLE_PARAMETER[1,_F_S_AX[6]])*_FAK2
IF($MAS_SPINDLE_CHUCK_TYPE[_F_S_AX[6]])
_L3=_L3+$MAS_SPINDLE_PARAMETER[2,_F_S_AX[6]]*_FAK2
ENDIF
_L3=_L3+ABS(_E_RT[0,3]-_E_RT[0,7])*_FAK2
ENDIF
ENDIF
ENDIF
_L3=_L3+_BASE
$P_UIFR[_NPV,_ZZ,TR]=$AA_IM[_Z2]-_L3/_FAK1+$MAS_AXIS_MCS_POSITION[2,_F_S_AX[6]]
$P_UIFR[_NPV,_ZZ,MI]=1
IF($MN_MM_FRAME_FINE_TRANS)
$P_UIFR[_NPV,_ZZ,FI]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"NPV beschreiben (007)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,TR]<<" (TR)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,MI]<<" (MI)")
ENDIF
IF(_F_AX_EXISTS[8])
$P_UIFR[_NPV,_ZZ,TR]=$P_UIFR[_NPV,_ZZ,TR]+$MAS_AXIS_MCS_POSITION[2,_F_S_AX[8]]
ENDIF
ELSE
IF($MN_SIM_ENVIRONMENT B_AND 'B100')AND(($ON_HMI_FUNCTION_MASK[0] B_AND 'H0008')==0)AND((_F_SUB_STA B_AND 'H0001')==0)
IF(_E_RT[0,0]>0)
_L3=($MAS_SPINDLE_PARAMETER[0,_F_S_AX[6]]+$MAS_SPINDLE_PARAMETER[1,_F_S_AX[6]])*_FAK2
IF($MAS_SPINDLE_CHUCK_TYPE[_F_S_AX[6]])
_L3=_L3+$MAS_SPINDLE_PARAMETER[2,_F_S_AX[6]]*_FAK2
ENDIF
_L3=_L3+ABS(_E_RT[0,3]-_E_RT[0,7])*_FAK2
ENDIF
_L3=_L3+_BASE
$P_UIFR[_NPV,_ZZ,TR]=$P_EPM[_Z2]-_L3/_FAK1+$MAS_AXIS_MCS_POSITION[2,_F_S_AX[6]]
$P_UIFR[_NPV,_ZZ,MI]=1
IF($MN_MM_FRAME_FINE_TRANS)
$P_UIFR[_NPV,_ZZ,FI]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"NPV beschreiben (008)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,TR]<<" (TR)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,MI]<<" (MI)")
ENDIF
IF(_F_AX_EXISTS[8])
$P_UIFR[_NPV,_ZZ,TR]=$P_UIFR[_NPV,_ZZ,TR]+$MAS_AXIS_MCS_POSITION[2,_F_S_AX[8]]
ENDIF
ENDIF
ENDIF
_RUECKSEITE_A1:
IF(S_ZVA)AND(_MOSE7==0)
IF($MCS_FUNCTION_MASK_TECH B_AND 'B1000000') GOTOF _FEHL15
$P_UIFR[_NPV,_ZZ,TR]=_ZV/_FAK1
$P_UIFR[_NPV,_ZZ,MI]=1
IF($MN_MM_FRAME_FINE_TRANS)
$P_UIFR[_NPV,_ZZ,FI]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"NPV beschreiben (009)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,TR]<<" (TR)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,MI]<<" (MI)")
ENDIF
ENDIF
IF($MCS_FUNCTION_MASK_TURN B_AND 'H8000')
IF(_MOSE1==2)AND(S_ZVA==0)
IF(_MOSE7==0)
$P_UIFR[_NPV,_ZZ,TR]=(_IFR_NPV+_MOVE_BP+_ZV)/_FAK1
$P_UIFR[_NPV,_ZZ,MI]=1
IF($MN_MM_FRAME_FINE_TRANS)
$P_UIFR[_NPV,_ZZ,FI]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"NPV beschreiben (010)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,TR]<<" (TR)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,MI]<<" (MI)")
ENDIF
ENDIF
ENDIF
ENDIF
_F_SUBSP=0
_F_SUB_STA=8
_F_SUB_ANG=0
_F_SUB_GRP=0
_F_SUB_FAN=0
_RUECKSEITE_A2:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_RUECKSEITE_A2")
ENDIF
SETMS(_F_S_NR[2])
_F_MASPI=2
IF(_NPV<0) GOTOF _FEHL8
IF($P_UIFR[_NPV,_ZZ,MI]==0) GOTOF _FEHL6
_NPV1=_NPV+1
G[8]=_NPV1
_F_NPV[1]=_NPV
D=$P_TOOL
WORKPIECE(,,,"SET_FOCUS",2)
_F_TCP[0]=_F_TCP_M[1,0]
_F_TCP[1]=_F_TCP_M[1,1]
_F_TCP[2]=_F_TCP_M[1,2]
CUST_TECHCYC(126)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_RUECKSEITE_E")
ENDIF
_RUECKSEITE_E:
IF(_SC_CHAN_ST<>"")
REPEAT _SET_NPV_A _SET_NPV_E
ENDIF
GOTOF _MEND
_M3:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_M3: Vorderseite")
ENDIF
IF(_F_SUB_STA B_AND 'H0004')
S_LS=2
S_FS=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  LS="<<S_LS<<" FS="<<S_FS)
ENDIF
IF(_SC_CHAN_ST<>"")
_WM=107
REPEAT _SYNC_A _SYNC_E
ENDIF
IF(_F_MASPI==S_FS)AND((_F_RP_DIR[0]==1)OR(_F_RP_DIR[0]==2)OR(_F_RP_DIR[0]==-1))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  N300 auf WWP fahren, wegen Wechsel der Masterspindel")
ENDIF
N300 F_SP_RP(1,,,1)
ENDIF
_VORDERSEITE_A:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_VORDERSEITE_A")
ENDIF
IF(_F_AX_EXISTS[3]==0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"GOTOF _VORDERSEITE_A1")
ENDIF
GOTOF _VORDERSEITE_A1
ENDIF
IF(_F_MASPI==2)AND(_F_SUB_STA B_AND 'H0001')AND((_F_SUB_STA B_AND 'H0004')==0)
WRTPR("NPVSET(0,2)",1)
ELSE
WRTPR("NPVSET(0,11)",1)
ENDIF
IF($AA_AX_DISABLE_SRC[SPI(_F_S_NR[0])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[0])] B_AND 'B010000' == 'B010000')
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"GOTOF _TESTLAUF4")
ENDIF
GOTOF _TESTLAUF4
ENDIF
IF(_F_SUB_STA B_AND 'H0001')AND((_F_SUB_STA B_AND 'H0004')OR(_MOSE10))AND(_MOSE1<>-4)AND(_F_SUBSP<>2)
IF($P_SDIR[_F_S_NR[S_LS]]==5)
CUST_TECHCYC(27)
ELSE
CUST_TECHCYC(28)
ENDIF
FIXTURE(,,,"CHUCK_ACTION",2,1)
;WRTPR("CHUCK(2,1)",1)
ENDIF
IF(_MOSE10)OR((ABS(_MOSE1)==4)AND(_MOSE9==1))
REPEAT S_Z2_GO_A S_Z2_GO_E
ENDIF
IF(_F_SUB_STA B_AND 'H0001')AND((_MOSE10)OR((ABS(_MOSE1)==4)AND(_MOSE9==1)))
IF(_MOSE8)AND(_MOSE1<>-4)
CUST_TECHCYC(4)
_F_NCK_CL_STATE[_F_MA_AX_NR[0]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[0]-1]=_SC_A_NO_VAL
CUST_TECHCYC(4+20)
_F_NCK_CL_STATE[_F_MA_AX_NR[2]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[2]-1]=_SC_A_NO_VAL
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Spindelkopplung: N505 CUST_TECHCYC("<<(121+S_LS)<<") Definition lschen: Kopplung")
ENDIF
N505 CUST_TECHCYC(121+S_LS)
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Spindelkopplung: N506 COUPOF("<<_F_S_NR[S_FS]<<","<<_F_S_NR[S_LS]<<")")
ENDIF
N506 COUPOF(SPI(_F_S_NR[S_FS]),SPI(_F_S_NR[S_LS]))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Spindelkopplung: N507 CUST_TECHCYC("<<(121+S_LS)<<") Definition lschen: Kopplung")
ENDIF
N507 CUST_TECHCYC(121+S_LS)
M5
M[_F_S_NR[S_FS]]=5
ENDIF
ENDIF
IF(_F_SUB_STA B_AND 'H0001')
$P_PFRAME[_F_S_AX[0],TR]=$P_PFRAME[_F_S_AX[2],TR]
ENDIF
IF(_F_SUB_STA B_AND 'H0004')
IF((($P_SEARCH)OR($AC_SERUPRO))AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100')))AND(_F_SUB_FAN)AND(_TRZ_SSL_FA<>0)
$P_UIFR[_NPV,_ZZ,TR]=_TRZ_SSL_FA
$P_UIFR[_NPV,_ZZ,MI]=_MIZ_SSL_FA
IF($MN_MM_FRAME_FINE_TRANS)
$P_UIFR[_NPV,_ZZ,FI]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"NPV beschreiben (011)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,TR]<<" (TR)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,MI]<<" (MI)")
ENDIF
ENDIF
IF((($P_SEARCH)OR($AC_SERUPRO))AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100')))AND(_F_SUB_FAN)AND($P_UIFR[_NPV,_ZZ,MI]==0)AND(ABS($P_UIFR[_NPV,_ZZ,TR]*_FAK1-(_IFR_NPV+_ZV))<=2*$SCS_TURN_FIXED_STOP_DIST*_FAK1)
ELSE
IF(_MOSE7==0)
$P_UIFR[_NPV,_ZZ,TR]=(_IFR_NPV+_ZV)/_FAK1
IF($MN_MM_FRAME_FINE_TRANS)
$P_UIFR[_NPV,_ZZ,FI]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"NPV beschreiben (012)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,TR]<<" (TR)")
ENDIF
ENDIF
$P_UIFR[_NPV,_ZZ,MI]=0
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,MI]<<" (MI)")
ENDIF
$P_UIFR[_NPV,_F_S_AX[0],TR]=_F_SUB_ANG
ENDIF
ENDIF
_VORDERSEITE_A1:
IF(S_ZVA)AND(_MOSE7==0)
IF($MCS_FUNCTION_MASK_TECH B_AND 'B1000000') GOTOF _FEHL15
$P_UIFR[_NPV,_ZZ,TR]=_ZV/_FAK1
IF($MN_MM_FRAME_FINE_TRANS)
$P_UIFR[_NPV,_ZZ,FI]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"NPV beschreiben (013)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,TR]<<" (TR)")
ENDIF
ENDIF
IF($MCS_FUNCTION_MASK_TURN B_AND 'H8000')
IF(_MOSE1==3)AND(S_ZVA==0)
IF(_MOSE7==0)
$P_UIFR[_NPV,_ZZ,TR]=(_IFR_NPV+_ZV)/_FAK1
$P_UIFR[_NPV,_ZZ,MI]=0
IF($MN_MM_FRAME_FINE_TRANS)
$P_UIFR[_NPV,_ZZ,FI]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"NPV beschreiben (014)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,TR]<<" (TR)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,MI]<<" (MI)")
ENDIF
ENDIF
ENDIF
ENDIF
_F_SUBSP=0
_F_SUB_STA=0
_F_SUB_ANG=0
_F_SUB_GRP=0
_F_SUB_FAN=0
_TESTLAUF4:
_VORDERSEITE_A2:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_VORDERSEITE_A2")
ENDIF
SETMS(_F_S_NR[0])
IF(_NPV<0) GOTOF _FEHL7
_NPV1=_NPV+1
IF($MN_SIM_ENVIRONMENT B_AND 'B100')AND(_MOSE7)AND(S_LS==2)AND(_NPV>0)AND(_F_NPV[0]>0)AND(_NPV<>_F_NPV[0])
$P_UIFR[_NPV]=$P_UIFR[_F_NPV[0]]
ENDIF
G[8]=_NPV1
_F_NPV[0]=_NPV
D=$P_TOOL
IF($P_UIFR[_NPV,_ZZ,MI]) GOTOF _FEHL14
IF(_F_MASPI==2)AND(_F_AX_EXISTS[3]==0)
WRTPR("NPVSET(0,2)",1)
ENDIF
WORKPIECE(,,,"SET_FOCUS",1)
_F_MASPI=0
_F_TCP[0]=_F_TCP_M[0,0]
_F_TCP[1]=_F_TCP_M[0,1]
_F_TCP[2]=_F_TCP_M[0,2]
CUST_TECHCYC(125)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_VORDERSEITE_E")
ENDIF
_VORDERSEITE_E:
IF(_SC_CHAN_ST<>"")
REPEAT _SET_NPV_A _SET_NPV_E
ENDIF
GOTOF _MEND
_M4:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_M4: Komplett")
ENDIF
IF(_MOSE4==0)
REPEAT _GREIFEN_A _GREIFEN_E
REPEAT _SET_ZTRANS_A _SET_ZTRANS_E
IF(S_LS==2)
REPEAT _VORDERSEITE_A _VORDERSEITE_E
ELSE
REPEAT _RUECKSEITE_A _RUECKSEITE_E
ENDIF
IF(_SC_CHAN_ST<>"")
REPEAT _SET_NPV_A _SET_NPV_E
ENDIF
ELSE
IF(_F_AX_EXISTS[3])
_F_SUBSP=1
ENDIF
_E_TR[0,0]=_ROTEL
_E_TR[1,0]=_MODE
_E_TR[2,0]=_SDIR
_E_TR[3,0]=_S
_E_TR[4,0]=_A1
_E_TR[5,0]=_Z1
_E_TR[6,0]=_ZR
_E_TR[7,0]=_ZRA
_E_TR[8,0]=_FR
_E_TR[9,0]=_F
_E_TR[10,0]=_NPV
_E_TR[11,0]=_ZV
_E_TR[12,0]=_RTL
_E_TR[13,0]=_ZW
_E_TR[14,0]=_XP
_E_TR[15,0]=_ZP
_E_TR[16,0]=_BETA
_E_TR[17,0]=_BETAA
_E_TR[18,0]=_GAMA
_E_TR[19,0]=_GAMAA
_E_TR[0,1]=S_ZVA
ENDIF
GOTOF _MEND
_M_3: ; Rest von Komplett (vor Abstich)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_M_3: ; Rest von Komplett (vor Abstich) ")
ENDIF
WRTPR("BLOCK_OFFSET(1)",1)
_GUD_PUFFER_A:
_ROTEL=_E_TR[0,0]
_MODE =_E_TR[1,0]
_SDIR =_E_TR[2,0]
_S =_E_TR[3,0]
_A1 =_E_TR[4,0]
_Z1 =_E_TR[5,0]
_ZR =_E_TR[6,0]
_ZRA =_E_TR[7,0]
_FR =_E_TR[8,0]
_F =_E_TR[9,0]
_NPV =_E_TR[10,0]
_ZV =_E_TR[11,0]
_RTL =_E_TR[12,0]
_ZW =_E_TR[13,0]
_XP =_E_TR[14,0]
_ZP =_E_TR[15,0]
S_ZVA =_E_TR[0,1]
_TRZ_SSL_FA=_E_TR[1,1]
_MIZ_SSL_FA=_E_TR[2,1]
REPEAT _MODUS_A _MODUS_E
_GUD_PUFFER_E:
_BETA =_E_TR[16,0]
_BETAA=_E_TR[17,0]
_GAMA =_E_TR[18,0]
_GAMAA=_E_TR[19,0]
REPEAT _GREIFEN_A _GREIFEN_E
IF(_F_AX_EXISTS[3]==0) GOTOF _MEND
IF(_MOSE5)
_PULLER=ABS(_F_RTL[0]*_FAK2-_RTL)
REPEAT _ZIEHEN_A _ZIEHEN_E
IF(($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_LS])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_LS])] B_AND 'B010000' == 'B010000'))OR(($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_FS])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_FS])] B_AND 'B010000' == 'B010000'))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N96 G0 G94 Z2=AC("<<(_Z1+_CHUCK+_GES_NPV-_TRAN_Z2+_PULLER)<<")")
ENDIF
SBLON
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N95 G0 G94 POS[_Z2]=AC(_Z1+_CHUCK+_GES_NPV-_TRAN_Z2+_PULLER)
ELSE
N96 G0 G94 AX[_Z2]=AC(_Z1+_CHUCK+_GES_NPV-_TRAN_Z2+_PULLER)
ENDIF
SBLOF
ENDIF
IF(_MOSE7)AND(S_LS<>2)
$P_PFRAME=$P_PFRAME:CTRANS(_ZZ,_PULLER/_FAK1)
ENDIF
ELSE
IF(($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_LS])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_LS])] B_AND 'B010000' == 'B010000'))OR(($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_FS])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_FS])] B_AND 'B010000' == 'B010000'))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N98 G0 Z2=AC("<<_ZR+_CHUCK+_GES_NPV-_TRAN_Z2<<")")
ENDIF
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N97 G0 POS[_Z2]=AC(_ZR+_CHUCK+_GES_NPV-_TRAN_Z2)
ELSE
N98 G0 AX[_Z2]=AC(_ZR+_CHUCK+_GES_NPV-_TRAN_Z2)
ENDIF
ENDIF
ENDIF
IF($P_SEARCH)OR($AC_SERUPRO)
_E_TR[16,0]=$P_EPM[_Z2]*_FAK1
IF(($P_SEARCH)OR($AC_SERUPRO))AND(_F_SUB_FAN)AND($P_UIFR[_NPV,_ZZ,MI])AND(ABS($P_UIFR[_NPV,_ZZ,TR]*_FAK1-(_IFR_NPV+_PULLER+_ZW-$P_EPM[_Z2]*_FAK1+_ZV))<=2*$SCS_TURN_FIXED_STOP_DIST*_FAK1)
_E_TR[16,0]=_E_TR[16,0]-_PULLER
ENDIF
ELSE
_E_TR[16,0]=$AA_IM[_Z2]*_FAK1
ENDIF
IF($SCS_TURN_PART_OFF_CTRL_FEED>0)
IF(($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_LS])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_LS])] B_AND 'B010000' == 'B010000'))OR(($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_FS])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_FS])] B_AND 'B010000' == 'B010000'))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"GOTOF _REST_1")
ENDIF
GOTOF _REST_1
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N101 G1 G94 F"<<$SCS_TURN_PART_OFF_CTRL_FEED<<" Z2=IC("<<$SCS_TURN_PART_OFF_RETRACTION*_FAK1<<")")
ENDIF
SBLON
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N100 G1 G94 FA[_Z2]=$SCS_TURN_PART_OFF_CTRL_FEED POS[_Z2]=IC($SCS_TURN_PART_OFF_RETRACTION*_FAK1)
ELSE
N101 G1 G94 F=$SCS_TURN_PART_OFF_CTRL_FEED AX[_Z2]=IC($SCS_TURN_PART_OFF_RETRACTION*_FAK1)
ENDIF
SBLOF
_REST_1:
ENDIF
IF(_MOSE8)
CUST_TECHCYC(4)
_F_NCK_CL_STATE[_F_MA_AX_NR[0]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[0]-1]=_SC_A_NO_VAL
CUST_TECHCYC(4+20)
_F_NCK_CL_STATE[_F_MA_AX_NR[2]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[2]-1]=_SC_A_NO_VAL
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Spindelkopplung: N508 COUPON("<<_F_S_NR[S_FS]<<","<<_F_S_NR[S_LS]<<","<<_A1<<")")
ENDIF
N508 COUPON(SPI(_F_S_NR[S_FS]),SPI(_F_S_NR[S_LS]),_A1)
ENDIF
WRTPR("BLOCK_OFFSET(0)",1)
GOTOF _MEND
_M_4:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_M_4: Rest von Komplett (nach Abstich)")
ENDIF
REPEAT _GUD_PUFFER_A _GUD_PUFFER_E
_MOSE1=-4
IF(_MOSE5)AND(_MOSE7)AND(S_LS<>2)
$P_PFRAME=$P_PFRAME:CTRANS(_ZZ,-ABS(_F_RTL[0]*_FAK2-_RTL)/_FAK1)
ENDIF
IF(S_LS==2)
REPEAT _VORDERSEITE_A _VORDERSEITE_E
ELSE
REPEAT _RUECKSEITE_A _RUECKSEITE_E
ENDIF
IF(($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_LS])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_LS])] B_AND 'B010000' == 'B010000'))OR(($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_FS])] B_AND 'B000100' == 'B000000')AND($AA_AX_DISABLE_SRC[SPI(_F_S_NR[S_FS])] B_AND 'B010000' == 'B010000'))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Z2-Achse nach Abstich auf Bearbeitungsposition fahren!")
ENDIF
REPEAT S_Z2_GO_A S_Z2_GO_E
ENDIF
IF(_SC_CHAN_ST<>"")
REPEAT _SET_NPV_A _SET_NPV_E
ENDIF
GOTOF _MEND
_M7:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_M7: Synchronisieren")
ENDIF
_SYNCHRONISIEREN_A:
IF(_SC_CHAN_ST=="")GOTOF _FEHL11
F_SP_TRA(4040)
G18
IF(_E_S_LINE==0)
IF(_XP<=0)AND(_ZP<=0)
N1020 F_SP_RP(1,,,1)
ELSE
IF(_MOSE6)
N1021 F_SP_RP(6,_XP,_ZP,1)
ELSE
N1022 F_SP_RP(5,_XP,_ZP,1)
ENDIF
ENDIF
ENDIF
_WM=107
REPEAT _SYNC_A _SYNC_E
_WM=106
REPEAT _SYNC_A _SYNC_E
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"GUDs abholen")
WRITE(_LOG,_LOG_FILE," NPV="<<_SC_NCK_NPV[0])
WRITE(_LOG,_LOG_FILE," SPI="<<_SC_NCK_NPV[1])
WRITE(_LOG,_LOG_FILE," Z  ="<<_SC_NCK_NPV[2])
WRITE(_LOG,_LOG_FILE," C  ="<<_SC_NCK_NPV[3])
WRITE(_LOG,_LOG_FILE," Zmi="<<_SC_NCK_NPV[4])
WRITE(_LOG,_LOG_FILE," ABSTICH="<<_SC_NCK_NPV[5])
WRITE(_LOG,_LOG_FILE," STA="<<_SC_NCK_NPV[6])
WRITE(_LOG,_LOG_FILE," ANG="<<_SC_NCK_NPV[7])
WRITE(_LOG,_LOG_FILE," GRP="<<_SC_NCK_NPV[8])
WRITE(_LOG,_LOG_FILE," FAN="<<_SC_NCK_NPV[9])
WRITE(_LOG,_LOG_FILE," RTL1="<<_SC_NCK_NPV[10])
WRITE(_LOG,_LOG_FILE," RTL2="<<_SC_NCK_NPV[11])
WRITE(_LOG,_LOG_FILE," Chan Z2="<<_SC_NCK_NPV[12])
WRITE(_LOG,_LOG_FILE," Pos Z2 ="<<_SC_NCK_NPV[13])
ENDIF
_NPV=_SC_NCK_NPV[0]
IF(_NPV==-99)GOTOF _FEHL12
$P_UIFR[_NPV,_ZZ,TR]=_SC_NCK_NPV[2]
$P_UIFR[_NPV,_F_S_AX[2],TR]=_SC_NCK_NPV[3]
$P_UIFR[_NPV,_ZZ,MI]=_SC_NCK_NPV[4]
IF($MN_MM_FRAME_FINE_TRANS)
$P_UIFR[_NPV,_ZZ,FI]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"NPV beschreiben (015)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,TR]<<" (TR)")
WRITE(_LOG,_LOG_FILE,"  G"<<_NPV+53<<" Z="<<$P_UIFR[_NPV,_ZZ,MI]<<" (MI)")
ENDIF
IF(_SC_NCK_NPV[1]==1)
_F_NPV[1]=_NPV
ELSE
_F_NPV[0]=_NPV
ENDIF
_F_SUBSP=_SC_NCK_NPV[5]
_F_SUB_STA=_SC_NCK_NPV[6]
_F_SUB_ANG=_SC_NCK_NPV[7]
_F_SUB_GRP=_SC_NCK_NPV[8]
_F_SUB_FAN=_SC_NCK_NPV[9]
_F_RTL[0]=_SC_NCK_NPV[10]
_F_RTL[1]=_SC_NCK_NPV[11]
IF(_SC_NCK_NPV[12]==$P_CHANNO)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N86 G0 Z2="<<AC(_SC_NCK_NPV[13])
ENDIF
SBLON
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N85 G0 POS[_Z2]=AC(_SC_NCK_NPV[13])
ELSE
N86 G0 AX[_Z2]=AC(_SC_NCK_NPV[13])
ENDIF
SBLOF
ENDIF
_WM=107
REPEAT _SYNC_A _SYNC_E
IF(_SC_NCK_NPV[1]==_F_MASPI/2)
_NPV1=_NPV+1
G[8]=_NPV1
D=$P_TOOL
ENDIF
_SYNCHRONISIEREN_E:
_MEND:
_F_INIT=1
_F_RELEAS=0
G[29]=_P29
_RET:
SBLON
RET
S_Z2_GO_A:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N91 G0 Z2="<<_ZW-_TRAN_Z2)
ENDIF
SBLON
IF($MA_BASE_FUNCTION_MASK[_Z2] B_AND 'H100')
FPRAOF(_Z2)
N90 G0 POS[_Z2]=AC(_ZW-_TRAN_Z2)
ELSE
N91 G0 AX[_Z2]=AC(_ZW-_TRAN_Z2)
ENDIF
SBLOF
IF((_F_NCK_CHAN_INFO[$P_CHANNO-1] B_AND 'B010')=='B010')
_I=0
WHILE(_I<10)
IF((_F_NCK_CHAN_INFO[_I] B_AND 'B011')=='B001')
_SC_NCK_NPV[12]=_I+1
_SC_NCK_NPV[13]=_ZW-_TRAN_Z2
_I=10
ENDIF
_I=_I+1
ENDWHILE
ENDIF
S_Z2_GO_E:
_SET_NPV_A:
IF(_SC_NCK_NPV[0]<>-99)GOTOF _FEHL13
IF(_NPV==-1)
_NPV=_F_NPV[_F_MASPI/2]
ENDIF
_SC_NCK_NPV[0]=_NPV
_SC_NCK_NPV[1]=_F_MASPI/2
_SC_NCK_NPV[2]=$P_UIFR[_NPV,_ZZ,TR]
_SC_NCK_NPV[3]=$P_UIFR[_NPV,_F_S_AX[2],TR]
_SC_NCK_NPV[4]=$P_UIFR[_NPV,_ZZ,MI]
_SC_NCK_NPV[5]=_F_SUBSP
_SC_NCK_NPV[6]=_F_SUB_STA
_SC_NCK_NPV[7]=_F_SUB_ANG
_SC_NCK_NPV[8]=_F_SUB_GRP
_SC_NCK_NPV[9]=_F_SUB_FAN
_SC_NCK_NPV[10]=_F_RTL[0]
_SC_NCK_NPV[11]=_F_RTL[1]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"GUDs besetzt:")
WRITE(_LOG,_LOG_FILE," NPV="<<_SC_NCK_NPV[0])
WRITE(_LOG,_LOG_FILE," SPI="<<_SC_NCK_NPV[1])
WRITE(_LOG,_LOG_FILE," Z  ="<<_SC_NCK_NPV[2])
WRITE(_LOG,_LOG_FILE," C  ="<<_SC_NCK_NPV[3])
WRITE(_LOG,_LOG_FILE," Zmi="<<_SC_NCK_NPV[4])
WRITE(_LOG,_LOG_FILE," ABSTICH="<<_SC_NCK_NPV[5])
WRITE(_LOG,_LOG_FILE," STA="<<_SC_NCK_NPV[6])
WRITE(_LOG,_LOG_FILE," ANG="<<_SC_NCK_NPV[7])
WRITE(_LOG,_LOG_FILE," GRP="<<_SC_NCK_NPV[8])
WRITE(_LOG,_LOG_FILE," FAN="<<_SC_NCK_NPV[9])
WRITE(_LOG,_LOG_FILE," RTL1="<<_SC_NCK_NPV[10])
WRITE(_LOG,_LOG_FILE," RTL2="<<_SC_NCK_NPV[11])
WRITE(_LOG,_LOG_FILE," Chan Z2="<<_SC_NCK_NPV[12])
WRITE(_LOG,_LOG_FILE," Pos Z2 ="<<_SC_NCK_NPV[13])
ENDIF
_WM=106
REPEAT _SYNC_A _SYNC_E
_WM=107
REPEAT _SYNC_A _SYNC_E
_SC_NCK_NPV[0]=-99
_SC_NCK_NPV[1]=REP(0)
_SET_NPV_E:
_SYNC_A:
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"WAITM("<<_WM<<","<<_SC_CHAN_ST<<")")
ENDIF
N970 EXECSTRING("WAITM("<<_WM<<","<<_SC_CHAN_ST<<")")
N975 STOPRE
_SYNC_E:
_FEHL0:STOPRE
N934400 SETAL(61254)
RET
_FEHL1:STOPRE
N934401 SETAL(61255)
RET
_FEHL3:STOPRE
N934403 SETAL(61257)
RET
_FEHL4:STOPRE
N934404 SETAL(61258)
RET
_FEHL5:STOPRE
N934405 SETAL(61403)
RET
_FEHL6:STOPRE
N934406 SETAL(61280,<<AXSTRING(_ZZ))
RET
_FEHL7:STOPRE
N934407 SETAL(61298)
RET
_FEHL8:STOPRE
N934408 SETAL(61299)
RET
_FEHL9:STOPRE
N934409 SETAL(61052)
RET
_FEHL10:STOPRE
N934410 SETAL(61053)
RET
_FEHL11:STOPRE
N934411 SETAL(61206)
RET
_FEHL12:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 12: Keinen Gegenspindelschritt zum Synchronisieren gefunden")
ENDIF
N934412 SETAL(61207)
RET
_FEHL13:STOPRE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Fehler 13: Gegenspindelschritte in mehreren Kanlen programmiert")
ENDIF
N934413 SETAL(61209)
RET
_FEHL14: STOPRE
N934414 SETAL(61614,<<AXSTRING(_ZZ))
RET
_FEHL15:STOPRE
;N934415 SETAL(61058,"ZV abs")
N934415 SETAL(61856)
RET
_FEHL16:STOPRE
N934416 SETAL(61868)
RET
_FEHL17:STOPRE
N934417 SETAL(61022,"ZW: "<<_ZW)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_SWIV_H_SPF
PROC F_SWIV_H(INT _TCI,REAL _A1,REAL _A2) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.20.00.00.004 ;DATE: 2021-11-12
;ShopTurn: Swivelling Cycle
DEF INT _I,_II,_III,_H,_FOUND
DEF INT _AX1_MODE,_AX2_MODE,_TCBA=0
DEF STRING[30] _SERR
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_SWIV_H_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"F_SWIV_H("<<_TCI<<","<<_A1<<","<<_A2<<")")
ENDIF
IF(_TCI>0)AND((_A1<>_SC_A_NO_VAL)OR(_A2<>_SC_A_NO_VAL))
_AX1_MODE=TRUNC($TC_CARR37[_TCI]/10) MOD 10
_AX2_MODE=TRUNC($TC_CARR37[_TCI]/100) MOD 10
IF(_AX1_MODE==0)AND(_AX2_MODE==0)
_TCBA=20
ELSE
IF(_AX1_MODE==1)AND(_AX2_MODE==1)
_TCBA=31
ELSE
IF(_AX1_MODE>0)AND(_AX2_MODE==0)
_TCBA=21
ENDIF
IF(_AX1_MODE==0)AND(_AX2_MODE>0)
_TCBA=30
ENDIF
ENDIF
ENDIF
CYCLE213(_TCI)
IF($TC_CARR36[_TCI]=="")OR(_A2==_SC_A_NO_VAL)
_TCBA=_TCBA+2
IF (_TCBA==32)OR(_TCBA==33)
_TCBA=_TCBA-10
ENDIF
ENDIF
IF(NOT $P_SEARCH)AND(NOT $AC_SERUPRO)AND(NOT $P_ISTEST)AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100'))
IF(_TCBA==31)AND(_AX1_MODE==1)AND(_AX2_MODE==1)
_SERR=<<$TC_CARR35[_TCI]<<": "<<_A1<<"  "<<$TC_CARR36[_TCI]<<": "<<_A2
N980021 SETAL(62180,_SERR)
WRTPR("MANAX("<<$TC_CARR35[_TCI]<<","<<_A1<<")",1)
WRTPR("MANAX("<<$TC_CARR36[_TCI]<<","<<_A2<<")",1)
ENDIF
IF((_TCBA==21)OR(_TCBA==23))AND(_AX1_MODE==1)
_SERR=<<$TC_CARR35[_TCI]<<": "<<_A1
N980022 SETAL(62181,_SERR)
WRTPR("MANAX("<<$TC_CARR36[_TCI]<<","<<_A1<<")",1)
ENDIF
IF(_TCBA==30)AND(_AX2_MODE==1)
_SERR=<<$TC_CARR36[_TCI]<<": "<<_A2
N980023 SETAL(62181,_SERR)
WRTPR("MANAX("<<$TC_CARR36[_TCI]<<","<<_A2<<")",1)
ENDIF
ENDIF
IF(_A2<>_SC_A_NO_VAL)
_A2=_A2 MOD 360
ENDIF
IF((_A1<$TC_CARR30[_TCI])OR(_A1>$TC_CARR32[_TCI]))OR((_A2<>_SC_A_NO_VAL)AND((_A2<$TC_CARR31[_TCI])OR(_A2>$TC_CARR33[_TCI])))
GOTOF _FEHL4
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  CUST_800("<<_TCBA<<","<<_TCI<<","<<_A1<<","<<_A2<<")")
ENDIF
N100 CUST_800(_TCBA,_TCI,_A1,_A2)
IF(NOT $P_SEARCH)AND(NOT $AC_SERUPRO)
STOPRE
$TC_CARR13[_TCI]=_A1
IF(_A2<>_SC_A_NO_VAL)
$TC_CARR14[_TCI]=_A2
ENDIF
ENDIF
ENDIF
RET
_FEHL4: STOPRE
N980024 SETAL(61189)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_T_REV2_SPF
PROC F_T_REV2 SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.07.72.00 ;DATE: 2017-08-28
;ShopTurn: Mirroring
DEF AXIS _XX,_YY,_HSP,_GSP
DEF INT _DD
DEF REAL S_T_LEN
CYCLE210(0)
_F_T_REV2=0
WRTPR("IGNORE(16,0)",1)
IF($C_TCA==1)
IF($C_DUPLO_PROG==1)AND($C_THNO_PROG==1)
TCA($C_TS,$C_DUPLO,$C_THNO)
ELSE
IF($C_DUPLO_PROG==1)AND($C_THNO_PROG==0)
TCA($C_TS,$C_DUPLO)
ELSE
IF($C_DUPLO_PROG==0)AND($C_THNO_PROG==1)
TCA($C_TS,,$C_THNO)
ELSE
TCA($C_TS)
ENDIF
ENDIF
ENDIF
ELSE
IF($C_T_PROG==1)OR($C_TS_PROG==1)
IF($C_T_PROG==1)
T[$C_TE]=$C_T
ELSE
T[$C_TE]=$C_TS
ENDIF
ENDIF
ENDIF
IF($MCS_REV_2_BORDER_TOOL_LENGTH)
_XX=AXNAME($MC_AXCONF_GEOAX_NAME_TAB[0])
IF(_F_Y_AXIS)OR($P_TRAFO B_AND 'H100')
_YY=AXNAME($MC_AXCONF_GEOAX_NAME_TAB[1])
ENDIF
_HSP=_F_S_AX[0]
IF(_F_S_NR[2])
_GSP=_F_S_AX[2]
ENDIF
_DD=$P_TOOL
IF($P_TOOLNO<>0)AND($P_TOOL==0)
D1
ENDIF
IF($P_TOOLNO)AND($P_TOOL)
S_T_LEN=$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]
IF($SC_MIRROR_TOOL_LENGTH)AND($P_ACTFRAME[_XX,MI])
S_T_LEN=-S_T_LEN
ENDIF
ELSE
S_T_LEN=0
ENDIF
IF(S_T_LEN<$MCS_REV_2_BORDER_TOOL_LENGTH)
WRTPR("MIRROR(0)",1)
$P_WPFRAME[_XX,MI]=0
$P_WPFR[_XX,MI]=0
IF(_F_Y_AXIS)OR($P_TRAFO B_AND 'H100')
$P_WPFRAME[_YY,MI]=0
$P_WPFR[_YY,MI]=0
ENDIF
$P_WPFRAME[_HSP,TR]=0
$P_WPFR[_HSP,TR]=0
IF(_F_S_NR[2])
$P_WPFRAME[_GSP,TR]=0
$P_WPFR[_GSP,TR]=0
ENDIF
ELSE
_F_T_REV2=1
WRTPR("MIRROR(3)",1)
$P_WPFRAME[_XX,MI]=1
$P_WPFR[_XX,MI]=1
IF(_F_Y_AXIS)OR($P_TRAFO B_AND 'H100')
$P_WPFRAME[_YY,MI]=1
$P_WPFR[_YY,MI]=1
ENDIF
$P_WPFRAME[_HSP,TR]=180
$P_WPFR[_HSP,TR]=180
IF(_F_S_NR[2])
$P_WPFRAME[_GSP,TR]=180
$P_WPFR[_GSP,TR]=180
ENDIF
ENDIF
IF($P_TOOL<>_DD)
D=_DD
ENDIF
G4 F0
ENDIF
WRTPR("IGNORE(32,0)",1)
SBLON
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_TAP_SPF
PROC F_TAP(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,REAL _Z0,INT _Z0A,REAL _Z1,INT _Z1A,REAL _FI,REAL _FM,INT _FZG,INT _FZZ,INT _FZN,REAL _D,REAL _V2,INT _SR,STRING[20] _PTAB,STRING[20] _PTABA,INT _TECHNO,REAL S_D3D) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.008 ;DATE: 2024-05-15
;ShopTurn: Concentric Tapping
DEF AXIS _XX,_ZZ,_YY
DEF INT _PM,_P29,_SDIR,_TYP=0,_M3_5,_MAN,_I,_DIR,_TM1=2,_TM3=0,_HS_CINV,_GS_CINV,_DMODE,_AMODE,_PITA,_VARI
DEF REAL _FAK1,_FAK2,_FAK3,_FAK4,_SC,_SD,_RTP,_RP,_VRT,_XS,_YS,_ZS,_F1
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
_P29=$P_GG[29]
DIAMCYCOF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK3=1/$MN_SCALING_VALUE_INCH
ELSE
_FAK3=1
ENDIF
_FAK4=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==3)
_FAK4=$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==4)
_FAK4=1/$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_MAN=TRUNC(_TMOD/10) MOD 10
IF((_F_S_NR[1]>0)AND($P_SDIR[_F_S_NR[1]]<>5))
M[_F_S_NR[1]]=5
CUST_TECHCYC(42)
ENDIF
IF(_FAA _DEC2 == 0)
_F1=_F*_FAK3
ELSE
IF(_FAA _DEC1 == 0)
_F1=_F*_FAK3
ELSE
IF(_FAA _DEC1 == 1)
_F1=_F*$MN_SCALING_VALUE_INCH*_FAK3
ELSE
IF(_FAA _DEC1 == 2)
_F1=_F*$PI*_FAK3
ELSE
_F1=$MN_SCALING_VALUE_INCH/_F*_FAK3
ENDIF
ENDIF
ENDIF
ENDIF
IF(_MAN==0)
N20 F_TFS(_T,_TF,_DD,_F1,3,_S,_SA,1,0)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
IF($P_S[_F_S_NR[1]]==0) OR ($P_SDIR[_F_S_NR[1]]==5)
F_SP_BC(5,0,0)
ELSE
F_SP_BC(5,0,_SC_A_NO_VAL)
ENDIF
ENDIF
ELSE
_F_INIT=2
_F_RELEAS=1
IF(_MAN==1)
_F_MASPI=0
N24 F_TFS(_T,,_DD,_F1,3,_S,_SA,1,8)
ELSE
_F_MASPI=2
N26 F_TFS(_T,,_DD,_F1,3,_S,_SA,3,8)
ENDIF
ENDIF
F_SP_TRA(2050)
_ZZ=$P_AXN3 _XX=$P_AXN1
_S=$P_S[0]
IF($P_TOOLNO)
_TYP=$P_AD[1]
ENDIF
IF(_TYP<200) OR (_TYP>299) GOTOF _FEHL1
IF S_CALL_FROM_MA_JOG_STEP
_F_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
ELSE
_SC=_E_SC*_FAK2
ENDIF
IF(_Z1A==90)OR(_Z1A==0)
_Z1=_Z0-_Z1
ELSE
_Z1=ABS(_Z1)
ENDIF
IF(_Z1<0)GOTOF _FEHL2
_PM=-1
IF(_MAN==0)
IF(_TMOD MOD 10 <2)
_TMOD=_TMOD+2
ENDIF
F_SP_RPT(1,_TMOD)
_RP=_F_RP_ACT*_FAK2
ENDIF
IF(_FAA _DEC2 == 0)
_PITA=1
ELSE
IF(_FAA _DEC1 == 0)
_PITA=1
ELSE
IF(_FAA _DEC1 == 1)
_PITA=3
ELSE
IF(_FAA _DEC1 == 2)
_PITA=4
ELSE
_PITA=2
ENDIF
ENDIF
ENDIF
ENDIF
_SDIR=5
IF(_MAN==0)
_F_INIT=1
ENDIF
IF(_SR==0)
_SR=_S
ELSE
IF(_SA==2)
IF($P_TOOLR>0)
IF($MN_SCALING_SYSTEM_IS_METRIC)
_SR=1000*_SR/($PI*2*$P_TOOLR*_FAK4)
ELSE
_SR=12*_SR/($PI*2*$P_TOOLR*_FAK4)
ENDIF
IF(_SR>999999)
_SR=999999
ENDIF
IF(_F_S_NR[0]==$P_MSNUM)
IF(_SR>$AC_SMAXVELO[_F_S_NR[0]])
_SR=$AC_SMAXVELO[_F_S_NR[0]]
ENDIF
ENDIF
IF(_F_S_NR[2]==$P_MSNUM)
IF(_SR>$AC_SMAXVELO[_F_S_NR[2]])
_SR=$AC_SMAXVELO[_F_S_NR[2]]
ENDIF
ENDIF
ELSE
GOTOF _FEHL4
ENDIF
ENDIF
ENDIF
IF(_BA B_AND 'B11' == 'B01')
_VARI=1
IF(_BA B_AND 'B1100' == 'B1000')
_VRT=_V2
ELSE
IF(_BA B_AND 'B1100' == 'B0100')
_VRT=_F
ELSE
IF(_V2==0)
_VRT=_F
ELSE
_VRT=_V2
ENDIF
ENDIF
ENDIF
ELSE
IF(_BA B_AND 'B11' == 'B10')
_VARI=2
ELSE
_VARI=0
ENDIF
ENDIF
_DMODE=100
IF(_BA B_AND 'B10000'==0)
_DMODE=_DMODE+1000
ENDIF
IF((_TECHNO _DEC4)==1)
_TECHNO=_TECHNO-1000
ENDIF
_AMODE=2000001
_M3_5=TRUNC($TC_DP25[$P_TOOLNO,1]/256)MOD 4
IF(_M3_5==1)
IF(S_INV_S_MID[_F_MASPI/2]==0)
_AMODE=_AMODE+1000
ELSE
_AMODE=_AMODE+2000
ENDIF
ELSE
IF(_M3_5==2)
IF(S_INV_S_MID[_F_MASPI/2]==0)
_AMODE=_AMODE+2000
ELSE
_AMODE=_AMODE+1000
ENDIF
ELSE
GOTOF _FEHL3
ENDIF
ENDIF
F_SP_ED(_SD)
IF(_MAN==0)
_RTP=_F_RP_ACT*_FAK2-_SD*_PM
N30 F_SP_RP(0,0,_RP,0)
F_SP_TRA(1050)
ELSE
_RTP=_Z0+(_SC+_SD)
ENDIF
IF(_MAN==0)
SBLON
IF(_F_RELEAS==0)
N40 G0 G90 AX[_XX]=0 AX[_ZZ]=_RP+_SD
ELSE
N42 G0 G90 AX[_XX]=0
ENDIF
SBLOF
ELSE
_XS=$P_EP[_XX]*_FAK1 _ZS=$P_EP[_ZZ]*_FAK1
IF(_F_Y_AXIS==1)
_YY=$P_AXN2
_YS=$P_EP[_YY]*_FAK1
ENDIF
IF(_ZS<_Z0+(_SC+_SD)) GOTOF _FEHL6
SBLON
IF(_F_Y_AXIS==0)
N46 G90 G0 AX[_XX]=0 AX[_ZZ]=_RTP
ELSE
N48 G90 G0 AX[_XX]=0 AX[_ZZ]=_RTP AX[_YY]=0
ENDIF
SBLOF
ENDIF
N50 CYCLE84(_RTP,_Z0,_SC,,_Z1,,_SDIR,,_F,0,_S,_SR,3,_PITA,_TECHNO,_VARI,_D,_VRT,,,,,_DMODE,_AMODE)
S=_S
IF(_MAN<>0)
SBLON
IF(_F_Y_AXIS==0)
N70 G90 G0 AX[_XX]=_XS AX[_ZZ]=_ZS
ELSE
N80 G90 G0 AX[_XX]=_XS AX[_ZZ]=_ZS AX[_YY]=_YS
ENDIF
SBLOF
ENDIF
F_SP_TRA(2040)
G[29]=_P29
_RETS:
_F_RELEAS=0
SBLON
RET
_FEHL1: STOPRE
N908441 SETAL(61212)
RET
_FEHL2: STOPRE
N908442 SETAL(61242)
RET
_FEHL3: STOPRE
N908443 SETAL(61102)
RET
_FEHL4: STOPRE
N908444 SETAL(61217)
RET
_FEHL6: STOPRE
N908446 SETAL(61284)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_TCARR_SPF
PROC F_TCARR(STRING[32] _TC,STRING[32] _T,STRING[32] _TF,INT _DD,INT _ST,REAL _X0,REAL _Y0,REAL _Z0,REAL _A,REAL _B,REAL _C,INT _MODE,REAL _X1,REAL _Y1,REAL _Z1,INT _DIR,INT _FRE,INT _HEB,REAL _FR_I,REAL _RP,REAL _C0) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.95.00.00.001 ;DATE: 2020-11-02
;ShopTurn: Swivelling Cycle
DEF INT _I,_II,_III,_H,_FOUND
DEF INT _ST0,_ST1,_ST7,_ST8,_ST9,_STATUS,_FR
DEF INT _TC_NUM_AKTIV,_TCI,_TCPR,_TC37_A,_TC37_N,_DMODE
DEF REAL _FAK2,_PDEG,_A1,_A2,_CANG
DEF STRING[30] _SERR
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_TCARR_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
; DELETE(_LOG,_LOG_FILE)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"Aufruf aus "<<SUBSTR($P_PROG[$P_STACK-1],3,STRLEN($P_PROG[$P_STACK-1])-3-4))
WRITE(_LOG,_LOG_FILE,"F_TCARR("<<_TC<<","<<_T<<","<<_TF<<","<<_DD<<","<<_ST<<","<<_X0<<","<<_Y0<<","<<_Z0<<","<<_A<<","<<_B<<","<<_C<<","<<_MODE<<","<<_X1<<","<<_Y1<<","<<_Z1<<","<<_DIR<<","<<_FRE<<","<<_HEB<<","<<_FR_I<<","<<_RP<<","<<_C0<<")")
ENDIF
_PDEG=$MN_INT_INCR_PER_DEG
_TC_N_WZ=(_ST B_AND 'B00000010')/2
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF(_F_TC_ACT>0)
_F_TC_DEF[_F_MASPI/2]=_F_TC_ACT
ENDIF
_TCI=_F_TC_DEF[_F_MASPI/2]
IF(_TCI)
_TC=$TC_CARR34[_TCI]
ELSE
_TC=""
ENDIF
_DIR=1-_F_MASPI
GOTOF _M_TC_AUTO
IF(_TC=="0")
IF($SCS_FUNCTION_MASK_SWIVEL_SET B_AND 'B100')
_TCI=0
ELSE
GOTOF _FEHL2
ENDIF
ELSE
_TC_NUM_AKTIV=0
FOR _I=1 TO $P_TCNUM
_TC37_A=TRUNC($TC_CARR37[_I]/100000000) MOD 10
IF(_TC37_A B_AND 'B100')
_TC_NUM_AKTIV=_TC_NUM_AKTIV+1
_TCI=_I
ENDIF
ENDFOR
IF(_TC=="")
IF($P_TC>0)
_TCI=$P_TC
ELSE
IF(_TC_NUM_AKTIV==1)
ELSE
GOTOF _FEHL3
ENDIF
ENDIF
ELSE
IF(_TC_NUM_AKTIV==1)
ELSE
_TCI=$P_TCNUM
_I=TRUNC($TC_CARR37[_TCI]/100000000) MOD 10
WHILE((_TCI>0)AND(($TC_CARR34[_TCI]<>_TC)OR((_I B_AND 'B100')==0)))
_TCI=_TCI-1
_I=TRUNC($TC_CARR37[_TCI]/100000000) MOD 10
ENDWHILE
IF(_TCI<1) GOTOF _FEHL1
ENDIF
ENDIF
ENDIF
IF(_TCI)
_TC=$TC_CARR34[_TCI]
ENDIF
_M_TC_AUTO:
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
_ST7=(_ST B_AND 'B10000000')
IF(_ST7)
_TCI=$P_TC
_TCPR=_TC_NUM
ELSE
_TCPR=$P_TC
ENDIF
IF(_TCI<>_TCPR)
IF(_TCPR>0)
_TC37_A=TRUNC($TC_CARR37[_TCPR]/100000000) MOD 10
ENDIF
IF(_TCI>0)
_TC37_N=TRUNC($TC_CARR37[_TCI]/100000000) MOD 10
ENDIF
IF(NOT $P_SEARCH)AND(NOT $AC_SERUPRO)AND(NOT $P_ISTEST)AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100'))
IF(_TCPR==0)
IF(_TCI==0)
ELSE
IF(_TC37_N B_AND 'B010')
_SERR=<<$TC_CARR34[_TCI]
SETAL(62182,_SERR)
N20 CUST_800(5,_TCI)
ELSE
N30 CUST_800(4,_TCI)
ENDIF
ENDIF
ELSE
IF(_TC37_A B_AND 'B010')
IF(_TCI==0)
_SERR=<<$TC_CARR34[_TCPR]
SETAL(62183,_SERR)
N40 CUST_800(7,_TCPR)
ELSE
IF(_TC37_N B_AND 'B010')
_SERR=<<$TC_CARR34[_TCPR]<<"->"<<$TC_CARR34[_TCI]
SETAL(62184,_SERR)
N50 CUST_800(9,_TCPR,,,_TCI)
ELSE
_SERR=<<$TC_CARR34[_TCPR]
SETAL(62183,_SERR)
N60 CUST_800(7,_TCPR)
N70 CUST_800(4,_TCI)
ENDIF
ENDIF
ELSE
IF(_TCI==0)
N80 CUST_800(6,_TCPR)
ELSE
IF(_TC37_N B_AND 'B010')
N90 CUST_800(6,_TCPR)
IF(NOT $P_SEARCH)AND(NOT $AC_SERUPRO)
CYCLE800()
_TC_NUM=0
IF($MC_TOOL_CARRIER_RESET_VALUE<>0)
STOPRE
$MC_TOOL_CARRIER_RESET_VALUE=0
ENDIF
D=$P_TOOL
ENDIF
_SERR=<<$TC_CARR34[_TCI]
SETAL(62182,_SERR)
N100 CUST_800(5,_TCI)
ELSE
N110 CUST_800(8,_TCPR,,,_TCI)
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
IF(_TCI>0)
F_SP_TRA(4063)
N300 F_TFS(_T,_TF,_DD,,,,,2,5)
_F_INIT=1
IF($AC_SERUPRO)AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100'))
IF(_E_SEARCH[3]==$P_LINENO[0])
F_SP_LAB
ENDIF
ENDIF
ENDIF
IF(_FRE==1)
F_SP_RP(7,,,1)
ENDIF
F_SP_TRA(2063)
IF(NOT _ST7)
_F_RPT[5]=_RP/_FAK2
_ST0=1-(_ST B_AND 'B00000001')
_ST1=(_ST B_AND 'B00000010')/2
_ST8=(_ST B_AND 'H100')/256
_ST9=(_ST B_AND 'H200') AND _ST8
_STATUS=_ST0+_ST1*10+(_ST8+_ST9)*1000
IF(_FRE==1)
_FR=0
ELSE
IF(_FRE==0)
_FR=1
ELSE
_FR=_FRE
ENDIF
ENDIF
IF(_DIR==1)
_STATUS=_STATUS+220000
ENDIF
IF(_DIR==-1)
_STATUS=_STATUS+110000
ENDIF
_DIR=0
WRTPR("IGNORE(16,0)",1)
$P_CYCFRAME=CTRANS()
_C0=((_C0 MOD 360)+360)MOD 360
_F_TRA_C=_C0
$P_CYCFRAME[_F_S_AX[_F_MASPI],TR]=_F_TRA_C
_CANG=$P_PFRAME[_F_S_AX[_F_MASPI],TR]
$P_PFRAME[_F_S_AX[_F_MASPI],TR]=0
_DMODE=100
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CYCLE800("<<_FR<<","<<_TC<<","<<_STATUS<<","<<_MODE<<","<<_X0<<","<<_Y0<<","<<_Z0<<","<<_A<<","<<_B<<","<<_C<<","<<_X1<<","<<_Y1<<","<<_Z1<<","<<_DIR<<","<<_FR_I<<<<","<<_DMODE<<")")
ENDIF
CYCLE800(_FR,_TC,_STATUS,_MODE,_X0,_Y0,_Z0,_A,_B,_C,_X1,_Y1,_Z1,_DIR,_FR_I,_DMODE)
$P_PFRAME[_F_S_AX[_F_MASPI],TR]=_CANG
WRTPR("CPOS("<<$P_PFRAME[_F_S_AX[_F_MASPI],TR]+$P_CYCFRAME[_F_S_AX[_F_MASPI],TR]<<")",1)
IF(_HEB==0)AND(_TCI)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[1]="<<$P_TCANG[1]<<"  $P_TCANG[2]="<<$P_TCANG[2])
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[3]="<<$P_TCANG[3]<<"  $P_TCANG[4]="<<$P_TCANG[4])
WRITE(_LOG,_LOG_FILE,"  _TC_A1="<<_TC_A1)
WRITE(_LOG,_LOG_FILE,"  _TC_A2="<<_TC_A2)
ENDIF
_A1=_TC_A1 _A2=_TC_A2
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  _A1="<<_A1)
WRITE(_LOG,_LOG_FILE,"  _A2="<<_A2)
ENDIF
CYCLE213(_TCI)
IF(ROUND(_A1*_PDEG)<>ROUND($P_EP[AXNAME($TC_CARR35[_TCI])]*_PDEG))OR(ROUND(_A2*_PDEG)<>ROUND($P_EP[AXNAME($TC_CARR36[_TCI])]*_PDEG))
N400 F_SP_RP(8,,,1)
N500 F_SWIV_H(_TCI,_A1,_A2)
ENDIF
WRTPR("SWIVEL(0)",1)
ENDIF
WRTPR("IGNORE(32,0)",1)
ENDIF
_F_RP_DIR[0]=7
RET
_FEHL1: STOPRE
N980001 SETAL(61225)
RET
_FEHL2: STOPRE
N980002 SETAL(61226)
RET
_FEHL3: STOPRE
N980003 SETAL(61182)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_TCTOOL_SPF
PROC F_TCTOOL(STRING[32] _TC,INT _ST,REAL _A,REAL _B,INT _MODE,INT _FRE,REAL _FR_I) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 02.06.43.00 ;DATE: 2010-01-21
;ShopTurn: Approach Cycle
DEF INT _FR800,_MODE800,_ST800,_TCI
DEF STRING[32] _TC800
F_HOME
IF(_ST B_AND 'B10')
_ST800=111
ELSE
_ST800=101
ENDIF
CASE _MODE OF 0 GOTOF _M0 1 GOTOF _M1 2 GOTOF _M2 3 GOTOF _M3 4 GOTOF _M4 5 GOTOF _M5 DEFAULT GOTOF _MMODF
_M0:
_MODE800='B111001'
GOTOF _MMOD
_M1:
_MODE800='B101101'
GOTOF _MMOD
_M2:
_MODE800='B110110'
GOTOF _MMOD
_M3:
_MODE800='B011110'
GOTOF _MMOD
_M4:
_MODE800='B100111'
GOTOF _MMOD
_M5:
_MODE800='B011011'
GOTOF _MMOD
_MMODF:
GOTOF _FEHL1
_MMOD:
_TCI=_F_TC_DEF[_F_MASPI/2]
IF(_TCI)
_TC800=$TC_CARR34[_TCI]
ELSE
GOTOF _FEHL2
ENDIF
IF(_FRE==1)
_FR800=0
ELSE
IF(_FRE==0)
_FR800=1
ELSE
_FR800=_FRE
ENDIF
ENDIF
N100 CYCLE800(_FR800,_TC800,_ST800,_MODE800,,,,_A,_B,0,,,,-1,_FR_I,0)
RET
_FEHL1:
N980041 SETAL(61295)
RET
_FEHL2: STOPRE
N980042 SETAL(61292)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_TFS_SPF
PROC F_TFS(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _SMODE,INT _MODE,INT _DP) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.009 ;DATE: 2024-05-22
;ShopTurn: Tool change/Feedrate/Spindle
DEF AXIS _XX,_YY,_ZZ
DEF INT _I,_II,_III,_H,_FOUND
DEF INT _TI=0,_TIN=0,_TFI,_TFA,_M3_5,S_M3_5,_M7_8,_M7_8_ALT=0,_MB1=0,_MB2=0,_MB3=0,_MB4=0,_MB9=0,_WTYP=0,_TRAFO=0,_MSP,_DPA
DEF INT _TCI,_TC37,_AX1_MODE,_AX2_MODE,_WZGW=0,_HND_ALT=0,_HND_NEU=0,_HS_CDIR,_HS_SDIR,_HS_SDIRC,_GS_CDIR,_GS_SDIR,_GS_SDIRC,S_TI,S_THNR,_NPV,S_P52,S_P53
DEF INT S_TC_FR,S_TC_ST,S_TC_MODE,S_TC_N_WZ,S_TC_A_WZ,S_TC_NUM
DEF REAL _FAK4,_WR,_A1,_A2,S_A1TC,S_A2TC
DEF REAL S_TC_P[10],S_TC_A1,S_TC_A2
DEF BOOL _T_NEU=FALSE,_TF_NEU=FALSE,_D_NEU=FALSE,_M_NEU=FALSE,_MK_NEU=FALSE,_S_NEU=FALSE,_F_NEU=FALSE,_MS_NEU=FALSE,_WZW=FALSE,_F_OK=FALSE,S_MK_OFF=FALSE
DEF BOOL _Y_EXISTS
DEF FRAME _WPFR
DEF STRING[80] _CMD
DEF STRING[200] S_STR
DEF STRING[32] _AX1_NAME,_AX2_NAME
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_TFS_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"F_TFS(_T="<<_T<<",_TF="<<_TF<<",_DD="<<_DD<<",_F="<<_F<<",_FAA="<<_FAA<<",_S="<<_S<<",_SA="<<_SA<<",_SMODE="<<_SMODE<<",_MODE="<<_MODE<<",_DP="<<_DP<<")")
S_STR="Aufruf aus "
FOR _I=0 TO $P_STACK-1
S_STR=S_STR<<SUBSTR($P_PROG[_I],3,STRLEN($P_PROG[_I])-3-4)<<" -> "
ENDFOR
WRITE(_LOG,_LOG_FILE,S_STR<<"F_TFS")
ENDIF
S_M3_5=_SA _DEC2
_SA=_SA _DEC1
IF(_MODE==10)
S_MK_OFF=TRUE
_MODE=0
ENDIF
IF(_T<>"")
REPEAT S_GET_T_NR_A S_GET_T_NR_E
_TI=S_TI
IF(_TI>0)
_DPA=$TC_TP1[_TI]
ELSE
_DPA=-1
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"aktiv: TI="<<_TI<<" DPA="<<_DPA)
ENDIF
_TI=GETT(_T,_DP)
IF(ISNUMBER(_T))
IF(NUMBER(_T)==0)
_TI=0
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"neu:   TI="<<_TI<<" DP="<<_DP)
ENDIF
IF(_MODE==2)
IF(S_TI<>_TI)
_T_NEU=TRUE
_WZW=TRUE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_T_NEU=TRUE")
WRITE(_LOG,_LOG_FILE,"_WZW=TRUE")
ENDIF
ELSE
_D_NEU=TRUE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_D_NEU=TRUE")
ENDIF
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"$P_TOOLNO="<<$P_TOOLNO)
ENDIF
IF($P_TOOLNO>0)
IF(_T==$TC_TP2[$P_TOOLNO])
_TI=$P_TOOLNO
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Duplo -> _TI="<<_TI)
ENDIF
ENDIF
ENDIF
IF($P_TOOLNO<>_TI)
_T_NEU=TRUE
_WZW=TRUE
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"$P_TOOL="<<$P_TOOL<<" _DD="<<_DD)
ENDIF
IF($P_TOOL<>_DD)
_D_NEU=TRUE
IF($P_TOOL)AND($P_TOOL<>_DD)AND(_DD)AND(_TI)
_WTYP=$TC_DP1[_TI,$P_TOOL]
IF(_WTYP>=100)AND(_WTYP<300)
IF($TC_DP2[_TI,$P_TOOL]<>$TC_DP2[_TI,_DD])
_T_NEU=TRUE
_WZW=TRUE
ENDIF
ENDIF
ENDIF
IF($MCS_REV_2_BORDER_TOOL_LENGTH)
_T_NEU=TRUE
_WZW=TRUE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_T_NEU=TRUE _WZW=TRUE wegen $MCS_REV_2_BORDER_TOOL_LENGTH")
ENDIF
ENDIF
ELSE
IF($MC_CUTTING_EDGE_DEFAULT==-2)OR($MC_CUTTING_EDGE_DEFAULT==0)
_D_NEU=TRUE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_D_NEU=TRUE wegen $MC_CUTTING_EDGE_DEFAULT="<<$MC_CUTTING_EDGE_DEFAULT)
ENDIF
ENDIF
ENDIF
ENDIF
IF($P_TOOLNO>0)AND($MCS_FUNCTION_MASK_TECH B_AND 'H80')
STOPRE
IF($TC_TP8[$P_TOOLNO] B_AND 'B100')
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Standzeit abgelaufen -> Wkz. auswechseln!")
ENDIF
_WZW=TRUE
_T_NEU=TRUE
ENDIF
ENDIF
ENDIF
ELSE
_TI=$P_TOOLNO
IF(_DD==0)
_DD=$P_TOOL
ENDIF
IF($P_TOOL<>_DD)AND((_MODE==1)OR(_MODE==3))
_D_NEU=TRUE
ENDIF
ENDIF
IF($MC_TOOL_CHANGE_MODE==1)AND(_TF<>"")AND(($SCS_FUNCTION_MASK_TECH_SET B_AND 'B001'==1)OR(_MODE==2))
_TFI=GETT(_TF,0)
IF(ISNUMBER(_TF))
IF(NUMBER(_TF)==0)
_TFI=0
ENDIF
ENDIF
IF(_TFI>=0)
IF(_T_NEU)
IF(_TFI<>_TI)
_TF_NEU=TRUE
ENDIF
ELSE
IF(_TFI<>$P_TOOLNO)
_TF_NEU=TRUE
ENDIF
ENDIF
ENDIF
ENDIF
IF(_F_INIT==2)OR(((_MODE==2)OR(_MODE==3))AND(_T<>""))
_T_NEU=TRUE
ENDIF
IF(_MODE==2)AND(_F_RELEAS==1)
REPEAT S_GET_T_NR_A S_GET_T_NR_E
IF(S_TI==_TI)
N932120 SETAL(62202)
M0
STOPRE
_T_NEU=0
_M_NEU=TRUE
_MK_NEU=TRUE
ELSE
GOTOF _FEHL5
ENDIF
ENDIF
IF(_F_INIT)
_M_NEU=TRUE
_MK_NEU=TRUE
_MS_NEU=TRUE
S_M_OK=0
S_MK_OK=0
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_F_INIT -> S_M_OK=0, S_MK_OK=0")
ENDIF
_F_INIT=0
ENDIF
IF(_SA>0)
_S_NEU=TRUE
ENDIF
IF(_FAA>0)
_F_NEU=TRUE
ENDIF
IF(_T_NEU)OR(_MODE==7)OR((_MODE==1)AND(_S_NEU))
_M_NEU=TRUE
_MK_NEU=TRUE
ENDIF
IF(_TI<=0)
_M_NEU=FALSE
_MK_NEU=FALSE
ENDIF
IF(NOT _S_NEU)
_M_NEU=FALSE
ENDIF
IF(_MODE==1)AND((_T_NEU)AND(NOT _M_NEU))
_F_INIT=1
ENDIF
IF(_T_NEU)
_MS_NEU=TRUE
ENDIF
IF((_MODE==1)AND(_SMODE==0))OR(_MODE==3)
_MS_NEU=FALSE
ENDIF
IF(_SMODE==1)AND(_F_MASPI==2)AND(_MODE<>1)
_SMODE=3
ENDIF
IF(_SMODE==0)
IF(_F_S_NR[0]==$P_MSNUM)
_SMODE=1
ELSE
IF(_F_S_NR[1]==$P_MSNUM)
_SMODE=2
ELSE
IF(_F_S_NR[2]==$P_MSNUM)
_SMODE=3
ELSE
GOTOF _FEHL6
ENDIF
ENDIF
ENDIF
ELSE
IF(_F_S_NR[_SMODE-1]<>$P_MSNUM)
_MS_NEU=TRUE
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_SMODE="<<_SMODE)
ENDIF
IF(_TI>0)AND((_MODE==0)OR(_MODE==1))
_MK_NEU=TRUE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_MK_NEU=TRUE (Werkzeugwechsel)")
ENDIF
_M3_5=TRUNC($TC_DP25[_TI,GETDNO(_TI,1)]/256)MOD 4
IF(($P_SDIR[_F_S_NR[_SMODE-1]]-2)MOD 3<>_M3_5)AND(_S_NEU)
_M_NEU=TRUE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_M_NEU=TRUE (Werkzeugwechsel)")
ENDIF
S_M_OK=0
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"S_M_OK=0 (M3/4 und S)")
ENDIF
ENDIF
ENDIF
IF(_MODE==0)AND(_FAA==0)AND(_SA==0)
_M_NEU=FALSE
_MK_NEU=FALSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_M_NEU=FALSE (nur Werkzeugwechsel)")
WRITE(_LOG,_LOG_FILE,"_MK_NEU=FALSE (nur Werkzeugwechsel)")
ENDIF
ENDIF
IF(_MODE==3)OR(_MODE==4)OR(_MODE==5)OR(_MODE==6)OR(_MODE==9)
_M_NEU=FALSE
_MK_NEU=FALSE
ENDIF
IF(S_MK_OFF==TRUE)
_MK_NEU=TRUE
ENDIF
_Y_EXISTS=FALSE
_YY=NO_AXIS
IF($P_GG[6]==1)
_ZZ=$P_AXN3
_XX=$P_AXN1
IF(_F_TRAANG)OR(_F_Y_AXIS)
_YY=$P_AXN2
_Y_EXISTS=TRUE
ENDIF
ELSE
IF($P_GG[6]==2)
_ZZ=$P_AXN1
_XX=$P_AXN2
IF(_F_TRAANG)OR(_F_Y_AXIS)
_YY=$P_AXN3
_Y_EXISTS=TRUE
ENDIF
ELSE
_ZZ=$P_AXN2
_XX=$P_AXN3
IF(_F_TRAANG)OR(_F_Y_AXIS)
_YY=$P_AXN1
_Y_EXISTS=TRUE
ENDIF
ENDIF
ENDIF
IF(_D_NEU)AND($P_TOOL<>_DD)AND(NOT _T_NEU)AND($P_TOOLNO)
_F_D_NO=_DD
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(113) ; neue D-Nummer")
WRITE(_LOG,_LOG_FILE,"D"<<_DD)
ENDIF
CUST_TECHCYC(113)
D=_DD
ENDIF
IF(_T_NEU)
S_M_OK=0
S_MK_OK=0
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_T_NEU -> S_M_OK=0, S_MK_OK=0")
ENDIF
ENDIF
IF(_M_NEU)AND(S_M_OK==1)
_M_NEU=FALSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_M_NEU=FALSE (wurde schon ausgegeben)")
ENDIF
ENDIF
IF(_MK_NEU)AND(S_MK_OK==1)
_MK_NEU=FALSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_MK_NEU=FALSE (wurde schon ausgegeben)")
ENDIF
ENDIF
IF(_LOG_ON)
_CMD=""
IF(_T_NEU)
_CMD=_CMD<<" _T_NEU"
ENDIF
IF(_D_NEU)
_CMD=_CMD<<" (_D_NEU)"
ENDIF
IF(_TF_NEU)
_CMD=_CMD<<" _TF_NEU"
ENDIF
IF(_M_NEU)
_CMD=_CMD<<" _M_NEU"
ENDIF
IF(_MK_NEU)
_CMD=_CMD<<" _MK_NEU"
ENDIF
IF(_S_NEU)
_CMD=_CMD<<" _S_NEU"
ENDIF
IF(_F_NEU)
_CMD=_CMD<<" _F_NEU"
ENDIF
IF(_MS_NEU)
_CMD=_CMD<<" _MS_NEU"
ENDIF
WRITE(_LOG,_LOG_FILE,"To do:"<<_CMD)
ENDIF
IF(NOT(_T_NEU OR _TF_NEU OR _M_NEU OR _MK_NEU OR _S_NEU OR _F_NEU OR _MS_NEU))
GOTOF _RET
ENDIF
_TCI=$P_TC
_FAK4=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==3)
_FAK4=$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==4)
_FAK4=1/$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF(_TI>0)AND(_DD>0)
_MM1A:
_WTYP=$TC_DP1[_TI,_DD]
_WR=$TC_DP6[_TI,_DD]+$TC_DP15[_TI,_DD]
_MM2A:
ENDIF
IF(_M_NEU)AND(S_M_OK==0)
_MM1:
IF(S_M3_5)
_M3_5=S_M3_5-2
ELSE
IF(_TI>0)
_M3_5=TRUNC($TC_DP25[_TI,GETDNO(_TI,1)]/256)MOD 4
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"T: _M3_5="<<_M3_5)
ENDIF
ENDIF
ENDIF
IF(_M3_5==1)
_MB1=3
ELSE
IF(_M3_5==2)
_MB1=4
ELSE
_MB1=5
IF(_S_NEU)AND(_S>0) GOTOF _FEHL7
ENDIF
ENDIF
_HS_CDIR=($MCS_AXIS_USAGE_ATTRIB[_F_AX_NR[0]-1] B_AND'B1000')/'B1000'
_HS_SDIR=($MCS_AXIS_USAGE_ATTRIB[_F_AX_NR[0]-1] B_AND'B10000')/'B10000'
_HS_SDIRC=($MCS_AXIS_USAGE_ATTRIB[_F_AX_NR[0]-1] B_AND'B100000')/'B100000'
IF(_F_AX_EXISTS[2])
_GS_CDIR=($MCS_AXIS_USAGE_ATTRIB[_F_AX_NR[2]-1] B_AND'B1000')/'B1000'
_GS_SDIR=($MCS_AXIS_USAGE_ATTRIB[_F_AX_NR[2]-1] B_AND'B10000')/'B10000'
_GS_SDIRC=($MCS_AXIS_USAGE_ATTRIB[_F_AX_NR[2]-1] B_AND'B100000')/'B100000'
ELSE
_GS_CDIR=0 _GS_SDIR=0 _GS_SDIRC=0
ENDIF
IF(_MB1==3)OR(_MB1==4)
IF(SUBSTR($P_PROG[$P_STACK-1],3,7)=="F_DRILL")
IF(_WTYP==560)
IF($TC_DP2[_TI,_DD]==3)OR($TC_DP2[_TI,_DD]==4)
_MB1=7-_MB1
ENDIF
ENDIF
ENDIF
IF(_WTYP>=100)AND(_WTYP<300)AND((_SMODE==1)OR(_SMODE==3))
IF(_SMODE==1)
IF(_HS_CDIR==_HS_SDIRC)
_MB1=7-_MB1
ENDIF
ELSE
IF(_GS_CDIR==_GS_SDIRC)
_MB1=7-_MB1
ENDIF
ENDIF
ELSE
IF(_SMODE==3)AND(_HS_SDIR==_GS_SDIR)
_MB1=7-_MB1
ENDIF
ENDIF
ENDIF
IF(_WTYP==505)OR(_WTYP==515)OR(_WTYP==525)OR(_WTYP==535)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Y-Drehen: $P_CUT_INV="<<$P_CUT_INV)
ENDIF
IF($P_CUT_INV)AND((_MB1==3)OR(_MB1==4))
_MB1=7-_MB1
ENDIF
ELSE
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND((_WTYP>=500)AND(_WTYP<599))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"B: $P_CUT_INV="<<$P_CUT_INV)
ENDIF
IF($P_CUT_INV)AND((_MB1==3)OR(_MB1==4))
_MB1=7-_MB1
ENDIF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_MB1="<<_MB1)
ENDIF
IF($PC_TRAFO_TYPE_NAME=="TRAINT")
IF(S_INV_S_IPT)AND((_M3_5==1)OR(_M3_5==2))
_MB1=7-_MB1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: M"<<_MB1)
ENDIF
ENDIF
ENDIF
_MM2:
ENDIF
IF(_MK_NEU)AND(S_MK_OK==0)
S_MK_OK=1
_MMK1:
_M7_8=TRUNC($TC_DP25[_TI,GETDNO(_TI,1)]/1024)MOD 4
IF(S_MK_OFF)
_M7_8=0
ENDIF
IF((_M7_8 B_AND 3)==3)AND($MCS_M_CODE_COOLANT_1_AND_2_ON>-1)
_MB9=$MCS_M_CODE_ALL_COOLANTS_OFF
_MB4=$MCS_M_CODE_COOLANT_1_AND_2_ON
ELSE
IF(_M7_8 B_AND 1)
_MB2=$MCS_M_CODE_COOLANT_1_ON
ENDIF
IF(_M7_8 B_AND 2)
_MB3=$MCS_M_CODE_COOLANT_2_ON
ENDIF
IF(_M7_8==1)OR(_M7_8==2)
_MB9=$MCS_M_CODE_ALL_COOLANTS_OFF
ENDIF
ENDIF
IF(_M7_8==0)
_MB9=$MCS_M_CODE_ALL_COOLANTS_OFF
ENDIF
_MMK2:
ENDIF
IF(_S_NEU)
IF(_WTYP>=100)AND(_WTYP<300)
IF(_SA==2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Schnittgeschwindigkeit V="<<_S<<" WR="<<_WR<<" metric="<<$MN_SCALING_SYSTEM_IS_METRIC<<" "<<SUBSTR("G70 G71 G700G710",4*$P_GG[13]-4,4))
ENDIF
IF(_WR>0)
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]<>3)
_S=1000*_S/($PI*2*_WR*_FAK4)
ELSE
_S=12*_S/($PI*2*_WR)
ENDIF
ELSE
IF($P_GG[13]<>4)
_S=12*_S/($PI*2*_WR*_FAK4)
ELSE
_S=1000*_S/($PI*2*_WR)
ENDIF
ENDIF
IF(_S>999999)
_S=999999
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"-> S="<<_S)
ENDIF
IF(_SMODE==1)OR(_SMODE==3)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(4)")
ENDIF
F_SP_TRA(4)
ENDIF
IF(_SMODE==1)
IF($P_SMODE[_F_S_NR[0]]==4)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"   M["<<_F_S_NR[0]<<"]=5")
ENDIF
M[_F_S_NR[0]]=5
ENDIF
IF(_S>$AC_SMAXVELO[_F_S_NR[0]])
_S=$AC_SMAXVELO[_F_S_NR[0]]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"   $AC_SMAXVELO["<<_F_S_NR[0]<<"]="<<$AC_SMAXVELO[_F_S_NR[0]])
WRITE(_LOG,_LOG_FILE,"   $AC_SMAXVELO_INFO["<<_F_S_NR[0]<<"]="<<$AC_SMAXVELO_INFO[_F_S_NR[0]])
ENDIF
ENDIF
ENDIF
IF(_SMODE==3)
IF($P_SMODE[_F_S_NR[2]]==4)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"   M["<<_F_S_NR[2]<<"]=5")
ENDIF
M[_F_S_NR[2]]=5
ENDIF
IF(_S>$AC_SMAXVELO[_F_S_NR[2]])
_S=$AC_SMAXVELO[_F_S_NR[2]]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"   $AC_SMAXVELO["<<_F_S_NR[2]<<"]="<<$AC_SMAXVELO[_F_S_NR[2]])
WRITE(_LOG,_LOG_FILE,"   $AC_SMAXVELO_INFO["<<_F_S_NR[2]<<"]="<<$AC_SMAXVELO_INFO[_F_S_NR[2]])
ENDIF
ENDIF
ENDIF
ELSE
GOTOF _FEHL2
ENDIF
ELSE
IF(_SMODE==1)OR(_SMODE==3)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(4)")
ENDIF
F_SP_TRA(4)
ENDIF
ENDIF
ENDIF
IF(_WTYP>=500)AND(_WTYP<=599)
IF(_SMODE==1)OR(_SMODE==3)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(4)")
ENDIF
F_SP_TRA(4)
ENDIF
ENDIF
ENDIF
IF(_T_NEU)
IF(_MODE<>2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(300)")
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(4)")
ENDIF
F_SP_TRA(300)
F_SP_TRA(4)
ENDIF
IF(_SMODE==2)OR(_MB1==5)OR(_TI<=0)OR((_S==0)AND(_SA>0))
IF($P_SMODE[_F_S_NR[_F_MASPI]]==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"M["<<_F_S_NR[_F_MASPI]<<"]=5")
ENDIF
M[_F_S_NR[_F_MASPI]]=5
ENDIF
ENDIF
_F_SP_CL_TURN=0
IF(_MODE==3)OR(_MODE==8)
_E_L6=0
ELSE
_E_L6=1
ENDIF
IF(_T<>"")
IF($P_TOOLNO>0)AND($P_TOOL>0)
_M7_8_ALT=TRUNC($TC_DP25[$P_TOOLNO,GETDNO($P_TOOLNO,1)]/1024)MOD 4
ENDIF
IF(_MODE<>2)
MCALL
ENDIF
IF(_TI==-1)
GOTOF _FEHL8
ENDIF
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_TCI)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Schwenkdaten merken")
ENDIF
_NPV=$P_GG[8]
S_P52=$P_GG[52]
S_P53=$P_GG[53]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"$P_WPFRAME merken")
IF(_Y_EXISTS)
WRITE(_LOG,_LOG_FILE,"  Trans("<<$P_WPFRAME[_XX,TR]<<"/"<<$P_WPFRAME[_YY,TR]<<"/"<<$P_WPFRAME[_ZZ,TR]<<")")
WRITE(_LOG,_LOG_FILE,"  Rot  ("<<$P_WPFRAME[_XX,RT]<<"/"<<$P_WPFRAME[_YY,RT]<<"/"<<$P_WPFRAME[_ZZ,RT]<<")")
ELSE
WRITE(_LOG,_LOG_FILE,"  Trans("<<$P_WPFRAME[_XX,TR]<<"/"<<$P_WPFRAME[_ZZ,TR]<<")")
WRITE(_LOG,_LOG_FILE,"  Rot  ("<<$P_WPFRAME[_XX,RT]<<"/"<<$P_WPFRAME[_ZZ,RT]<<")")
ENDIF
ENDIF
_WPFR=$P_WPFRAME
_AX1_MODE=TRUNC($TC_CARR37[_TCI]/10) MOD 10
_AX2_MODE=TRUNC($TC_CARR37[_TCI]/100) MOD 10
CYCLE213(_TCI)
_AX1_NAME=$TC_CARR35[_TCI]
_AX2_NAME=$TC_CARR36[_TCI]
IF(_MODE<>2)AND(_MODE<>6)AND(_AX1_MODE==0)AND(_AX1_NAME<>"")
_A1=$P_EP[AXNAME(_AX1_NAME)]
ELSE
_A1=$TC_CARR13[_TCI]
ENDIF
IF(_MODE<>2)AND(_MODE<>6)AND(_AX2_MODE==0)AND(_AX2_NAME<>"")
_A2=$P_EP[AXNAME(_AX2_NAME)]
ELSE
_A2=$TC_CARR14[_TCI]
ENDIF
S_A1TC=$P_TCANG[1]
S_A2TC=$P_TCANG[2]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Position Schwenkkopf merken:")
WRITE(_LOG,_LOG_FILE,"  Rundachspositionen: "<<_A1<<"/"<<_A2)
WRITE(_LOG,_LOG_FILE,"  Toolcarrier:        "<<S_A1TC<<"/"<<S_A2TC)
ENDIF
_TC37=TRUNC($TC_CARR37[_TCI]/100000000) MOD 10
IF(_TC37 B_AND 'B001')AND($TC_CARR23[_TCI]<>"P")
_WZGW=1
ELSE
_WZGW=2
ENDIF
S_TC_FR=_TC_FR
S_TC_ST=_TC_ST
S_TC_MODE=_TC_MODE
S_TC_P[5]=_TC_P[5]
S_TC_P[6]=_TC_P[6]
S_TC_P[7]=_TC_P[7]
S_TC_N_WZ=_TC_N_WZ
S_TC_A_WZ=_TC_A_WZ
S_TC_A1=_TC_A1
S_TC_A2=_TC_A2
S_TC_NUM=_TC_NUM
ENDIF
IF($P_TOOLNO>0)
IF($A_MYMN[$P_TOOLNO]==0)
_HND_ALT=1
ELSE
_HND_ALT=0
ENDIF
ENDIF
IF(_TI>0)
IF($A_MYMN[_TI]==0)
_HND_NEU=1
ELSE
_HND_NEU=0
ENDIF
ENDIF
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_TI>0)AND(_TCI>0)AND(_WZGW<>2)AND(NOT _HND_NEU) GOTOF _FEHL4
IF(_MODE<>3)AND(_MODE<>8)AND(_MODE<>9)AND((_MODE<>2)OR(_E_JS_PRG>0))
IF(_WZW)OR((_WTYP<>731)AND(_WTYP<>732))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Werkzeugwechselposition anfahren")
ENDIF
N10 F_SP_RP(2,,,1)
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Werkzeugwechselposition nicht anfahren (_WTYP="<<_WTYP<<")")
ENDIF
ENDIF
ENDIF
IF(_MODE<>3)AND(_MODE<>4)AND(_MODE<>9)
IF(_SMODE==2)
ELSE
IF(NOT((_MB1==5)OR(_S<=0)OR(_SA<>1)OR(_TI<=0)OR(_HND_ALT)OR(_HND_NEU)))
_MSP=$P_MSNUM
IF(_SMODE==3)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"SETMS("<<_F_S_NR[2]<<")")
ENDIF
SETMS(_F_S_NR[2])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(22) ; Gegenspindel in Spindelbetrieb")
ENDIF
CUST_TECHCYC(22)
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"SETMS("<<_F_S_NR[0]<<")")
ENDIF
SETMS(_F_S_NR[0])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(2) ; Hauptspindel in Spindelbetrieb")
ENDIF
CUST_TECHCYC(2)
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"G972 M="<<_MB1<<" S="<<_S)
ENDIF
G972 M=_MB1 S=_S
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"SETMS("<<_MSP<<")")
ENDIF
SETMS(_MSP)
ENDIF
ENDIF
ENDIF
IF(_F_AX_EXISTS[1])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(42) ; angetriebenes Werkzeug auskuppeln")
ENDIF
CUST_TECHCYC(42)
ENDIF
IF(_HND_ALT)AND(_HND_NEU)
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_TCI)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N100 CUST_800(3,"<<_TCI<<")")
ENDIF
N100 CUST_800(3,_TCI)
ENDIF
ELSE
IF(_HND_ALT)
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_TCI)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N110 CUST_800(3,"<<_TCI<<")")
ENDIF
N110 CUST_800(3,_TCI)
ENDIF
ENDIF
IF(_HND_NEU)
REPEAT S_GET_T_NR_A S_GET_T_NR_E
IF(S_TI)
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_TCI)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N120 CUST_800(2,"<<_TCI<<")")
ENDIF
N120 CUST_800(2,_TCI)
ENDIF
_F_T_STR="0"
_F_DP_NO=-1
_F_T_MP=-1
_F_MTL=-1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(117) ; vor T-Befehl")
ENDIF
CUST_TECHCYC(117)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"T0")
ENDIF
T0
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(110) ; nach T-Befehl")
ENDIF
CUST_TECHCYC(110)
IF($MC_TOOL_CHANGE_MODE==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"M6")
ENDIF
M6
ENDIF
ENDIF
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_TCI)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N130 CUST_800(3,"<<_TCI<<")")
ENDIF
N130 CUST_800(3,_TCI)
ENDIF
ENDIF
ENDIF
IF(NOT _HND_ALT)AND(NOT _HND_NEU)
REPEAT S_GET_T_NR_A S_GET_T_NR_E
IF(S_TI<>_TI)
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_TCI)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N140 CUST_800(2,"<<_TCI<<")")
ENDIF
N140 CUST_800(2,_TCI)
ENDIF
ENDIF
ENDIF
WRTPR("IGNORE(16,0)",1)
IF(_T=="0")
_F_T_STR="0"
_F_DP_NO=-1
_F_T_MP=-1
_F_MTL=-1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(117) ; vor T-Befehl")
ENDIF
CUST_TECHCYC(117)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"T0 ;Werkzeug entladen")
ENDIF
T0
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_DD=0 (wegen T0)")
ENDIF
_DD=0
ELSE
IF(_DP)
_F_T_STR=_T
_F_DP_NO=_DP
_F_T_MP=-1
_F_MTL=-1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(117) ; vor T-Befehl")
ENDIF
CUST_TECHCYC(117)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"TCA("<<_T<<","<<_DP<<")")
ENDIF
TCA(_T,_DP)
ELSE
_F_T_STR=_T
_F_DP_NO=-1
_F_T_MP=-1
_F_MTL=-1
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(117) ; vor T-Befehl")
ENDIF
CUST_TECHCYC(117)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"T="<<_T)
ENDIF
T=_T
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(110) ; nach T-Befehl")
ENDIF
CUST_TECHCYC(110)
IF($MC_TOOL_CHANGE_MODE==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"M6")
ENDIF
M6
ENDIF
GETEXET(_TIN)
IF(_TIN<>_TI)AND(_TIN>0)
_TI=_TIN
REPEAT _MM1A _MM2A
REPEAT _MM1 _MM2
REPEAT _MMK1 _MMK2
ENDIF
_F_RP_DIR[0]=0
IF($MCS_REV_2_BORDER_TOOL_LENGTH)AND($P_TOOLNO)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"D"<<_DD)
WRITE(_LOG,_LOG_FILE,"F_T_REV2")
ENDIF
D=_DD
F_T_REV2
ENDIF
WRTPR("IGNORE(32,0)",1)
IF($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_TCI)AND(_MODE<>4)AND(_MODE<>5)AND(_MODE<>6)
IF(NOT((_WTYP>=500)AND(_WTYP<=599)))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Toolcarrier rekonstruieren")
ENDIF
$P_WPFRAME=_WPFR
$P_WPFR=$P_WPFRAME
G[8]=_NPV
IF(_LOG_ON)
IF(_Y_EXISTS)
WRITE(_LOG,_LOG_FILE,"  $P_WPFRAME rekonstruieren ("<<_WPFR[_XX,RT]<<"/"<<_WPFR[_YY,RT]<<"/"<<_WPFR[_ZZ,RT]<<")")
ELSE
WRITE(_LOG,_LOG_FILE,"  $P_WPFRAME rekonstruieren ("<<_WPFR[_XX,RT]<<"/"<<_WPFR[_ZZ,RT]<<")")
ENDIF
ENDIF
_A1=$TC_CARR13[_TCI]
_A2=$TC_CARR14[_TCI]
$TC_CARR13[_TCI]=S_A1TC
$TC_CARR14[_TCI]=S_A2TC
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  $TC_CARR13="<<$TC_CARR13[_TCI]<<" $TC_CARR14="<<$TC_CARR14[_TCI])
ENDIF
N800 TCARR=_TCI TCOABS
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  N800 TCARR="<<_TCI<<" TCOABS")
ENDIF
IF(NOT $P_SEARCH)AND(NOT $AC_SERUPRO)AND(NOT $P_ISTEST)AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100'))
IF($MC_TOOL_CARRIER_RESET_VALUE<>_TCI)
STOPRE
$MC_TOOL_CARRIER_RESET_VALUE=_TCI
ENDIF
ENDIF
$TC_CARR13[_TCI]=_A1
$TC_CARR14[_TCI]=_A2
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  $TC_CARR13="<<$TC_CARR13[_TCI]<<" $TC_CARR14="<<$TC_CARR14[_TCI])
ENDIF
_TC_A1=$P_TCANG[1]
_TC_A2=$P_TCANG[2]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  _TC_A1="<<_TC_A1<<" _TC_A2="<<_TC_A2)
ENDIF
_TC_FR=S_TC_FR
_TC_ST=S_TC_ST
_TC_MODE=S_TC_MODE
_TC_P[5]=S_TC_P[5]
_TC_P[6]=S_TC_P[6]
_TC_P[7]=S_TC_P[7]
_TC_N_WZ=S_TC_N_WZ
_TC_A_WZ=S_TC_A_WZ
_TC_A1=S_TC_A1
_TC_A2=S_TC_A2
_TC_NUM=S_TC_NUM
N52 G[52]=S_P52
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  N52 G[52]="<<S_P52<<" -> "<<SUBSTR("PAROTOFPAROT",(S_P52-1)*7,7))
ENDIF
N53 G[53]=S_P53
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  N53 G[53]="<<S_P53<<" -> "<<SUBSTR("TOROTOF TOROT   TOROTZ  TOROTY  TOROTX  TOFRAME TOFRAMEZTOFRAMEYTOFRAMEX",(S_P53-1)*8,8))
ENDIF
ENDIF
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Toolcarrier nicht wieder anwaehlen (_MODE="<<_MODE<<")")
ENDIF
ENDIF
IF(_MODE<>0)
IF(_MODE<>2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(200)")
ENDIF
F_SP_TRA(200)
ENDIF
ENDIF
ELSE
_DD=$P_TOOL
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"D="<<_DD)
ENDIF
D=_DD
_E_L6=0
ENDIF
IF(_MS_NEU)
_CMD="SETMS("<<_F_S_NR[_SMODE-1]<<")"
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Kommandostring 1: "<<_CMD)
ENDIF
EXECSTRING(_CMD)
IF(_SMODE==2)AND((_WTYP<500)OR(_WTYP>599))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(41) ; Werkzeug einkuppeln")
ENDIF
CUST_TECHCYC(41)
ENDIF
ENDIF
IF(_M_NEU)
IF(_MB1==3)OR(_MB1==4)
IF(_WTYP>=100)AND(_WTYP<300)AND((_SMODE==1)OR(_SMODE==3))
IF((_F_S_NR[1]>0)AND($P_SDIR[_F_S_NR[1]]==5))
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(42) ; Bohrwerkzeug auskuppeln")
ENDIF
CUST_TECHCYC(42)
ENDIF
ENDIF
ENDIF
ENDIF
IF(_S_NEU)
IF(_WTYP>=500)AND(_WTYP<599)
IF(_SMODE==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(2) ; Hauptspindel in Spindelbetrieb")
ENDIF
CUST_TECHCYC(2)
ENDIF
IF(_SMODE==3)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(22) ; Gegenspindel in Spindelbetrieb")
ENDIF
CUST_TECHCYC(22)
ENDIF
ENDIF
ENDIF
IF(_F_NEU)
_F_OK=TRUE
IF($P_F_TYPE==11)OR($P_F_TYPE==33)
IF(_FAA<>2)
_F_OK=FALSE
ENDIF
ELSE
IF($P_F_TYPE==1)OR($P_F_TYPE==3)
IF(_FAA<>3)
_F_OK=FALSE
ENDIF
ELSE
IF(_FAA<>1)
_F_OK=FALSE
ENDIF
ENDIF
ENDIF
ENDIF
IF(_F_NEU)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"_F_NEU: G[15]="<<$P_GG[15]<<" _FAA="<<_FAA<<" _SA="<<_SA<<" _WTYP="<<_WTYP)
ENDIF
IF(_FAA==1)
IF(_WTYP>=100)AND(_WTYP<300)
IF($P_GG[15]<>2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G94")
ENDIF
G94
ENDIF
ELSE
IF(_FAA==1)AND(_SA==0)
IF($P_GG[15]<>2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G942")
ENDIF
G942
ENDIF
ENDIF
IF(_FAA==1)AND(_SA==1)
IF($P_GG[15]<>2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G94 S="<<_S)
ENDIF
G94 S=_S
ENDIF
ENDIF
IF(_FAA==1)AND(_SA==2)
IF($P_GG[15]<>7)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G961 S="<<_S)
ENDIF
G961 S=_S
ENDIF
ENDIF
ENDIF
ENDIF
IF(_FAA==2)OR(_FAA==3)
IF(_FAA==2)
IF((_WTYP<100)OR(_WTYP>199))AND(_WTYP<>220)
GOTOF _FEHL1
ENDIF
ENDIF
IF(_WTYP>=100)AND(_WTYP<300)
IF($P_GG[15]<>3)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G95")
ENDIF
G95
ENDIF
ELSE
IF(_FAA==3)AND(_SA==0)
IF($P_GG[15]<>3)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G952")
ENDIF
G952
ENDIF
ENDIF
IF(_FAA==3)AND(_SA==1)
IF($P_GG[15]<>3)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G95 S="<<_S)
ENDIF
G95 S=_S
ENDIF
ENDIF
IF(_FAA==3)AND(_SA==2)
IF($P_GG[15]<>4)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G96 S="<<_S)
ENDIF
G96 S=_S
ENDIF
ENDIF
ENDIF
ENDIF
ENDIF
IF(_M_NEU)AND(_S_NEU)AND(NOT _F_NEU)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  M,S ohne F")
ENDIF
IF(_SA==1)
IF($P_GG[15]==4)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G95")
ENDIF
G95
ENDIF
IF($P_GG[15]==7)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G94")
ENDIF
G94
ENDIF
ENDIF
IF(_SA==2)
IF($P_MSNUM==_F_S_NR[1])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G95")
ENDIF
G95
ELSE
IF($P_GG[15]==2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G961 S="<<_S)
ENDIF
G961 S=_S
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  G96 S="<<_S)
ENDIF
G96 S=_S
ENDIF
ENDIF
ENDIF
ENDIF
IF(_F_OK)
IF($P_F_TYPE==11)OR($P_F_TYPE==33)
_F_OK=(_F==$P_FZ)AND(_FAA==2)
ELSE
_F_OK=(_F==$P_F)AND(_FAA<>2)
ENDIF
ENDIF
IF(_F_NEU==FALSE)OR(_FAA<1)OR(_FAA>3)OR(_F_OK)
_F=-1
ENDIF
IF(_S_NEU==FALSE)OR(_SA<1)OR(_SA>2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  S nicht ausgeben")
ENDIF
_S=-1
ENDIF
IF(_MB9>0)
IF($MCS_ENABLE_QUICK_M_CODES B_AND 'B0001')
_CMD="M=QU("<<_MB9<<")"
ELSE
_CMD="M="<<_MB9
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Kommandostring 2: "<<_CMD)
ENDIF
EXECSTRING(_CMD)
ENDIF
_CMD=""
IF(_S>=0)
_CMD=_CMD<<"S="<<_S<<" "
ENDIF
IF(_F>=0)
IF(_FAA==2)
_CMD=_CMD<<"FZ="<<_F<<" "
ELSE
IF(_FAA==3)
_CMD=_CMD<<"F="<<_F<<" "
ELSE
_CMD=_CMD<<"F="<<_F<<" "
ENDIF
ENDIF
ENDIF
IF(_M_NEU)
_CMD=_CMD<<"M="<<_MB1<<" "
ENDIF
IF(_MB2>0)
IF($MCS_ENABLE_QUICK_M_CODES B_AND 'B0010')
_CMD=_CMD<<"M=QU("<<_MB2<<") "
ELSE
_CMD=_CMD<<"M="<<_MB2<<" "
ENDIF
ENDIF
IF(_MB3>0)
IF($MCS_ENABLE_QUICK_M_CODES B_AND 'B0100')
_CMD=_CMD<<"M=QU("<<_MB3<<") "
ELSE
_CMD=_CMD<<"M="<<_MB3<<" "
ENDIF
ENDIF
IF(_MB4>0)
IF($MCS_ENABLE_QUICK_M_CODES B_AND 'B1000')
_CMD=_CMD<<"M=QU("<<_MB4<<") "
ELSE
_CMD=_CMD<<"M="<<_MB4<<" "
ENDIF
ENDIF
IF(_CMD<>"")
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Kommandostring 3: "<<_CMD)
ENDIF
EXECSTRING(_CMD)
ENDIF
IF(_MK_NEU)
_CMD=""
IF($P_TOOLNO>0)AND($P_TOOL>0)
_I=$TC_DP25[$P_TOOLNO,1]
ELSE
_I=0
ENDIF
IF(_I B_AND 1)
IF($MCS_TOOL_MCODE_FUNC_ON[0] <> -1)
_CMD=_CMD<<"M="<<$MCS_TOOL_MCODE_FUNC_ON[0]<<" "
ENDIF
ELSE
IF($MCS_TOOL_MCODE_FUNC_OFF[0] <> -1)
_CMD=_CMD<<"M="<<$MCS_TOOL_MCODE_FUNC_OFF[0]<<" "
ENDIF
ENDIF
IF(_I B_AND 2)
IF($MCS_TOOL_MCODE_FUNC_ON[1] <> -1)
_CMD=_CMD<<"M="<<$MCS_TOOL_MCODE_FUNC_ON[1]<<" "
ENDIF
ELSE
IF($MCS_TOOL_MCODE_FUNC_OFF[1] <> -1)
_CMD=_CMD<<"M="<<$MCS_TOOL_MCODE_FUNC_OFF[1]<<" "
ENDIF
ENDIF
IF(_I B_AND 4)
IF($MCS_TOOL_MCODE_FUNC_ON[2] <> -1)
_CMD=_CMD<<"M="<<$MCS_TOOL_MCODE_FUNC_ON[2]<<" "
ENDIF
ELSE
IF($MCS_TOOL_MCODE_FUNC_OFF[2] <> -1)
_CMD=_CMD<<"M="<<$MCS_TOOL_MCODE_FUNC_OFF[2]<<" "
ENDIF
ENDIF
IF(_I B_AND 8)
IF($MCS_TOOL_MCODE_FUNC_ON[3] <> -1)
_CMD=_CMD<<"M="<<$MCS_TOOL_MCODE_FUNC_ON[3]<<" "
ENDIF
ELSE
IF($MCS_TOOL_MCODE_FUNC_OFF[3] <> -1)
_CMD=_CMD<<"M="<<$MCS_TOOL_MCODE_FUNC_OFF[3]<<" "
ENDIF
ENDIF
IF(_CMD<>"")
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Kommandostring 4: "<<_CMD)
ENDIF
EXECSTRING(_CMD)
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(118) ; Ausgabe von M- und H-Funktionen")
ENDIF
CUST_TECHCYC(118)
ENDIF
IF(_TF_NEU)
GETSELT(_TFA)
_F_TFI=_TFI
_F_TF=_TF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(119): "<<_F_TFI<<" "<<_F_TF<<" vor Werkzeugvoranwahl")
ENDIF
CUST_TECHCYC(119)
IF(_TFI<>_TFA)
IF(_TFI==0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Folgewerkzeug: T0")
ENDIF
T0
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"  Folgewerkzeug: T="<<_TF)
ENDIF
T=_TF
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(115): "<<_F_TFI<<" "<<_F_TF<<" nach Werkzeugvoranwahl")
ENDIF
CUST_TECHCYC(115)
ENDIF
SBLON
_RET:
_F_RPT[0]=_F_RPTM[_F_MASPI/2,0]
_F_RPT[1]=_F_RPTM[_F_MASPI/2,1]
_F_RPT[2]=_F_RPTM[_F_MASPI/2,2]
_F_RPT[3]=_F_RPTM[_F_MASPI/2,3]
_F_RPT[4]=_F_RPTM[_F_MASPI/2,4]
IF(_T_NEU)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(111) ; nach Werkzeugwechselzyklusende mit Werkzeugwechsel")
ENDIF
CUST_TECHCYC(111)
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC(114) ; nach Werkzeugwechselzyklusende ohne Werkzeugwechsel")
ENDIF
CUST_TECHCYC(114)
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Ende Werkzeugwechselzyklus F_TFS (G[15]="<<$P_GG[15]<<")")
ENDIF
IF($AC_SERUPRO)AND(NOT($MN_SIM_ENVIRONMENT B_AND 'B100'))
IF(_E_SEARCH[3]==$P_LINENO[0])
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_RP(8,,,1)")
ENDIF
F_SP_RP(8,,,1)
IF(NOT((_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')))OR(_MODE==1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"SSL-Label: UP-Ebene="<<$P_STACK<<" Zeile="<<$P_LINENO[0])
ENDIF
F_SP_LAB
ENDIF
ENDIF
ENDIF
RET
S_GET_T_NR_A:
GETEXET(S_TI,,"S")
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Spindelwerkzeug: S_TI="<<S_TI)
ENDIF
S_GET_T_NR_E:
_FEHL1: STOPRE
N932101 SETAL(61216)
RET
_FEHL2: STOPRE
N932102 SETAL(61217)
RET
_FEHL3: STOPRE
N932103 SETAL(61218)
RET
_FEHL4: STOPRE
N932104 SETAL(61232)
RET
_FEHL5: STOPRE
N932105 SETAL(61283)
RET
_FEHL6: STOPRE
N932106 SETAL(61287)
RET
_FEHL7: STOPRE
N932107 SETAL(61293,_T)
RET
_FEHL8: STOPRE
N932108 SETAL(61343,_T)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_TR_CHN_SPF
PROC F_TR_CHN(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F1,REAL _F2,REAL _F3,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,INT _SN,REAL __X0,INT _X0A,REAL _Z0,INT _Z0A,REAL __X1,INT _X1A,REAL _Z1,INT _Z1A,REAL _X2,INT _X2A,REAL _Z2,INT _Z2A,REAL _X3,INT _X3A,REAL _Z3,INT _Z3A,REAL _W,REAL _R,REAL _KK,REAL _A,INT _AS,REAL _V,REAL _U,REAL _QQ,INT _QA,INT _L,REAL _GW,REAL _I,INT _AA,INT _F1ZG,INT _F1ZZ,INT _F1ZN,INT _F2ZG,INT _F2ZZ,INT _F2ZN,INT _F3ZG,INT _F3ZZ,INT _F3ZN,_E_MAC_TR_CHN) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.007 ;DATE: 2024-04-26
;ShopTurn: Thread-chaining
DEF AXIS _XX,_ZZ,_YYR
DEF INT _BA1,_AI,_LP,_PM,_P29,_TYP,_P2RP,_TM2,_TM3,_TM8,_P15,_MAN,_PITA,_VARI[8],_AMODE[10],_DMODE,S_MODE_BC
DEF REAL _X,_Z,_DX,_DZ,_PO1,_DM1,_FPL,_DM2,_FAK1,_FAK2,_FAK3,_FF,_YS,_X0,_X1,_IANG,S_ROT_Z,S_F1
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
IF(_E_SM_PRG)AND((_TMOD _DEC4)==0) GOTOF _FEHL9
IF(_E_ST_PRG)AND((_TMOD _DEC4)==1) GOTOF _FEHL10
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK3=1/$MN_SCALING_VALUE_INCH
ELSE
_FAK3=1
ENDIF
IF(_FAA _DEC2 == 0)
_PITA=1
S_F1=_F1*_FAK3
ELSE
IF(_FAA _DEC1 == 0)
_PITA=1
S_F1=_F1*_FAK3
ELSE
IF(_FAA _DEC1 == 1)
_PITA=3
S_F1=_F1*$MN_SCALING_VALUE_INCH*_FAK3
ELSE
IF(_FAA _DEC1 == 2)
_PITA=4
S_F1=_F1*$PI*_FAK3
ELSE
_PITA=2
S_F1=$MN_SCALING_VALUE_INCH/_F1*_FAK3
ENDIF
ENDIF
ENDIF
ENDIF
_X0=__X0 _X1=__X1
IF(_X0A==90)
_X0=_X0/2
ENDIF
_DM2=_X1
IF(_X1A==90)
_X1=_X1/2
ENDIF
IF(_X1A<>1)
_AMODE[2]=_X1A MOD 2
ELSE
_AMODE[2]=2
ENDIF
_AMODE[2]=_AMODE[2]*10
IF(_X2A<>1)
_AMODE[4]=_X2A MOD 2
ELSE
_AMODE[4]=2
ENDIF
_AMODE[4]=_AMODE[4]*1000
_AMODE[3]=(_Z2A MOD 2)*100
IF(_X3A<>1)
_AMODE[6]=_X3A MOD 2
ELSE
_AMODE[6]=2
ENDIF
_AMODE[6]=_AMODE[6]*100000
_AMODE[5]=(_Z3A MOD 2)*10000
_MAN=TRUNC(_TMOD/10) MOD 10
IF(_E_SM_PRG)
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H0000')
DIAM90
ELSE
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H8000')
DIAMON
ELSE
DIAMOF
ENDIF
ENDIF
ENDIF
_P29=$P_GG[29]
DIAMCYCOF
_P15=$P_GG[15]
_FF=$P_F
N10 G40 G90
IF(_MAN==0)
IF(_E_SM_PRG)
N80 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=S_FR_M
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
_ZZ=$P_AXN1
S_ROT_Z=$P_ACTFRAME[_ZZ,RT]
N81 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
IF($P_ACTFRAME[_ZZ,RT]<>S_ROT_Z)
IF($P_EP[_ZZ]*_FAK1<_F_RPT[1]*_FAK2)
N815 G0 G90 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
ENDIF
N82 E_TFS(_T,_TF,_DD,S_F1,3,_S,_SA,0)
ELSE
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N16 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
N17 F_SP_BC(4,_BETA,_GAMA)
N18 F_TFS(_T,_TF,_DD,S_F1,3,_S,_SA,1,7)
ELSE
N19 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
N191 F_TFS(_T,_TF,_DD,S_F1,3,_S,_SA,1,7)
ENDIF
ENDIF
ELSE
IF($MCS_TECHNOLOGY==2)
N70 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=0
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
N71 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
N72 E_TFS(_T,_TF,_DD,S_F1,3,_S,_SA,0)
ELSE
_F_INIT=2
_F_RELEAS=1
IF(_MAN==1)
_F_MASPI=0
N21 F_TFS(_T,,_DD,S_F1,3,_S,_SA,1,8)
ELSE
_F_MASPI=2
N22 F_TFS(_T,,_DD,S_F1,3,_S,_SA,3,8)
ENDIF
F_SP_TRA(2040)
ENDIF
ENDIF
_TYP=$P_AD[1]
IF(_TYP<500)OR(_TYP>599) GOTOF _FEHL7
; Bearbeitungsart pruefen:
_BA1=_BA B_AND 'B0011'
IF(_BA1==0)GOTOF _FEHL2
_XX=$P_AXN2 _ZZ=$P_AXN1
_X=$P_EP[_XX]*_FAK1 _Z=$P_EP[_ZZ]*_FAK1
IF(_F_Y_AXIS==1)
_YYR=$P_AXN3
_YS=$P_EP[_YYR]*_FAK1
ENDIF
IF(_X0A<>90)
_X0=_X0+_X
ENDIF
IF(_Z0A<>90)
_Z0=_Z0+_Z
ENDIF
IF(_Z1A<>90)
_Z1=_Z0+_Z1
ENDIF
_FPL=_Z1 _AMODE[1]=0
IF(_X1A==91)
_X1=_X0+_X1
ELSE
IF(_X1A==1)
IF(_X1<=-90)OR(_X1>=90) GOTOF _FEHL6
_X1=_X0+(ABS(_Z1-_Z0))*TAN(_X1)
ENDIF
ENDIF
_DX=_X1-_X0 _DZ=_Z1-_Z0
IF(_SN==0)OR(_BA1==2)
_AS=1 _BA1=2
_U=0
ENDIF
IF(_SN==0)OR(_BA1==1)
_AS2=0
ENDIF
_TM2=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM8=TRUNC(_TMOD/10000000) MOD 10
_KK=ABS(_KK)
IF(_TM3)
_KK=-_KK
ENDIF
IF(_SN<0)OR(_SN>2) GOTOF _FEHL2
IF(_KK==0) GOTOF _FEHL5
IF(_DX==0)AND(_DZ==0) GOTOF _FEHL4
IF(_F1<=0) GOTOF _FEHL3
IF(_W<0) GOTOF _FEHL4
IF(_QA==1)GOTOF _MA1
_L=1
_AMODE[8]=10000000
IF(_QQ>=0)GOTOF _MA2
_QQ=_QQ+360
_MA2:
IF(_QQ<0)OR(_QQ>=360)GOTOF _FEHL2
GOTOF _MAA
_MA1:
IF(_GW<0)GOTOF _FEHL2
_QQ=0
_AMODE[8]=20000000
_VARI[7]=1000000
_MAA:
_LP=0
IF(ABS(_DX)>ABS(_DZ))GOTOF _MR1
_LP=1
_MR1:
_AI=_KK/ABS(_KK)
IF(_LP==1)
_PM=(_Z1-_Z0)/ABS(_Z1-_Z0)
ELSE
_PM=(_X1-_X0)/ABS(_X1-_X0)
ENDIF
IF(_LP==1)
IF(_KK>0)
_P2RP=0
ELSE
_P2RP=2
ENDIF
ELSE
IF(_KK>0)
_P2RP=4
ELSE
_P2RP=6
ENDIF
ENDIF
IF(_MAN==0)
F_SP_RPT(0,_P2RP)
ENDIF
_VARI[2]=10
_VARI[4]=0
IF(_SN==0)OR(_SN==1)
IF(_KK>0)
_VARI[1]=1
ELSE
_VARI[1]=2
ENDIF
ELSE
IF(_KK>0)
_VARI[1]=3
ELSE
_VARI[1]=4
ENDIF
ENDIF
_VARI[6]=(_BA B_AND 'B0011')*100000
IF(_BA B_AND 'B110000' == 'B010000')
_VARI[3]=300
ELSE
IF(_BA B_AND 'B110000' == 'B100000')
_VARI[3]=400
ELSE
_VARI[3]=0
ENDIF
ENDIF
IF(_BA B_AND 'B1000' == 'B1000')
_VARI[5]=10000
ELSE
_VARI[5]=0
ENDIF
_VARI[0]=_VARI[1]+_VARI[2]+_VARI[3]+_VARI[4]+_VARI[5]+_VARI[6]+_VARI[7]
_KK=ABS(_KK)
_PO1=_Z0
_DM1=2*_X0
IF(_AA==0)
_IANG=_I _AMODE[7]=1000000
ELSE
_IANG=_A _AMODE[7]=0
ENDIF
IF(_BA B_AND 'B1000000000000')
_AMODE[9]=100000000
ELSE
_AMODE[9]=0
ENDIF
_AMODE[0]=_AMODE[1]+_AMODE[2]+_AMODE[3]+_AMODE[4]+_AMODE[5]+_AMODE[6]+_AMODE[7]+_AMODE[8]+_AMODE[9]
_DMODE=0
IF(_TM8==1)
_DMODE=_DMODE+10000
ENDIF
IF(_MAN==0)
IF(_LP==1)
IF(_AI==-1)
F_SP_RP(3,_DM1/2+_V*_AI,_PO1)
ENDIF
N25 F_SP_RP(0,_DM1/2+_V*_AI,_PO1,0)
SBLON
N26 G0 G90 AX[_XX]=_F_RP_ACT*_FAK2 AX[_ZZ]=_PO1-ABS(_W)*_PM
SBLOF
ELSE
IF(_AI==-1)
F_SP_RP(3,_DM1/2,_PO1+_V*_AI)
ENDIF
N28 F_SP_RP(0,_DM1/2,_PO1+_V*_AI,0)
SBLON
N29 G0 G90 AX[_XX]=_DM1/2-ABS(_W)*_PM AX[_ZZ]=_F_RP_ACT*_FAK2
SBLOF
ENDIF
F_SP_TRA(1040)
ELSE
IF(_LP==1)
IF((_X*_AI<=_X0*_AI)OR(_Z*_PM>=_Z0*_PM)) GOTOF _FEHL8
SBLON
IF(_F_Y_AXIS==0)
N30 G0 G90 AX[_XX]=_X0+_V*_AI AX[_ZZ]=_PO1-ABS(_W)*_PM
ELSE
N32 G0 G90 AX[_XX]=_X0+_V*_AI AX[_ZZ]=_PO1-ABS(_W)*_PM AX[_YYR]=0
ENDIF
SBLOF
ELSE
IF((_Z*_AI<=_Z0*_AI)OR(_X*_PM>=_X0*_PM)) GOTOF _FEHL8
SBLON
IF(_F_Y_AXIS==0)
N34 G0 G90 AX[_XX]=_DM1/2-ABS(_W)*_PM AX[_ZZ]=_PO1+_V*_AI
ELSE
N36 G0 G90 AX[_XX]=_DM1/2-ABS(_W)*_PM AX[_ZZ]=_PO1+_V*_AI AX[_YYR]=0
ENDIF
SBLOF
ENDIF
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
N50 CYCLE98(_PO1,_DM1,_FPL,_DM2,_Z2,_X2,_Z3,_X3,_W,_R,_KK,_U,_IANG,_QQ,_AS,_AS2,_F1,_F2,_F3,_VARI[0],_L,_V,_AS1,_GW,,_PITA,,,,_DMODE,_AMODE[0])
ENDIF
IF(_MAN==0)
IF(_E_ST_PRG)
IF(_AI==-1)
F_SP_RP(4,$P_EP[_XX]*_FAK1,$P_EP[_ZZ]*_FAK1)
ENDIF
ELSE
SBLON
IF(_LP==1)
N60 G0 G90 AX[_XX]=_F_RP_ACT*_FAK2
IF(_AI==-1)
N65 G0 G90 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
ELSE
N70 G0 G90 AX[_ZZ]=_F_RP_ACT*_FAK2
IF(_AI==-1)
N75 G0 G90 AX[_XX]=_F_RPT[0]*_FAK2
ENDIF
ENDIF
SBLOF
F_SP_RP(101,,,1)
ENDIF
ELSE
SBLON
IF(_F_Y_AXIS==0)
N100 G90 G0 AX[_XX]=_X AX[_ZZ]=_Z
ELSE
N110 G90 G0 AX[_XX]=_X AX[_ZZ]=_Z AX[_YYR]=_YS
ENDIF
SBLOF
ENDIF
G[29]=_P29
IF(_FF>0)
F=_FF
ENDIF
_RETS:
_F_RELEAS=0
SBLON
RET
_FEHL2: STOPRE
N909802 SETAL(61002)
RET
_FEHL3: STOPRE
N909803 SETAL(61001)
RET
_FEHL4: STOPRE
N909804 SETAL(61609)
RET
_FEHL5: STOPRE
N909805 SETAL(61610)
RET
_FEHL6: STOPRE
N909806 SETAL(61233)
RET
_FEHL7: STOPRE
N909807 SETAL(61212)
RET
_FEHL8: STOPRE
N909808 SETAL(61284)
RET
_FEHL9: STOPRE
N909809 SETAL(61862)
RET
_FEHL10: STOPRE
N909810 SETAL(61863)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_TR_CON_SPF
PROC F_TR_CON(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,INT _SN,REAL __X0,INT _X0A,REAL _Z0,INT _Z0A,REAL __X1,INT _X1A,REAL _Z1,INT _Z1A,REAL _W,INT _WA,REAL _R,REAL _KK,REAL _A,REAL _E,INT _AS,REAL _V,REAL _U,REAL _QQ,INT _QA,INT _L,INT _N,INT _P,REAL _GW,REAL _I,INT _AA,_E_MAC_TR_CON,REAL _AS1,REAL _G,REAL _XA1,INT _AS2,REAL _BETA,INT _BETAA,REAL _GAMA,REAL S_XRS,REAL S_POLA,INT S_FR_M,REAL S_FR_I,STRING[32] S_TRA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.21.00.00.001 ;DATE: 2022-07-14
;ShopTurn: Taper Thread cutting cycle
DEF AXIS _XX,_ZZ,_YYR
DEF INT _BA1,_AI,_LP,_PM,_LF[8],_SL,_P29,_TYP,_P2RP,_TM2,_TM3,_TM8,_P15,_MAN,_PITA,_VARI[8],_AMODE[9],_DMODE,S_MODE_BC
DEF INT _SLT[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,2,1,4,3,7,6,5,8,9)
DEF INT _SLX[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,4,3,2,1,5,8,7,6,9)
DEF REAL _X,_Z,_DX,_DZ,_SPL,_SPD,_FPL,_FPD,_FAK1,_FAK2,_FAK3,_FF,_YS,_X0,_X1,_F1,S_ROT_Z
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
IF(_E_SM_PRG)AND((_TMOD _DEC4)==0) GOTOF _FEHL9
IF(_E_ST_PRG)AND((_TMOD _DEC4)==1) GOTOF _FEHL10
_X0=__X0 _X1=__X1
IF(_BA B_AND 'H200' == 'H200')
IF(_X0A==90)
_X0=_X0/2
ENDIF
IF(_X1A==90)
_X1=_X1/2
ENDIF
ENDIF
_MAN=TRUNC(_TMOD/10) MOD 10
IF(_E_SM_PRG)
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H0000')
DIAM90
ELSE
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H8000')
DIAMON
ELSE
DIAMOF
ENDIF
ENDIF
ENDIF
_P29=$P_GG[29]
DIAMCYCOF
_P15=$P_GG[15]
_FF=$P_F
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK3=1/$MN_SCALING_VALUE_INCH
ELSE
_FAK3=1
ENDIF
IF(_FAA _DEC2 == 0)
_PITA=1
_F1=_F*_FAK3
ELSE
IF(_FAA _DEC1 == 0)
_PITA=1
_F1=_F*_FAK3
ELSE
IF(_FAA _DEC1 == 1)
_PITA=3
_F1=_F*$MN_SCALING_VALUE_INCH*_FAK3
ELSE
IF(_FAA _DEC1 == 2)
_PITA=4
_F1=_F*$PI*_FAK3
ELSE
_PITA=2
_F1=$MN_SCALING_VALUE_INCH/_F*_FAK3
ENDIF
ENDIF
ENDIF
ENDIF
N10 G40 G90
IF(_MAN==0)
IF(_E_SM_PRG)
N70 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=S_FR_M
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
_ZZ=$P_AXN1
S_ROT_Z=$P_ACTFRAME[_ZZ,RT]
N71 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
IF($P_ACTFRAME[_ZZ,RT]<>S_ROT_Z)
IF($P_EP[_ZZ]*_FAK1<_F_RPT[1]*_FAK2)
N715 G0 G90 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
ENDIF
N72 E_TFS(_T,_TF,_DD,_F1,3,_S,_SA,0)
ELSE
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N16 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
N17 F_SP_BC(4,_BETA,_GAMA)
N18 F_TFS(_T,_TF,_DD,_F1,3,_S,_SA,1,7)
ELSE
N19 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
N191 F_TFS(_T,_TF,_DD,_F1,3,_S,_SA,1,7)
ENDIF
ENDIF
ELSE
IF($MCS_TECHNOLOGY==2)
N80 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=0
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
N81 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
N82 E_TFS(_T,_TF,_DD,_F1,3,_S,_SA,0)
ELSE
_F_INIT=2
_F_RELEAS=1
IF(_MAN==1)
_F_MASPI=0
N21 F_TFS(_T,,_DD,_F1,3,_S,_SA,1,8)
ELSE
_F_MASPI=2
N22 F_TFS(_T,,_DD,_F1,3,_S,_SA,3,8)
ENDIF
F_SP_TRA(2040)
ENDIF
ENDIF
_TYP=$P_ADT[1]
IF(_TYP<500)OR(_TYP>599) GOTOF _FEHL7
; Bearbeitungsart pruefen:
_BA1=_BA B_AND 'B0011'
IF(_BA1==0)GOTOF _FEHL2
_XX=$P_AXN2 _ZZ=$P_AXN1
_X=$P_EP[_XX]*_FAK1 _Z=$P_EP[_ZZ]*_FAK1
IF(_F_Y_AXIS==1)
_YYR=$P_AXN3
_YS=$P_EP[_YYR]*_FAK1
ENDIF
IF(_X0A<>90)
_X0=_X0+_X
ENDIF
IF(_Z0A<>90)
_Z0=_Z0+_Z
ENDIF
IF(_Z1A<>90)
_Z1=_Z0+_Z1
ENDIF
IF(_X1A==91)
_X1=_X0+_X1
ELSE
IF(_X1A==1)
IF (_XA1<=-90)OR(_XA1>=90) GOTOF _FEHL6
_X1=_X0+(ABS(_Z1-_Z0))*TAN(_XA1)
ENDIF
ENDIF
_DX=_X1-_X0 _DZ=_Z1-_Z0
IF(_SN==0)OR(_BA1==2)
_E=0
_AS=1 _BA1=2
_U=0
ENDIF
IF(_SN==0)OR(_BA1==1)
_AS2=0
ENDIF
_TM2=TRUNC(_TMOD/10) MOD 10
_TM3=TRUNC(_TMOD/100) MOD 10
_TM8=TRUNC(_TMOD/10000000) MOD 10
_KK=ABS(_KK)
IF(_TM3)
_KK=-_KK
ENDIF
IF(_SN<0)OR(_SN>2)GOTOF _FEHL2
IF(_KK==0)GOTOF _FEHL5
IF(_U<0)OR(_E<0)GOTOF _FEHL2
IF(ABS(_KK)<_E+_U)GOTOF _FEHL2
IF(_DX==0)AND(_DZ==0)GOTOF _FEHL4
IF(_F<=0)GOTOF _FEHL3
IF(_W<0)GOTOF _FEHL4
IF(_QA==1)GOTOF _MA1
_L=1
_AMODE[5]=0
IF(_QQ>=0)GOTOF _MA2
_QQ=_QQ+360
_MA2:
IF(_QQ<0)OR(_QQ>=360)GOTOF _FEHL2
GOTOF _MAA
_MA1:
IF(_GW<0)GOTOF _FEHL2
_QQ=0
;IF(_L<1)OR(_L>6)GOTOF _FEHL2
_AMODE[5]=10000
_AMODE[6]=0
_VARI[7]=1000000
IF(_L>1)GOTOF _MM1
_P=0
GOTOF _MAA
_MM1:
;IF(_N<0)OR(_N>6)GOTOF _FEHL2
IF(_N==0)GOTOF _MM2
_P=_N
_AMODE[6]=200000
GOTOF _MAA
_MM2:
;IF(_P<0)OR(_P>6)GOTOF _FEHL2
IF(_P==0)GOTOF _MAA
_QQ=(_P-1)*360/_L
_AMODE[6]=100000
_MAA:
_LP=0
IF(ABS(_DX)>ABS(_DZ))GOTOF _MR1
_LP=1
_MR1:
_AI=_KK/ABS(_KK)
IF(_LP==1)
_PM=(_Z1-_Z0)/ABS(_Z1-_Z0)
ELSE
_PM=(_X1-_X0)/ABS(_X1-_X0)
ENDIF
IF(_LP==1)
IF(_KK>0)
_P2RP=0
ELSE
_P2RP=2
ENDIF
ELSE
IF(_KK>0)
_P2RP=4
ELSE
_P2RP=6
ENDIF
ENDIF
IF(_MAN==0)
F_SP_RPT(0,_P2RP)
ENDIF
_VARI[2]=0 _VARI[4]=0
IF(_SN==0)OR(_SN==1)
IF(_KK>0)
_VARI[1]=1
ELSE
_VARI[1]=2
ENDIF
ELSE
IF(_KK>0)
_VARI[1]=3
ELSE
_VARI[1]=4
ENDIF
ENDIF
_VARI[6]=(_BA B_AND 'B0011')*100000
IF(_BA B_AND 'B0100' == 'B0100')
_VARI[3]=200
ELSE
_VARI[3]=100
ENDIF
IF(_BA B_AND 'B1000' == 'B1000')
_VARI[5]=10000
ELSE
_VARI[5]=0
ENDIF
_VARI[0]=_VARI[1]+_VARI[2]+_VARI[3]+_VARI[4]+_VARI[5]+_VARI[6]+_VARI[7]
IF(_V==-1)
_V=2*_FAK3
ENDIF
_KK=ABS(_KK)
IF($P_TOOLNO>0)AND(NOT $P_SEARCH)AND(NOT $AC_SERUPRO)
_SL=$P_ADT[2]
IF(NOT(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'H00200000')AND($P_CUTMOD))AND NOT(($P_CUTMODK==$PC_TRAFO_NAME)AND($P_CUTMODK<>"")))
_SL=_SLT[$P_ACTFRAME[_ZZ,MI],_SL]
_SL=_SLX[$P_ACTFRAME[_XX,MI],_SL]
ENDIF
IF(_SL>0)
_LF[0]=8 _LF[1]=6 _LF[2]=7 _LF[3]=5
IF(_LF[2*(1-_LP)+1-(_AI+1)/2]<>_SL)GOTOF _FEHL1
ENDIF
ENDIF
_SPL=_Z0
_FPL=_Z1
_SPD=2*_X0
_FPD=2*_X1
_AMODE[3]=_WA*100
;IF(_WA==1)
; _AMODE[3]=100
;ENDIF
;IF(_WA==2)
; _AMODE[3]=200
;ENDIF
_AMODE[4]=0
IF(_BA B_AND 'B100000000000')
_AMODE[7]=1000000
ELSE
_AMODE[7]=0
ENDIF
IF(_BA B_AND 'B1000000000000')
_AMODE[8]=10000000
ELSE
_AMODE[8]=0
ENDIF
_AMODE[1]=0 _AMODE[2]=0
_AMODE[0]=_AMODE[1]+_AMODE[2]+_AMODE[3]+_AMODE[4]+_AMODE[5]+_AMODE[6]+_AMODE[7]+_AMODE[8]
_DMODE=0
IF(_TM8==1)
_DMODE=_DMODE+10000
ENDIF
IF (_FAA==2)OR(_FAA==3)
_G=0
ENDIF
IF(_MAN==0)
IF(_LP==1)
IF(_AI==-1)
F_SP_RP(3,_SPD/2+_V*_AI,-ABS(_W)*_PM)
ENDIF
N25 F_SP_RP(0,_SPD/2+_V*_AI,_SPL-ABS(_W)*_PM,0)
ELSE
IF(_AI==-1)
F_SP_RP(3,_SPD/2-ABS(_W)*_PM,_SPL+_V*_AI)
ENDIF
N28 F_SP_RP(0,_SPD/2-ABS(_W)*_PM,_SPL+_V*_AI,0)
ENDIF
F_SP_TRA(1040)
ELSE
IF(_LP==1)
IF((_X*_AI<=_X0*_AI)OR(_Z*_PM>=_Z0*_PM)) GOTOF _FEHL8
SBLON
IF(_F_Y_AXIS==0)
N30 G0 G90 AX[_XX]=_X0+_V*_AI AX[_ZZ]=_SPL-ABS(_W)*_PM
ELSE
N32 G0 G90 AX[_XX]=_X0+_V*_AI AX[_ZZ]=_SPL-ABS(_W)*_PM AX[_YYR]=0
ENDIF
SBLOF
ELSE
IF((_Z*_AI<=_Z0*_AI)OR(_X*_PM>=_X0*_PM)) GOTOF _FEHL8
SBLON
IF(_F_Y_AXIS==0)
N34 G0 G90 AX[_XX]=_SPD/2-ABS(_W)*_PM AX[_ZZ]=_SPL+_V*_AI
ELSE
N36 G0 G90 AX[_XX]=_SPD/2-ABS(_W)*_PM AX[_ZZ]=_SPL+_V*_AI AX[_YYR]=0
ENDIF
SBLOF
ENDIF
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
N50 CYCLE99(_SPL,_SPD,_FPL,_FPD,_W,_R,_KK,_U,_A,_QQ,_AS,_AS2,_F,_VARI[0],_L,_V,_AS1,_GW,_G,_E,_P,_TM2 AND 1,_I,_PITA,,,,20+_DMODE,_AMODE[0],S_XRS)
ENDIF
IF(_MAN==0)
IF(_E_ST_PRG)
IF(_AI==-1)
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
F_SP_RP(4,$P_EP[_XX]*_FAK1,$P_EP[_ZZ]*_FAK1)
ENDIF
ENDIF
ELSE
SBLON
IF(_LP==1)
N60 G0 G90 AX[_XX]=_F_RP_ACT*_FAK2
IF(_AI==-1)
N65 G0 G90 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
ELSE
N70 G0 G90 AX[_ZZ]=_F_RP_ACT*_FAK2
IF(_AI==-1)
N75 G0 G90 AX[_XX]=_F_RPT[0]*_FAK2
ENDIF
ENDIF
SBLOF
F_SP_RP(101,,,1)
ENDIF
ELSE
SBLON
IF(_F_Y_AXIS==0)
N100 G90 G0 AX[_XX]=_X AX[_ZZ]=_Z
ELSE
N110 G90 G0 AX[_XX]=_X AX[_ZZ]=_Z AX[_YYR]=_YS
ENDIF
SBLOF
ENDIF
G[29]=_P29
_E_S_LINE=0
IF(_FF>0)
F=_FF
ENDIF
_RETS:
_F_RELEAS=0
SBLON
RET
_FEHL1: STOPRE
N909901 SETAL(61608)
RET
_FEHL2: STOPRE
N909902 SETAL(61002)
RET
_FEHL3: STOPRE
N909903 SETAL(61001)
RET
_FEHL4: STOPRE
N909904 SETAL(61609)
RET
_FEHL5: STOPRE
N909905 SETAL(61610)
RET
_FEHL6: STOPRE
N909906 SETAL(61233)
RET
_FEHL7: STOPRE
N909907 SETAL(61212)
RET
_FEHL8: STOPRE
N909908 SETAL(61284)
RET
_FEHL9: STOPRE
N909909 SETAL(61862)
RET
_FEHL10: STOPRE
N909910 SETAL(61863)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_TR_LON_SPF
PROC F_TR_LON(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,INT _SN,REAL _X0,INT _X0A,REAL _Z0,INT _Z0A,REAL _Z1,INT _Z1A,REAL _W,INT _WA,REAL _R,REAL _KK,REAL _A,REAL _E,INT _AS,REAL _V,REAL _U,REAL _QQ,INT _QA,INT _L,INT _N,INT _P,REAL _GW,REAL _I,INT _AA,_E_MAC_TR_CON,REAL _AS1,REAL _G,INT _AS2,REAL _BETA,INT _BETAA,REAL _GAMA,STRING[20] _PTAB,STRING[20] _PTABA,REAL S_XRS,REAL S_POLA,INT S_FR_M,REAL S_FR_I,STRING[32] S_TRA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.90.00.00.010 ;DATE: 2018-08-23
;ShopTurn: Longitudinal Thread cutting cycle
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
IF(_PTAB<>"")
_G=0
ENDIF
F_TR_CON(_T,_TF,_DD,_F,_FAA,_S,_SA,_TMOD,_BA,_SN,_X0,_X0A,_Z0,_Z0A,0,91,_Z1,_Z1A,_W,_WA,_R,_KK,_A,_E,_AS,_V,_U,_QQ,_QA,_L,_N,_P,_GW,_I,_AA,_FI,_FM,_FZG,_FZZ,_FZN,_AS1,_G,0,_AS2,_BETA,_BETAA,_GAMA,S_XRS,S_POLA,S_FR_M,S_FR_I,S_TRA)
_RETS:
_F_RELEAS=0
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_TR_PLA_SPF
PROC F_TR_PLA(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _BA,INT _SN,REAL _X0,INT _X0A,REAL _Z0,INT _Z0A,REAL _X1,INT _X1A,REAL _W,INT _WA,REAL _R,REAL _KK,REAL _A,REAL _E,INT _AS,REAL _V,REAL _U,REAL _QQ,INT _QA,INT _L,INT _N,INT _P,REAL _GW,REAL _I,INT _AA,_E_MAC_TR_CON,REAL _AS1,REAL _G,INT _AS2,REAL _BETA,INT _BETAA,REAL _GAMA,REAL S_POLA,INT S_FR_M,REAL S_FR_I,STRING[32] S_TRA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.90.00.00.010 ;DATE: 2018-08-23
;ShopTurn: Face Thread Cutting Cycle
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
F_TR_CON(_T,_TF,_DD,_F,_FAA,_S,_SA,_TMOD,_BA,_SN,_X0,_X0A,_Z0,_Z0A,_X1,_X1A,0,91,_W,_WA,_R,_KK,_A,_E,_AS,_V,_U,_QQ,_QA,_L,_N,_P,_GW,_I,_AA,_FI,_FM,_FZG,_FZZ,_FZN,_AS1,_G,0,_AS2,_BETA,_BETAA,_GAMA,,S_POLA,S_FR_M,S_FR_I,S_TRA)
_RETS:
_F_RELEAS=0
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_TS_SPF
PROC F_TS(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _S,INT _SA,INT _SMODE,INT _TMOD,REAL _D,REAL _C0,INT _ST,REAL _BETA,INT _BETAA,REAL _GAMA) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.94.00.00.005 ;DATE: 2020-04-23
;ShopTurn: Tool/Spindle Speed
DEF AXIS _CC,_ZZ
DEF INT _INIT,_TM1,_TM6,_MD_CLAMP,S_MD_BREAK
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_TS_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
WRITE(_LOG,_LOG_FILE,"F_TS(_T="<<_T<<",_TF="<<_TF<<",_DD="<<_DD<<",_S="<<_S<<",_SA="<<_SA<<",_SMODE="<<_SMODE<<",_TMOD="<<_TMOD<<",_D="<<_D<<",_C0="<<_C0<<",_ST="<<_ST<<",_BETA="<<_BETA<<",_BETAA="<<_BETAA<<",_GAMA="<<_GAMA<<")")
ENDIF
_TM1=_TMOD MOD 10
_TM6=TRUNC(_TMOD/100000) MOD 10
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(0)")
ENDIF
F_SP_TRA(0)
IF(_SA==0)
IF(_TM1==5)
_SMODE=0
ELSE
IF(_TM1==4)
_SMODE=1
ELSE
_SMODE=2
ENDIF
ENDIF
ENDIF
IF(_TM1<>5)
IF(_TM1<=1)
IF(_TM1==0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(4104,"<<_D/2<<")")
ENDIF
F_SP_TRA(4104,_D/2)
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(4014,"<<_D/2<<")")
ENDIF
F_SP_TRA(4014,_D/2)
ENDIF
ELSE
IF(_TM1<=3)OR(_TM1==6)
IF(_TM1==2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(4124)")
ENDIF
F_SP_TRA(4124)
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA("<<4004+_TM1*10<<")")
ENDIF
F_SP_TRA(4004+_TM1*10)
ENDIF
ELSE
IF(_TM1==4)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(4044)")
ENDIF
F_SP_TRA(4044)
ENDIF
ENDIF
ENDIF
ENDIF
_INIT=_F_INIT
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')AND(_TM1<>5)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N11 F_TFS("<<_T<<",,"<<_DD<<",,,,,"<<_SMODE<<",0)")
WRITE(_LOG,_LOG_FILE,"N12 F_SP_BC("<<_TM1<<","<<_BETA<<","<<_GAMA<<")")
WRITE(_LOG,_LOG_FILE,"N13 F_TFS("<<_T<<","<<_TF<<","<<_DD<<",0,0,"<<_S<<","<<_SA<<","<<_SMODE<<",7)")
ENDIF
N11 F_TFS(_T,,_DD,,,,,_SMODE,0)
N12 F_SP_BC(_TM1,_BETA,_GAMA)
N13 F_TFS(_T,_TF,_DD,0,0,_S,_SA,_SMODE,7)
ELSE
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"N20 F_TFS("<<_T<<","<<_TF<<","<<_DD<<",0,0,"<<_S<<","<<_SA<<","<<_SMODE<<",1)")
ENDIF
N20 F_TFS(_T,_TF,_DD,0,0,_S,_SA,_SMODE,1)
ENDIF
IF(_T=="")
_F_INIT=_INIT
ENDIF
IF(_TM1<>5)
IF(_TM1<=1)
IF(_TM1==0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(2104,"<<_D/2<<")")
ENDIF
F_SP_TRA(2104,_D/2)
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(2014,"<<_D/2<<","<<_C0<<")")
ENDIF
F_SP_TRA(2014,_D/2,_C0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"G0 G90 "<<AXSTRING(_CC)<<"=DC("<<_C0<<")")
ENDIF
SBLON
G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
ELSE
IF(_TM1<=3)OR(_TM1==6)
IF(_TM1==2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(2124)")
ENDIF
F_SP_TRA(2124)
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA("<<2004+_TM1*10<<",,"<<_C0<<")")
ENDIF
F_SP_TRA(2004+_TM1*10,,_C0)
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
_ZZ=$P_AXN3
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"G0 G90 "<<AXSTRING(_CC)<<"=DC("<<_C0<<")")
ENDIF
SBLON
G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
ELSE
IF(_TM1==4)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"F_SP_TRA(2044)")
ENDIF
F_SP_TRA(2044)
ENDIF
ENDIF
ENDIF
ELSE
_CC=_F_S_AX[_F_MASPI]
_C0=$P_EP[_CC]
ENDIF
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
IF(_MD_CLAMP==0)AND(_TM6==2)
_TM6=0
ENDIF
IF(S_MD_BREAK==0)AND(_TM6==3)
_TM6=0
ENDIF
IF(_TM6<>0)
IF(_TM6==1)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC("<<4+_F_MASPI*10<<")")
WRITE(_LOG,_LOG_FILE,"D"<<_DD)
ENDIF
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_TM6==2)
IF((_TM1 MOD 2)==1)OR(_TM1==6)
IF ((_SMODE<>2)AND(_SA==0)) OR (_SMODE==2)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>1)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC("<<3+_F_MASPI*10<<")")
WRITE(_LOG,_LOG_FILE,"D"<<_DD)
ENDIF
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
ENDIF
ENDIF
IF(_TM6==3)
IF(_TM1==0)OR(_TM1==2)OR(_TM1==5)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"CUST_TECHCYC("<<403+_F_MASPI*10<<")")
WRITE(_LOG,_LOG_FILE,"D"<<_DD)
ENDIF
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
ENDIF
ENDIF
ENDIF
ENDIF
_RETS:
SBLON
G4 F0.0001
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_UCUT_D_SPF
PROC F_UCUT_D(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT __BA,INT _L,REAL __X0,INT _X0A,REAL _Z0,INT _Z0A,REAL _A,REAL __V,INT _VA,REAL _D,REAL _U,INT _ST,REAL _UX,REAL _UZ,REAL _BETA,INT _BETAA,REAL _GAMA,REAL S_POLA,INT S_FR_M,REAL S_FR_I,STRING[32] S_TRA,REAL S_XC,REAL S_YC,REAL _SV2,REAL _C0) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.21.00.00.004 ;DATE: 2022-10-27
;ShopTurn: Thread Undercut, DIN-76
DEF INT _AI,_BA
DEF REAL _R[24],_G[24],_T2[24],_S2[24],_R1,_G2,_T1,_H3,_FAK3,_V,_X0
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
_BA=__BA _V=__V _X0=__X0
IF(_BA B_AND 'B10000000' == 'B10000000')
IF(_X0A==90)
_X0=_X0/2
ENDIF
IF(_VA==90)
_V=_V/2
ENDIF
_BA=_BA B_AND (B_NOT 'B10000000')
ENDIF
IF(_VA<>90)
_V=ABS(_V)
ENDIF
_R[ 0]=0.1 _R[ 1]=0.12 _R[ 2]=0.16 _R[ 3]=0.16 _R[ 4]=0.2 _R[ 5]=0.2
_R[ 6]=0.2 _R[ 7]=0.4 _R[ 8]=0.4 _R[ 9]=0.4 _R[10]=0.4 _R[11]=0.6
_R[12]=0.6 _R[13]=0.8 _R[14]=1.0 _R[15]=1.0 _R[16]=1.2 _R[17]=1.6
_R[18]=1.6 _R[19]=2.0 _R[20]=2.0 _R[21]=2.5 _R[22]=3.2 _R[23]=3.2
IF(_L >3) GOTOF _ML1
IF NOT(_BA B_AND 'B1000000' == 'B1000000')
_G[0]=0.7 _G[1]=0.9 _G[2]=1.1 _G[3]=1.2 _G[4]=1.4 _G[5]=1.6
_G[6]=1.8 _G[7]=2.1 _G[8]=2.5 _G[9]=2.6 _G[10]=2.8 _G[11]=3.5
_G[12]=4.4 _G[13]=5.2 _G[14]=6.1 _G[15]=7.0 _G[16]=8.7 _G[17]=10.5
_G[18]=12.0 _G[19]=14.0 _G[20]=16.0 _G[21]=17.5 _G[22]=19.0 _G[23]=21.0
ELSE
_G[0]=0.5 _G[1]=0.6 _G[2]=0.75 _G[3]=0.9 _G[4]=1 _G[5]=1.1
_G[6]=1.25 _G[7]=1.5 _G[8]=1.75 _G[9]=1.9 _G[10]=2 _G[11]=2.5
_G[12]=3.2 _G[13]=3.8 _G[14]=4.3 _G[15]=5.0 _G[16]=6.3 _G[17]=7.5
_G[18]=9.0 _G[19]=10.0 _G[20]=11.0 _G[21]=12.5 _G[22]=14.0 _G[23]=15.0
ENDIF
GOTOF _ML2
_ML1:
IF NOT(_BA B_AND 'B1000000' == 'B1000000')
_G[0]=1.2 _G[1]=1.4 _G[2]=1.6 _G[3]=1.9 _G[4]=2.2 _G[5]=2.4
_G[6]=2.7 _G[7]=3.3 _G[8]=3.8 _G[9]=4.0 _G[10]=4.2 _G[11]=5.2
_G[12]=6.7 _G[13]=7.8 _G[14]=9.1 _G[15]=10.3 _G[16]=13.0 _G[17]=15.2
_G[18]=17.7 _G[19]=20.0 _G[20]=23.0 _G[21]=26.0 _G[22]=28.0 _G[23]=30.0
ELSE
_G[0]=0.9 _G[1]=1 _G[2]=1.25 _G[3]=1.4 _G[4]=1.6 _G[5]=1.7
_G[6]=2 _G[7]=2.4 _G[8]=2.75 _G[9]=2.9 _G[10]=3 _G[11]=3.7
_G[12]=4.9 _G[13]=5.6 _G[14]=6.4 _G[15]=7.3 _G[16]=9.3 _G[17]=10.7
_G[18]=12.7 _G[19]=14 _G[20]=16 _G[21]=18.5 _G[22]=20 _G[23]=21
ENDIF
_ML2:
IF(_L >3) GOTOF _ML3
_T2[ 0]=0.3 _T2[ 1]=0.4 _T2[ 2]=0.5 _T2[ 3]=0.6 _T2[ 4]=0.7 _T2[ 5]=0.7
_T2[ 6]=0.8 _T2[ 7]=1.0 _T2[ 8]=1.1 _T2[ 9]=1.2 _T2[10]=1.3 _T2[11]=1.6
_T2[12]=2.0 _T2[13]=2.3 _T2[14]=2.6 _T2[15]=3.0 _T2[16]=3.6 _T2[17]=4.4
_T2[18]=5.0 _T2[19]=5.7 _T2[20]=6.4 _T2[21]=7.0 _T2[22]=7.7 _T2[23]=8.3
GOTOF _ML4
_ML3:
_T2[ 0]=0.1 _T2[ 1]=0.1 _T2[ 2]=0.1 _T2[ 3]=0.2 _T2[ 4]=0.2 _T2[ 5]=0.2
_T2[ 6]=0.3 _T2[ 7]=0.3 _T2[ 8]=0.3 _T2[ 9]=0.3 _T2[10]=0.3 _T2[11]=0.5
_T2[12]=0.5 _T2[13]=0.5 _T2[14]=0.5 _T2[15]=0.5 _T2[16]=0.5 _T2[17]=0.5
_T2[18]=0.5 _T2[19]=0.5 _T2[20]=0.5 _T2[21]=0.5 _T2[22]=0.5 _T2[23]=0.5
;
; Steigung: _S2
_S2[ 0]=0.2 _S2[ 1]=0.25 _S2[ 2]=0.3 _S2[ 3]=0.35 _S2[ 4]=0.4 _S2[ 5]=0.45
_S2[ 6]=0.5 _S2[ 7]=0.6 _S2[ 8]=0.7 _S2[ 9]=0.75 _S2[10]=0.8 _S2[11]=1.0
_S2[12]=1.25 _S2[13]=1.5 _S2[14]=1.75 _S2[15]=2.0 _S2[16]=2.5 _S2[17]=3.0
_S2[18]=3.5 _S2[19]=4.0 _S2[20]=4.5 _S2[21]=5.0 _S2[22]=5.5 _S2[23]=6.0
_ML4:
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK3=1/$MN_SCALING_VALUE_INCH
ELSE
_FAK3=1
ENDIF
IF((_L MOD 4)>=2)
_AI=-1
ELSE
_AI=1
ENDIF
_R1=_R[_ST]*_FAK3
_G2=_G[_ST]*_FAK3
_T1=_T2[_ST]/2*_FAK3
IF(_L <=3) GOTOF _M1
_H3=0.61343*_S2[_ST]*_FAK3
_X0=_X0+_H3*_AI
_T1=_T1+_H3
_V=_V-_H3
IF(_V>=0) GOTOF _M1
_V=0
_M1:
_L=_L MOD 4
F_UCUT_T(_T,_TF,_DD,_F,_FAA,_S,_SA,_TMOD,_BA,_L,_X0,_X0A,_Z0,_Z0A,_T1,91,_G2,91,_R1,_R1,_A,_V,_VA,_D,_U,_UX,_UZ,_BETA,_BETAA,_GAMA,S_POLA,S_FR_M,S_FR_I,S_TRA,S_XC,S_YC,_SV2,_C0)
_RETS:
_F_RELEAS=0
SBLON
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_UCUT_E_SPF
PROC F_UCUT_E(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _L,REAL _X0,INT _X0A,REAL _Z0,INT _Z0A,REAL _X1,INT _X1A,REAL _V,INT _VA,INT _RT,REAL _BETA,INT _BETAA,REAL _GAMA,INT _BA,REAL S_POLA,INT S_FR_M,REAL S_FR_I,STRING[32] S_TRA,REAL S_XC,REAL S_YC,REAL _SV2,REAL _C0) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.21.00.00.004 ;DATE: 2022-10-27
;ShopTurn: Thread Undercut, Form E
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
F_SP_EF(_T,_TF,_DD,_F,_FAA,_S,_SA,_TMOD,"E",_L,_X0,_X0A,_Z0,_Z0A,_X1,_X1A,,,_RT,_V,_VA,_BETA,_BETAA,_GAMA,_BA,S_POLA,S_FR_M,S_FR_I,S_TRA,S_XC,S_YC,_SV2,_C0)
_RETS:
_F_RELEAS=0
SBLON
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_UCUT_F_SPF
PROC F_UCUT_F(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT _L,REAL _X0,INT _X0A,REAL _Z0,INT _Z0A,REAL _X1,INT _X1A,REAL _Z1,INT _Z1A,INT _RT,REAL _V,INT _VA,REAL _BETA,INT _BETAA,REAL _GAMA,INT _BA,REAL S_POLA,INT S_FR_M,REAL S_FR_I,STRING[32] S_TRA,REAL S_XC,REAL S_YC,REAL _SV2,REAL _C0) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.21.00.00.004 ;DATE: 2022-10-27
;ShopTurn: Thread Undercut, Form F
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
F_SP_EF(_T,_TF,_DD,_F,_FAA,_S,_SA,_TMOD,"F",_L,_X0,_X0A,_Z0,_Z0A,_X1,_X1A,_Z1,_Z1A,_RT,_V,_VA,_BETA,_BETAA,_GAMA,_BA,S_POLA,S_FR_M,S_FR_I,S_TRA,S_XC,S_YC,_SV2,_C0)
_RETS:
_F_RELEAS=0
SBLON
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_UCUT_T_SPF
PROC F_UCUT_T(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _F,INT _FAA,REAL _S,INT _SA,INT _TMOD,INT __BA,INT _L,REAL __X0,INT _X0A,REAL _Z0,INT _Z0A,REAL __X1,INT _X1A,REAL _Z1,INT _Z1A,REAL _R1,REAL _R2,REAL _A,REAL __V,INT _VA,REAL _D,REAL _U,REAL _UX,REAL _UZ,REAL _BETA,INT _BETAA,REAL _GAMA,REAL S_POLA,INT S_FR_M,REAL S_FR_I,STRING[32] S_TRA,REAL S_XC,REAL S_YC,REAL _SV2,REAL _C0) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Thread Undercut, Form programmable
DEF AXIS _XX,_ZZ,_YY,_CC,_AX1,_AX2,_AX3
DEF INT _PM,_AI,_LF[4],_P29,_TYP,_SL,_SN,_MAN,_BA1,_BA2,_BA5,_ZUG,_I,_G2_3,_BA,S_MODE_BC,S_IPT,S_PL,_TM1,_TCI,_NPV,S_Y_TURN,S_C805_AMODE
DEF INT _SLT[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,2,1,4,3,7,6,5,8,9)
DEF INT _SLX[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,4,3,2,1,5,8,7,6,9)
DEF REAL _WR,_WF,_WH,_TR,_SC,_FAK1,_FAK2,_FAK3,_XS,_YS,_ZS,_ZUT,_OFK,_OFX,_OFZ,_STX,_STZ,_V,_X0,_X1,S_ROT_Z,_SD,_RP,_RTP,S_A1TC,S_A2TC
DEF REAL _PG[4,2],_PF[6,2],_PR[2,3],_P[6,2]
DEF STRING[32] _TC
DEF FRAME _WPFR
DEF INT _LOG,_LOG_ON,S_LOGSIZE
DEF STRING[35] _LOG_FILE
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
_LOG_FILE="/_N_MPF_DIR/_N_LOG_F_UCUT_T_"<<$P_CHANNO<<"_MPF"
_LOG_ON=ISFILE(_LOG_FILE)
IF(_LOG_ON)
FILESIZE(_LOG,_LOG_FILE,S_LOGSIZE)
IF(S_LOGSIZE>20000)
_LOG_ON=0
ENDIF
ENDIF
IF(_LOG_ON)
; DELETE(_LOG,_LOG_FILE)
WRITE(_LOG,_LOG_FILE,"-------------------")
WRITE(_LOG,_LOG_FILE,SPRINT(";! only for internal diagnostics ! %s.%s.%s %s:%s:%s",SUBSTR(""<<100+$A_DAY,1),SUBSTR(""<<100+$A_MONTH,1),""<<2000+$A_YEAR,SUBSTR(""<<100+$A_HOUR,1),SUBSTR(""<<100+$A_MINUTE,1),SUBSTR(""<<100+$A_SECOND,1)))
ENDIF
IF(_E_SM_PRG)AND((_TMOD _DEC4)==0) GOTOF _FEHL8
IF(_E_ST_PRG)AND((_TMOD _DEC4)==1) GOTOF _FEHL9
IF(_TMOD _DEC9)==1
S_IPT=1
ENDIF
IF(_TMOD _DEC9)==3
S_Y_TURN=1
ENDIF
_TM1=_TMOD MOD 10
_C0=((_C0 MOD 360)+360)MOD 360
_P29=$P_GG[29]
DIAMCYCOF
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_FAK3=1
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK3=1/$MN_SCALING_VALUE_INCH
ENDIF
_BA=__BA _V=__V _X0=__X0 _X1=__X1
IF(_BA B_AND 'B10000000' == 'B10000000')
IF(_X0A==90)
_X0=_X0/2
ENDIF
IF(_X1A==90)
_X1=_X1/2
ENDIF
IF(_VA==90)
_V=_V/2
ENDIF
_BA=_BA B_AND (B_NOT 'B10000000')
ENDIF
_BA1=_BA MOD 4
_BA2=(_BA DIV 4) MOD 2
_BA5=(_BA DIV 32) MOD 2
IF(_BA5)
IF(_UX>_UZ)
_U=_UZ
ELSE
_U=_UX
ENDIF
_UX=_UX-_U
_UZ=_UZ-_U
ELSE
_UX=0
_UZ=0
ENDIF
IF(_BA1==2)
_U=0 _UX=0 _UZ=0
ENDIF
_MAN=TRUNC(_TMOD/10) MOD 10
IF S_CALL_FROM_MA_JOG_STEP
_F_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
ELSE
_SC=_E_SC*_FAK2
ENDIF
IF(_L==1)OR(_L==2)
_G2_3=2+1
ELSE
_G2_3=3+1
ENDIF
_PM=1-(_L MOD 2)*2
_AI=1-(_L DIV 2)*2
IF(_X1A==90)
_X1=(_X0-_X1)*_AI
ELSE
_X1=ABS(_X1)
ENDIF
IF(_Z1A==90)
_Z1=-(_Z1-_Z0)*_PM
ELSE
_Z1=ABS(_Z1)
ENDIF
IF(_VA==90)
_V=(_V-_X0)*_AI
ELSE
_V=ABS(_V)
ENDIF
N10 G40 G90
IF(NOT((_FAA==1)OR(_FAA==3))) GOTOF _FEHL3
IF(_MAN==0)
IF(_E_SM_PRG)
IF(S_IPT==1)
IF($PC_TRAFO_TYPE_NAME=="TRAORI_STAT")
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: DFM -> M5")
WRITE(_LOG,_LOG_FILE,"IPT: DFM -> SPOS=0")
ENDIF
M[_F_S_NR[_F_MASPI]]=5
SPOS[_F_S_NR[_F_MASPI]]=0
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N333 E_TFS")
ENDIF
N333 E_TFS(_T,_TF,_DD,,,,,11)
TRAFOOF
G18
IF(_GAMA==180)
_XX=$P_AXN2
$P_CYCFRAME=$P_CYCFRAME:CMIRROR(_XX)
ENDIF
ELSE
N12 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=S_FR_M
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
_ZZ=$P_AXN1
S_ROT_Z=$P_ACTFRAME[_ZZ,RT]
N13 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
IF($P_ACTFRAME[_ZZ,RT]<>S_ROT_Z)
IF($P_EP[_ZZ]*_FAK1<_F_RPT[1]*_FAK2)
N135 G0 G90 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
ENDIF
N14 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
ENDIF
ELSE
IF(S_IPT==1)
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
IF(_F_TRAMA _DEC2 ==6)
_TCI=$P_TC
S_A1TC=$P_TCANG[1]
S_A2TC=$P_TCANG[2]
_NPV=$P_GG[8]
_WPFR=$P_WPFRAME
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Stirn B vor N250 F_TFS")
WRITE(_LOG,_LOG_FILE,"  _F_TRAMA="<<_F_TRAMA)
WRITE(_LOG,_LOG_FILE,"  $P_TC="<<$P_TC)
WRITE(_LOG,_LOG_FILE,"  _TC_A1="<<_TC_A1)
WRITE(_LOG,_LOG_FILE,"  _TC_A2="<<_TC_A2)
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[1]="<<$P_TCANG[1])
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[2]="<<$P_TCANG[2])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR13[_TCI]="<<$TC_CARR13[_TCI])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR14[_TCI]="<<$TC_CARR14[_TCI])
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N250 F_TFS")
ENDIF
N250 F_TFS(_T,_TF,_DD,,,,,1,0)
IF(_TCI)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Stirn B nach N250 F_TFS")
WRITE(_LOG,_LOG_FILE,"  _F_TRAMA="<<_F_TRAMA)
WRITE(_LOG,_LOG_FILE,"  $P_TC="<<$P_TC)
WRITE(_LOG,_LOG_FILE,"  _TC_A1="<<_TC_A1)
WRITE(_LOG,_LOG_FILE,"  _TC_A2="<<_TC_A2)
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[1]="<<$P_TCANG[1])
WRITE(_LOG,_LOG_FILE,"  $P_TCANG[2]="<<$P_TCANG[2])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR13[_TCI]="<<$TC_CARR13[_TCI])
WRITE(_LOG,_LOG_FILE,"  $TC_CARR14[_TCI]="<<$TC_CARR14[_TCI])
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N800 CYCLE800 direkt: "<<S_A1TC<<"/"<<S_A2TC)
ENDIF
N800 CYCLE800(0,$TC_CARR34[_TCI],220000,192,0,0,0,S_A1TC,S_A2TC,0,0,0,0,0,0,1001)
$P_WPFRAME=_WPFR
$P_WPFR=$P_WPFRAME
G[8]=_NPV
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: G18 TRAFOOF")
ENDIF
F_SP_TRA(2040)
_XX=$P_AXN2
IF(NOT _TCI)
N255 F_SP_BC(4,_SC_A_NO_VAL,0)
ENDIF
IF(_GAMA==180)
$P_CYCFRAME=$P_CYCFRAME:CMIRROR(_XX)
ENDIF
ELSE
IF S_Y_TURN
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"Y-Drehen")
ENDIF
N1800 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
IF(_SC_Y_TURN)
IF(_SC_Y_TURN_GAMA<>_GAMA)
F_SP_RP(1,,,1)
ENDIF
IF(_BA B_AND 'H1000000' == 'H1000000')
IF(_SC_Y_TURN==-90)
F_SP_RP(1,,,1)
ENDIF
ELSE
IF(_SC_Y_TURN==90)
F_SP_RP(1,,,1)
ENDIF
ENDIF
ENDIF
IF(_F_TC_DEF[2]==0)
_TC=""
ELSE
_TC=$TC_CARR34[_F_TC_DEF[2]]
ENDIF
IF(_BA B_AND 'H1000000' == 'H1000000')
S_C805_AMODE=1000
ENDIF
N1805 CYCLE805(1,_TC,_GAMA,,,,S_C805_AMODE)
N1810 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,7)
ELSE
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N16 F_TFS(_T,_TF,_DD,,,,,1,0)
F_SP_TRA(2040)
N17 F_SP_BC(4,_BETA,_GAMA)
N18 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,7)
ELSE
N19 F_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,1,0)
F_SP_TRA(2040)
ENDIF
ENDIF
ENDIF
ENDIF
ELSE
IF($MCS_TECHNOLOGY==2)
N20 E_TFS(_T,_TF,_DD,,,,,0)
F_SP_TRA(2040)
S_MODE_BC=0
S_MODE_BC=S_MODE_BC+10*((_BA B_AND 'H00100000')/'H00100000')
S_MODE_BC=S_MODE_BC+1000*(((_BA B_AND 'H00200000')/'H00200000')+1)
S_MODE_BC=S_MODE_BC+10000*((_BA B_AND 'H00010000')/'H00010000')
S_MODE_BC=S_MODE_BC+100000*((_BA B_AND 'H00060000')/'H00020000')
S_MODE_BC=S_MODE_BC+1000000*((_BA B_AND 'H00080000')/'H00080000')
N21 E_SP_BC(S_TRA,_BETA,_GAMA,S_MODE_BC,S_FR_I,S_POLA)
N22 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
ELSE
_F_INIT=2
_F_RELEAS=1
IF(_MAN==1)
_F_MASPI=0
N25 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,1,8)
ELSE
_F_MASPI=2
N30 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,3,8)
ENDIF
F_SP_TRA(2040)
ENDIF
ENDIF
_TYP=$P_ADT[1]
IF(_TYP<500)OR(_TYP>599) GOTOF _FEHL4
_XX=$P_AXN2 _ZZ=$P_AXN1
IF($P_TOOLNO>0)
IF(S_IPT)
_SL=$TC_DP2[$P_TOOLNO,$P_TOOL]
ELSE
_SL=$P_ADT[2]
ENDIF
IF(NOT(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'H00200000')AND($P_CUTMOD))AND NOT(($P_CUTMODK==$PC_TRAFO_NAME)AND($P_CUTMODK<>""))AND(NOT S_Y_TURN))
_SL=_SLT[$P_ACTFRAME[_ZZ,MI],_SL]
_SL=_SLX[$P_ACTFRAME[_XX,MI],_SL]
ENDIF
IF(_SL>0)
_LF[0]=4 _LF[1]=3 _LF[2]=1 _LF[3]=2
IF(_LF[_L]<>_SL) GOTOF _FEHL1
ENDIF
_WR=$P_TOOLR*_FAK1
ELSE
_WR=0
ENDIF
_SN=$P_ADT[11]
IF(_SN==1)OR(_SN==2)
_WF=$P_ADT[10]-90
_WH=$P_ADT[24]
ELSE
_WF=$P_ADT[24]
_WH=$P_ADT[10]-90
ENDIF
IF(_WF<=_A) GOTOF _FEHL7
IF(_WH<=0) GOTOF _FEHL7
_TR=0.0000001
IF(_WR>_R1)OR(_WR>_R2) GOTOF _FEHL2
IF(_X1<0)OR(_Z1<0) GOTOF _FEHL2
IF(_A<=0)OR(_A>=90) GOTOF _FEHL2
IF(_U+_UX>_X1) GOTOF _FEHL6
IF(_R2>_X1) GOTOF _FEHL2
IF _Z1<_R2+_R1*SIN(_A)+(_X1-_R1*(1-COS(_A)))/TAN(_A)-_TR GOTOF _FEHL2
IF(_MAN==0)AND(S_IPT==0)
F_SP_RPT(0,_L)
ENDIF
IF(_F_Y_AXIS<>0)
_YY=$P_AXN3
ENDIF
IF(_MAN==0)
ELSE
_XS=$P_EP[_XX]*_FAK1 _ZS=$P_EP[_ZZ]*_FAK1
IF(_F_Y_AXIS<>0)
_YS=$P_EP[_YY]*_FAK1
ENDIF
ENDIF
IF(_BA1 B_AND 1)
_ZUT=_X1-(_U+_UX)
IF(_D==0)
_D=_ZUT
ENDIF
_ZUG=TRUNC(_ZUT/_D)
IF(_ZUG*_D<_ZUT)
_ZUG=_ZUG+1
ENDIF
_D=_ZUT/_ZUG
ENDIF
IF(_BA1 B_AND 1)
IF(_BA2)
_STZ=_Z0+((_U+_WR)/SIN(_A)+_UZ+_UX/TAN(_A)-((_Z1+(_SC+_WR)/TAN(_A))-_WR))*_PM
ELSE
_STZ=_Z0-(_Z1-(_U+_WR+_D*(_ZUG-1))/SIN(_A)-_UZ-_UX/TAN(_A)+(_SC+_WR)/TAN(_A)-_WR)*_PM
ENDIF
ELSE
_STZ=_Z0-(_Z1-_WR/SIN(_A)+(_SC+_WR)/TAN(_A)-_WR)*_PM
ENDIF
_STX=_X0+_SC*_AI
IF(S_IPT==1)
IF(_BA1 B_AND 2)
_XS=_STX+_V*_AI
ELSE
_XS=_STX
ENDIF
_ZS=_STZ
IF(_GAMA==180)
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: Gamma 180 -> Spiegelung X entfernt")
ENDIF
$P_CYCFRAME=$P_CYCFRAME:CMIRROR(_XX)
ENDIF
IF(_E_SM_PRG)
E_SP_ED(_SD)
_RP=_E_RP*_FAK2
_RTP=_RP-_SD
G17
N310 E_SP_RP(2,_RTP,S_XC,S_YC,_RTP)
ELSE
IF(_GAMA==180)
_XS=_XS-2*$P_TOOLL[ABS($P_ACT_TOOL_LENGTH_INDEX[0])]
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: F_SP_BC")
ENDIF
F_SP_BC(_TM1)
F_SP_RPT(2,_TMOD)
_RP=_F_RP_ACT*_FAK2
_RTP=_RP
IF(_TM1==1)
F_SP_TRA(2012,,_C0)
F_SP_RP(0,_RP,_YS,0,_XS)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N32 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
F_SP_RP(9,S_XC+_XS,_RP,0,S_YC)
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N33 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
_AX1=$P_AXN1 _AX2=$P_AXN2 _AX3=$P_AXN3
IF(_F_RELEAS==0)
SBLON
N34 G90 G0 G40 AX[_AX1]=S_XC+_XS AX[_AX2]=S_YC AX[_AX3]=_RP
N341 G90 G0 G40 AX[_AX3]=_ZS
SBLOF
ENDIF
ENDIF
ENDIF
IF($MCS_TECHNOLOGY==2)
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H0000')
DIAM90
ELSE
IF(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'HC000')=='H8000')
DIAMON
ELSE
DIAMOF
ENDIF
ENDIF
IF(S_IPT==0)
_P29=$P_GG[29]
ENDIF
DIAMCYCOF
ENDIF
IF(S_IPT==1)
IF(_E_SM_PRG)
S_PL=_E_PLANE
ELSE
IF(_TM1==1)
S_PL=3
ELSE
S_PL=1
ENDIF
ENDIF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N806 Anwahl Interpolationsdrehen")
ENDIF
IF(_E_SM_PRG)
N806 CYCLE806(0001,S_XC,S_YC,_GAMA,_S,_SV2,5,_SA-1+100,S_PL,S_TRA,2*_XS,_RP)
SBLON
G4 F0
SBLOF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N334 E_TFS")
ENDIF
N334 E_TFS(_T,_TF,_DD,_F,_FAA,_S,_SA,0)
SBLON
G4 F0
SBLOF
ELSE
N806 CYCLE806(0001,S_XC,S_YC,_GAMA,_S,_SV2,5,_SA-1,S_PL,S_TRA)
SBLON
G4 F0
SBLOF
IF(_LOG_ON)
WRITE(_LOG,_LOG_FILE,"IPT: N251 F_TFS")
ENDIF
N251 F_TFS(_T,,_DD,_F,_FAA,_S,_SA,,0)
SBLON
G4 F0
SBLOF
ENDIF
DIAMCYCOF
SBLON
N810 G0 G90 AX[_ZZ]=_ZS
SBLOF
ELSE
IF S_Y_TURN
IF(_BA1 B_AND 2)
_XS=_STX+_V*_AI
ELSE
_XS=_STX
ENDIF
_ZS=_STZ
SBLON
IF($P_EP[_ZZ]*_FAK1<_F_RPT[1]*_FAK2)AND($P_EP[_YY]<>0)
N1840 G0 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
IF($P_EP[_ZZ]*_FAK1>_F_RPT[1]*_FAK2)
N1850 G0 AX[_XX]=_F_RPT[0]*_FAK2 AX[_ZZ]=_F_RPT[1]*_FAK2
ELSE
N1860 G0 AX[_XX]=_F_RPT[0]*_FAK2
ENDIF
N1870 G0 AX[_YY]=0
N1880 G0 AX[_ZZ]=_ZS
N1890 G0 G90 AX[_XX]=_XS AX[_ZZ]=_ZS
SBLOF
ELSE
IF(_MAN==0)
IF(_AI==-1)
F_SP_RP(3,_F_RP_ACT*_FAK2+0.001*_FAK3,_STZ)
ENDIF
N40 F_SP_RP(0,_F_RP_ACT*_FAK2,_STZ,0)
IF(_F_RELEAS==0)
SBLON
N50 G0 AX[_XX]=_F_RP_ACT*_FAK2 AX[_ZZ]=_STZ
SBLOF
ENDIF
F_SP_TRA(1040)
ELSE
IF((_XS*_AI<=_X0*_AI)OR(_ZS*_PM>=_Z0*_PM)) GOTOF _FEHL5
SBLON
IF(_F_Y_AXIS==0)
N70 G0 AX[_XX]=_STX AX[_ZZ]=_STZ
ELSE
N80 G0 AX[_XX]=_STX AX[_ZZ]=_STZ AX[_YY]=0
ENDIF
SBLOF
ENDIF
ENDIF
ENDIF
IF(_BA1 B_AND 1)
IF(_BA2)
_M_GROB_A:
_PG[0,0]=0
_PG[0,1]=_Z1
_PG[1,0]=-_X1
_PG[1,1]=_Z1-_X1/TAN(_A)
_PG[2,0]=-_X1
_PG[2,1]=0
_PG[3,0]=0
_PG[3,1]=0
_PR[0,2]=_R1
_PR[1,2]=_R2
_M_GROB_E:
_OFK=_U+_WR
_OFX=_UX
_OFZ=_UZ
_M_GROB_WR_U_A:
_PG[0,0]=_PG[0,0]
_PG[0,1]=_PG[0,1]-_OFK/SIN(_A)-_OFZ-_OFX/TAN(_A)
_PG[1,0]=_PG[1,0]+_OFK+_OFX
_PG[1,1]=_PG[1,1]-_OFK*TAN(_A/2)-_OFZ
_PG[2,0]=_PG[2,0]+_OFK+_OFX
_PG[2,1]=_PG[2,1]+_OFK+_OFZ
_PG[3,0]=_PG[3,0]
_PG[3,1]=_PG[3,1]+_OFK+_OFZ
_PR[0,2]=_PR[0,2]-_OFK
_PR[1,2]=_PR[1,2]-_OFK
IF(_PR[0,2]<0)
_PR[0,2]=0
ENDIF
IF(_PR[1,2]<0)
_PR[1,2]=0
ENDIF
_PR[0,0]=_PG[1,0]+_PR[0,2]
_PR[0,1]=_PG[1,1]-_PR[0,2]*TAN(_A/2)
_PR[1,0]=_PG[2,0]+_PR[1,2]
_PR[1,1]=_PG[2,1]+_PR[1,2]
_M_GROB_WR_U_E:
IF(_PR[1,1]>_PR[0,1])GOTOF _FEHL6
_M_GROB_WR_U_CHECK_E:
_M_FEIN_A:
_PF[0,0]=_PG[0,0]
_PF[0,1]=_PG[0,1]
_PF[1,0]=_PG[1,0]+_PR[0,2]*TAN(_A/2)*SIN(_A)
_PF[1,1]=_PG[1,1]+_PR[0,2]*TAN(_A/2)*COS(_A)
_PF[2,0]=_PG[1,0]
_PF[2,1]=_PR[0,1]
_PF[3,0]=_PG[2,0]
_PF[3,1]=_PR[1,1]
_PF[4,0]=_PR[1,0]
_PF[4,1]=_PG[3,1]
_PF[5,0]=_PG[3,0]
_PF[5,1]=_PG[3,1]
_M_FEIN_E:
FOR _I=1 TO _ZUG
IF(_I==1)
_P[0,0]=_SC+_WR
_P[2,0]=-_D+_WR
ELSE
_P[0,0]=_P[2,0]
IF(_I==_ZUG)
_P[2,0]=-_ZUT+_WR
ELSE
_P[2,0]=_P[2,0]-_D
ENDIF
ENDIF
_P[3,0]=_P[2,0]
_P[5,0]=_P[0,0]
IF(_P[0,0]>=_PF[1,0])
_P[0,1]=_PF[0,1]+_P[0,0]/TAN(_A)
IF(_P[2,0]>=_PF[1,0])
_P[2,1]=_PF[0,1]+_P[2,0]/TAN(_A)
_P[1,0]=_P[2,0]
_P[1,1]=_P[2,1]
ELSE
_P[2,1]=_PF[2,1]+SQRT(ABS(POT(_PR[0,2])-POT(_PR[0,0]-_P[2,0])))
_P[1,0]=_PF[1,0]
_P[1,1]=_PF[1,1]
ENDIF
ELSE
_P[0,1]=_PF[2,1]+SQRT(ABS(POT(_PR[0,2])-POT(_PR[0,0]-_P[0,0])))
_P[2,1]=_PF[2,1]+SQRT(ABS(POT(_PR[0,2])-POT(_PR[0,0]-_P[2,0])))
_P[1,0]=_P[0,0]
_P[1,1]=_P[0,1]
ENDIF
IF(_P[5,0]>=_PF[4,0])
_P[5,1]=_PF[4,1]
IF(_P[3,0]>=_PF[4,0])
_P[3,1]=_PF[4,1]
_P[4,0]=_P[3,0]
_P[4,1]=_P[3,1]
ELSE
_P[3,1]=_PF[3,1]-SQRT(ABS(POT(_PR[1,2])-POT(_PR[1,0]-_P[3,0])))
_P[4,0]=_PF[4,0]
_P[4,1]=_PF[4,1]
ENDIF
ELSE
_P[5,1]=_PF[3,1]-SQRT(ABS(POT(_PR[1,2])-POT(_PR[1,0]-_P[5,0])))
_P[3,1]=_PF[3,1]-SQRT(ABS(POT(_PR[1,2])-POT(_PR[1,0]-_P[3,0])))
_P[4,0]=_P[5,0]
_P[4,1]=_P[5,1]
ENDIF
N100 G0 AX[_ZZ]=_Z0-(_P[0,1]-_WR)*_PM
IF(_I==1)
N110 G0 AX[_XX]=_X0+(_P[0,0]-_WR)*_AI
ELSE
IF(_D>_SC)
N120 G0 AX[_XX]=_X0+(_P[0,0]+_SC-_WR)*_AI
ENDIF
ENDIF
N130 G1 AX[_XX]=_X0+(_P[0,0]-_WR)*_AI
IF(_P[0,0]<>_P[1,0])
N140 G1 AX[_XX]=_X0+(_P[1,0]-_WR)*_AI AX[_ZZ]=_Z0-(_P[1,1]-_WR)*_PM
ENDIF
IF(_P[1,0]<>_P[2,0])
N150 G[1]=_G2_3 AX[_XX]=_X0+(_P[2,0]-_WR)*_AI AX[_ZZ]=_Z0-(_P[2,1]-_WR)*_PM CR=_PR[0,2]
ENDIF
N160 G1 AX[_XX]=_X0+(_P[3,0]-_WR)*_AI AX[_ZZ]=_Z0-(_P[3,1]-_WR)*_PM
IF(_P[3,0]<>_P[4,0])
N170 G[1]=_G2_3 AX[_XX]=_X0+(_P[4,0]-_WR)*_AI AX[_ZZ]=_Z0-(_P[4,1]-_WR)*_PM CR=_PR[1,2]
ENDIF
IF(_P[4,0]<>_P[5,0])
N180 G1 AX[_XX]=_X0+(_P[5,0]-_WR)*_AI
ENDIF
ENDFOR
ELSE
FOR _I=1 TO _ZUG
REPEAT _M_GROB_A _M_GROB_E
_OFK=_U+_WR
_OFX=_UX
_OFZ=_UZ
REPEAT _M_GROB_WR_U_A _M_GROB_WR_U_CHECK_E
_OFK=_D*(_ZUG-_I)
_OFX=0
_OFZ=0
REPEAT _M_GROB_WR_U_A _M_GROB_WR_U_E
REPEAT _M_FEIN_A _M_FEIN_E
_P[0,0]=_SC+_WR
_P[0,1]=_PF[0,1]+_P[0,0]/TAN(_A)
_P[1,0]=_PF[1,0]
_P[1,1]=_PF[1,1]
_P[2,0]=_PF[2,0]
_P[2,1]=_PF[2,1]
_P[3,0]=_PF[3,0]
_P[3,1]=_PF[3,1]
_P[4,0]=_PF[4,0]
_P[4,1]=_PF[4,1]
_P[5,0]=_PF[5,0]
_P[5,1]=_PF[5,1]
IF(_P[1,1]<_P[4,1])
_P[1,0]=_P[0,0]-(_P[0,1]-_P[4,1])*TAN(_A)
_P[1,1]=_P[4,1]
_P[2,0]=_P[1,0]
_P[2,1]=_P[1,1]
_P[3,0]=_P[1,0]
_P[3,1]=_P[1,1]
_P[4,0]=_P[1,0]
ENDIF
IF(_P[2,1]<_P[4,1])
_P[2,0]=_PR[0,0]-SQRT(ABS(POT(_PR[0,2])-POT(_PR[0,1]-_P[4,1])))
_P[2,1]=_P[4,1]
_P[3,0]=_P[2,0]
_P[3,1]=_P[2,1]
_P[4,0]=_P[2,0]
ENDIF
_M_CHECK_R1_A:
IF(_P[1,0]>_P[0,0])
_P[1,1]=_PR[0,1]+SQRT(ABS(POT(_PR[0,2])-POT(_PR[0,0]-_P[0,0])))
_P[1,0]=_P[0,0]
_P[0,1]=_P[1,1]
ENDIF
_M_CHECK_R1_E:
IF(_P[2,0]>_WR) GOTOF _M_ENDFOR
N200 G0 F=_F AX[_XX]=_X0+(_P[0,0]-_WR)*_AI
N210 G0 AX[_ZZ]=_Z0-(_P[0,1]-_WR)*_PM
IF(_P[0,0]<>_P[1,0])
N220 G1 AX[_XX]=_X0+(_P[1,0]-_WR)*_AI AX[_ZZ]=_Z0-(_P[1,1]-_WR)*_PM
ENDIF
IF(_P[1,0]<>_P[2,0])
N230 G[1]=_G2_3 AX[_XX]=_X0+(_P[2,0]-_WR)*_AI AX[_ZZ]=_Z0-(_P[2,1]-_WR)*_PM CR=_PR[0,2]
ENDIF
IF(_P[2,1]<>_P[3,1])
N240 G1 AX[_XX]=_X0+(_P[3,0]-_WR)*_AI AX[_ZZ]=_Z0-(_P[3,1]-_WR)*_PM
ENDIF
IF(_P[3,0]<>_P[4,0])
N241 G[1]=_G2_3 AX[_XX]=_X0+(_P[4,0]-_WR)*_AI AX[_ZZ]=_Z0-(_P[4,1]-_WR)*_PM CR=_PR[1,2]
ENDIF
IF(_P[4,0]<_P[5,0])
N260 G1 AX[_XX]=_X0+(_P[5,0]-_WR)*_AI
ENDIF
_M_ENDFOR:
ENDFOR
ENDIF
IF(_P[5,1]==_PF[5,1])
N280 G0 AX[_XX]=_X0+(_P[5,0]+_SC*SIN(_A)-_WR)*_AI AX[_ZZ]=_Z0-(_P[5,1]+_SC*COS(_A)-_WR)*_PM
ENDIF
IF(_BA1==1)
SBLON
N290 G0 AX[_XX]=_X0+_SC*_AI
SBLOF
ENDIF
ENDIF
IF(_BA1 B_AND 2)
IF(_BA1==3)
F=_F*$SCS_TURN_FIN_FEED_PERCENT/100
ENDIF
REPEAT _M_GROB_A _M_GROB_E
_OFK=_WR _OFX=0 _OFZ=0
REPEAT _M_GROB_WR_U_A _M_GROB_WR_U_E
REPEAT _M_FEIN_A _M_FEIN_E
_P[0,0]=_SC+_WR
_P[0,1]=_PF[0,1]+_P[0,0]/TAN(_A)
_P[1,0]=_PF[1,0]
_P[1,1]=_PF[1,1]
_P[2,0]=_PF[2,0]
_P[2,1]=_PF[2,1]
_P[3,0]=_PF[3,0]
_P[3,1]=_PF[3,1]
_P[4,0]=_PF[4,0]
_P[4,1]=_PF[4,1]
_P[5,0]=_PF[5,0]+_V
_P[5,1]=_PF[5,1]
REPEAT _M_CHECK_R1_A _M_CHECK_R1_E
N300 G0 F=_F AX[_XX]=_X0+(_P[0,0]-_WR)*_AI
N305 G0 AX[_ZZ]=_Z0-(_P[0,1]-_WR)*_PM
IF(_P[0,0]<>_P[1,0])
N320 G1 AX[_XX]=_X0+(_P[1,0]-_WR)*_AI AX[_ZZ]=_Z0-(_P[1,1]-_WR)*_PM
ENDIF
IF(_P[1,0]<>_P[2,0])
N330 G[1]=_G2_3 AX[_XX]=_X0+(_P[2,0]-_WR)*_AI AX[_ZZ]=_Z0-(_P[2,1]-_WR)*_PM CR=_PR[0,2]
ENDIF
N340 G1 AX[_XX]=_X0+(_P[3,0]-_WR)*_AI AX[_ZZ]=_Z0-(_P[3,1]-_WR)*_PM
IF(_P[3,0]<>_P[4,0])
N350 G[1]=_G2_3 AX[_XX]=_X0+(_P[4,0]-_WR)*_AI AX[_ZZ]=_Z0-(_P[4,1]-_WR)*_PM CR=_PR[1,2]
ENDIF
IF(_P[4,0]<>_P[5,0])
N360 G1 AX[_XX]=_X0+(_P[5,0]-_WR)*_AI
ENDIF
SBLON
N370 G0 AX[_XX]=_X0+(_P[5,0]-_WR+_SC)*_AI
SBLOF
ENDIF
IF(_MAN==0)
IF(_E_ST_PRG)
IF(_AI==-1)
F_SP_RP(4,$P_EP[_XX]*_FAK1,$P_EP[_ZZ]*_FAK1)
ENDIF
IF(S_IPT==1)
CYCLE806(0)
S_M_OK=0
SBLON
N125 G0 G90 AX[_ZZ]=_RTP
SBLOF
ENDIF
ELSE
IF(S_IPT==1)
SBLON
N111 G0 G90 AX[_XX]=_XS
SBLOF
CYCLE806(0)
S_M_OK=0
G[29]=_P29
_ZZ=$P_AXN3
SBLON
N131 G0 G90 AX[_ZZ]=_RTP
SBLOF
ELSE
SBLON
N380 G0 G90 AX[_XX]=_F_RP_ACT*_FAK2
IF(_AI==-1)
N390 G0 G90 AX[_ZZ]=_F_RPT[1]*_FAK2
ENDIF
SBLOF
F_SP_RP(101,,,1)
ENDIF
ENDIF
ELSE
SBLON
IF(_F_Y_AXIS==0)
N400 G0 AX[_XX]=_XS AX[_ZZ]=_ZS
ELSE
N410 G0 AX[_XX]=_XS AX[_ZZ]=_ZS AX[_YY]=_YS
ENDIF
SBLOF
ENDIF
G[29]=_P29
_RETS:
_F_RELEAS=0
SBLON
RET
_FEHL1: STOPRE
N994061 SETAL(61608)
RET
_FEHL2: STOPRE
N994062 SETAL(61605)
RET
_FEHL3: STOPRE
N994063 SETAL(61240)
RET
_FEHL4: STOPRE
N994064 SETAL(61212)
RET
_FEHL5: STOPRE
N994065 SETAL(61284)
RET
_FEHL6: STOPRE
N994066 SETAL(61010)
RET
_FEHL7: STOPRE
N994067 SETAL(61286)
RET
_FEHL8: STOPRE
N994068 SETAL(61862)
RET
_FEHL9: STOPRE
N994069 SETAL(61863)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MT_TUR_SPF
PROC F_MT_TUR(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _BETA,INT _BETAA,REAL _GAMA,REAL S_Z,REAL S_X,REAL S_Y,INT S_MVAR,INT S_KNUM,INT S_PRNUM,INT S_MA,INT S_MD,REAL S_ID,REAL S_FA,REAL S_TSA,REAL S_VMS,REAL S_STA1,REAL S_CORA,REAL S_TZL,REAL S_TDIF,INT S_NMSP,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.07.67.00 ;DATE: 2016-09-23
;ShopTurn: Measure tool: Turning tool
DEF AXIS _XX,_YY,_ZZ
DEF INT _P29,_SL,_P2,S_MVAR5,_WTYP
DEF INT _SLT[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,2,1,4,3,7,6,5,8,9)
DEF INT _SLX[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,4,3,2,1,5,8,7,6,9)
DEF INT S_MAT[10]=set(-1,4,5,5,4,4,0,5,1,5)
DEF REAL _FAK1,_FAK2,_T_DIR
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
S_X=S_X/2
_P29=$P_GG[29]
DIAMCYCOF
N10 G40 G90
F_SP_TRA(2040)
_ZZ=$P_AXN1 _XX=$P_AXN2
IF(_F_Y_AXIS<>0)
_YY=$P_AXN3
ENDIF
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N25 F_TFS(_T,_TF,_DD,,,,,2,10)
_F_INIT=1
IF($P_TOOLNO)
_WTYP=$P_ADT[1]
ENDIF
IF(_WTYP>=500)AND(_WTYP<=599)
N26 F_SP_BC(4,_BETA,_GAMA)
ELSE
N27 F_SP_BC(8,_BETA,_SC_A_NO_VAL)
ENDIF
_T_DIR=((_BETA MOD 360) + 360) MOD 360
S_MVAR=S_MVAR-(S_MVAR _DEC5)*10000
IF(_T_DIR==0)OR(_T_DIR==180)
S_MVAR5=0
ELSE
S_MVAR5=1
ENDIF
S_MVAR=S_MVAR+S_MVAR5*10000
ELSE
N28 F_TFS(_T,_TF,_DD,,,,,2,10)
_F_INIT=1
ENDIF
_SL=$P_ADT[2]
IF(NOT(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'H00200000')AND($P_CUTMOD)))
_SL=_SLT[$P_ACTFRAME[_ZZ,MI],_SL]
_SL=_SLX[$P_ACTFRAME[_XX,MI],_SL]
ENDIF
_P2=S_MAT[_SL]
F_SP_RPT(4,_P2)
IF(_F_RELEAS==0)
N50 F_SP_RP(10,S_X,S_Z,0,S_Y)
ELSE
SBLON
IF(_F_Y_AXIS<>0)
N55 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z AX[_YY]=S_Y
ELSE
N56 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z
ENDIF
SBLOF
ENDIF
_DMODE=_DMODE-(_DMODE _DEC1)
_AMODE=_AMODE-(_AMODE _DEC4)
_AMODE=_AMODE+1000
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
N982 CYCLE982(S_MVAR,S_KNUM,S_PRNUM,S_MA,S_MD,S_ID,S_FA,S_TSA,S_VMS,S_STA1,S_CORA,S_TZL,S_TDIF,S_NMSP,S_EVNUM,S_MCBIT,_DMODE,_AMODE)
ENDIF
SBLON
IF(_F_Y_AXIS<>0)
N1000 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z AX[_YY]=S_Y
ELSE
N1010 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z
ENDIF
SBLOF
G[29]=_P29
_RETS:
_F_RELEAS=0
SBLON
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MT_MIL_SPF
PROC F_MT_MIL(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _BETA,INT _BETAA,REAL S_Z,REAL S_X,REAL S_Y,INT S_MVAR,INT S_KNUM,INT S_PRNUM,INT S_MA,INT S_MD,REAL S_ID,REAL S_FA,REAL S_TSA,REAL S_VMS,REAL S_STA1,REAL S_CORA,REAL S_TZL,REAL S_TDIF,INT S_NMSP,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.04.17.00 ;DATE: 2011-06-27
;ShopTurn: Measure tool: Milling tool
F_MT_TUR(_T,_TF,_DD,_BETA,_BETAA,0,S_Z,S_X,S_Y,S_MVAR,S_KNUM,S_PRNUM,S_MA,S_MD,S_ID,S_FA,S_TSA,S_VMS,S_STA1,S_CORA,S_TZL,S_TDIF,S_NMSP,S_EVNUM,S_MCBIT,_DMODE,_AMODE)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MT_DR_SPF
PROC F_MT_DR(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _BETA,INT _BETAA,REAL S_Z,REAL S_X,REAL S_Y,INT S_MVAR,INT S_KNUM,INT S_PRNUM,INT S_MA,INT S_MD,REAL S_ID,REAL S_FA,REAL S_TSA,REAL S_VMS,REAL S_STA1,REAL S_CORA,REAL S_TZL,REAL S_TDIF,INT S_NMSP,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.04.17.00 ;DATE: 2011-06-27
;ShopTurn: Measure tool: Drilling tool
F_MT_TUR(_T,_TF,_DD,_BETA,_BETAA,0,S_Z,S_X,S_Y,S_MVAR,S_KNUM,S_PRNUM,S_MA,S_MD,S_ID,S_FA,S_TSA,S_VMS,S_STA1,S_CORA,S_TZL,S_TDIF,S_NMSP,S_EVNUM,S_MCBIT,_DMODE,_AMODE)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_SPH_SPF
PROC F_MP_SPH(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_KNUM,INT S_PRNUM,REAL S_SETV,REAL S_FA,REAL S_TSA,REAL S_STA1,REAL S_INCA,REAL S_SETV0,REAL S_SETV1,REAL S_SETV2,REAL S_SETV3,REAL S_SETV4,REAL S_SETV5,REAL S_SETV6,REAL S_SETV7,REAL S_SETV8,REAL S_TNVL,INT S_NMSP,INT S_MCBIT,INT _DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.04.11.00 ;DATE: 2011-03-09
;ShopTurn: Measure part: Sphere
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
F_MP_3SP(_T,_TF,_DD,_TMOD,S_X,S_Y,S_Z,S_C,S_MVAR,S_KNUM,S_PRNUM,S_SETV,S_FA,S_TSA,S_STA1,S_INCA,S_SETV0,S_SETV1,S_SETV2,S_SETV3,S_SETV4,S_SETV5,S_SETV6,S_SETV7,S_SETV8,S_TNVL,S_NMSP,S_MCBIT,_DMODE,_AMODE)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_SL_SPF
PROC F_MP_SL(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_KNUM,INT S_KNUM1,INT S_PRNUM,REAL S_SETV,REAL S_SETV0,REAL S_SETV1,REAL S_FA,REAL S_TSA,REAL S_STA1,REAL S_ID,REAL S_SZA,REAL S_SZO,INT S_MA,INT S_NMSP,STRING[32] S_TNAME,INT S_DLNUM,REAL S_TZL,REAL S_TDIF,REAL S_TUL,REAL S_TLL,REAL S_TMV,INT S_K,INT S_EVNUM,INT S_MCBIT,INT S_DMODE,INT _AMODE,REAL S_XM,REAL S_YM,INT _DP) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Measure part: Slot
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _DMODE,_DIR,_TM1,_TM3,_TM4,_TM6,_TM9,_MD_CLAMP,_P29,S_MD_BREAK,_MERKER_C=0
DEF REAL _DZ,_C0,_X0,_Y0,_Z0,_FAK1,_FAK2,_SC,_RP,_SPX,_XS,_YS
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
S_MD_BREAK=$MCS_FUNCTION_MASK_MILL B_AND 'H100'
_TM1=_TMOD _DEC1 _TM3=_TMOD _DEC3
_TM4=_TMOD _DEC4
IF _MD_CLAMP
_TM6=TRUNC(_TMOD/100000) MOD 10
ELSE
_TM6=2
ENDIF
IF S_MD_BREAK
_TM9=_TMOD _DEC9
ELSE
_TM9=0
ENDIF
_DMODE=S_DMODE-(S_DMODE _DEC1)
_X0=S_X _Y0=S_Y _Z0=S_Z
_C0=S_C
_P29=$P_GG[29]
DIAMCYCOF
IF(_TM6==0)
_TM6=2
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
IF(_TM3==0)
_DZ=-(ABS(S_ID))
ELSE
_DZ=ABS(S_ID)
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N14 F_TFS(_T,_TF,_DD,,,,,2)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
F_SP_RPT(2,_TMOD)
IF S_CALL_FROM_MA_JOG_STEP
_E_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RP=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RP=_F_RP_ACT*_FAK2
ENDIF
IF(_TM1<2)
IF(_TM1==0)
GOTOF _FEHL1
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,_Z0,_C0)
IF(_F_RELEAS==0)
F_SP_RP(0,_RP,_Y0,0,_X0)
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N35 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
_YY=$P_AXN1 _ZZ=$P_AXN2 _XX=$P_AXN3
SBLON
N40 G90 G0 G40 AX[_XX]=_Z0 AX[_ZZ]=_Y0 AX[_YY]=_X0
SBLOF
ELSE
_SPX=_X0
IF(_TM1==2)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
_SPX=SQRT(ABS(POT(_XS)+POT(_YS)))
IF(_F_RELEAS==0)
F_SP_RP(0,_SPX,_RP,0)
ENDIF
IF(_TM9==1)
F_SP_TRA(103122)
ELSE
F_SP_TRA(3122)
ENDIF
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC) GOTOF _FEHL2
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
IF(_F_RELEAS==0)
F_SP_RP(9,_XS,_RP,0,_YS)
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N65 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
_XX=$P_AXN1 _YY=$P_AXN2 _ZZ=$P_AXN3
SBLON
IF(_TM1==6)
IF(_F_RELEAS==0)
N66 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS
ELSE
N67 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ENDIF
ELSE
IF(_F_RELEAS==0)
N68 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_RP
ELSE
N69 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ENDIF
ENDIF
N70 G90 G0 G40 AX[_ZZ]=_Z0
SBLOF
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
IF(_TM1==0)OR(_TM1==2)
IF(_TM9==1)
_MERKER_C=4
ELSE
_MERKER_C=0
ENDIF
ELSE
IF(_TM6==2)
_MERKER_C=2
ELSE
_MERKER_C=0
ENDIF
ENDIF
IF(_MERKER_C==0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>0)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
IF(_MERKER_C==2)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>1)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
IF(_MERKER_C==4)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]<>2)
CUST_TECHCYC(403+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=2
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N977 CYCLE977(S_MVAR,S_KNUM,S_KNUM1,S_PRNUM,S_SETV,S_SETV0,S_SETV1,S_FA,S_TSA,S_STA1,_DZ,S_SZA,S_SZO,S_MA,S_NMSP,S_TNAME,S_DLNUM,S_TZL,S_TDIF,S_TUL,S_TLL,S_TMV,S_K,S_EVNUM,S_MCBIT,_DMODE,_AMODE,S_XM,S_YM,_DP)
ELSE
N1000 G0 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ENDIF
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
G[29]=_P29
_RETS:
RET
_FEHL1: STOPRE
N997701 SETAL(61020)
RET
_FEHL2: STOPRE
N997702 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_POR_SPF
PROC F_MP_POR(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_KNUM,INT S_KNUM1,INT S_PRNUM,REAL S_SETV,REAL S_SETV0,REAL S_SETV1,REAL S_FA,REAL S_TSA,REAL S_STA1,REAL S_ID,REAL S_SZA,REAL S_SZO,INT S_MA,INT S_NMSP,STRING[32] S_TNAME,INT S_DLNUM,REAL S_TZL,REAL S_TDIF,REAL S_TUL,REAL S_TLL,REAL S_TMV,INT S_K,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE,REAL S_XM,REAL S_YM,INT _DP) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.94.00.00.005 ;DATE: 2020-05-12
;ShopTurn: Measure part: Rectangular pocket
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
F_MP_SL(_T,_TF,_DD,_TMOD,S_X,S_Y,S_Z,S_C,S_MVAR,S_KNUM,S_KNUM1,S_PRNUM,S_SETV,S_SETV0,S_SETV1,S_FA,S_TSA,S_STA1,S_ID,S_SZA,S_SZO,S_MA,S_NMSP,S_TNAME,S_DLNUM,S_TZL,S_TDIF,S_TUL,S_TLL,S_TMV,S_K,S_EVNUM,S_MCBIT,_DMODE,_AMODE,S_XM,S_YM,_DP)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_PL_SPF
PROC F_MP_PL(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_KNUM,INT S_RA,INT S_PRNUM,REAL S_SETV,REAL S_STA1,REAL S_INCA,REAL S_FA,REAL S_TSA,INT S_MA,INT S_MD,REAL S_ID,REAL S_SETV0,REAL S_SETV1,REAL S_SETV2,REAL S_SETV3,INT S_NMSP,INT S_MCBIT,INT S_DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Measure part: Align plane
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _DMODE,_DIR,_TM1,_TM3,_TM4,_TM6,_MD_CLAMP,_P29
DEF REAL _DZ,_C0,_X0,_Y0,_Z0,_FAK1,_FAK2,_SC,_RP,_XS,_YS
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_TM1=_TMOD _DEC1 _TM3=_TMOD _DEC3
_TM4=_TMOD _DEC4 _TM6=_TMOD _DEC6
_DMODE=S_DMODE-(S_DMODE _DEC1)
_X0=S_X _Y0=S_Y _Z0=S_Z
_C0=S_C
_P29=$P_GG[29]
DIAMCYCOF
IF(_TM6==0)
_TM6=2
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
IF(_TM3==0)
_DZ=-(ABS(S_ID))
ELSE
_DZ=ABS(S_ID)
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N14 F_TFS(_T,_TF,_DD,,,,,2)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
F_SP_RPT(2,_TMOD)
IF S_CALL_FROM_MA_JOG_STEP
_E_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RP=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RP=_F_RP_ACT*_FAK2
ENDIF
IF(_TM1<2)
IF(_TM1==0)
GOTOF _FEHL1
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,_Z0,_C0)
IF(_F_RELEAS==0)
F_SP_RP(0,_RP,_Y0,0,_X0)
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N35 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
_YY=$P_AXN1 _ZZ=$P_AXN2 _XX=$P_AXN3
SBLON
N40 G90 G0 G40 AX[_XX]=_Z0 AX[_ZZ]=_Y0 AX[_YY]=_X0
SBLOF
ELSE
IF(_TM1==2)
GOTOF _FEHL1
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC) GOTOF _FEHL2
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
IF(_F_RELEAS==0)
F_SP_RP(9,_XS,_RP,0,_YS)
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N65 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
_XX=$P_AXN1 _YY=$P_AXN2 _ZZ=$P_AXN3
SBLON
IF(_TM1==6)
IF(_F_RELEAS==0)
N66 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS
ELSE
N67 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ENDIF
ELSE
IF(_F_RELEAS==0)
N68 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_RP
ELSE
N69 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ENDIF
ENDIF
N70 G90 G0 G40 AX[_ZZ]=_Z0
SBLOF
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_TM1==1)OR(_TM1==3)OR(_TM1==6)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N998 CYCLE998(S_MVAR,S_KNUM,S_RA,S_PRNUM,S_SETV,S_STA1,S_INCA,S_FA,S_TSA,S_MA,S_MD,_DZ,S_SETV0,S_SETV1,S_SETV2,S_SETV3,S_NMSP,S_MCBIT,_DMODE,_AMODE)
ELSE
N1000 G0 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ENDIF
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
G[29]=_P29
_RETS:
RET
_FEHL1: STOPRE
N999801 SETAL(61020)
RET
_FEHL2: STOPRE
N999802 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_PIR_SPF
PROC F_MP_PIR(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_KNUM,INT S_KNUM1,INT S_PRNUM,REAL S_SETV,REAL S_SETV0,REAL S_SETV1,REAL S_FA,REAL S_TSA,REAL S_STA1,REAL S_ID,REAL S_SZA,REAL S_SZO,INT S_MA,INT S_NMSP,STRING[32] S_TNAME,INT S_DLNUM,REAL S_TZL,REAL S_TDIF,REAL S_TUL,REAL S_TLL,REAL S_TMV,INT S_K,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE,REAL S_XM,REAL S_YM,INT _DP) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.94.00.00.005 ;DATE: 2020-05-12
;ShopTurn: Measure part: Rectangular spigot
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
F_MP_SL(_T,_TF,_DD,_TMOD,S_X,S_Y,S_Z,S_C,S_MVAR,S_KNUM,S_KNUM1,S_PRNUM,S_SETV,S_SETV0,S_SETV1,S_FA,S_TSA,S_STA1,S_ID,S_SZA,S_SZO,S_MA,S_NMSP,S_TNAME,S_DLNUM,S_TZL,S_TDIF,S_TUL,S_TLL,S_TMV,S_K,S_EVNUM,S_MCBIT,_DMODE,_AMODE,S_XM,S_YM,_DP)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_PIC_SPF
PROC F_MP_PIC(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_KNUM,INT S_KNUM1,INT S_PRNUM,REAL S_SETV,REAL S_SETV0,REAL S_SETV1,REAL S_FA,REAL S_TSA,REAL S_STA1,REAL S_ID,REAL S_SZA,REAL S_SZO,INT S_MA,INT S_NMSP,STRING[32] S_TNAME,INT S_DLNUM,REAL S_TZL,REAL S_TDIF,REAL S_TUL,REAL S_TLL,REAL S_TMV,INT S_K,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE,REAL S_XM,REAL S_YM,INT _DP) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.94.00.00.005 ;DATE: 2020-05-12
;ShopTurn: Measure part: Circular spigot
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
F_MP_SL(_T,_TF,_DD,_TMOD,S_X,S_Y,S_Z,S_C,S_MVAR,S_KNUM,S_KNUM1,S_PRNUM,S_SETV,S_SETV0,S_SETV1,S_FA,S_TSA,S_STA1,S_ID,S_SZA,S_SZO,S_MA,S_NMSP,S_TNAME,S_DLNUM,S_TZL,S_TDIF,S_TUL,S_TLL,S_TMV,S_K,S_EVNUM,S_MCBIT,_DMODE,_AMODE,S_XM,S_YM,_DP)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_LIN_SPF
PROC F_MP_LIN(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_KNUM,INT S_RA,INT S_PRNUM,REAL S_SETV,REAL S_STA1,REAL S_INCA,REAL S_FA,REAL S_TSA,INT S_MA,INT S_MD,REAL S_ID,REAL S_SETV0,REAL S_SETV1,REAL S_SETV2,REAL S_SETV3,INT S_NMSP,INT S_MCBIT,INT _DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.04.01.00 ;DATE: 2010-08-25
;ShopTurn: Measure part: Align edge
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
F_MP_PL(_T,_TF,_DD,_TMOD,S_X,S_Y,S_Z,S_C,S_MVAR,S_KNUM,S_RA,S_PRNUM,S_SETV,S_STA1,S_INCA,S_FA,S_TSA,S_MA,S_MD,S_ID,S_SETV0,S_SETV1,S_SETV2,S_SETV3,S_NMSP,S_MCBIT,_DMODE,_AMODE)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_FCE_SPF
PROC F_MP_FCE(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _BETA,INT _BETAA,REAL S_Z,REAL S_X,REAL S_Y,INT S_MVAR,INT S_KNUM,INT S_KNUM1,INT S_PRNUM,REAL S_SETV,INT S_MA,REAL S_FA,REAL S_TSA,REAL S_STA1,INT S_NMSP,STRING[32] S_TNAME,INT S_DLNUM,REAL S_TZL,REAL S_TDIF,REAL S_TUL,REAL S_TLL,REAL S_TMV,INT S_K,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE,INT _DP) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.90.00.00.001 ;DATE: 2018-02-22
;ShopTurn: Measure part: Set face
DEF AXIS _XX,_YY,_ZZ
DEF INT _P29,_TYP
DEF REAL _FAK1,_FAK2
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
S_X=S_X/2
_P29=$P_GG[29]
DIAMCYCOF
N10 G40 G90
F_SP_TRA(2040)
_ZZ=$P_AXN1 _XX=$P_AXN2
IF(_F_Y_AXIS<>0)
_YY=$P_AXN3
ENDIF
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N25 F_TFS(_T,_TF,_DD,,,,,_F_MASPI+1,0)
N26 F_SP_BC(10004,_BETA,0)
ELSE
N28 F_TFS(_T,_TF,_DD,,,,,_F_MASPI+1,0)
ENDIF
IF($P_TOOLNO==0) GOTOF _FEHL0
IF($P_TOOL==0) GOTOF _FEHL1
_TYP=$P_AD[1]
IF(_TYP<>580)AND(_TYP<>710) GOTOF _FEHL2
F_SP_RPT(5)
IF(_F_RELEAS==0)
N50 F_SP_RP(0,S_X,S_Z,0,S_Y)
ENDIF
SBLON
IF(_F_Y_AXIS<>0)
N55 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z AX[_YY]=S_Y
ELSE
N56 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z
ENDIF
SBLOF
_DMODE=_DMODE-(_DMODE _DEC1)
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
N974 CYCLE974(S_MVAR,S_KNUM,S_KNUM1,S_PRNUM,S_SETV,S_MA,S_FA,S_TSA,S_STA1,S_NMSP,S_TNAME,S_DLNUM,S_TZL,S_TDIF,S_TUL,S_TLL,S_TMV,S_K,S_EVNUM,S_MCBIT,_DMODE,_AMODE,_DP)
ELSE
IF(_F_Y_AXIS<>0)
N1000 G0 AX[_XX]=S_X AX[_ZZ]=S_Z AX[_YY]=S_Y
ELSE
N1001 G0 AX[_XX]=S_X AX[_ZZ]=S_Z
ENDIF
ENDIF
G[29]=_P29
_E_S_LINE=0
_RETS:
_F_RELEAS=0
SBLON
RET
_FEHL0: STOPRE
N997400 SETAL(61009)
RET
_FEHL1: STOPRE
N997401 SETAL(61000)
RET
_FEHL2: STOPRE
N997402 SETAL(61212)
RET
_FEHL3: STOPRE
N997403 SETAL(61415)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_EDG_SPF
PROC F_MP_EDG(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,INT S_MVAR,INT S_KNUM,INT S_KNUM1,INT S_PRNUM,REAL S_SETV,REAL S_FA,REAL S_TSA,INT S_MA,INT S_MD,INT S_NMSP,STRING[32] S_TNAME,INT S_DLNUM,REAL S_TZL,REAL S_TDIF,REAL S_TUL,REAL S_TLL,REAL S_TMV,INT S_K,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE,REAL S_C,INT _DP) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Measure part: Set edge
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _DIR,_TM1,_TM3,_TM4,_TM5,_TM6,_MD_CLAMP,_AI,_TYP,_P29
DEF REAL _FAK1,_FAK2,_SC,_RP,_C0,_X0,_Y0,_Z0,_SPX,_XS,_YS
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_TM1=_TMOD _DEC1 _TM3=_TMOD _DEC3 _TM4=_TMOD _DEC4
_TM5=_TMOD _DEC5 _TM6=_TMOD _DEC6
_X0=S_X _Y0=S_Y _Z0=S_Z
_C0=S_C
_P29=$P_GG[29]
DIAMCYCOF
IF(_TM6==0)
_TM6=2
ENDIF
IF($P_TOOLNO==0) GOTOF _FEHL0
IF($P_TOOL==0) GOTOF _FEHL1
_TYP=$P_AD[1]
IF(_TYP<>580)AND(_TYP<>710) GOTOF _FEHL2
IF(_TM5==0)
F_SP_TRA(2032)
N14 F_TFS(_T,_TF,_DD,,,,,2)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(3)
ENDIF
IF(S_MD==0)
GOTOF _FEHL3
ELSE
_AI=S_MD-1
ENDIF
F_SP_RPT(5)
IF S_CALL_FROM_MA_JOG_STEP
_E_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RP=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RP=_F_RP_ACT*_FAK2
ENDIF
_XX=$P_AXN1 _ZZ=$P_AXN3
IF(_F_Y_AXIS<>0)
_YY=$P_AXN2
ENDIF
IF(_F_RELEAS==0)
N50 F_SP_RP(0,S_X,S_Z,0,S_Y)
ENDIF
SBLON
IF(_F_Y_AXIS<>0)
N55 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z AX[_YY]=S_Y
ELSE
N56 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z
ENDIF
SBLOF
ELSE
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N114 F_TFS(_T,_TF,_DD,,,,,2)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
F_SP_RPT(2,_TMOD)
IF S_CALL_FROM_MA_JOG_STEP
_E_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RP=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RP=_F_RP_ACT*_FAK2
ENDIF
IF(_TM1<2)
IF(_TM1==0)
GOTOF _FEHL1
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,_Z0,_C0)
IF(_F_RELEAS==0)
F_SP_RP(0,_RP,_Y0,0,_X0)
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N135 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
_XX=$P_AXN3 _ZZ=$P_AXN2
IF(_F_Y_AXIS<>0)
_YY=$P_AXN1
ENDIF
SBLON
IF(_F_Y_AXIS)
N140 G90 G0 G40 AX[_XX]=_Z0 AX[_ZZ]=_Y0 AX[_YY]=_X0
ELSE
N141 G90 G0 G40 AX[_XX]=_Z0 AX[_ZZ]=_Y0
ENDIF
SBLOF
ELSE
_SPX=_X0
IF(_TM1==2)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
_SPX=SQRT(ABS(POT(_XS)+POT(_YS)))
IF(_F_RELEAS==0)
F_SP_RP(0,_SPX,_RP,0)
ENDIF
F_SP_TRA(3122)
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC) GOTOF _FEHL2
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
IF(_F_Y_AXIS)
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ELSE
_C0=_C0+_Y0*_F_C_DIR[_F_MASPI/2]
_C0=((_C0 MOD 360)+360)MOD 360
_XS=_X0 _YS=0
ENDIF
ENDIF
IF(_F_RELEAS==0)
F_SP_RP(9,_XS,_RP,0,_YS)
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N165 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
_XX=$P_AXN1 _ZZ=$P_AXN3
IF(_F_Y_AXIS<>0)
_YY=$P_AXN2
ENDIF
IF(_F_RELEAS==0)
F_SP_RP(0,_XS,_RP,0,_YS)
IF(_TM1==6)
SBLON
IF(_F_Y_AXIS)
N167 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS
ELSE
N168 G90 G0 G40 AX[_XX]=_XS
ENDIF
SBLOF
ENDIF
ENDIF
SBLON
IF(_F_Y_AXIS<>0)
N169 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ELSE
N170 G90 G0 G40 AX[_XX]=_XS AX[_ZZ]=_Z0
ENDIF
SBLOF
ENDIF
ENDIF
_DMODE=_DMODE-(_DMODE _DEC1)
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N978 CYCLE978(S_MVAR,S_KNUM,S_KNUM1,S_PRNUM,S_SETV,S_FA,S_TSA,S_MA,S_MD,S_NMSP,S_TNAME,S_DLNUM,S_TZL,S_TDIF,S_TUL,S_TLL,S_TMV,S_K,S_EVNUM,S_MCBIT,_DMODE,_AMODE,_DP)
ELSE
IF(_F_Y_AXIS<>0)
N1000 G0 AX[_XX]=S_X AX[_ZZ]=S_Z AX[_YY]=S_Y
ELSE
N1001 G0 AX[_XX]=S_X AX[_ZZ]=S_Z
ENDIF
ENDIF
G[29]=_P29
_F_RELEAS=0
SBLON
_RETS:
RET
_FEHL0: STOPRE
N997800 SETAL(61009)
RET
_FEHL1: STOPRE
N997801 SETAL(61000)
RET
_FEHL2: STOPRE
N997802 SETAL(61212)
RET
_FEHL3: STOPRE
N997803 SETAL(61326)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_DR_SPF
PROC F_MP_DR(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_KNUM,INT S_KNUM1,INT S_PRNUM,REAL S_SETV,REAL S_SETV0,REAL S_SETV1,REAL S_FA,REAL S_TSA,REAL S_STA1,REAL S_ID,REAL S_SZA,REAL S_SZO,INT S_MA,INT S_NMSP,STRING[32] S_TNAME,INT S_DLNUM,REAL S_TZL,REAL S_TDIF,REAL S_TUL,REAL S_TLL,REAL S_TMV,INT S_K,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE,REAL S_XM,REAL S_YM,INT _DP) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.94.00.00.005 ;DATE: 2020-05-12
;ShopTurn: Measure part: Hole
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
F_MP_SL(_T,_TF,_DD,_TMOD,S_X,S_Y,S_Z,S_C,S_MVAR,S_KNUM,S_KNUM1,S_PRNUM,S_SETV,S_SETV0,S_SETV1,S_FA,S_TSA,S_STA1,S_ID,S_SZA,S_SZO,S_MA,S_NMSP,S_TNAME,S_DLNUM,S_TZL,S_TDIF,S_TUL,S_TLL,S_TMV,S_K,S_EVNUM,S_MCBIT,_DMODE,_AMODE,S_XM,S_YM,_DP)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_DMO_SPF
PROC F_MP_DMO(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _BETA,INT _BETAA,REAL S_Z,REAL S_X,INT S_MVAR,INT S_KNUM,INT S_KNUM1,INT S_PRNUM,REAL S_SETV,INT S_MA,REAL S_FA,REAL S_TSA,REAL S_STA1,INT S_NMSP,STRING[32] S_TNAME,INT S_DLNUM,REAL S_TZL,REAL S_TDIF,REAL S_TUL,REAL S_TLL,REAL S_TMV,INT S_K,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE,INT _DP) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.90.00.00.001 ;DATE: 2018-02-22
;ShopTurn: Measure part: Diameter outside
DEF AXIS _XX,_YY,_ZZ
DEF INT _P29,_TYP
DEF REAL _FAK1,_FAK2
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
S_X=S_X/2
_P29=$P_GG[29]
DIAMCYCOF
N10 G40 G90
F_SP_TRA(2040)
_ZZ=$P_AXN1 _XX=$P_AXN2
IF(_F_Y_AXIS<>0)
_YY=$P_AXN3
ENDIF
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N25 F_TFS(_T,_TF,_DD,,,,,_F_MASPI+1,0)
N26 F_SP_BC(10004,_BETA,0)
ELSE
N28 F_TFS(_T,_TF,_DD,,,,,_F_MASPI+1,0)
ENDIF
IF($P_TOOLNO==0) GOTOF _FEHL0
IF($P_TOOL==0) GOTOF _FEHL1
_TYP=$P_AD[1]
IF(_TYP<>580)AND(_TYP<>710) GOTOF _FEHL2
F_SP_RPT(5)
IF(_F_RELEAS==0)
IF(S_MA==3)
N45 F_SP_RP(0,0,S_Z,0,S_X)
ELSE
N50 F_SP_RP(0,S_X,S_Z,0,0)
ENDIF
ENDIF
SBLON
IF(_F_Y_AXIS<>0)
IF(S_MA==3)
N52 G0 G90 AX[_XX]=0 AX[_ZZ]=S_Z AX[_YY]=S_X
ELSE
N55 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z AX[_YY]=0
ENDIF
ELSE
N56 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z
ENDIF
SBLOF
_DMODE=_DMODE-(_DMODE _DEC1)
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
N974 CYCLE974(S_MVAR,S_KNUM,S_KNUM1,S_PRNUM,S_SETV,S_MA,S_FA,S_TSA,S_STA1,S_NMSP,S_TNAME,S_DLNUM,S_TZL,S_TDIF,S_TUL,S_TLL,S_TMV,S_K,S_EVNUM,S_MCBIT,_DMODE,_AMODE,_DP)
ELSE
IF(_F_Y_AXIS<>0)
N1000 G0 AX[_XX]=S_X AX[_ZZ]=S_Z AX[_YY]=0
ELSE
N1001 G0 AX[_XX]=S_X AX[_ZZ]=S_Z
ENDIF
ENDIF
G[29]=_P29
_E_S_LINE=0
_RETS:
_F_RELEAS=0
SBLON
RET
_FEHL0: STOPRE
N997400 SETAL(61009)
RET
_FEHL1: STOPRE
N997401 SETAL(61000)
RET
_FEHL2: STOPRE
N997402 SETAL(61212)
RET
_FEHL3: STOPRE
N997403 SETAL(61415)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_DMI_SPF
PROC F_MP_DMI(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _BETA,INT _BETAA,REAL S_Z,REAL S_X,INT S_MVAR,INT S_KNUM,INT S_KNUM1,INT S_PRNUM,REAL S_SETV,INT S_MA,REAL S_FA,REAL S_TSA,REAL S_STA1,INT S_NMSP,STRING[32] S_TNAME,INT S_DLNUM,REAL S_TZL,REAL S_TDIF,REAL S_TUL,REAL S_TLL,REAL S_TMV,INT S_K,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE,INT _DP) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.90.00.00.001 ;DATE: 2018-02-22
;ShopTurn: Measure part: Diameter inside
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
_E_S_LINE=0
F_MP_DMO(_T,_TF,_DD,_BETA,_BETAA,S_Z,S_X,S_MVAR,S_KNUM,S_KNUM1,S_PRNUM,S_SETV,S_MA,S_FA,S_TSA,S_STA1,S_NMSP,S_TNAME,S_DLNUM,S_TZL,S_TDIF,S_TUL,S_TLL,S_TMV,S_K,S_EVNUM,S_MCBIT,_DMODE,_AMODE,_DP)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_CSO_SPF
PROC F_MP_CSO(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_KNUM,INT S_KNUM1,INT S_PRNUM,REAL S_SETV,REAL S_FA,REAL S_TSA,REAL S_CPA,REAL S_CPO,REAL S_STA1,REAL S_INCA,INT S_NMSP,STRING[32] S_TNAME,REAL S_DLNUM,REAL S_TZL,REAL S_TDIF,REAL S_TUL,REAL S_TLL,REAL S_TMV,INT S_K,INT S_EVNUM,INT S_MCBIT,INT S_DMODE,INT _AMODE,REAL S_MPVAL1,REAL S_MPVAL2,INT _DP) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Measure part: Circle segment outside
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _DMODE,_DIR,_TM1,_TM3,_TM4,_TM6,_MD_CLAMP,_P29
DEF REAL _C0,_X0,_Y0,_Z0,_FAK1,_FAK2,_SC,_RP,_XS,_YS
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_TM1=_TMOD _DEC1 _TM3=_TMOD _DEC3
_TM4=_TMOD _DEC4 _TM6=_TMOD _DEC6
_DMODE=S_DMODE-(S_DMODE _DEC1)
_X0=S_X _Y0=S_Y _Z0=S_Z
_C0=S_C
_P29=$P_GG[29]
DIAMCYCOF
IF(_TM6==0)
_TM6=2
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N14 F_TFS(_T,_TF,_DD,,,,,2)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
F_SP_RPT(2,_TMOD)
IF S_CALL_FROM_MA_JOG_STEP
_E_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RP=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RP=_F_RP_ACT*_FAK2
ENDIF
IF(_TM1<2)
IF(_TM1==0)
GOTOF _FEHL1
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,_Z0,_C0)
IF(_F_RELEAS==0)
F_SP_RP(0,_RP,_Y0,0,_X0)
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N35 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
_YY=$P_AXN1 _ZZ=$P_AXN2 _XX=$P_AXN3
SBLON
N40 G90 G0 G40 AX[_XX]=_Z0 AX[_ZZ]=_Y0 AX[_YY]=_X0
SBLOF
ELSE
IF(_TM1==2)
GOTOF _FEHL1
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC) GOTOF _FEHL2
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
IF(_F_RELEAS==0)
F_SP_RP(9,_XS,_RP,0,_YS)
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N65 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
_XX=$P_AXN1 _YY=$P_AXN2 _ZZ=$P_AXN3
SBLON
IF(_TM1==6)
IF(_F_RELEAS==0)
N66 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS
ELSE
N67 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ENDIF
ELSE
IF(_F_RELEAS==0)
N68 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_RP
ELSE
N69 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ENDIF
ENDIF
N70 G90 G0 G40 AX[_ZZ]=_Z0
SBLOF
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_TM1==1)OR(_TM1==3)OR(_TM1==6)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N979 CYCLE979(S_MVAR,S_KNUM,S_KNUM1,S_PRNUM,S_SETV,S_FA,S_TSA,S_CPA,S_CPO,S_STA1,S_INCA,S_NMSP,S_TNAME,S_DLNUM,S_TZL,S_TDIF,S_TUL,S_TLL,S_TMV,S_K,S_EVNUM,S_MCBIT,_DMODE,_AMODE,S_MPVAL1,S_MPVAL2,_DP)
ELSE
N1000 G0 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ENDIF
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
G[29]=_P29
_RETS:
RET
_FEHL1: STOPRE
N997901 SETAL(61020)
RET
_FEHL2: STOPRE
N997902 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_CSI_SPF
PROC F_MP_CSI(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_KNUM,INT S_KNUM1,INT S_PRNUM,REAL S_SETV,REAL S_FA,REAL S_TSA,REAL S_CPA,REAL S_CPO,REAL S_STA1,REAL S_INCA,INT S_NMSP,STRING[32] S_TNAME,REAL S_DLNUM,REAL S_TZL,REAL S_TDIF,REAL S_TUL,REAL S_TLL,REAL S_TMV,INT S_K,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE,REAL S_MPVAL1,REAL S_MPVAL2,INT _DP) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.90.00.00.001 ;DATE: 2018-02-22
;ShopTurn: Measure part: Circle segment inside
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
F_MP_CSO(_T,_TF,_DD,_TMOD,S_X,S_Y,S_Z,S_C,S_MVAR,S_KNUM,S_KNUM1,S_PRNUM,S_SETV,S_FA,S_TSA,S_CPA,S_CPO,S_STA1,S_INCA,S_NMSP,S_TNAME,S_DLNUM,S_TZL,S_TDIF,S_TUL,S_TLL,S_TMV,S_K,S_EVNUM,S_MCBIT,_DMODE,_AMODE,S_MPVAL1,S_MPVAL2,_DP)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_COR_SPF
PROC F_MP_COR(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_KNUM,INT S_PRNUM,REAL S_SETV0,REAL S_SETV1,REAL S_SETV2,REAL S_SETV3,REAL S_SETV4,REAL S_SETV5,REAL S_SETV6,REAL S_SETV7,REAL S_SETV8,REAL S_SETV9,REAL S_STA1,REAL S_INCA,REAL S_ID,REAL S_FA,REAL S_TSA,INT S_NMSP,INT S_MCBIT,INT S_DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Measure part: Any corner
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _DMODE,_DIR,_TM1,_TM3,_TM4,_TM6,_MD_CLAMP,_P29
DEF REAL _DZ,_C0,_X0,_Y0,_Z0,_FAK1,_FAK2,_SC,_RP,_XS,_YS
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_TM1=_TMOD _DEC1 _TM3=_TMOD _DEC3
_TM4=_TMOD _DEC4 _TM6=_TMOD _DEC6
_DMODE=S_DMODE-(S_DMODE _DEC1)
_X0=S_X _Y0=S_Y _Z0=S_Z
_C0=S_C
_P29=$P_GG[29]
DIAMCYCOF
IF(_TM6==0)
_TM6=2
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
IF(_TM3==0)
_DZ=-(ABS(S_ID))
ELSE
_DZ=ABS(S_ID)
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N14 F_TFS(_T,_TF,_DD,,,,,2)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
F_SP_RPT(2,_TMOD)
IF S_CALL_FROM_MA_JOG_STEP
_E_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RP=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RP=_F_RP_ACT*_FAK2
ENDIF
IF(_TM1<2)
IF(_TM1==0)
GOTOF _FEHL1
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,_Z0,_C0)
IF(_F_RELEAS==0)
F_SP_RP(0,_RP,_Y0,0,_X0)
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N35 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
_YY=$P_AXN1 _ZZ=$P_AXN2 _XX=$P_AXN3
SBLON
N40 G90 G0 G40 AX[_XX]=_Z0 AX[_ZZ]=_Y0 AX[_YY]=_X0
SBLOF
ELSE
IF(_TM1==2)
GOTOF _FEHL1
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC) GOTOF _FEHL2
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
IF(_F_RELEAS==0)
F_SP_RP(9,_XS,_RP,0,_YS)
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N65 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
_XX=$P_AXN1 _YY=$P_AXN2 _ZZ=$P_AXN3
SBLON
IF(_TM1==6)
IF(_F_RELEAS==0)
N66 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS
ELSE
N67 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ENDIF
ELSE
IF(_F_RELEAS==0)
N68 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_RP
ELSE
N69 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ENDIF
ENDIF
N70 G90 G0 G40 AX[_ZZ]=_Z0
SBLOF
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_TM1==1)OR(_TM1==3)OR(_TM1==6)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N961 CYCLE961(S_MVAR,S_KNUM,S_PRNUM,S_SETV0,S_SETV1,S_SETV2,S_SETV3,S_SETV4,S_SETV5,S_SETV6,S_SETV7,S_SETV8,S_SETV9,S_STA1,S_INCA,_DZ,S_FA,S_TSA,S_NMSP,S_MCBIT,_DMODE,_AMODE)
ELSE
N1000 G0 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ENDIF
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
G[29]=_P29
_RETS:
RET
_FEHL1: STOPRE
N996101 SETAL(61020)
RET
_FEHL2: STOPRE
N996102 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_C90_SPF
PROC F_MP_C90(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_KNUM,INT S_PRNUM,REAL S_SETV0,REAL S_SETV1,REAL S_SETV2,REAL S_SETV3,REAL S_SETV4,REAL S_SETV5,REAL S_SETV6,REAL S_SETV7,REAL S_SETV8,REAL S_SETV9,REAL S_STA1,REAL S_INCA,REAL S_ID,REAL S_FA,REAL S_TSA,INT S_NMSP,INT S_MCBIT,INT _DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.04.01.00 ;DATE: 2010-08-04
;ShopTurn: Measure part: Rectangular corner
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
F_MP_COR(_T,_TF,_DD,_TMOD,S_X,S_Y,S_Z,S_C,S_MVAR,S_KNUM,S_PRNUM,S_SETV0,S_SETV1,S_SETV2,S_SETV3,S_SETV4,S_SETV5,S_SETV6,S_SETV7,S_SETV8,S_SETV9,S_STA1,S_INCA,S_ID,S_FA,S_TSA,S_NMSP,S_MCBIT,_DMODE,_AMODE)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_BAR_SPF
PROC F_MP_BAR(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_KNUM,INT S_KNUM1,INT S_PRNUM,REAL S_SETV,REAL S_SETV0,REAL S_SETV1,REAL S_FA,REAL S_TSA,REAL S_STA1,REAL S_ID,REAL S_SZA,REAL S_SZO,INT S_MA,INT S_NMSP,STRING[32] S_TNAME,INT S_DLNUM,REAL S_TZL,REAL S_TDIF,REAL S_TUL,REAL S_TLL,REAL S_TMV,INT S_K,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE,REAL S_XM,REAL S_YM,INT _DP) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.94.00.00.005 ;DATE: 2020-05-12
;ShopTurn: Measure part: Bar
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
F_MP_SL(_T,_TF,_DD,_TMOD,S_X,S_Y,S_Z,S_C,S_MVAR,S_KNUM,S_KNUM1,S_PRNUM,S_SETV,S_SETV0,S_SETV1,S_FA,S_TSA,S_STA1,S_ID,S_SZA,S_SZO,S_MA,S_NMSP,S_TNAME,S_DLNUM,S_TZL,S_TDIF,S_TUL,S_TLL,S_TMV,S_K,S_EVNUM,S_MCBIT,_DMODE,_AMODE,S_XM,S_YM,_DP)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MP_3SP_SPF
PROC F_MP_3SP(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_KNUM,INT S_PRNUM,REAL S_SETV,REAL S_FA,REAL S_TSA,REAL S_STA1,REAL S_INCA,REAL S_SETV0,REAL S_SETV1,REAL S_SETV2,REAL S_SETV3,REAL S_SETV4,REAL S_SETV5,REAL S_SETV6,REAL S_SETV7,REAL S_SETV8,REAL S_TNVL,INT S_NMSP,INT S_MCBIT,INT S_DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Measure part: 3 spheres
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _DMODE,_DIR,_TM1,_TM3,_TM4,_TM6,_MD_CLAMP,_P29
DEF REAL _C0,_X0,_Y0,_Z0,_FAK1,_FAK2,_SC,_RP,_XS,_YS
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_TM1=_TMOD _DEC1 _TM3=_TMOD _DEC3
_TM4=_TMOD _DEC4 _TM6=_TMOD _DEC6
_DMODE=S_DMODE-(S_DMODE _DEC1)
_X0=S_X _Y0=S_Y _Z0=S_Z
_C0=S_C
_P29=$P_GG[29]
DIAMCYCOF
IF(_TM6==0)
_TM6=2
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N14 F_TFS(_T,_TF,_DD,,,,,2)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
F_SP_RPT(2,_TMOD)
IF S_CALL_FROM_MA_JOG_STEP
_E_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RP=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RP=_F_RP_ACT*_FAK2
ENDIF
IF(_TM1<2)
IF(_TM1==0)
GOTOF _FEHL1
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,_Z0,_C0)
IF(_F_RELEAS==0)
F_SP_RP(0,_RP,_Y0,0,_X0)
ENDIF
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N35 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
_YY=$P_AXN1 _ZZ=$P_AXN2 _XX=$P_AXN3
SBLON
N40 G90 G0 G40 AX[_XX]=_Z0 AX[_ZZ]=_Y0 AX[_YY]=_X0
SBLOF
ELSE
IF(_TM1==2)
GOTOF _FEHL1
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC) GOTOF _FEHL2
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
IF(_F_RELEAS==0)
F_SP_RP(9,_XS,_RP,0,_YS)
ENDIF
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N65 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
_XX=$P_AXN1 _YY=$P_AXN2 _ZZ=$P_AXN3
SBLON
IF(_TM1==6)
IF(_F_RELEAS==0)
N66 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS
ELSE
N67 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ENDIF
ELSE
IF(_F_RELEAS==0)
N68 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_RP
ELSE
N69 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ENDIF
ENDIF
N70 G90 G0 G40 AX[_ZZ]=_Z0
SBLOF
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_TM1==1)OR(_TM1==3)OR(_TM1==6)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N997 CYCLE997(S_MVAR,S_KNUM,S_PRNUM,S_SETV,S_FA,S_TSA,S_STA1,S_INCA,S_SETV0,S_SETV1,S_SETV2,S_SETV3,S_SETV4,S_SETV5,S_SETV6,S_SETV7,S_SETV8,S_TNVL,S_NMSP,S_MCBIT,_DMODE,_AMODE)
ELSE
N1000 G0 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ENDIF
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
G[29]=_P29
_RETS:
RET
_FEHL1: STOPRE
N999701 SETAL(61020)
RET
_FEHL2: STOPRE
N999702 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MC_RSP_SPF
PROC F_MC_RSP(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_PRNUM,REAL S_SETV,REAL S_SETV0,INT S_MA,INT S_MD,REAL S_FA,REAL S_TSA,REAL S_VMS,REAL S_STA1,INT S_NMSP,INT S_MCBIT,INT S_DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 06.24.00.00.001 ;DATE: 2024-02-06
;ShopTurn: Measure calibration: Part probe radius at sphere
DEF AXIS _XX,_YY,_ZZ,_CC
DEF INT _DMODE,_DIR,_TM1,_TM3,_TM4,_TM6,_MD_CLAMP,_P29
DEF REAL _C0,_X0,_Y0,_Z0,_FAK1,_FAK2,_SC,_RP,_XS,_YS
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
_TM1=_TMOD _DEC1 _TM3=_TMOD _DEC3
_TM4=_TMOD _DEC4 _TM6=_TMOD _DEC6
_DMODE=S_DMODE-(S_DMODE _DEC1)
_X0=S_X _Y0=S_Y _Z0=S_Z
_C0=S_C
_P29=$P_GG[29]
DIAMCYCOF
IF(_TM1==0)
S_Z=S_Z/2
ENDIF
IF(_TM6==0)
_TM6=2
ENDIF
IF(_TM1==6)AND(_TM3==1)
_TM3=0 _TMOD=_TMOD-100
ENDIF
F_SP_TRA(4102+10*_TM1-100*(_TM1 B_AND 1))
N14 F_TFS(_T,_TF,_DD,,,,,2)
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
F_SP_BC(_TM1+_TM3*100000)
ENDIF
F_SP_RPT(2,_TMOD)
IF S_CALL_FROM_MA_JOG_STEP
_E_INIT=1
_SC=$SCS_MAJOG_SAFETY_CLEARANCE*_FAK1
_RP=$SCS_MAJOG_RELEASE_PLANE*_FAK1
ELSE
_SC=_E_SC*_FAK2
_RP=_F_RP_ACT*_FAK2
ENDIF
IF(_TM1<2)
IF(_TM1==0)
GOTOF _FEHL1
ELSE
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2012,_Z0,_C0)
F_SP_RP(0,_RP,_Y0,0,_X0)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N35 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
ENDIF
_ZZ=$P_AXN2 _XX=$P_AXN3
IF(_F_Y_AXIS==1)
_YY=$P_AXN1
SBLON
N40 G90 G0 G40 AX[_XX]=_Z0 AX[_ZZ]=_Y0 AX[_YY]=_X0
SBLOF
ELSE
SBLON
N42 G90 G0 G40 AX[_XX]=_Z0 AX[_ZZ]=_Y0
SBLOF
ENDIF
ELSE
IF(_TM1==2)
GOTOF _FEHL1
ELSE
IF(_TM1==6)
IF(_RP<=_Z0+_SC) GOTOF _FEHL2
ENDIF
_C0=((_C0 MOD 360)+360)MOD 360
F_SP_TRA(2002+_TM1*10,,_C0)
IF(_TM4==0)
_XS=_X0 _YS=_Y0
ELSE
_XS=_X0*COS(_Y0) _YS=_X0*SIN(_Y0)
ENDIF
F_SP_RP(9,_XS,_RP,0,_YS)
IF(_TM1==3)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
_CC=_F_S_AX[_F_MASPI]
SBLON
N65 G0 G90 AX[_CC]=DC(_C0)
SBLOF
ENDIF
_ZZ=$P_AXN3
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
ENDIF
_XX=$P_AXN1 _ZZ=$P_AXN3
IF(_F_Y_AXIS==1)
_YY=$P_AXN2
F_SP_RP(0,_XS,_RP,0,_YS)
SBLON
N68 G90 G0 G40 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_RP
N70 G90 G0 G40 AX[_ZZ]=_Z0
SBLOF
ELSE
F_SP_RP(0,_XS,_RP,0,0)
SBLON
N72 G90 G0 G40 AX[_XX]=_XS AX[_ZZ]=_RP
N74 G90 G0 G40 AX[_ZZ]=_Z0
SBLOF
ENDIF
ENDIF
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
_MD_CLAMP=$MCS_FUNCTION_MASK_MILL B_AND 'H10'
IF (NOT _MD_CLAMP)OR(_MD_CLAMP AND(_TM6==2))
IF(_TM1==1)OR(_TM1==3)OR(_TM1==6)
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==0)
CUST_TECHCYC(3+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=1
_CC=_F_S_AX[_F_MASPI]
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_C0+$P_ACTFRAME[_CC,TR]
ENDIF
ENDIF
ELSE
IF(_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]==1)
CUST_TECHCYC(4+_F_MASPI*10)
_F_NCK_CL_STATE[_F_MA_AX_NR[_F_MASPI]-1]=0
_F_NCK_CL_ANG[_F_MA_AX_NR[_F_MASPI]-1]=_SC_A_NO_VAL
ENDIF
ENDIF
N977 CYCLE976(S_MVAR,S_PRNUM,S_SETV,S_SETV0,S_MA,S_MD,S_FA,S_TSA,S_VMS,S_STA1,S_NMSP,S_MCBIT,_DMODE,_AMODE)
ELSE
IF(_F_Y_AXIS==1)
N1000 G0 AX[_XX]=_XS AX[_YY]=_YS AX[_ZZ]=_Z0
ELSE
N1002 G0 AX[_XX]=_XS AX[_ZZ]=_Z0
ENDIF
ENDIF
IF(_TM1==3)
$P_CYCFRAME=INVFRAME($P_PFRAME):CROT(_ZZ,-_C0*_F_C_DIR[_F_MASPI/2]):$P_PFRAME:$P_CYCFRAME
ENDIF
G[29]=_P29
_RETS:
RET
_FEHL1: STOPRE
N997601 SETAL(61020)
RET
_FEHL2: STOPRE
N997602 SETAL(61742,"RP")
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MC_SL_SPF
PROC F_MC_SL(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _BETA,INT _BETAA,REAL S_Z,REAL S_X,REAL S_Y,INT S_MVAR,INT S_PRNUM,INT S_CALNUM,REAL S_SETV,INT S_MA,INT S_MD,REAL S_FA,REAL S_TSA,REAL S_VMS,INT S_NMSP,INT S_MCBIT,INT _DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.04.23.00 ;DATE: 2012-01-03
;ShopTurn: Measure calibration: Part probe in slot
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
F_MC_L(_T,_TF,_DD,_BETA,_BETAA,S_Z,S_X,S_Y,S_MVAR,S_PRNUM,S_CALNUM,S_SETV,S_MA,S_MD,S_FA,S_TSA,S_VMS,S_NMSP,S_MCBIT,_DMODE,_AMODE)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MC_RR_SPF
PROC F_MC_RR(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_PRNUM,REAL S_SETV,REAL S_SETV0,INT S_MA,INT S_MD,REAL S_FA,REAL S_TSA,REAL S_VMS,REAL S_STA1,INT S_NMSP,INT S_MCBIT,INT _DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.04.06.00 ;DATE: 2010-12-07
;ShopTurn: Measure calibration: Part probe radius in ring
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
F_MC_RSP(_T,_TF,_DD,_TMOD,S_X,S_Y,S_Z,S_C,S_MVAR,S_PRNUM,S_SETV,S_SETV0,S_MA,S_MD,S_FA,S_TSA,S_VMS,S_STA1,S_NMSP,S_MCBIT,_DMODE,_AMODE)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MC_R_SPF
PROC F_MC_R(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _BETA,INT _BETAA,REAL S_Z,REAL S_X,REAL S_Y,INT S_MVAR,INT S_PRNUM,INT S_CALNUM,REAL S_SETV,INT S_MA,INT S_MD,REAL S_FA,REAL S_TSA,REAL S_VMS,INT S_NMSP,INT S_MCBIT,INT _DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.04.23.00 ;DATE: 2012-01-03
;ShopTurn: Measure calibration: Part probe radius
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
F_MC_L(_T,_TF,_DD,_BETA,_BETAA,S_Z,S_X,S_Y,S_MVAR,S_PRNUM,S_CALNUM,S_SETV,S_MA,S_MD,S_FA,S_TSA,S_VMS,S_NMSP,S_MCBIT,_DMODE,_AMODE)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MC_MPT_SPF
PROC F_MC_MPT(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _BETA,INT _BETAA,REAL _GAMA,REAL S_Z,REAL S_X,REAL S_Y,INT S_MVAR,INT S_KNUM,INT S_PRNUM,INT S_MA,INT S_MD,REAL S_ID,REAL S_FA,REAL S_TSA,REAL S_VMS,REAL S_STA1,REAL S_CORA,REAL S_TZL,REAL S_TDIF,INT S_NMSP,INT S_EVNUM,INT S_MCBIT,INT _DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.04.17.00 ;DATE: 2011-06-27
;ShopTurn: Measure calibration: Measure probe tool
F_MT_TUR(_T,_TF,_DD,_BETA,_BETAA,_GAMA,S_Z,S_X,S_Y,S_MVAR,S_KNUM,S_PRNUM,S_MA,S_MD,S_ID,S_FA,S_TSA,S_VMS,S_STA1,S_CORA,S_TZL,S_TDIF,S_NMSP,S_EVNUM,S_MCBIT,_DMODE,_AMODE)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MC_L_SPF
PROC F_MC_L(STRING[32] _T,STRING[32] _TF,INT _DD,REAL _BETA,INT _BETAA,REAL S_Z,REAL S_X,REAL S_Y,INT S_MVAR,INT S_PRNUM,INT S_CALNUM,REAL S_SETV,INT S_MA,INT S_MD,REAL S_FA,REAL S_TSA,REAL S_VMS,INT S_NMSP,INT S_MCBIT,INT _DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.07.11.00 ;DATE: 2014-07-09
;ShopTurn: Measure calibration: Part probe length
DEF AXIS _XX,_YY,_ZZ
DEF INT _AI,_LP,_P29,_SL,_TYP,_P2
DEF INT _SLT[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,2,1,4,3,7,6,5,8,9)
DEF INT _SLX[2,10]=set(0,1,2,3,4,5,6,7,8,9,0,4,3,2,1,5,8,7,6,9)
DEF REAL _FAK1,_FAK2
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
IF($P_GG[13]<3)
_FAK1=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)
_FAK1=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)
_FAK1=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
ELSE
_FAK1=1
ENDIF
_FAK2=1
IF($MN_SCALING_SYSTEM_IS_METRIC)
IF($P_GG[13]==1)OR($P_GG[13]==3)
_FAK2=1/$MN_SCALING_VALUE_INCH
ENDIF
ELSE
IF($P_GG[13]==2)OR($P_GG[13]==4)
_FAK2=$MN_SCALING_VALUE_INCH
ENDIF
ENDIF
S_X=S_X/2
_P29=$P_GG[29]
DIAMCYCOF
N10 G40 G90
F_SP_TRA(2040)
_ZZ=$P_AXN1 _XX=$P_AXN2
IF(_F_Y_AXIS<>0)
_YY=$P_AXN3
ENDIF
IF(_F_AX_EXISTS[6])AND($MCS_FUNCTION_MASK_TECH B_AND 'H01')
N25 F_TFS(_T,_TF,_DD,,,,,1,0)
N26 F_SP_BC(4,_BETA,0)
ELSE
N28 F_TFS(_T,_TF,_DD,,,,,1,0)
ENDIF
IF($P_TOOLNO==0) GOTOF _FEHL0
IF($P_TOOL==0) GOTOF _FEHL1
_TYP=$P_ADT[1]
IF(_TYP<>580)AND(_TYP<>710) GOTOF _FEHL2
_SL=$P_ADT[2]
IF(NOT(($MC_TOOL_PARAMETER_DEF_MASK B_AND 'H00200000')AND($P_CUTMOD)))
_SL=_SLT[$P_ACTFRAME[_ZZ,MI],_SL]
_SL=_SLX[$P_ACTFRAME[_XX,MI],_SL]
ENDIF
IF(S_MA==1)
_LP=0
IF(_SL==7)OR(_SL==5)
IF(_SL==7)
_P2=5
_AI=1
ELSE
_P2=4
_AI=-1
ENDIF
ELSE
IF(_SL==8)OR(_SL==6)
IF(S_MD==1)
_P2=5
_AI=1
ELSE
_P2=4
_AI=-1
ENDIF
ELSE
GOTOF _FEHL3
ENDIF
ENDIF
ELSE
_LP=1
IF(_SL==8)OR(_SL==6)
IF(_SL==8)
_P2=1
_AI=1
ELSE
_P2=0
_AI=-1
ENDIF
ELSE
IF(_SL==5)OR(_SL==7)
IF(S_MD==1)
_P2=1
_AI=1
ELSE
_P2=0
_AI=-1
ENDIF
ELSE
GOTOF _FEHL3
ENDIF
ENDIF
ENDIF
F_SP_RPT(0,_P2)
IF(_F_RELEAS==0)
IF(_AI==-1)
N40 F_SP_RP(3,S_X,S_Z)
ENDIF
IF(_LP==1)
N50 F_SP_RP(0,_F_RP_ACT*_FAK2,S_Z,0,S_Y)
ELSE
N51 F_SP_RP(0,S_X,_F_RP_ACT*_FAK2,0,S_Y)
ENDIF
SBLON
IF(_F_Y_AXIS<>0)
N52 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z AX[_YY]=S_Y
ELSE
N53 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z
ENDIF
SBLOF
ELSE
N54 F_SP_RP(0,,,0)
SBLON
IF(_F_Y_AXIS<>0)
N55 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z AX[_YY]=S_Y
ELSE
N56 G0 G90 AX[_XX]=S_X AX[_ZZ]=S_Z
ENDIF
SBLOF
ENDIF
_DMODE=_DMODE-(_DMODE _DEC1)
IF(NOT(($P_SEARCH)OR($AC_SERUPRO)))OR($MN_SIM_ENVIRONMENT B_AND 'B100')
N973 CYCLE973(S_MVAR,S_PRNUM,S_CALNUM,S_SETV,S_MA,S_MD,S_FA,S_TSA,S_VMS,S_NMSP,S_MCBIT,_DMODE,_AMODE)
ELSE
IF(_F_Y_AXIS<>0)
N1000 G0 AX[_XX]=S_X AX[_ZZ]=S_Z AX[_YY]=S_Y
ELSE
N1001 G0 AX[_XX]=S_X AX[_ZZ]=S_Z
ENDIF
ENDIF
G[29]=_P29
_RET:
_E_S_LINE=0
_RETS:
_F_RELEAS=0
SBLON
RET
_FEHL0: STOPRE
N997300 SETAL(61009)
RET
_FEHL1: STOPRE
N997301 SETAL(61000)
RET
_FEHL2: STOPRE
N997302 SETAL(61212)
RET
_FEHL3: STOPRE
N997303 SETAL(61415)
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MC_LP_SPF
PROC F_MC_LP(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_PRNUM,REAL S_SETV,REAL S_SETV0,INT S_MA,INT S_MD,REAL S_FA,REAL S_TSA,REAL S_VMS,REAL S_STA1,INT S_NMSP,INT S_MCBIT,INT S_DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.04.27.00 ;DATE: 2012-06-14
;ShopTurn: Measure calibration: Part probe length on plane
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
F_MC_RSP(_T,_TF,_DD,_TMOD,S_X,S_Y,S_Z,S_C,S_MVAR,S_PRNUM,S_SETV,S_SETV0,S_MA,S_MD,S_FA,S_TSA,S_VMS,S_STA1,S_NMSP,S_MCBIT,S_DMODE,_AMODE)
_RETS:
RET

;$ACCESS=70771
;$PATH=/_N_CST_DIR/_N_F_MC_RC_SPF
PROC F_MC_RC(STRING[32] _T,STRING[32] _TF,INT _DD,INT _TMOD,REAL S_X,REAL S_Y,REAL S_Z,REAL S_C,INT S_MVAR,INT S_PRNUM,REAL S_SETV,REAL S_SETV0,INT S_MA,INT S_MD,REAL S_FA,REAL S_TSA,REAL S_VMS,REAL S_STA1,INT S_NMSP,INT S_MCBIT,INT S_DMODE,INT _AMODE) SBLOF DISPLOF
;VERSION: 06.24.00.00 ;DATE: 2024-07-15
;CHANGE : 04.04.27.00 ;DATE: 2012-06-14
;ShopTurn: Measure calibration: Part probe radius at edge
IF(_E_S_LINE)AND(_E_S_LINE<>$P_LINENO[0]) GOTOF _RETS
F_MC_RSP(_T,_TF,_DD,_TMOD,S_X,S_Y,S_Z,S_C,S_MVAR,S_PRNUM,S_SETV,S_SETV0,S_MA,S_MD,S_FA,S_TSA,S_VMS,S_STA1,S_NMSP,S_MCBIT,S_DMODE,_AMODE)
_RETS:
RET

